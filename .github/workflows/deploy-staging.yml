name: Deploy to Staging

on:
  push:
    branches:
      - develop
      - staging
  pull_request:
    types: [opened, synchronize, reopened]
    branches:
      - main

env:
  DOTNET_VERSION: '9.0.x'
  REGISTRY: ghcr.io
  LOCATION_API_IMAGE: ghcr.io/${{ github.repository_owner }}/fwh-location-api
  MARKETING_API_IMAGE: ghcr.io/${{ github.repository_owner }}/fwh-marketing-api

jobs:
  detect_changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    permissions:
      checks: write
    outputs:
      location_api_changed: ${{ steps.changes.outputs.location_api }}
      marketing_api_changed: ${{ steps.changes.outputs.marketing_api }}
      mobile_changed: ${{ steps.changes.outputs.mobile }}
      any_changes: ${{ steps.changes.outputs.location_api || steps.changes.outputs.marketing_api || steps.changes.outputs.mobile }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect file changes
        id: changes
        run: |
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            BASE_SHA="${{ github.event.pull_request.base.sha }}"
            HEAD_SHA="${{ github.event.pull_request.head.sha }}"
          else
            # For push events, compare with previous commit
            BASE_SHA="${{ github.event.before }}"
            HEAD_SHA="${{ github.sha }}"
          fi

          # If BASE_SHA is empty or same as HEAD_SHA, check all files
          if [ -z "$BASE_SHA" ] || [ "$BASE_SHA" == "$HEAD_SHA" ] || [ "$BASE_SHA" == "0000000000000000000000000000000000000000" ]; then
            echo "âš ï¸  Cannot determine base commit, assuming all files changed"
            echo "location_api=true" >> $GITHUB_OUTPUT
            echo "marketing_api=true" >> $GITHUB_OUTPUT
            echo "mobile=true" >> $GITHUB_OUTPUT
            echo "any_changes=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          LOCATION_CHANGED="false"
          MARKETING_CHANGED="false"
          MOBILE_CHANGED="false"

          # Check for Location API changes
          if git diff --name-only "$BASE_SHA" "$HEAD_SHA" | grep -qE "^src/FWH\.Location\.Api/|^src/FWH\.Common\.Location/|^src/FWH\.ServiceDefaults/|^src/FWH\.Common\.(Chat|Imaging|Workflow)/|^Directory\.(Build\.(props|targets)|Packages\.props)|^\.github/workflows/deploy-staging\.yml|^src/FWH\.Location\.Api/.*Dockerfile"; then
            echo "âœ… Location API files changed"
            LOCATION_CHANGED="true"
            echo "location_api=true" >> $GITHUB_OUTPUT
          else
            echo "â­ï¸  Location API files unchanged"
            echo "location_api=false" >> $GITHUB_OUTPUT
          fi

          # Check for Marketing API changes
          if git diff --name-only "$BASE_SHA" "$HEAD_SHA" | grep -qE "^src/FWH\.MarketingApi/|^src/FWH\.ServiceDefaults/|^Directory\.(Build\.(props|targets)|Packages\.props)|^\.github/workflows/deploy-staging\.yml|^src/FWH\.MarketingApi/.*Dockerfile"; then
            echo "âœ… Marketing API files changed"
            MARKETING_CHANGED="true"
            echo "marketing_api=true" >> $GITHUB_OUTPUT
          else
            echo "â­ï¸  Marketing API files unchanged"
            echo "marketing_api=false" >> $GITHUB_OUTPUT
          fi

          # Check for Mobile app changes
          if git diff --name-only "$BASE_SHA" "$HEAD_SHA" | grep -qE "^src/FWH\.Mobile/|^src/FWH\.Mobile\.Data/|^src/FWH\.Common\.(Location|Chat|Imaging|Workflow)/|^Directory\.(Build\.(props|targets)|Packages\.props)|^\.github/workflows/deploy-staging\.yml"; then
            echo "âœ… Mobile app files changed"
            MOBILE_CHANGED="true"
            echo "mobile=true" >> $GITHUB_OUTPUT
          else
            echo "â­ï¸  Mobile app files unchanged"
            echo "mobile=false" >> $GITHUB_OUTPUT
          fi

          # Determine if any changes were detected
          if [ "$LOCATION_CHANGED" == "true" ] || [ "$MARKETING_CHANGED" == "true" ] || [ "$MOBILE_CHANGED" == "true" ]; then
            echo "any_changes=true" >> $GITHUB_OUTPUT
          else
            echo "any_changes=false" >> $GITHUB_OUTPUT
          fi

      - name: Create no-build check run
        if: steps.changes.outputs.any_changes == 'false'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ğŸ·ï¸  Creating 'no-build' check run (no changes detected)"

          # Create a check run to tag this workflow run
          CHECK_RUN_ID=$(gh api \
            -X POST \
            "/repos/${{ github.repository }}/check-runs" \
            -f name="no-build" \
            -f head_sha="${{ github.sha }}" \
            -f status="completed" \
            -f conclusion="success" \
            -f output='{"title":"No Build Required","summary":"No relevant files changed. Build steps were skipped.","text":"This workflow run was tagged as `no-build` because no changes were detected in Location API, Marketing API, or Mobile app files."}' \
            --jq '.id')

          echo "âœ… Created check run with ID: $CHECK_RUN_ID"

  build_and_test:
    name: Build and Test
    runs-on: windows-2022
    needs: detect_changes
    if: needs.detect_changes.outputs.any_changes == 'true'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup .NET 9
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Cache NuGet packages
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/Directory.Packages.props', '**/Directory.Build.props', '**/Directory.Build.targets', 'FunWasHad.sln') }}
          restore-keys: |
            ${{ runner.os }}-nuget-

      - name: Cache .NET environment and workload assets
        uses: actions/cache@v4
        with:
          path: |
            ~/.dotnet
            ~/.nuget
          key: ${{ runner.os }}-dotnet-env-${{ env.DOTNET_VERSION }}-${{ hashFiles('global.json') }}
          restore-keys: |
            ${{ runner.os }}-dotnet-env-${{ env.DOTNET_VERSION }}-
            ${{ runner.os }}-dotnet-env-

      - name: Cache build outputs
        uses: actions/cache@v4
        with:
          path: |
            **/bin
            **/obj
          key: ${{ runner.os }}-build-${{ hashFiles('**/*.csproj', 'FunWasHad.sln') }}-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-build-${{ hashFiles('**/*.csproj', 'FunWasHad.sln') }}-
            ${{ runner.os }}-build-

      - name: Restore dependencies
        run: |
          dotnet restore FunWasHad.sln
          dotnet restore src/FWH.Location.Api/FWH.Location.Api.csproj
          dotnet restore src/FWH.MarketingApi/FWH.MarketingApi.csproj

      - name: Build solution
        run: |
          dotnet build src/FWH.Location.Api/FWH.Location.Api.csproj --no-restore --configuration Release
          dotnet build src/FWH.MarketingApi/FWH.MarketingApi.csproj --no-restore --configuration Release

      - name: Run tests
        run: |
          dotnet test tests/FWH.Common.Location.Tests/FWH.Common.Location.Tests.csproj --configuration Release --verbosity normal
          dotnet test tests/FWH.MarketingApi.Tests/FWH.MarketingApi.Tests.csproj --configuration Release --verbosity normal
        continue-on-error: true

      - name: Publish Location API
        run: dotnet publish src/FWH.Location.Api/FWH.Location.Api.csproj --configuration Release --output ./publish/location-api --no-restore

      - name: Publish Marketing API
        run: dotnet publish src/FWH.MarketingApi/FWH.MarketingApi.csproj --configuration Release --output ./publish/marketing-api --no-restore

      - name: Upload Location API artifacts
        uses: actions/upload-artifact@v4
        with:
          name: location-api
          path: ./publish/location-api
          retention-days: 1

      - name: Upload Marketing API artifacts
        uses: actions/upload-artifact@v4
        with:
          name: marketing-api
          path: ./publish/marketing-api
          retention-days: 1

  docker_location_api_staging:
    name: Build Location API Docker Image (Staging)
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: [detect_changes, build_and_test]
    if: needs.detect_changes.outputs.location_api_changed == 'true'
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download Location API artifacts
        if: needs.detect_changes.outputs.location_api_changed == 'true'
        uses: actions/download-artifact@v4
        with:
          name: location-api
          path: ./artifacts/location-api

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.LOCATION_API_IMAGE }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=sha,prefix=staging-
            type=raw,value=staging-latest

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        timeout-minutes: 20
        with:
          context: .
          file: ./src/FWH.Location.Api/Dockerfile.artifacts
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          build-args: |
            BUILD_CONFIGURATION=Release
          platforms: linux/amd64
        continue-on-error: false

  docker_marketing_api_staging:
    name: Build Marketing API Docker Image (Staging)
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: [detect_changes, build_and_test]
    if: needs.detect_changes.outputs.marketing_api_changed == 'true'
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download Marketing API artifacts
        if: needs.detect_changes.outputs.marketing_api_changed == 'true'
        uses: actions/download-artifact@v4
        with:
          name: marketing-api
          path: ./artifacts/marketing-api

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.MARKETING_API_IMAGE }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=sha,prefix=staging-
            type=raw,value=staging-latest

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        timeout-minutes: 20
        with:
          context: .
          file: ./src/FWH.MarketingApi/Dockerfile.artifacts
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          build-args: |
            BUILD_CONFIGURATION=Release
          platforms: linux/amd64
        continue-on-error: false

  deploy_railway_staging:
    name: Deploy to Railway Staging
    runs-on: ubuntu-latest
    container: ghcr.io/railwayapp/cli:latest
    needs: [detect_changes, docker_location_api_staging, docker_marketing_api_staging]
    if: |
      github.event_name == 'push' &&
      (github.ref == 'refs/heads/develop' || github.ref == 'refs/heads/staging') &&
      (needs.detect_changes.outputs.location_api_changed == 'true' || needs.detect_changes.outputs.marketing_api_changed == 'true')
    environment:
      name: staging
      url: https://staging.up.railway.app
    env:
      RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get image tags
        id: image_tags
        run: |
          LOCATION_IMAGE="${{ env.LOCATION_API_IMAGE }}:staging-latest"
          MARKETING_IMAGE="${{ env.MARKETING_API_IMAGE }}:staging-latest"
          echo "location_image=$LOCATION_IMAGE" >> $GITHUB_OUTPUT
          echo "marketing_image=$MARKETING_IMAGE" >> $GITHUB_OUTPUT
          echo "ğŸ“¦ Location API image: $LOCATION_IMAGE"
          echo "ğŸ“¦ Marketing API image: $MARKETING_IMAGE"

      - name: Verify previous Docker builds succeeded
        run: |
          echo "ğŸ” Verifying Docker images were built successfully..."
          echo "âœ… Location API Docker image: ${{ env.LOCATION_API_IMAGE }}:staging-latest"
          echo "âœ… Marketing API Docker image: ${{ env.MARKETING_API_IMAGE }}:staging-latest"
          echo ""
          echo "ğŸ’¡ Note: Railway services must be pre-configured in dashboard to use Docker images from GHCR"
          echo "ğŸ’¡ Configure in Railway: Service Settings â†’ Source â†’ Docker Image"
          echo "ğŸ’¡ Image paths:"
          echo "   - Location API: ${{ env.LOCATION_API_IMAGE }}:staging-latest"
          echo "   - Marketing API: ${{ env.MARKETING_API_IMAGE }}:staging-latest"
          echo "ğŸ’¡ Dashboard: https://railway.com/project/${{ secrets.RAILWAY_STAGING_PROJECT_ID }}"

      - name: Deploy Location API to Railway
        if: needs.detect_changes.outputs.location_api_changed == 'true'
        run: railway redeploy -s staging-location-api -y

      - name: Deploy Marketing API to Railway
        if: needs.detect_changes.outputs.marketing_api_changed == 'true'
        run: railway redeploy -s staging-marketing-api -y

      - name: Wait for deployments
        run: sleep 60

      - name: Health check Location API
        run: |
          echo "ğŸ¥ Checking Location API health..."
          echo "ğŸ’¡ Check Railway dashboard for the service URL: https://railway.com/project/${{ secrets.RAILWAY_STAGING_PROJECT_ID }}"
          echo "âš ï¸  Health check skipped - use Railway dashboard to verify deployment status"
        continue-on-error: true

      # - name: Health check Marketing API
      #   run: |
      #     echo "ğŸ¥ Checking Marketing API health..."
      #     echo "ğŸ’¡ Check Railway dashboard for the service URL: https://railway.com/project/${{ secrets.RAILWAY_STAGING_PROJECT_ID }}"
      #     echo "âš ï¸  Health check skipped - use Railway dashboard to verify deployment status"
      #   continue-on-error: true

  build_mobile_android_staging:
    name: Build Mobile Android (Staging)
    runs-on: windows-2022
    needs: [detect_changes, build_and_test]
    if: needs.detect_changes.outputs.mobile_changed == 'true'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup .NET 9
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'microsoft'
          java-version: '17'

      - name: Cache NuGet packages
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/Directory.Packages.props', '**/Directory.Build.props', '**/Directory.Build.targets', 'FunWasHad.sln') }}
          restore-keys: |
            ${{ runner.os }}-nuget-

      - name: Cache .NET workloads and assets
        uses: actions/cache@v4
        with:
          path: |
            ~/.dotnet/workloads
            ~/.dotnet/packs
            ~/.dotnet/sdk-manifests
            ~/.dotnet/toolResolverCache
            C:\Program Files\dotnet\sdk-manifests
          key: ${{ runner.os }}-dotnet-workloads-android-${{ env.DOTNET_VERSION }}
          restore-keys: |
            ${{ runner.os }}-dotnet-workloads-android-
            ${{ runner.os }}-dotnet-env-${{ env.DOTNET_VERSION }}-

      - name: Cache build outputs
        uses: actions/cache@v4
        with:
          path: |
            **/bin
            **/obj
          key: ${{ runner.os }}-build-mobile-${{ hashFiles('src/FWH.Mobile/**/*.csproj') }}-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-build-mobile-${{ hashFiles('src/FWH.Mobile/**/*.csproj') }}-
            ${{ runner.os }}-build-mobile-

      - name: Install .NET MAUI Android workload
        timeout-minutes: 15
        run: |
          dotnet workload install android --source https://api.nuget.org/v3/index.json
          dotnet workload list

      - name: Restore dependencies
        timeout-minutes: 10
        run: dotnet restore src/FWH.Mobile/FWH.Mobile.Android/FWH.Mobile.Android.csproj

      - name: Build Android app (Staging)
        timeout-minutes: 20
        run: dotnet build src/FWH.Mobile/FWH.Mobile.Android/FWH.Mobile.Android.csproj --no-restore --configuration Staging

      - name: Publish Android APK (Staging)
        timeout-minutes: 30
        run: dotnet publish src/FWH.Mobile/FWH.Mobile.Android/FWH.Mobile.Android.csproj --no-restore --configuration Staging -f net9.0-android -p:AndroidPackageFormat=apk

      - name: Find APK file
        id: find_apk
        shell: pwsh
        run: |
          Write-Host "Searching for APK file..." -ForegroundColor Cyan
          $workspaceRoot = $env:GITHUB_WORKSPACE
          Write-Host "Workspace root: $workspaceRoot" -ForegroundColor Gray

          # Search in multiple possible locations
          $searchPaths = @(
            "src\FWH.Mobile\FWH.Mobile.Android\bin\Staging\net9.0-android",
            "src\FWH.Mobile\FWH.Mobile.Android\bin\Staging\net9.0-android\publish",
            "src\FWH.Mobile\FWH.Mobile.Android\bin\Staging",
            "src\FWH.Mobile\FWH.Mobile.Android\bin"
          )

          $apkPath = $null
          Write-Host "Searching in the following paths:" -ForegroundColor Cyan
          foreach ($path in $searchPaths) {
            $fullPath = Join-Path $workspaceRoot $path
            Write-Host "  - $path" -ForegroundColor Gray
            if (Test-Path $fullPath) {
              Write-Host "    (exists)" -ForegroundColor Green
              $found = Get-ChildItem -Path $fullPath -Filter "*.apk" -Recurse -ErrorAction SilentlyContinue | Select-Object -First 1
              if ($found) {
                $apkPath = $found
                Write-Host "    âœ“ Found APK: $($found.FullName)" -ForegroundColor Green
                break
              } else {
                Write-Host "    (no APK found, listing files:)" -ForegroundColor Yellow
                Get-ChildItem -Path $fullPath -Recurse -File | Select-Object -First 5 | ForEach-Object { Write-Host "      $($_.Name)" -ForegroundColor Gray }
              }
            } else {
              Write-Host "    (does not exist)" -ForegroundColor Red
            }
          }

          # If not found in expected paths, search more broadly
          if (-not $apkPath) {
            Write-Host "APK not found in expected paths, searching more broadly..." -ForegroundColor Yellow
            $mobileAndroidPath = Join-Path $workspaceRoot "src\FWH.Mobile\FWH.Mobile.Android"
            if (Test-Path $mobileAndroidPath) {
              $found = Get-ChildItem -Path $mobileAndroidPath -Filter "*.apk" -Recurse -ErrorAction SilentlyContinue | Select-Object -First 1
              if ($found) {
                $apkPath = $found
                Write-Host "âœ“ Found APK in broader search: $($found.FullName)" -ForegroundColor Green
              }
            }
          }

          if ($apkPath) {
            $fullPath = $apkPath.FullName
            if ($fullPath.StartsWith($workspaceRoot)) {
              $relativePath = $fullPath.Substring($workspaceRoot.Length).TrimStart('\', '/')
            } else {
              $relativePath = $fullPath
            }
            Write-Host "" -ForegroundColor Green
            Write-Host "âœ… APK found successfully!" -ForegroundColor Green
            Write-Host "   Full path: $fullPath" -ForegroundColor Gray
            Write-Host "   Relative path: $relativePath" -ForegroundColor Gray
            Write-Host "   File name: $($apkPath.Name)" -ForegroundColor Gray
            Write-Host "APK_PATH=$relativePath" >> $env:GITHUB_OUTPUT
            Write-Host "APK_NAME=$($apkPath.Name)" >> $env:GITHUB_OUTPUT
          } else {
            Write-Host "" -ForegroundColor Red
            Write-Error "APK file not found in any location"
            Write-Host "Searched paths:" -ForegroundColor Yellow
            foreach ($path in $searchPaths) {
              Write-Host "  - $path" -ForegroundColor Gray
            }
            Write-Host "Also searched: src\FWH.Mobile\FWH.Mobile.Android (recursive)" -ForegroundColor Gray
            # Set empty output so condition check works, then exit with error
            Write-Host "APK_PATH=" >> $env:GITHUB_OUTPUT
            Write-Host "APK_NAME=" >> $env:GITHUB_OUTPUT
            exit 1
          }

      - name: Upload APK artifact
        if: steps.find_apk.outputs.APK_PATH != ''
        uses: actions/upload-artifact@v4
        with:
          name: android-apk-staging
          path: ${{ steps.find_apk.outputs.APK_PATH }}
          retention-days: 30
          if-no-files-found: error

  release_android_staging:
    name: Create Android Release Candidate
    runs-on: ubuntu-latest
    needs: [detect_changes, build_mobile_android_staging, deploy_railway_staging]
    if: |
      github.event_name == 'push' &&
      (github.ref == 'refs/heads/develop' || github.ref == 'refs/heads/staging') &&
      needs.detect_changes.outputs.mobile_changed == 'true'
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download APK artifact
        uses: actions/download-artifact@v4
        with:
          name: android-apk-staging
          path: ./artifacts

      - name: Generate release candidate tag
        id: tag
        run: |
          SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)
          BRANCH_NAME=$(echo "${{ github.ref }}" | sed 's/refs\/heads\///')
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          TAG_NAME="staging-rc-${BRANCH_NAME}-${TIMESTAMP}-${SHORT_SHA}"
          echo "TAG_NAME=${TAG_NAME}" >> $GITHUB_OUTPUT
          echo "Generated release candidate tag: ${TAG_NAME}"

      - name: Find APK file
        id: find_apk
        run: |
          APK_FILE=$(find ./artifacts -name "*.apk" -type f | head -n 1)
          if [ -z "$APK_FILE" ]; then
            echo "APK file not found"
            exit 1
          fi
          echo "APK_PATH=$APK_FILE" >> $GITHUB_OUTPUT
          echo "APK_NAME=$(basename $APK_FILE)" >> $GITHUB_OUTPUT
          echo "Found APK: $APK_FILE"

      - name: Create GitHub Release Candidate
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.tag.outputs.TAG_NAME }}
          name: Staging Release Candidate - ${{ steps.tag.outputs.TAG_NAME }}
          body: |
            ## Android APK Release Candidate (Staging)

            **Version:** ${{ steps.tag.outputs.TAG_NAME }}
            **Branch:** ${{ github.ref_name }}
            **Build Date:** ${{ github.event.head_commit.timestamp }}
            **Commit:** ${{ github.sha }}
            **Commit Message:** ${{ github.event.head_commit.message }}

            ### Downloads
            - **APK:** ${{ steps.find_apk.outputs.APK_NAME }}

            ### Installation
            1. Download the APK file
            2. Enable "Install from Unknown Sources" on your Android device
            3. Install the APK file

            ### Staging Environment
            This release candidate is built against the **Staging** environment:
            - **Location API:** https://staging-location-api-production.up.railway.app
            - **Marketing API:** https://staging-marketing-api-production.up.railway.app

            ### Changes
            See the [commit history](https://github.com/${{ github.repository }}/compare/${{ github.event.before }}...${{ github.sha }}) for details.

            âš ï¸ **Note:** This is a release candidate for testing purposes only.
          files: ${{ steps.find_apk.outputs.APK_PATH }}
          draft: false
          prerelease: true

  notify_deployment:
    name: Notify Deployment Status
    runs-on: ubuntu-latest
    needs: [detect_changes, deploy_railway_staging, release_android_staging]
    if: always()

    steps:
      - name: Check for skipped deployments
        id: skipped
        run: |
          SKIPPED_APIS=""
          if [ "${{ needs.detect_changes.outputs.location_api_changed }}" == "false" ]; then
            SKIPPED_APIS="${SKIPPED_APIS}Location API "
          fi
          if [ "${{ needs.detect_changes.outputs.marketing_api_changed }}" == "false" ]; then
            SKIPPED_APIS="${SKIPPED_APIS}Marketing API "
          fi
          if [ "${{ needs.detect_changes.outputs.mobile_changed }}" == "false" ]; then
            SKIPPED_APIS="${SKIPPED_APIS}Mobile "
          fi
          if [ -n "$SKIPPED_APIS" ]; then
            echo "â­ï¸  Skipped (no changes): $SKIPPED_APIS"
            echo "skipped=true" >> $GITHUB_OUTPUT
          else
            echo "skipped=false" >> $GITHUB_OUTPUT
          fi

      - name: Deployment Success
        if: |
          steps.skipped.outputs.skipped == 'false' &&
          (needs.deploy_railway_staging.result == 'success' || needs.deploy_railway_staging.result == 'skipped') &&
          (needs.release_android_staging.result == 'success' || needs.release_android_staging.result == 'skipped')
        run: |
          echo "âœ… Staging deployment successful!"
          if [ "${{ needs.detect_changes.outputs.location_api_changed }}" == "true" ] || [ "${{ needs.detect_changes.outputs.marketing_api_changed }}" == "true" ]; then
            echo "ğŸš‚ Railway Project: https://railway.com/project/${{ secrets.RAILWAY_STAGING_PROJECT_ID }}"
          fi
          if [ "${{ needs.detect_changes.outputs.mobile_changed }}" == "true" ]; then
            echo "ğŸ“± Android Release Candidate created successfully!"
          fi

      - name: Deployment Skipped
        if: steps.skipped.outputs.skipped == 'true'
        run: |
          echo "â­ï¸  Deployment skipped - no relevant files changed"
          echo "âœ… All checks passed, but no deployment needed"

      - name: Deployment Failed
        if: |
          steps.skipped.outputs.skipped == 'false' &&
          (needs.deploy_railway_staging.result == 'failure' || needs.release_android_staging.result == 'failure')
        run: |
          echo "âŒ Staging deployment failed!"
          if [ "${{ needs.deploy_railway_staging.result }}" == "failure" ]; then
            echo "  - Railway deployment failed"
          fi
          if [ "${{ needs.release_android_staging.result }}" == "failure" ]; then
            echo "  - Android release candidate creation failed"
          fi
          exit 1
