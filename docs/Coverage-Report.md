Last updated: 2026-01-25 19:32 UTC

---

# Summary

|||
|:---|:---|
| Generated on: | 1/25/2026 - 7:32:45 PM |
| Coverage date: | 1/25/2026 - 7:30:06 PM - 1/25/2026 - 7:30:34 PM |
| Parser: | MultiReport (8x Cobertura) |
| Assemblies: | 10 |
| Classes: | 204 |
| Files: | 172 |
| **Line coverage:** | 32% (3181 of 9932) |
| Covered lines: | 3181 |
| Uncovered lines: | 6751 |
| Coverable lines: | 9932 |
| Total lines: | 17981 |
| **Branch coverage:** | 31.2% (841 of 2687) |
| Covered branches: | 841 |
| Total branches: | 2687 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

# Risk Hotspots

| **Assembly** | **Class** | **Method** | **Crap Score** | **Cyclomatic complexity** |
|:---|:---|:---|---:|---:|
| FWH.Mobile | [FWH.Mobile.ChatInputControl](#fwhmobilechatinputcontrol) | OnCameraRequested() | 1806 | 42 || FWH.Common.Workflow | [FWH.Common.Workflow.Actions.WorkflowActionExecutor](#fwhcommonworkflowactionsworkflowactionexecutor) | ExecuteHandlerAsync() | 1482 | 38 || FWH.Mobile | [FWH.Mobile.App](#fwhmobileapp) | LoadWorkflowFileAsync() | 812 | 28 || FWH.Mobile | [FWH.Mobile.App](#fwhmobileapp) | TryRegisterPlatformCameraServices(...) | 702 | 26 || FWH.Mobile | [FWH.Mobile.Services.ActivityTrackingService](#fwhmobileservicesactivitytrackingservice) | OnMovementStateChanged(...) | 702 | 26 || FWH.Mobile | [FWH.Mobile.Services.GetNearbyBusinessesActionHandler](#fwhmobileservicesgetnearbybusinessesactionhandler) | HandleAsync() | 702 | 26 || FWH.Mobile | [FWH.Mobile.Services.LocationWorkflowService](#fwhmobileserviceslocationworkflowservice) | LoadLocationWorkflowFileAsync() | 702 | 26 || FWH.Mobile | [FWH.Mobile.ViewModels.PlacesViewModel](#fwhmobileviewmodelsplacesviewmodel) | FetchBusinessLogoAsync() | 702 | 26 || FWH.Mobile | [FWH.Mobile.App](#fwhmobileapp) | LoadAndroidAsset(...) | 600 | 24 || FWH.Mobile | [FWH.Mobile.Logging.AvaloniaLoggerProvider](#fwhmobileloggingavalonialoggerprovider) | FormatScope(...) | 600 | 24 || FWH.Common.Chat | [FWH.Common.Chat.Services.PlatformService](#fwhcommonchatservicesplatformservice) | GetDatabasePath(...) | 506 | 22 || FWH.Mobile | [FWH.Mobile.Services.ThemeService](#fwhmobileservicesthemeservice) | ApplyTheme(...) | 506 | 22 || FWH.Common.Chat | [FWH.Common.Chat.Services.PlatformService](#fwhcommonchatservicesplatformservice) | DetectPlatform() | 420 | 20 || FWH.Common.Location | [FWH.Common.Location.Services.OverpassLocationService](#fwhcommonlocationservicesoverpasslocationservice) | SanitizeCategory(...) | 342 | 18 || FWH.Mobile | [FWH.Mobile.Services.LocationTrackingService](#fwhmobileserviceslocationtrackingservice) | ExtractCityStateCountryFromAddress(...) | 342 | 18 || FWH.Mobile | [FWH.Mobile.Services.LocationTrackingService](#fwhmobileserviceslocationtrackingservice) | SaveStationaryPlaceAsync() | 342 | 18 || FWH.Mobile | [FWH.Mobile.Services.MovementStateLogger](#fwhmobileservicesmovementstatelogger) | LogTransitionMessage(...) | 342 | 18 || FWH.Common.Location | [FWH.Common.Location.Services.OverpassLocationService](#fwhcommonlocationservicesoverpasslocationservice) | GetAddressAsync() | 272 | 16 || FWH.Mobile | [FWH.Mobile.ViewModels.PlacesViewModel](#fwhmobileviewmodelsplacesviewmodel) | ExtractCityFromAddress(...) | 272 | 16 || FWH.Common.Workflow | [FWH.Common.Workflow.Actions.WorkflowActionExecutor](#fwhcommonworkflowactionsworkflowactionexecutor) | ExecuteAsync() | 235 | 56 || FWH.MarketingApi | [FWH.MarketingApi.Data.DatabaseMigrationService](#fwhmarketingapidatadatabasemigrationservice) | GetConnectionString() | 229 | 18 || FWH.Mobile | [FWH.Mobile.Services.LocationApiClient](#fwhmobileserviceslocationapiclient) | .ctor(...) | 210 | 14 || FWH.Mobile | [FWH.Mobile.Services.LocationTrackingService](#fwhmobileserviceslocationtrackingservice) | CheckForAddressChangeAsync() | 210 | 14 || FWH.Mobile | [FWH.Mobile.ViewModels.CameraCaptureViewModel](#fwhmobileviewmodelscameracaptureviewmodel) | CapturePhotoAsync() | 210 | 14 || FWH.Mobile | [FWH.Mobile.ViewModels.LogViewerViewModel](#fwhmobileviewmodelslogviewerviewmodel) | OnEntriesCollectionChanged(...) | 210 | 14 || FWH.Mobile | [FWH.Mobile.ViewModels.PlacesViewModel](#fwhmobileviewmodelsplacesviewmodel) | LoadPlacesAsync() | 210 | 14 || FWH.Common.Chat | [FWH.Common.Chat.ViewModels.ChatListViewModel](#fwhcommonchatviewmodelschatlistviewmodel) | AddEntry(...) | 193 | 28 || FWH.Common.Location | [FWH.Common.Location.Services.GpsServiceFactory](#fwhcommonlocationservicesgpsservicefactory) | CreateGpsService() | 156 | 12 || FWH.Common.Location | [FWH.Common.Location.Services.LocationConfigurationService](#fwhcommonlocationserviceslocationconfigurationservice) | LoadOptionsAsync() | 156 | 12 || FWH.MarketingApi | [FWH.MarketingApi.Controllers.MarketingController](#fwhmarketingapicontrollersmarketingcontroller) | GetCityMarketing() | 156 | 12 || FWH.MarketingApi | [FWH.MarketingApi.Controllers.MarketingController](#fwhmarketingapicontrollersmarketingcontroller) | GetNearbyBusinesses() | 156 | 12 || FWH.Mobile | [FWH.Mobile.App](#fwhmobileapp) | .cctor() | 156 | 12 || FWH.Mobile | [FWH.Mobile.Logging.AvaloniaLoggerProvider](#fwhmobileloggingavalonialoggerprovider) | FormatValue(...) | 156 | 12 || FWH.Mobile | [FWH.Mobile.Services.ApiAuthenticationService](#fwhmobileservicesapiauthenticationservice) | GenerateRequestSignature(...) | 156 | 12 || FWH.Mobile | [FWH.Mobile.Services.ImageService](#fwhmobileservicesimageservice) | GetImageAsync() | 156 | 12 || FWH.Mobile | [FWH.Mobile.Services.ImageService](#fwhmobileservicesimageservice) | StoreImageAsync() | 156 | 12 || FWH.Mobile | [FWH.Mobile.Views.MapView](#fwhmobileviewsmapview) | UpdateMapLocation() | 156 | 12 || FWH.Mobile | [FWH.Mobile.Views.MovementStateControl](#fwhmobileviewsmovementstatecontrol) | UpdateMapLocation() | 156 | 12 || FWH.Mobile | [FWH.Mobile.Views.UrlToImageConverter](#fwhmobileviewsurltoimageconverter) | Convert(...) | 156 | 12 || FWH.Orchestrix.Mediator.Remote | [FWH.Orchestrix.Mediator.Remote.Location.GetNearbyBusinessesHandler](#fwhorchestrixmediatorremotelocationgetnearbybusinesseshandler) | HandleAsync() | 156 | 12 || FWH.Common.Workflow | [FWH.Common.Workflow.PlantUmlParser](#fwhcommonworkflowplantumlparser) | Parse(...) | 118 | 114 || FWH.Common.Chat | [FWH.Common.Chat.ChatService](#fwhcommonchatchatservice) | NormalizeNoteMarkdown(...) | 110 | 10 || FWH.Common.Location | [FWH.Common.Location.Services.OverpassLocationService](#fwhcommonlocationservicesoverpasslocationservice) | BuildAddressFromTags(...) | 110 | 10 || FWH.Mobile | [FWH.Mobile.App](#fwhmobileapp) | BuildConfiguration() | 110 | 10 || FWH.Mobile | [FWH.Mobile.Services.ThemeService](#fwhmobileservicesthemeservice) | ApplyCityThemeAsync() | 110 | 10 || FWH.Orchestrix.Mediator.Remote | [FWH.Orchestrix.Mediator.Remote.Extensions.ApiAuthenticationMessageHandler](#fwhorchestrixmediatorremoteextensionsapiauthenticationmessagehandler) | SendAsync() | 110 | 10 || FWH.Orchestrix.Mediator.Remote | [FWH.Orchestrix.Mediator.Remote.Location.GetDeviceLocationHistoryHandler](#fwhorchestrixmediatorremotelocationgetdevicelocationhistoryhandler) | HandleAsync() | 110 | 10 || FWH.Mobile | [FWH.Mobile.Services.LocationTrackingService](#fwhmobileserviceslocationtrackingservice) | DetermineMovementState(...) | 102 | 34 || FWH.Common.Chat | [FWH.Common.Chat.Duplicate.ChatDuplicateDetector](#fwhcommonchatduplicatechatduplicatedetector) | IsDuplicate(...) | 88 | 18 || FWH.Common.Workflow | [FWH.Common.Workflow.Controllers.WorkflowController](#fwhcommonworkflowcontrollersworkflowcontroller) | ResolveChoiceValue(...) | 82 | 26 || FWH.Common.Chat | [FWH.Common.Chat.ChatService](#fwhcommonchatchatservice) | OnTextSubmitted() | 72 | 8 || FWH.Common.Chat | [FWH.Common.Chat.Services.CameraServiceFactory](#fwhcommonchatservicescameraservicefactory) | CreateCameraService() | 72 | 8 || FWH.Common.Location | [FWH.Common.Location.Services.RateLimitedLocationService](#fwhcommonlocationservicesratelimitedlocationservice) | ValidateCoordinates(...) | 72 | 8 || FWH.Mobile | [FWH.Mobile.Logging.AvaloniaLoggerProvider](#fwhmobileloggingavalonialoggerprovider) | Log(...) | 72 | 8 || FWH.Mobile | [FWH.Mobile.Services.GetNearbyBusinessesActionHandler](#fwhmobileservicesgetnearbybusinessesactionhandler) | .ctor(...) | 72 | 8 || FWH.Mobile | [FWH.Mobile.ViewModels.LogViewerViewModel](#fwhmobileviewmodelslogviewerviewmodel) | UpdateFilteredEntries(...) | 72 | 8 || FWH.Mobile | [FWH.Mobile.ViewModels.MovementStateViewModel](#fwhmobileviewmodelsmovementstateviewmodel) | .ctor(...) | 72 | 8 || FWH.Mobile | [FWH.Mobile.ViewModels.PlacesViewModel](#fwhmobileviewmodelsplacesviewmodel) | ToggleFavorite() | 72 | 8 || FWH.Mobile | [FWH.Mobile.Views.MapView](#fwhmobileviewsmapview) | InitializeMap() | 72 | 8 || FWH.Orchestrix.Mediator.Remote | [FWH.Orchestrix.Mediator.Remote.Marketing.UploadFeedbackAttachmentHandler](#fwhorchestrixmediatorremotemarketinguploadfeedbackattachmenthandler) | HandleAsync() | 72 | 8 || FWH.Mobile.Data | [FWH.Mobile.Data.Repositories.EfWorkflowRepository](#fwhmobiledatarepositoriesefworkflowrepository) | UpdateAsync() | 63 | 22 || FWH.Mobile | [FWH.Mobile.Logging.AvaloniaLogEntry](#fwhmobileloggingavalonialogentry) | get_LevelShort() | 56 | 7 || FWH.Mobile | [FWH.Mobile.Logging.AvaloniaLogEntry](#fwhmobileloggingavalonialogentry) | get_LevelColor() | 56 | 7 || FWH.Mobile | [FWH.Mobile.Logging.AvaloniaLogEntry](#fwhmobileloggingavalonialogentry) | get_LevelBackgroundColor() | 56 | 7 || FWH.Common.Workflow | [FWH.Common.Workflow.State.WorkflowStateCalculator](#fwhcommonworkflowstateworkflowstatecalculator) | CalculateCurrentPayload(...) | 49 | 38 || FWH.Common.Imaging | [FWH.Common.Imaging.ImagingService](#fwhcommonimagingimagingservice) | RenderSvgOverlay(...) | 43 | 38 || FWH.Common.Chat | [FWH.Common.Chat.ChatService](#fwhcommonchatchatservice) | PopulateFromWorkflow(...) | 42 | 6 || FWH.Common.Chat | [FWH.Common.Chat.ChatService](#fwhcommonchatchatservice) | OnImageCaptured() | 42 | 6 || FWH.Common.Location | [FWH.Common.Location.RateLimiting.TokenBucketRateLimiter](#fwhcommonlocationratelimitingtokenbucketratelimiter) | WaitAsync() | 42 | 6 || FWH.Common.Location | [FWH.Common.Location.Services.OverpassLocationService](#fwhcommonlocationservicesoverpasslocationservice) | HasAddressTags(...) | 42 | 6 || FWH.MarketingApi | [FWH.MarketingApi.Models.PaginationParameters](#fwhmarketingapimodelspaginationparameters) | Validate() | 42 | 6 || FWH.Mobile | [FWH.Mobile.ChatInputControl](#fwhmobilechatinputcontrol) | OnImageCaptured(...) | 42 | 6 || FWH.Mobile | [FWH.Mobile.Configuration.ApiSettings](#fwhmobileconfigurationapisettings) | GetLocationApiBaseUrl() | 42 | 6 || FWH.Mobile | [FWH.Mobile.Configuration.ApiSettings](#fwhmobileconfigurationapisettings) | GetMarketingApiBaseUrl() | 42 | 6 || FWH.Mobile | [FWH.Mobile.Configuration.LocationSettings](#fwhmobileconfigurationlocationsettings) | get_UseKmh() | 42 | 6 || FWH.Mobile | [FWH.Mobile.Services.ActivityTrackingService](#fwhmobileservicesactivitytrackingservice) | .ctor(...) | 42 | 6 || FWH.Mobile | [FWH.Mobile.Services.ImageService](#fwhmobileservicesimageservice) | GetImageUriAsync() | 42 | 6 || FWH.Mobile | [FWH.Mobile.Services.LocationTrackingService](#fwhmobileserviceslocationtrackingservice) | Dispose(...) | 42 | 6 || FWH.Mobile | [FWH.Mobile.Services.LocationWorkflowService](#fwhmobileserviceslocationworkflowservice) | .ctor(...) | 42 | 6 || FWH.Mobile | [FWH.Mobile.Services.MovementStateLogger](#fwhmobileservicesmovementstatelogger) | OnMovementStateChanged(...) | 42 | 6 || FWH.Mobile | [FWH.Mobile.Services.ThemeService](#fwhmobileservicesthemeservice) | TryParseColor(...) | 42 | 6 || FWH.Mobile | [FWH.Mobile.Services.ThemeService](#fwhmobileservicesthemeservice) | .ctor(...) | 42 | 6 || FWH.Mobile | [FWH.Mobile.ViewModels.ActivityTrackingViewModel](#fwhmobileviewmodelsactivitytrackingviewmodel) | UpdateDisplay() | 42 | 6 || FWH.Mobile | [FWH.Mobile.ViewModels.ActivityTrackingViewModel](#fwhmobileviewmodelsactivitytrackingviewmodel) | .ctor(...) | 42 | 6 || FWH.Mobile | [FWH.Mobile.ViewModels.MovementStateViewModel](#fwhmobileviewmodelsmovementstateviewmodel) | UpdateAddress() | 42 | 6 || FWH.Mobile | [FWH.Mobile.ViewModels.MovementStateViewModel](#fwhmobileviewmodelsmovementstateviewmodel) | UpdateMovementState(...) | 42 | 6 || FWH.Mobile | [FWH.Mobile.ViewModels.MovementStateViewModel](#fwhmobileviewmodelsmovementstateviewmodel) | UpdateSpeed() | 42 | 6 || FWH.Mobile | [FWH.Mobile.ViewModels.MovementStateViewModel](#fwhmobileviewmodelsmovementstateviewmodel) | UpdateCoordinates() | 42 | 6 || FWH.Mobile | [FWH.Mobile.ViewModels.PlacesViewModel](#fwhmobileviewmodelsplacesviewmodel) | .ctor(...) | 42 | 6 || FWH.Mobile | [FWH.Mobile.Views.FavoriteIconConverter](#fwhmobileviewsfavoriteiconconverter) | Convert(...) | 42 | 6 || FWH.Mobile | [FWH.Mobile.Views.FavoriteTooltipConverter](#fwhmobileviewsfavoritetooltipconverter) | Convert(...) | 42 | 6 || FWH.Mobile | [FWH.Mobile.Views.LogViewerControl](#fwhmobileviewslogviewercontrol) | OnPropertyChanged(...) | 42 | 6 || FWH.Mobile | [FWH.Mobile.Views.MainView](#fwhmobileviewsmainview) | .ctor() | 42 | 6 || FWH.Mobile | [FWH.Mobile.Views.MapView](#fwhmobileviewsmapview) | GetEmojiForMovementState(...) | 42 | 6 || FWH.Mobile | [FWH.Mobile.Views.MovementStateControl](#fwhmobileviewsmovementstatecontrol) | InitializeMap() | 42 | 6 || FWH.Mobile.Data | [FWH.Mobile.Data.Services.MobileDatabaseMigrationService](#fwhmobiledataservicesmobiledatabasemigrationservice) | EnsureDatabaseAsync() | 42 | 6 || FWH.Common.Workflow | [FWH.Common.Workflow.Controllers.WorkflowController](#fwhcommonworkflowcontrollersworkflowcontroller) | StartInstanceAsync() | 32 | 30 || FWH.Common.Location | [FWH.Common.Location.Services.OverpassLocationService](#fwhcommonlocationservicesoverpasslocationservice) | ConvertToBusinessLocation(...) | 26 | 26 || FWH.Common.Workflow | [FWH.Common.Workflow.State.WorkflowStateCalculator](#fwhcommonworkflowstateworkflowstatecalculator) | CalculateStartNode(...) | 25 | 24 || FWH.Mobile | [FWH.Mobile.Services.LocationTrackingService](#fwhmobileserviceslocationtrackingservice) | TrackLocationLoopAsync() | 27 | 24 || FWH.Common.Chat | [FWH.Common.Chat.ChatService](#fwhcommonchatchatservice) | <RenderWorkflowStateAsync() | 28 | 22 || FWH.Common.Workflow | [FWH.Common.Workflow.Actions.WorkflowActionRequestHandler](#fwhcommonworkflowactionsworkflowactionrequesthandler) | HandleAsync() | 26 | 20 || FWH.Common.Workflow | [FWH.Common.Workflow.Mapping.WorkflowModelMapper](#fwhcommonworkflowmappingworkflowmodelmapper) | ToDataModel(...) | 18 | 18 || FWH.Common.Chat | [FWH.Common.Chat.ChatService](#fwhcommonchatchatservice) | RenderWorkflowStateAsync() | 18 | 16 |
# Coverage

| **Name** | **Covered** | **Uncovered** | **Coverable** | **Total** | **Line coverage** | **Covered** | **Total** | **Branch coverage** |
|:---|---:|---:|---:|---:|---:|---:|---:|---:|
| **FWH.Common.Chat** | **311** | **296** | **607** | **1130** | **51.2%** | **88** | **228** | **38.5%** |
| [FWH.Common.Chat.ChatService](#fwhcommonchatchatservice) | 114 | 121 | 235 | 352 | 48.5% | 30 | 74 | 40.5% |
| [FWH.Common.Chat.Conversion.WorkflowToChatConverter](#fwhcommonchatconversionworkflowtochatconverter) | 23 | 0 | 23 | 47 | 100% | 10 | 12 | 83.3% |
| [FWH.Common.Chat.Duplicate.ChatDuplicateDetector](#fwhcommonchatduplicatechatduplicatedetector) | 8 | 12 | 20 | 41 | 40% | 6 | 18 | 33.3% |
| [FWH.Common.Chat.Extensions.ChatServiceCollectionExtensions](#fwhcommonchatextensionschatservicecollectionextensions) | 14 | 24 | 38 | 101 | 36.8% | 0 | 0 |  |
| [FWH.Common.Chat.Services.CameraServiceFactory](#fwhcommonchatservicescameraservicefactory) | 0 | 20 | 20 | 46 | 0% | 0 | 12 | 0% |
| [FWH.Common.Chat.Services.NoCameraService](#fwhcommonchatservicesnocameraservice) | 0 | 7 | 7 | 21 | 0% | 0 | 0 |  |
| [FWH.Common.Chat.Services.PlatformService](#fwhcommonchatservicesplatformservice) | 0 | 65 | 65 | 117 | 0% | 0 | 42 | 0% |
| [FWH.Common.Chat.ViewModels.ChatEntry<T>](#fwhcommonchatviewmodelschatentry<t>) | 5 | 0 | 5 | 19 | 100% | 0 | 0 |  |
| [FWH.Common.Chat.ViewModels.ChatInputViewModel](#fwhcommonchatviewmodelschatinputviewmodel) | 72 | 12 | 84 | 134 | 85.7% | 20 | 28 | 71.4% |
| [FWH.Common.Chat.ViewModels.ChatListViewModel](#fwhcommonchatviewmodelschatlistviewmodel) | 28 | 30 | 58 | 105 | 48.2% | 16 | 34 | 47% |
| [FWH.Common.Chat.ViewModels.ChatViewModel](#fwhcommonchatviewmodelschatviewmodel) | 7 | 0 | 7 | 16 | 100% | 0 | 0 |  |
| [FWH.Common.Chat.ViewModels.ChoiceChatEntry](#fwhcommonchatviewmodelschoicechatentry) | 4 | 3 | 7 | 17 | 57.1% | 2 | 2 | 100% |
| [FWH.Common.Chat.ViewModels.ChoicePayload](#fwhcommonchatviewmodelschoicepayload) | 14 | 0 | 14 | 34 | 100% | 3 | 4 | 75% |
| [FWH.Common.Chat.ViewModels.ChoicesItem](#fwhcommonchatviewmodelschoicesitem) | 9 | 0 | 9 | 29 | 100% | 1 | 2 | 50% |
| [FWH.Common.Chat.ViewModels.ImageChatEntry](#fwhcommonchatviewmodelsimagechatentry) | 4 | 2 | 6 | 14 | 66.6% | 0 | 0 |  |
| [FWH.Common.Chat.ViewModels.ImagePayload](#fwhcommonchatviewmodelsimagepayload) | 2 | 0 | 2 | 14 | 100% | 0 | 0 |  |
| [FWH.Common.Chat.ViewModels.TextChatEntry](#fwhcommonchatviewmodelstextchatentry) | 4 | 0 | 4 | 11 | 100% | 0 | 0 |  |
| [FWH.Common.Chat.ViewModels.TextPayload](#fwhcommonchatviewmodelstextpayload) | 3 | 0 | 3 | 12 | 100% | 0 | 0 |  |
| **FWH.Common.Imaging** | **113** | **34** | **147** | **278** | **76.8%** | **27** | **38** | **71%** |
| [FWH.Common.Imaging.Extensions.ImagingServiceCollectionExtensions](#fwhcommonimagingextensionsimagingservicecollectionextensions) | 4 | 4 | 8 | 30 | 50% | 0 | 0 |  |
| [FWH.Common.Imaging.ImagingOptions](#fwhcommonimagingimagingoptions) | 4 | 0 | 4 | 36 | 100% | 0 | 0 |  |
| [FWH.Common.Imaging.ImagingService](#fwhcommonimagingimagingservice) | 105 | 30 | 135 | 212 | 77.7% | 27 | 38 | 71% |
| **FWH.Common.Location** | **195** | **554** | **749** | **1409** | **26%** | **50** | **228** | **21.9%** |
| [FWH.Common.Location.Configuration.LocationServiceOptions](#fwhcommonlocationconfigurationlocationserviceoptions) | 11 | 2 | 13 | 59 | 84.6% | 2 | 4 | 50% |
| [FWH.Common.Location.Extensions.LocationServiceCollectionExtensions](#fwhcommonlocationextensionslocationservicecollectionextensions) | 21 | 121 | 142 | 197 | 14.7% | 0 | 4 | 0% |
| [FWH.Common.Location.LocationServicesException](#fwhcommonlocationlocationservicesexception) | 24 | 1 | 25 | 65 | 96% | 9 | 14 | 64.2% |
| [FWH.Common.Location.Models.BusinessLocation](#fwhcommonlocationmodelsbusinesslocation) | 7 | 2 | 9 | 47 | 77.7% | 0 | 0 |  |
| [FWH.Common.Location.Models.GpsCoordinates](#fwhcommonlocationmodelsgpscoordinates) | 15 | 10 | 25 | 68 | 60% | 3 | 6 | 50% |
| [FWH.Common.Location.RateLimiting.TokenBucketRateLimiter](#fwhcommonlocationratelimitingtokenbucketratelimiter) | 0 | 66 | 66 | 129 | 0% | 0 | 14 | 0% |
| [FWH.Common.Location.Services.GpsServiceFactory](#fwhcommonlocationservicesgpsservicefactory) | 0 | 26 | 26 | 55 | 0% | 0 | 16 | 0% |
| [FWH.Common.Location.Services.LocationConfigurationService](#fwhcommonlocationserviceslocationconfigurationservice) | 0 | 73 | 73 | 141 | 0% | 0 | 14 | 0% |
| [FWH.Common.Location.Services.NoGpsService](#fwhcommonlocationservicesnogpsservice) | 0 | 7 | 7 | 22 | 0% | 0 | 0 |  |
| [FWH.Common.Location.Services.OverpassLocationService](#fwhcommonlocationservicesoverpasslocationservice) | 117 | 185 | 302 | 499 | 38.7% | 36 | 144 | 25% |
| [FWH.Common.Location.Services.RateLimitedLocationService](#fwhcommonlocationservicesratelimitedlocationservice) | 0 | 61 | 61 | 127 | 0% | 0 | 12 | 0% |
| **FWH.Common.Workflow** | **1243** | **380** | **1623** | **3193** | **76.5%** | **440** | **648** | **67.9%** |
| [FWH.Common.Workflow.Actions.ActionHandlerContext](#fwhcommonworkflowactionsactionhandlercontext) | 8 | 3 | 11 | 21 | 72.7% | 0 | 0 |  |
| [FWH.Common.Workflow.Actions.WorkflowActionExecutor](#fwhcommonworkflowactionsworkflowactionexecutor) | 92 | 148 | 240 | 368 | 38.3% | 54 | 118 | 45.7% |
| [FWH.Common.Workflow.Actions.WorkflowActionExecutorOptions](#fwhcommonworkflowactionsworkflowactionexecutoroptions) | 3 | 0 | 3 | 20 | 100% | 0 | 0 |  |
| [FWH.Common.Workflow.Actions.WorkflowActionHandlerAdapter](#fwhcommonworkflowactionsworkflowactionhandleradapter) | 7 | 9 | 16 | 42 | 43.7% | 0 | 0 |  |
| [FWH.Common.Workflow.Actions.WorkflowActionHandlerRegistrar](#fwhcommonworkflowactionsworkflowactionhandlerregistrar) | 24 | 4 | 28 | 54 | 85.7% | 8 | 14 | 57.1% |
| [FWH.Common.Workflow.Actions.WorkflowActionHandlerRegistry](#fwhcommonworkflowactionsworkflowactionhandlerregistry) | 15 | 0 | 15 | 31 | 100% | 8 | 8 | 100% |
| [FWH.Common.Workflow.Actions.WorkflowActionRequest](#fwhcommonworkflowactionsworkflowactionrequest) | 7 | 0 | 7 | 22 | 100% | 0 | 0 |  |
| [FWH.Common.Workflow.Actions.WorkflowActionRequestHandler](#fwhcommonworkflowactionsworkflowactionrequesthandler) | 62 | 12 | 74 | 116 | 83.7% | 13 | 20 | 65% |
| [FWH.Common.Workflow.Actions.WorkflowActionResponse](#fwhcommonworkflowactionsworkflowactionresponse) | 3 | 0 | 3 | 22 | 100% | 0 | 0 |  |
| [FWH.Common.Workflow.Controllers.WorkflowController](#fwhcommonworkflowcontrollersworkflowcontroller) | 222 | 40 | 262 | 398 | 84.7% | 79 | 122 | 64.7% |
| [FWH.Common.Workflow.DependencyExtensions](#fwhcommonworkflowdependencyextensions) | 0 | 5 | 5 | 14 | 0% | 0 | 0 |  |
| [FWH.Common.Workflow.Extensions.WorkflowServiceCollectionExtensions](#fwhcommonworkflowextensionsworkflowservicecollectionextensions) | 35 | 13 | 48 | 143 | 72.9% | 4 | 4 | 100% |
| [FWH.Common.Workflow.Instance.InMemoryWorkflowInstanceManager](#fwhcommonworkflowinstanceinmemoryworkflowinstancemanager) | 27 | 1 | 28 | 58 | 96.4% | 10 | 14 | 71.4% |
| [FWH.Common.Workflow.Logging.CorrelationIdService](#fwhcommonworkflowloggingcorrelationidservice) | 9 | 4 | 13 | 51 | 69.2% | 2 | 2 | 100% |
| [FWH.Common.Workflow.Logging.LoggerExtensions](#fwhcommonworkflowloggingloggerextensions) | 79 | 1 | 80 | 148 | 98.7% | 19 | 20 | 95% |
| [FWH.Common.Workflow.Logging.LoggerHelpers](#fwhcommonworkflowloggingloggerhelpers) | 11 | 3 | 14 | 31 | 78.5% | 5 | 6 | 83.3% |
| [FWH.Common.Workflow.Logging.ScopeValidator](#fwhcommonworkflowloggingscopevalidator) | 13 | 1 | 14 | 43 | 92.8% | 9 | 18 | 50% |
| [FWH.Common.Workflow.Mapping.WorkflowModelMapper](#fwhcommonworkflowmappingworkflowmodelmapper) | 35 | 0 | 35 | 57 | 100% | 14 | 18 | 77.7% |
| [FWH.Common.Workflow.Models.StartPoint](#fwhcommonworkflowmodelsstartpoint) | 1 | 0 | 1 | 3 | 100% | 0 | 0 |  |
| [FWH.Common.Workflow.Models.Transition](#fwhcommonworkflowmodelstransition) | 1 | 0 | 1 | 3 | 100% | 0 | 0 |  |
| [FWH.Common.Workflow.Models.WorkflowDefinition](#fwhcommonworkflowmodelsworkflowdefinition) | 6 | 0 | 6 | 10 | 100% | 0 | 0 |  |
| [FWH.Common.Workflow.Models.WorkflowNode](#fwhcommonworkflowmodelsworkflownode) | 1 | 0 | 1 | 4 | 100% | 0 | 0 |  |
| [FWH.Common.Workflow.Models.WorkflowStateModel](#fwhcommonworkflowmodelsworkflowstatemodel) | 0 | 3 | 3 | 13 | 0% | 0 | 0 |  |
| [FWH.Common.Workflow.PlantUmlParser](#fwhcommonworkflowplantumlparser) | 336 | 47 | 383 | 539 | 87.7% | 136 | 158 | 86% |
| [FWH.Common.Workflow.State.WorkflowStateCalculator](#fwhcommonworkflowstateworkflowstatecalculator) | 62 | 9 | 71 | 113 | 87.3% | 47 | 64 | 73.4% |
| [FWH.Common.Workflow.Storage.InMemoryWorkflowDefinitionStore](#fwhcommonworkflowstorageinmemoryworkflowdefinitionstore) | 9 | 4 | 13 | 32 | 69.2% | 4 | 8 | 50% |
| [FWH.Common.Workflow.Views.WorkflowView](#fwhcommonworkflowviewsworkflowview) | 80 | 31 | 111 | 201 | 72% | 13 | 30 | 43.3% |
| [FWH.Common.Workflow.WorkflowChoiceOption](#fwhcommonworkflowworkflowchoiceoption) | 1 | 0 | 1 | 212 | 100% | 0 | 0 |  |
| [FWH.Common.Workflow.WorkflowService](#fwhcommonworkflowworkflowservice) | 93 | 42 | 135 | 212 | 68.8% | 15 | 24 | 62.5% |
| [FWH.Common.Workflow.WorkflowStatePayload](#fwhcommonworkflowworkflowstatepayload) | 1 | 0 | 1 | 212 | 100% | 0 | 0 |  |
| **FWH.MarketingApi** | **545** | **810** | **1355** | **2465** | **40.2%** | **114** | **226** | **50.4%** |
| [FWH.MarketingApi.Controllers.FeedbackController](#fwhmarketingapicontrollersfeedbackcontroller) | 120 | 88 | 208 | 407 | 57.6% | 24 | 48 | 50% |
| [FWH.MarketingApi.Controllers.MarketingController](#fwhmarketingapicontrollersmarketingcontroller) | 0 | 256 | 256 | 462 | 0% | 0 | 36 | 0% |
| [FWH.MarketingApi.Data.DatabaseMigrationService](#fwhmarketingapidatadatabasemigrationservice) | 95 | 67 | 162 | 255 | 58.6% | 29 | 54 | 53.7% |
| [FWH.MarketingApi.Data.MarketingDbContext](#fwhmarketingapidatamarketingdbcontext) | 12 | 215 | 227 | 263 | 5.2% | 0 | 0 |  |
| [FWH.MarketingApi.Middleware.ApiKeyAuthenticationMiddleware](#fwhmarketingapimiddlewareapikeyauthenticationmiddleware) | 49 | 5 | 54 | 97 | 90.7% | 24 | 30 | 80% |
| [FWH.MarketingApi.Models.Airport](#fwhmarketingapimodelsairport) | 12 | 2 | 14 | 24 | 85.7% | 0 | 0 |  |
| [FWH.MarketingApi.Models.AirportTourismMarket](#fwhmarketingapimodelsairporttourismmarket) | 6 | 0 | 6 | 14 | 100% | 0 | 0 |  |
| [FWH.MarketingApi.Models.Business](#fwhmarketingapimodelsbusiness) | 17 | 0 | 17 | 27 | 100% | 0 | 0 |  |
| [FWH.MarketingApi.Models.BusinessMarketingResponse](#fwhmarketingapimodelsbusinessmarketingresponse) | 0 | 6 | 6 | 14 | 0% | 0 | 0 |  |
| [FWH.MarketingApi.Models.BusinessTheme](#fwhmarketingapimodelsbusinesstheme) | 0 | 15 | 15 | 25 | 0% | 0 | 0 |  |
| [FWH.MarketingApi.Models.City](#fwhmarketingapimodelscity) | 9 | 4 | 13 | 23 | 69.2% | 0 | 0 |  |
| [FWH.MarketingApi.Models.CityMarketingResponse](#fwhmarketingapimodelscitymarketingresponse) | 0 | 7 | 7 | 17 | 0% | 0 | 0 |  |
| [FWH.MarketingApi.Models.CityTheme](#fwhmarketingapimodelscitytheme) | 0 | 15 | 15 | 25 | 0% | 0 | 0 |  |
| [FWH.MarketingApi.Models.CityThemeDto](#fwhmarketingapimodelscitythemedto) | 0 | 14 | 14 | 22 | 0% | 0 | 0 |  |
| [FWH.MarketingApi.Models.CityTourismMarket](#fwhmarketingapimodelscitytourismmarket) | 6 | 0 | 6 | 14 | 100% | 0 | 0 |  |
| [FWH.MarketingApi.Models.Coupon](#fwhmarketingapimodelscoupon) | 0 | 16 | 16 | 27 | 0% | 0 | 0 |  |
| [FWH.MarketingApi.Models.Feedback](#fwhmarketingapimodelsfeedback) | 21 | 0 | 21 | 39 | 100% | 0 | 0 |  |
| [FWH.MarketingApi.Models.FeedbackAttachment](#fwhmarketingapimodelsfeedbackattachment) | 11 | 0 | 11 | 21 | 100% | 0 | 0 |  |
| [FWH.MarketingApi.Models.MenuItem](#fwhmarketingapimodelsmenuitem) | 0 | 16 | 16 | 28 | 0% | 0 | 0 |  |
| [FWH.MarketingApi.Models.NewsItem](#fwhmarketingapimodelsnewsitem) | 0 | 14 | 14 | 25 | 0% | 0 | 0 |  |
| [FWH.MarketingApi.Models.PagedResult<T>](#fwhmarketingapimodelspagedresult<t>) | 0 | 7 | 7 | 79 | 0% | 0 | 0 |  |
| [FWH.MarketingApi.Models.PaginationParameters](#fwhmarketingapimodelspaginationparameters) | 0 | 9 | 9 | 79 | 0% | 0 | 6 | 0% |
| [FWH.MarketingApi.Models.SubmitFeedbackRequest](#fwhmarketingapimodelssubmitfeedbackrequest) | 11 | 0 | 11 | 89 | 100% | 0 | 0 |  |
| [FWH.MarketingApi.Models.TourismMarket](#fwhmarketingapimodelstourismmarket) | 7 | 1 | 8 | 18 | 87.5% | 0 | 0 |  |
| [FWH.MarketingApi.Models.UploadAttachmentRequest](#fwhmarketingapimodelsuploadattachmentrequest) | 0 | 5 | 5 | 13 | 0% | 0 | 0 |  |
| [FWH.MarketingApi.Services.LocalFileBlobStorageService](#fwhmarketingapiserviceslocalfileblobstorageservice) | 91 | 28 | 119 | 203 | 76.4% | 27 | 38 | 71% |
| [Program](#program) | 78 | 20 | 98 | 155 | 79.5% | 10 | 14 | 71.4% |
| **FWH.Mobile** | **407** | **3527** | **3934** | **8372** | **10.3%** | **91** | **1149** | **7.9%** |
| [FWH.Mobile.App](#fwhmobileapp) | 0 | 405 | 405 | 704 | 0% | 0 | 124 | 0% |
| [FWH.Mobile.ChatInputControl](#fwhmobilechatinputcontrol) | 0 | 139 | 139 | 249 | 0% | 0 | 54 | 0% |
| [FWH.Mobile.ChatListControl](#fwhmobilechatlistcontrol) | 0 | 54 | 54 | 141 | 0% | 0 | 4 | 0% |
| [FWH.Mobile.Configuration.ApiSettings](#fwhmobileconfigurationapisettings) | 0 | 20 | 20 | 72 | 0% | 0 | 12 | 0% |
| [FWH.Mobile.Configuration.LocationSettings](#fwhmobileconfigurationlocationsettings) | 9 | 5 | 14 | 52 | 64.2% | 3 | 16 | 18.7% |
| [FWH.Mobile.Logging.AvaloniaLogEntry](#fwhmobileloggingavalonialogentry) | 0 | 38 | 38 | 49 | 0% | 0 | 21 | 0% |
| [FWH.Mobile.Logging.AvaloniaLoggerProvider](#fwhmobileloggingavalonialoggerprovider) | 13 | 75 | 88 | 157 | 14.7% | 1 | 50 | 2% |
| [FWH.Mobile.Logging.AvaloniaLogStore](#fwhmobileloggingavalonialogstore) | 9 | 18 | 27 | 52 | 33.3% | 2 | 8 | 25% |
| [FWH.Mobile.Options.LocationApiClientOptions](#fwhmobileoptionslocationapiclientoptions) | 0 | 9 | 9 | 41 | 0% | 0 | 2 | 0% |
| [FWH.Mobile.Services.ActivityTrackingService](#fwhmobileservicesactivitytrackingservice) | 0 | 163 | 163 | 283 | 0% | 0 | 50 | 0% |
| [FWH.Mobile.Services.ApiAuthenticationService](#fwhmobileservicesapiauthenticationservice) | 0 | 43 | 43 | 88 | 0% | 0 | 18 | 0% |
| [FWH.Mobile.Services.ChatNotificationService](#fwhmobileserviceschatnotificationservice) | 0 | 33 | 33 | 61 | 0% | 0 | 18 | 0% |
| [FWH.Mobile.Services.GetNearbyBusinessesActionHandler](#fwhmobileservicesgetnearbybusinessesactionhandler) | 0 | 168 | 168 | 246 | 0% | 0 | 34 | 0% |
| [FWH.Mobile.Services.GpsCalculator](#fwhmobileservicesgpscalculator) | 31 | 33 | 64 | 184 | 48.4% | 2 | 2 | 100% |
| [FWH.Mobile.Services.ImageService](#fwhmobileservicesimageservice) | 0 | 143 | 143 | 224 | 0% | 0 | 38 | 0% |
| [FWH.Mobile.Services.LocationAddressChangedEventArgs](#fwhmobileserviceslocationaddresschangedeventargs) | 0 | 15 | 15 | 137 | 0% | 0 | 0 |  |
| [FWH.Mobile.Services.LocationApiClient](#fwhmobileserviceslocationapiclient) | 0 | 113 | 113 | 213 | 0% | 0 | 30 | 0% |
| [FWH.Mobile.Services.LocationTrackingService](#fwhmobileserviceslocationtrackingservice) | 330 | 286 | 616 | 899 | 53.5% | 83 | 186 | 44.6% |
| [FWH.Mobile.Services.LocationWorkflowService](#fwhmobileserviceslocationworkflowservice) | 0 | 134 | 134 | 231 | 0% | 0 | 38 | 0% |
| [FWH.Mobile.Services.MovementStateChangedEventArgs](#fwhmobileservicesmovementstatechangedeventargs) | 15 | 26 | 41 | 120 | 36.5% | 0 | 8 | 0% |
| [FWH.Mobile.Services.MovementStateLogger](#fwhmobileservicesmovementstatelogger) | 0 | 87 | 87 | 132 | 0% | 0 | 28 | 0% |
| [FWH.Mobile.Services.ThemeService](#fwhmobileservicesthemeservice) | 0 | 162 | 162 | 282 | 0% | 0 | 50 | 0% |
| [FWH.Mobile.ViewLocator](#fwhmobileviewlocator) | 0 | 13 | 13 | 31 | 0% | 0 | 4 | 0% |
| [FWH.Mobile.ViewModels.ActivityTrackingViewModel](#fwhmobileviewmodelsactivitytrackingviewmodel) | 0 | 39 | 39 | 88 | 0% | 0 | 12 | 0% |
| [FWH.Mobile.ViewModels.AuthorToAlignmentConverter](#fwhmobileviewmodelsauthortoalignmentconverter) | 0 | 2 | 2 | 81 | 0% | 0 | 4 | 0% |
| [FWH.Mobile.ViewModels.AuthorToBrushConverter](#fwhmobileviewmodelsauthortobrushconverter) | 0 | 2 | 2 | 81 | 0% | 0 | 4 | 0% |
| [FWH.Mobile.ViewModels.ByteArrayToImageConverter](#fwhmobileviewmodelsbytearraytoimageconverter) | 0 | 11 | 11 | 81 | 0% | 0 | 4 | 0% |
| [FWH.Mobile.ViewModels.CameraCaptureViewModel](#fwhmobileviewmodelscameracaptureviewmodel) | 0 | 58 | 58 | 117 | 0% | 0 | 18 | 0% |
| [FWH.Mobile.ViewModels.ChatInputModeToChoiceVisibility](#fwhmobileviewmodelschatinputmodetochoicevisibility) | 0 | 2 | 2 | 81 | 0% | 0 | 2 | 0% |
| [FWH.Mobile.ViewModels.ChatInputModeToPhotoVisibility](#fwhmobileviewmodelschatinputmodetophotovisibility) | 0 | 2 | 2 | 81 | 0% | 0 | 2 | 0% |
| [FWH.Mobile.ViewModels.ChatInputModeToTextVisibility](#fwhmobileviewmodelschatinputmodetotextvisibility) | 0 | 2 | 2 | 81 | 0% | 0 | 2 | 0% |
| [FWH.Mobile.ViewModels.LogViewerViewModel](#fwhmobileviewmodelslogviewerviewmodel) | 0 | 93 | 93 | 167 | 0% | 0 | 40 | 0% |
| [FWH.Mobile.ViewModels.MainViewModel](#fwhmobileviewmodelsmainviewmodel) | 0 | 28 | 28 | 74 | 0% | 0 | 0 |  |
| [FWH.Mobile.ViewModels.MovementStateViewModel](#fwhmobileviewmodelsmovementstateviewmodel) | 0 | 154 | 154 | 246 | 0% | 0 | 38 | 0% |
| [FWH.Mobile.ViewModels.PlaceItem](#fwhmobileviewmodelsplaceitem) | 0 | 29 | 29 | 540 | 0% | 0 | 10 | 0% |
| [FWH.Mobile.ViewModels.PlacesViewModel](#fwhmobileviewmodelsplacesviewmodel) | 0 | 338 | 338 | 540 | 0% | 0 | 96 | 0% |
| [FWH.Mobile.Views.CameraCaptureControl](#fwhmobileviewscameracapturecontrol) | 0 | 53 | 53 | 118 | 0% | 0 | 2 | 0% |
| [FWH.Mobile.Views.ChatView](#fwhmobileviewschatview) | 0 | 15 | 15 | 39 | 0% | 0 | 2 | 0% |
| [FWH.Mobile.Views.FavoriteIconConverter](#fwhmobileviewsfavoriteiconconverter) | 0 | 8 | 8 | 151 | 0% | 0 | 6 | 0% |
| [FWH.Mobile.Views.FavoriteTooltipConverter](#fwhmobileviewsfavoritetooltipconverter) | 0 | 8 | 8 | 151 | 0% | 0 | 6 | 0% |
| [FWH.Mobile.Views.LogView](#fwhmobileviewslogview) | 0 | 14 | 14 | 31 | 0% | 0 | 4 | 0% |
| [FWH.Mobile.Views.LogViewerControl](#fwhmobileviewslogviewercontrol) | 0 | 69 | 69 | 124 | 0% | 0 | 10 | 0% |
| [FWH.Mobile.Views.MainView](#fwhmobileviewsmainview) | 0 | 59 | 59 | 117 | 0% | 0 | 8 | 0% |
| [FWH.Mobile.Views.MainWindow](#fwhmobileviewsmainwindow) | 0 | 8 | 8 | 26 | 0% | 0 | 2 | 0% |
| [FWH.Mobile.Views.MapView](#fwhmobileviewsmapview) | 0 | 85 | 85 | 146 | 0% | 0 | 36 | 0% |
| [FWH.Mobile.Views.MovementStateControl](#fwhmobileviewsmovementstatecontrol) | 0 | 84 | 84 | 187 | 0% | 0 | 28 | 0% |
| [FWH.Mobile.Views.PlacesView](#fwhmobileviewsplacesview) | 0 | 108 | 108 | 206 | 0% | 0 | 4 | 0% |
| [FWH.Mobile.Views.SettingsView](#fwhmobileviewssettingsview) | 0 | 6 | 6 | 19 | 0% | 0 | 2 | 0% |
| [FWH.Mobile.Views.UrlToImageConverter](#fwhmobileviewsurltoimageconverter) | 0 | 68 | 68 | 151 | 0% | 0 | 12 | 0% |
| **FWH.Mobile.Data** | **278** | **477** | **755** | **1557** | **36.8%** | **25** | **82** | **30.4%** |
| [FWH.Mobile.Data.Data.NotesDbContext](#fwhmobiledatadatanotesdbcontext) | 98 | 0 | 98 | 136 | 100% | 0 | 0 |  |
| [FWH.Mobile.Data.DependencyInjection.ServiceCollectionExtensions](#fwhmobiledatadependencyinjectionservicecollectionextensions) | 0 | 9 | 9 | 22 | 0% | 0 | 0 |  |
| [FWH.Mobile.Data.Entities.CityMarketingInfoEntity](#fwhmobiledataentitiescitymarketinginfoentity) | 0 | 17 | 17 | 94 | 0% | 0 | 0 |  |
| [FWH.Mobile.Data.Entities.ConfigurationSetting](#fwhmobiledataentitiesconfigurationsetting) | 0 | 6 | 6 | 37 | 0% | 0 | 0 |  |
| [FWH.Mobile.Data.Entities.DeviceLocationEntity](#fwhmobiledataentitiesdevicelocationentity) | 11 | 1 | 12 | 71 | 91.6% | 0 | 0 |  |
| [FWH.Mobile.Data.Entities.ImageEntity](#fwhmobiledataentitiesimageentity) | 0 | 11 | 11 | 64 | 0% | 0 | 0 |  |
| [FWH.Mobile.Data.Entities.StationaryPlaceEntity](#fwhmobiledataentitiesstationaryplaceentity) | 0 | 19 | 19 | 105 | 0% | 0 | 0 |  |
| [FWH.Mobile.Data.Extensions.DataServiceCollectionExtensions](#fwhmobiledataextensionsdataservicecollectionextensions) | 0 | 25 | 25 | 87 | 0% | 0 | 0 |  |
| [FWH.Mobile.Data.Migrations.AddDeviceLocationHistory](#fwhmobiledatamigrationsadddevicelocationhistory) | 0 | 40 | 40 | 61 | 0% | 0 | 0 |  |
| [FWH.Mobile.Data.Migrations.AddWorkflowRowVersion](#fwhmobiledatamigrationsaddworkflowrowversion) | 0 | 13 | 13 | 30 | 0% | 0 | 0 |  |
| [FWH.Mobile.Data.Models.NodeEntity](#fwhmobiledatamodelsnodeentity) | 4 | 2 | 6 | 21 | 66.6% | 0 | 0 |  |
| [FWH.Mobile.Data.Models.Note](#fwhmobiledatamodelsnote) | 4 | 0 | 4 | 9 | 100% | 0 | 0 |  |
| [FWH.Mobile.Data.Models.StartPointEntity](#fwhmobiledatamodelsstartpointentity) | 2 | 2 | 4 | 17 | 50% | 0 | 0 |  |
| [FWH.Mobile.Data.Models.TransitionEntity](#fwhmobiledatamodelstransitionentity) | 4 | 2 | 6 | 19 | 66.6% | 0 | 0 |  |
| [FWH.Mobile.Data.Models.WorkflowDefinitionEntity](#fwhmobiledatamodelsworkflowdefinitionentity) | 7 | 1 | 8 | 30 | 87.5% | 0 | 0 |  |
| [FWH.Mobile.Data.Repositories.EfConfigurationRepository](#fwhmobiledatarepositoriesefconfigurationrepository) | 0 | 73 | 73 | 120 | 0% | 0 | 18 | 0% |
| [FWH.Mobile.Data.Repositories.EfNoteRepository](#fwhmobiledatarepositoriesefnoterepository) | 15 | 45 | 60 | 101 | 25% | 2 | 8 | 25% |
| [FWH.Mobile.Data.Repositories.EfWorkflowRepository](#fwhmobiledatarepositoriesefworkflowrepository) | 133 | 112 | 245 | 356 | 54.2% | 23 | 44 | 52.2% |
| [FWH.Mobile.Data.Services.MobileDatabaseMigrationService](#fwhmobiledataservicesmobiledatabasemigrationservice) | 0 | 58 | 58 | 114 | 0% | 0 | 12 | 0% |
| [FWH.Mobile.Data.Sqlite.SqliteDbInitializer](#fwhmobiledatasqlitesqlitedbinitializer) | 0 | 41 | 41 | 63 | 0% | 0 | 0 |  |
| **FWH.Orchestrix.Contracts** | **0** | **163** | **163** | **6998** | **0%** | **0** | **0** | **** |
| [FWH.Orchestrix.Contracts.Location.BusinessDto](#fwhorchestrixcontractslocationbusinessdto) | 0 | 10 | 10 | 111 | 0% | 0 | 0 |  |
| [FWH.Orchestrix.Contracts.Location.DeviceLocationDto](#fwhorchestrixcontractslocationdevicelocationdto) | 0 | 10 | 10 | 111 | 0% | 0 | 0 |  |
| [FWH.Orchestrix.Contracts.Location.GetDeviceLocationHistoryRequest](#fwhorchestrixcontractslocationgetdevicelocationhistoryrequest) | 0 | 5 | 5 | 111 | 0% | 0 | 0 |  |
| [FWH.Orchestrix.Contracts.Location.GetDeviceLocationHistoryResponse](#fwhorchestrixcontractslocationgetdevicelocationhistoryresponse) | 0 | 2 | 2 | 111 | 0% | 0 | 0 |  |
| [FWH.Orchestrix.Contracts.Location.GetNearbyBusinessesRequest](#fwhorchestrixcontractslocationgetnearbybusinessesrequest) | 0 | 5 | 5 | 111 | 0% | 0 | 0 |  |
| [FWH.Orchestrix.Contracts.Location.GetNearbyBusinessesResponse](#fwhorchestrixcontractslocationgetnearbybusinessesresponse) | 0 | 3 | 3 | 111 | 0% | 0 | 0 |  |
| [FWH.Orchestrix.Contracts.Location.LocationRequest](#fwhorchestrixcontractslocationlocationrequest) | 0 | 1 | 1 | 111 | 0% | 0 | 0 |  |
| [FWH.Orchestrix.Contracts.Location.LocationResponse](#fwhorchestrixcontractslocationlocationresponse) | 0 | 3 | 3 | 111 | 0% | 0 | 0 |  |
| [FWH.Orchestrix.Contracts.Location.UpdateDeviceLocationRequest](#fwhorchestrixcontractslocationupdatedevicelocationrequest) | 0 | 9 | 9 | 111 | 0% | 0 | 0 |  |
| [FWH.Orchestrix.Contracts.Location.UpdateDeviceLocationResponse](#fwhorchestrixcontractslocationupdatedevicelocationresponse) | 0 | 2 | 2 | 111 | 0% | 0 | 0 |  |
| [FWH.Orchestrix.Contracts.Marketing.BusinessMarketingDto](#fwhorchestrixcontractsmarketingbusinessmarketingdto) | 0 | 7 | 7 | 256 | 0% | 0 | 0 |  |
| [FWH.Orchestrix.Contracts.Marketing.BusinessSummaryDto](#fwhorchestrixcontractsmarketingbusinesssummarydto) | 0 | 8 | 8 | 256 | 0% | 0 | 0 |  |
| [FWH.Orchestrix.Contracts.Marketing.BusinessThemeDto](#fwhorchestrixcontractsmarketingbusinessthemedto) | 0 | 12 | 12 | 256 | 0% | 0 | 0 |  |
| [FWH.Orchestrix.Contracts.Marketing.CouponDto](#fwhorchestrixcontractsmarketingcoupondto) | 0 | 12 | 12 | 256 | 0% | 0 | 0 |  |
| [FWH.Orchestrix.Contracts.Marketing.FindNearbyBusinessesRequest](#fwhorchestrixcontractsmarketingfindnearbybusinessesrequest) | 0 | 4 | 4 | 256 | 0% | 0 | 0 |  |
| [FWH.Orchestrix.Contracts.Marketing.FindNearbyBusinessesResponse](#fwhorchestrixcontractsmarketingfindnearbybusinessesresponse) | 0 | 2 | 2 | 256 | 0% | 0 | 0 |  |
| [FWH.Orchestrix.Contracts.Marketing.GetBusinessCouponsRequest](#fwhorchestrixcontractsmarketinggetbusinesscouponsrequest) | 0 | 2 | 2 | 256 | 0% | 0 | 0 |  |
| [FWH.Orchestrix.Contracts.Marketing.GetBusinessCouponsResponse](#fwhorchestrixcontractsmarketinggetbusinesscouponsresponse) | 0 | 2 | 2 | 256 | 0% | 0 | 0 |  |
| [FWH.Orchestrix.Contracts.Marketing.GetBusinessMarketingRequest](#fwhorchestrixcontractsmarketinggetbusinessmarketingrequest) | 0 | 2 | 2 | 256 | 0% | 0 | 0 |  |
| [FWH.Orchestrix.Contracts.Marketing.GetBusinessMarketingResponse](#fwhorchestrixcontractsmarketinggetbusinessmarketingresponse) | 0 | 2 | 2 | 256 | 0% | 0 | 0 |  |
| [FWH.Orchestrix.Contracts.Marketing.GetBusinessMenuRequest](#fwhorchestrixcontractsmarketinggetbusinessmenurequest) | 0 | 3 | 3 | 256 | 0% | 0 | 0 |  |
| [FWH.Orchestrix.Contracts.Marketing.GetBusinessMenuResponse](#fwhorchestrixcontractsmarketinggetbusinessmenuresponse) | 0 | 2 | 2 | 256 | 0% | 0 | 0 |  |
| [FWH.Orchestrix.Contracts.Marketing.GetBusinessNewsRequest](#fwhorchestrixcontractsmarketinggetbusinessnewsrequest) | 0 | 3 | 3 | 256 | 0% | 0 | 0 |  |
| [FWH.Orchestrix.Contracts.Marketing.GetBusinessNewsResponse](#fwhorchestrixcontractsmarketinggetbusinessnewsresponse) | 0 | 2 | 2 | 256 | 0% | 0 | 0 |  |
| [FWH.Orchestrix.Contracts.Marketing.GetBusinessThemeRequest](#fwhorchestrixcontractsmarketinggetbusinessthemerequest) | 0 | 2 | 2 | 256 | 0% | 0 | 0 |  |
| [FWH.Orchestrix.Contracts.Marketing.GetBusinessThemeResponse](#fwhorchestrixcontractsmarketinggetbusinessthemeresponse) | 0 | 2 | 2 | 256 | 0% | 0 | 0 |  |
| [FWH.Orchestrix.Contracts.Marketing.MarketingResponse](#fwhorchestrixcontractsmarketingmarketingresponse) | 0 | 3 | 3 | 256 | 0% | 0 | 0 |  |
| [FWH.Orchestrix.Contracts.Marketing.MenuItemDto](#fwhorchestrixcontractsmarketingmenuitemdto) | 0 | 11 | 11 | 256 | 0% | 0 | 0 |  |
| [FWH.Orchestrix.Contracts.Marketing.NewsItemDto](#fwhorchestrixcontractsmarketingnewsitemdto) | 0 | 9 | 9 | 256 | 0% | 0 | 0 |  |
| [FWH.Orchestrix.Contracts.Marketing.SubmitFeedbackRequest](#fwhorchestrixcontractsmarketingsubmitfeedbackrequest) | 0 | 12 | 12 | 256 | 0% | 0 | 0 |  |
| [FWH.Orchestrix.Contracts.Marketing.SubmitFeedbackResponse](#fwhorchestrixcontractsmarketingsubmitfeedbackresponse) | 0 | 2 | 2 | 256 | 0% | 0 | 0 |  |
| [FWH.Orchestrix.Contracts.Marketing.UploadFeedbackAttachmentRequest](#fwhorchestrixcontractsmarketinguploadfeedbackattachmentrequest) | 0 | 6 | 6 | 256 | 0% | 0 | 0 |  |
| [FWH.Orchestrix.Contracts.Marketing.UploadFeedbackAttachmentResponse](#fwhorchestrixcontractsmarketinguploadfeedbackattachmentresponse) | 0 | 3 | 3 | 256 | 0% | 0 | 0 |  |
| **FWH.Orchestrix.Mediator.Remote** | **29** | **504** | **533** | **1330** | **5.4%** | **3** | **84** | **3.5%** |
| [FWH.Orchestrix.Mediator.Remote.Extensions.ApiAuthenticationMessageHandler](#fwhorchestrixmediatorremoteextensionsapiauthenticationmessagehandler) | 0 | 27 | 27 | 233 | 0% | 0 | 12 | 0% |
| [FWH.Orchestrix.Mediator.Remote.Extensions.ApiClientOptions](#fwhorchestrixmediatorremoteextensionsapiclientoptions) | 0 | 2 | 2 | 233 | 0% | 0 | 0 |  |
| [FWH.Orchestrix.Mediator.Remote.Extensions.MediatorServiceCollectionExtensions](#fwhorchestrixmediatorremoteextensionsmediatorservicecollectionextensions) | 12 | 121 | 133 | 233 | 9% | 0 | 4 | 0% |
| [FWH.Orchestrix.Mediator.Remote.Location.GetDeviceLocationHistoryHandler](#fwhorchestrixmediatorremotelocationgetdevicelocationhistoryhandler) | 0 | 44 | 44 | 73 | 0% | 0 | 12 | 0% |
| [FWH.Orchestrix.Mediator.Remote.Location.GetNearbyBusinessesHandler](#fwhorchestrixmediatorremotelocationgetnearbybusinesseshandler) | 0 | 43 | 43 | 72 | 0% | 0 | 14 | 0% |
| [FWH.Orchestrix.Mediator.Remote.Location.UpdateDeviceLocationHandler](#fwhorchestrixmediatorremotelocationupdatedevicelocationhandler) | 0 | 51 | 51 | 87 | 0% | 0 | 6 | 0% |
| [FWH.Orchestrix.Mediator.Remote.Marketing.GetBusinessCouponsHandler](#fwhorchestrixmediatorremotemarketinggetbusinesscouponshandler) | 0 | 37 | 37 | 65 | 0% | 0 | 6 | 0% |
| [FWH.Orchestrix.Mediator.Remote.Marketing.GetBusinessMarketingHandler](#fwhorchestrixmediatorremotemarketinggetbusinessmarketinghandler) | 0 | 37 | 37 | 65 | 0% | 0 | 4 | 0% |
| [FWH.Orchestrix.Mediator.Remote.Marketing.GetBusinessThemeHandler](#fwhorchestrixmediatorremotemarketinggetbusinessthemehandler) | 0 | 37 | 37 | 65 | 0% | 0 | 4 | 0% |
| [FWH.Orchestrix.Mediator.Remote.Marketing.SubmitFeedbackHandler](#fwhorchestrixmediatorremotemarketingsubmitfeedbackhandler) | 0 | 54 | 54 | 83 | 0% | 0 | 6 | 0% |
| [FWH.Orchestrix.Mediator.Remote.Marketing.UploadFeedbackAttachmentHandler](#fwhorchestrixmediatorremotemarketinguploadfeedbackattachmenthandler) | 0 | 46 | 46 | 77 | 0% | 0 | 10 | 0% |
| [FWH.Orchestrix.Mediator.Remote.Mediator.ServiceProviderMediatorSender](#fwhorchestrixmediatorremotemediatorserviceprovidermediatorsender) | 17 | 5 | 22 | 44 | 77.2% | 3 | 6 | 50% |
| **FWH.ServiceDefaults** | **60** | **6** | **66** | **118** | **90.9%** | **3** | **4** | **75%** |
| [Microsoft.Extensions.Hosting.Extensions](#microsoftextensionshostingextensions) | 60 | 6 | 66 | 118 | 90.9% | 3 | 4 | 75% |

# FWH.Common.Chat.ChatService

## Summary

|||
|:---|:---|
| Class: | FWH.Common.Chat.ChatService |
| Assembly: | FWH.Common.Chat |
| **File(s):** | E:\github\FunWasHad\src\FWH.Common.Chat\ChatService.cs |
| **Line coverage:** | 48.5% (114 of 235) |
| Covered lines: | 114 |
| Uncovered lines: | 121 |
| Coverable lines: | 235 |
| Total lines: | 352 |
| **Branch coverage:** | 40.5% (30 of 74) |
| Covered branches: | 30 |
| Total branches: | 74 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **.ctor(...)** | 50.0% | 6 | 6 | 100% |
| **StartAsync()** | 100% | 1 | 1 | 100% |
| **RenderWorkflowStateAsync()** | 87.50% | 18 | 16 | 81.81% |
| **<RenderWorkflowStateAsync()** | 59.09% | 28 | 22 | 77.14% |
| **PopulateFromWorkflow(...)** | 0% | 42 | 6 | 0% |
| **NormalizeNoteMarkdown(...)** | 0% | 110 | 10 | 0% |
| **OnTextSubmitted()** | 0% | 72 | 8 | 0% |
| **OnImageCaptured()** | 0% | 42 | 6 | 0% |
| **OnChoiceSubmitted(...)** | 100% | 2 | 1 | 0% |

## File(s)

### E:\github\FunWasHad\src\FWH.Common.Chat\ChatService.cs
```
  1            using System;
  2            using System.Threading.Tasks;
  3            using Microsoft.Extensions.DependencyInjection;
  4            using Microsoft.Extensions.Logging;
  5            using Microsoft.Extensions.Logging.Abstractions;
  6            using FWH.Common.Chat.ViewModels;
  7            using FWH.Common.Chat.Conversion;
  8            using FWH.Common.Chat.Duplicate;
  9            using FWH.Common.Workflow.Models;
 10            using FWH.Common.Workflow;
 11            
 12            namespace FWH.Common.Chat;
 13            
 14            /// <summary>
 15            /// Orchestrates chat operations and workflow integration.
 16            /// Single Responsibility: Coordinate chat UI and workflow interactions.
 17            /// </summary>
 18            public class ChatService
 19            {
 20                private readonly IServiceProvider _serviceProvider;
 21                private readonly ChatViewModel _chatViewModel;
 22                private readonly ILogger<ChatService> _logger;
 23                private readonly IWorkflowService? _workflowService;
 24                private readonly IWorkflowToChatConverter _converter;
 25                private readonly IChatDuplicateDetector _duplicateDetector;
 26            
 27                private string? _currentWorkflowId;
 28                private string? _currentUserId;
 29                private string? _currentTenantId;
 30                private string? _currentCorrelationId;
 31            
 32  ✔  19         public ChatService(
 33  ✔  19             IServiceProvider serviceProvider,
 34  ✔  19             IWorkflowToChatConverter converter,
 35  ✔  19             IChatDuplicateDetector duplicateDetector,
 36  ✔  19             ILogger<ChatService>? logger = null)
 37  ✔  19         {
 38  ✓  19  ◑          _serviceProvider = serviceProvider ?? throw new ArgumentNullException(nameof(serviceProvider));
 39  ✓  19  ◑          _converter = converter ?? throw new ArgumentNullException(nameof(converter));
 40  ✓  19  ◑          _duplicateDetector = duplicateDetector ?? throw new ArgumentNullException(nameof(duplicateDetector));
 41  ✔  19             _chatViewModel = serviceProvider.GetRequiredService<ChatViewModel>();
 42  ✔  19             _logger = FWH.Common.Workflow.Logging.LoggerHelpers.ResolveLogger<ChatService>(serviceProvider, logger);
 43  ✔  19             _workflowService = serviceProvider.GetService<IWorkflowService>();
 44  ✔  19         }
 45            
 46                public async Task StartAsync()
 47  ✔   4         {
 48  ✔   4             _chatViewModel.ChatInput.ChoiceSubmitted += OnChoiceSubmitted;
 49  ✔   4             _chatViewModel.ChatInput.TextSubmitted += OnTextSubmitted;
 50  ✔   4             _chatViewModel.ChatInput.ImageCaptured += OnImageCaptured;
 51            
 52  ✔   4             var chat = _chatViewModel.ChatList;
 53  ✔   4             chat.Reset();
 54            
 55                    // Add initial welcome message
 56  ✔   4             chat.AddEntry(new TextChatEntry(
 57  ✔   4                 FWH.Common.Chat.ViewModels.ChatAuthors.Bot,
 58  ✔   4                 "Welcome! Let's capture your fun experiences."));
 59            
 60  ✔   4             await Task.CompletedTask;
 61  ✔   4         }
 62            
 63                /// <summary>
 64                /// Render the current workflow state to the chat and wire choice selections to advance the workflow.
 65                /// For non-choice states, waits for user text input before advancing.
 66                /// Optional userId, tenantId and correlationId allow callers to supply contextual fields to be included in logging 
 67                /// </summary>
 68                public async Task RenderWorkflowStateAsync(string workflowId, string? userId = null, string? tenantId = null, string
 69  ✔  37         {
 70  ✔  39  ●          if (string.IsNullOrWhiteSpace(workflowId)) throw new ArgumentNullException(nameof(workflowId));
 71            
 72  ✓  35  ◑          if (_workflowService == null)
 73  ❌  0             {
 74  ❌  0                 _logger.LogWarning("WorkflowService not registered; cannot render workflow state for {WorkflowId}", workflow
 75  ❌  0                 return;
 76                    }
 77            
 78  ✔  35  ●          correlationId ??= Guid.NewGuid().ToString();
 79            
 80                    // Store current workflow context for text submission handler
 81  ✔  35             _currentWorkflowId = workflowId;
 82  ✔  35             _currentUserId = userId;
 83  ✔  35             _currentTenantId = tenantId;
 84  ✔  35             _currentCorrelationId = correlationId;
 85            
 86  ✔  35             _logger.LogDebug("RenderWorkflowStateAsync START - WorkflowId={WorkflowId} CorrelationId={CorrelationId}", workf
 87            
 88  ✔  35             var scopeDict = new System.Collections.Generic.Dictionary<string, object> { ["WorkflowId"] = workflowId, ["Opera
 89  ✔  39  ●          if (!string.IsNullOrWhiteSpace(userId)) scopeDict["UserId"] = userId;
 90  ✔  39  ●          if (!string.IsNullOrWhiteSpace(tenantId)) scopeDict["TenantId"] = tenantId;
 91            
 92  ✔  35             using var scope = _logger.BeginScope(scopeDict);
 93            
 94                    WorkflowStatePayload payload;
 95                    try
 96  ✔  35             {
 97  ✔  35                 payload = await _workflowService.GetCurrentStatePayloadAsync(workflowId);
 98  ✔  34             }
 99  ✔   1             catch (InvalidOperationException ex) when (ex.Message.Contains("Unknown workflow"))
100  ✔   1             {
101  ✔   1                 _logger.LogWarning(ex, "Workflow {WorkflowId} not found", workflowId);
102                        // Add error message to chat instead of crashing
103  ✔   1                 _chatViewModel.ChatList.AddEntry(new TextChatEntry(
104  ✔   1                     FWH.Common.Chat.ViewModels.ChatAuthors.Bot,
105  ✔   1                     $"Sorry, I couldn't find that workflow."));
106  ✔   1                 return;
107                    }
108  ❌  0             catch (Exception ex)
109  ❌  0             {
110  ❌  0                 _logger.LogError(ex, "Error getting workflow state for {WorkflowId}", workflowId);
111  ❌  0                 return;
112                    }
113            
114  ✔  34             var entry = _converter.ConvertToEntry(payload, workflowId);
115            
116  ✔  34             _logger.LogDebug("RenderWorkflowStateAsync - Built entry for WorkflowId={WorkflowId} IsChoice={IsChoice} Payload
117  ✔  34                 workflowId, payload.IsChoice, entry.Payload.PayloadType);
118            
119                    // If entry is a choice, subscribe to ChatInput.ChoiceSubmitted once so the selection is handled exactly once.
120  ✔  34  ●          if (entry is ChoiceChatEntry)
121  ✔   6             {
122  ✔   6                 EventHandler<ChoicesItem?>? inputHandler = null;
123  ✔   6                 inputHandler = async (s, selected) =>
124  ✔   5                 {
125  ✓   5  ◑                  _logger.LogDebug("Selection handler ENTER - WorkflowId={WorkflowId} SelectedValue={Selected}", workflowI
126  ✔   6     
127  ✔   6                     // Unsubscribe immediately to handle a single selection for this rendered state
128  ✔   5                     _chatViewModel.ChatInput.ChoiceSubmitted -= inputHandler!;
129  ✔   6     
130  ✓   5  ◑                  var advDict = new System.Collections.Generic.Dictionary<string, object> { ["WorkflowId"] = workflowId, [
131  ✔   7  ●                  if (!string.IsNullOrWhiteSpace(userId)) advDict["UserId"] = userId;
132  ✔   7  ●                  if (!string.IsNullOrWhiteSpace(tenantId)) advDict["TenantId"] = tenantId;
133  ✔   6     
134  ✔   5                     using var advScope = _logger.BeginScope(advDict);
135  ✔   6                     try
136  ✔   5                     {
137  ✓   5  ◔                      var chosenValue = selected?.ChoiceValue ?? selected?.DisplayOrder as object;
138  ✔   5                         var advanced = await _workflowService.AdvanceByChoiceValueAsync(workflowId, chosenValue);
139  ✓   5  ◑                      if (!advanced)
140  ❌  0                         {
141  ❌  0                             _logger.LogWarning("AdvanceByChoiceValueAsync returned false for workflow {WorkflowId} with valu
142  ❌  0                             return;
143  ✔   6                         }
144  ✔   6     
145  ✔   5                         _logger.LogDebug("Selection handler ADVANCED - WorkflowId={WorkflowId} ChosenValue={Value}", workflo
146  ✔   6     
147  ✔   6                         // after advancing, render the new state
148  ✔   5                         await RenderWorkflowStateAsync(workflowId, userId, tenantId, correlationId);
149  ✔   6     
150  ✔   6                         // Diagnostic: emit debug-scoped chat list contents
151  ✔   6                         try
152  ✔   5                         {
153  ✔   5                             var list = _chatViewModel.ChatList;
154  ✔   5                             _logger.LogDebug("After render EntriesCount={Count}", list.Entries.Count);
155  ✔  30  ●                          for (int i = 0; i < list.Entries.Count; i++)
156  ✔  10                             {
157  ✔  10                                 var e = list.Entries[i];
158  ✔  10                                 _logger.LogDebug("Entry[{Index}] Type={Type} PayloadType={PayloadType}", i, e.GetType().Name
159  ✔  10                             }
160  ✔   5                         }
161  ❌  0                         catch { }
162  ✔   5                     }
163  ❌  0                     catch (Exception ex)
164  ❌  0                     {
165  ❌  0                         _logger.LogError(ex, "Error advancing workflow {WorkflowId}", workflowId);
166  ❌  0                     }
167  ✔   6                     finally
168  ✔   5                     {
169  ✔   5                         _logger.LogDebug("Selection handler EXIT - WorkflowId={WorkflowId}", workflowId);
170  ✔   5                     }
171  ✔  11                 };
172            
173                        // Attach handler to ChatInput.ChoiceSubmitted which is raised by ChatInputViewModel when a choice is select
174  ✔   6                 _chatViewModel.ChatInput.ChoiceSubmitted += inputHandler;
175  ✔   6             }
176  ✔  28  ●          else if (entry.Payload.PayloadType == PayloadTypes.Image)
177  ✔   2             {
178                        // For image/camera nodes, the workflow will auto-advance when image is captured
179  ✔   2                 _logger.LogDebug("Image/camera node rendered - waiting for image capture to advance workflow");
180  ✔   2             }
181                    else
182  ✔  26             {
183                        // For non-choice, non-image states (TextChatEntry), the workflow waits for user text input
184                        // The OnTextSubmitted handler will advance the workflow when user responds
185  ✔  26                 _logger.LogDebug("Non-choice state rendered - waiting for user text input to advance workflow");
186  ✔  26             }
187            
188                    // Append entry to chat list using duplicate detector
189                    try
190  ✔  34             {
191  ✔  34                 var chatList = _chatViewModel.ChatList;
192  ✔  34                 var last = chatList.Current;
193            
194  ✓  34  ◑              if (!_duplicateDetector.IsDuplicate(entry, last))
195  ✔  34                 {
196  ✔  34                     chatList.AddEntry(entry);
197  ✔  34                     _logger.LogDebug("Appended entry to ChatList - WorkflowId={WorkflowId} CurrentCount={Count}", workflowId
198  ✔  34                 }
199                        else
200  ❌  0                 {
201  ❌  0                     _logger.LogDebug("Skipped adding duplicate entry for WorkflowId={WorkflowId}", workflowId);
202  ❌  0                 }
203  ✔  34             }
204  ❌  0             catch (Exception ex)
205  ❌  0             {
206  ❌  0                 _logger.LogError(ex, "Failed to add chat entry for workflow {WorkflowId}", workflowId);
207  ❌  0             }
208  ✔  34             _logger.LogDebug("RenderWorkflowStateAsync END - WorkflowId={WorkflowId} CorrelationId={CorrelationId}", workflo
209  ✔  35         }
210            
211                /// <summary>
212                /// Create chat entries for workflow nodes that include note markdown.
213                /// </summary>
214                public void PopulateFromWorkflow(WorkflowDefinition def)
215  ❌  0         {
216  ❌  0  ○          if (def == null) throw new ArgumentNullException(nameof(def));
217            
218  ❌  0             var chat = _chatViewModel.ChatList;
219            
220  ❌  0  ○          foreach (var node in def.Nodes)
221  ❌  0             {
222  ❌  0  ○              if (!string.IsNullOrWhiteSpace(node.NoteMarkdown))
223  ❌  0                 {
224                            // Normalize whitespace
225  ❌  0                     var text = NormalizeNoteMarkdown(node.NoteMarkdown);
226  ❌  0                     chat.AddEntry(new TextChatEntry(FWH.Common.Chat.ViewModels.ChatAuthors.Bot, text));
227  ❌  0                 }
228  ❌  0             }
229  ❌  0         }
230            
231                private static string NormalizeNoteMarkdown(string raw)
232  ❌  0         {
233  ❌  0  ○          if (string.IsNullOrWhiteSpace(raw)) return string.Empty;
234  ❌  0             var lines = raw.Split(new[] { '\r', '\n' }, StringSplitOptions.RemoveEmptyEntries);
235  ❌  0  ○          for (int i = 0; i < lines.Length; i++)
236  ❌  0             {
237  ❌  0                 var l = lines[i].Trim();
238  ❌  0  ○              if (l.StartsWith("|")) l = l[1..].TrimStart();
239  ❌  0  ○              if (l.StartsWith("\"") && l.EndsWith("\"")) l = l[1..^1];
240  ❌  0                 lines[i] = l;
241  ❌  0             }
242  ❌  0             return string.Join('\n', lines).Trim();
243  ❌  0         }
244            
245                private async void OnTextSubmitted(object? sender, string text)
246  ❌  0         {
247  ❌  0  ○          if (string.IsNullOrWhiteSpace(_currentWorkflowId))
248  ❌  0             {
249  ❌  0                 _logger.LogDebug("OnTextSubmitted - no active workflow");
250  ❌  0                 return;
251                    }
252            
253  ❌  0  ○          if (_workflowService == null)
254  ❌  0             {
255  ❌  0                 _logger.LogWarning("OnTextSubmitted - WorkflowService not available");
256  ❌  0                 return;
257                    }
258            
259  ❌  0             _logger.LogDebug("OnTextSubmitted - Text='{Text}' WorkflowId={WorkflowId}", text, _currentWorkflowId);
260            
261                    try
262  ❌  0             {
263                        // Add user's text response to chat
264  ❌  0                 _chatViewModel.ChatList.AddEntry(new TextChatEntry(
265  ❌  0                     FWH.Common.Chat.ViewModels.ChatAuthors.User,
266  ❌  0                     text));
267            
268                        // Get current state to check if we can advance
269  ❌  0                 var currentState = await _workflowService.GetCurrentStatePayloadAsync(_currentWorkflowId);
270            
271  ❌  0  ○              if (!currentState.IsChoice)
272  ❌  0                 {
273                            // For non-choice nodes, try to auto-advance with null (single path)
274  ❌  0                     _logger.LogDebug("Attempting to advance non-choice workflow state");
275  ❌  0                     var advanced = await _workflowService.AdvanceByChoiceValueAsync(_currentWorkflowId, null);
276            
277  ❌  0  ○                  if (advanced)
278  ❌  0                     {
279  ❌  0                         _logger.LogDebug("Workflow advanced successfully after user text input");
280                                // Render the next state
281  ❌  0                         await RenderWorkflowStateAsync(
282  ❌  0                             _currentWorkflowId,
283  ❌  0                             _currentUserId,
284  ❌  0                             _currentTenantId,
285  ❌  0                             _currentCorrelationId);
286  ❌  0                     }
287                            else
288  ❌  0                     {
289  ❌  0                         _logger.LogWarning("Failed to advance workflow after user text input");
290  ❌  0                     }
291  ❌  0                 }
292                        else
293  ❌  0                 {
294  ❌  0                     _logger.LogDebug("Current state is a choice - user should select from options, not submit text");
295  ❌  0                 }
296  ❌  0             }
297  ❌  0             catch (Exception ex)
298  ❌  0             {
299  ❌  0                 _logger.LogError(ex, "Error handling text submission for workflow {WorkflowId}", _currentWorkflowId);
300  ❌  0             }
301  ❌  0         }
302            
303                private async void OnImageCaptured(object? sender, byte[] imageBytes)
304  ❌  0         {
305  ❌  0  ○          if (string.IsNullOrWhiteSpace(_currentWorkflowId))
306  ❌  0             {
307  ❌  0                 _logger.LogDebug("OnImageCaptured - no active workflow");
308  ❌  0                 return;
309                    }
310            
311  ❌  0  ○          if (_workflowService == null)
312  ❌  0             {
313  ❌  0                 _logger.LogWarning("OnImageCaptured - WorkflowService not available");
314  ❌  0                 return;
315                    }
316            
317  ❌  0             _logger.LogDebug("OnImageCaptured - ImageSize={Size} WorkflowId={WorkflowId}", imageBytes.Length, _currentWorkfl
318            
319                    try
320  ❌  0             {
321                        // Image was captured, advance the workflow
322                        // Camera nodes are treated as non-choice nodes that auto-advance
323  ❌  0                 _logger.LogDebug("Attempting to advance workflow after image capture");
324  ❌  0                 var advanced = await _workflowService.AdvanceByChoiceValueAsync(_currentWorkflowId, null);
325            
326  ❌  0  ○              if (advanced)
327  ❌  0                 {
328  ❌  0                     _logger.LogDebug("Workflow advanced successfully after image capture");
329                            // Render the next state
330  ❌  0                     await RenderWorkflowStateAsync(
331  ❌  0                         _currentWorkflowId,
332  ❌  0                         _currentUserId,
333  ❌  0                         _currentTenantId,
334  ❌  0                         _currentCorrelationId);
335  ❌  0                 }
336                        else
337  ❌  0                 {
338  ❌  0                     _logger.LogWarning("Failed to advance workflow after image capture");
339  ❌  0                 }
340  ❌  0             }
341  ❌  0             catch (Exception ex)
342  ❌  0             {
343  ❌  0                 _logger.LogError(ex, "Error handling image capture for workflow {WorkflowId}", _currentWorkflowId);
344  ❌  0             }
345  ❌  0         }
346            
347                private void OnChoiceSubmitted(object? sender, FWH.Common.Chat.ViewModels.ChoicesItem? e)
348  ❌  0         {
349                    // This is now handled inline in RenderWorkflowStateAsync for better context
350  ❌  0             _logger.LogDebug("OnChoiceSubmitted event fired (handled inline in RenderWorkflowStateAsync)");
351  ❌  0         }
352            }
```
# FWH.Common.Chat.Conversion.WorkflowToChatConverter

## Summary

|||
|:---|:---|
| Class: | FWH.Common.Chat.Conversion.WorkflowToChatConverter |
| Assembly: | FWH.Common.Chat |
| **File(s):** | E:\github\FunWasHad\src\FWH.Common.Chat\Conversion\WorkflowToChatConverter.cs |
| **Line coverage:** | 100% (23 of 23) |
| Covered lines: | 23 |
| Uncovered lines: | 0 |
| Coverable lines: | 23 |
| Total lines: | 47 |
| **Branch coverage:** | 83.3% (10 of 12) |
| Covered branches: | 10 |
| Total branches: | 12 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **ConvertToEntry(...)** | 83.33% | 12 | 12 | 100% |

## File(s)

### E:\github\FunWasHad\src\FWH.Common.Chat\Conversion\WorkflowToChatConverter.cs
```
 1            using System;
 2            using System.Linq;
 3            using FWH.Common.Chat.ViewModels;
 4            using FWH.Common.Workflow;
 5            
 6            namespace FWH.Common.Chat.Conversion;
 7            
 8            /// <summary>
 9            /// Converts workflow state payloads to chat entries.
10            /// Single Responsibility: Workflow-to-chat data transformation.
11            /// </summary>
12            public class WorkflowToChatConverter : IWorkflowToChatConverter
13            {
14                public IChatEntry<IPayload> ConvertToEntry(WorkflowStatePayload payload, string workflowId)
15  ✔  34         {
16  ✓  34  ◑          if (payload == null) throw new ArgumentNullException(nameof(payload));
17            
18                    // Check if this is a camera node
19  ✔  34  ●          if (!string.IsNullOrWhiteSpace(payload.NodeLabel) &&
20  ✔  34                 payload.NodeLabel.Equals("camera", StringComparison.OrdinalIgnoreCase))
21  ✔   2             {
22  ✔   2                 var imagePayload = new ImagePayload
23  ✔   2                 {
24  ✔   2                     Image = null, // Will be populated by camera capture
25  ✔   2                     ShowBorder = true
26  ✔   2                 };
27  ✔   2                 return new ImageChatEntry(ChatAuthors.Bot, imagePayload);
28                    }
29            
30  ✔  32  ●          if (!payload.IsChoice)
31  ✔  26             {
32  ✓  26  ◑              return new TextChatEntry(ChatAuthors.Bot, payload.Text ?? string.Empty);
33                    }
34            
35                    // Build choice items from workflow options
36  ✔   6             var items = payload.Choices.Select((opt, i) =>
37  ✔  18                 new ChoicesItem(i, opt.DisplayText, opt.TargetNodeId)).ToList();
38            
39  ✔   6  ●          var choicePayload = new ChoicePayload(items)
40  ✔   6             {
41  ✔   6                 Prompt = payload.Text ?? "Choose an option",
42  ✔   6                 Title = ""
43  ✔   6             };
44            
45  ✔   6             return new ChoiceChatEntry(ChatAuthors.Bot, choicePayload);
46  ✔  34         }
47            }
```
# FWH.Common.Chat.Duplicate.ChatDuplicateDetector

## Summary

|||
|:---|:---|
| Class: | FWH.Common.Chat.Duplicate.ChatDuplicateDetector |
| Assembly: | FWH.Common.Chat |
| **File(s):** | E:\github\FunWasHad\src\FWH.Common.Chat\Duplicate\ChatDuplicateDetector.cs |
| **Line coverage:** | 40% (8 of 20) |
| Covered lines: | 8 |
| Uncovered lines: | 12 |
| Coverable lines: | 20 |
| Total lines: | 41 |
| **Branch coverage:** | 33.3% (6 of 18) |
| Covered branches: | 6 |
| Total branches: | 18 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **IsDuplicate(...)** | 33.33% | 88 | 18 | 40.0% |

## File(s)

### E:\github\FunWasHad\src\FWH.Common.Chat\Duplicate\ChatDuplicateDetector.cs
```
 1            using FWH.Common.Chat.ViewModels;
 2            
 3            namespace FWH.Common.Chat.Duplicate;
 4            
 5            /// <summary>
 6            /// Detects duplicate chat entries to prevent redundant UI elements.
 7            /// Single Responsibility: Duplicate detection logic for chat entries.
 8            /// </summary>
 9            public class ChatDuplicateDetector : IChatDuplicateDetector
10            {
11                public bool IsDuplicate(IChatEntry<IPayload> newEntry, IChatEntry<IPayload>? lastEntry)
12  ✔  34         {
13  ✓  34  ◑          if (newEntry == null || lastEntry == null)
14  ✔  13                 return false;
15            
16                    // Only check for choice duplicates
17  ✔  21  ●          if (newEntry.Payload.PayloadType != PayloadTypes.Choice)
18  ✔  20                 return false;
19            
20  ✓   1  ◑          if (lastEntry.Payload.PayloadType != PayloadTypes.Choice)
21  ✔   1                 return false;
22            
23  ❌  0             var lastChoice = lastEntry.Payload as ChoicePayload;
24  ❌  0             var newChoice = newEntry.Payload as ChoicePayload;
25            
26  ❌  0  ○          if (lastChoice == null || newChoice == null)
27  ❌  0                 return false;
28            
29  ❌  0  ○          if (lastChoice.Choices.Count != newChoice.Choices.Count)
30  ❌  0                 return false;
31            
32                    // Compare choice texts
33  ❌  0  ○          for (int i = 0; i < lastChoice.Choices.Count; i++)
34  ❌  0             {
35  ❌  0  ○              if (lastChoice.Choices[i].ChoiceText != newChoice.Choices[i].ChoiceText)
36  ❌  0                     return false;
37  ❌  0             }
38            
39  ❌  0             return true;
40  ✔  34         }
41            }
```
# FWH.Common.Chat.Extensions.ChatServiceCollectionExtensions

## Summary

|||
|:---|:---|
| Class: | FWH.Common.Chat.Extensions.ChatServiceCollectionExtensions |
| Assembly: | FWH.Common.Chat |
| **File(s):** | E:\github\FunWasHad\src\FWH.Common.Chat\Extensions\ChatServiceCollectionExtensions.cs |
| **Line coverage:** | 36.8% (14 of 38) |
| Covered lines: | 14 |
| Uncovered lines: | 24 |
| Coverable lines: | 38 |
| Total lines: | 101 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **AddChatServices(...)** | 100% | 1 | 1 | 82.35% |
| **AddChatService(...)** | 100% | 2 | 1 | 0% |
| **AddChatViewModels(...)** | 100% | 2 | 1 | 0% |
| **AddWorkflowToChatConversion(...)** | 100% | 2 | 1 | 0% |
| **AddChatServicesWithImaging(...)** | 100% | 2 | 1 | 0% |

## File(s)

### E:\github\FunWasHad\src\FWH.Common.Chat\Extensions\ChatServiceCollectionExtensions.cs
```
  1            using System;
  2            using Microsoft.Extensions.DependencyInjection;
  3            using FWH.Common.Chat.ViewModels;
  4            using FWH.Common.Chat.Conversion;
  5            using FWH.Common.Chat.Duplicate;
  6            using FWH.Common.Chat.Services;
  7            using FWH.Common.Imaging.Extensions;
  8            
  9            namespace FWH.Common.Chat.Extensions;
 10            
 11            /// <summary>
 12            /// Extension methods for registering chat services with dependency injection.
 13            /// Single Responsibility: Configure DI for chat components.
 14            /// </summary>
 15            public static class ChatServiceCollectionExtensions
 16            {
 17                /// <summary>
 18                /// Adds all chat services to the service collection.
 19                /// Includes converter, duplicate detector, chat service, and view models.
 20                /// </summary>
 21                /// <param name="services">The service collection to add services to.</param>
 22                /// <returns>The service collection for chaining.</returns>
 23                public static IServiceCollection AddChatServices(this IServiceCollection services)
 24  ✔  35         {
 25                    // Core chat components (SRP-compliant)
 26  ✔  35             services.AddSingleton<IWorkflowToChatConverter, WorkflowToChatConverter>();
 27  ✔  35             services.AddSingleton<IChatDuplicateDetector, ChatDuplicateDetector>();
 28  ✔  35             services.AddSingleton<ChatService>();
 29            
 30                    // Platform detection
 31  ✔  35             services.AddSingleton<IPlatformService, PlatformService>();
 32            
 33                    // Camera service factory
 34  ✔  35             services.AddSingleton<CameraServiceFactory>();
 35            
 36                    // Register camera service using factory
 37  ✔  35             services.AddSingleton<ICameraService>(sp =>
 38  ❌  0             {
 39  ❌  0                 var factory = sp.GetRequiredService<CameraServiceFactory>();
 40  ❌  0                 return factory.CreateCameraService();
 41  ✔  35             });
 42            
 43                    // View models
 44  ✔  35             services.AddSingleton<ChatListViewModel>();
 45  ✔  35             services.AddSingleton<ChatInputViewModel>(sp =>
 46  ✔  48                 new ChatInputViewModel(sp.GetRequiredService<ChatListViewModel>()));
 47  ✔  35             services.AddSingleton<ChatViewModel>();
 48            
 49  ✔  35             return services;
 50  ✔  35         }
 51            
 52                /// <summary>
 53                /// Adds chat service to the service collection.
 54                /// Requires workflow-to-chat converter and duplicate detector to be registered.
 55                /// </summary>
 56                /// <param name="services">The service collection to add services to.</param>
 57                /// <returns>The service collection for chaining.</returns>
 58                public static IServiceCollection AddChatService(this IServiceCollection services)
 59  ❌  0         {
 60  ❌  0             services.AddSingleton<ChatService>();
 61  ❌  0             return services;
 62  ❌  0         }
 63            
 64                /// <summary>
 65                /// Adds chat view models to the service collection.
 66                /// </summary>
 67                /// <param name="services">The service collection to add services to.</param>
 68                /// <returns>The service collection for chaining.</returns>
 69                public static IServiceCollection AddChatViewModels(this IServiceCollection services)
 70  ❌  0         {
 71  ❌  0             services.AddSingleton<ChatListViewModel>();
 72  ❌  0             services.AddSingleton<ChatInputViewModel>(sp =>
 73  ❌  0                 new ChatInputViewModel(sp.GetRequiredService<ChatListViewModel>()));
 74  ❌  0             services.AddSingleton<ChatViewModel>();
 75            
 76  ❌  0             return services;
 77  ❌  0         }
 78            
 79                /// <summary>
 80                /// Adds workflow-to-chat conversion components to the service collection.
 81                /// </summary>
 82                /// <param name="services">The service collection to add services to.</param>
 83                /// <returns>The service collection for chaining.</returns>
 84                public static IServiceCollection AddWorkflowToChatConversion(this IServiceCollection services)
 85  ❌  0         {
 86  ❌  0             services.AddSingleton<IWorkflowToChatConverter, WorkflowToChatConverter>();
 87  ❌  0             services.AddSingleton<IChatDuplicateDetector, ChatDuplicateDetector>();
 88            
 89  ❌  0             return services;
 90  ❌  0         }
 91            
 92                /// <summary>
 93                /// Convenience method to register chat-related services plus imaging if desired.
 94                /// </summary>
 95                public static IServiceCollection AddChatServicesWithImaging(this IServiceCollection services)
 96  ❌  0         {
 97  ❌  0             services.AddChatServices();
 98  ❌  0             services.AddImagingServices();
 99  ❌  0             return services;
100  ❌  0         }
101            }
```
# FWH.Common.Chat.Services.CameraServiceFactory

## Summary

|||
|:---|:---|
| Class: | FWH.Common.Chat.Services.CameraServiceFactory |
| Assembly: | FWH.Common.Chat |
| **File(s):** | E:\github\FunWasHad\src\FWH.Common.Chat\Services\CameraServiceFactory.cs |
| **Line coverage:** | 0% (0 of 20) |
| Covered lines: | 0 |
| Uncovered lines: | 20 |
| Coverable lines: | 20 |
| Total lines: | 46 |
| **Branch coverage:** | 0% (0 of 12) |
| Covered branches: | 0 |
| Total branches: | 12 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **.ctor(...)** | 0% | 20 | 4 | 0% |
| **CreateCameraService()** | 0% | 72 | 8 | 0% |

## File(s)

### E:\github\FunWasHad\src\FWH.Common.Chat\Services\CameraServiceFactory.cs
```
 1           using System;
 2           using Microsoft.Extensions.DependencyInjection;
 3           
 4           namespace FWH.Common.Chat.Services;
 5           
 6           /// <summary>
 7           /// Factory for creating platform-specific camera services
 8           /// </summary>
 9           public class CameraServiceFactory
10           {
11               private readonly IServiceProvider _serviceProvider;
12               private readonly IPlatformService _platformService;
13           
14  ❌ 0         public CameraServiceFactory(IServiceProvider serviceProvider, IPlatformService platformService)
15  ❌ 0         {
16  ❌ 0  ○          _serviceProvider = serviceProvider ?? throw new ArgumentNullException(nameof(serviceProvider));
17  ❌ 0  ○          _platformService = platformService ?? throw new ArgumentNullException(nameof(platformService));
18  ❌ 0         }
19           
20               /// <summary>
21               /// Creates the appropriate camera service for the current platform
22               /// </summary>
23               public ICameraService CreateCameraService()
24  ❌ 0         {
25                   // Try to get platform-specific implementations from DI
26                   // The platform-specific projects will register their implementations with a key
27           
28  ❌ 0  ○          if (_platformService.IsAndroid)
29  ❌ 0             {
30                       // Try to get Android-specific service
31  ❌ 0                 var androidService = _serviceProvider.GetKeyedService<ICameraService>("Android");
32  ❌ 0  ○              if (androidService != null)
33  ❌ 0                     return androidService;
34  ❌ 0             }
35  ❌ 0  ○          else if (_platformService.IsIOS)
36  ❌ 0             {
37                       // Try to get iOS-specific service
38  ❌ 0                 var iosService = _serviceProvider.GetKeyedService<ICameraService>("iOS");
39  ❌ 0  ○              if (iosService != null)
40  ❌ 0                     return iosService;
41  ❌ 0             }
42           
43                   // Fallback to NoCameraService for desktop/browser/unknown platforms
44  ❌ 0             return new NoCameraService();
45  ❌ 0         }
46           }
```
# FWH.Common.Chat.Services.NoCameraService

## Summary

|||
|:---|:---|
| Class: | FWH.Common.Chat.Services.NoCameraService |
| Assembly: | FWH.Common.Chat |
| **File(s):** | E:\github\FunWasHad\src\FWH.Common.Chat\NoCameraService.cs |
| **Line coverage:** | 0% (0 of 7) |
| Covered lines: | 0 |
| Uncovered lines: | 7 |
| Coverable lines: | 7 |
| Total lines: | 21 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **.ctor()** | 100% | 2 | 1 | 0% |
| **get_IsCameraAvailable()** | 100% | 2 | 1 | 0% |
| **TakePhotoAsync()** | 100% | 2 | 1 | 0% |

## File(s)

### E:\github\FunWasHad\src\FWH.Common.Chat\NoCameraService.cs
```
 1           using FWH.Common.Chat.Services;
 2           using System.Threading.Tasks;
 3           
 4           namespace FWH.Common.Chat.Services;
 5           
 6           /// <summary>
 7           /// Fallback camera service for desktop platforms (no camera available)
 8           /// </summary>
 9           public class NoCameraService : ICameraService
10           {
11  ❌ 0         public NoCameraService()
12  ❌ 0         {
13  ❌ 0         }
14           
15  ❌ 0         public bool IsCameraAvailable => false;
16           
17               public Task<byte[]?> TakePhotoAsync()
18  ❌ 0         {
19  ❌ 0             return Task.FromResult<byte[]?>(null);
20  ❌ 0         }
21           }
```
# FWH.Common.Chat.Services.PlatformService

## Summary

|||
|:---|:---|
| Class: | FWH.Common.Chat.Services.PlatformService |
| Assembly: | FWH.Common.Chat |
| **File(s):** | E:\github\FunWasHad\src\FWH.Common.Chat\Services\PlatformService.cs |
| **Line coverage:** | 0% (0 of 65) |
| Covered lines: | 0 |
| Uncovered lines: | 65 |
| Coverable lines: | 65 |
| Total lines: | 117 |
| **Branch coverage:** | 0% (0 of 42) |
| Covered branches: | 0 |
| Total branches: | 42 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **.ctor()** | 100% | 2 | 1 | 0% |
| **get_Platform()** | 100% | 2 | 1 | 0% |
| **get_IsAndroid()** | 100% | 2 | 1 | 0% |
| **get_IsIOS()** | 100% | 2 | 1 | 0% |
| **get_IsDesktop()** | 100% | 2 | 1 | 0% |
| **get_IsBrowser()** | 100% | 2 | 1 | 0% |
| **GetDatabasePath(...)** | 0% | 506 | 22 | 0% |
| **DetectPlatform()** | 0% | 420 | 20 | 0% |

## File(s)

### E:\github\FunWasHad\src\FWH.Common.Chat\Services\PlatformService.cs
```
  1           using System;
  2           using System.IO;
  3           using System.Runtime.InteropServices;
  4           
  5           namespace FWH.Common.Chat.Services;
  6           
  7           /// <summary>
  8           /// Default platform detection service using runtime information
  9           /// </summary>
 10           public class PlatformService : IPlatformService
 11           {
 12               private readonly PlatformType _platform;
 13           
 14  ❌ 0         public PlatformService()
 15  ❌ 0         {
 16  ❌ 0             _platform = DetectPlatform();
 17  ❌ 0         }
 18           
 19  ❌ 0         public PlatformType Platform => _platform;
 20           
 21  ❌ 0         public bool IsAndroid => _platform == PlatformType.Android;
 22           
 23  ❌ 0         public bool IsIOS => _platform == PlatformType.iOS;
 24           
 25  ❌ 0         public bool IsDesktop => _platform == PlatformType.Desktop;
 26           
 27  ❌ 0         public bool IsBrowser => _platform == PlatformType.Browser;
 28           
 29               public string GetDatabasePath(string databaseName)
 30  ❌ 0         {
 31                   string basePath;
 32           
 33  ❌ 0  ○          if (IsAndroid)
 34  ❌ 0             {
 35                       // On Android, use the app's private storage directory
 36                       // This is accessible via Android.App.Application.Context.GetExternalFilesDir(null)
 37                       // Use reflection to avoid compile-time dependency on Android assemblies
 38                       try
 39  ❌ 0                 {
 40  ❌ 0                     var contextType = Type.GetType("Android.App.Application, Mono.Android");
 41  ❌ 0  ○                  var contextProperty = contextType?.GetProperty("Context");
 42  ❌ 0  ○                  var context = contextProperty?.GetValue(null);
 43           
 44  ❌ 0  ○                  var getExternalFilesDirMethod = context?.GetType().GetMethod("GetExternalFilesDir", new[] { typeof(strin
 45  ❌ 0  ○                  var filesDir = getExternalFilesDirMethod?.Invoke(context, new object?[] { null });
 46           
 47  ❌ 0  ○                  var absolutePathProperty = filesDir?.GetType().GetProperty("AbsolutePath");
 48  ❌ 0  ○                  basePath = absolutePathProperty?.GetValue(filesDir) as string ?? "/data/data/com.CompanyName.FWH.Mobile/
 49  ❌ 0                 }
 50  ❌ 0                 catch
 51  ❌ 0                 {
 52                           // Fallback to a default Android path
 53  ❌ 0                     basePath = "/data/data/com.CompanyName.FWH.Mobile/files";
 54  ❌ 0                 }
 55  ❌ 0             }
 56  ❌ 0  ○          else if (IsIOS)
 57  ❌ 0             {
 58                       // On iOS, use the Documents directory
 59  ❌ 0                 var documentsPath = Environment.GetFolderPath(Environment.SpecialFolder.MyDocuments);
 60  ❌ 0                 basePath = Path.Combine(documentsPath, "..", "Library");
 61  ❌ 0             }
 62  ❌ 0  ○          else if (IsBrowser)
 63  ❌ 0             {
 64                       // For browser/WASM, use in-memory or IndexedDB (not implemented here)
 65  ❌ 0                 return "DataSource=:memory:";
 66                   }
 67                   else
 68  ❌ 0             {
 69                       // Desktop: use application data directory
 70  ❌ 0                 basePath = Environment.GetFolderPath(Environment.SpecialFolder.LocalApplicationData);
 71  ❌ 0                 basePath = Path.Combine(basePath, "FWH.Mobile");
 72  ❌ 0             }
 73           
 74                   // Ensure the directory exists
 75  ❌ 0  ○          if (!Directory.Exists(basePath))
 76  ❌ 0             {
 77  ❌ 0                 Directory.CreateDirectory(basePath);
 78  ❌ 0             }
 79           
 80  ❌ 0             return Path.Combine(basePath, databaseName);
 81  ❌ 0         }
 82           
 83               private static PlatformType DetectPlatform()
 84  ❌ 0         {
 85                   // Check for browser/WASM first
 86  ❌ 0  ○          if (RuntimeInformation.OSDescription.Contains("Browser", StringComparison.OrdinalIgnoreCase) ||
 87  ❌ 0                 OperatingSystem.IsBrowser())
 88  ❌ 0             {
 89  ❌ 0                 return PlatformType.Browser;
 90                   }
 91           
 92                   // Check for Android
 93  ❌ 0  ○          if (OperatingSystem.IsAndroid())
 94  ❌ 0             {
 95  ❌ 0                 return PlatformType.Android;
 96                   }
 97           
 98                   // Check for iOS/tvOS/watchOS/macCatalyst
 99  ❌ 0  ○          if (OperatingSystem.IsIOS() ||
100  ❌ 0                 OperatingSystem.IsTvOS() ||
101  ❌ 0                 OperatingSystem.IsWatchOS() ||
102  ❌ 0                 OperatingSystem.IsMacCatalyst())
103  ❌ 0             {
104  ❌ 0                 return PlatformType.iOS;
105                   }
106           
107                   // Check for desktop platforms
108  ❌ 0  ○          if (OperatingSystem.IsWindows() ||
109  ❌ 0                 OperatingSystem.IsLinux() ||
110  ❌ 0                 OperatingSystem.IsMacOS())
111  ❌ 0             {
112  ❌ 0                 return PlatformType.Desktop;
113                   }
114           
115  ❌ 0             return PlatformType.Unknown;
116  ❌ 0         }
117           }
```
# FWH.Common.Chat.ViewModels.ChatEntry<T>

## Summary

|||
|:---|:---|
| Class: | FWH.Common.Chat.ViewModels.ChatEntry<T> |
| Assembly: | FWH.Common.Chat |
| **File(s):** | E:\github\FunWasHad\src\FWH.Common.Chat\ViewModels\ChatEntry.cs |
| **Line coverage:** | 100% (5 of 5) |
| Covered lines: | 5 |
| Uncovered lines: | 0 |
| Coverable lines: | 5 |
| Total lines: | 19 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **.ctor(...)** | 100% | 1 | 1 | 100% |

## File(s)

### E:\github\FunWasHad\src\FWH.Common.Chat\ViewModels\ChatEntry.cs
```
 1            using CommunityToolkit.Mvvm.ComponentModel;
 2            
 3            namespace FWH.Common.Chat.ViewModels;
 4            
 5            public partial class ChatEntry<TPayload> : ObservableObject, IChatEntry<TPayload>
 6                where TPayload : IPayload
 7            {
 8                [ObservableProperty]
 9                private ChatAuthors author;
10            
11                [ObservableProperty]
12                private TPayload payload;
13            
14  ✔  42         public ChatEntry(ChatAuthors author, TPayload payload)
15  ✔  42         {
16  ✔  42             Author = author;
17  ✔  42             Payload = payload;
18  ✔  42         }
19            }
```
# FWH.Common.Chat.ViewModels.ChatInputViewModel

## Summary

|||
|:---|:---|
| Class: | FWH.Common.Chat.ViewModels.ChatInputViewModel |
| Assembly: | FWH.Common.Chat |
| **File(s):** | E:\github\FunWasHad\src\FWH.Common.Chat\ViewModels\ChatInputViewModel.cs |
| **Line coverage:** | 85.7% (72 of 84) |
| Covered lines: | 72 |
| Uncovered lines: | 12 |
| Coverable lines: | 84 |
| Total lines: | 134 |
| **Branch coverage:** | 71.4% (20 of 28) |
| Covered branches: | 20 |
| Total branches: | 28 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **.ctor(...)** | 85.71% | 14 | 14 | 92.85% |
| **get_InputMode()** | 100% | 1 | 1 | 100% |
| **set_InputMode(...)** | 100% | 1 | 1 | 100% |
| **ClearInput()** | 100% | 1 | 1 | 100% |
| **SetChoices(...)** | 100% | 2 | 2 | 100% |
| **submitted()** | 50.0% | 2 | 2 | 100% |
| **SetImageMode(...)** | 100% | 1 | 1 | 100% |
| **Send()** | 83.33% | 6 | 6 | 100% |
| **OpenCameraAsync()** | 0% | 6 | 2 | 0% |
| **RaiseImageCaptured(...)** | 0% | 6 | 2 | 0% |

## File(s)

### E:\github\FunWasHad\src\FWH.Common.Chat\ViewModels\ChatInputViewModel.cs
```
  1            using System;
  2            using System.Collections.ObjectModel;
  3            using CommunityToolkit.Mvvm.ComponentModel;
  4            using CommunityToolkit.Mvvm.Input;
  5            using System.Threading.Tasks;
  6            
  7            namespace FWH.Common.Chat.ViewModels;
  8            
  9            public partial class ChatInputViewModel : ViewModelBase
 10            {
 11                [ObservableProperty]
 12  ✔  25         private bool isVisible = true;
 13            
 14  ✔  25         private ChatInputModes _inputMode = ChatInputModes.Text;
 15                public ChatInputModes InputMode
 16                {
 17  ✔   3             get => _inputMode;
 18  ✔  41             set => SetProperty(ref _inputMode, value);
 19                }
 20            
 21                [ObservableProperty]
 22  ✔  25         private string? text = string.Empty;
 23            
 24                [ObservableProperty]
 25                private ChoicePayload? choices;
 26            
 27                [ObservableProperty]
 28                private ImagePayload? currentImage;
 29            
 30  ✔  25         public ChatInputViewModel(ChatListViewModel listViewModel)
 31  ✔  25         {
 32  ✔  25             listViewModel.PropertyChanged += (s, e) =>
 33  ✔  41             {
 34  ✔  41  ●              if (e.PropertyName == nameof(ChatListViewModel.Current))
 35  ✔  41                 {
 36  ✔  41                     var current = listViewModel.Current;
 37  ✔  25     
 38  ✔  41  ●                  if (current != null)
 39  ✔  41                     {
 40  ✔  41  ●                      switch (current.Payload.PayloadType)
 41  ✔  25                         {
 42  ✔  25                             case PayloadTypes.Choice:
 43  ✔   7                                 var choicePayload = current.Payload as ChoicePayload;
 44  ✔   7  ●                              if (choicePayload != null)
 45  ✔   7                                 {
 46  ✔   7                                     SetChoices(choicePayload);
 47  ✔   7                                 }
 48  ✔   7                                 break;
 49  ✔  25                             case PayloadTypes.Image:
 50  ✔   2                                 var imgPayload = current.Payload as ImagePayload;
 51  ✓   2  ◑                              if (imgPayload != null && imgPayload.Image == null)
 52  ✔   2                                 {
 53  ✔  25                                     // Camera node - show camera capture UI
 54  ✔   2                                     SetImageMode(imgPayload);
 55  ✔   2                                 }
 56  ✔  25                                 else
 57  ❌  0                                 {
 58  ❌  0                                     ClearInput();
 59  ❌  0                                 }
 60  ✔   2                                 break;
 61  ✔  25                             default:
 62  ✔  32                                 ClearInput();
 63  ✔  32                                 break;
 64  ✔  25                         }
 65  ✔  41                     }
 66  ✔  41                 }
 67  ✔  66             };
 68  ✔  25         }
 69            
 70                public void ClearInput()
 71  ✔  32         {
 72  ✔  32             Text = string.Empty;
 73  ✔  32             Choices = null;
 74  ✔  32             CurrentImage = null;
 75  ✔  32             InputMode = ChatInputModes.Text;
 76  ✔  32         }
 77            
 78                public void SetChoices(ChoicePayload choicePayload)
 79  ✔   7         {
 80  ✔   7             Choices = choicePayload;
 81  ✔   7             CurrentImage = null;
 82  ✔   7             InputMode = ChatInputModes.Choice;
 83            
 84  ✔  47  ●          foreach (var choice in choicePayload.Choices)
 85  ✔  13             {
 86                        void submitted(object? s, ChoicesItem? e)
 87  ✔   5                 {
 88  ✓   5  ◑                  ChoiceSubmitted?.Invoke(this, e);
 89  ✔   5                     choice.ChoiceSubmitted -= submitted;
 90  ✔   5                 }
 91            
 92  ✔  13                 choice.ChoiceSubmitted += submitted;
 93  ✔  13             }
 94  ✔   7         }
 95            
 96                public void SetImageMode(ImagePayload imagePayload)
 97  ✔   2         {
 98  ✔   2             CurrentImage = imagePayload;
 99  ✔   2             Choices = null;
100  ✔   2             Text = string.Empty;
101  ✔   2             InputMode = ChatInputModes.Image;
102  ✔   2         }
103            
104                [RelayCommand]
105                private void Send()
106  ✔   3         {
107  ✔   3  ●          switch (InputMode)
108                    {
109                        case ChatInputModes.Text:
110  ✓   3  ◑                  TextSubmitted?.Invoke(this, Text ?? string.Empty);
111  ✔   3                     Text = string.Empty; // Clear after sending
112  ✔   3                     break;
113                    }
114  ✔   3         }
115            
116                [RelayCommand]
117                private async Task OpenCameraAsync()
118  ❌  0         {
119  ❌  0             System.Diagnostics.Debug.WriteLine("ChatInputViewModel: OpenCameraAsync called - invoking CameraRequested event"
120  ❌  0  ○          CameraRequested?.Invoke(this, EventArgs.Empty);
121  ❌  0             System.Diagnostics.Debug.WriteLine("ChatInputViewModel: CameraRequested event invoked");
122  ❌  0             await Task.CompletedTask;
123  ❌  0         }
124            
125                public void RaiseImageCaptured(byte[] imageBytes)
126  ❌  0         {
127  ❌  0  ○          ImageCaptured?.Invoke(this, imageBytes);
128  ❌  0         }
129            
130                public event EventHandler<string>? TextSubmitted;
131                public event EventHandler<ChoicesItem?>? ChoiceSubmitted;
132                public event EventHandler? CameraRequested;
133                public event EventHandler<byte[]>? ImageCaptured;
134            }
```
# FWH.Common.Chat.ViewModels.ChatListViewModel

## Summary

|||
|:---|:---|
| Class: | FWH.Common.Chat.ViewModels.ChatListViewModel |
| Assembly: | FWH.Common.Chat |
| **File(s):** | E:\github\FunWasHad\src\FWH.Common.Chat\ViewModels\ChatListViewModel.cs |
| **Line coverage:** | 48.2% (28 of 58) |
| Covered lines: | 28 |
| Uncovered lines: | 30 |
| Coverable lines: | 58 |
| Total lines: | 105 |
| **Branch coverage:** | 47% (16 of 34) |
| Covered branches: | 16 |
| Total branches: | 34 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **.ctor(...)** | 100% | 1 | 1 | 100% |
| **get_Entries()** | 100% | 1 | 1 | 100% |
| **set_Entries(...)** | 100% | 2 | 1 | 0% |
| **AddEntry(...)** | 50.0% | 193 | 28 | 40.47% |
| **SelectedChoice(...)** | 0% | 20 | 4 | 0% |
| **Reset()** | 100% | 1 | 1 | 100% |
| **get_Current()** | 100% | 2 | 2 | 100% |

## File(s)

### E:\github\FunWasHad\src\FWH.Common.Chat\ViewModels\ChatListViewModel.cs
```
  1             using System;
  2             using System.Collections.ObjectModel;
  3             using CommunityToolkit.Mvvm.ComponentModel;
  4             using CommunityToolkit.Mvvm.Input;
  5             
  6             namespace FWH.Common.Chat.ViewModels;
  7             
  8             #pragma warning disable CS9113 // Parameter is unread
  9  ✔   26     public partial class ChatListViewModel(IServiceProvider? _ = null) : ViewModelBase
 10             #pragma warning restore CS9113
 11             {
 12  ✔   26         private ObservableCollection<IChatEntry<IPayload>> entries = new ObservableCollection<IChatEntry<IPayload>>();
 13             
 14                 public ObservableCollection<IChatEntry<IPayload>> Entries
 15                 {
 16  ✔  320             get => entries;
 17  ❌   0             private set => SetProperty(ref entries, value);
 18                 }
 19             
 20                 public void AddEntry(IChatEntry<IPayload> entry)
 21  ✔   42         {
 22  ✔   43  ●          if (entry == null) throw new ArgumentNullException(nameof(entry));
 23             
 24                     // Central duplicate prevention: skip adding a choice entry if the last entry is an identical choice
 25  ✓   41  ◕          if (Entries.Count > 0 && entry.Payload.PayloadType == PayloadTypes.Choice && Entries[^1].Payload.PayloadType == 
 26  ❌   0             {
 27  ❌   0                 var lastChoice = Entries[^1].Payload as ChoicePayload;
 28  ❌   0                 var newChoice = entry.Payload as ChoicePayload;
 29  ❌   0  ○              if (lastChoice != null && newChoice != null)
 30  ❌   0                 {
 31  ❌   0  ○                  if (lastChoice.Choices.Count == newChoice.Choices.Count)
 32  ❌   0                     {
 33  ❌   0                         bool same = true;
 34  ❌   0  ○                      for (int i = 0; i < lastChoice.Choices.Count; i++)
 35  ❌   0                         {
 36  ❌   0  ○                          if (lastChoice.Choices[i].ChoiceText != newChoice.Choices[i].ChoiceText)
 37  ❌   0                             {
 38  ❌   0                                 same = false;
 39  ❌   0                                 break;
 40                                     }
 41  ❌   0                         }
 42             
 43  ❌   0  ◑                      if (same)
 44  ❌   0                             return; // skip duplicate
 45  ❌   0                     }
 46  ❌   0                 }
 47  ❌   0             }
 48             
 49  ✔   41  ●          Entries.Add(entry);
 50             
 51                     switch (entry.Payload.PayloadType)
 52                     {
 53                         case PayloadTypes.Choice:
 54  ✔    7                     var choicePayload = entry.Payload as ChoicePayload;
 55  ✔    7  ●                  if (choicePayload != null)
 56  ✔    7                     {
 57  ✔    7                         choicePayload.PropertyChanged += (s, e) =>
 58  ❌   0                         {
 59  ❌   0  ○                          if (e.PropertyName == nameof(ChoicePayload.SelectedChoice))
 60  ❌   0                             {
 61  ❌   0                                 SelectedChoice(choicePayload.SelectedChoice);
 62  ❌   0                             }
 63  ✔    7                         };
 64             
 65  ✔    7                         OnPropertyChanged(nameof(Current));
 66  ✔    7                     }
 67  ✔    7                     break;
 68             
 69                         case PayloadTypes.Image:
 70                             // Notify that Current has changed so ChatInputViewModel can detect image mode
 71  ✔    2                     OnPropertyChanged(nameof(Current));
 72  ✔    2                     break;
 73             
 74                         case PayloadTypes.Text:
 75                             // Notify that Current has changed for text entries too
 76  ✔   32                     OnPropertyChanged(nameof(Current));
 77  ✔   32                     break;
 78                     }
 79  ✔   41         }
 80             
 81                 [RelayCommand]
 82                 private void SelectedChoice(ChoicesItem? selectedChoice)
 83  ❌   0         {
 84  ❌   0  ○          if (selectedChoice == null) return;
 85             
 86  ❌   0  ○          ChoiceSelected?.Invoke(this, selectedChoice);
 87  ❌   0         }
 88             
 89                 internal void Reset()
 90  ✔    4         {
 91  ✔    4             Entries.Clear();
 92  ✔    4         }
 93             
 94                 public event EventHandler<ChoicesItem?>? ChoiceSelected;
 95             
 96                 public IChatEntry<IPayload>? Current
 97                 {
 98                     get
 99  ✔   75             {
100  ✔   75  ●              if (Entries.Count == 0)
101  ✔   13                     return null;
102  ✔   62                 return Entries[^1];
103  ✔   75             }
104                 }
105             }
```
# FWH.Common.Chat.ViewModels.ChatViewModel

## Summary

|||
|:---|:---|
| Class: | FWH.Common.Chat.ViewModels.ChatViewModel |
| Assembly: | FWH.Common.Chat |
| **File(s):** | E:\github\FunWasHad\src\FWH.Common.Chat\ViewModels\ChatViewModel.cs |
| **Line coverage:** | 100% (7 of 7) |
| Covered lines: | 7 |
| Uncovered lines: | 0 |
| Coverable lines: | 7 |
| Total lines: | 16 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **get_ChatInput()** | 100% | 1 | 1 | 100% |
| **get_ChatList()** | 100% | 1 | 1 | 100% |
| **.ctor(...)** | 100% | 1 | 1 | 100% |

## File(s)

### E:\github\FunWasHad\src\FWH.Common.Chat\ViewModels\ChatViewModel.cs
```
 1            using System;
 2            using Microsoft.Extensions.DependencyInjection;
 3            
 4            namespace FWH.Common.Chat.ViewModels;
 5            
 6            public class ChatViewModel : ViewModelBase
 7            {
 8  ✔  25         public ChatInputViewModel ChatInput { get; }
 9  ✔  46         public ChatListViewModel ChatList { get; }
10            
11  ✔  21         public ChatViewModel(IServiceProvider serviceProvider)
12  ✔  21         {
13  ✔  21             ChatInput = serviceProvider.GetRequiredService<ChatInputViewModel>();
14  ✔  21             ChatList = serviceProvider.GetRequiredService<ChatListViewModel>();
15  ✔  21         }
16            }
```
# FWH.Common.Chat.ViewModels.ChoiceChatEntry

## Summary

|||
|:---|:---|
| Class: | FWH.Common.Chat.ViewModels.ChoiceChatEntry |
| Assembly: | FWH.Common.Chat |
| **File(s):** | E:\github\FunWasHad\src\FWH.Common.Chat\ViewModels\ChoiceChatEntry.cs |
| **Line coverage:** | 57.1% (4 of 7) |
| Covered lines: | 4 |
| Uncovered lines: | 3 |
| Coverable lines: | 7 |
| Total lines: | 17 |
| **Branch coverage:** | 100% (2 of 2) |
| Covered branches: | 2 |
| Total branches: | 2 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **.ctor(...)** | 100% | 2 | 2 | 100% |
| **get_Prompt()** | 100% | 2 | 1 | 0% |
| **get_Title()** | 100% | 2 | 1 | 0% |
| **get_Choices()** | 100% | 1 | 1 | 100% |
| **get_SelectedChoice()** | 100% | 2 | 1 | 0% |

## File(s)

### E:\github\FunWasHad\src\FWH.Common.Chat\ViewModels\ChoiceChatEntry.cs
```
 1           using System;
 2           using System.Collections.ObjectModel;
 3           
 4           namespace FWH.Common.Chat.ViewModels;
 5           
 6           public class ChoiceChatEntry : ChatEntry<ChoicePayload>
 7           {
 8               public ChoiceChatEntry(ChatAuthors author, ChoicePayload payload)
 9  ✔  8  ●          : base(author, payload ?? throw new ArgumentNullException(nameof(payload)))
10  ✔  7         {
11  ✔  7         }
12           
13  ❌ 0         public string Prompt => Payload.Prompt;
14  ❌ 0         public string Title => Payload.Title;
15  ✔  7         public ObservableCollection<ChoicesItem> Choices => Payload.Choices;
16  ❌ 0         public ChoicesItem? SelectedChoice => Payload.SelectedChoice;
17           }
```
# FWH.Common.Chat.ViewModels.ChoicePayload

## Summary

|||
|:---|:---|
| Class: | FWH.Common.Chat.ViewModels.ChoicePayload |
| Assembly: | FWH.Common.Chat |
| **File(s):** | E:\github\FunWasHad\src\FWH.Common.Chat\ViewModels\ChoicePayload.cs |
| **Line coverage:** | 100% (14 of 14) |
| Covered lines: | 14 |
| Uncovered lines: | 0 |
| Coverable lines: | 14 |
| Total lines: | 34 |
| **Branch coverage:** | 75% (3 of 4) |
| Covered branches: | 3 |
| Total branches: | 4 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **.ctor(...)** | 100% | 1 | 1 | 100% |
| **get_PayloadType()** | 100% | 1 | 1 | 100% |
| **AddChoice(...)** | 75.00% | 4 | 4 | 100% |

## File(s)

### E:\github\FunWasHad\src\FWH.Common.Chat\ViewModels\ChoicePayload.cs
```
 1            using System.Collections.ObjectModel;
 2            using System.Linq;
 3            using CommunityToolkit.Mvvm.ComponentModel;
 4            
 5            namespace FWH.Common.Chat.ViewModels;
 6            
 7  ✔  10     public partial class ChoicePayload(IEnumerable<ChoicesItem> choiceItems)
 8                : ObservableObject, IPayload
 9            {
10  ✔  27         public PayloadTypes PayloadType => PayloadTypes.Choice;
11            
12                [ObservableProperty]
13  ✔  10         public string prompt = "Select One...";
14            
15                [ObservableProperty]
16  ✔  10         public string title = "You selected...";
17            
18                [ObservableProperty]
19  ✔  10         public ObservableCollection<ChoicesItem> choices = new ObservableCollection<ChoicesItem>(choiceItems);
20            
21                public ChoicesItem AddChoice(string text, object? value, int? atIndex)
22  ✔   2         {
23  ✔   2  ●          if (Choices.Any(c => c.DisplayOrder == atIndex))
24  ✔   2             {
25  ✔   2                 atIndex = null;
26  ✔   2             }
27  ✓   2  ◑          var newItem = new ChoicesItem(atIndex ?? Choices.Count, text, value);
28  ✔   2             Choices.Add(newItem);
29  ✔   2             return newItem;
30  ✔   2         }
31            
32                [ObservableProperty]
33                public ChoicesItem? selectedChoice;
34            }
```
# FWH.Common.Chat.ViewModels.ChoicesItem

## Summary

|||
|:---|:---|
| Class: | FWH.Common.Chat.ViewModels.ChoicesItem |
| Assembly: | FWH.Common.Chat |
| **File(s):** | E:\github\FunWasHad\src\FWH.Common.Chat\ViewModels\ChoicesItem.cs |
| **Line coverage:** | 100% (9 of 9) |
| Covered lines: | 9 |
| Uncovered lines: | 0 |
| Coverable lines: | 9 |
| Total lines: | 29 |
| **Branch coverage:** | 50% (1 of 2) |
| Covered branches: | 1 |
| Total branches: | 2 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **.ctor(...)** | 100% | 1 | 1 | 100% |
| **SelectChoice(...)** | 50.0% | 2 | 2 | 100% |

## File(s)

### E:\github\FunWasHad\src\FWH.Common.Chat\ViewModels\ChoicesItem.cs
```
 1            using System;
 2            using CommunityToolkit.Mvvm.ComponentModel;
 3            using CommunityToolkit.Mvvm.Input;
 4            using System.Threading.Tasks;
 5            
 6            namespace FWH.Common.Chat.ViewModels;
 7            
 8  ✔  21     public partial class ChoicesItem(int order, string text, object? value)
 9                : ObservableObject
10            {
11                [ObservableProperty]
12  ✔  21         private int displayOrder = order;
13                [ObservableProperty]
14  ✔  21         private string choiceText = text;
15                [ObservableProperty]
16  ✔  21         private bool isSelected = false;
17                [ObservableProperty]
18  ✔  21         private object? choiceValue = value;
19            
20                public event EventHandler<ChoicesItem?>? ChoiceSubmitted;
21            
22            
23                [RelayCommand(AllowConcurrentExecutions =false)]
24                private Task SelectChoice(ChoicesItem? choice)
25  ✔   9         {
26  ✓   9  ◑          ChoiceSubmitted?.Invoke(this, choice);
27  ✔   9             return Task.CompletedTask;
28  ✔   9         }
29            }
```
# FWH.Common.Chat.ViewModels.ImageChatEntry

## Summary

|||
|:---|:---|
| Class: | FWH.Common.Chat.ViewModels.ImageChatEntry |
| Assembly: | FWH.Common.Chat |
| **File(s):** | E:\github\FunWasHad\src\FWH.Common.Chat\ViewModels\ImageChatEntry.cs |
| **Line coverage:** | 66.6% (4 of 6) |
| Covered lines: | 4 |
| Uncovered lines: | 2 |
| Coverable lines: | 6 |
| Total lines: | 14 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **.ctor(...)** | 100% | 1 | 1 | 100% |
| **get_Image()** | 100% | 2 | 1 | 0% |
| **get_ShowBorder()** | 100% | 2 | 1 | 0% |

## File(s)

### E:\github\FunWasHad\src\FWH.Common.Chat\ViewModels\ImageChatEntry.cs
```
 1           using System;
 2           
 3           namespace FWH.Common.Chat.ViewModels;
 4           
 5           public class ImageChatEntry : ChatEntry<ImagePayload>
 6           {
 7               public ImageChatEntry(ChatAuthors author, ImagePayload payload)
 8  ✔  2             : base(author, payload)
 9  ✔  2         {
10  ✔  2             ArgumentNullException.ThrowIfNull(payload);
11  ✔  2         }
12  ❌ 0         public byte[]? Image => Payload.Image;
13  ❌ 0         public bool ShowBorder => Payload.ShowBorder;
14           }
```
# FWH.Common.Chat.ViewModels.ImagePayload

## Summary

|||
|:---|:---|
| Class: | FWH.Common.Chat.ViewModels.ImagePayload |
| Assembly: | FWH.Common.Chat |
| **File(s):** | E:\github\FunWasHad\src\FWH.Common.Chat\ViewModels\ImagePayload.cs |
| **Line coverage:** | 100% (2 of 2) |
| Covered lines: | 2 |
| Uncovered lines: | 0 |
| Coverable lines: | 2 |
| Total lines: | 14 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **get_PayloadType()** | 100% | 1 | 1 | 100% |
| **.ctor()** | 100% | 1 | 1 | 100% |

## File(s)

### E:\github\FunWasHad\src\FWH.Common.Chat\ViewModels\ImagePayload.cs
```
 1            using CommunityToolkit.Mvvm.ComponentModel;
 2            
 3            namespace FWH.Common.Chat.ViewModels;
 4            
 5            public partial class ImagePayload : ObservableObject, IPayload
 6            {
 7  ✔  12         public PayloadTypes PayloadType => PayloadTypes.Image;
 8            
 9                [ObservableProperty]
10                public byte[]? image;
11            
12                [ObservableProperty]
13  ✔   2         public bool showBorder = false;
14            }
```
# FWH.Common.Chat.ViewModels.TextChatEntry

## Summary

|||
|:---|:---|
| Class: | FWH.Common.Chat.ViewModels.TextChatEntry |
| Assembly: | FWH.Common.Chat |
| **File(s):** | E:\github\FunWasHad\src\FWH.Common.Chat\ViewModels\TextChatEntry.cs |
| **Line coverage:** | 100% (4 of 4) |
| Covered lines: | 4 |
| Uncovered lines: | 0 |
| Coverable lines: | 4 |
| Total lines: | 11 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **.ctor(...)** | 100% | 1 | 1 | 100% |
| **get_Text()** | 100% | 1 | 1 | 100% |

## File(s)

### E:\github\FunWasHad\src\FWH.Common.Chat\ViewModels\TextChatEntry.cs
```
 1            namespace FWH.Common.Chat.ViewModels;
 2            
 3            public class TextChatEntry : ChatEntry<TextPayload>
 4            {
 5                public TextChatEntry(ChatAuthors author, string message)
 6  ✔  33             : base(author, new TextPayload(message))
 7  ✔  33         {
 8  ✔  33         }
 9            
10  ✔   1         public string Text => Payload.Text;
11            }
```
# FWH.Common.Chat.ViewModels.TextPayload

## Summary

|||
|:---|:---|
| Class: | FWH.Common.Chat.ViewModels.TextPayload |
| Assembly: | FWH.Common.Chat |
| **File(s):** | E:\github\FunWasHad\src\FWH.Common.Chat\ViewModels\TextPayload.cs |
| **Line coverage:** | 100% (3 of 3) |
| Covered lines: | 3 |
| Uncovered lines: | 0 |
| Coverable lines: | 3 |
| Total lines: | 12 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **.ctor(...)** | 100% | 1 | 1 | 100% |
| **get_PayloadType()** | 100% | 1 | 1 | 100% |

## File(s)

### E:\github\FunWasHad\src\FWH.Common.Chat\ViewModels\TextPayload.cs
```
 1             using CommunityToolkit.Mvvm.ComponentModel;
 2             
 3             namespace FWH.Common.Chat.ViewModels;
 4             
 5  ✔   33     public partial class TextPayload(string message = "Empty Message")
 6                 : ObservableObject, IPayload
 7             {
 8  ✔  159         public PayloadTypes PayloadType => PayloadTypes.Text;
 9             
10                 [ObservableProperty]
11  ✔   33         public string text = message;
12             }
```
# FWH.Common.Imaging.Extensions.ImagingServiceCollectionExtensions

## Summary

|||
|:---|:---|
| Class: | FWH.Common.Imaging.Extensions.ImagingServiceCollectionExtensions |
| Assembly: | FWH.Common.Imaging |
| **File(s):** | E:\github\FunWasHad\src\FWH.Common.Imaging\Extensions\ImagingServiceCollectionExtensions.cs |
| **Line coverage:** | 50% (4 of 8) |
| Covered lines: | 4 |
| Uncovered lines: | 4 |
| Coverable lines: | 8 |
| Total lines: | 30 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **AddImagingServices(...)** | 100% | 1 | 1 | 100% |
| **AddImagingService(...)** | 100% | 2 | 1 | 0% |

## File(s)

### E:\github\FunWasHad\src\FWH.Common.Imaging\Extensions\ImagingServiceCollectionExtensions.cs
```
 1            using Microsoft.Extensions.DependencyInjection;
 2            using SkiaSharp;
 3            
 4            namespace FWH.Common.Imaging.Extensions;
 5            
 6            /// <summary>
 7            /// Extension methods for registering imaging services with dependency injection.
 8            /// </summary>
 9            public static class ImagingServiceCollectionExtensions
10            {
11                /// <summary>
12                /// Registers the imaging service implementations used by the application.
13                /// </summary>
14                /// <param name="services">Service collection to modify.</param>
15                /// <returns>The original service collection for chaining.</returns>
16                public static IServiceCollection AddImagingServices(this IServiceCollection services)
17  ✔  21         {
18  ✔  21             services.AddSingleton<FWH.Common.Imaging.IImagingService, FWH.Common.Imaging.ImagingService>();
19  ✔  21             return services;
20  ✔  21         }
21            
22                /// <summary>
23                /// Registers a single imaging service implementation.
24                /// </summary>
25                public static IServiceCollection AddImagingService(this IServiceCollection services)
26  ❌  0         {
27  ❌  0             services.AddSingleton<FWH.Common.Imaging.IImagingService, FWH.Common.Imaging.ImagingService>();
28  ❌  0             return services;
29  ❌  0         }
30            }
```
# FWH.Common.Imaging.ImagingOptions

## Summary

|||
|:---|:---|
| Class: | FWH.Common.Imaging.ImagingOptions |
| Assembly: | FWH.Common.Imaging |
| **File(s):** | E:\github\FunWasHad\src\FWH.Common.Imaging\ImagingOptions.cs |
| **Line coverage:** | 100% (4 of 4) |
| Covered lines: | 4 |
| Uncovered lines: | 0 |
| Coverable lines: | 4 |
| Total lines: | 36 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **get_FitMode()** | 100% | 1 | 1 | 100% |
| **get_Anchor()** | 100% | 1 | 1 | 100% |
| **get_Padding()** | 100% | 1 | 1 | 100% |
| **get_BackgroundColor()** | 100% | 1 | 1 | 100% |

## File(s)

### E:\github\FunWasHad\src\FWH.Common.Imaging\ImagingOptions.cs
```
 1             using SkiaSharp;
 2             
 3             namespace FWH.Common.Imaging;
 4             
 5             public enum FitMode
 6             {
 7                 BestFit,
 8                 Fill,
 9                 Stretch
10             }
11             
12             public enum Anchor
13             {
14                 Center,
15                 TopLeft,
16                 TopRight,
17                 BottomLeft,
18                 BottomRight
19             }
20             
21             public class ImagingOptions
22             {
23  ✔   73         public FitMode FitMode { get; set; } = FitMode.BestFit;
24  ✔   73         public Anchor Anchor { get; set; } = Anchor.TopLeft;
25             
26                 /// <summary>
27                 /// Padding in pixels applied around the SVG when fitting.
28                 /// </summary>
29  ✔  210         public int Padding { get; set; } = 0;
30             
31                 /// <summary>
32                 /// Background color to paint in the output before composing base and SVG.
33                 /// Defaults to transparent.
34                 /// </summary>
35  ✔   43         public SKColor BackgroundColor { get; set; } = SKColors.Transparent;
36             }
```
# FWH.Common.Imaging.ImagingService

## Summary

|||
|:---|:---|
| Class: | FWH.Common.Imaging.ImagingService |
| Assembly: | FWH.Common.Imaging |
| **File(s):** | E:\github\FunWasHad\src\FWH.Common.Imaging\ImagingService.cs |
| **Line coverage:** | 77.7% (105 of 135) |
| Covered lines: | 105 |
| Uncovered lines: | 30 |
| Coverable lines: | 135 |
| Total lines: | 212 |
| **Branch coverage:** | 71% (27 of 38) |
| Covered branches: | 27 |
| Total branches: | 38 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **RenderSvgOverlay(...)** | 100% | 1 | 1 | 100% |
| **RenderSvgOverlayToPngStream(...)** | 100% | 2 | 1 | 0% |
| **RenderSvgOverlay(...)** | 71.05% | 43 | 38 | 85.00% |
| **RenderSvgOverlayToPngStream(...)** | 100% | 2 | 1 | 0% |

## File(s)

### E:\github\FunWasHad\src\FWH.Common.Imaging\ImagingService.cs
```
  1            using System;
  2            using System.IO;
  3            using SkiaSharp;
  4            using Svg.Skia;
  5            
  6            namespace FWH.Common.Imaging;
  7            
  8            public class ImagingService : IImagingService
  9            {
 10                public SKBitmap RenderSvgOverlay(SKBitmap baseBitmap, string svg, float x = 0, float y = 0, ImagingOptions? options 
 11  ✔  21         {
 12  ✔  21             return RenderSvgOverlay(baseBitmap, svg, baseBitmap.Width, baseBitmap.Height, x, y, options);
 13  ✔  21         }
 14            
 15                public Stream RenderSvgOverlayToPngStream(SKBitmap baseBitmap, string svg, float x = 0, float y = 0, ImagingOptions?
 16  ❌  0         {
 17  ❌  0             return RenderSvgOverlayToPngStream(baseBitmap, svg, baseBitmap.Width, baseBitmap.Height, x, y, options);
 18  ❌  0         }
 19            
 20                public SKBitmap RenderSvgOverlay(SKBitmap baseBitmap, string svg, int outputWidth, int outputHeight, float x = 0, fl
 21  ✔  21         {
 22  ✔  21  ●          options ??= new ImagingOptions();
 23            
 24  ✔  21             ArgumentNullException.ThrowIfNull(baseBitmap);
 25  ✓  21  ◑          if (string.IsNullOrWhiteSpace(svg)) throw new ArgumentException("SVG must not be empty", nameof(svg));
 26  ✓  21  ◑          if (outputWidth <= 0 || outputHeight <= 0) throw new ArgumentException("Output dimensions must be positive");
 27            
 28                    // Load SVG using Svg.Skia
 29  ✔  21             var svgDrawable = new SKSvg();
 30  ✔  21             using var svgStream = new MemoryStream(System.Text.Encoding.UTF8.GetBytes(svg));
 31  ✔  21             var svgPicture = svgDrawable.Load(svgStream);
 32            
 33  ✓  21  ◑          if (svgPicture == null)
 34  ❌  0             {
 35  ❌  0                 throw new InvalidOperationException("Failed to parse SVG into drawable picture.");
 36                    }
 37            
 38                    // Get the SVG's natural size
 39  ✔  21             var srcRect = svgPicture.CullRect;
 40  ✔  21             var srcWidth = srcRect.Width;
 41  ✔  21             var srcHeight = srcRect.Height;
 42            
 43                    // Fallback to minimal size if needed
 44  ✓  21  ◑          if (srcWidth <= 0) srcWidth = 1;
 45  ✓  21  ◑          if (srcHeight <= 0) srcHeight = 1;
 46            
 47                    // Apply padding to output dimensions
 48  ✔  21             var paddedOutputWidth = Math.Max(1, outputWidth - options.Padding * 2);
 49  ✔  21             var paddedOutputHeight = Math.Max(1, outputHeight - options.Padding * 2);
 50            
 51                    // Compute desired size based on FitMode
 52  ✔  21             float desiredWidthF = srcWidth;
 53  ✔  21             float desiredHeightF = srcHeight;
 54            
 55  ✔  21  ●          switch (options.FitMode)
 56                    {
 57                        case FitMode.BestFit:
 58  ✔  11                     {
 59  ✔  11                         var scaleX = paddedOutputWidth / srcWidth;
 60  ✔  11                         var scaleY = paddedOutputHeight / srcHeight;
 61  ✔  11                         var scale = Math.Min(scaleX, scaleY);
 62  ✓  11  ◑                      if (scale <= 0) scale = 1f;
 63  ✔  11                         desiredWidthF = srcWidth * scale;
 64  ✔  11                         desiredHeightF = srcHeight * scale;
 65  ✔  11                         break;
 66                            }
 67                        case FitMode.Fill:
 68  ✔   5                     {
 69  ✔   5                         var scaleX = paddedOutputWidth / srcWidth;
 70  ✔   5                         var scaleY = paddedOutputHeight / srcHeight;
 71  ✔   5                         var scale = Math.Max(scaleX, scaleY);
 72  ✓   5  ◑                      if (scale <= 0) scale = 1f;
 73  ✔   5                         desiredWidthF = srcWidth * scale;
 74  ✔   5                         desiredHeightF = srcHeight * scale;
 75  ✔   5                         break;
 76                            }
 77                        case FitMode.Stretch:
 78  ✔   5                     {
 79  ✔   5                         desiredWidthF = paddedOutputWidth;
 80  ✔   5                         desiredHeightF = paddedOutputHeight;
 81  ✔   5                         break;
 82                            }
 83                    }
 84            
 85  ✔  21             var desiredWidth = Math.Max(1, (int)Math.Ceiling(desiredWidthF));
 86  ✔  21             var desiredHeight = Math.Max(1, (int)Math.Ceiling(desiredHeightF));
 87            
 88                    // Compute alignment offsets based on anchor within padded area
 89  ✔  42             float offsetX = 0f, offsetY = 0f;
 90  ✔  21  ●          switch (options.Anchor)
 91                    {
 92                        case Anchor.Center:
 93  ✔   3                     offsetX = options.Padding + (paddedOutputWidth - desiredWidth) / 2f;
 94  ✔   3                     offsetY = options.Padding + (paddedOutputHeight - desiredHeight) / 2f;
 95  ✔   3                     break;
 96                        case Anchor.TopLeft:
 97  ✔   9                     offsetX = options.Padding;
 98  ✔   9                     offsetY = options.Padding;
 99  ✔   9                     break;
100                        case Anchor.TopRight:
101  ✔   3                     offsetX = options.Padding + (paddedOutputWidth - desiredWidth);
102  ✔   3                     offsetY = options.Padding;
103  ✔   3                     break;
104                        case Anchor.BottomLeft:
105  ✔   3                     offsetX = options.Padding;
106  ✔   3                     offsetY = options.Padding + (paddedOutputHeight - desiredHeight);
107  ✔   3                     break;
108                        case Anchor.BottomRight:
109  ✔   3                     offsetX = options.Padding + (paddedOutputWidth - desiredWidth);
110  ✔   3                     offsetY = options.Padding + (paddedOutputHeight - desiredHeight);
111  ✔   3                     break;
112                    }
113            
114                    // Apply user offsets
115  ✔  21             offsetX += x;
116  ✔  21             offsetY += y;
117            
118  ✔  21             var outInfo = new SKImageInfo(outputWidth, outputHeight, baseBitmap.ColorType, baseBitmap.AlphaType);
119  ✔  21             var outBitmap = new SKBitmap(outInfo);
120            
121  ✔  21             using (var canvas = new SKCanvas(outBitmap))
122  ✔  21             {
123                        // Paint background color if provided
124  ✔  21                 canvas.Clear(options.BackgroundColor);
125            
126                        // Draw scaled base bitmap within the padded area
127  ✔  21  ●              if (options.Padding > 0)
128  ✔   1                 {
129                            // Draw base bitmap only within padded area
130  ✔   1                     var paddedRect = new SKRect(options.Padding, options.Padding,
131  ✔   1                         outputWidth - options.Padding, outputHeight - options.Padding);
132            
133  ✔   1                     canvas.Save();
134  ✔   1                     canvas.ClipRect(paddedRect);
135  ✔   1                     canvas.Translate(options.Padding, options.Padding);
136            
137                            // Scale to fit the padded area if needed
138  ✓   1  ◑                  if (baseBitmap.Width != paddedOutputWidth || baseBitmap.Height != paddedOutputHeight)
139  ✔   1                     {
140  ✔   1                         var scaleX = (float)paddedOutputWidth / baseBitmap.Width;
141  ✔   1                         var scaleY = (float)paddedOutputHeight / baseBitmap.Height;
142  ✔   1                         var scale = Math.Min(scaleX, scaleY);
143  ✔   1                         canvas.Scale(scale, scale);
144  ✔   1                     }
145            
146  ✔   1                     canvas.DrawBitmap(baseBitmap, 0, 0);
147  ✔   1                     canvas.Restore();
148  ✔   1                 }
149                        else
150  ✔  20                 {
151                            // No padding - draw base bitmap normally
152  ✓  20  ◑                  if (baseBitmap.Width == outputWidth && baseBitmap.Height == outputHeight)
153  ✔  20                     {
154  ✔  20                         canvas.DrawBitmap(baseBitmap, 0, 0);
155  ✔  20                     }
156                            else
157  ❌  0                     {
158                                // Fit base bitmap into output preserving aspect ratio (letterbox)
159  ❌  0                         var bw = baseBitmap.Width;
160  ❌  0                         var bh = baseBitmap.Height;
161  ❌  0                         var scaleX = (float)outputWidth / bw;
162  ❌  0                         var scaleY = (float)outputHeight / bh;
163  ❌  0                         var baseScale = Math.Min(scaleX, scaleY);
164  ❌  0                         var drawW = bw * baseScale;
165  ❌  0                         var drawH = bh * baseScale;
166  ❌  0                         var drawX = (outputWidth - drawW) / 2f;
167  ❌  0                         var drawY = (outputHeight - drawH) / 2f;
168  ❌  0                         canvas.Save();
169  ❌  0                         canvas.Translate(drawX, drawY);
170  ❌  0                         canvas.Scale(baseScale, baseScale);
171  ❌  0                         canvas.DrawBitmap(baseBitmap, 0, 0);
172  ❌  0                         canvas.Restore();
173  ❌  0                     }
174  ✔  20                 }
175            
176                        // Render SVG directly onto the canvas at the computed position
177                        // Round to nearest pixel to avoid anti-aliasing artifacts at fractional positions
178  ✔  21                 var roundedOffsetX = (float)Math.Round(offsetX);
179  ✔  21                 var roundedOffsetY = (float)Math.Round(offsetY);
180            
181  ✔  21                 canvas.Save();
182  ✔  21                 canvas.Translate(roundedOffsetX, roundedOffsetY);
183            
184                        // Calculate scale to match desired size
185  ✔  21                 var scaleToFitX = desiredWidthF / srcWidth;
186  ✔  21                 var scaleToFitY = desiredHeightF / srcHeight;
187  ✔  21                 canvas.Scale(scaleToFitX, scaleToFitY);
188            
189                        // Translate to handle SVG's CullRect offset
190  ✔  21                 canvas.Translate(-srcRect.Left, -srcRect.Top);
191            
192                        // Draw the SVG picture
193  ✔  21                 canvas.DrawPicture(svgPicture);
194            
195  ✔  21                 canvas.Restore();
196  ✔  21                 canvas.Flush();
197  ✔  21             }
198            
199  ✔  21             return outBitmap;
200  ✔  21         }
201            
202                public Stream RenderSvgOverlayToPngStream(SKBitmap baseBitmap, string svg, int outputWidth, int outputHeight, float 
203  ❌  0         {
204  ❌  0             using var composed = RenderSvgOverlay(baseBitmap, svg, outputWidth, outputHeight, x, y, options);
205  ❌  0             using var image = SKImage.FromBitmap(composed);
206  ❌  0             using var data = image.Encode(SKEncodedImageFormat.Png, 100);
207  ❌  0             var ms = new MemoryStream();
208  ❌  0             data.SaveTo(ms);
209  ❌  0             ms.Seek(0, SeekOrigin.Begin);
210  ❌  0             return ms;
211  ❌  0         }
212            }
```
# FWH.Common.Location.Configuration.LocationServiceOptions

## Summary

|||
|:---|:---|
| Class: | FWH.Common.Location.Configuration.LocationServiceOptions |
| Assembly: | FWH.Common.Location |
| **File(s):** | E:\github\FunWasHad\src\FWH.Common.Location\Configuration\LocationServiceOptions.cs |
| **Line coverage:** | 84.6% (11 of 13) |
| Covered lines: | 11 |
| Uncovered lines: | 2 |
| Coverable lines: | 13 |
| Total lines: | 59 |
| **Branch coverage:** | 50% (2 of 4) |
| Covered branches: | 2 |
| Total branches: | 4 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **get_DefaultRadiusMeters()** | 100% | 1 | 1 | 100% |
| **get_MaxRadiusMeters()** | 100% | 1 | 1 | 100% |
| **get_MinRadiusMeters()** | 100% | 1 | 1 | 100% |
| **get_TimeoutSeconds()** | 100% | 1 | 1 | 100% |
| **get_UserAgent()** | 100% | 1 | 1 | 100% |
| **get_OverpassApiUrl()** | 100% | 1 | 1 | 100% |
| **ValidateAndClampRadius(...)** | 50.0% | 4 | 4 | 71.42% |

## File(s)

### E:\github\FunWasHad\src\FWH.Common.Location\Configuration\LocationServiceOptions.cs
```
 1            namespace FWH.Common.Location.Configuration;
 2            
 3            /// <summary>
 4            /// Configuration options for the location service.
 5            /// </summary>
 6            public class LocationServiceOptions
 7            {
 8                /// <summary>
 9                /// Default search radius in meters if not specified in query.
10                /// Default: 30 meters.
11                /// </summary>
12  ✔   8         public int DefaultRadiusMeters { get; set; } = 30;
13            
14                /// <summary>
15                /// Maximum allowed search radius in meters.
16                /// Default: 5000 meters (5 km) for optimal Overpass API performance.
17                /// </summary>
18  ✔  10         public int MaxRadiusMeters { get; set; } = 5000;
19            
20                /// <summary>
21                /// Minimum allowed search radius in meters.
22                /// Default: 50 meters.
23                /// </summary>
24  ✔  10         public int MinRadiusMeters { get; set; } = 50;
25            
26                /// <summary>
27                /// HTTP timeout for Overpass API requests in seconds.
28                /// Default: 30 seconds.
29                /// </summary>
30  ✔   4         public int TimeoutSeconds { get; set; } = 30;
31            
32                /// <summary>
33                /// User agent string for HTTP requests.
34                /// Default: "FunWasHad/1.0".
35                /// </summary>
36  ✔   4         public string UserAgent { get; set; } = "FunWasHad/1.0";
37            
38                /// <summary>
39                /// Base URL for the Overpass API.
40                /// Default: "https://overpass-api.de/api/interpreter".
41                /// </summary>
42  ✔  12         public string OverpassApiUrl { get; set; } = "https://overpass-api.de/api/interpreter";
43            
44                /// <summary>
45                /// Validates the radius against configured min/max limits and returns a clamped value.
46                /// </summary>
47                /// <param name="requestedRadius">The requested radius in meters.</param>
48                /// <returns>The clamped radius within valid bounds.</returns>
49                public int ValidateAndClampRadius(int requestedRadius)
50  ✔   2         {
51  ✓   2  ◑          if (requestedRadius < MinRadiusMeters)
52  ❌  0                 return MinRadiusMeters;
53            
54  ✓   2  ◑          if (requestedRadius > MaxRadiusMeters)
55  ❌  0                 return MaxRadiusMeters;
56            
57  ✔   2             return requestedRadius;
58  ✔   2         }
59            }
```
# FWH.Common.Location.Extensions.LocationServiceCollectionExtensions

## Summary

|||
|:---|:---|
| Class: | FWH.Common.Location.Extensions.LocationServiceCollectionExtensions |
| Assembly: | FWH.Common.Location |
| **File(s):** | E:\github\FunWasHad\src\FWH.Common.Location\Extensions\LocationServiceCollectionExtensions.cs |
| **Line coverage:** | 14.7% (21 of 142) |
| Covered lines: | 21 |
| Uncovered lines: | 121 |
| Coverable lines: | 142 |
| Total lines: | 197 |
| **Branch coverage:** | 0% (0 of 4) |
| Covered branches: | 0 |
| Total branches: | 4 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **AddLocationServices(...)** | 0% | 6 | 2 | 0% |
| **AddLocationServicesWithInMemoryConfig(...)** | 0% | 4 | 2 | 26.92% |

## File(s)

### E:\github\FunWasHad\src\FWH.Common.Location\Extensions\LocationServiceCollectionExtensions.cs
```
  1            using Microsoft.Extensions.DependencyInjection;
  2            using Microsoft.Extensions.Options;
  3            using FWH.Common.Location.Configuration;
  4            using FWH.Common.Location.Services;
  5            using FWH.Common.Chat.Services;
  6            using System;
  7            using System.Net.Http;
  8            using Microsoft.Extensions.Http.Resilience;
  9            using Polly;
 10            using Polly.CircuitBreaker;
 11            using Polly.Fallback;
 12            
 13            namespace FWH.Common.Location.Extensions;
 14            
 15            public static class LocationServiceCollectionExtensions
 16            {
 17                private const int Timeout_Seconds = 30;
 18            
 19                /// <summary>
 20                /// Adds location services with database-backed configuration.
 21                /// </summary>
 22                public static IServiceCollection AddLocationServices(this IServiceCollection services)
 23  ❌  0         {
 24                    // Register HttpClient for Overpass API with custom resilience pipeline
 25                    // that includes retry, circuit breaker, timeout
 26  ❌  0             services.AddHttpClient<OverpassLocationService>(client =>
 27  ❌  0             {
 28  ❌  0                 client.Timeout = TimeSpan.FromSeconds(30);
 29  ❌  0                 client.DefaultRequestHeaders.Add("User-Agent", "FunWasHad/1.0");
 30  ❌  0             })
 31  ❌  0             .AddResilienceHandler("overpass-pipeline", (ResiliencePipelineBuilder<HttpResponseMessage> builder) =>
 32  ❌  0             {
 33  ❌  0                 // 1. Circuit breaker (prevents cascading failures)
 34  ❌  0                 builder.AddCircuitBreaker(new CircuitBreakerStrategyOptions<HttpResponseMessage>
 35  ❌  0                 {
 36  ❌  0                     SamplingDuration = TimeSpan.FromSeconds(30),
 37  ❌  0                     FailureRatio = 0.5,
 38  ❌  0                     MinimumThroughput = 3,
 39  ❌  0                     BreakDuration = TimeSpan.FromSeconds(15),
 40  ❌  0                     ShouldHandle = new PredicateBuilder<HttpResponseMessage>()
 41  ❌  0                         .Handle<HttpRequestException>()
 42  ❌  0                         .Handle<TimeoutException>()
 43  ❌  0                         .HandleResult(response => !response.IsSuccessStatusCode)
 44  ❌  0                 });
 45  ❌  0     
 46  ❌  0                 // 3. Retry with exponential backoff
 47  ❌  0                 builder.AddRetry(new Polly.Retry.RetryStrategyOptions<HttpResponseMessage>
 48  ❌  0                 {
 49  ❌  0                     MaxRetryAttempts = 3,
 50  ❌  0                     BackoffType = Polly.DelayBackoffType.Exponential,
 51  ❌  0                     UseJitter = true,
 52  ❌  0                     Delay = TimeSpan.FromSeconds(1),
 53  ❌  0                     ShouldHandle = new PredicateBuilder<HttpResponseMessage>()
 54  ❌  0                         .Handle<HttpRequestException>()
 55  ❌  0                         .Handle<TimeoutException>()
 56  ❌  0  ○                      .HandleResult(response => !response.IsSuccessStatusCode && response.StatusCode != System.Net.HttpSta
 57  ❌  0                 });
 58  ❌  0     
 59  ❌  0                 // 4. Timeout per attempt (inner layer - wraps each individual request)
 60  ❌  0                 builder.AddTimeout(TimeSpan.FromSeconds(Timeout_Seconds));
 61  ❌  0             });
 62            
 63                    // Register configuration service
 64  ❌  0             services.AddSingleton<LocationConfigurationService>();
 65            
 66                    // Register options
 67  ❌  0             services.AddOptions<LocationServiceOptions>()
 68  ❌  0                 .Configure<LocationConfigurationService>((options, configService) =>
 69  ❌  0                 {
 70  ❌  0                     var config = configService.LoadOptionsAsync().GetAwaiter().GetResult();
 71  ❌  0                     options.DefaultRadiusMeters = config.DefaultRadiusMeters;
 72  ❌  0                     options.MaxRadiusMeters = config.MaxRadiusMeters;
 73  ❌  0                     options.MinRadiusMeters = config.MinRadiusMeters;
 74  ❌  0                     options.TimeoutSeconds = config.TimeoutSeconds;
 75  ❌  0                     options.UserAgent = config.UserAgent;
 76  ❌  0                     options.OverpassApiUrl = config.OverpassApiUrl;
 77  ❌  0                 });
 78            
 79                    // Register the base service
 80  ❌  0             services.AddSingleton<OverpassLocationService>();
 81            
 82                    // Register rate-limited decorator as the main ILocationService
 83  ❌  0             services.AddSingleton<ILocationService>(sp =>
 84  ❌  0             {
 85  ❌  0                 var innerService = sp.GetRequiredService<OverpassLocationService>();
 86  ❌  0                 var logger = sp.GetRequiredService<Microsoft.Extensions.Logging.ILogger<RateLimitedLocationService>>();
 87  ❌  0                 return new RateLimitedLocationService(innerService, logger, maxRequestsPerMinute: 10);
 88  ❌  0             });
 89            
 90                    // Register GPS service factory and service
 91                    // Note: Requires IPlatformService from FWH.Common.Chat to be registered first
 92  ❌  0             services.AddSingleton<GpsServiceFactory>();
 93  ❌  0             services.AddSingleton<IGpsService>(sp =>
 94  ❌  0             {
 95  ❌  0                 var factory = sp.GetRequiredService<GpsServiceFactory>();
 96  ❌  0                 return factory.CreateGpsService();
 97  ❌  0             });
 98            
 99  ❌  0             return services;
100  ❌  0         }
101            
102                /// <summary>
103                /// Adds location services with in-memory configuration (for testing).
104                /// </summary>
105                public static IServiceCollection AddLocationServicesWithInMemoryConfig(
106                    this IServiceCollection services,
107                    Action<LocationServiceOptions> configureOptions)
108  ✔  14         {
109                    // Register HttpClient with custom resilience pipeline
110                    // that includes retry, circuit breaker, timeout, and fallback
111  ✔  14             services.AddHttpClient<OverpassLocationService>(client =>
112  ❌  0             {
113  ✔  14                 //client.Timeout = TimeSpan.FromSeconds(30);
114  ❌  0                 client.DefaultRequestHeaders.Add("User-Agent", "FunWasHad/1.0");
115  ❌  0             })
116  ✔  14             .AddResilienceHandler("overpass-pipeline", (ResiliencePipelineBuilder<HttpResponseMessage> builder) =>
117  ❌  0             {
118  ✔  14                 // 1. Fallback (outer layer - executed last if all else fails)
119  ❌  0                 builder.AddFallback(new FallbackStrategyOptions<HttpResponseMessage>
120  ❌  0                 {
121  ❌  0                     ShouldHandle = new PredicateBuilder<HttpResponseMessage>()
122  ❌  0                         .Handle<HttpRequestException>()
123  ❌  0                         .Handle<TimeoutException>()
124  ❌  0                         .Handle<BrokenCircuitException>()
125  ❌  0                         .HandleResult(response => !response.IsSuccessStatusCode),
126  ❌  0                     FallbackAction = args =>
127  ❌  0                     {
128  ❌  0                         // Return an empty JSON response that the service will interpret as no results
129  ❌  0                         var fallbackResponse = new HttpResponseMessage(System.Net.HttpStatusCode.OK)
130  ❌  0                         {
131  ❌  0                             Content = new StringContent(@"{""elements"":[]}", System.Text.Encoding.UTF8, "application/json")
132  ❌  0                         };
133  ❌  0     
134  ❌  0                         return Outcome.FromResultAsValueTask(fallbackResponse);
135  ❌  0                     },
136  ❌  0                     OnFallback = args =>
137  ❌  0                     {
138  ❌  0                         // Fallback triggered - return empty result set
139  ❌  0                         return default;
140  ❌  0                     }
141  ❌  0                 });
142  ✔  14     
143  ✔  14                 // 2. Circuit breaker (prevents cascading failures)
144  ❌  0                 builder.AddCircuitBreaker(new CircuitBreakerStrategyOptions<HttpResponseMessage>
145  ❌  0                 {
146  ❌  0                     SamplingDuration = TimeSpan.FromSeconds(30),
147  ❌  0                     FailureRatio = 0.5,
148  ❌  0                     MinimumThroughput = 3,
149  ❌  0                     BreakDuration = TimeSpan.FromSeconds(15),
150  ❌  0                     ShouldHandle = new PredicateBuilder<HttpResponseMessage>()
151  ❌  0                         .Handle<HttpRequestException>()
152  ❌  0                         .Handle<TimeoutException>()
153  ❌  0                         .HandleResult(response => !response.IsSuccessStatusCode)
154  ❌  0                 });
155  ✔  14     
156  ✔  14                 // 3. Retry with exponential backoff
157  ❌  0                 builder.AddRetry(new Polly.Retry.RetryStrategyOptions<HttpResponseMessage>
158  ❌  0                 {
159  ❌  0                     MaxRetryAttempts = 3,
160  ❌  0                     BackoffType = Polly.DelayBackoffType.Exponential,
161  ❌  0                     UseJitter = true,
162  ❌  0                     Delay = TimeSpan.FromSeconds(1),
163  ❌  0                     ShouldHandle = new PredicateBuilder<HttpResponseMessage>()
164  ❌  0                         .Handle<HttpRequestException>()
165  ❌  0                         .Handle<TimeoutException>()
166  ❌  0  ○                      .HandleResult(response => !response.IsSuccessStatusCode && response.StatusCode != System.Net.HttpSta
167  ❌  0                 });
168  ✔  14     
169  ✔  14                 // 4. Timeout per attempt (inner layer - wraps each individual request)
170  ❌  0                 builder.AddTimeout(TimeSpan.FromSeconds(10));
171  ✔  14             });
172            
173                    // Configure options
174  ✔  14             services.Configure(configureOptions);
175            
176                    // Register the base service
177  ✔  14             services.AddSingleton<OverpassLocationService>();
178            
179                    // Register rate-limited decorator
180  ✔  14             services.AddSingleton<ILocationService>(sp =>
181  ❌  0             {
182  ❌  0                 var innerService = sp.GetRequiredService<OverpassLocationService>();
183  ❌  0                 var logger = sp.GetRequiredService<Microsoft.Extensions.Logging.ILogger<RateLimitedLocationService>>();
184  ❌  0                 return new RateLimitedLocationService(innerService, logger, maxRequestsPerMinute: 10);
185  ✔  14             });
186            
187                    // Register GPS service factory and service
188  ✔  14             services.AddSingleton<GpsServiceFactory>();
189  ✔  14             services.AddSingleton<IGpsService>(sp =>
190  ❌  0             {
191  ❌  0                 var factory = sp.GetRequiredService<GpsServiceFactory>();
192  ❌  0                 return factory.CreateGpsService();
193  ✔  14             });
194            
195  ✔  14             return services;
196  ✔  14         }
197            }
```
# FWH.Common.Location.LocationServicesException

## Summary

|||
|:---|:---|
| Class: | FWH.Common.Location.LocationServicesException |
| Assembly: | FWH.Common.Location |
| **File(s):** | E:\github\FunWasHad\src\FWH.Common.Location\LocationServicesException.cs |
| **Line coverage:** | 96% (24 of 25) |
| Covered lines: | 24 |
| Uncovered lines: | 1 |
| Coverable lines: | 25 |
| Total lines: | 65 |
| **Branch coverage:** | 64.2% (9 of 14) |
| Covered branches: | 9 |
| Total branches: | 14 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **get_Platform()** | 100% | 1 | 1 | 100% |
| **get_Operation()** | 100% | 1 | 1 | 100% |
| **get_Diagnostics()** | 100% | 1 | 1 | 100% |
| **.ctor(...)** | 50.0% | 2 | 2 | 100% |
| **BuildMessage(...)** | 66.66% | 12 | 12 | 93.75% |

## File(s)

### E:\github\FunWasHad\src\FWH.Common.Location\LocationServicesException.cs
```
 1            using System;
 2            using System.Collections.Generic;
 3            using System.Linq;
 4            using System.Text;
 5            
 6            namespace FWH.Common.Location;
 7            
 8            /// <summary>
 9            /// Exception thrown when location services fail.
10            /// Includes detailed diagnostic information to help debug location service issues.
11            /// </summary>
12            public class LocationServicesException : Exception
13            {
14                /// <summary>
15                /// Gets the platform on which the error occurred.
16                /// </summary>
17  ✔   3         public string Platform { get; }
18            
19                /// <summary>
20                /// Gets the operation that was being performed when the error occurred.
21                /// </summary>
22  ✔   3         public string Operation { get; }
23            
24                /// <summary>
25                /// Gets additional diagnostic information about the failure.
26                /// </summary>
27  ✔   2         public Dictionary<string, object?> Diagnostics { get; }
28            
29                public LocationServicesException(
30                    string platform,
31                    string operation,
32                    string message,
33                    Dictionary<string, object?>? diagnostics = null,
34                    Exception? innerException = null)
35  ✔   1             : base(BuildMessage(platform, operation, message, diagnostics), innerException)
36  ✔   1         {
37  ✔   1             Platform = platform;
38  ✔   1             Operation = operation;
39  ✓   1  ◑          Diagnostics = diagnostics ?? new Dictionary<string, object?>();
40  ✔   1         }
41            
42                private static string BuildMessage(
43                    string platform,
44                    string operation,
45                    string message,
46                    Dictionary<string, object?>? diagnostics)
47  ✔   1         {
48  ✔   1             var sb = new StringBuilder();
49  ✔   1             sb.AppendLine($"Location service failure on {platform} during {operation}: {message}");
50            
51  ✓   1  ◑          if (diagnostics != null && diagnostics.Count > 0)
52  ✔   1             {
53  ✔   1                 sb.AppendLine("Diagnostics:");
54  ✔  12  ●              foreach (var kvp in diagnostics.OrderBy(k => k.Key))
55  ✔   3                 {
56  ✓   3  ◑                  var value = kvp.Value?.ToString() ?? "null";
57  ✓   3  ◑                  if (value.Length > 200)
58  ❌  0                         value = value.Substring(0, 200) + "...";
59  ✔   3                     sb.AppendLine($"  {kvp.Key}: {value}");
60  ✔   3                 }
61  ✔   1             }
62            
63  ✔   1             return sb.ToString();
64  ✔   1         }
65            }
```
# FWH.Common.Location.Models.BusinessLocation

## Summary

|||
|:---|:---|
| Class: | FWH.Common.Location.Models.BusinessLocation |
| Assembly: | FWH.Common.Location |
| **File(s):** | E:\github\FunWasHad\src\FWH.Common.Location\Models\BusinessLocation.cs |
| **Line coverage:** | 77.7% (7 of 9) |
| Covered lines: | 7 |
| Uncovered lines: | 2 |
| Coverable lines: | 9 |
| Total lines: | 47 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **.ctor(...)** | 100% | 2 | 1 | 0% |
| **get_Id()** | 100% | 2 | 1 | 0% |
| **get_Name()** | 100% | 1 | 1 | 100% |
| **get_Address()** | 100% | 1 | 1 | 100% |
| **get_Latitude()** | 100% | 1 | 1 | 100% |
| **get_Longitude()** | 100% | 1 | 1 | 100% |
| **get_Category()** | 100% | 1 | 1 | 100% |
| **get_Tags()** | 100% | 1 | 1 | 100% |
| **get_DistanceMeters()** | 100% | 1 | 1 | 100% |

## File(s)

### E:\github\FunWasHad\src\FWH.Common.Location\Models\BusinessLocation.cs
```
 1           namespace FWH.Common.Location.Models;
 2           
 3           /// <summary>
 4           /// Represents a business or point of interest location.
 5           /// </summary>
 6  ❌ 0     public record BusinessLocation
 7           {
 8               /// <summary>
 9               /// Optional business ID (e.g. from Marketing DB or OSM). When null, theme application is skipped.
10               /// </summary>
11  ❌ 0         public long? Id { get; init; }
12           
13               /// <summary>
14               /// The name of the business or POI.
15               /// </summary>
16  ✔  4         public required string Name { get; init; }
17           
18               /// <summary>
19               /// The full address of the location.
20               /// </summary>
21  ✔  2         public string? Address { get; init; }
22           
23               /// <summary>
24               /// Latitude coordinate.
25               /// </summary>
26  ✔  2         public double Latitude { get; init; }
27           
28               /// <summary>
29               /// Longitude coordinate.
30               /// </summary>
31  ✔  2         public double Longitude { get; init; }
32           
33               /// <summary>
34               /// The category or type of the business (e.g., restaurant, shop, cafe).
35               /// </summary>
36  ✔  3         public string? Category { get; init; }
37           
38               /// <summary>
39               /// Additional tags from OpenStreetMap.
40               /// </summary>
41  ✔  4         public Dictionary<string, string> Tags { get; init; } = new();
42           
43               /// <summary>
44               /// Distance from the search point in meters (if calculated).
45               /// </summary>
46  ✔  2         public double? DistanceMeters { get; init; }
47           }
```
# FWH.Common.Location.Models.GpsCoordinates

## Summary

|||
|:---|:---|
| Class: | FWH.Common.Location.Models.GpsCoordinates |
| Assembly: | FWH.Common.Location |
| **File(s):** | E:\github\FunWasHad\src\FWH.Common.Location\Models\GpsCoordinates.cs |
| **Line coverage:** | 60% (15 of 25) |
| Covered lines: | 15 |
| Uncovered lines: | 10 |
| Coverable lines: | 25 |
| Total lines: | 68 |
| **Branch coverage:** | 50% (3 of 6) |
| Covered branches: | 3 |
| Total branches: | 6 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **get_Latitude()** | 100% | 1 | 1 | 100% |
| **get_Longitude()** | 100% | 1 | 1 | 100% |
| **get_AccuracyMeters()** | 100% | 1 | 1 | 100% |
| **get_AltitudeMeters()** | 100% | 1 | 1 | 100% |
| **get_SpeedMetersPerSecond()** | 100% | 1 | 1 | 100% |
| **get_Timestamp()** | 100% | 1 | 1 | 100% |
| **.ctor()** | 100% | 2 | 1 | 0% |
| **.ctor(...)** | 100% | 1 | 1 | 100% |
| **.ctor(...)** | 100% | 2 | 1 | 0% |
| **IsValid()** | 50.0% | 6 | 6 | 100% |
| **ToString()** | 100% | 2 | 1 | 0% |

## File(s)

### E:\github\FunWasHad\src\FWH.Common.Location\Models\GpsCoordinates.cs
```
 1             namespace FWH.Common.Location.Models;
 2             
 3             /// <summary>
 4             /// Represents GPS coordinates (latitude and longitude).
 5             /// </summary>
 6             public class GpsCoordinates
 7             {
 8                 /// <summary>
 9                 /// Latitude in decimal degrees (-90 to 90).
10                 /// </summary>
11  ✔  240         public double Latitude { get; set; }
12             
13                 /// <summary>
14                 /// Longitude in decimal degrees (-180 to 180).
15                 /// </summary>
16  ✔  240         public double Longitude { get; set; }
17             
18                 /// <summary>
19                 /// Accuracy of the location in meters (optional).
20                 /// </summary>
21  ✔   13         public double? AccuracyMeters { get; set; }
22             
23                 /// <summary>
24                 /// Altitude in meters above sea level (optional).
25                 /// </summary>
26  ✔   13         public double? AltitudeMeters { get; set; }
27             
28                 /// <summary>
29                 /// Speed in meters per second (optional).
30                 /// This is the instant speed reported by the device GPS.
31                 /// </summary>
32  ✔   30         public double? SpeedMetersPerSecond { get; set; }
33             
34                 /// <summary>
35                 /// Timestamp when the coordinates were obtained.
36                 /// </summary>
37  ✔   76         public DateTimeOffset Timestamp { get; set; } = DateTimeOffset.UtcNow;
38             
39  ❌   0         public GpsCoordinates()
40  ❌   0         {
41  ❌   0         }
42             
43  ✔   13         public GpsCoordinates(double latitude, double longitude)
44  ✔   13         {
45  ✔   13             Latitude = latitude;
46  ✔   13             Longitude = longitude;
47  ✔   13         }
48             
49                 public GpsCoordinates(double latitude, double longitude, double accuracyMeters)
50  ❌   0             : this(latitude, longitude)
51  ❌   0         {
52  ❌   0             AccuracyMeters = accuracyMeters;
53  ❌   0         }
54             
55                 /// <summary>
56                 /// Validates that the coordinates are within valid ranges.
57                 /// </summary>
58                 public bool IsValid()
59  ✔   39         {
60  ✓   39  ◑          return Latitude >= -90 && Latitude <= 90 &&
61  ✔   39                    Longitude >= -180 && Longitude <= 180;
62  ✔   39         }
63             
64                 public override string ToString()
65  ❌   0         {
66  ❌   0             return $"({Latitude:F6}, {Longitude:F6})";
67  ❌   0         }
68             }
```
# FWH.Common.Location.RateLimiting.TokenBucketRateLimiter

## Summary

|||
|:---|:---|
| Class: | FWH.Common.Location.RateLimiting.TokenBucketRateLimiter |
| Assembly: | FWH.Common.Location |
| **File(s):** | E:\github\FunWasHad\src\FWH.Common.Location\RateLimiting\TokenBucketRateLimiter.cs |
| **Line coverage:** | 0% (0 of 66) |
| Covered lines: | 0 |
| Uncovered lines: | 66 |
| Coverable lines: | 66 |
| Total lines: | 129 |
| **Branch coverage:** | 0% (0 of 14) |
| Covered branches: | 0 |
| Total branches: | 14 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **.ctor(...)** | 0% | 20 | 4 | 0% |
| **WaitAsync()** | 0% | 42 | 6 | 0% |
| **TryConsume()** | 0% | 6 | 2 | 0% |
| **get_AvailableTokens()** | 100% | 2 | 1 | 0% |
| **RefillTokensAsync()** | 100% | 2 | 1 | 0% |
| **RefillTokens()** | 0% | 6 | 2 | 0% |

## File(s)

### E:\github\FunWasHad\src\FWH.Common.Location\RateLimiting\TokenBucketRateLimiter.cs
```
  1           using System;
  2           using System.Threading;
  3           using System.Threading.Tasks;
  4           
  5           namespace FWH.Common.Location.RateLimiting;
  6           
  7           /// <summary>
  8           /// Token bucket rate limiter implementation.
  9           /// Limits the rate of API calls to respect external service limits.
 10           /// </summary>
 11           public class TokenBucketRateLimiter
 12           {
 13               private readonly SemaphoreSlim _semaphore;
 14               private readonly int _maxTokens;
 15               private readonly TimeSpan _refillInterval;
 16               private int _availableTokens;
 17               private DateTime _lastRefillTime;
 18  ❌ 0         private readonly object _lock = new();
 19           
 20               /// <summary>
 21               /// Creates a new token bucket rate limiter.
 22               /// </summary>
 23               /// <param name="maxTokens">Maximum number of tokens (requests) in the bucket</param>
 24               /// <param name="refillInterval">Time interval to refill one token</param>
 25  ❌ 0         public TokenBucketRateLimiter(int maxTokens, TimeSpan refillInterval)
 26  ❌ 0         {
 27  ❌ 0  ○          if (maxTokens <= 0)
 28  ❌ 0                 throw new ArgumentException("Max tokens must be positive", nameof(maxTokens));
 29           
 30  ❌ 0  ○          if (refillInterval <= TimeSpan.Zero)
 31  ❌ 0                 throw new ArgumentException("Refill interval must be positive", nameof(refillInterval));
 32           
 33  ❌ 0             _maxTokens = maxTokens;
 34  ❌ 0             _refillInterval = refillInterval;
 35  ❌ 0             _availableTokens = maxTokens;
 36  ❌ 0             _lastRefillTime = DateTime.UtcNow;
 37  ❌ 0             _semaphore = new SemaphoreSlim(1, 1);
 38  ❌ 0         }
 39           
 40               /// <summary>
 41               /// Waits until a token is available, then consumes it.
 42               /// </summary>
 43               /// <param name="cancellationToken">Cancellation token</param>
 44               /// <returns>Task that completes when a token is consumed</returns>
 45               public async Task WaitAsync(CancellationToken cancellationToken = default)
 46  ❌ 0  ○      {
 47  ❌ 0             await _semaphore.WaitAsync(cancellationToken);
 48                   try
 49  ❌ 0             {
 50  ❌ 0                 await RefillTokensAsync();
 51           
 52  ❌ 0  ○              while (_availableTokens <= 0)
 53  ❌ 0                 {
 54  ❌ 0                     var timeSinceLastRefill = DateTime.UtcNow - _lastRefillTime;
 55  ❌ 0                     var timeToWait = _refillInterval - timeSinceLastRefill;
 56           
 57  ❌ 0  ○                  if (timeToWait > TimeSpan.Zero)
 58  ❌ 0                     {
 59  ❌ 0                         await Task.Delay(timeToWait, cancellationToken);
 60  ❌ 0                     }
 61           
 62  ❌ 0                     await RefillTokensAsync();
 63  ❌ 0                 }
 64           
 65  ❌ 0                 _availableTokens--;
 66  ❌ 0             }
 67                   finally
 68  ❌ 0             {
 69  ❌ 0                 _semaphore.Release();
 70  ❌ 0             }
 71  ❌ 0         }
 72           
 73               /// <summary>
 74               /// Tries to consume a token without waiting.
 75               /// </summary>
 76               /// <returns>True if a token was available and consumed, false otherwise</returns>
 77               public bool TryConsume()
 78  ❌ 0         {
 79  ❌ 0             lock (_lock)
 80  ❌ 0             {
 81  ❌ 0                 RefillTokens();
 82           
 83  ❌ 0  ○              if (_availableTokens > 0)
 84  ❌ 0                 {
 85  ❌ 0                     _availableTokens--;
 86  ❌ 0                     return true;
 87                       }
 88           
 89  ❌ 0                 return false;
 90                   }
 91  ❌ 0         }
 92           
 93               /// <summary>
 94               /// Gets the number of currently available tokens.
 95               /// </summary>
 96               public int AvailableTokens
 97               {
 98                   get
 99  ❌ 0             {
100  ❌ 0                 lock (_lock)
101  ❌ 0                 {
102  ❌ 0                     RefillTokens();
103  ❌ 0                     return _availableTokens;
104                       }
105  ❌ 0             }
106               }
107           
108               private Task RefillTokensAsync()
109  ❌ 0         {
110  ❌ 0             lock (_lock)
111  ❌ 0             {
112  ❌ 0                 RefillTokens();
113  ❌ 0             }
114  ❌ 0             return Task.CompletedTask;
115  ❌ 0         }
116           
117               private void RefillTokens()
118  ❌ 0         {
119  ❌ 0             var now = DateTime.UtcNow;
120  ❌ 0             var timeSinceLastRefill = now - _lastRefillTime;
121           
122  ❌ 0  ○          if (timeSinceLastRefill >= _refillInterval)
123  ❌ 0             {
124  ❌ 0                 var tokensToAdd = (int)(timeSinceLastRefill.TotalMilliseconds / _refillInterval.TotalMilliseconds);
125  ❌ 0                 _availableTokens = Math.Min(_availableTokens + tokensToAdd, _maxTokens);
126  ❌ 0                 _lastRefillTime = now;
127  ❌ 0             }
128  ❌ 0         }
129           }
```
# FWH.Common.Location.Services.GpsServiceFactory

## Summary

|||
|:---|:---|
| Class: | FWH.Common.Location.Services.GpsServiceFactory |
| Assembly: | FWH.Common.Location |
| **File(s):** | E:\github\FunWasHad\src\FWH.Common.Location\Services\GpsServiceFactory.cs |
| **Line coverage:** | 0% (0 of 26) |
| Covered lines: | 0 |
| Uncovered lines: | 26 |
| Coverable lines: | 26 |
| Total lines: | 55 |
| **Branch coverage:** | 0% (0 of 16) |
| Covered branches: | 0 |
| Total branches: | 16 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **.ctor(...)** | 0% | 20 | 4 | 0% |
| **CreateGpsService()** | 0% | 156 | 12 | 0% |

## File(s)

### E:\github\FunWasHad\src\FWH.Common.Location\Services\GpsServiceFactory.cs
```
 1           using System;
 2           using Microsoft.Extensions.DependencyInjection;
 3           using FWH.Common.Chat.Services;
 4           
 5           namespace FWH.Common.Location.Services;
 6           
 7           /// <summary>
 8           /// Factory for creating platform-specific GPS services.
 9           /// Uses the same pattern as CameraServiceFactory.
10           /// </summary>
11           public class GpsServiceFactory
12           {
13               private readonly IServiceProvider _serviceProvider;
14               private readonly IPlatformService _platformService;
15           
16  ❌ 0         public GpsServiceFactory(IServiceProvider serviceProvider, IPlatformService platformService)
17  ❌ 0         {
18  ❌ 0  ○          _serviceProvider = serviceProvider ?? throw new ArgumentNullException(nameof(serviceProvider));
19  ❌ 0  ○          _platformService = platformService ?? throw new ArgumentNullException(nameof(platformService));
20  ❌ 0         }
21           
22               /// <summary>
23               /// Creates the appropriate GPS service for the current platform.
24               /// </summary>
25               public IGpsService CreateGpsService()
26  ❌ 0         {
27                   // Try to get platform-specific implementations from DI
28                   // The platform-specific projects will register their implementations with a key
29           
30  ❌ 0  ○          if (_platformService.IsAndroid)
31  ❌ 0             {
32                       // Try to get Android-specific service
33  ❌ 0                 var androidService = _serviceProvider.GetKeyedService<IGpsService>("Android");
34  ❌ 0  ○              if (androidService != null)
35  ❌ 0                     return androidService;
36  ❌ 0             }
37  ❌ 0  ○          else if (_platformService.IsIOS)
38  ❌ 0             {
39                       // Try to get iOS-specific service
40  ❌ 0                 var iosService = _serviceProvider.GetKeyedService<IGpsService>("iOS");
41  ❌ 0  ○              if (iosService != null)
42  ❌ 0                     return iosService;
43  ❌ 0             }
44  ❌ 0  ○          else if (_platformService.IsDesktop)
45  ❌ 0             {
46                       // Try to get Desktop-specific service (Windows)
47  ❌ 0                 var desktopService = _serviceProvider.GetKeyedService<IGpsService>("Desktop");
48  ❌ 0  ○              if (desktopService != null)
49  ❌ 0                     return desktopService;
50  ❌ 0             }
51           
52                   // Fallback to NoGpsService for browser/unknown platforms
53  ❌ 0             return new NoGpsService();
54  ❌ 0         }
55           }
```
# FWH.Common.Location.Services.LocationConfigurationService

## Summary

|||
|:---|:---|
| Class: | FWH.Common.Location.Services.LocationConfigurationService |
| Assembly: | FWH.Common.Location |
| **File(s):** | E:\github\FunWasHad\src\FWH.Common.Location\Services\LocationConfigurationService.cs |
| **Line coverage:** | 0% (0 of 73) |
| Covered lines: | 0 |
| Uncovered lines: | 73 |
| Coverable lines: | 73 |
| Total lines: | 141 |
| **Branch coverage:** | 0% (0 of 14) |
| Covered branches: | 0 |
| Total branches: | 14 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **.ctor(...)** | 0% | 6 | 2 | 0% |
| **LoadOptionsAsync()** | 0% | 156 | 12 | 0% |
| **SaveOptionsAsync()** | 100% | 2 | 1 | 0% |
| **SetDefaultRadiusAsync()** | 100% | 2 | 1 | 0% |
| **SetMaxRadiusAsync()** | 100% | 2 | 1 | 0% |
| **SetMinRadiusAsync()** | 100% | 2 | 1 | 0% |

## File(s)

### E:\github\FunWasHad\src\FWH.Common.Location\Services\LocationConfigurationService.cs
```
  1           using FWH.Mobile.Data.Repositories;
  2           using FWH.Common.Location.Configuration;
  3           
  4           namespace FWH.Common.Location.Services;
  5           
  6           /// <summary>
  7           /// Service for loading and saving location configuration from database.
  8           /// Single Responsibility: Bridge between LocationServiceOptions and database.
  9           /// </summary>
 10           public class LocationConfigurationService
 11           {
 12               private readonly IConfigurationRepository _repository;
 13               private const string CategoryName = "Location";
 14           
 15               // Configuration keys
 16               private const string KeyDefaultRadius = "Location.DefaultRadiusMeters";
 17               private const string KeyMaxRadius = "Location.MaxRadiusMeters";
 18               private const string KeyMinRadius = "Location.MinRadiusMeters";
 19               private const string KeyTimeout = "Location.TimeoutSeconds";
 20               private const string KeyUserAgent = "Location.UserAgent";
 21               private const string KeyApiUrl = "Location.OverpassApiUrl";
 22           
 23  ❌ 0         public LocationConfigurationService(IConfigurationRepository repository)
 24  ❌ 0         {
 25  ❌ 0  ○          _repository = repository ?? throw new ArgumentNullException(nameof(repository));
 26  ❌ 0         }
 27           
 28               /// <summary>
 29               /// Loads location service options from the database.
 30               /// If values don't exist, uses defaults and saves them.
 31               /// </summary>
 32               public async Task<LocationServiceOptions> LoadOptionsAsync()
 33  ❌ 0         {
 34  ❌ 0             var options = new LocationServiceOptions();
 35           
 36                   // Load or initialize default radius (30 meters as requested)
 37  ❌ 0  ○          if (await _repository.ExistsAsync(KeyDefaultRadius))
 38  ❌ 0             {
 39  ❌ 0                 options.DefaultRadiusMeters = await _repository.GetIntAsync(KeyDefaultRadius, 30);
 40  ❌ 0             }
 41                   else
 42  ❌ 0             {
 43  ❌ 0                 options.DefaultRadiusMeters = 30;
 44  ❌ 0                 await _repository.SetIntAsync(KeyDefaultRadius, 30, CategoryName, "Default search radius in meters");
 45  ❌ 0             }
 46           
 47                   // Load or initialize max radius
 48  ❌ 0  ○          if (await _repository.ExistsAsync(KeyMaxRadius))
 49  ❌ 0             {
 50  ❌ 0                 options.MaxRadiusMeters = await _repository.GetIntAsync(KeyMaxRadius, 5000);
 51  ❌ 0             }
 52                   else
 53  ❌ 0             {
 54  ❌ 0                 options.MaxRadiusMeters = 5000;
 55  ❌ 0                 await _repository.SetIntAsync(KeyMaxRadius, 5000, CategoryName, "Maximum allowed search radius in meters");
 56  ❌ 0             }
 57           
 58                   // Load or initialize min radius
 59  ❌ 0  ○          if (await _repository.ExistsAsync(KeyMinRadius))
 60  ❌ 0             {
 61  ❌ 0                 options.MinRadiusMeters = await _repository.GetIntAsync(KeyMinRadius, 50);
 62  ❌ 0             }
 63                   else
 64  ❌ 0             {
 65  ❌ 0                 options.MinRadiusMeters = 50;
 66  ❌ 0                 await _repository.SetIntAsync(KeyMinRadius, 50, CategoryName, "Minimum allowed search radius in meters");
 67  ❌ 0             }
 68           
 69                   // Load or initialize timeout
 70  ❌ 0  ○          if (await _repository.ExistsAsync(KeyTimeout))
 71  ❌ 0             {
 72  ❌ 0                 options.TimeoutSeconds = await _repository.GetIntAsync(KeyTimeout, 30);
 73  ❌ 0             }
 74                   else
 75  ❌ 0             {
 76  ❌ 0                 options.TimeoutSeconds = 30;
 77  ❌ 0                 await _repository.SetIntAsync(KeyTimeout, 30, CategoryName, "HTTP timeout in seconds");
 78  ❌ 0             }
 79           
 80                   // Load or initialize user agent
 81  ❌ 0  ○          if (await _repository.ExistsAsync(KeyUserAgent))
 82  ❌ 0             {
 83  ❌ 0                 options.UserAgent = await _repository.GetStringAsync(KeyUserAgent, "FunWasHad/1.0");
 84  ❌ 0             }
 85                   else
 86  ❌ 0             {
 87  ❌ 0                 options.UserAgent = "FunWasHad/1.0";
 88  ❌ 0                 await _repository.SetAsync(KeyUserAgent, "FunWasHad/1.0", "string", CategoryName, "User agent for HTTP reque
 89  ❌ 0             }
 90           
 91                   // Load or initialize API URL
 92  ❌ 0  ○          if (await _repository.ExistsAsync(KeyApiUrl))
 93  ❌ 0             {
 94  ❌ 0                 options.OverpassApiUrl = await _repository.GetStringAsync(KeyApiUrl, "https://overpass-api.de/api/interprete
 95  ❌ 0             }
 96                   else
 97  ❌ 0             {
 98  ❌ 0                 options.OverpassApiUrl = "https://overpass-api.de/api/interpreter";
 99  ❌ 0                 await _repository.SetAsync(KeyApiUrl, "https://overpass-api.de/api/interpreter", "string", CategoryName, "Ov
100  ❌ 0             }
101           
102  ❌ 0             return options;
103  ❌ 0         }
104           
105               /// <summary>
106               /// Saves location service options to the database.
107               /// </summary>
108               public async Task SaveOptionsAsync(LocationServiceOptions options)
109  ❌ 0         {
110  ❌ 0             await _repository.SetIntAsync(KeyDefaultRadius, options.DefaultRadiusMeters, CategoryName, "Default search radiu
111  ❌ 0             await _repository.SetIntAsync(KeyMaxRadius, options.MaxRadiusMeters, CategoryName, "Maximum allowed search radiu
112  ❌ 0             await _repository.SetIntAsync(KeyMinRadius, options.MinRadiusMeters, CategoryName, "Minimum allowed search radiu
113  ❌ 0             await _repository.SetIntAsync(KeyTimeout, options.TimeoutSeconds, CategoryName, "HTTP timeout in seconds");
114  ❌ 0             await _repository.SetAsync(KeyUserAgent, options.UserAgent, "string", CategoryName, "User agent for HTTP request
115  ❌ 0             await _repository.SetAsync(KeyApiUrl, options.OverpassApiUrl, "string", CategoryName, "Overpass API endpoint URL
116  ❌ 0         }
117           
118               /// <summary>
119               /// Updates the default radius in the database.
120               /// </summary>
121               public async Task SetDefaultRadiusAsync(int radiusMeters)
122  ❌ 0         {
123  ❌ 0             await _repository.SetIntAsync(KeyDefaultRadius, radiusMeters, CategoryName, "Default search radius in meters");
124  ❌ 0         }
125           
126               /// <summary>
127               /// Updates the max radius in the database.
128               /// </summary>
129               public async Task SetMaxRadiusAsync(int radiusMeters)
130  ❌ 0         {
131  ❌ 0             await _repository.SetIntAsync(KeyMaxRadius, radiusMeters, CategoryName, "Maximum allowed search radius in meters
132  ❌ 0         }
133           
134               /// <summary>
135               /// Updates the min radius in the database.
136               /// </summary>
137               public async Task SetMinRadiusAsync(int radiusMeters)
138  ❌ 0         {
139  ❌ 0             await _repository.SetIntAsync(KeyMinRadius, radiusMeters, CategoryName, "Minimum allowed search radius in meters
140  ❌ 0         }
141           }
```
# FWH.Common.Location.Services.NoGpsService

## Summary

|||
|:---|:---|
| Class: | FWH.Common.Location.Services.NoGpsService |
| Assembly: | FWH.Common.Location |
| **File(s):** | E:\github\FunWasHad\src\FWH.Common.Location\Services\NoGpsService.cs |
| **Line coverage:** | 0% (0 of 7) |
| Covered lines: | 0 |
| Uncovered lines: | 7 |
| Coverable lines: | 7 |
| Total lines: | 22 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **get_IsLocationAvailable()** | 100% | 2 | 1 | 0% |
| **GetCurrentLocationAsync(...)** | 100% | 2 | 1 | 0% |
| **RequestLocationPermissionAsync()** | 100% | 2 | 1 | 0% |

## File(s)

### E:\github\FunWasHad\src\FWH.Common.Location\Services\NoGpsService.cs
```
 1           using FWH.Common.Location.Models;
 2           
 3           namespace FWH.Common.Location.Services;
 4           
 5           /// <summary>
 6           /// Fallback GPS service for platforms without GPS support (desktop, browser).
 7           /// Returns null for all location requests.
 8           /// </summary>
 9           public class NoGpsService : IGpsService
10           {
11  ❌ 0         public bool IsLocationAvailable => false;
12           
13               public Task<GpsCoordinates?> GetCurrentLocationAsync(CancellationToken cancellationToken = default)
14  ❌ 0         {
15  ❌ 0             return Task.FromResult<GpsCoordinates?>(null);
16  ❌ 0         }
17           
18               public Task<bool> RequestLocationPermissionAsync()
19  ❌ 0         {
20  ❌ 0             return Task.FromResult(false);
21  ❌ 0         }
22           }
```
# FWH.Common.Location.Services.OverpassLocationService

## Summary

|||
|:---|:---|
| Class: | FWH.Common.Location.Services.OverpassLocationService |
| Assembly: | FWH.Common.Location |
| **File(s):** | E:\github\FunWasHad\src\FWH.Common.Location\Services\OverpassLocationService.cs |
| **Line coverage:** | 38.7% (117 of 302) |
| Covered lines: | 117 |
| Uncovered lines: | 185 |
| Coverable lines: | 302 |
| Total lines: | 499 |
| **Branch coverage:** | 25% (36 of 144) |
| Covered branches: | 36 |
| Total branches: | 144 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **.ctor(...)** | 50.0% | 8 | 8 | 100% |
| **GetNearbyBusinessesAsync()** | 50.0% | 21 | 8 | 40.74% |
| **GetClosestBusinessAsync()** | 100% | 2 | 1 | 0% |
| **GetAddressAsync()** | 0% | 272 | 16 | 0% |
| **ValidateCoordinates(...)** | 75.00% | 8 | 8 | 100% |
| **BuildOverpassQuery(...)** | 33.33% | 21 | 12 | 60.0% |
| **SanitizeCategory(...)** | 0% | 342 | 18 | 0% |
| **BuildAddressQuery(...)** | 100% | 2 | 1 | 0% |
| **HasAddressTags(...)** | 0% | 42 | 6 | 0% |
| **BuildAddressFromTags(...)** | 0% | 110 | 10 | 0% |
| **ConvertToBusinessLocation(...)** | 53.84% | 26 | 26 | 93.54% |
| **CalculateDistance(...)** | 100% | 1 | 1 | 100% |
| **DegreesToRadians(...)** | 100% | 1 | 1 | 100% |
| **get_Elements()** | 100% | 1 | 1 | 100% |
| **get_Type()** | 100% | 1 | 1 | 100% |
| **get_Id()** | 100% | 1 | 1 | 100% |
| **get_Lat()** | 100% | 1 | 1 | 100% |
| **get_Lon()** | 100% | 1 | 1 | 100% |
| **get_Center()** | 100% | 2 | 1 | 0% |
| **get_Tags()** | 100% | 1 | 1 | 100% |
| **get_Lat()** | 100% | 2 | 1 | 0% |
| **get_Lon()** | 100% | 2 | 1 | 0% |

## File(s)

### E:\github\FunWasHad\src\FWH.Common.Location\Services\OverpassLocationService.cs
```
  1           using System.Text.Json;
  2           using System.Text.Json.Serialization;
  3           using Microsoft.Extensions.Logging;
  4           using Microsoft.Extensions.Options;
  5           using FWH.Common.Location.Models;
  6           using FWH.Common.Location.Configuration;
  7           
  8           namespace FWH.Common.Location.Services;
  9           
 10           /// <summary>
 11           /// Location service implementation using OpenStreetMap's Overpass API.
 12           /// This is a free, open-source solution with no API key required.
 13           /// Single Responsibility: Query Overpass API for nearby POIs.
 14           /// </summary>
 15           public class OverpassLocationService : ILocationService
 16           {
 17               private readonly HttpClient _httpClient;
 18               private readonly ILogger<OverpassLocationService> _logger;
 19               private readonly LocationServiceOptions _options;
 20               private readonly string _overpassApiUrl;
 21           
 22  ✔  4         public OverpassLocationService(
 23  ✔  4             HttpClient httpClient,
 24  ✔  4             ILogger<OverpassLocationService> logger,
 25  ✔  4             IOptions<LocationServiceOptions> options)
 26  ✔  4         {
 27  ✓  4  ◑          _httpClient = httpClient ?? throw new ArgumentNullException(nameof(httpClient));
 28  ✓  4  ◑          _logger = logger ?? throw new ArgumentNullException(nameof(logger));
 29  ✓  4  ◑          _options = options?.Value ?? throw new ArgumentNullException(nameof(options));
 30  ✔  4             _overpassApiUrl = _options.OverpassApiUrl;
 31  ✔  4         }
 32           
 33               public async Task<IEnumerable<BusinessLocation>> GetNearbyBusinessesAsync(
 34                   double latitude,
 35                   double longitude,
 36                   int radiusMeters,
 37                   IEnumerable<string>? categories = null,
 38                   CancellationToken cancellationToken = default)
 39  ✔  4         {
 40                   // Validate coordinates
 41  ✔  4             ValidateCoordinates(latitude, longitude);
 42           
 43                   try
 44  ✔  2             {
 45                       // Validate and clamp radius
 46  ✔  2                 var validatedRadius = _options.ValidateAndClampRadius(radiusMeters);
 47  ✓  2  ◑              if (validatedRadius != radiusMeters)
 48  ❌ 0                 {
 49  ❌ 0                     _logger.LogWarning(
 50  ❌ 0                         "Requested radius {RequestedRadius}m clamped to {ValidatedRadius}m (min: {Min}m, max: {Max}m)",
 51  ❌ 0                         radiusMeters, validatedRadius, _options.MinRadiusMeters, _options.MaxRadiusMeters);
 52  ❌ 0                 }
 53           
 54  ✔  2                 var query = BuildOverpassQuery(latitude, longitude, validatedRadius, categories, _logger);
 55  ✔  2                 _logger.LogDebug("Querying Overpass API: lat={Lat}, lon={Lon}, radius={Radius}m",
 56  ✔  2                     latitude, longitude, validatedRadius);
 57           
 58  ✔  2                 var content = new StringContent(query);
 59           
 60                       // The HttpClient is configured with resilience policies (retry, circuit breaker, timeout)
 61                       // in LocationServiceCollectionExtensions, so transient failures will be automatically retried
 62  ✔  2                 var response = await _httpClient.PostAsync(_overpassApiUrl, content, cancellationToken)
 63  ✔  2                     .ConfigureAwait(false);
 64           
 65  ✓  2  ◑              if (!response.IsSuccessStatusCode)
 66  ❌ 0                 {
 67  ❌ 0                     _logger.LogWarning(
 68  ❌ 0                         "Overpass API returned status code: {StatusCode} after resilience policies applied",
 69  ❌ 0                         response.StatusCode);
 70  ❌ 0                     return Enumerable.Empty<BusinessLocation>();
 71                       }
 72           
 73  ✔  2                 var json = await response.Content.ReadAsStringAsync(cancellationToken)
 74  ✔  2                     .ConfigureAwait(false);
 75  ✔  2                 var result = JsonSerializer.Deserialize<OverpassResponse>(json);
 76           
 77  ✓  2  ◑              if (result?.Elements == null)
 78  ❌ 0                 {
 79  ❌ 0                     return Enumerable.Empty<BusinessLocation>();
 80                       }
 81           
 82  ✔  2                 var businesses = result.Elements
 83  ✓  2  ◑                  .Where(e => e.Tags != null && !string.IsNullOrEmpty(e.Tags.GetValueOrDefault("name")))
 84  ✓  2  ◔                  .Where(e => (e.Lat.HasValue || e.Center?.Lat != null) && (e.Lon.HasValue || e.Center?.Lon != null)) // F
 85  ✔  2                     .Select(e => ConvertToBusinessLocation(e, latitude, longitude))
 86  ❌ 0                     .OrderBy(b => b.DistanceMeters)
 87  ❌ 0                     .ThenBy(b => b.Name)
 88  ✔  2                     .ToList();
 89           
 90  ✔  2                 _logger.LogInformation("Found {Count} businesses near ({Lat}, {Lon}) within {Radius}m",
 91  ✔  2                     businesses.Count, latitude, longitude, validatedRadius);
 92           
 93  ✔  2                 return businesses;
 94                   }
 95  ❌ 0             catch (HttpRequestException ex)
 96  ❌ 0             {
 97  ❌ 0                 _logger.LogError(ex, "HTTP error fetching nearby businesses from Overpass API");
 98  ❌ 0                 return Enumerable.Empty<BusinessLocation>();
 99                   }
100  ❌ 0             catch (TaskCanceledException ex)
101  ❌ 0             {
102  ❌ 0                 _logger.LogWarning(ex, "Request timeout fetching nearby businesses from Overpass API");
103  ❌ 0                 return Enumerable.Empty<BusinessLocation>();
104                   }
105  ❌ 0             catch (OperationCanceledException)
106  ❌ 0             {
107  ❌ 0                 _logger.LogInformation("Fetching nearby businesses was cancelled");
108  ❌ 0                 return Enumerable.Empty<BusinessLocation>();
109                   }
110  ❌ 0             catch (JsonException ex)
111  ❌ 0             {
112  ❌ 0                 _logger.LogError(ex, "JSON deserialization error fetching nearby businesses from Overpass API");
113  ❌ 0                 return Enumerable.Empty<BusinessLocation>();
114                   }
115  ❌ 0             catch (Exception ex)
116  ❌ 0             {
117  ❌ 0                 _logger.LogError(ex, "Unexpected error fetching nearby businesses from Overpass API");
118  ❌ 0                 return Enumerable.Empty<BusinessLocation>();
119                   }
120  ✔  2         }
121           
122               public async Task<BusinessLocation?> GetClosestBusinessAsync(
123                   double latitude,
124                   double longitude,
125                   int maxDistanceMeters = 1000,
126                   CancellationToken cancellationToken = default)
127  ❌ 0         {
128                   // Validate coordinates
129  ❌ 0             ValidateCoordinates(latitude, longitude);
130           
131  ❌ 0             var businesses = await GetNearbyBusinessesAsync(
132  ❌ 0                 latitude,
133  ❌ 0                 longitude,
134  ❌ 0                 maxDistanceMeters,
135  ❌ 0                 null,
136  ❌ 0                 cancellationToken);
137           
138  ❌ 0             return businesses.FirstOrDefault();
139  ❌ 0         }
140           
141               public async Task<string?> GetAddressAsync(
142                   double latitude,
143                   double longitude,
144                   int maxDistanceMeters = 500,
145                   CancellationToken cancellationToken = default)
146  ❌ 0         {
147                   // Validate coordinates
148  ❌ 0             ValidateCoordinates(latitude, longitude);
149           
150                   try
151  ❌ 0             {
152                       // First try to get address from a nearby business
153  ❌ 0                 var closestBusiness = await GetClosestBusinessAsync(
154  ❌ 0                     latitude,
155  ❌ 0                     longitude,
156  ❌ 0                     maxDistanceMeters,
157  ❌ 0                     cancellationToken);
158           
159  ❌ 0  ○              if (closestBusiness != null && !string.IsNullOrEmpty(closestBusiness.Address))
160  ❌ 0                 {
161  ❌ 0                     return closestBusiness.Address;
162                       }
163           
164                       // If no business found, query for any address data (nodes/ways with address tags)
165  ❌ 0                 var validatedRadius = _options.ValidateAndClampRadius(maxDistanceMeters);
166  ❌ 0                 var query = BuildAddressQuery(latitude, longitude, validatedRadius);
167  ❌ 0                 _logger.LogDebug("Querying Overpass API for address: lat={Lat}, lon={Lon}, radius={Radius}m",
168  ❌ 0                     latitude, longitude, validatedRadius);
169           
170  ❌ 0                 var content = new StringContent(query);
171  ❌ 0                 var response = await _httpClient.PostAsync(_overpassApiUrl, content, cancellationToken)
172  ❌ 0                     .ConfigureAwait(false);
173           
174  ❌ 0  ○              if (!response.IsSuccessStatusCode)
175  ❌ 0                 {
176  ❌ 0                     _logger.LogDebug("Overpass API returned status code: {StatusCode} for address query",
177  ❌ 0                         response.StatusCode);
178  ❌ 0                     return null;
179                       }
180           
181  ❌ 0                 var json = await response.Content.ReadAsStringAsync(cancellationToken)
182  ❌ 0                     .ConfigureAwait(false);
183  ❌ 0                 var result = JsonSerializer.Deserialize<OverpassResponse>(json);
184           
185  ❌ 0  ○              if (result?.Elements == null || !result.Elements.Any())
186  ❌ 0                 {
187  ❌ 0                     return null;
188                       }
189           
190                       // Find the closest element with address data
191  ❌ 0                 var addressElements = result.Elements
192  ❌ 0  ○                  .Where(e => e.Tags != null && HasAddressTags(e.Tags))
193  ❌ 0  ○                  .Where(e => (e.Lat.HasValue || e.Center?.Lat != null) && (e.Lon.HasValue || e.Center?.Lon != null))
194  ❌ 0  ○                  .Select(e => new
195  ❌ 0                     {
196  ❌ 0                         Element = e,
197  ❌ 0                         Distance = CalculateDistance(
198  ❌ 0                             latitude,
199  ❌ 0                             longitude,
200  ❌ 0                             e.Lat ?? e.Center?.Lat ?? 0,
201  ❌ 0                             e.Lon ?? e.Center?.Lon ?? 0)
202  ❌ 0                     })
203  ❌ 0                     .OrderBy(x => x.Distance)
204  ❌ 0                     .ToList();
205           
206  ❌ 0                 var closestElement = addressElements.FirstOrDefault();
207  ❌ 0  ○              if (closestElement != null)
208  ❌ 0                 {
209  ❌ 0                     var address = BuildAddressFromTags(closestElement.Element.Tags!);
210  ❌ 0  ○                  if (!string.IsNullOrEmpty(address))
211  ❌ 0                     {
212  ❌ 0                         _logger.LogDebug("Found address: {Address} at distance {Distance}m", address, closestElement.Distanc
213  ❌ 0                         return address;
214                           }
215  ❌ 0                 }
216           
217  ❌ 0                 return null;
218                   }
219  ❌ 0             catch (HttpRequestException ex)
220  ❌ 0             {
221  ❌ 0                 _logger.LogError(ex, "HTTP error fetching address from Overpass API");
222  ❌ 0                 return null;
223                   }
224  ❌ 0             catch (TaskCanceledException ex)
225  ❌ 0             {
226  ❌ 0                 _logger.LogWarning(ex, "Request timeout fetching address from Overpass API");
227  ❌ 0                 return null;
228                   }
229  ❌ 0             catch (OperationCanceledException)
230  ❌ 0             {
231  ❌ 0                 _logger.LogInformation("Fetching address was cancelled");
232  ❌ 0                 return null;
233                   }
234  ❌ 0             catch (JsonException ex)
235  ❌ 0             {
236  ❌ 0                 _logger.LogError(ex, "JSON deserialization error fetching address from Overpass API");
237  ❌ 0                 return null;
238                   }
239  ❌ 0             catch (Exception ex)
240  ❌ 0             {
241  ❌ 0                 _logger.LogError(ex, "Unexpected error fetching address from Overpass API");
242  ❌ 0                 return null;
243                   }
244  ❌ 0         }
245           
246               private static void ValidateCoordinates(double latitude, double longitude)
247  ✔  4         {
248  ✓  4  ◑          if (latitude < -90 || latitude > 90)
249  ✔  1             {
250  ✔  1                 throw new ArgumentOutOfRangeException(
251  ✔  1                     nameof(latitude),
252  ✔  1                     latitude,
253  ✔  1                     "Latitude must be between -90 and 90 degrees");
254                   }
255           
256  ✓  3  ◑          if (longitude < -180 || longitude > 180)
257  ✔  1             {
258  ✔  1                 throw new ArgumentOutOfRangeException(
259  ✔  1                     nameof(longitude),
260  ✔  1                     longitude,
261  ✔  1                     "Longitude must be between -180 and 180 degrees");
262                   }
263  ✔  2         }
264           
265               private static string BuildOverpassQuery(
266                   double latitude,
267                   double longitude,
268                   int radiusMeters,
269                   IEnumerable<string>? categories,
270                   ILogger<OverpassLocationService>? logger = null)
271  ✔  2         {
272  ✓  2  ◑          var categoryFilters = categories?.ToList() ?? new List<string>();
273           
274                   // Build Overpass QL query
275  ✔  2             var filters = new List<string>();
276           
277  ✓  2  ◑          if (categoryFilters.Any())
278  ❌ 0             {
279  ❌ 0  ○              foreach (var category in categoryFilters)
280  ❌ 0                 {
281                           // Sanitize category to prevent injection: only allow alphanumeric, hyphens, underscores, and colons
282                           // (colons are used in OSM tag keys like "addr:street")
283  ❌ 0                     var sanitizedCategory = SanitizeCategory(category);
284  ❌ 0  ○                  if (string.IsNullOrEmpty(sanitizedCategory))
285  ❌ 0                     {
286  ❌ 0  ○                      logger?.LogWarning("Invalid category '{Category}' filtered out due to unsafe characters", category);
287  ❌ 0                         continue;
288                           }
289           
290  ❌ 0                     filters.Add($"node[\"amenity\"=\"{sanitizedCategory}\"](around:{radiusMeters},{latitude},{longitude});")
291  ❌ 0                     filters.Add($"way[\"amenity\"=\"{sanitizedCategory}\"](around:{radiusMeters},{latitude},{longitude});");
292  ❌ 0                     filters.Add($"node[\"shop\"=\"{sanitizedCategory}\"](around:{radiusMeters},{latitude},{longitude});");
293  ❌ 0                     filters.Add($"way[\"shop\"=\"{sanitizedCategory}\"](around:{radiusMeters},{latitude},{longitude});");
294  ❌ 0                 }
295  ❌ 0             }
296                   else
297  ✔  2             {
298  ✔  2                 filters.Add($"node[\"amenity\"](around:{radiusMeters},{latitude},{longitude});");
299  ✔  2                 filters.Add($"way[\"amenity\"](around:{radiusMeters},{latitude},{longitude});");
300  ✔  2                 filters.Add($"node[\"shop\"](around:{radiusMeters},{latitude},{longitude});");
301  ✔  2                 filters.Add($"way[\"shop\"](around:{radiusMeters},{latitude},{longitude});");
302  ✔  2                 filters.Add($"node[\"tourism\"](around:{radiusMeters},{latitude},{longitude});");
303  ✔  2                 filters.Add($"way[\"tourism\"](around:{radiusMeters},{latitude},{longitude});");
304  ✔  2             }
305           
306  ✔  2             var query = $@"
307  ✔  2     [out:json][timeout:25];
308  ✔  2     (
309  ✔  2       {string.Join("\n  ", filters)}
310  ✔  2     );
311  ✔  2     out center;
312  ✔  2     ";
313           
314  ✔  2             return query;
315  ✔  2         }
316           
317               /// <summary>
318               /// Sanitizes a category string to prevent injection attacks in Overpass queries.
319               /// Only allows alphanumeric characters, hyphens, underscores, and colons.
320               /// </summary>
321               /// <param name="category">The category string to sanitize</param>
322               /// <returns>Sanitized category string, or empty string if invalid</returns>
323               private static string SanitizeCategory(string category)
324  ❌ 0         {
325  ❌ 0  ○          if (string.IsNullOrWhiteSpace(category))
326  ❌ 0                 return string.Empty;
327           
328                   // Only allow alphanumeric, hyphens, underscores, and colons (for OSM tag keys like "addr:street")
329                   // This prevents injection of Overpass QL syntax like quotes, brackets, semicolons, etc.
330  ❌ 0             var sanitized = new System.Text.StringBuilder(category.Length);
331  ❌ 0  ○          foreach (var c in category)
332  ❌ 0             {
333  ❌ 0  ○              if (char.IsLetterOrDigit(c) || c == '-' || c == '_' || c == ':')
334  ❌ 0                 {
335  ❌ 0                     sanitized.Append(c);
336  ❌ 0                 }
337  ❌ 0             }
338           
339  ❌ 0             var result = sanitized.ToString();
340                   // Additional validation: ensure it's not empty and doesn't start/end with colon
341  ❌ 0  ○          if (string.IsNullOrEmpty(result) || result.StartsWith(':') || result.EndsWith(':'))
342  ❌ 0             {
343  ❌ 0                 return string.Empty;
344                   }
345           
346  ❌ 0             return result;
347  ❌ 0         }
348           
349               private static string BuildAddressQuery(
350                   double latitude,
351                   double longitude,
352                   int radiusMeters)
353  ❌ 0         {
354                   // Query for any nodes/ways with address tags
355  ❌ 0             var query = $@"
356  ❌ 0     [out:json][timeout:25];
357  ❌ 0     (
358  ❌ 0       node[""addr:street""](around:{radiusMeters},{latitude},{longitude});
359  ❌ 0       way[""addr:street""](around:{radiusMeters},{latitude},{longitude});
360  ❌ 0       node[""addr:housenumber""](around:{radiusMeters},{latitude},{longitude});
361  ❌ 0       way[""addr:housenumber""](around:{radiusMeters},{latitude},{longitude});
362  ❌ 0     );
363  ❌ 0     out center;
364  ❌ 0     ";
365           
366  ❌ 0             return query;
367  ❌ 0         }
368           
369               private static bool HasAddressTags(Dictionary<string, string> tags)
370  ❌ 0         {
371  ❌ 0  ○          return tags.ContainsKey("addr:street") ||
372  ❌ 0                    tags.ContainsKey("addr:housenumber") ||
373  ❌ 0                    tags.ContainsKey("addr:city") ||
374  ❌ 0                    tags.ContainsKey("addr:postcode");
375  ❌ 0         }
376           
377               private static string? BuildAddressFromTags(Dictionary<string, string> tags)
378  ❌ 0         {
379  ❌ 0             var addressParts = new List<string>();
380  ❌ 0  ○          if (tags.TryGetValue("addr:housenumber", out var houseNumber))
381  ❌ 0                 addressParts.Add(houseNumber);
382  ❌ 0  ○          if (tags.TryGetValue("addr:street", out var street))
383  ❌ 0                 addressParts.Add(street);
384  ❌ 0  ○          if (tags.TryGetValue("addr:city", out var city))
385  ❌ 0                 addressParts.Add(city);
386  ❌ 0  ○          if (tags.TryGetValue("addr:postcode", out var postcode))
387  ❌ 0                 addressParts.Add(postcode);
388           
389  ❌ 0  ○          return addressParts.Any() ? string.Join(", ", addressParts) : null;
390  ❌ 0         }
391           
392               private static BusinessLocation ConvertToBusinessLocation(
393                   OverpassElement element,
394                   double searchLat,
395                   double searchLon)
396  ✔  2         {
397  ✓  2  ◑          var tags = element.Tags ?? new Dictionary<string, string>();
398  ✔  2             var name = tags.GetValueOrDefault("name", "Unnamed Location");
399           
400                   // Build address
401  ✔  2             var addressParts = new List<string>();
402  ✓  2  ◑          if (tags.TryGetValue("addr:housenumber", out var houseNumber))
403  ❌ 0                 addressParts.Add(houseNumber);
404  ✔  2  ●          if (tags.TryGetValue("addr:street", out var street))
405  ✔  1                 addressParts.Add(street);
406  ✔  2  ●          if (tags.TryGetValue("addr:city", out var city))
407  ✔  1                 addressParts.Add(city);
408  ✓  2  ◑          if (tags.TryGetValue("addr:postcode", out var postcode))
409  ❌ 0                 addressParts.Add(postcode);
410           
411  ✔  2  ●          var address = addressParts.Any() ? string.Join(", ", addressParts) : null;
412           
413                   // Determine category
414  ✓  2  ◑          var category = tags.GetValueOrDefault("amenity")
415  ✔  2                         ?? tags.GetValueOrDefault("shop")
416  ✔  2                         ?? tags.GetValueOrDefault("tourism")
417  ✔  2                         ?? "unknown";
418           
419                   // Get coordinates
420  ✓  2  ○          var lat = element.Lat ?? element.Center?.Lat ?? 0;
421  ✓  2  ○          var lon = element.Lon ?? element.Center?.Lon ?? 0;
422           
423                   // Calculate distance
424  ✔  2             var distance = CalculateDistance(searchLat, searchLon, lat, lon);
425           
426  ✔  2             return new BusinessLocation
427  ✔  2             {
428  ✔  2                 Name = name,
429  ✔  2                 Address = address,
430  ✔  2                 Latitude = lat,
431  ✔  2                 Longitude = lon,
432  ✔  2                 Category = category,
433  ✔  2                 Tags = tags,
434  ✔  2                 DistanceMeters = distance
435  ✔  2             };
436  ✔  2         }
437           
438               private static double CalculateDistance(double lat1, double lon1, double lat2, double lon2)
439  ✔  2         {
440                   // Haversine formula
441                   const double earthRadiusMeters = 6371000;
442           
443  ✔  2             var dLat = DegreesToRadians(lat2 - lat1);
444  ✔  2             var dLon = DegreesToRadians(lon2 - lon1);
445           
446  ✔  2             var a = Math.Sin(dLat / 2) * Math.Sin(dLat / 2) +
447  ✔  2                     Math.Cos(DegreesToRadians(lat1)) * Math.Cos(DegreesToRadians(lat2)) *
448  ✔  2                     Math.Sin(dLon / 2) * Math.Sin(dLon / 2);
449           
450  ✔  2             var c = 2 * Math.Atan2(Math.Sqrt(a), Math.Sqrt(1 - a));
451           
452  ✔  2             return earthRadiusMeters * c;
453  ✔  2         }
454           
455               private static double DegreesToRadians(double degrees)
456  ✔  8         {
457  ✔  8             return degrees * Math.PI / 180;
458  ✔  8         }
459           
460               #region Overpass API Response Models
461           
462               private class OverpassResponse
463               {
464                   [JsonPropertyName("elements")]
465  ✔  6             public List<OverpassElement>? Elements { get; set; }
466               }
467           
468               private class OverpassElement
469               {
470                   [JsonPropertyName("type")]
471  ✔  2             public string? Type { get; set; }
472           
473                   [JsonPropertyName("id")]
474  ✔  2             public long Id { get; set; }
475           
476                   [JsonPropertyName("lat")]
477  ✔  6             public double? Lat { get; set; }
478           
479                   [JsonPropertyName("lon")]
480  ✔  6             public double? Lon { get; set; }
481           
482                   [JsonPropertyName("center")]
483  ❌ 0             public OverpassCenter? Center { get; set; }
484           
485                   [JsonPropertyName("tags")]
486  ✔  8             public Dictionary<string, string>? Tags { get; set; }
487               }
488           
489               private class OverpassCenter
490               {
491                   [JsonPropertyName("lat")]
492  ❌ 0             public double Lat { get; set; }
493           
494                   [JsonPropertyName("lon")]
495  ❌ 0             public double Lon { get; set; }
496               }
497           
498               #endregion
499           }
```
# FWH.Common.Location.Services.RateLimitedLocationService

## Summary

|||
|:---|:---|
| Class: | FWH.Common.Location.Services.RateLimitedLocationService |
| Assembly: | FWH.Common.Location |
| **File(s):** | E:\github\FunWasHad\src\FWH.Common.Location\Services\RateLimitedLocationService.cs |
| **Line coverage:** | 0% (0 of 61) |
| Covered lines: | 0 |
| Uncovered lines: | 61 |
| Coverable lines: | 61 |
| Total lines: | 127 |
| **Branch coverage:** | 0% (0 of 12) |
| Covered branches: | 0 |
| Total branches: | 12 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **.ctor(...)** | 0% | 20 | 4 | 0% |
| **GetNearbyBusinessesAsync()** | 100% | 2 | 1 | 0% |
| **GetClosestBusinessAsync()** | 100% | 2 | 1 | 0% |
| **GetAddressAsync()** | 100% | 2 | 1 | 0% |
| **ValidateCoordinates(...)** | 0% | 72 | 8 | 0% |

## File(s)

### E:\github\FunWasHad\src\FWH.Common.Location\Services\RateLimitedLocationService.cs
```
  1           using Microsoft.Extensions.Logging;
  2           using FWH.Common.Location.Models;
  3           using FWH.Common.Location.RateLimiting;
  4           using System;
  5           using System.Collections.Generic;
  6           using System.Threading;
  7           using System.Threading.Tasks;
  8           
  9           namespace FWH.Common.Location.Services;
 10           
 11           /// <summary>
 12           /// Decorator for ILocationService that adds rate limiting.
 13           /// Protects external APIs from excessive requests.
 14           /// </summary>
 15           public class RateLimitedLocationService : ILocationService
 16           {
 17               private readonly ILocationService _innerService;
 18               private readonly TokenBucketRateLimiter _rateLimiter;
 19               private readonly ILogger<RateLimitedLocationService> _logger;
 20           
 21               /// <summary>
 22               /// Creates a rate-limited location service.
 23               /// Default: 10 requests per minute (respects Overpass API fair use policy).
 24               /// </summary>
 25  ❌ 0         public RateLimitedLocationService(
 26  ❌ 0             ILocationService innerService,
 27  ❌ 0             ILogger<RateLimitedLocationService> logger,
 28  ❌ 0             int maxRequestsPerMinute = 10)
 29  ❌ 0         {
 30  ❌ 0  ○          _innerService = innerService ?? throw new ArgumentNullException(nameof(innerService));
 31  ❌ 0  ○          _logger = logger ?? throw new ArgumentNullException(nameof(logger));
 32           
 33                   // Token bucket: maxRequestsPerMinute tokens, refill 1 token every (60/max) seconds
 34  ❌ 0             var refillInterval = TimeSpan.FromSeconds(60.0 / maxRequestsPerMinute);
 35  ❌ 0             _rateLimiter = new TokenBucketRateLimiter(maxRequestsPerMinute, refillInterval);
 36  ❌ 0         }
 37           
 38               public async Task<IEnumerable<BusinessLocation>> GetNearbyBusinessesAsync(
 39                   double latitude,
 40                   double longitude,
 41                   int radiusMeters,
 42                   IEnumerable<string>? categories = null,
 43                   CancellationToken cancellationToken = default)
 44  ❌ 0         {
 45                   // Validate coordinates
 46  ❌ 0             ValidateCoordinates(latitude, longitude);
 47           
 48  ❌ 0             var availableTokens = _rateLimiter.AvailableTokens;
 49  ❌ 0             _logger.LogDebug("Rate limiter status: {AvailableTokens} tokens available", availableTokens);
 50           
 51                   // Wait for rate limit
 52  ❌ 0             await _rateLimiter.WaitAsync(cancellationToken);
 53           
 54  ❌ 0             _logger.LogDebug("Rate limit passed, executing GetNearbyBusinessesAsync");
 55  ❌ 0             return await _innerService.GetNearbyBusinessesAsync(
 56  ❌ 0                 latitude,
 57  ❌ 0                 longitude,
 58  ❌ 0                 radiusMeters,
 59  ❌ 0                 categories,
 60  ❌ 0                 cancellationToken);
 61  ❌ 0         }
 62           
 63               public async Task<BusinessLocation?> GetClosestBusinessAsync(
 64                   double latitude,
 65                   double longitude,
 66                   int maxDistanceMeters = 1000,
 67                   CancellationToken cancellationToken = default)
 68  ❌ 0         {
 69                   // Validate coordinates
 70  ❌ 0             ValidateCoordinates(latitude, longitude);
 71           
 72  ❌ 0             var availableTokens = _rateLimiter.AvailableTokens;
 73  ❌ 0             _logger.LogDebug("Rate limiter status: {AvailableTokens} tokens available", availableTokens);
 74           
 75                   // Wait for rate limit
 76  ❌ 0             await _rateLimiter.WaitAsync(cancellationToken);
 77           
 78  ❌ 0             _logger.LogDebug("Rate limit passed, executing GetClosestBusinessAsync");
 79  ❌ 0             return await _innerService.GetClosestBusinessAsync(
 80  ❌ 0                 latitude,
 81  ❌ 0                 longitude,
 82  ❌ 0                 maxDistanceMeters,
 83  ❌ 0                 cancellationToken);
 84  ❌ 0         }
 85           
 86               public async Task<string?> GetAddressAsync(
 87                   double latitude,
 88                   double longitude,
 89                   int maxDistanceMeters = 500,
 90                   CancellationToken cancellationToken = default)
 91  ❌ 0         {
 92                   // Validate coordinates
 93  ❌ 0             ValidateCoordinates(latitude, longitude);
 94           
 95  ❌ 0             var availableTokens = _rateLimiter.AvailableTokens;
 96  ❌ 0             _logger.LogDebug("Rate limiter status: {AvailableTokens} tokens available for address lookup", availableTokens);
 97           
 98                   // Wait for rate limit
 99  ❌ 0             await _rateLimiter.WaitAsync(cancellationToken);
100           
101  ❌ 0             _logger.LogDebug("Rate limit passed, executing GetAddressAsync");
102  ❌ 0             return await _innerService.GetAddressAsync(
103  ❌ 0                 latitude,
104  ❌ 0                 longitude,
105  ❌ 0                 maxDistanceMeters,
106  ❌ 0                 cancellationToken);
107  ❌ 0         }
108           
109               private static void ValidateCoordinates(double latitude, double longitude)
110  ❌ 0         {
111  ❌ 0  ○          if (latitude < -90 || latitude > 90)
112  ❌ 0             {
113  ❌ 0                 throw new ArgumentOutOfRangeException(
114  ❌ 0                     nameof(latitude),
115  ❌ 0                     latitude,
116  ❌ 0                     "Latitude must be between -90 and 90 degrees");
117                   }
118           
119  ❌ 0  ○          if (longitude < -180 || longitude > 180)
120  ❌ 0             {
121  ❌ 0                 throw new ArgumentOutOfRangeException(
122  ❌ 0                     nameof(longitude),
123  ❌ 0                     longitude,
124  ❌ 0                     "Longitude must be between -180 and 180 degrees");
125                   }
126  ❌ 0         }
127           }
```
# FWH.Common.Workflow.Actions.ActionHandlerContext

## Summary

|||
|:---|:---|
| Class: | FWH.Common.Workflow.Actions.ActionHandlerContext |
| Assembly: | FWH.Common.Workflow |
| **File(s):** | E:\github\FunWasHad\src\FWH.Common.Workflow\Actions\ActionHandlerContext.cs |
| **Line coverage:** | 72.7% (8 of 11) |
| Covered lines: | 8 |
| Uncovered lines: | 3 |
| Coverable lines: | 11 |
| Total lines: | 21 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **get_WorkflowId()** | 100% | 1 | 1 | 100% |
| **get_Node()** | 100% | 2 | 1 | 0% |
| **get_Definition()** | 100% | 2 | 1 | 0% |
| **get_InstanceManager()** | 100% | 2 | 1 | 0% |
| **.ctor(...)** | 100% | 1 | 1 | 100% |

## File(s)

### E:\github\FunWasHad\src\FWH.Common.Workflow\Actions\ActionHandlerContext.cs
```
 1            using System.Threading;
 2            using FWH.Common.Workflow.Models;
 3            using FWH.Common.Workflow.Instance;
 4            
 5            namespace FWH.Common.Workflow.Actions;
 6            
 7            public class ActionHandlerContext
 8            {
 9  ✔   4         public string WorkflowId { get; }
10  ❌  0         public WorkflowNode Node { get; }
11  ❌  0         public WorkflowDefinition Definition { get; }
12  ❌  0         public IWorkflowInstanceManager InstanceManager { get; }
13            
14  ✔  51         public ActionHandlerContext(string workflowId, WorkflowNode node, WorkflowDefinition definition, IWorkflowInstanceMa
15  ✔  51         {
16  ✔  51             WorkflowId = workflowId;
17  ✔  51             Node = node;
18  ✔  51             Definition = definition;
19  ✔  51             InstanceManager = instanceManager;
20  ✔  51         }
21            }
```
# FWH.Common.Workflow.Actions.WorkflowActionExecutor

## Summary

|||
|:---|:---|
| Class: | FWH.Common.Workflow.Actions.WorkflowActionExecutor |
| Assembly: | FWH.Common.Workflow |
| **File(s):** | E:\github\FunWasHad\src\FWH.Common.Workflow\Actions\WorkflowActionExecutor.cs |
| **Line coverage:** | 38.3% (92 of 240) |
| Covered lines: | 92 |
| Uncovered lines: | 148 |
| Coverable lines: | 240 |
| Total lines: | 368 |
| **Branch coverage:** | 45.7% (54 of 118) |
| Covered branches: | 54 |
| Total branches: | 118 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **.ctor(...)** | 58.33% | 12 | 12 | 100% |
| **ExecuteAsync()** | 66.07% | 235 | 56 | 61.53% |
| **ExecuteHandlerAsync()** | 0% | 1482 | 38 | 0% |
| **ResolveTemplates(...)** | 66.66% | 12 | 12 | 94.11% |

## File(s)

### E:\github\FunWasHad\src\FWH.Common.Workflow\Actions\WorkflowActionExecutor.cs
```
  1             using System;
  2             using System.Collections.Generic;
  3             using System.Text.RegularExpressions;
  4             using System.Text.Json;
  5             using System.Threading;
  6             using System.Threading.Tasks;
  7             using Microsoft.Extensions.Logging;
  8             using Microsoft.Extensions.DependencyInjection;
  9             using FWH.Common.Workflow.Models;
 10             using FWH.Common.Workflow.Instance;
 11             using System.Diagnostics;
 12             using Microsoft.Extensions.Options;
 13             using System.Collections.Concurrent;
 14             using System.Linq;
 15             using FWH.Orchestrix.Contracts.Mediator;
 16             
 17             namespace FWH.Common.Workflow.Actions;
 18             
 19             /// <summary>
 20             /// Basic workflow action executor.
 21             /// - Parses JSON action definitions from node.NoteMarkdown
 22             /// - Replaces template parameters using instance manager variables
 23             /// - Dispatches to registered typed handlers resolved from a registry.
 24             /// Handlers may return variable updates which will be applied to the instance manager.
 25             /// </summary>
 26             public class WorkflowActionExecutor : IWorkflowActionExecutor
 27             {
 28                 private readonly ILogger<WorkflowActionExecutor> _logger;
 29                 private readonly IServiceProvider _serviceProvider;
 30                 private readonly IWorkflowActionHandlerRegistry _registry;
 31                 private readonly IMediatorSender? _mediator;
 32                 private readonly WorkflowActionExecutorOptions _options;
 33             
 34                 //public WorkflowActionExecutor(IServiceProvider serviceProvider, IWorkflowActionHandlerRegistry registry, IOptions<
 35                 //{
 36                 //    _serviceProvider = serviceProvider ?? throw new ArgumentNullException(nameof(serviceProvider));
 37                 //    _registry = registry ?? throw new ArgumentNullException(nameof(registry));
 38                 //    _mediator = null;
 39                 //    _logger = logger ?? Microsoft.Extensions.Logging.Abstractions.NullLogger<WorkflowActionExecutor>.Instance;
 40                 //    _options = options?.Value ?? new WorkflowActionExecutorOptions();
 41             
 42                 //    // Eagerly trigger registrar if available so handlers registered as singletons get wired when DI builds
 43                 //    var registrar = _serviceProvider.GetService<WorkflowActionHandlerRegistrar>();
 44                 //    // registrar's constructor performs registration
 45                 //}
 46             
 47  ✔   58         public WorkflowActionExecutor(IServiceProvider serviceProvider,
 48  ✔   58                                       IMediatorSender mediator,
 49  ✔   58                                       IOptions<WorkflowActionExecutorOptions>? options = null,
 50  ✔   58                                       ILogger<WorkflowActionExecutor>? logger = null)
 51  ✔   58         {
 52  ✓   58  ◑          _serviceProvider = serviceProvider ?? throw new ArgumentNullException(nameof(serviceProvider));
 53  ✓   58  ◑          _mediator = mediator ?? throw new ArgumentNullException(nameof(mediator));
 54  ✓   58  ◑          _registry = _serviceProvider.GetService<IWorkflowActionHandlerRegistry>() ?? new WorkflowActionHandlerRegistry()
 55  ✔   58  ●          _logger = logger ?? Microsoft.Extensions.Logging.Abstractions.NullLogger<WorkflowActionExecutor>.Instance;
 56  ✓   58  ◑          _options = options?.Value ?? new WorkflowActionExecutorOptions();
 57  ✔   58         }
 58             
 59                 public async Task<bool> ExecuteAsync(string workflowId, WorkflowNode node, WorkflowDefinition definition, Cancellati
 60  ✔  270         {
 61  ✓  270  ◑          if (node == null) return false;
 62             
 63                     // NoteMarkdown is primary; fall back to JsonMetadata (some PlantUML notes may have been parsed into JsonMetadat
 64  ✔  270  ●          var note = node.NoteMarkdown?.Trim();
 65  ✔  270  ●          if (string.IsNullOrWhiteSpace(note) && !string.IsNullOrWhiteSpace(node.JsonMetadata))
 66  ✔    9             {
 67  ✔    9                 note = node.JsonMetadata.Trim();
 68  ✔    9             }
 69  ✔  270  ●          if (string.IsNullOrWhiteSpace(note))
 70  ✔  196                 return false;
 71             
 72                     // Detect JSON action
 73  ✔   74  ●          if (!note.StartsWith('{') || !note.EndsWith('}'))
 74  ✔    9                 return false;
 75             
 76                     JsonDocument doc;
 77                     try
 78  ✔   65             {
 79  ✔   65                 doc = JsonDocument.Parse(note);
 80  ✔   65             }
 81  ❌   0             catch (JsonException ex)
 82  ❌   0             {
 83  ❌   0                 _logger.LogWarning(ex, "Invalid JSON action on node {NodeId}", node.Id);
 84  ❌   0                 return false;
 85                     }
 86             
 87  ✓   65  ◑          if (doc.RootElement.ValueKind != JsonValueKind.Object)
 88  ❌   0                 return false;
 89             
 90  ✓   65  ◑          if (!doc.RootElement.TryGetProperty("action", out var actionProp))
 91  ❌   0                 return false;
 92             
 93  ✔   65             var actionName = actionProp.GetString();
 94  ✓   65  ◑          if (string.IsNullOrWhiteSpace(actionName))
 95  ❌   0                 return false;
 96             
 97                     // Resolve params object (if present)
 98  ✔   65             IDictionary<string, string> parameters = new ConcurrentDictionary<string, string>(StringComparer.OrdinalIgnoreCa
 99  ✔   65  ●          if (doc.RootElement.TryGetProperty("params", out var paramsProp) && paramsProp.ValueKind == JsonValueKind.Object
100  ✔   63             {
101  ✔  225  ●              foreach (var prop in paramsProp.EnumerateObject())
102  ✔   18                 {
103  ✓   18  ◑                  parameters[prop.Name] = prop.Value.GetString() ?? string.Empty;
104  ✔   18                 }
105  ✔   63             }
106             
107                     // Resolve templates in parameters using instance variables if available
108  ✔   65             var rootInstanceManager = _serviceProvider.GetService<IWorkflowInstanceManager>();
109  ✔   65             IDictionary<string, string>? variables = null;
110  ✔   65  ●          if (rootInstanceManager != null)
111  ✔   65             {
112  ✓   65  ◑              variables = rootInstanceManager.GetVariables(workflowId) ?? new ConcurrentDictionary<string,string>(StringCo
113  ✔   65             }
114             
115  ✔   65             var resolved = ResolveTemplates(parameters, variables);
116             
117  ✓   65  ◑          if (_mediator != null)
118  ✔   65             {
119                         try
120  ✔   65                 {
121  ✔   65                     var sw = System.Diagnostics.Stopwatch.StartNew();
122  ✔   65                     var response = await _mediator.SendAsync(new WorkflowActionRequest
123  ✔   65                     {
124  ✔   65                         WorkflowId = workflowId,
125  ✔   65                         Node = node,
126  ✔   65                         Definition = definition,
127  ✔   65                         ActionName = actionName,
128  ✔   65                         Parameters = resolved,
129  ✔   65                         CreateScopeForHandlers = _options.CreateScopeForHandlers,
130  ✔   65                         LogExecutionTime = _options.LogExecutionTime
131  ✔   65                     }, cancellationToken).ConfigureAwait(false);
132             
133  ✔   63                     sw.Stop();
134  ✔   63  ●                  if (_options.LogExecutionTime)
135  ✔   58                     {
136  ✔   58                         _logger.LogInformation("Action {ActionName} handled by mediator in {ElapsedMs}ms", actionName, sw.El
137  ✔   58                     }
138             
139  ✔   63  ●                  if (!response.Success || rootInstanceManager == null)
140  ✔   15                     {
141  ✔   15                         return false;
142                             }
143             
144                             // Check for error status if VariableUpdates exists
145  ✔   48  ●                  if (response.VariableUpdates != null)
146  ✔   44                     {
147  ✓   44  ◑                      if (response.VariableUpdates.TryGetValue("status", out var status) && status.Equals("error", StringC
148  ❌   0                         {
149  ❌   0                             return false;
150                                 }
151             
152                                 // Apply variable updates
153  ✔  200  ●                      foreach (var update in response.VariableUpdates)
154  ✔   34                         {
155  ✔   34                             rootInstanceManager.SetVariable(workflowId, update.Key, update.Value);
156  ✔   34                         }
157  ✔   44                     }
158             
159  ✔   48                     return true;
160                         }
161  ❌   0                 catch (OperationCanceledException)
162  ❌   0                 {
163  ❌   0                     return false;
164                         }
165  ❌   0                 catch (Exception ex)
166  ❌   0                 {
167  ❌   0                     _logger.LogError(ex, "Action {ActionName} execution failed via mediator", actionName);
168                             // Return false but don't throw - allows workflow to continue
169  ❌   0                     return false;
170                         }
171                     }
172             
173                     // Prefer any singleton handlers registered directly in DI (common for delegate adapters)
174  ❌   0             var directHandlersList = _serviceProvider.GetServices<IWorkflowActionHandler>();
175  ❌   0             var directHandler = directHandlersList.FirstOrDefault(h => string.Equals(h.Name, actionName, StringComparison.Or
176  ❌   0             Func<IServiceProvider, IWorkflowActionHandler> factory = null!;
177  ❌   0  ○          if (directHandler != null)
178  ❌   0             {
179  ❌   0                 _logger.LogDebug("Using direct singleton handler for action {ActionName}", actionName);
180  ❌   0                 factory = _ => directHandler;
181  ❌   0             }
182  ❌   0  ○          else if (_registry.TryGetFactory(actionName ?? string.Empty, out var regFactory))
183  ❌   0             {
184  ❌   0                 factory = regFactory!;
185  ❌   0             }
186                     else
187  ❌   0             {
188  ❌   0                 _logger.LogWarning("No handler registered for action {ActionName}", actionName);
189  ❌   0                 return false;
190                     }
191             
192                     // Execution delegate shared by sync and background paths
193                     async Task ExecuteHandlerAsync(Func<IServiceProvider, IWorkflowActionHandler> factoryFunc)
194  ❌   0             {
195                         try
196  ❌   0                 {
197  ❌   0  ○                  if (_options.CreateScopeForHandlers)
198  ❌   0                     {
199  ❌   0                         using var scope = _serviceProvider.CreateScope();
200  ❌   0                         var handler = factoryFunc(scope.ServiceProvider);
201  ❌   0  ○                      _logger.LogDebug("Factory produced handler instance {Handler} for action {ActionName}", handler?.Nam
202             
203                                 // Fallback: if factory returns null, try resolving singleton handlers from the scoped provider
204  ❌   0  ○                      if (handler == null)
205  ❌   0                         {
206  ❌   0                             var direct = scope.ServiceProvider.GetServices<IWorkflowActionHandler>().FirstOrDefault(h => str
207  ❌   0  ○                          if (direct != null)
208  ❌   0                             {
209  ❌   0                                 handler = direct;
210  ❌   0                             }
211  ❌   0                         }
212             
213  ❌   0  ○                      if (handler == null)
214  ❌   0                         {
215  ❌   0                             _logger.LogWarning("Handler factory returned null for action {ActionName}", actionName);
216  ❌   0                             return;
217                                 }
218             
219  ❌   0  ○                      var scopedInstanceManager = scope.ServiceProvider.GetService<IWorkflowInstanceManager>() ?? throw ne
220  ❌   0                         var ctx = new ActionHandlerContext(workflowId, node, definition, scopedInstanceManager);
221             
222  ❌   0                         var sw = Stopwatch.StartNew();
223  ❌   0                         IDictionary<string,string>? updates = null;
224                                 try
225  ❌   0                         {
226  ❌   0                             _logger.LogDebug("Invoking handler {HandlerName} for workflow {WorkflowId} node {NodeId}", handl
227  ❌   0                             updates = await handler.HandleAsync(ctx, resolved, cancellationToken).ConfigureAwait(false);
228  ❌   0                         }
229  ❌   0                         catch (OperationCanceledException)
230  ❌   0                         {
231  ❌   0                             _logger.LogDebug("Action {ActionName} execution cancelled", actionName);
232  ❌   0                             throw; // Re-throw to be caught by outer try-catch
233                                 }
234             
235  ❌   0                         sw.Stop();
236  ❌   0  ○                      if (_options.LogExecutionTime)
237  ❌   0                         {
238  ❌   0  ○                          _logger.LogInformation("Action {ActionName} handled by {HandlerName} in {ElapsedMs}ms", actionNa
239  ❌   0                         }
240             
241  ❌   0  ○                      if (updates != null)
242  ❌   0                         {
243  ❌   0  ○                          foreach (var kv in updates)
244  ❌   0                             {
245                                         try
246  ❌   0                                 {
247  ❌   0                                     scopedInstanceManager.SetVariable(workflowId, kv.Key, kv.Value);
248  ❌   0                                 }
249  ❌   0                                 catch (Exception ex)
250  ❌   0                                 {
251  ❌   0                                     _logger.LogWarning(ex, "Failed to set variable {Key} from handler {ActionName}", kv.Key,
252  ❌   0                                 }
253  ❌   0                             }
254  ❌   0                         }
255  ❌   0                     }
256                             else
257  ❌   0                     {
258  ❌   0                         var handler = factoryFunc(_serviceProvider);
259  ❌   0  ○                      _logger.LogDebug("Factory produced handler instance {Handler} for action {ActionName}", handler?.Nam
260             
261                                 // Fallback: if factory returns null, try resolving singleton handlers from the provider
262  ❌   0  ○                      if (handler == null)
263  ❌   0                         {
264  ❌   0                             var direct = _serviceProvider.GetServices<IWorkflowActionHandler>().FirstOrDefault(h => string.E
265  ❌   0  ○                          if (direct != null)
266  ❌   0                             {
267  ❌   0                                 handler = direct;
268  ❌   0                             }
269  ❌   0                         }
270             
271  ❌   0  ○                      if (handler == null)
272  ❌   0                         {
273  ❌   0                             _logger.LogWarning("Handler factory returned null for action {ActionName}", actionName);
274  ❌   0                             return;
275                                 }
276             
277  ❌   0  ○                      var rootMgr = _serviceProvider.GetService<IWorkflowInstanceManager>() ?? throw new InvalidOperationE
278  ❌   0                         var ctx = new ActionHandlerContext(workflowId, node, definition, rootMgr);
279             
280  ❌   0                         var sw = Stopwatch.StartNew();
281  ❌   0                         IDictionary<string,string>? updates = null;
282                                 try
283  ❌   0                         {
284  ❌   0                             _logger.LogDebug("Invoking handler {HandlerName} for workflow {WorkflowId} node {NodeId}", handl
285  ❌   0                             updates = await handler.HandleAsync(ctx, resolved, cancellationToken).ConfigureAwait(false);
286  ❌   0                         }
287  ❌   0                         catch (OperationCanceledException)
288  ❌   0                         {
289  ❌   0                             _logger.LogDebug("Action {ActionName} execution cancelled", actionName);
290  ❌   0                             throw; // Re-throw to be caught by outer try-catch
291                                 }
292             
293  ❌   0                         sw.Stop();
294  ❌   0  ○                      if (_options.LogExecutionTime)
295  ❌   0                         {
296  ❌   0  ○                          _logger.LogDebug("Action {ActionName} handled by {HandlerName} in {ElapsedMs}ms", actionName, ha
297  ❌   0                         }
298             
299  ❌   0  ○                      if (updates != null)
300  ❌   0                         {
301  ❌   0  ○                          foreach (var kv in updates)
302  ❌   0                             {
303                                         try
304  ❌   0                                 {
305  ❌   0                                     rootMgr.SetVariable(workflowId, kv.Key, kv.Value);
306  ❌   0                                 }
307  ❌   0                                 catch (Exception ex)
308  ❌   0                                 {
309  ❌   0                                     _logger.LogWarning(ex, "Failed to set variable {Key} from handler {ActionName}", kv.Key,
310  ❌   0                                 }
311  ❌   0                             }
312  ❌   0                         }
313  ❌   0                     }
314  ❌   0                 }
315  ❌   0                 catch (OperationCanceledException)
316  ❌   0                 {
317  ❌   0                     throw; // Propagate cancellation to outer handler
318                         }
319  ❌   0                 catch (Exception ex)
320  ❌   0                 {
321  ❌   0                     _logger.LogError(ex, "Action handler for {ActionName} threw an exception", actionName);
322  ❌   0                 }
323  ❌   0             };
324             
325  ❌   0  ○          if (_options.ExecuteHandlersInBackground)
326  ❌   0             {
327                         // Launch background task
328  ❌   0                 _ = Task.Run(() => ExecuteHandlerAsync(factory));
329  ❌   0                 return true;
330                     }
331                     else
332  ❌   0             {
333                         // Execute synchronously and await completion so callers (tests) observe effects
334                         try
335  ❌   0                 {
336  ❌   0                     await ExecuteHandlerAsync(factory).ConfigureAwait(false);
337  ❌   0                     return true;
338                         }
339  ❌   0                 catch (OperationCanceledException)
340  ❌   0                 {
341                             // Return false only when cancellation occurs in synchronous mode
342  ❌   0                     return false;
343                         }
344                     }
345  ✔  268         }
346             
347                 private static IDictionary<string,string> ResolveTemplates(IDictionary<string,string> parameters, IDictionary<string
348  ✔   66         {
349  ✔   66             var result = new ConcurrentDictionary<string,string>(StringComparer.OrdinalIgnoreCase);
350  ✔   66             var pattern = new Regex(@"\{\{\s*(?<key>[a-zA-Z0-9_.]+)\s*\}\}", RegexOptions.Compiled);
351             
352  ✔  238  ●          foreach (var kv in parameters)
353  ✔   20             {
354  ✓   20  ◑              var val = kv.Value ?? string.Empty;
355  ✔   20  ●              var newVal = pattern.Replace(val, m =>
356  ✔    5                 {
357  ✔    5                     var key = m.Groups["key"].Value;
358  ✓    5  ◑                  if (variables != null && variables.TryGetValue(key, out var v))
359  ✓    5  ◑                      return v ?? string.Empty;
360  ❌   0                     return string.Empty;
361  ✔   25                 });
362             
363  ✔   20                 result[kv.Key] = newVal;
364  ✔   20             }
365             
366  ✔   66             return result;
367  ✔   66         }
368             }
```
# FWH.Common.Workflow.Actions.WorkflowActionExecutorOptions

## Summary

|||
|:---|:---|
| Class: | FWH.Common.Workflow.Actions.WorkflowActionExecutorOptions |
| Assembly: | FWH.Common.Workflow |
| **File(s):** | E:\github\FunWasHad\src\FWH.Common.Workflow\Actions\WorkflowActionExecutorOptions.cs |
| **Line coverage:** | 100% (3 of 3) |
| Covered lines: | 3 |
| Uncovered lines: | 0 |
| Coverable lines: | 3 |
| Total lines: | 20 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **get_CreateScopeForHandlers()** | 100% | 1 | 1 | 100% |
| **get_LogExecutionTime()** | 100% | 1 | 1 | 100% |
| **get_ExecuteHandlersInBackground()** | 100% | 1 | 1 | 100% |

## File(s)

### E:\github\FunWasHad\src\FWH.Common.Workflow\Actions\WorkflowActionExecutorOptions.cs
```
 1             namespace FWH.Common.Workflow.Actions;
 2             
 3             public class WorkflowActionExecutorOptions
 4             {
 5                 /// <summary>
 6                 /// When true the executor will create a DI scope for every handler execution so scoped services are available.
 7                 /// </summary>
 8  ✔  143         public bool CreateScopeForHandlers { get; set; } = true;
 9             
10                 /// <summary>
11                 /// When true the executor will log handler execution time.
12                 /// </summary>
13  ✔  206         public bool LogExecutionTime { get; set; } = true;
14             
15                 /// <summary>
16                 /// When true handlers will be executed in background (fire-and-forget) and executor returns immediately.
17                 /// Default false preserves previous synchronous behavior expected by tests.
18                 /// </summary>
19  ✔   83         public bool ExecuteHandlersInBackground { get; set; } = false;
20             }
```
# FWH.Common.Workflow.Actions.WorkflowActionHandlerAdapter

## Summary

|||
|:---|:---|
| Class: | FWH.Common.Workflow.Actions.WorkflowActionHandlerAdapter |
| Assembly: | FWH.Common.Workflow |
| **File(s):** | E:\github\FunWasHad\src\FWH.Common.Workflow\Actions\WorkflowActionHandlerAdapter.cs |
| **Line coverage:** | 43.7% (7 of 16) |
| Covered lines: | 7 |
| Uncovered lines: | 9 |
| Coverable lines: | 16 |
| Total lines: | 42 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **get_Name()** | 100% | 1 | 1 | 100% |
| **.ctor(...)** | 100% | 1 | 1 | 100% |
| **HandleAsync(...)** | 100% | 1 | 1 | 100% |
| **.ctor(...)** | 100% | 2 | 1 | 0% |
| **.ctor(...)** | 100% | 2 | 1 | 0% |
| **FromTyped(...)** | 100% | 2 | 1 | 0% |

## File(s)

### E:\github\FunWasHad\src\FWH.Common.Workflow\Actions\WorkflowActionHandlerAdapter.cs
```
 1            using System;
 2            using System.Collections.Generic;
 3            using System.Threading;
 4            using System.Threading.Tasks;
 5            
 6            namespace FWH.Common.Workflow.Actions;
 7            
 8            /// <summary>
 9            /// Simple adapter to register static handler delegates as IWorkflowActionHandler.
10            /// Supports delegates that return typed results or synchronous handlers.
11            /// </summary>
12            public class WorkflowActionHandlerAdapter : IWorkflowActionHandler
13            {
14  ✔  24         public string Name { get; }
15                private readonly Func<ActionHandlerContext, IDictionary<string,string>, CancellationToken, Task<IDictionary<string,s
16            
17  ✔  12         public WorkflowActionHandlerAdapter(string name, Func<ActionHandlerContext, IDictionary<string,string>, Cancellation
18  ✔  12         {
19  ✔  12             Name = name;
20  ✔  12             _handler = handler;
21  ✔  12         }
22            
23  ✔  43         public Task<IDictionary<string,string>?> HandleAsync(ActionHandlerContext context, IDictionary<string,string> parame
24            
25                // Convenience constructor for delegate that ignores context and cancellation
26                public WorkflowActionHandlerAdapter(string name, Func<IDictionary<string,string>, Task<IDictionary<string,string>?>>
27  ❌  0             : this(name, (ctx, p, ct) => handler(p)) { }
28            
29                // Convenience constructor for sync delegate
30                public WorkflowActionHandlerAdapter(string name, Func<IDictionary<string,string>, IDictionary<string,string>?> handl
31  ❌  0             : this(name, (ctx, p, ct) => Task.FromResult(handler(p))) { }
32            
33                // Convenience constructor for delegate that only uses context and parameters and returns typed results other than s
34                public static WorkflowActionHandlerAdapter FromTyped<T>(string name, Func<ActionHandlerContext, IDictionary<string,s
35  ❌  0         {
36  ❌  0             return new WorkflowActionHandlerAdapter(name, async (ctx, p, ct) =>
37  ❌  0             {
38  ❌  0                 var typed = await typedHandler(ctx, p, ct);
39  ❌  0                 return resultMapper(typed);
40  ❌  0             });
41  ❌  0         }
42            }
```
# FWH.Common.Workflow.Actions.WorkflowActionHandlerRegistrar

## Summary

|||
|:---|:---|
| Class: | FWH.Common.Workflow.Actions.WorkflowActionHandlerRegistrar |
| Assembly: | FWH.Common.Workflow |
| **File(s):** | E:\github\FunWasHad\src\FWH.Common.Workflow\Actions\WorkflowActionHandlerRegistrar.cs |
| **Line coverage:** | 85.7% (24 of 28) |
| Covered lines: | 24 |
| Uncovered lines: | 4 |
| Coverable lines: | 28 |
| Total lines: | 54 |
| **Branch coverage:** | 57.1% (8 of 14) |
| Covered branches: | 8 |
| Total branches: | 14 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **.ctor(...)** | 57.14% | 15 | 14 | 85.71% |

## File(s)

### E:\github\FunWasHad\src\FWH.Common.Workflow\Actions\WorkflowActionHandlerRegistrar.cs
```
 1             using System.Linq;
 2             using Microsoft.Extensions.DependencyInjection;
 3             using Microsoft.Extensions.Logging;
 4             
 5             namespace FWH.Common.Workflow.Actions;
 6             
 7             /// <summary>
 8             /// On-demand registrar that wires handlers registered in DI into the registry.
 9             /// This registrar supports handler factories to resolve handlers with scoped services.
10             /// </summary>
11             public class WorkflowActionHandlerRegistrar
12             {
13                 private readonly IWorkflowActionHandlerRegistry _registry;
14                 private readonly IServiceProvider _sp;
15                 private readonly ILogger<WorkflowActionHandlerRegistrar>? _logger;
16             
17  ✔   29         public WorkflowActionHandlerRegistrar(IServiceProvider sp, IWorkflowActionHandlerRegistry registry, ILogger<Workflow
18  ✔   29         {
19  ✔   29             _sp = sp;
20  ✔   29             _registry = registry;
21  ✔   29             _logger = logger;
22             
23                     // Discover any IWorkflowActionHandler singletons and register factories for them
24  ✔   29             var handlers = sp.GetServices<IWorkflowActionHandler>().ToList();
25  ✓   29  ◑          _logger?.LogInformation("Discovered {Count} singleton handlers during registration", handlers.Count);
26             
27  ✔  113  ●          foreach (var h in handlers)
28  ✔   13             {
29  ✔   57                 _registry.Register(h.Name, _ => h);
30  ✓   13  ◑              _logger?.LogInformation("Registered singleton handler '{HandlerName}' into registry", h.Name);
31  ✔   13             }
32             
33                     // Discover any Func<IServiceProvider,IWorkflowActionHandler> factories registered in DI and register them
34  ✔   29             var factories = sp.GetServices<Func<IServiceProvider, IWorkflowActionHandler>>().ToList();
35  ✓   29  ◑          _logger?.LogInformation("Discovered {Count} handler factories during registration", factories.Count);
36             
37  ✔   97  ●          foreach (var f in factories)
38  ✔    5             {
39                         try
40  ✔    5                 {
41                             // Use a scope when sampling factory in case it requires scoped services
42  ✔    5                     using var scope = sp.CreateScope();
43  ✔    5                     var sample = f(scope.ServiceProvider);
44                             // Register the factory so executor can create handler instances from a scope during execution
45  ✔    5                     _registry.Register(sample.Name, f);
46  ✓    5  ◑                  _logger?.LogInformation("Registered factory handler '{HandlerName}' into registry", sample.Name);
47  ✔    5                 }
48  ❌   0                 catch (Exception ex)
49  ❌   0                 {
50  ❌   0  ○                  _logger?.LogWarning(ex, "Factory sampling failed for a handler factory; skipping registration");
51  ❌   0                 }
52  ✔    5             }
53  ✔   29         }
54             }
```
# FWH.Common.Workflow.Actions.WorkflowActionHandlerRegistry

## Summary

|||
|:---|:---|
| Class: | FWH.Common.Workflow.Actions.WorkflowActionHandlerRegistry |
| Assembly: | FWH.Common.Workflow |
| **File(s):** | E:\github\FunWasHad\src\FWH.Common.Workflow\Actions\WorkflowActionHandlerRegistry.cs |
| **Line coverage:** | 100% (15 of 15) |
| Covered lines: | 15 |
| Uncovered lines: | 0 |
| Coverable lines: | 15 |
| Total lines: | 31 |
| **Branch coverage:** | 100% (8 of 8) |
| Covered branches: | 8 |
| Total branches: | 8 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **.ctor(...)** | 100% | 1 | 1 | 100% |
| **Register(...)** | 100% | 6 | 6 | 100% |
| **TryGetFactory(...)** | 100% | 2 | 2 | 100% |

## File(s)

### E:\github\FunWasHad\src\FWH.Common.Workflow\Actions\WorkflowActionHandlerRegistry.cs
```
 1               using System;
 2               using System.Collections.Concurrent;
 3               using Microsoft.Extensions.Logging;
 4               
 5               namespace FWH.Common.Workflow.Actions;
 6               
 7               public class WorkflowActionHandlerRegistry : IWorkflowActionHandlerRegistry
 8               {
 9  ✔     77         private readonly ConcurrentDictionary<string, Func<IServiceProvider, IWorkflowActionHandler>> _factories = new(Strin
10                   private readonly ILogger<WorkflowActionHandlerRegistry>? _logger;
11               
12  ✔     77         public WorkflowActionHandlerRegistry(ILogger<WorkflowActionHandlerRegistry>? logger = null)
13  ✔     77         {
14  ✔     77             _logger = logger;
15  ✔     77         }
16               
17                   public void Register(string name, Func<IServiceProvider, IWorkflowActionHandler> factory)
18  ✔  10229         {
19  ✔  10232  ●          if (string.IsNullOrWhiteSpace(name)) throw new ArgumentNullException(nameof(name));
20  ✔  10227  ●          if (factory == null) throw new ArgumentNullException(nameof(factory));
21               
22  ✔  10225             _factories[name] = factory;
23  ✔  10225  ●          _logger?.LogInformation("Registered workflow action handler factory for {Action}", name);
24  ✔  10225         }
25               
26                   public bool TryGetFactory(string name, out Func<IServiceProvider, IWorkflowActionHandler>? factory)
27  ✔   1223         {
28  ✔   1226  ●          if (string.IsNullOrWhiteSpace(name)) { factory = null; return false; }
29  ✔   1222             return _factories.TryGetValue(name, out factory);
30  ✔   1223         }
31               }
```
# FWH.Common.Workflow.Actions.WorkflowActionRequest

## Summary

|||
|:---|:---|
| Class: | FWH.Common.Workflow.Actions.WorkflowActionRequest |
| Assembly: | FWH.Common.Workflow |
| **File(s):** | E:\github\FunWasHad\src\FWH.Common.Workflow\Actions\WorkflowActionRequest.cs |
| **Line coverage:** | 100% (7 of 7) |
| Covered lines: | 7 |
| Uncovered lines: | 0 |
| Coverable lines: | 7 |
| Total lines: | 22 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **get_WorkflowId()** | 100% | 1 | 1 | 100% |
| **get_Node()** | 100% | 1 | 1 | 100% |
| **get_Definition()** | 100% | 1 | 1 | 100% |
| **get_ActionName()** | 100% | 1 | 1 | 100% |
| **get_Parameters()** | 100% | 1 | 1 | 100% |
| **get_CreateScopeForHandlers()** | 100% | 1 | 1 | 100% |
| **get_LogExecutionTime()** | 100% | 1 | 1 | 100% |

## File(s)

### E:\github\FunWasHad\src\FWH.Common.Workflow\Actions\WorkflowActionRequest.cs
```
 1             using FWH.Common.Workflow.Models;
 2             using FWH.Orchestrix.Contracts.Mediator;
 3             
 4             namespace FWH.Common.Workflow.Actions;
 5             
 6             public sealed class WorkflowActionRequest : IMediatorRequest<WorkflowActionResponse>
 7             {
 8  ✔  181         public string WorkflowId { get; set; } = string.Empty;
 9  ✔  181         public WorkflowNode Node { get; set; } = null!;
10  ✔  181         public WorkflowDefinition Definition { get; set; } = null!;
11  ✔  332         public string ActionName { get; set; } = string.Empty;
12  ✔  181         public IDictionary<string, string> Parameters { get; set; } = new Dictionary<string, string>();
13  ✔  181         public bool CreateScopeForHandlers { get; set; } = true;
14  ✔  181         public bool LogExecutionTime { get; set; } = false;
15             }
16             
17             public sealed class WorkflowActionResponse
18             {
19                 public bool Success { get; set; }
20                 public string? ErrorMessage { get; set; }
21                 public IDictionary<string, string>? VariableUpdates { get; set; }
22             }
```
# FWH.Common.Workflow.Actions.WorkflowActionRequestHandler

## Summary

|||
|:---|:---|
| Class: | FWH.Common.Workflow.Actions.WorkflowActionRequestHandler |
| Assembly: | FWH.Common.Workflow |
| **File(s):** | E:\github\FunWasHad\src\FWH.Common.Workflow\Actions\WorkflowActionRequestHandler.cs |
| **Line coverage:** | 83.7% (62 of 74) |
| Covered lines: | 62 |
| Uncovered lines: | 12 |
| Coverable lines: | 74 |
| Total lines: | 116 |
| **Branch coverage:** | 65% (13 of 20) |
| Covered branches: | 13 |
| Total branches: | 20 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **.ctor(...)** | 100% | 1 | 1 | 100% |
| **HandleAsync()** | 65.00% | 26 | 20 | 75.80% |

## File(s)

### E:\github\FunWasHad\src\FWH.Common.Workflow\Actions\WorkflowActionRequestHandler.cs
```
  1            using Microsoft.Extensions.DependencyInjection;
  2            using Microsoft.Extensions.Logging;
  3            using FWH.Common.Workflow.Instance;
  4            using FWH.Orchestrix.Contracts.Mediator;
  5            
  6            namespace FWH.Common.Workflow.Actions;
  7            
  8            public sealed class WorkflowActionRequestHandler : IMediatorHandler<WorkflowActionRequest, WorkflowActionResponse>
  9            {
 10                private readonly IServiceProvider _serviceProvider;
 11                private readonly IWorkflowActionHandlerRegistry _registry;
 12                private readonly ILogger<WorkflowActionRequestHandler> _logger;
 13            
 14  ✔  65         public WorkflowActionRequestHandler(
 15  ✔  65             IServiceProvider serviceProvider,
 16  ✔  65             IWorkflowActionHandlerRegistry registry,
 17  ✔  65             ILogger<WorkflowActionRequestHandler> logger)
 18  ✔  65         {
 19  ✔  65             ArgumentNullException.ThrowIfNull(serviceProvider);
 20  ✔  65             ArgumentNullException.ThrowIfNull(registry);
 21  ✔  65             ArgumentNullException.ThrowIfNull(logger);
 22            
 23  ✔  65             _serviceProvider = serviceProvider;
 24  ✔  65             _registry = registry;
 25  ✔  65             _logger = logger;
 26  ✔  65         }
 27            
 28                public async Task<WorkflowActionResponse> HandleAsync(WorkflowActionRequest request, CancellationToken cancellationT
 29  ✔  65         {
 30  ✔  65             ArgumentNullException.ThrowIfNull(request);
 31            
 32  ✓  65  ◑          if (string.IsNullOrWhiteSpace(request.ActionName))
 33  ❌  0             {
 34  ❌  0                 return new WorkflowActionResponse { Success = false, ErrorMessage = "ActionName is required." };
 35                    }
 36            
 37  ✓  65  ◑          if (!_registry.TryGetFactory(request.ActionName, out var factory) || factory is null)
 38  ✔  14             {
 39  ✔  14                 _logger.LogWarning("No handler registered for action {ActionName}", request.ActionName);
 40  ✔  14                 return new WorkflowActionResponse { Success = false, ErrorMessage = $"No handler for {request.ActionName}" }
 41                    }
 42            
 43                    try
 44  ✔  51             {
 45                        IDictionary<string, string>? updates;
 46  ✔  51                 System.Diagnostics.Stopwatch? sw = null;
 47            
 48  ✔  51  ●              if (request.LogExecutionTime)
 49  ✔  46                 {
 50  ✔  46                     sw = System.Diagnostics.Stopwatch.StartNew();
 51  ✔  46                 }
 52            
 53  ✔  51  ●              if (request.CreateScopeForHandlers)
 54  ✔  49                 {
 55  ✔  49                     using var scope = _serviceProvider.CreateScope();
 56  ✔  49                     var handler = factory(scope.ServiceProvider);
 57  ✓  49  ◑                  if (handler is null)
 58  ❌  0                     {
 59  ❌  0                         _logger.LogWarning("Handler factory returned null for action {ActionName}", request.ActionName);
 60  ❌  0                         return new WorkflowActionResponse { Success = false, ErrorMessage = $"Handler factory returned null 
 61                            }
 62            
 63  ✔  49                     var instanceManager = scope.ServiceProvider.GetService<IWorkflowInstanceManager>();
 64  ✓  49  ◑                  if (instanceManager is null)
 65  ❌  0                     {
 66  ❌  0                         throw new InvalidOperationException("InstanceManager required in workflow action scope.");
 67                            }
 68            
 69  ✔  49                     var ctx = new ActionHandlerContext(request.WorkflowId, request.Node, request.Definition, instanceManager
 70  ✔  49                     updates = await handler.HandleAsync(ctx, request.Parameters, cancellationToken).ConfigureAwait(false);
 71  ✔  44                 }
 72                        else
 73  ✔   2                 {
 74                            // Use root service provider without creating a scope
 75  ✔   2                     var handler = factory(_serviceProvider);
 76  ✓   2  ◑                  if (handler is null)
 77  ❌  0                     {
 78  ❌  0                         _logger.LogWarning("Handler factory returned null for action {ActionName}", request.ActionName);
 79  ❌  0                         return new WorkflowActionResponse { Success = false, ErrorMessage = $"Handler factory returned null 
 80                            }
 81            
 82  ✔   2                     var instanceManager = _serviceProvider.GetService<IWorkflowInstanceManager>();
 83  ✓   2  ◑                  if (instanceManager is null)
 84  ❌  0                     {
 85  ❌  0                         throw new InvalidOperationException("InstanceManager required in workflow action scope.");
 86                            }
 87            
 88  ✔   2                     var ctx = new ActionHandlerContext(request.WorkflowId, request.Node, request.Definition, instanceManager
 89  ✔   2                     updates = await handler.HandleAsync(ctx, request.Parameters, cancellationToken).ConfigureAwait(false);
 90  ✔   2                 }
 91            
 92  ✔  46  ●              if (sw != null)
 93  ✔  41                 {
 94  ✔  41                     sw.Stop();
 95  ✔  41                     _logger.LogInformation("Action {ActionName} handled by handler in {ElapsedMs}ms", request.ActionName, sw
 96  ✔  41                 }
 97            
 98  ✔  46                 return new WorkflowActionResponse
 99  ✔  46                 {
100  ✔  46                     Success = true,
101  ✔  46                     VariableUpdates = updates
102  ✔  46                 };
103                    }
104  ✔   1             catch (OperationCanceledException)
105  ✔   1             {
106  ✔   1                 _logger.LogInformation("Action {ActionName} execution cancelled", request.ActionName);
107  ✔   1                 return new WorkflowActionResponse { Success = false, ErrorMessage = "Action execution was cancelled" };
108                    }
109  ✔   2             catch (Exception ex)
110  ✔   2             {
111  ✔   2                 _logger.LogError(ex, "Action handler for {ActionName} threw an exception", request.ActionName);
112                        // Return success=true even on exception - allows workflow to continue (matches direct handler path behavior
113  ✔   2                 return new WorkflowActionResponse { Success = true, VariableUpdates = null };
114                    }
115  ✔  63         }
116            }
```
# FWH.Common.Workflow.Actions.WorkflowActionResponse

## Summary

|||
|:---|:---|
| Class: | FWH.Common.Workflow.Actions.WorkflowActionResponse |
| Assembly: | FWH.Common.Workflow |
| **File(s):** | E:\github\FunWasHad\src\FWH.Common.Workflow\Actions\WorkflowActionRequest.cs |
| **Line coverage:** | 100% (3 of 3) |
| Covered lines: | 3 |
| Uncovered lines: | 0 |
| Coverable lines: | 3 |
| Total lines: | 22 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **get_Success()** | 100% | 1 | 1 | 100% |
| **get_ErrorMessage()** | 100% | 1 | 1 | 100% |
| **get_VariableUpdates()** | 100% | 1 | 1 | 100% |

## File(s)

### E:\github\FunWasHad\src\FWH.Common.Workflow\Actions\WorkflowActionRequest.cs
```
 1             using FWH.Common.Workflow.Models;
 2             using FWH.Orchestrix.Contracts.Mediator;
 3             
 4             namespace FWH.Common.Workflow.Actions;
 5             
 6             public sealed class WorkflowActionRequest : IMediatorRequest<WorkflowActionResponse>
 7             {
 8                 public string WorkflowId { get; set; } = string.Empty;
 9                 public WorkflowNode Node { get; set; } = null!;
10                 public WorkflowDefinition Definition { get; set; } = null!;
11                 public string ActionName { get; set; } = string.Empty;
12                 public IDictionary<string, string> Parameters { get; set; } = new Dictionary<string, string>();
13                 public bool CreateScopeForHandlers { get; set; } = true;
14                 public bool LogExecutionTime { get; set; } = false;
15             }
16             
17             public sealed class WorkflowActionResponse
18             {
19  ✔  126         public bool Success { get; set; }
20  ✔   15         public string? ErrorMessage { get; set; }
21  ✔  184         public IDictionary<string, string>? VariableUpdates { get; set; }
22             }
```
# FWH.Common.Workflow.Controllers.WorkflowController

## Summary

|||
|:---|:---|
| Class: | FWH.Common.Workflow.Controllers.WorkflowController |
| Assembly: | FWH.Common.Workflow |
| **File(s):** | E:\github\FunWasHad\src\FWH.Common.Workflow\Controllers\WorkflowController.cs |
| **Line coverage:** | 84.7% (222 of 262) |
| Covered lines: | 222 |
| Uncovered lines: | 40 |
| Coverable lines: | 262 |
| Total lines: | 398 |
| **Branch coverage:** | 64.7% (79 of 122) |
| Covered branches: | 79 |
| Total branches: | 122 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **.ctor(...)** | 50.0% | 14 | 14 | 100% |
| **ImportWorkflowAsync()** | 66.66% | 6 | 6 | 81.81% |
| **StartInstanceAsync()** | 76.66% | 32 | 30 | 86.66% |
| **RestartInstanceAsync()** | 80.0% | 11 | 10 | 82.75% |
| **GetCurrentStatePayloadAsync(...)** | 75.00% | 4 | 4 | 87.50% |
| **AdvanceByChoiceValueAsync()** | 66.66% | 14 | 12 | 75.00% |
| **GetCurrentNodeId(...)** | 50.0% | 2 | 2 | 80.0% |
| **WorkflowExists(...)** | 0% | 6 | 2 | 0% |
| **ResolveChoiceValue(...)** | 50.0% | 82 | 26 | 56.52% |
| **PersistCurrentNodeAsync()** | 50.0% | 6 | 6 | 96.00% |
| **PersistDefinitionAsync()** | 50.0% | 6 | 6 | 82.35% |
| **GetRepository()** | 100% | 1 | 1 | 100% |
| **TryExecuteNodeActionAsync()** | 100% | 4 | 4 | 100% |

## File(s)

### E:\github\FunWasHad\src\FWH.Common.Workflow\Controllers\WorkflowController.cs
```
  1             using System;
  2             using System.Linq;
  3             using System.Collections.Generic;
  4             using System.Threading.Tasks;
  5             using Microsoft.Extensions.DependencyInjection;
  6             using Microsoft.Extensions.Logging;
  7             using FWH.Common.Workflow.Models;
  8             using FWH.Common.Workflow.Storage;
  9             using FWH.Common.Workflow.Instance;
 10             using FWH.Common.Workflow.Mapping;
 11             using FWH.Common.Workflow.State;
 12             using FWH.Mobile.Data.Repositories;
 13             
 14             namespace FWH.Common.Workflow.Controllers;
 15             
 16             /// <summary>
 17             /// Controller for workflow business logic operations.
 18             /// Coordinates between workflow service components and handles business rules.
 19             /// Single Responsibility: Orchestrate workflow operations and enforce business logic.
 20             /// </summary>
 21             public class WorkflowController : IWorkflowController
 22             {
 23                 private readonly IServiceProvider _serviceProvider;
 24                 private readonly IWorkflowDefinitionStore _definitionStore;
 25                 private readonly IWorkflowInstanceManager _instanceManager;
 26                 private readonly IWorkflowModelMapper _mapper;
 27                 private readonly IWorkflowStateCalculator _stateCalculator;
 28                 private readonly ILogger<WorkflowController> _logger;
 29                 private readonly FWH.Common.Workflow.Actions.IWorkflowActionExecutor _actionExecutor;
 30             
 31  ✔   51         public WorkflowController(
 32  ✔   51             IServiceProvider serviceProvider,
 33  ✔   51             IWorkflowDefinitionStore definitionStore,
 34  ✔   51             IWorkflowInstanceManager instanceManager,
 35  ✔   51             IWorkflowModelMapper mapper,
 36  ✔   51             IWorkflowStateCalculator stateCalculator,
 37  ✔   51             FWH.Common.Workflow.Actions.IWorkflowActionExecutor actionExecutor,
 38  ✔   51             ILogger<WorkflowController>? logger = null)
 39  ✔   51         {
 40  ✓   51  ◑          _serviceProvider = serviceProvider ?? throw new ArgumentNullException(nameof(serviceProvider));
 41  ✓   51  ◑          _definitionStore = definitionStore ?? throw new ArgumentNullException(nameof(definitionStore));
 42  ✓   51  ◑          _instanceManager = instanceManager ?? throw new ArgumentNullException(nameof(instanceManager));
 43  ✓   51  ◑          _mapper = mapper ?? throw new ArgumentNullException(nameof(mapper));
 44  ✓   51  ◑          _stateCalculator = stateCalculator ?? throw new ArgumentNullException(nameof(stateCalculator));
 45  ✓   51  ◑          _actionExecutor = actionExecutor ?? throw new ArgumentNullException(nameof(actionExecutor));
 46  ✓   51  ◑          _logger = logger ?? Microsoft.Extensions.Logging.Abstractions.NullLogger<WorkflowController>.Instance;
 47  ✔   51         }
 48             
 49                 public async Task<WorkflowDefinition> ImportWorkflowAsync(string plantUmlText, string? id = null, string? name = nul
 50  ✔  184         {
 51  ✔  184  ●          if (string.IsNullOrWhiteSpace(plantUmlText))
 52  ✔    1                 throw new ArgumentNullException(nameof(plantUmlText));
 53             
 54  ✓  183  ◑          var workflowId = id ?? Guid.NewGuid().ToString();
 55  ✔  183             _logger.LogDebug("Importing workflow {WorkflowId}", workflowId);
 56             
 57                     // Check if workflow definition already exists in memory store
 58  ✔  183             var existingDefinition = _definitionStore.Get(workflowId);
 59  ✓  183  ◑          if (existingDefinition != null)
 60  ❌   0             {
 61  ❌   0                 _logger.LogDebug("Workflow {WorkflowId} already exists in definition store, reusing existing definition", wo
 62             
 63                         // Ensure instance is started
 64  ❌   0                 await StartInstanceAsync(workflowId);
 65  ❌   0                 return existingDefinition;
 66                     }
 67             
 68                     // Parse PlantUML only if not already in store
 69  ✔  183             _logger.LogDebug("Parsing PlantUML for workflow {WorkflowId} (content length: {Length} chars)", workflowId, plan
 70  ✔  183             var parser = new PlantUmlParser(plantUmlText);
 71  ✔  183             var definition = parser.Parse(id, name);
 72  ✔  183             _logger.LogDebug("Completed parsing workflow {WorkflowId} - {NodeCount} nodes, {TransitionCount} transitions",
 73  ✔  183                 workflowId, definition.Nodes.Count, definition.Transitions.Count);
 74             
 75                     // Store definition
 76  ✔  183             _definitionStore.Store(definition);
 77             
 78                     // Initialize instance
 79  ✔  183             await StartInstanceAsync(definition.Id);
 80             
 81                     // Persist to database
 82  ✔  183             await PersistDefinitionAsync(definition);
 83             
 84  ✔  183             _logger.LogInformation("Imported workflow {WorkflowId}", definition.Id);
 85  ✔  183             return definition;
 86  ✔  183         }
 87             
 88                 public async Task StartInstanceAsync(string workflowId)
 89  ✔  186         {
 90  ✓  186  ◑          if (string.IsNullOrWhiteSpace(workflowId))
 91  ❌   0                 throw new ArgumentNullException(nameof(workflowId));
 92             
 93  ✓  186  ◑          var definition = _definitionStore.Get(workflowId) ?? throw new InvalidOperationException($"Unknown workflow id: 
 94  ✔  186             _logger.LogDebug("Starting instance for workflow {WorkflowId}", workflowId);
 95             
 96                     // Try to restore from persistence
 97  ✔  186             var repo = GetRepository();
 98  ✔  186  ●          if (repo != null)
 99  ✔  186             {
100                         try
101  ✔  186                 {
102  ✔  186                     var persisted = await repo.GetByIdAsync(workflowId);
103  ✔  179  ●                  if (persisted != null && !string.IsNullOrWhiteSpace(persisted.CurrentNodeId))
104  ✔    3                     {
105  ✔    3                         _instanceManager.SetCurrentNode(workflowId, persisted.CurrentNodeId);
106  ✔    3                         _logger.LogDebug("Restored workflow {WorkflowId} to node {NodeId}",
107  ✔    3                             workflowId, persisted.CurrentNodeId);
108  ✔    3                         return;
109                             }
110  ✔  176                 }
111  ✔    7                 catch (Exception ex)
112  ✔    7                 {
113  ✔    7                     _logger.LogWarning(ex, "Failed to restore workflow {WorkflowId} state", workflowId);
114  ✔    7                 }
115  ✔  183             }
116             
117                     // Calculate and set start node
118  ✔  183             var startNode = _stateCalculator.CalculateStartNode(definition);
119  ✔  183             _instanceManager.SetCurrentNode(workflowId, startNode);
120             
121  ✔  183             _logger.LogInformation("Started workflow {WorkflowId} at node {NodeId}", workflowId, startNode);
122             
123                     // Also attempt to execute an inline action attached to the original start node (before auto-advance)
124  ✓  183  ◕          var originalStart = definition.StartPoints.FirstOrDefault()?.NodeId ?? definition.Nodes.FirstOrDefault()?.Id;
125  ✔  183  ●          if (!string.IsNullOrWhiteSpace(originalStart))
126  ✔  183             {
127  ✔  366                 var originalNode = definition.Nodes.FirstOrDefault(n => n.Id == originalStart);
128  ✓  183  ◑              if (originalNode != null && !string.IsNullOrWhiteSpace(originalNode.NoteMarkdown))
129  ✔   21                 {
130  ✔   21                     var note = originalNode.NoteMarkdown.Trim();
131  ✓   21  ◑                  if (note.StartsWith('{') && note.EndsWith('}'))
132  ✔   21                     {
133  ✔   21                         _ = TryExecuteNodeActionAsync(definition, workflowId, originalNode);
134  ✔   21                     }
135  ✔   21                 }
136  ✔  183             }
137             
138                     // If the start node (as selected) is an action node attempt to execute it
139  ✔  183  ●          if (!string.IsNullOrWhiteSpace(startNode))
140  ✔  183             {
141  ✔  388                 var startNodeObj = definition.Nodes.FirstOrDefault(n => n.Id == startNode);
142  ✔  183  ●              if (startNodeObj != null)
143  ✔  183                 {
144  ✔  183                     _ = TryExecuteNodeActionAsync(definition, workflowId, startNodeObj);
145  ✔  183                 }
146  ✔  183             }
147  ✔  186         }
148             
149                 public async Task RestartInstanceAsync(string workflowId)
150  ✔    1         {
151  ✓    1  ◑          if (string.IsNullOrWhiteSpace(workflowId))
152  ❌   0                 throw new ArgumentNullException(nameof(workflowId));
153             
154  ✓    1  ◑          var definition = _definitionStore.Get(workflowId) ?? throw new InvalidOperationException($"Unknown workflow id: 
155  ✔    1             _logger.LogDebug("Restarting workflow {WorkflowId}", workflowId);
156             
157                     // Clear current state
158  ✔    1             _instanceManager.ClearCurrentNode(workflowId);
159             
160                     // Calculate new start node (don't call StartInstanceAsync as it would try to restore from DB)
161  ✔    1             var startNode = _stateCalculator.CalculateStartNode(definition);
162  ✔    1             _instanceManager.SetCurrentNode(workflowId, startNode);
163             
164  ✔    1             _logger.LogInformation("Restarted workflow {WorkflowId} at node {NodeId}", workflowId, startNode);
165             
166                     // Persist the restart (update DB to new start node)
167  ✔    1             var repo = GetRepository();
168  ✔    1  ●          if (repo != null)
169  ✔    1             {
170                         try
171  ✔    1                 {
172  ✔    1                     await repo.UpdateCurrentNodeIdAsync(workflowId, startNode);
173  ✔    1                     _logger.LogInformation("Persisted restart for workflow {WorkflowId}", workflowId);
174  ✔    1                 }
175  ❌   0                 catch (Exception ex)
176  ❌   0                 {
177  ❌   0                     _logger.LogWarning(ex, "Failed to persist restart for workflow {WorkflowId}", workflowId);
178  ❌   0                 }
179  ✔    1             }
180             
181                     // Execute action on start node if present
182  ✔    1  ●          if (!string.IsNullOrWhiteSpace(startNode))
183  ✔    1             {
184  ✔    3                 var startNodeObj = definition.Nodes.FirstOrDefault(n => n.Id == startNode);
185  ✔    1  ●              if (startNodeObj != null)
186  ✔    1                 {
187  ✔    1                     await TryExecuteNodeActionAsync(definition, workflowId, startNodeObj);
188  ✔    1                 }
189  ✔    1             }
190  ✔    1         }
191             
192                 public Task<WorkflowStatePayload> GetCurrentStatePayloadAsync(string workflowId)
193  ✔  116         {
194  ✓  116  ◑          if (string.IsNullOrWhiteSpace(workflowId))
195  ❌   0                 throw new ArgumentNullException(nameof(workflowId));
196             
197  ✔  116  ●          var definition = _definitionStore.Get(workflowId) ?? throw new InvalidOperationException($"Unknown workflow id: 
198  ✔  115             var currentNodeId = _instanceManager.GetCurrentNode(workflowId);
199  ✔  115             var payload = _stateCalculator.CalculateCurrentPayload(definition, currentNodeId);
200             
201  ✔  115             return Task.FromResult(payload);
202  ✔  115         }
203             
204                 public async Task<bool> AdvanceByChoiceValueAsync(string workflowId, object? choiceValue)
205  ✔   59         {
206  ✓   59  ◑          if (string.IsNullOrWhiteSpace(workflowId))
207  ❌   0                 throw new ArgumentNullException(nameof(workflowId));
208             
209  ✓   59  ◑          var definition = _definitionStore.Get(workflowId) ?? throw new InvalidOperationException($"Unknown workflow id: 
210  ✔   59             var currentNodeId = _instanceManager.GetCurrentNode(workflowId);
211  ✓   59  ◑          if (currentNodeId == null)
212  ❌   0             {
213  ❌   0                 await StartInstanceAsync(workflowId);
214  ❌   0                 currentNodeId = _instanceManager.GetCurrentNode(workflowId);
215  ❌   0             }
216             
217                     // Find matching transition
218  ✔  359             var outgoing = definition.Transitions.Where(t => t.FromNodeId == currentNodeId).ToList();
219  ✔   59  ●          if (outgoing.Count == 0)
220  ✔    3                 return false;
221             
222  ✔   56             string? newNodeId = ResolveChoiceValue(outgoing, definition, choiceValue);
223  ✓   56  ◑          if (newNodeId == null)
224  ❌   0                 return false;
225             
226                     // Update state
227  ✔   56             _instanceManager.SetCurrentNode(workflowId, newNodeId);
228             
229                     // Persist state
230  ✔   56             await PersistCurrentNodeAsync(workflowId, newNodeId);
231             
232  ✔   56             _logger.LogInformation("Advanced workflow {WorkflowId} to node {NodeId}", workflowId, newNodeId);
233             
234                     // After advancing, if the new node is an action node execute it and auto-advance if possible
235  ✔  240             var newNodeObj = definition.Nodes.FirstOrDefault(n => n.Id == newNodeId);
236  ✔   56  ●          if (newNodeObj != null)
237  ✔   56             {
238  ✔   56                 await TryExecuteNodeActionAsync(definition, workflowId, newNodeObj);
239  ✔   56             }
240             
241  ✔   56             return true;
242  ✔   59         }
243             
244                 public string? GetCurrentNodeId(string workflowId)
245  ✔   35         {
246  ✓   35  ◑          if (string.IsNullOrWhiteSpace(workflowId))
247  ❌   0                 return null;
248             
249  ✔   35             return _instanceManager.GetCurrentNode(workflowId);
250  ✔   35         }
251             
252                 public bool WorkflowExists(string workflowId)
253  ❌   0         {
254  ❌   0  ○          if (string.IsNullOrWhiteSpace(workflowId))
255  ❌   0                 return false;
256             
257  ❌   0             return _definitionStore.Exists(workflowId);
258  ❌   0         }
259             
260                 private string? ResolveChoiceValue(
261                     List<Transition> outgoing,
262                     WorkflowDefinition definition,
263                     object? choiceValue)
264  ✔   56         {
265                     // Match by node ID
266  ✔   56  ●          if (choiceValue is string sVal)
267  ✔   32             {
268  ✔   32                 var match = outgoing.FirstOrDefault(t =>
269  ✔   66                     string.Equals(t.ToNodeId, sVal, StringComparison.Ordinal));
270  ✓   32  ◑              if (match != null)
271  ✔   32                     return match.ToNodeId;
272             
273                         // Match by node label
274  ❌   0                 var byLabel = outgoing.FirstOrDefault(t =>
275  ❌   0  ○                  definition.Nodes.FirstOrDefault(n => n.Id == t.ToNodeId)?.Label == sVal);
276  ❌   0  ○              if (byLabel != null)
277  ❌   0                     return byLabel.ToNodeId;
278  ❌   0             }
279             
280                     // Match by index
281  ✔   24  ●          if (choiceValue is int idx && idx >= 0 && idx < outgoing.Count)
282  ✔    1                 return outgoing[idx].ToNodeId;
283             
284                     // Match by numeric string
285  ✓   23  ◑          if (choiceValue is string numeric && int.TryParse(numeric, out var parsed))
286  ❌   0             {
287  ❌   0  ○              if (parsed >= 0 && parsed < outgoing.Count)
288  ❌   0                     return outgoing[parsed].ToNodeId;
289  ❌   0             }
290             
291                     // Auto-advance on single transition
292  ✓   23  ◑          if (choiceValue == null && outgoing.Count == 1)
293  ✔   23                 return outgoing[0].ToNodeId;
294             
295  ❌   0             return null;
296  ✔   56         }
297             
298                 private async Task PersistCurrentNodeAsync(string workflowId, string? nodeId)
299  ✔   96         {
300  ✔   96             var repo = GetRepository();
301  ✓   94  ◑          if (repo == null)
302  ❌   0                 return;
303             
304                     try
305  ✔   94             {
306  ✓   94  ◑              using var scope = _logger.BeginScope(new Dictionary<string, object>
307  ✔   94                 {
308  ✔   94                     ["Operation"] = "UpdateCurrentNodeId",
309  ✔   94                     ["WorkflowId"] = workflowId,
310  ✔   94                     ["NodeId"] = nodeId ?? "null"
311  ✔   94                 });
312             
313  ✔   94                 await repo.UpdateCurrentNodeIdAsync(workflowId, nodeId);
314  ✔   87                 _logger.LogDebug("Persisted node {NodeId} for workflow {WorkflowId}", nodeId, workflowId);
315  ✔   87             }
316  ✔    7             catch (Exception ex)
317  ✔    7             {
318  ✓    7  ◑              using var warnScope = _logger.BeginScope(new Dictionary<string, object>
319  ✔    7                 {
320  ✔    7                     ["Operation"] = "UpdateCurrentNodeId",
321  ✔    7                     ["WorkflowId"] = workflowId,
322  ✔    7                     ["NodeId"] = nodeId ?? "null"
323  ✔    7                 });
324             
325  ✔    7                 _logger.LogWarning(ex, "Failed to persist node for workflow {WorkflowId}", workflowId);
326  ✔    7             }
327  ✔   94         }
328             
329                 private async Task PersistDefinitionAsync(WorkflowDefinition definition)
330  ✔  183         {
331  ✔  183             var repo = GetRepository();
332  ✓  183  ◑          if (repo == null)
333  ❌   0                 return;
334             
335                     try
336  ✔  183             {
337  ✔  183                 using var scope = _logger.BeginScope(new Dictionary<string, object>
338  ✔  183                 {
339  ✔  183                     ["Operation"] = "PersistDefinition",
340  ✔  183                     ["WorkflowId"] = definition.Id
341  ✔  183                 });
342             
343  ✔  183                 var dataModel = _mapper.ToDataModel(definition);
344  ✓  183  ◑              dataModel.CurrentNodeId = _instanceManager.GetCurrentNode(definition.Id) ?? dataModel.CurrentNodeId;
345             
346                         // Check if workflow already exists - use upsert pattern
347  ✔  183                 var existing = await repo.GetByIdAsync(definition.Id);
348  ✓  176  ◑              if (existing != null)
349  ❌   0                 {
350  ❌   0                     _logger.LogDebug("Workflow {WorkflowId} already exists, updating instead of creating", definition.Id);
351  ❌   0                     await repo.UpdateAsync(dataModel);
352  ❌   0                     _logger.LogInformation("Updated existing workflow {WorkflowId}", definition.Id);
353  ❌   0                 }
354                         else
355  ✔  176                 {
356  ✔  176                     await repo.CreateAsync(dataModel);
357  ✔  174                     _logger.LogInformation("Created new workflow {WorkflowId}", definition.Id);
358  ✔  174                 }
359  ✔  174             }
360  ✔    9             catch (Exception ex)
361  ✔    9             {
362  ✔    9                 using var errScope = _logger.BeginScope(new Dictionary<string, object>
363  ✔    9                 {
364  ✔    9                     ["Operation"] = "PersistDefinition",
365  ✔    9                     ["WorkflowId"] = definition.Id
366  ✔    9                 });
367             
368  ✔    9                 _logger.LogError(ex, "Failed to persist workflow {WorkflowId}", definition.Id);
369  ✔    9             }
370  ✔  183         }
371             
372                 private IWorkflowRepository? GetRepository()
373  ✔  466         {
374  ✔  466             return _serviceProvider.GetService<IWorkflowRepository>();
375  ✔  464         }
376             
377                 private async Task TryExecuteNodeActionAsync(WorkflowDefinition definition, string workflowId, WorkflowNode node)
378  ✔  261         {
379                     try
380  ✔  261             {
381  ✔  261                 var executed = await _actionExecutor.ExecuteAsync(workflowId, node, definition);
382  ✔  478  ●              if (!executed) return;
383             
384                         // If executed and there is a single outgoing transition, advance automatically
385  ✔   80                 var outgoing = definition.Transitions.Where(t => t.FromNodeId == node.Id).ToList();
386  ✔   40  ●              if (outgoing.Count == 1)
387  ✔   40                 {
388  ✔   40                     var next = outgoing[0].ToNodeId;
389  ✔   40                     _instanceManager.SetCurrentNode(workflowId, next);
390  ✔   40                     await PersistCurrentNodeAsync(workflowId, next);
391  ✔   38                 }
392  ✔   38             }
393  ✔    2             catch (Exception ex)
394  ✔    2             {
395  ✔    2                 _logger.LogWarning(ex, "Error executing action for node {NodeId}", node.Id);
396  ✔    2             }
397  ✔  259         }
398             }
```
# FWH.Common.Workflow.DependencyExtensions

## Summary

|||
|:---|:---|
| Class: | FWH.Common.Workflow.DependencyExtensions |
| Assembly: | FWH.Common.Workflow |
| **File(s):** | E:\github\FunWasHad\src\FWH.Common.Workflow\DependencyExtensions.cs |
| **Line coverage:** | 0% (0 of 5) |
| Covered lines: | 0 |
| Uncovered lines: | 5 |
| Coverable lines: | 5 |
| Total lines: | 14 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **AddWorkflowService(...)** | 100% | 2 | 1 | 0% |

## File(s)

### E:\github\FunWasHad\src\FWH.Common.Workflow\DependencyExtensions.cs
```
 1           using FWH.Common.Workflow.Controllers;
 2           using Microsoft.Extensions.DependencyInjection;
 3           
 4           namespace FWH.Common.Workflow;
 5           
 6           public static class DependencyExtensions
 7           {
 8               public static IServiceCollection AddWorkflowService(this IServiceCollection services)
 9  ❌ 0         {
10  ❌ 0             services.AddSingleton<WorkflowService>();
11  ❌ 0             services.AddSingleton<WorkflowController>();
12  ❌ 0             return services;
13  ❌ 0         }
14           }
```
# FWH.Common.Workflow.Extensions.WorkflowServiceCollectionExtensions

## Summary

|||
|:---|:---|
| Class: | FWH.Common.Workflow.Extensions.WorkflowServiceCollectionExtensions |
| Assembly: | FWH.Common.Workflow |
| **File(s):** | E:\github\FunWasHad\src\FWH.Common.Workflow\Extensions\WorkflowServiceCollectionExtensions.cs |
| **Line coverage:** | 72.9% (35 of 48) |
| Covered lines: | 35 |
| Uncovered lines: | 13 |
| Coverable lines: | 48 |
| Total lines: | 143 |
| **Branch coverage:** | 100% (4 of 4) |
| Covered branches: | 4 |
| Total branches: | 4 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **AddWorkflowServices(...)** | 100% | 2 | 2 | 100% |
| **AddWorkflowActionHandler(...)** | 100% | 1 | 1 | 100% |
| **AddWorkflowActionHandler(...)** | 100% | 1 | 1 | 100% |
| **AddWorkflowActionHandler(...)** | 100% | 2 | 2 | 100% |
| **AddWorkflowDefinitionStore(...)** | 100% | 2 | 1 | 0% |
| **AddWorkflowInstanceManager(...)** | 100% | 2 | 1 | 0% |
| **InitializeWorkflowActionHandlers(...)** | 100% | 2 | 1 | 0% |

## File(s)

### E:\github\FunWasHad\src\FWH.Common.Workflow\Extensions\WorkflowServiceCollectionExtensions.cs
```
  1            using System;
  2            using System.Collections.Generic;
  3            using FWH.Common.Workflow.Actions;
  4            using FWH.Common.Workflow.Controllers;
  5            using FWH.Common.Workflow.Instance;
  6            using FWH.Common.Workflow.Logging;
  7            using FWH.Common.Workflow.Mapping;
  8            using FWH.Common.Workflow.Models;
  9            using FWH.Common.Workflow.State;
 10            using FWH.Common.Workflow.Storage;
 11            using FWH.Common.Workflow.Views;
 12            using FWH.Orchestrix.Contracts.Mediator;
 13            using FWH.Orchestrix.Mediator.Remote.Extensions;
 14            using Microsoft.Extensions.DependencyInjection;
 15            using Microsoft.Extensions.Logging;
 16            using Microsoft.Extensions.Options;
 17            
 18            namespace FWH.Common.Workflow.Extensions;
 19            
 20            /// <summary>
 21            /// Extension methods for registering workflow services with dependency injection.
 22            /// Single Responsibility: Configure DI for workflow components.
 23            /// </summary>
 24            public static class WorkflowServiceCollectionExtensions
 25            {
 26                /// <summary>
 27                /// Adds all workflow services to the service collection.
 28                /// Includes definition store, instance manager, mapper, state calculator, controller, service, and view.
 29                /// </summary>
 30                /// <param name="services">The service collection to add services to.</param>
 31                /// <returns>The service collection for chaining.</returns>
 32                public static IServiceCollection AddWorkflowServices(this IServiceCollection services, WorkflowActionExecutorOptions
 33  ✔  56         {
 34                    // Logging infrastructure
 35  ✔  56             services.AddSingleton<ICorrelationIdService, CorrelationIdService>();
 36            
 37                    // Core workflow components (SRP-compliant with Controller pattern)
 38  ✔  56             services.AddSingleton<IWorkflowDefinitionStore, InMemoryWorkflowDefinitionStore>();
 39  ✔  56             services.AddSingleton<IWorkflowInstanceManager, InMemoryWorkflowInstanceManager>();
 40  ✔  56             services.AddSingleton<IWorkflowModelMapper, WorkflowModelMapper>();
 41  ✔  56             services.AddSingleton<IWorkflowStateCalculator, WorkflowStateCalculator>();
 42            
 43                    // Handler registry and executor
 44  ✔  56             services.AddSingleton<IWorkflowActionHandlerRegistry, WorkflowActionHandlerRegistry>();
 45  ✔  56             services.AddSingleton<WorkflowActionHandlerRegistrar>();
 46            
 47  ✔  56  ●          var opts = executorOptions ?? new WorkflowActionExecutorOptions();
 48  ✔  96             services.AddSingleton<IWorkflowActionExecutor>(sp => new WorkflowActionExecutor(sp,
 49  ✔  96                                                                                             sp.GetRequiredService<IMediatorS
 50  ✔  96                                                                                             Options.Create(opts),
 51  ✔  96                                                                                             sp.GetService<Microsoft.Extensio
 52            
 53                    // Controller and service
 54  ✔  56             services.AddSingleton<IWorkflowController, WorkflowController>();
 55  ✔  56             services.AddSingleton<IWorkflowService, WorkflowService>();
 56            
 57                    // View (transient for multiple workflow instances)
 58  ✔  56             services.AddTransient<IWorkflowView, WorkflowView>();
 59            
 60  ✔  56             services.AddRemoteMediatorHandlers();
 61  ✔  56             services.AddTransient<IMediatorHandler<WorkflowActionRequest, WorkflowActionResponse>, WorkflowActionRequestHand
 62            
 63  ✔  56             return services;
 64  ✔  56         }
 65            
 66                /// <summary>
 67                /// Register an action handler instance with a name.
 68                /// </summary>
 69                public static IServiceCollection AddWorkflowActionHandler(this IServiceCollection services, IWorkflowActionHandler h
 70  ✔  11         {
 71                    // Register the handler as a singleton so it will be discovered by the registrar
 72  ✔  11             services.AddSingleton<IWorkflowActionHandler>(handler);
 73  ✔  11             services.AddSingleton(handler.GetType(), handler);
 74  ✔  11             return services;
 75  ✔  11         }
 76            
 77                /// <summary>
 78                /// Register an action handler delegate by name. Convenience overload.
 79                /// </summary>
 80                public static IServiceCollection AddWorkflowActionHandler(this IServiceCollection services, string name, System.Func
 81  ✔  11         {
 82  ✔  11             var adapter = new WorkflowActionHandlerAdapter(name, handler);
 83  ✔  11             services.AddWorkflowActionHandler(adapter);
 84  ✔  11             return services;
 85  ✔  11         }
 86            
 87                /// <summary>
 88                /// Register an action handler type (scoped) where THandler implements IWorkflowActionHandler.
 89                /// The registry will register a factory that resolves the handler from the IServiceProvider so scoped services can 
 90                /// </summary>
 91                public static IServiceCollection AddWorkflowActionHandler<THandler>(this IServiceCollection services)
 92                    where THandler : class, IWorkflowActionHandler
 93  ✔   1         {
 94  ✔   1             services.AddScoped<THandler>();
 95                    // Register factory with registry at startup via IServiceProvider; we store a descriptor in DI so registrar can 
 96  ✔   4  ●          services.AddSingleton<Func<IServiceProvider, IWorkflowActionHandler>>(sp => (provider) => provider.GetRequiredSe
 97                    // We also register a small marker to allow registrar to pick it up: register a factory that registrar can find 
 98  ✔   1             return services;
 99  ✔   1         }
100            
101                /// <summary>
102                /// Adds workflow definition store to the service collection.
103                /// </summary>
104                /// <typeparam name="TStore">The implementation type for the definition store.</typeparam>
105                /// <param name="services">The service collection to add services to.</param>
106                /// <returns>The service collection for chaining.</returns>
107                public static IServiceCollection AddWorkflowDefinitionStore<TStore>(this IServiceCollection services)
108                    where TStore : class, IWorkflowDefinitionStore
109  ❌  0         {
110  ❌  0             services.AddSingleton<IWorkflowDefinitionStore, TStore>();
111  ❌  0             return services;
112  ❌  0         }
113            
114                /// <summary>
115                /// Adds workflow instance manager to the service collection.
116                /// </summary>
117                /// <typeparam name="TManager">The implementation type for the instance manager.</typeparam>
118                /// <param name="services">The service collection to add services to.</param>
119                /// <returns>The service collection for chaining.</returns>
120                public static IServiceCollection AddWorkflowInstanceManager<TManager>(this IServiceCollection services)
121                    where TManager : class, IWorkflowInstanceManager
122  ❌  0         {
123  ❌  0             services.AddSingleton<IWorkflowInstanceManager, TManager>();
124  ❌  0             return services;
125  ❌  0         }
126            
127                /// <summary>
128                /// Initializes the workflow action handler registry by resolving the registrar.
129                /// This must be called after the service provider is built to ensure handlers are registered.
130                /// </summary>
131                /// <param name="serviceProvider">The built service provider.</param>
132                /// <returns>The service provider for chaining.</returns>
133                public static IServiceProvider InitializeWorkflowActionHandlers(this IServiceProvider serviceProvider)
134  ❌  0         {
135  ❌  0             ArgumentNullException.ThrowIfNull(serviceProvider);
136            
137                    // Resolving the registrar triggers its constructor, which discovers and registers all handlers
138  ❌  0             _ = serviceProvider.GetRequiredService<WorkflowActionHandlerRegistrar>();
139            
140  ❌  0             return serviceProvider;
141  ❌  0         }
142            }
143            
```
# FWH.Common.Workflow.Instance.InMemoryWorkflowInstanceManager

## Summary

|||
|:---|:---|
| Class: | FWH.Common.Workflow.Instance.InMemoryWorkflowInstanceManager |
| Assembly: | FWH.Common.Workflow |
| **File(s):** | E:\github\FunWasHad\src\FWH.Common.Workflow\Instance\InMemoryWorkflowInstanceManager.cs |
| **Line coverage:** | 96.4% (27 of 28) |
| Covered lines: | 27 |
| Uncovered lines: | 1 |
| Coverable lines: | 28 |
| Total lines: | 58 |
| **Branch coverage:** | 71.4% (10 of 14) |
| Covered branches: | 10 |
| Total branches: | 14 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **.ctor()** | 100% | 1 | 1 | 100% |
| **GetCurrentNode(...)** | 50.0% | 4 | 4 | 100% |
| **SetCurrentNode(...)** | 50.0% | 2 | 2 | 80.0% |
| **ClearCurrentNode(...)** | 100% | 2 | 2 | 100% |
| **GetVariables(...)** | 50.0% | 2 | 2 | 100% |
| **SetVariable(...)** | 100% | 4 | 4 | 100% |

## File(s)

### E:\github\FunWasHad\src\FWH.Common.Workflow\Instance\InMemoryWorkflowInstanceManager.cs
```
 1             using System;
 2             using System.Collections.Concurrent;
 3             using System.Collections.Generic;
 4             
 5             namespace FWH.Common.Workflow.Instance;
 6             
 7             /// <summary>
 8             /// Thread-safe in-memory implementation of workflow instance state management.
 9             /// Single Responsibility: Track current node and variables for workflow instances in memory.
10             /// </summary>
11             public class InMemoryWorkflowInstanceManager : IWorkflowInstanceManager
12             {
13  ✔   62         private readonly ConcurrentDictionary<string, string?> _currentNodeByWorkflow = new(StringComparer.Ordinal);
14  ✔   62         private readonly ConcurrentDictionary<string, ConcurrentDictionary<string,string>> _vars = new(StringComparer.Ordina
15             
16                 public string? GetCurrentNode(string workflowId)
17  ✔  392         {
18  ✓  392  ◑          if (string.IsNullOrWhiteSpace(workflowId)) return null;
19  ✓  392  ◑          return _currentNodeByWorkflow.TryGetValue(workflowId, out var node) ? node : null;
20  ✔  392         }
21             
22                 public void SetCurrentNode(string workflowId, string? nodeId)
23  ✔  283         {
24  ✓  283  ◑          if (string.IsNullOrWhiteSpace(workflowId))
25  ❌   0                 throw new ArgumentNullException(nameof(workflowId));
26             
27  ✔  283             _currentNodeByWorkflow[workflowId] = nodeId;
28  ✔  283         }
29             
30                 public void ClearCurrentNode(string workflowId)
31  ✔    6         {
32  ✔    6  ●          if (string.IsNullOrWhiteSpace(workflowId)) return;
33  ✔    6             _currentNodeByWorkflow.TryRemove(workflowId, out _);
34  ✔    6         }
35             
36                 public IDictionary<string,string>? GetVariables(string workflowId)
37  ✔  216         {
38  ✓  216  ◑          if (string.IsNullOrWhiteSpace(workflowId)) return null;
39             
40                     // Use GetOrAdd to atomically get or create the dictionary
41  ✔  216             var variables = _vars.GetOrAdd(workflowId, _ =>
42  ✔  256                 new ConcurrentDictionary<string, string>(StringComparer.OrdinalIgnoreCase));
43             
44  ✔  216             return variables;
45  ✔  216         }
46             
47                 public void SetVariable(string workflowId, string key, string value)
48  ✔  305         {
49  ✔  305  ●          if (string.IsNullOrWhiteSpace(workflowId)) return;
50  ✔  305  ●          if (string.IsNullOrWhiteSpace(key)) return;
51             
52                     // Use GetOrAdd to atomically get or create the dictionary
53  ✔  305             var variables = _vars.GetOrAdd(workflowId, _ =>
54  ✔  319                 new ConcurrentDictionary<string, string>(StringComparer.OrdinalIgnoreCase));
55             
56  ✔  305             variables[key] = value;
57  ✔  305         }
58             }
```
# FWH.Common.Workflow.Logging.CorrelationIdService

## Summary

|||
|:---|:---|
| Class: | FWH.Common.Workflow.Logging.CorrelationIdService |
| Assembly: | FWH.Common.Workflow |
| **File(s):** | E:\github\FunWasHad\src\FWH.Common.Workflow\Logging\CorrelationIdService.cs |
| **Line coverage:** | 69.2% (9 of 13) |
| Covered lines: | 9 |
| Uncovered lines: | 4 |
| Coverable lines: | 13 |
| Total lines: | 51 |
| **Branch coverage:** | 100% (2 of 2) |
| Covered branches: | 2 |
| Total branches: | 2 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **.cctor()** | 100% | 1 | 1 | 100% |
| **GetCorrelationId()** | 100% | 2 | 2 | 100% |
| **SetCorrelationId(...)** | 100% | 2 | 1 | 0% |
| **GenerateCorrelationId()** | 100% | 1 | 1 | 100% |

## File(s)

### E:\github\FunWasHad\src\FWH.Common.Workflow\Logging\CorrelationIdService.cs
```
 1             using System;
 2             
 3             namespace FWH.Common.Workflow.Logging;
 4             
 5             /// <summary>
 6             /// Service for managing correlation IDs across the application.
 7             /// Correlation IDs help trace requests/operations through logs.
 8             /// </summary>
 9             public interface ICorrelationIdService
10             {
11                 /// <summary>
12                 /// Gets the current correlation ID for this execution context.
13                 /// </summary>
14                 string GetCorrelationId();
15             
16                 /// <summary>
17                 /// Sets a new correlation ID for this execution context.
18                 /// </summary>
19                 void SetCorrelationId(string correlationId);
20             
21                 /// <summary>
22                 /// Generates a new correlation ID.
23                 /// </summary>
24                 string GenerateCorrelationId();
25             }
26             
27             /// <summary>
28             /// Thread-safe implementation of correlation ID service using AsyncLocal.
29             /// </summary>
30             public class CorrelationIdService : ICorrelationIdService
31             {
32  ✔    3         private static readonly AsyncLocal<string?> _correlationId = new();
33             
34                 public string GetCorrelationId()
35  ✔  624         {
36  ✔  624  ●          return _correlationId.Value ?? GenerateCorrelationId();
37  ✔  624         }
38             
39                 public void SetCorrelationId(string correlationId)
40  ❌   0         {
41  ❌   0             ArgumentNullException.ThrowIfNull(correlationId);
42  ❌   0             _correlationId.Value = correlationId;
43  ❌   0         }
44             
45                 public string GenerateCorrelationId()
46  ✔  221         {
47  ✔  221             var newId = Guid.NewGuid().ToString("N");
48  ✔  221             _correlationId.Value = newId;
49  ✔  221             return newId;
50  ✔  221         }
51             }
```
# FWH.Common.Workflow.Logging.LoggerExtensions

## Summary

|||
|:---|:---|
| Class: | FWH.Common.Workflow.Logging.LoggerExtensions |
| Assembly: | FWH.Common.Workflow |
| **File(s):** | E:\github\FunWasHad\src\FWH.Common.Workflow\Logging\LoggerExtensions.cs |
| **Line coverage:** | 98.7% (79 of 80) |
| Covered lines: | 79 |
| Uncovered lines: | 1 |
| Coverable lines: | 80 |
| Total lines: | 148 |
| **Branch coverage:** | 95% (19 of 20) |
| Covered branches: | 19 |
| Total branches: | 20 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **BeginCorrelatedScope(...)** | 83.33% | 6 | 6 | 100% |
| **LogOperationStart(...)** | 100% | 4 | 4 | 100% |
| **LogOperationComplete(...)** | 100% | 4 | 4 | 100% |
| **LogOperationFailure(...)** | 100% | 6 | 6 | 100% |
| **Dispose()** | 100% | 2 | 1 | 0% |

## File(s)

### E:\github\FunWasHad\src\FWH.Common.Workflow\Logging\LoggerExtensions.cs
```
  1              using Microsoft.Extensions.Logging;
  2              using System;
  3              using System.Collections.Generic;
  4              
  5              namespace FWH.Common.Workflow.Logging;
  6              
  7              /// <summary>
  8              /// Extension methods for structured logging with correlation IDs.
  9              /// </summary>
 10              public static class LoggerExtensions
 11              {
 12                  /// <summary>
 13                  /// Begins a logging scope with correlation ID and additional properties.
 14                  /// </summary>
 15                  /// <param name="logger">The logger instance</param>
 16                  /// <param name="correlationIdService">Service to get correlation ID</param>
 17                  /// <param name="operation">Name of the operation being performed</param>
 18                  /// <param name="additionalProperties">Additional properties to include in scope</param>
 19                  /// <returns>Disposable scope</returns>
 20                  public static IDisposable BeginCorrelatedScope(
 21                      this ILogger logger,
 22                      ICorrelationIdService correlationIdService,
 23                      string operation,
 24                      IDictionary<string, object>? additionalProperties = null)
 25  ✔   221         {
 26  ✔   221             var properties = new Dictionary<string, object>
 27  ✔   221             {
 28  ✔   221                 ["CorrelationId"] = correlationIdService.GetCorrelationId(),
 29  ✔   221                 ["Operation"] = operation,
 30  ✔   221                 ["Timestamp"] = DateTime.UtcNow
 31  ✔   221             };
 32              
 33  ✔   221  ●          if (additionalProperties != null)
 34  ✔   221             {
 35  ✔  1469  ●              foreach (var kvp in additionalProperties)
 36  ✔   403                 {
 37  ✔   403                     properties[kvp.Key] = kvp.Value;
 38  ✔   403                 }
 39  ✔   221             }
 40              
 41  ✓   221  ◑          return logger.BeginScope(properties) ?? new NullDisposable();
 42  ✔   221         }
 43              
 44                  /// <summary>
 45                  /// Logs an operation start with correlation ID.
 46                  /// </summary>
 47                  public static void LogOperationStart(
 48                      this ILogger logger,
 49                      ICorrelationIdService correlationIdService,
 50                      string operation,
 51                      IDictionary<string, object>? properties = null)
 52  ✔   182         {
 53  ✔   182             var allProperties = new Dictionary<string, object>
 54  ✔   182             {
 55  ✔   182                 ["CorrelationId"] = correlationIdService.GetCorrelationId(),
 56  ✔   182                 ["Operation"] = operation,
 57  ✔   182                 ["Phase"] = "Start"
 58  ✔   182             };
 59              
 60  ✔   182  ●          if (properties != null)
 61  ✔   182             {
 62  ✔   922  ●              foreach (var kvp in properties)
 63  ✔   188                 {
 64  ✔   188                     allProperties[kvp.Key] = kvp.Value;
 65  ✔   188                 }
 66  ✔   182             }
 67              
 68  ✔   182             using (logger.BeginScope(allProperties))
 69  ✔   182             {
 70  ✔   182                 logger.LogInformation("Operation started: {Operation}", operation);
 71  ✔   182             }
 72  ✔   182         }
 73              
 74                  /// <summary>
 75                  /// Logs an operation completion with correlation ID and duration.
 76                  /// </summary>
 77                  public static void LogOperationComplete(
 78                      this ILogger logger,
 79                      ICorrelationIdService correlationIdService,
 80                      string operation,
 81                      TimeSpan duration,
 82                      IDictionary<string, object>? properties = null)
 83  ✔   219         {
 84  ✔   219             var allProperties = new Dictionary<string, object>
 85  ✔   219             {
 86  ✔   219                 ["CorrelationId"] = correlationIdService.GetCorrelationId(),
 87  ✔   219                 ["Operation"] = operation,
 88  ✔   219                 ["Phase"] = "Complete",
 89  ✔   219                 ["DurationMs"] = duration.TotalMilliseconds
 90  ✔   219             };
 91              
 92  ✔   219  ●          if (properties != null)
 93  ✔   219             {
 94  ✔  1959  ●              foreach (var kvp in properties)
 95  ✔   651                 {
 96  ✔   651                     allProperties[kvp.Key] = kvp.Value;
 97  ✔   651                 }
 98  ✔   219             }
 99              
100  ✔   219             using (logger.BeginScope(allProperties))
101  ✔   219             {
102  ✔   219                 logger.LogInformation("Operation completed: {Operation} in {DurationMs}ms", operation, duration.TotalMillise
103  ✔   219             }
104  ✔   219         }
105              
106                  /// <summary>
107                  /// Logs an operation failure with correlation ID, duration, and exception.
108                  /// </summary>
109                  public static void LogOperationFailure(
110                      this ILogger logger,
111                      ICorrelationIdService correlationIdService,
112                      string operation,
113                      Exception exception,
114                      TimeSpan? duration = null,
115                      IDictionary<string, object>? properties = null)
116  ✔     2         {
117  ✔     2             var allProperties = new Dictionary<string, object>
118  ✔     2             {
119  ✔     2                 ["CorrelationId"] = correlationIdService.GetCorrelationId(),
120  ✔     2                 ["Operation"] = operation,
121  ✔     2                 ["Phase"] = "Failed",
122  ✔     2                 ["ErrorType"] = exception.GetType().Name
123  ✔     2             };
124              
125  ✔     2  ●          if (duration.HasValue)
126  ✔     2             {
127  ✔     2                 allProperties["DurationMs"] = duration.Value.TotalMilliseconds;
128  ✔     2             }
129              
130  ✔     2  ●          if (properties != null)
131  ✔     2             {
132  ✔    10  ●              foreach (var kvp in properties)
133  ✔     2                 {
134  ✔     2                     allProperties[kvp.Key] = kvp.Value;
135  ✔     2                 }
136  ✔     2             }
137              
138  ✔     2             using (logger.BeginScope(allProperties))
139  ✔     2             {
140  ✔     2                 logger.LogError(exception, "Operation failed: {Operation}", operation);
141  ✔     2             }
142  ✔     2         }
143              
144                  private sealed class NullDisposable : IDisposable
145                  {
146  ❌    0             public void Dispose() { }
147                  }
148              }
```
# FWH.Common.Workflow.Logging.LoggerHelpers

## Summary

|||
|:---|:---|
| Class: | FWH.Common.Workflow.Logging.LoggerHelpers |
| Assembly: | FWH.Common.Workflow |
| **File(s):** | E:\github\FunWasHad\src\FWH.Common.Workflow\Logging\LoggerHelpers.cs |
| **Line coverage:** | 78.5% (11 of 14) |
| Covered lines: | 11 |
| Uncovered lines: | 3 |
| Coverable lines: | 14 |
| Total lines: | 31 |
| **Branch coverage:** | 83.3% (5 of 6) |
| Covered branches: | 5 |
| Total branches: | 6 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **ResolveLogger(...)** | 83.33% | 6 | 6 | 78.57% |

## File(s)

### E:\github\FunWasHad\src\FWH.Common.Workflow\Logging\LoggerHelpers.cs
```
 1            using System;
 2            using Microsoft.Extensions.Logging;
 3            using Microsoft.Extensions.DependencyInjection;
 4            
 5            namespace FWH.Common.Workflow.Logging;
 6            
 7            public static class LoggerHelpers
 8            {
 9                /// <summary>
10                /// Resolve an ILogger&lt;T&gt; instance using the provided explicit logger, the service provider, or a NullLogger f
11                /// This centralizes the null-logger pattern so callers don't duplicate the same logic.
12                /// </summary>
13                public static ILogger<T> ResolveLogger<T>(IServiceProvider? serviceProvider, ILogger<T>? explicitLogger = null)
14  ✔  19         {
15  ✔  37  ●          if (explicitLogger != null) return explicitLogger;
16  ✔   1  ●          if (serviceProvider != null)
17  ✔   1             {
18                        try
19  ✔   1                 {
20  ✔   1                     var logger = serviceProvider.GetService<ILogger<T>>();
21  ✓   1  ◑                  if (logger != null) return logger;
22  ✔   1                 }
23  ❌  0                 catch
24  ❌  0                 {
25                            // ignore resolution errors and fall back to NullLogger
26  ❌  0                 }
27  ✔   1             }
28            
29  ✔   1             return Microsoft.Extensions.Logging.Abstractions.NullLogger<T>.Instance;
30  ✔  19         }
31            }
```
# FWH.Common.Workflow.Logging.ScopeValidator

## Summary

|||
|:---|:---|
| Class: | FWH.Common.Workflow.Logging.ScopeValidator |
| Assembly: | FWH.Common.Workflow |
| **File(s):** | E:\github\FunWasHad\src\FWH.Common.Workflow\Logging\ScopeValidator.cs |
| **Line coverage:** | 92.8% (13 of 14) |
| Covered lines: | 13 |
| Uncovered lines: | 1 |
| Coverable lines: | 14 |
| Total lines: | 43 |
| **Branch coverage:** | 50% (9 of 18) |
| Covered branches: | 9 |
| Total branches: | 18 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **ContainsKeys(...)** | 50.0% | 8 | 8 | 100% |
| **AnyScopeContainsKeys(...)** | 50.0% | 8 | 8 | 100% |
| **EnsureAnyScopeContainsKeys(...)** | 50.0% | 2 | 2 | 75.00% |

## File(s)

### E:\github\FunWasHad\src\FWH.Common.Workflow\Logging\ScopeValidator.cs
```
 1             using System;
 2             using System.Collections.Generic;
 3             using System.Linq;
 4             
 5             namespace FWH.Common.Workflow.Logging;
 6             
 7             /// <summary>
 8             /// Small runtime helpers to validate structured logging scopes.
 9             /// Intended for tests and diagnostic checks where the logging provider exposes
10             /// parsed scope dictionaries (e.g. TestLoggerProvider).
11             /// </summary>
12             public static class ScopeValidator
13             {
14                 /// <summary>
15                 /// Return true when the provided scope dictionary contains all requested keys
16                 /// and none of the corresponding values are null.
17                 /// </summary>
18                 public static bool ContainsKeys(IDictionary<string, object?> scope, params string[] keys)
19  ✔   59         {
20  ✓   59  ◑          if (scope is null) throw new ArgumentNullException(nameof(scope));
21  ✓   59  ◑          if (keys is null || keys.Length == 0) return true;
22  ✓  130  ◑          return keys.All(k => scope.ContainsKey(k) && scope[k] != null);
23  ✔   59         }
24             
25                 /// <summary>
26                 /// Return true when any of the provided scope dictionaries contains all requested keys.
27                 /// </summary>
28                 public static bool AnyScopeContainsKeys(IEnumerable<IDictionary<string, object?>> scopes, params string[] keys)
29  ✔    1         {
30  ✓    1  ◑          if (scopes is null) throw new ArgumentNullException(nameof(scopes));
31  ✓    1  ◑          if (keys is null || keys.Length == 0) return true;
32  ✓    2  ◑          return scopes.Any(s => s != null && ContainsKeys(s, keys));
33  ✔    1         }
34             
35                 /// <summary>
36                 /// Throws InvalidOperationException when no scope contains the requested keys. Useful inside tests.
37                 /// </summary>
38                 public static void EnsureAnyScopeContainsKeys(IEnumerable<IDictionary<string, object?>> scopes, params string[] keys
39  ✔    1         {
40  ✓    1  ◑          if (!AnyScopeContainsKeys(scopes, keys))
41  ❌   0                 throw new InvalidOperationException($"No scope contains required keys: {string.Join(",", keys)}");
42  ✔    1         }
43             }
```
# FWH.Common.Workflow.Mapping.WorkflowModelMapper

## Summary

|||
|:---|:---|
| Class: | FWH.Common.Workflow.Mapping.WorkflowModelMapper |
| Assembly: | FWH.Common.Workflow |
| **File(s):** | E:\github\FunWasHad\src\FWH.Common.Workflow\Mapping\WorkflowModelMapper.cs |
| **Line coverage:** | 100% (35 of 35) |
| Covered lines: | 35 |
| Uncovered lines: | 0 |
| Coverable lines: | 35 |
| Total lines: | 57 |
| **Branch coverage:** | 77.7% (14 of 18) |
| Covered branches: | 14 |
| Total branches: | 18 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **ToDataModel(...)** | 77.77% | 18 | 18 | 100% |

## File(s)

### E:\github\FunWasHad\src\FWH.Common.Workflow\Mapping\WorkflowModelMapper.cs
```
 1              using System;
 2              using System.Linq;
 3              using FWH.Common.Workflow.Models;
 4              using DataModels = FWH.Mobile.Data.Models;
 5              
 6              namespace FWH.Common.Workflow.Mapping;
 7              
 8              /// <summary>
 9              /// Maps workflow models between domain and data layers.
10              /// Single Responsibility: Model conversion logic.
11              /// </summary>
12              public class WorkflowModelMapper : IWorkflowModelMapper
13              {
14                  public DataModels.WorkflowDefinitionEntity ToDataModel(WorkflowDefinition def)
15  ✔   183         {
16  ✓   183  ◑          if (def == null) throw new ArgumentNullException(nameof(def));
17              
18  ✓   183  ◑          var data = new DataModels.WorkflowDefinitionEntity
19  ✔   183             {
20  ✔   183                 Id = string.IsNullOrWhiteSpace(def.Id) ? Guid.NewGuid().ToString() : def.Id,
21  ✔   183                 Name = def.Name ?? string.Empty,
22  ✔   183                 CreatedAt = DateTime.UtcNow
23  ✔   183             };
24              
25  ✔  1315  ●          foreach (var n in def.Nodes)
26  ✔   383             {
27  ✔   383                 data.Nodes.Add(new DataModels.NodeEntity
28  ✔   383                 {
29  ✔   383                     NodeId = n.Id,
30  ✔   383                     Text = n.Label
31  ✔   383                 });
32  ✔   383             }
33              
34  ✔  1003  ●          foreach (var t in def.Transitions)
35  ✔   227             {
36  ✔   227                 data.Transitions.Add(new DataModels.TransitionEntity
37  ✔   227                 {
38  ✔   227                     FromNodeId = t.FromNodeId,
39  ✔   227                     ToNodeId = t.ToNodeId,
40  ✔   227                     Condition = t.Condition
41  ✔   227                 });
42  ✔   227             }
43              
44  ✔   901  ●          foreach (var s in def.StartPoints)
45  ✔   176             {
46  ✔   176                 data.StartPoints.Add(new DataModels.StartPointEntity
47  ✔   176                 {
48  ✔   176                     NodeId = s.NodeId
49  ✔   176                 });
50  ✔   176             }
51              
52                      // Set initial current node as the start point if available
53  ✓   183  ◕          data.CurrentNodeId = def.StartPoints.FirstOrDefault()?.NodeId ?? def.Nodes.FirstOrDefault()?.Id;
54              
55  ✔   183             return data;
56  ✔   183         }
57              }
```
# FWH.Common.Workflow.Models.StartPoint

## Summary

|||
|:---|:---|
| Class: | FWH.Common.Workflow.Models.StartPoint |
| Assembly: | FWH.Common.Workflow |
| **File(s):** | E:\github\FunWasHad\src\FWH.Common.Workflow\Models\StartPoint.cs |
| **Line coverage:** | 100% (1 of 1) |
| Covered lines: | 1 |
| Uncovered lines: | 0 |
| Coverable lines: | 1 |
| Total lines: | 3 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **get_NodeId()** | 100% | 1 | 1 | 100% |

## File(s)

### E:\github\FunWasHad\src\FWH.Common.Workflow\Models\StartPoint.cs
```
1             namespace FWH.Common.Workflow.Models;
2             
3  ✔  944     public record StartPoint(string NodeId);
```
# FWH.Common.Workflow.Models.Transition

## Summary

|||
|:---|:---|
| Class: | FWH.Common.Workflow.Models.Transition |
| Assembly: | FWH.Common.Workflow |
| **File(s):** | E:\github\FunWasHad\src\FWH.Common.Workflow\Models\Transition.cs |
| **Line coverage:** | 100% (1 of 1) |
| Covered lines: | 1 |
| Uncovered lines: | 0 |
| Coverable lines: | 1 |
| Total lines: | 3 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **get_Id()** | 100% | 1 | 1 | 100% |

## File(s)

### E:\github\FunWasHad\src\FWH.Common.Workflow\Models\Transition.cs
```
1              namespace FWH.Common.Workflow.Models;
2              
3  ✔  3666     public record Transition(string Id, string FromNodeId, string ToNodeId, string? Condition = null);
```
# FWH.Common.Workflow.Models.WorkflowDefinition

## Summary

|||
|:---|:---|
| Class: | FWH.Common.Workflow.Models.WorkflowDefinition |
| Assembly: | FWH.Common.Workflow |
| **File(s):** | E:\github\FunWasHad\src\FWH.Common.Workflow\Models\WorkflowDefinition.cs |
| **Line coverage:** | 100% (6 of 6) |
| Covered lines: | 6 |
| Uncovered lines: | 0 |
| Coverable lines: | 6 |
| Total lines: | 10 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **.ctor(...)** | 100% | 1 | 1 | 100% |
| **get_Id()** | 100% | 1 | 1 | 100% |
| **get_Name()** | 100% | 1 | 1 | 100% |
| **get_Nodes()** | 100% | 1 | 1 | 100% |
| **get_Transitions()** | 100% | 1 | 1 | 100% |
| **get_StartPoints()** | 100% | 1 | 1 | 100% |

## File(s)

### E:\github\FunWasHad\src\FWH.Common.Workflow\Models\WorkflowDefinition.cs
```
 1              using System.Collections.Generic;
 2              
 3              namespace FWH.Common.Workflow.Models;
 4              
 5  ✔   272     public record WorkflowDefinition(
 6  ✔  2174         string Id,
 7  ✔   187         string Name,
 8  ✔  1460         IReadOnlyList<WorkflowNode> Nodes,
 9  ✔   960         IReadOnlyList<Transition> Transitions,
10  ✔  1013         IReadOnlyList<StartPoint> StartPoints);
```
# FWH.Common.Workflow.Models.WorkflowNode

## Summary

|||
|:---|:---|
| Class: | FWH.Common.Workflow.Models.WorkflowNode |
| Assembly: | FWH.Common.Workflow |
| **File(s):** | E:\github\FunWasHad\src\FWH.Common.Workflow\Models\WorkflowNode.cs |
| **Line coverage:** | 100% (1 of 1) |
| Covered lines: | 1 |
| Uncovered lines: | 0 |
| Coverable lines: | 1 |
| Total lines: | 4 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **get_Id()** | 100% | 1 | 1 | 100% |

## File(s)

### E:\github\FunWasHad\src\FWH.Common.Workflow\Models\WorkflowNode.cs
```
1                 namespace FWH.Common.Workflow.Models;
2                 
3                 // Added JsonMetadata as a new property to hold structured JSON attached to a node (left-side of note).
4  ✔  1510134     public record WorkflowNode(string Id, string Label, string? JsonMetadata = null, string? NoteMarkdown = null);
```
# FWH.Common.Workflow.Models.WorkflowStateModel

## Summary

|||
|:---|:---|
| Class: | FWH.Common.Workflow.Models.WorkflowStateModel |
| Assembly: | FWH.Common.Workflow |
| **File(s):** | E:\github\FunWasHad\src\FWH.Common.Workflow\Models\WorkflowStateModel.cs |
| **Line coverage:** | 0% (0 of 3) |
| Covered lines: | 0 |
| Uncovered lines: | 3 |
| Coverable lines: | 3 |
| Total lines: | 13 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **.ctor()** | 100% | 2 | 1 | 0% |
| **TryGetWorkflow(...)** | 100% | 2 | 1 | 0% |
| **AddOrUpdateWorkflow(...)** | 100% | 2 | 1 | 0% |

## File(s)

### E:\github\FunWasHad\src\FWH.Common.Workflow\Models\WorkflowStateModel.cs
```
 1           using System.Collections.Concurrent;
 2           using CommunityToolkit.Mvvm.ComponentModel;
 3           
 4           namespace FWH.Common.Workflow.Models;
 5           
 6           public partial class WorkflowStateModel : ObservableObject
 7           {
 8  ❌ 0         private ConcurrentDictionary<string, WorkflowModel> Workflows = new();
 9           
10  ❌ 0         public bool TryGetWorkflow(string id, out WorkflowModel? model) => Workflows.TryGetValue(id, out model);
11           
12  ❌ 0         public void AddOrUpdateWorkflow(string id, WorkflowModel model) => Workflows[id] = model;
13           }
```
# FWH.Common.Workflow.PlantUmlParser

## Summary

|||
|:---|:---|
| Class: | FWH.Common.Workflow.PlantUmlParser |
| Assembly: | FWH.Common.Workflow |
| **File(s):** | E:\github\FunWasHad\src\FWH.Common.Workflow\PlantUmlParser.cs |
| **Line coverage:** | 87.7% (336 of 383) |
| Covered lines: | 336 |
| Uncovered lines: | 47 |
| Coverable lines: | 383 |
| Total lines: | 539 |
| **Branch coverage:** | 86% (136 of 158) |
| Covered branches: | 136 |
| Total branches: | 158 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **.ctor(...)** | 100% | 10 | 10 | 100% |
| **Parse(...)** | 92.10% | 118 | 114 | 93.15% |
| **SplitAndAttachMetadata(...)** | 25.00% | 11 | 4 | 25.00% |
| **NormalizeLabel(...)** | 100% | 4 | 4 | 100% |
| **CreateSyntheticNode(...)** | 100% | 1 | 1 | 100% |
| **GetOrCreateNode(...)** | 50.0% | 16 | 10 | 60.86% |
| **MakeId(...)** | 50.0% | 4 | 4 | 100% |
| **AttachNoteToNode(...)** | 75.00% | 4 | 4 | 100% |
| **AddTransition(...)** | 75.00% | 8 | 8 | 90.0% |
| **get_DecisionNodeId()** | 100% | 1 | 1 | 100% |
| **get_ConditionText()** | 100% | 2 | 1 | 0% |
| **get_Branches()** | 100% | 1 | 1 | 100% |
| **.ctor(...)** | 100% | 1 | 1 | 100% |
| **get_Label()** | 100% | 1 | 1 | 100% |
| **get_EntryNodeId()** | 100% | 1 | 1 | 100% |
| **get_LastNodeId()** | 100% | 1 | 1 | 100% |
| **get_ConditionText()** | 100% | 1 | 1 | 100% |
| **.ctor(...)** | 100% | 1 | 1 | 100% |
| **get_LoopEntryNodeId()** | 100% | 1 | 1 | 100% |
| **get_ConditionText()** | 100% | 1 | 1 | 100% |
| **get_FirstNodeId()** | 100% | 1 | 1 | 100% |
| **get_LastNodeId()** | 100% | 1 | 1 | 100% |
| **.ctor(...)** | 100% | 1 | 1 | 100% |
| **get_Transitions()** | 100% | 2 | 1 | 0% |
| **get_StartPoints()** | 100% | 2 | 1 | 0% |
| **get_Nodes()** | 100% | 2 | 1 | 0% |

## File(s)

### E:\github\FunWasHad\src\FWH.Common.Workflow\PlantUmlParser.cs
```
  1                 using System;
  2                 using System.Collections.Generic;
  3                 using System.Linq;
  4                 using System.Text.RegularExpressions;
  5                 using System.Text.Json;
  6                 using FWH.Common.Workflow.Models;
  7                 
  8                 namespace FWH.Common.Workflow;
  9                 
 10                 public sealed class PlantUmlParser
 11                 {
 12                     private readonly List<string> lines;
 13  ✔      217         private readonly Dictionary<string, WorkflowNode> nodes = new(StringComparer.Ordinal); // keyed by node.Id
 14  ✔      217         private readonly List<Transition> transitions = new();
 15  ✔      217         private readonly List<StartPoint> startPoints = new();
 16  ✔      217         private int idx = 0;
 17                 
 18                     // store some global elements encountered
 19  ✔      217         private readonly Dictionary<string, string?> skinparams = new(StringComparer.OrdinalIgnoreCase);
 20  ✔      217         private readonly List<(string Name, string? Value)> pragmas = new();
 21  ✔      217         private readonly List<string> styleBlocks = new();
 22                 
 23  ✔      217         public PlantUmlParser(string plantUmlText)
 24  ✔      217         {
 25  ✔      218  ●          if (plantUmlText is null) throw new ArgumentNullException(nameof(plantUmlText));
 26                 
 27  ✔      216             lines = plantUmlText
 28  ✔      216                 .Split(new[] { '\r', '\n' }, StringSplitOptions.RemoveEmptyEntries)
 29  ✔     3614                 .Select(l => l.Trim())
 30  ✔     3614  ●              .Where(l => l.Length > 0
 31  ✔     3614                             && !l.StartsWith("@startuml", StringComparison.OrdinalIgnoreCase)
 32  ✔     3614                             && !l.StartsWith("@enduml", StringComparison.OrdinalIgnoreCase)
 33  ✔     3614                             && !l.StartsWith("'")
 34  ✔     3614                             && !l.StartsWith("//"))
 35  ✔      216                 .ToList();
 36  ✔      216         }
 37                 
 38                     public WorkflowDefinition Parse(string? id = null, string? name = null)
 39  ✔      265         {
 40  ✔      265             var currentNodeId = default(string);
 41  ✔      265             var ifStack = new Stack<IfFrame>();
 42  ✔      265             var loopStack = new Stack<LoopFrame>();
 43                 
 44  ✔     6372  ●          for (int i = 0; i < lines.Count; i++)
 45  ✔     2921             {
 46  ✔     2921                 var rawLine = lines[i];
 47                 
 48                             // handle style block
 49  ✔     2921  ●              if (Regex.IsMatch(rawLine, "^<style\\b", RegexOptions.IgnoreCase))
 50  ✔        1                 {
 51  ✔        1                     var j = i;
 52  ✔        1                     var blockLines = new List<string>();
 53  ✔        9  ●                  for (; j < lines.Count; j++)
 54  ✔        5                     {
 55  ✔        5                         blockLines.Add(lines[j]);
 56  ✔        5  ●                      if (Regex.IsMatch(lines[j], "</style>", RegexOptions.IgnoreCase))
 57  ✔        1                             break;
 58  ✔        4                     }
 59                 
 60  ✔        1                     styleBlocks.Add(string.Join('\n', blockLines));
 61  ✔        1                     i = j;
 62  ✔        1                     continue;
 63                             }
 64                 
 65                             // handle skinparam: skinparam Name Value ;
 66  ✔     2920                 var skinMatch = Regex.Match(rawLine, "^skinparam\\s+(\\S+)\\s+(.*?);?$", RegexOptions.IgnoreCase);
 67  ✔     2920  ●              if (skinMatch.Success)
 68  ✔        2                 {
 69  ✔        2                     var nameKey = skinMatch.Groups[1].Value.Trim();
 70  ✔        2                     var value = skinMatch.Groups[2].Value.Trim();
 71  ✔        2                     skinparams[nameKey] = value;
 72  ✔        2                     continue;
 73                             }
 74                 
 75                             // handle pragma: !pragma name [value]
 76  ✔     2918                 var pragmaMatch = Regex.Match(rawLine, "^!\\s*pragma\\s+(\\S+)(?:\\s+(.*))?$", RegexOptions.IgnoreCase);
 77  ✔     2918  ●              if (pragmaMatch.Success)
 78  ✔        1                 {
 79  ✔        1                     var pName = pragmaMatch.Groups[1].Value.Trim();
 80  ✓        1  ◑                  var pVal = pragmaMatch.Groups[2].Success ? pragmaMatch.Groups[2].Value.Trim() : null;
 81  ✔        1                     pragmas.Add((pName, pVal));
 82  ✔        1                     continue;
 83                             }
 84                 
 85                             // handle inline note (same as before)
 86                             // Support shorthand inline note (e.g. `note right: <text>`) which attaches to the most recently created nod
 87  ✔     2917                 var shorthandNoteMatch = Regex.Match(rawLine, @"^note\s+(left|right|top|bottom)?\s*:\s*(.*)$", RegexOptions.
 88  ✔     2917  ●              if (shorthandNoteMatch.Success)
 89  ✔       64                 {
 90  ✔       64                     var noteText = shorthandNoteMatch.Groups[2].Value.Trim();
 91  ✔       64  ●                  if (!string.IsNullOrEmpty(noteText) && currentNodeId != null && nodes.TryGetValue(currentNodeId, out var
 92  ✔       36                     {
 93                                     // check for JSON|Markdown split
 94  ✔       36                         SplitAndAttachMetadata(currentNodeId, targetNode, noteText);
 95  ✔       36                     }
 96                 
 97  ✔       64                     continue;
 98                             }
 99                 
100  ✔     2853                 var inlineNoteMatch = Regex.Match(rawLine, @"^note\s+(left|right|top|bottom)?\s*(?:of\s+)?(.+?)\s*:\s*(.*)$"
101  ✔     2853  ●              if (inlineNoteMatch.Success)
102  ✔        1                 {
103  ✔        1                     var targetRaw = inlineNoteMatch.Groups[2].Value.Trim();
104  ✔        1                     var noteText = inlineNoteMatch.Groups[3].Value.Trim();
105  ✔        1                     AttachNoteToNode(targetRaw, noteText);
106  ✔        1                     continue;
107                             }
108                 
109                             // block note
110  ✔     2852                 var blockNoteMatch = Regex.Match(rawLine, @"^note\s+(left|right|top|bottom)?\s*(?:of\s+)?(.+?)$", RegexOptio
111  ✔     2852  ●              if (blockNoteMatch.Success)
112  ✔       30                 {
113  ✔       30                     var targetRaw = blockNoteMatch.Groups[2].Value.Trim();
114                                 // collect following lines until 'end note'
115  ✔       30                     var noteLines = new List<string>();
116  ✔       30                     int j = i + 1;
117  ✔      264  ●                  for (; j < lines.Count; j++)
118  ✔      147                     {
119  ✔      147  ●                      if (Regex.IsMatch(lines[j], "^end ?note;?$", RegexOptions.IgnoreCase))
120  ✔       30                         {
121  ✔       30                             break;
122                                     }
123  ✔      117                         noteLines.Add(lines[j]);
124  ✔      117                     }
125                 
126  ✔       30                     var noteText = string.Join('\n', noteLines).Trim();
127  ✔       30                     AttachNoteToNode(targetRaw, noteText);
128                 
129                                 // advance index to the line with end note (or last collected)
130  ✔       30                     i = j;
131  ✔       30                     continue;
132                             }
133                 
134                             // handle start/stop/end keywords
135  ✔     2822  ●              if (Regex.IsMatch(rawLine, "^start;?$", RegexOptions.IgnoreCase))
136  ✔       17                 {
137  ✔       17                     var nid = GetOrCreateNode("Start");
138  ✔       17                     startPoints.Add(new StartPoint(nid));
139  ✔       17                     currentNodeId = nid;
140  ✔       17                     continue;
141                             }
142                 
143  ✔     2805  ●              if (Regex.IsMatch(rawLine, "^(stop|end);?$", RegexOptions.IgnoreCase))
144  ✔       17                 {
145  ✔       17                     var nid = GetOrCreateNode("Stop");
146  ✔       17  ●                  if (currentNodeId != null)
147  ✔       17                     {
148  ✔       17                         AddTransition(currentNodeId, nid);
149  ✔       17                     }
150  ✔       17                     currentNodeId = nid;
151  ✔       17                     continue;
152                             }
153                 
154                             // broadened if handling: allow optional is()/equals() between condition and then
155  ✔     2788                 var ifMatch = Regex.Match(rawLine, @"^if\s*\((.*?)\)\s*(?:is\s*\((.*?)\)\s*|equals\s*\((.*?)\)\s*)?then(?:\s
156  ✔     2788  ●              if (ifMatch.Success)
157  ✔       24                 {
158  ✔       24                     var condition = ifMatch.Groups[1].Value.Trim();
159  ✔       24  ●                  var label = ifMatch.Groups[4].Success ? ifMatch.Groups[4].Value.Trim() : null;
160                 
161  ✔       24                     var decisionId = CreateSyntheticNode($"if: {condition}");
162  ✔       24  ●                  if (currentNodeId != null)
163  ✔       19                     {
164  ✔       19                         AddTransition(currentNodeId, decisionId);
165  ✔       19                         currentNodeId = null;
166  ✔       19                     }
167                 
168  ✔       24                     var frame = new IfFrame(decisionId, condition);
169  ✔       24                     frame.Branches[0].ConditionText = condition;
170  ✔       24                     frame.Branches[0].Label = label;
171  ✔       24                     ifStack.Push(frame);
172  ✔       24                     continue;
173                             }
174                 
175  ✔     2764                 var elseIfMatch = Regex.Match(rawLine, @"^else\s*(?:if\s*\((.*?)\)\s*then)?(?:\s*\((.*?)\))?$", RegexOptions
176                             // fallback original elseif handling
177  ✔     2764  ●              if (!elseIfMatch.Success)
178  ✔     2739                 {
179  ✔     2739                     elseIfMatch = Regex.Match(rawLine, @"^else\\s*(?:if\\s*\\((.*?)\\)\\s*then)?(?:\\s*\\((.*?)\\))?$", Rege
180  ✔     2739                 }
181                 
182  ✔     2764  ●              if (elseIfMatch.Success && ifStack.Count > 0)
183  ✔       25                 {
184  ✔       25  ●                  var cond = elseIfMatch.Groups[1].Success ? elseIfMatch.Groups[1].Value.Trim() : "else";
185  ✓       25  ◑                  var label = elseIfMatch.Groups[2].Success ? elseIfMatch.Groups[2].Value.Trim() : null;
186  ✔       25                     var currentFrame = ifStack.Peek();
187  ✔       25                     currentFrame.Branches.Add(new Branch(label) { ConditionText = cond });
188  ✔       25                     continue;
189                             }
190                 
191  ✔     2739  ●              if (Regex.IsMatch(rawLine, "^endif;?$", RegexOptions.IgnoreCase) && ifStack.Count > 0)
192  ✔       22                 {
193  ✔       22                     var frame = ifStack.Pop();
194  ✔       22                     var joinId = CreateSyntheticNode("join");
195  ✔      160  ●                  foreach (var br in frame.Branches)
196  ✔       47                     {
197  ✓       47  ◑                      if (br.EntryNodeId == null)
198  ❌       0                         {
199  ❌       0                             AddTransition(frame.DecisionNodeId, joinId, br.ConditionText);
200  ❌       0                         }
201  ✓       47  ◑                      else if (br.LastNodeId != null)
202  ✔       47                         {
203  ✔       47                             AddTransition(br.LastNodeId, joinId);
204  ✔       47                         }
205                                     else
206  ❌       0                         {
207  ❌       0                             AddTransition(br.EntryNodeId, joinId);
208  ❌       0                         }
209  ✔       47                     }
210                 
211  ✔       22                     currentNodeId = joinId;
212  ✔       22                     continue;
213                             }
214                 
215  ✔     2717  ●              if (Regex.IsMatch(rawLine, "^repeat$", RegexOptions.IgnoreCase))
216  ✔        9                 {
217  ✔        9                     var loopEntryId = CreateSyntheticNode("loop_entry");
218  ✔        9  ●                  if (currentNodeId != null)
219  ✔        5                     {
220  ✔        5                         AddTransition(currentNodeId, loopEntryId);
221  ✔        5                         currentNodeId = null;
222  ✔        5                     }
223                 
224  ✔        9                     var lf = new LoopFrame(loopEntryId);
225  ✔        9                     loopStack.Push(lf);
226  ✔        9                     continue;
227                             }
228                 
229  ✔     2708                 var repeatWhileMatch = Regex.Match(rawLine, "^repeat\\s+while\\s*\\((.*?)\\);?$", RegexOptions.IgnoreCase);
230  ✔     2708  ●              if (repeatWhileMatch.Success && loopStack.Count > 0)
231  ✔        7                 {
232  ✔        7                     var cond = repeatWhileMatch.Groups[1].Value.Trim();
233  ✔        7                     var lf = loopStack.Pop();
234  ✔        7                     lf.ConditionText = cond;
235                 
236  ✔        7                     var afterLoopId = CreateSyntheticNode("after_loop");
237                 
238  ✓        7  ◑                  if (lf.LastNodeId == null)
239  ❌       0                     {
240  ❌       0                         AddTransition(lf.LoopEntryNodeId, afterLoopId);
241  ❌       0                     }
242                                 else
243  ✔        7                     {
244  ✔        7                         AddTransition(lf.LastNodeId, lf.LoopEntryNodeId, cond);
245  ✔        7                         AddTransition(lf.LastNodeId, afterLoopId);
246  ✔        7                     }
247                 
248  ✔        7                     currentNodeId = afterLoopId;
249  ✔        7                     continue;
250                             }
251                 
252                             // arrow handling (unchanged)
253  ✔     2701                 var arrowMatch = Regex.Match(rawLine, "(.*?)\\s*(-{1,2}>\\s*|<-{1,2}\\s*)(.*)");
254  ✔     2701  ●              if (arrowMatch.Success)
255  ✔     1312                 {
256  ✔     1312                     var leftRaw = Regex.Replace(arrowMatch.Groups[1].Value.Trim(), "\"[^\"]*\"", string.Empty).Trim();
257  ✔     1312                     var rightRaw = Regex.Replace(arrowMatch.Groups[3].Value.Trim(), "\"[^\"]*\"", string.Empty).Trim();
258                 
259  ✔     1312  ●                  if (leftRaw == "[*]")
260  ✔      219                     {
261  ✔      219                         var targetId = GetOrCreateNode(rightRaw);
262  ✔      219                         startPoints.Add(new StartPoint(targetId));
263  ✔      219                         currentNodeId = targetId;
264  ✔      219                         continue;
265                                 }
266                 
267  ✔     1093                     var fromId = GetOrCreateNode(leftRaw);
268  ✔     1093                     var toId = GetOrCreateNode(rightRaw);
269  ✔     1093                     AddTransition(fromId, toId);
270  ✔     1093                     currentNodeId = toId;
271  ✔     1093                     continue;
272                             }
273                 
274                             // action with optional color: [#color]? :text;
275  ✔     1389                 var actionMatch = Regex.Match(rawLine, "^(?:#(?<color>[^:\\s]+)\\s*)?:(?<text>.*?);?$");
276  ✔     1389  ●              if (actionMatch.Success)
277  ✔     1372                 {
278  ✔     1372                     var label = actionMatch.Groups["text"].Value.Trim();
279  ✔     1372                     var nodeId = GetOrCreateNode(label);
280                 
281  ✔     1372  ●                  if (ifStack.Count > 0)
282  ✔       50                     {
283  ✔       50                         var frame = ifStack.Peek();
284  ✔       50                         var branch = frame.Branches.Last();
285                 
286  ✔       50  ●                      if (branch.EntryNodeId == null)
287  ✔       49                         {
288  ✔       49                             AddTransition(frame.DecisionNodeId, nodeId, branch.ConditionText);
289  ✔       49                             branch.EntryNodeId = nodeId;
290  ✔       49                             branch.LastNodeId = nodeId;
291  ✔       49                         }
292                                     else
293  ✔        1                         {
294  ✔        1                             AddTransition(branch.LastNodeId!, nodeId);
295  ✔        1                             branch.LastNodeId = nodeId;
296  ✔        1                         }
297  ✔       50                     }
298  ✔     1322  ●                  else if (loopStack.Count > 0)
299  ✔       10                     {
300  ✔       10                         var lf = loopStack.Peek();
301  ✔       10  ●                      if (lf.FirstNodeId == null)
302  ✔        9                         {
303  ✔        9                             AddTransition(lf.LoopEntryNodeId, nodeId);
304  ✔        9                             lf.FirstNodeId = nodeId;
305  ✔        9                             lf.LastNodeId = nodeId;
306  ✔        9                         }
307                                     else
308  ✔        1                         {
309  ✔        1                             AddTransition(lf.LastNodeId!, nodeId);
310  ✔        1                             lf.LastNodeId = nodeId;
311  ✔        1                         }
312  ✔       10                     }
313                                 else
314  ✔     1312                     {
315  ✔     1312  ●                      if (currentNodeId != null)
316  ✔     1291                         {
317  ✔     1291                             AddTransition(currentNodeId, nodeId);
318  ✔     1291                         }
319                 
320  ✔     1312                         currentNodeId = nodeId;
321  ✔     1312                     }
322                 
323                                 // sdl-stereotype detection inline e.g. <<input>>; just ignore or attach to node as note
324  ✔     1372                     var stereoMatch = Regex.Match(rawLine, "<<\\s*(\\w+)\\s*>>");
325  ✔     1372  ●                  if (stereoMatch.Success)
326  ✔        2                     {
327  ✔        2                         var stereo = stereoMatch.Groups[1].Value.Trim();
328  ✓        2  ◑                      if (nodes.TryGetValue(nodeId, out var node) && node != null)
329  ✔        2                         {
330                                         // preserve existing JsonMetadata while appending note text
331  ✔        2  ●                          nodes[nodeId] = new WorkflowNode(node.Id, node.Label, node.JsonMetadata, (node.NoteMarkdown ?? s
332  ✔        2                         }
333  ✔        2                     }
334                 
335  ✔     1372                     continue;
336                             }
337                 
338                             // ignore unknown or unhandled constructs for now
339  ✔       17             }
340                 
341                         // close open frames (unchanged)
342  ✔      267  ●          while (ifStack.Count > 0)
343  ✔        2             {
344  ✔        2                 var frame = ifStack.Pop();
345  ✔        2                 var joinId = CreateSyntheticNode("join");
346  ✔       10  ●              foreach (var br in frame.Branches)
347  ✔        2                 {
348  ✓        2  ◑                  if (br.EntryNodeId == null)
349  ❌       0                     {
350  ❌       0                         AddTransition(frame.DecisionNodeId, joinId, br.ConditionText);
351  ❌       0                     }
352  ✓        2  ◑                  else if (br.LastNodeId != null)
353  ✔        2                     {
354  ✔        2                         AddTransition(br.LastNodeId, joinId);
355  ✔        2                     }
356                                 else
357  ❌       0                     {
358  ❌       0                         AddTransition(br.EntryNodeId, joinId);
359  ❌       0                     }
360  ✔        2                 }
361                 
362  ✔        2                 currentNodeId = joinId;
363  ✔        2             }
364                 
365  ✔      267  ●          while (loopStack.Count > 0)
366  ✔        2             {
367  ✔        2                 var lf = loopStack.Pop();
368  ✔        2                 var afterLoopId = CreateSyntheticNode("after_loop");
369  ✓        2  ◑              if (lf.LastNodeId == null)
370  ❌       0                 {
371  ❌       0                     AddTransition(lf.LoopEntryNodeId, afterLoopId);
372  ❌       0                 }
373                             else
374  ✔        2                 {
375  ✔        2                     AddTransition(lf.LastNodeId, lf.LoopEntryNodeId, lf.ConditionText);
376  ✔        2                     AddTransition(lf.LastNodeId, afterLoopId);
377  ✔        2                 }
378                 
379  ✔        2                 currentNodeId = afterLoopId;
380  ✔        2             }
381                 
382  ✔      265             var nodeList = nodes.Values.ToList();
383                 
384  ✔      265  ●          return new WorkflowDefinition(id ?? Guid.NewGuid().ToString("D"), name ?? "ImportedWorkflow", nodeList, transiti
385  ✔      265         }
386                 
387                     private void SplitAndAttachMetadata(string nodeId, WorkflowNode targetNode, string noteText)
388  ✔       36         {
389                         // If the note contains a pipe '|' split, treat left side as JSON metadata and right side as note markdown.
390  ✔       36             var parts = noteText.Split(new[] { '|' }, 2);
391  ✓       36  ◑          if (parts.Length == 2)
392  ❌       0             {
393  ❌       0                 var left = parts[0].Trim();
394  ❌       0                 var right = parts[1].Trim();
395                 
396                             // Validate left side is JSON object; if not, attach whole note as markdown
397                             try
398  ❌       0                 {
399  ❌       0                     using var doc = JsonDocument.Parse(left);
400  ❌       0  ○                  if (doc.RootElement.ValueKind == JsonValueKind.Object)
401  ❌       0                     {
402  ❌       0                         var jsonStr = left; // preserve original json string
403  ❌       0                         nodes[nodeId] = new WorkflowNode(targetNode.Id, targetNode.Label, jsonStr, right);
404  ❌       0                         return;
405                                 }
406  ❌       0                 }
407  ❌       0                 catch (JsonException)
408  ❌       0                 {
409                                 // not JSON - fallthrough
410  ❌       0                 }
411  ❌       0             }
412                 
413                         // No pipe or invalid JSON - attach as normal note markdown, preserving existing JsonMetadata
414  ✔       36             nodes[nodeId] = new WorkflowNode(targetNode.Id, targetNode.Label, targetNode.JsonMetadata, noteText);
415  ✔       36         }
416                 
417                     private static string NormalizeLabel(string raw)
418  ✔     3842         {
419  ✔     3842             raw = raw.Trim();
420  ✔     3862  ●          if (raw.StartsWith(":")) raw = raw[1..].Trim();
421  ✔     3852  ●          if (raw.EndsWith(";")) raw = raw[..^1].Trim();
422  ✔     3842             return raw;
423  ✔     3842         }
424                 
425                     private string CreateSyntheticNode(string label)
426  ✔       66         {
427  ✔       66             var nid = MakeId(label, idx++);
428  ✔       66             var node = new WorkflowNode(nid, label);
429  ✔       66             nodes[nid] = node;
430  ✔       66             return node.Id;
431  ✔       66         }
432                 
433                     private string GetOrCreateNode(string token)
434  ✔     3842         {
435  ✔     3842             token = token.Trim();
436  ✓     3842  ◑          if (token == "[*]")
437  ❌       0             {
438                             const string key = "[*]";
439  ❌       0  ○              if (!nodes.ContainsKey(key))
440  ❌       0                 {
441  ❌       0                     nodes[key] = new WorkflowNode(key, "[*]");
442  ❌       0                 }
443                 
444  ❌       0                 return nodes[key].Id;
445                         }
446                 
447  ✔     3842             var label = NormalizeLabel(token);
448                         // find existing node by label
449  ✔  1504438             var existing = nodes.Values.FirstOrDefault(n => string.Equals(n.Label, label, StringComparison.Ordinal));
450  ✔     6256  ●          if (existing != null) return existing.Id;
451                 
452                         string nid;
453                         // If possible use the label itself as the node id for simpler IDs (keeps tests expecting plain labels)
454  ✓     1428  ◑          if (!string.IsNullOrEmpty(label) && !nodes.ContainsKey(label))
455  ✔     1428             {
456  ✔     1428                 nid = label;
457  ✔     1428             }
458                         else
459  ❌       0             {
460  ❌       0                 nid = MakeId(label, idx++);
461  ❌       0             }
462                 
463  ✔     1428             var node = new WorkflowNode(nid, label);
464  ✔     1428             nodes[nid] = node;
465  ✔     1428             return node.Id;
466  ✔     3842         }
467                 
468                     private static string MakeId(string label, int index)
469  ✔       66         {
470  ✓       66  ◑          var s = Regex.Replace(label ?? string.Empty, @"\s+", "_");
471  ✔       66             s = Regex.Replace(s, @"[^A-Za-z0-9_]+", "_");
472  ✓       66  ◑          if (string.IsNullOrEmpty(s)) s = $"node_{index}";
473  ✔       66             return $"{s}_{index}";
474  ✔       66         }
475                 
476                     private void AttachNoteToNode(string targetRaw, string noteText)
477  ✔       31         {
478  ✔       31             var targetId = GetOrCreateNode(targetRaw);
479  ✓       31  ◑          if (nodes.TryGetValue(targetId, out var node) && node != null)
480  ✔       31             {
481                             // replace existing node record (with note) while preserving any JsonMetadata
482  ✔       31                 nodes[targetId] = new WorkflowNode(node.Id, node.Label, node.JsonMetadata, noteText);
483  ✔       31             }
484  ✔       31         }
485                 
486                     // helper to add transitions but avoid self-transitions without a condition
487                     private void AddTransition(string fromId, string toId, string? condition = null)
488  ✔     2552         {
489  ✓     2552  ◑          if (string.IsNullOrWhiteSpace(fromId) || string.IsNullOrWhiteSpace(toId)) return;
490  ✔     2552  ●          if (string.Equals(fromId, toId, StringComparison.Ordinal))
491  ✔     1234             {
492                             // don't add a self-transition unless a condition/criteria is provided
493  ✓     1234  ◑              if (string.IsNullOrWhiteSpace(condition))
494  ✔     1234                     return;
495  ❌       0             }
496                 
497  ✔     1318             var tid = $"t_{transitions.Count}";
498  ✔     1318             transitions.Add(new Transition(tid, fromId, toId, condition));
499  ✔     2552         }
500                 
501                     private sealed class IfFrame
502                     {
503  ✔       49             public string DecisionNodeId { get; }
504  ❌       0             public string ConditionText { get; }
505  ✔      195             public List<Branch> Branches { get; } = new();
506                 
507  ✔       24             public IfFrame(string decisionNodeId, string conditionText)
508  ✔       24             {
509  ✔       24                 DecisionNodeId = decisionNodeId;
510  ✔       24                 ConditionText = conditionText;
511  ✔       24                 Branches.Add(new Branch(conditionText));
512  ✔       24             }
513                     }
514                 
515                     private sealed class Branch
516                     {
517  ✔       73             public string? Label { get; set; }
518  ✔      148             public string? EntryNodeId { get; set; }
519  ✔      149             public string? LastNodeId { get; set; }
520  ✔       98             public string? ConditionText { get; set; }
521                 
522  ✔       98             public Branch(string? label) => Label = label;
523                     }
524                 
525                     private sealed class LoopFrame
526                     {
527  ✔       18             public string LoopEntryNodeId { get; }
528  ✔        9             public string? ConditionText { get; set; }
529  ✔       19             public string? FirstNodeId { get; set; }
530  ✔       38             public string? LastNodeId { get; set; }
531                 
532  ✔       18             public LoopFrame(string loopEntryNodeId) => LoopEntryNodeId = loopEntryNodeId;
533                     }
534                 
535                     // Expose parse results for testing convenience
536  ❌       0         public IReadOnlyList<Transition> Transitions => transitions;
537  ❌       0         public IReadOnlyList<StartPoint> StartPoints => startPoints;
538  ❌       0         public IReadOnlyList<WorkflowNode> Nodes => nodes.Values.ToList();
539                 }
```
# FWH.Common.Workflow.State.WorkflowStateCalculator

## Summary

|||
|:---|:---|
| Class: | FWH.Common.Workflow.State.WorkflowStateCalculator |
| Assembly: | FWH.Common.Workflow |
| **File(s):** | E:\github\FunWasHad\src\FWH.Common.Workflow\State\WorkflowStateCalculator.cs |
| **Line coverage:** | 87.3% (62 of 71) |
| Covered lines: | 62 |
| Uncovered lines: | 9 |
| Coverable lines: | 71 |
| Total lines: | 113 |
| **Branch coverage:** | 73.4% (47 of 64) |
| Covered branches: | 47 |
| Total branches: | 64 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **.ctor(...)** | 50.0% | 2 | 2 | 100% |
| **CalculateStartNode(...)** | 79.16% | 25 | 24 | 88.46% |
| **CalculateCurrentPayload(...)** | 68.42% | 49 | 38 | 80.48% |

## File(s)

### E:\github\FunWasHad\src\FWH.Common.Workflow\State\WorkflowStateCalculator.cs
```
  1             using System;
  2             using System.Linq;
  3             using Microsoft.Extensions.Logging;
  4             using FWH.Common.Workflow.Models;
  5             using System.Text.Json;
  6             
  7             namespace FWH.Common.Workflow.State;
  8             
  9             /// <summary>
 10             /// Calculates workflow state and transitions.
 11             /// Single Responsibility: State calculation logic.
 12             /// </summary>
 13             public class WorkflowStateCalculator : IWorkflowStateCalculator
 14             {
 15                 private readonly ILogger<WorkflowStateCalculator> _logger;
 16             
 17  ✔   51         public WorkflowStateCalculator(ILogger<WorkflowStateCalculator> logger)
 18  ✔   51         {
 19  ✓   51  ◑          _logger = logger ?? Microsoft.Extensions.Logging.Abstractions.NullLogger<WorkflowStateCalculator>.Instance;
 20  ✔   51         }
 21             
 22                 public string? CalculateStartNode(WorkflowDefinition definition)
 23  ✔  184         {
 24  ✓  184  ◑          if (definition == null) throw new ArgumentNullException(nameof(definition));
 25             
 26  ✓  184  ◕          var start = definition.StartPoints.FirstOrDefault()?.NodeId ?? definition.Nodes.FirstOrDefault()?.Id;
 27             
 28  ✔  184  ●          if (!string.IsNullOrWhiteSpace(start))
 29  ✔  184             {
 30  ✔  419                 var outgoing = definition.Transitions.Where(t => t.FromNodeId == start).ToList();
 31             
 32                         // Only auto-advance if the start node is literally named "start" (case-insensitive)
 33                         // or if it's an implicit start point without a label
 34  ✔  368                 var startNode = definition.Nodes.FirstOrDefault(n => n.Id == start);
 35  ✔  184  ●              var shouldAutoAdvance = startNode == null ||
 36  ✔  184                                        string.Equals(startNode.Label, "start", StringComparison.OrdinalIgnoreCase) ||
 37  ✔  184                                        string.IsNullOrWhiteSpace(startNode.Label);
 38             
 39  ✔  184  ●              if (shouldAutoAdvance && outgoing.Count == 1)
 40  ✔   23                 {
 41  ✔   23                     var targetId = outgoing[0].ToNodeId;
 42  ✔   69                     var targetNode = definition.Nodes.FirstOrDefault(n => n.Id == targetId);
 43             
 44  ✓   23  ◑                  if (targetNode != null)
 45  ✔   23                     {
 46  ✓   23  ◑                      if (targetNode.Label?.StartsWith("if:", StringComparison.OrdinalIgnoreCase) == true)
 47  ✔    3                         {
 48  ✔    3                             _logger.LogDebug("Advanced to decision node {NodeId}", targetId);
 49  ✔    3                             return targetId;
 50                                 }
 51             
 52  ✔   20                         _logger.LogDebug("Advanced to first action node {NodeId}", targetId);
 53  ✔   20                         return targetId;
 54                             }
 55  ❌   0                 }
 56  ✔  161             }
 57             
 58  ✔  161             return start;
 59  ✔  184         }
 60             
 61                 public WorkflowStatePayload CalculateCurrentPayload(WorkflowDefinition definition, string? currentNodeId)
 62  ✔  115         {
 63  ✓  115  ◑          if (definition == null) throw new ArgumentNullException(nameof(definition));
 64             
 65  ✔  341             var node = definition.Nodes.FirstOrDefault(n => n.Id == currentNodeId);
 66  ✔  474             var outgoing = definition.Transitions.Where(t => t.FromNodeId == currentNodeId).ToList();
 67             
 68  ✔  141  ●          var isChoice = outgoing.Count > 1 || outgoing.Any(t => !string.IsNullOrWhiteSpace(t.Condition));
 69             
 70  ✔  115  ●          if (isChoice)
 71  ✔   36             {
 72  ✔   36                 var choices = outgoing.Select((t, idx) =>
 73  ✔   72                 {
 74  ✔  308                     var target = definition.Nodes.FirstOrDefault(n => n.Id == t.ToNodeId);
 75  ✓   72  ◑                  var display = target?.Label ?? t.ToNodeId;
 76  ✔   72                     return new WorkflowChoiceOption(idx, display, t.ToNodeId, t.Condition);
 77  ✔  108                 }).ToList();
 78             
 79  ✓   36  ◑              return new WorkflowStatePayload(true, node?.NoteMarkdown, choices, node?.Label);
 80                     }
 81             
 82                     // If the node contains a JSON action in the note, detect and present a concise action hint
 83  ✔   79             string? text = null;
 84  ✓   79  ◑          if (!string.IsNullOrWhiteSpace(node?.NoteMarkdown))
 85  ✔   15             {
 86  ✔   15                 var note = node!.NoteMarkdown!.Trim();
 87  ✔   15  ●              if (note.StartsWith('{') && note.EndsWith('}'))
 88  ✔    9                 {
 89                             try
 90  ✔    9                     {
 91  ✔    9                         using var doc = JsonDocument.Parse(note);
 92  ✓    9  ◑                      if (doc.RootElement.ValueKind == JsonValueKind.Object && doc.RootElement.TryGetProperty("action", ou
 93  ✔    9                         {
 94  ✔    9                             var actionName = actionProp.GetString();
 95  ✓    9  ◑                          text = actionName != null ? $"Action: {actionName}" : node.NoteMarkdown;
 96  ✔    9                         }
 97                                 else
 98  ❌   0                         {
 99  ❌   0                             text = node.NoteMarkdown;
100  ❌   0                         }
101  ✔    9                     }
102  ❌   0                     catch (JsonException ex)
103  ❌   0                     {
104  ❌   0                         _logger.LogDebug(ex, "Failed to parse JSON action in node {NodeId}", node.Id);
105  ❌   0                         text = node.NoteMarkdown;
106  ❌   0                     }
107  ✔    9                 }
108  ✔   15             }
109             
110  ✓   79  ◑          text ??= !string.IsNullOrWhiteSpace(node?.NoteMarkdown) ? node!.NoteMarkdown : node?.Label;
111  ✓   79  ◑          return new WorkflowStatePayload(false, text, Array.Empty<WorkflowChoiceOption>(), node?.Label);
112  ✔  115         }
113             }
```
# FWH.Common.Workflow.Storage.InMemoryWorkflowDefinitionStore

## Summary

|||
|:---|:---|
| Class: | FWH.Common.Workflow.Storage.InMemoryWorkflowDefinitionStore |
| Assembly: | FWH.Common.Workflow |
| **File(s):** | E:\github\FunWasHad\src\FWH.Common.Workflow\Storage\InMemoryWorkflowDefinitionStore.cs |
| **Line coverage:** | 69.2% (9 of 13) |
| Covered lines: | 9 |
| Uncovered lines: | 4 |
| Coverable lines: | 13 |
| Total lines: | 32 |
| **Branch coverage:** | 50% (4 of 8) |
| Covered branches: | 4 |
| Total branches: | 8 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **.ctor()** | 100% | 1 | 1 | 100% |
| **Store(...)** | 50.0% | 2 | 2 | 100% |
| **Get(...)** | 75.00% | 4 | 4 | 100% |
| **Exists(...)** | 0% | 6 | 2 | 0% |

## File(s)

### E:\github\FunWasHad\src\FWH.Common.Workflow\Storage\InMemoryWorkflowDefinitionStore.cs
```
 1             using System;
 2             using System.Collections.Concurrent;
 3             using FWH.Common.Workflow.Models;
 4             
 5             namespace FWH.Common.Workflow.Storage;
 6             
 7             /// <summary>
 8             /// Thread-safe in-memory implementation of workflow definition storage.
 9             /// Single Responsibility: Store workflow definitions in memory with concurrent access support.
10             /// </summary>
11             public class InMemoryWorkflowDefinitionStore : IWorkflowDefinitionStore
12             {
13  ✔   52         private readonly ConcurrentDictionary<string, WorkflowDefinition> _definitions = new(StringComparer.Ordinal);
14             
15                 public void Store(WorkflowDefinition definition)
16  ✔  233         {
17  ✓  233  ◑          if (definition == null) throw new ArgumentNullException(nameof(definition));
18  ✔  233             _definitions[definition.Id] = definition;
19  ✔  233         }
20             
21                 public WorkflowDefinition? Get(string workflowId)
22  ✔  595         {
23  ✓  595  ◑          if (string.IsNullOrWhiteSpace(workflowId)) return null;
24  ✔  595  ●          return _definitions.TryGetValue(workflowId, out var def) ? def : null;
25  ✔  595         }
26             
27                 public bool Exists(string workflowId)
28  ❌   0         {
29  ❌   0  ○          if (string.IsNullOrWhiteSpace(workflowId)) return false;
30  ❌   0             return _definitions.ContainsKey(workflowId);
31  ❌   0         }
32             }
```
# FWH.Common.Workflow.Views.WorkflowView

## Summary

|||
|:---|:---|
| Class: | FWH.Common.Workflow.Views.WorkflowView |
| Assembly: | FWH.Common.Workflow |
| **File(s):** | E:\github\FunWasHad\src\FWH.Common.Workflow\Views\WorkflowView.cs |
| **Line coverage:** | 72% (80 of 111) |
| Covered lines: | 80 |
| Uncovered lines: | 31 |
| Coverable lines: | 111 |
| Total lines: | 201 |
| **Branch coverage:** | 43.3% (13 of 30) |
| Covered branches: | 13 |
| Total branches: | 30 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **.ctor(...)** | 50.0% | 2 | 2 | 100% |
| **get_CurrentWorkflowId()** | 100% | 1 | 1 | 100% |
| **set_CurrentWorkflowId(...)** | 100% | 1 | 1 | 100% |
| **get_CurrentNodeId()** | 100% | 2 | 1 | 0% |
| **set_CurrentNodeId(...)** | 100% | 1 | 1 | 100% |
| **get_CurrentState()** | 100% | 1 | 1 | 100% |
| **set_CurrentState(...)** | 100% | 1 | 1 | 100% |
| **get_IsLoading()** | 100% | 2 | 1 | 0% |
| **set_IsLoading(...)** | 100% | 1 | 1 | 100% |
| **get_HasError()** | 100% | 1 | 1 | 100% |
| **set_HasError(...)** | 100% | 1 | 1 | 100% |
| **get_ErrorMessage()** | 100% | 2 | 1 | 0% |
| **set_ErrorMessage(...)** | 100% | 1 | 1 | 100% |
| **LoadWorkflowAsync()** | 33.33% | 7 | 6 | 68.18% |
| **AdvanceAsync()** | 50.0% | 9 | 8 | 72.00% |
| **RestartAsync()** | 33.33% | 7 | 6 | 66.66% |
| **RefreshStateAsync()** | 25.00% | 5 | 4 | 56.25% |
| **OnPropertyChanged(...)** | 50.0% | 2 | 2 | 100% |
| **SetProperty(...)** | 100% | 2 | 2 | 100% |

## File(s)

### E:\github\FunWasHad\src\FWH.Common.Workflow\Views\WorkflowView.cs
```
  1            using System;
  2            using System.ComponentModel;
  3            using System.Runtime.CompilerServices;
  4            using System.Threading.Tasks;
  5            using Microsoft.Extensions.Logging;
  6            
  7            namespace FWH.Common.Workflow.Views;
  8            
  9            /// <summary>
 10            /// View implementation for workflow interactions.
 11            /// Coordinates with WorkflowController to manage workflow state.
 12            /// Single Responsibility: Manage workflow view state and notify observers of changes.
 13            /// </summary>
 14            public class WorkflowView : IWorkflowView
 15            {
 16                private readonly IWorkflowController _controller;
 17                private readonly ILogger<WorkflowView>? _logger;
 18            
 19                private string? _currentWorkflowId;
 20                private string? _currentNodeId;
 21                private WorkflowStatePayload? _currentState;
 22                private bool _isLoading;
 23                private bool _hasError;
 24                private string? _errorMessage;
 25            
 26                public event PropertyChangedEventHandler? PropertyChanged;
 27            
 28  ✔   1         public WorkflowView(IWorkflowController controller, ILogger<WorkflowView>? logger = null)
 29  ✔   1         {
 30  ✓   1  ◑          _controller = controller ?? throw new ArgumentNullException(nameof(controller));
 31  ✔   1             _logger = logger;
 32  ✔   1         }
 33            
 34                public string? CurrentWorkflowId
 35                {
 36  ✔  28             get => _currentWorkflowId;
 37  ✔   1             set => SetProperty(ref _currentWorkflowId, value);
 38                }
 39            
 40                public string? CurrentNodeId
 41                {
 42  ❌  0             get => _currentNodeId;
 43  ✔   5             set => SetProperty(ref _currentNodeId, value);
 44                }
 45            
 46                public WorkflowStatePayload? CurrentState
 47                {
 48  ✔   8             get => _currentState;
 49  ✔   5             private set => SetProperty(ref _currentState, value);
 50                }
 51            
 52                public bool IsLoading
 53                {
 54  ❌  0             get => _isLoading;
 55  ✔  10             private set => SetProperty(ref _isLoading, value);
 56                }
 57            
 58                public bool HasError
 59                {
 60  ✔   2             get => _hasError;
 61  ✔   5             private set => SetProperty(ref _hasError, value);
 62                }
 63            
 64                public string? ErrorMessage
 65                {
 66  ❌  0             get => _errorMessage;
 67  ✔   5             private set => SetProperty(ref _errorMessage, value);
 68                }
 69            
 70                public async Task LoadWorkflowAsync(string workflowId)
 71  ✔   1         {
 72  ✓   1  ◑          if (string.IsNullOrWhiteSpace(workflowId))
 73  ❌  0                 throw new ArgumentNullException(nameof(workflowId));
 74            
 75                    try
 76  ✔   1             {
 77  ✔   1                 IsLoading = true;
 78  ✔   1                 HasError = false;
 79  ✔   1                 ErrorMessage = null;
 80            
 81  ✔   1                 CurrentWorkflowId = workflowId;
 82  ✔   1                 await _controller.StartInstanceAsync(workflowId);
 83  ✔   1                 await RefreshStateAsync();
 84            
 85  ✓   1  ◑              _logger?.LogInformation("Loaded workflow {WorkflowId}", workflowId);
 86  ✔   1             }
 87  ❌  0             catch (Exception ex)
 88  ❌  0             {
 89  ❌  0                 HasError = true;
 90  ❌  0                 ErrorMessage = ex.Message;
 91  ❌  0  ○              _logger?.LogError(ex, "Failed to load workflow {WorkflowId}", workflowId);
 92  ❌  0                 throw;
 93                    }
 94                    finally
 95  ✔   1             {
 96  ✔   1                 IsLoading = false;
 97  ✔   1             }
 98  ✔   1         }
 99            
100                public async Task<bool> AdvanceAsync(object? choiceValue)
101  ✔   3         {
102  ✓   3  ◑          if (string.IsNullOrWhiteSpace(CurrentWorkflowId))
103  ❌  0                 throw new InvalidOperationException("No workflow loaded");
104            
105                    try
106  ✔   3             {
107  ✔   3                 IsLoading = true;
108  ✔   3                 HasError = false;
109  ✔   3                 ErrorMessage = null;
110            
111  ✔   3                 var advanced = await _controller.AdvanceByChoiceValueAsync(CurrentWorkflowId, choiceValue);
112            
113  ✔   3  ●              if (advanced)
114  ✔   3                 {
115  ✔   3                     await RefreshStateAsync();
116  ✓   3  ◑                  _logger?.LogDebug("Advanced workflow {WorkflowId} with choice {Choice}",
117  ✔   3                         CurrentWorkflowId, choiceValue);
118  ✔   3                 }
119            
120  ✔   3                 return advanced;
121                    }
122  ❌  0             catch (Exception ex)
123  ❌  0             {
124  ❌  0                 HasError = true;
125  ❌  0                 ErrorMessage = ex.Message;
126  ❌  0  ○              _logger?.LogError(ex, "Failed to advance workflow {WorkflowId}", CurrentWorkflowId);
127  ❌  0                 throw;
128                    }
129                    finally
130  ✔   3             {
131  ✔   3                 IsLoading = false;
132  ✔   3             }
133  ✔   3         }
134            
135                public async Task RestartAsync()
136  ✔   1         {
137  ✓   1  ◑          if (string.IsNullOrWhiteSpace(CurrentWorkflowId))
138  ❌  0                 throw new InvalidOperationException("No workflow loaded");
139            
140                    try
141  ✔   1             {
142  ✔   1                 IsLoading = true;
143  ✔   1                 HasError = false;
144  ✔   1                 ErrorMessage = null;
145            
146  ✔   1                 await _controller.RestartInstanceAsync(CurrentWorkflowId);
147  ✔   1                 await RefreshStateAsync();
148            
149  ✓   1  ◑              _logger?.LogInformation("Restarted workflow {WorkflowId}", CurrentWorkflowId);
150  ✔   1             }
151  ❌  0             catch (Exception ex)
152  ❌  0             {
153  ❌  0                 HasError = true;
154  ❌  0                 ErrorMessage = ex.Message;
155  ❌  0  ○              _logger?.LogError(ex, "Failed to restart workflow {WorkflowId}", CurrentWorkflowId);
156  ❌  0                 throw;
157                    }
158                    finally
159  ✔   1             {
160  ✔   1                 IsLoading = false;
161  ✔   1             }
162  ✔   1         }
163            
164                public async Task RefreshStateAsync()
165  ✔   5         {
166  ✓   5  ◑          if (string.IsNullOrWhiteSpace(CurrentWorkflowId))
167  ❌  0                 return;
168            
169                    try
170  ✔   5             {
171  ✔   5                 var state = await _controller.GetCurrentStatePayloadAsync(CurrentWorkflowId);
172  ✔   5                 CurrentState = state;
173            
174                        // Update current node from controller
175  ✔   5                 CurrentNodeId = _controller.GetCurrentNodeId(CurrentWorkflowId);
176            
177  ✔   5                 OnPropertyChanged(nameof(CurrentState));
178  ✔   5             }
179  ❌  0             catch (Exception ex)
180  ❌  0             {
181  ❌  0                 HasError = true;
182  ❌  0                 ErrorMessage = ex.Message;
183  ❌  0  ○              _logger?.LogError(ex, "Failed to refresh state for workflow {WorkflowId}", CurrentWorkflowId);
184  ❌  0             }
185  ✔   5         }
186            
187                protected virtual void OnPropertyChanged([CallerMemberName] string? propertyName = null)
188  ✔  26         {
189  ✓  26  ◑          PropertyChanged?.Invoke(this, new PropertyChangedEventArgs(propertyName));
190  ✔  26         }
191            
192                protected bool SetProperty<T>(ref T field, T value, [CallerMemberName] string? propertyName = null)
193  ✔  31         {
194  ✔  31  ●          if (Equals(field, value))
195  ✔  10                 return false;
196            
197  ✔  21             field = value;
198  ✔  21             OnPropertyChanged(propertyName);
199  ✔  21             return true;
200  ✔  31         }
201            }
```
# FWH.Common.Workflow.WorkflowChoiceOption

## Summary

|||
|:---|:---|
| Class: | FWH.Common.Workflow.WorkflowChoiceOption |
| Assembly: | FWH.Common.Workflow |
| **File(s):** | E:\github\FunWasHad\src\FWH.Common.Workflow\WorkflowService.cs |
| **Line coverage:** | 100% (1 of 1) |
| Covered lines: | 1 |
| Uncovered lines: | 0 |
| Coverable lines: | 1 |
| Total lines: | 212 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **get_Order()** | 100% | 1 | 1 | 100% |

## File(s)

### E:\github\FunWasHad\src\FWH.Common.Workflow\WorkflowService.cs
```
  1             using System;
  2             using System.Linq;
  3             using System.Collections.Generic;
  4             using System.Threading.Tasks;
  5             using FWH.Common.Workflow.Models;
  6             using Microsoft.Extensions.Logging;
  7             using FWH.Common.Workflow.Controllers;
  8             using FWH.Common.Workflow.Logging;
  9             using System.Diagnostics;
 10             
 11             namespace FWH.Common.Workflow;
 12             
 13  ✔  131     public record WorkflowChoiceOption(int Order, string DisplayText, string TargetNodeId, string? Condition = null);
 14             public record WorkflowStatePayload(bool IsChoice, string? Text, IReadOnlyList<WorkflowChoiceOption> Choices, string? Nod
 15             
 16             /// <summary>
 17             /// Service facade for workflow operations.
 18             /// Delegates to IWorkflowController for business logic.
 19             /// Single Responsibility: Provide service interface for workflow operations.
 20             /// </summary>
 21             public class WorkflowService : IWorkflowService
 22             {
 23                 private readonly IWorkflowController _controller;
 24                 private readonly ILogger<WorkflowService> _logger;
 25                 private readonly ICorrelationIdService _correlationIdService;
 26             
 27                 public WorkflowService(
 28                     IWorkflowController controller,
 29                     ILogger<WorkflowService> logger,
 30                     ICorrelationIdService? correlationIdService = null)
 31                 {
 32                     _controller = controller;
 33                     _logger = logger;
 34                     _correlationIdService = correlationIdService ?? new CorrelationIdService();
 35                 }
 36             
 37                 public async Task<WorkflowDefinition> ImportWorkflowAsync(string plantUmlText, string? id = null, string? name = nul
 38                 {
 39                     var sw = Stopwatch.StartNew();
 40                     var correlationId = _correlationIdService.GenerateCorrelationId();
 41             
 42                     using var scope = _logger.BeginCorrelatedScope(
 43                         _correlationIdService,
 44                         "ImportWorkflow",
 45                         new Dictionary<string, object>
 46                         {
 47                             ["WorkflowId"] = id ?? "auto-generated",
 48                             ["Name"] = name ?? "unnamed"
 49                         });
 50             
 51                     try
 52                     {
 53                         _logger.LogOperationStart(_correlationIdService, "ImportWorkflow", new Dictionary<string, object>
 54                         {
 55                             ["WorkflowId"] = id ?? "auto-generated"
 56                         });
 57             
 58                         var result = await _controller.ImportWorkflowAsync(plantUmlText, id, name);
 59             
 60                         sw.Stop();
 61                         _logger.LogOperationComplete(_correlationIdService, "ImportWorkflow", sw.Elapsed, new Dictionary<string, obj
 62                         {
 63                             ["WorkflowId"] = result.Id,
 64                             ["NodeCount"] = result.Nodes.Count,
 65                             ["TransitionCount"] = result.Transitions.Count
 66                         });
 67             
 68                         return result;
 69                     }
 70                     catch (Exception ex)
 71                     {
 72                         sw.Stop();
 73                         _logger.LogOperationFailure(_correlationIdService, "ImportWorkflow", ex, sw.Elapsed, new Dictionary<string, 
 74                         {
 75                             ["WorkflowId"] = id ?? "auto-generated"
 76                         });
 77                         throw;
 78                     }
 79                 }
 80             
 81                 public async Task StartInstanceAsync(string workflowId)
 82                 {
 83                     using var scope = _logger.BeginCorrelatedScope(
 84                         _correlationIdService,
 85                         "StartInstance",
 86                         new Dictionary<string, object> { ["WorkflowId"] = workflowId });
 87             
 88                     try
 89                     {
 90                         await _controller.StartInstanceAsync(workflowId);
 91                         _logger.LogInformation("Started instance for workflow {WorkflowId}", workflowId);
 92                     }
 93                     catch (Exception ex)
 94                     {
 95                         _logger.LogError(ex, "Failed to start instance for workflow {WorkflowId}", workflowId);
 96                         throw;
 97                     }
 98                 }
 99             
100                 public async Task RestartInstanceAsync(string workflowId)
101                 {
102                     using var scope = _logger.BeginCorrelatedScope(
103                         _correlationIdService,
104                         "RestartInstance",
105                         new Dictionary<string, object> { ["WorkflowId"] = workflowId });
106             
107                     try
108                     {
109                         await _controller.RestartInstanceAsync(workflowId);
110                         _logger.LogInformation("Restarted instance for workflow {WorkflowId}", workflowId);
111                     }
112                     catch (Exception ex)
113                     {
114                         _logger.LogError(ex, "Failed to restart instance for workflow {WorkflowId}", workflowId);
115                         throw;
116                     }
117                 }
118             
119                 public async Task<WorkflowStatePayload> GetCurrentStatePayloadAsync(string workflowId)
120                 {
121                     var sw = Stopwatch.StartNew();
122             
123                     using var scope = _logger.BeginCorrelatedScope(
124                         _correlationIdService,
125                         "GetCurrentState",
126                         new Dictionary<string, object> { ["WorkflowId"] = workflowId });
127             
128                     try
129                     {
130                         var result = await _controller.GetCurrentStatePayloadAsync(workflowId);
131             
132                         sw.Stop();
133                         _logger.LogOperationComplete(_correlationIdService, "GetCurrentState", sw.Elapsed, new Dictionary<string, ob
134                         {
135                             ["WorkflowId"] = workflowId,
136                             ["IsChoice"] = result.IsChoice,
137                             ["ChoiceCount"] = result.Choices?.Count ?? 0
138                         });
139             
140                         return result;
141                     }
142                     catch (Exception ex)
143                     {
144                         sw.Stop();
145                         _logger.LogOperationFailure(_correlationIdService, "GetCurrentState", ex, sw.Elapsed, new Dictionary<string,
146                         {
147                             ["WorkflowId"] = workflowId
148                         });
149                         throw;
150                     }
151                 }
152             
153                 public async Task<bool> AdvanceByChoiceValueAsync(string workflowId, object? choiceValue)
154                 {
155                     var sw = Stopwatch.StartNew();
156             
157                     using var scope = _logger.BeginCorrelatedScope(
158                         _correlationIdService,
159                         "AdvanceByChoice",
160                         new Dictionary<string, object>
161                         {
162                             ["WorkflowId"] = workflowId,
163                             ["ChoiceValue"] = choiceValue?.ToString() ?? "null"
164                         });
165             
166                     try
167                     {
168                         _logger.LogOperationStart(_correlationIdService, "AdvanceByChoice", new Dictionary<string, object>
169                         {
170                             ["WorkflowId"] = workflowId,
171                             ["ChoiceValue"] = choiceValue?.ToString() ?? "null"
172                         });
173             
174                         var result = await _controller.AdvanceByChoiceValueAsync(workflowId, choiceValue);
175             
176                         sw.Stop();
177                         _logger.LogOperationComplete(_correlationIdService, "AdvanceByChoice", sw.Elapsed, new Dictionary<string, ob
178                         {
179                             ["WorkflowId"] = workflowId,
180                             ["Success"] = result
181                         });
182             
183                         return result;
184                     }
185                     catch (Exception ex)
186                     {
187                         sw.Stop();
188                         _logger.LogOperationFailure(_correlationIdService, "AdvanceByChoice", ex, sw.Elapsed, new Dictionary<string,
189                         {
190                             ["WorkflowId"] = workflowId,
191                             ["ChoiceValue"] = choiceValue?.ToString() ?? "null"
192                         });
193                         throw;
194                     }
195                 }
196             
197                 // Backwards-compatible sync wrappers
198                 public WorkflowDefinition ImportWorkflow(string plantUmlText, string? id = null, string? name = null)
199                     => ImportWorkflowAsync(plantUmlText, id, name).GetAwaiter().GetResult();
200             
201                 public void StartInstance(string workflowId)
202                     => StartInstanceAsync(workflowId).GetAwaiter().GetResult();
203             
204                 public void RestartInstance(string workflowId)
205                     => RestartInstanceAsync(workflowId).GetAwaiter().GetResult();
206             
207                 public WorkflowStatePayload GetCurrentStatePayload(string workflowId)
208                     => GetCurrentStatePayloadAsync(workflowId).GetAwaiter().GetResult();
209             
210                 public bool AdvanceByChoiceValue(string workflowId, object? choiceValue)
211                     => AdvanceByChoiceValueAsync(workflowId, choiceValue).GetAwaiter().GetResult();
212             }
```
# FWH.Common.Workflow.WorkflowService

## Summary

|||
|:---|:---|
| Class: | FWH.Common.Workflow.WorkflowService |
| Assembly: | FWH.Common.Workflow |
| **File(s):** | E:\github\FunWasHad\src\FWH.Common.Workflow\WorkflowService.cs |
| **Line coverage:** | 68.8% (93 of 135) |
| Covered lines: | 93 |
| Uncovered lines: | 42 |
| Coverable lines: | 135 |
| Total lines: | 212 |
| **Branch coverage:** | 62.5% (15 of 24) |
| Covered branches: | 15 |
| Total branches: | 24 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **.ctor(...)** | 100% | 2 | 2 | 100% |
| **ImportWorkflowAsync()** | 100% | 8 | 8 | 100% |
| **StartInstanceAsync()** | 100% | 2 | 1 | 0% |
| **RestartInstanceAsync()** | 100% | 2 | 1 | 0% |
| **GetCurrentStatePayloadAsync()** | 50.0% | 2 | 2 | 100% |
| **AdvanceByChoiceValueAsync()** | 33.33% | 15 | 12 | 73.52% |
| **ImportWorkflow(...)** | 100% | 2 | 1 | 0% |
| **StartInstance(...)** | 100% | 2 | 1 | 0% |
| **RestartInstance(...)** | 100% | 2 | 1 | 0% |
| **GetCurrentStatePayload(...)** | 100% | 2 | 1 | 0% |
| **AdvanceByChoiceValue(...)** | 100% | 2 | 1 | 0% |

## File(s)

### E:\github\FunWasHad\src\FWH.Common.Workflow\WorkflowService.cs
```
  1             using System;
  2             using System.Linq;
  3             using System.Collections.Generic;
  4             using System.Threading.Tasks;
  5             using FWH.Common.Workflow.Models;
  6             using Microsoft.Extensions.Logging;
  7             using FWH.Common.Workflow.Controllers;
  8             using FWH.Common.Workflow.Logging;
  9             using System.Diagnostics;
 10             
 11             namespace FWH.Common.Workflow;
 12             
 13             public record WorkflowChoiceOption(int Order, string DisplayText, string TargetNodeId, string? Condition = null);
 14             public record WorkflowStatePayload(bool IsChoice, string? Text, IReadOnlyList<WorkflowChoiceOption> Choices, string? Nod
 15             
 16             /// <summary>
 17             /// Service facade for workflow operations.
 18             /// Delegates to IWorkflowController for business logic.
 19             /// Single Responsibility: Provide service interface for workflow operations.
 20             /// </summary>
 21             public class WorkflowService : IWorkflowService
 22             {
 23                 private readonly IWorkflowController _controller;
 24                 private readonly ILogger<WorkflowService> _logger;
 25                 private readonly ICorrelationIdService _correlationIdService;
 26             
 27  ✔   49         public WorkflowService(
 28  ✔   49             IWorkflowController controller,
 29  ✔   49             ILogger<WorkflowService> logger,
 30  ✔   49             ICorrelationIdService? correlationIdService = null)
 31  ✔   49         {
 32  ✔   49             _controller = controller;
 33  ✔   49             _logger = logger;
 34  ✔   49  ●          _correlationIdService = correlationIdService ?? new CorrelationIdService();
 35  ✔   49         }
 36             
 37                 public async Task<WorkflowDefinition> ImportWorkflowAsync(string plantUmlText, string? id = null, string? name = nul
 38  ✔  176         {
 39  ✔  176             var sw = Stopwatch.StartNew();
 40  ✔  176             var correlationId = _correlationIdService.GenerateCorrelationId();
 41             
 42  ✔  176  ●          using var scope = _logger.BeginCorrelatedScope(
 43  ✔  176                 _correlationIdService,
 44  ✔  176                 "ImportWorkflow",
 45  ✔  176                 new Dictionary<string, object>
 46  ✔  176                 {
 47  ✔  176                     ["WorkflowId"] = id ?? "auto-generated",
 48  ✔  176                     ["Name"] = name ?? "unnamed"
 49  ✔  176                 });
 50             
 51                     try
 52  ✔  176             {
 53  ✔  176  ●              _logger.LogOperationStart(_correlationIdService, "ImportWorkflow", new Dictionary<string, object>
 54  ✔  176                 {
 55  ✔  176                     ["WorkflowId"] = id ?? "auto-generated"
 56  ✔  176                 });
 57             
 58  ✔  176                 var result = await _controller.ImportWorkflowAsync(plantUmlText, id, name);
 59             
 60  ✔  175                 sw.Stop();
 61  ✔  175                 _logger.LogOperationComplete(_correlationIdService, "ImportWorkflow", sw.Elapsed, new Dictionary<string, obj
 62  ✔  175                 {
 63  ✔  175                     ["WorkflowId"] = result.Id,
 64  ✔  175                     ["NodeCount"] = result.Nodes.Count,
 65  ✔  175                     ["TransitionCount"] = result.Transitions.Count
 66  ✔  175                 });
 67             
 68  ✔  175                 return result;
 69                     }
 70  ✔    1             catch (Exception ex)
 71  ✔    1             {
 72  ✔    1                 sw.Stop();
 73  ✔    1  ●              _logger.LogOperationFailure(_correlationIdService, "ImportWorkflow", ex, sw.Elapsed, new Dictionary<string, 
 74  ✔    1                 {
 75  ✔    1                     ["WorkflowId"] = id ?? "auto-generated"
 76  ✔    1                 });
 77  ✔    1                 throw;
 78                     }
 79  ✔  175         }
 80             
 81                 public async Task StartInstanceAsync(string workflowId)
 82  ❌   0         {
 83  ❌   0             using var scope = _logger.BeginCorrelatedScope(
 84  ❌   0                 _correlationIdService,
 85  ❌   0                 "StartInstance",
 86  ❌   0                 new Dictionary<string, object> { ["WorkflowId"] = workflowId });
 87             
 88                     try
 89  ❌   0             {
 90  ❌   0                 await _controller.StartInstanceAsync(workflowId);
 91  ❌   0                 _logger.LogInformation("Started instance for workflow {WorkflowId}", workflowId);
 92  ❌   0             }
 93  ❌   0             catch (Exception ex)
 94  ❌   0             {
 95  ❌   0                 _logger.LogError(ex, "Failed to start instance for workflow {WorkflowId}", workflowId);
 96  ❌   0                 throw;
 97                     }
 98  ❌   0         }
 99             
100                 public async Task RestartInstanceAsync(string workflowId)
101  ❌   0         {
102  ❌   0             using var scope = _logger.BeginCorrelatedScope(
103  ❌   0                 _correlationIdService,
104  ❌   0                 "RestartInstance",
105  ❌   0                 new Dictionary<string, object> { ["WorkflowId"] = workflowId });
106             
107                     try
108  ❌   0             {
109  ❌   0                 await _controller.RestartInstanceAsync(workflowId);
110  ❌   0                 _logger.LogInformation("Restarted instance for workflow {WorkflowId}", workflowId);
111  ❌   0             }
112  ❌   0             catch (Exception ex)
113  ❌   0             {
114  ❌   0                 _logger.LogError(ex, "Failed to restart instance for workflow {WorkflowId}", workflowId);
115  ❌   0                 throw;
116                     }
117  ❌   0         }
118             
119                 public async Task<WorkflowStatePayload> GetCurrentStatePayloadAsync(string workflowId)
120  ✔   39         {
121  ✔   39             var sw = Stopwatch.StartNew();
122             
123  ✔   39             using var scope = _logger.BeginCorrelatedScope(
124  ✔   39                 _correlationIdService,
125  ✔   39                 "GetCurrentState",
126  ✔   39                 new Dictionary<string, object> { ["WorkflowId"] = workflowId });
127             
128                     try
129  ✔   39             {
130  ✔   39                 var result = await _controller.GetCurrentStatePayloadAsync(workflowId);
131             
132  ✔   38                 sw.Stop();
133  ✓   38  ◑              _logger.LogOperationComplete(_correlationIdService, "GetCurrentState", sw.Elapsed, new Dictionary<string, ob
134  ✔   38                 {
135  ✔   38                     ["WorkflowId"] = workflowId,
136  ✔   38                     ["IsChoice"] = result.IsChoice,
137  ✔   38                     ["ChoiceCount"] = result.Choices?.Count ?? 0
138  ✔   38                 });
139             
140  ✔   38                 return result;
141                     }
142  ✔    1             catch (Exception ex)
143  ✔    1             {
144  ✔    1                 sw.Stop();
145  ✔    1                 _logger.LogOperationFailure(_correlationIdService, "GetCurrentState", ex, sw.Elapsed, new Dictionary<string,
146  ✔    1                 {
147  ✔    1                     ["WorkflowId"] = workflowId
148  ✔    1                 });
149  ✔    1                 throw;
150                     }
151  ✔   38         }
152             
153                 public async Task<bool> AdvanceByChoiceValueAsync(string workflowId, object? choiceValue)
154  ✔    6         {
155  ✔    6             var sw = Stopwatch.StartNew();
156             
157  ✓    6  ◑          using var scope = _logger.BeginCorrelatedScope(
158  ✔    6                 _correlationIdService,
159  ✔    6                 "AdvanceByChoice",
160  ✔    6                 new Dictionary<string, object>
161  ✔    6                 {
162  ✔    6                     ["WorkflowId"] = workflowId,
163  ✔    6                     ["ChoiceValue"] = choiceValue?.ToString() ?? "null"
164  ✔    6                 });
165             
166                     try
167  ✔    6             {
168  ✓    6  ◑              _logger.LogOperationStart(_correlationIdService, "AdvanceByChoice", new Dictionary<string, object>
169  ✔    6                 {
170  ✔    6                     ["WorkflowId"] = workflowId,
171  ✔    6                     ["ChoiceValue"] = choiceValue?.ToString() ?? "null"
172  ✔    6                 });
173             
174  ✔    6                 var result = await _controller.AdvanceByChoiceValueAsync(workflowId, choiceValue);
175             
176  ✔    6                 sw.Stop();
177  ✔    6                 _logger.LogOperationComplete(_correlationIdService, "AdvanceByChoice", sw.Elapsed, new Dictionary<string, ob
178  ✔    6                 {
179  ✔    6                     ["WorkflowId"] = workflowId,
180  ✔    6                     ["Success"] = result
181  ✔    6                 });
182             
183  ✔    6                 return result;
184                     }
185  ❌   0             catch (Exception ex)
186  ❌   0             {
187  ❌   0                 sw.Stop();
188  ❌   0  ○              _logger.LogOperationFailure(_correlationIdService, "AdvanceByChoice", ex, sw.Elapsed, new Dictionary<string,
189  ❌   0                 {
190  ❌   0                     ["WorkflowId"] = workflowId,
191  ❌   0                     ["ChoiceValue"] = choiceValue?.ToString() ?? "null"
192  ❌   0                 });
193  ❌   0                 throw;
194                     }
195  ✔    6         }
196             
197                 // Backwards-compatible sync wrappers
198                 public WorkflowDefinition ImportWorkflow(string plantUmlText, string? id = null, string? name = null)
199  ❌   0             => ImportWorkflowAsync(plantUmlText, id, name).GetAwaiter().GetResult();
200             
201                 public void StartInstance(string workflowId)
202  ❌   0             => StartInstanceAsync(workflowId).GetAwaiter().GetResult();
203             
204                 public void RestartInstance(string workflowId)
205  ❌   0             => RestartInstanceAsync(workflowId).GetAwaiter().GetResult();
206             
207                 public WorkflowStatePayload GetCurrentStatePayload(string workflowId)
208  ❌   0             => GetCurrentStatePayloadAsync(workflowId).GetAwaiter().GetResult();
209             
210                 public bool AdvanceByChoiceValue(string workflowId, object? choiceValue)
211  ❌   0             => AdvanceByChoiceValueAsync(workflowId, choiceValue).GetAwaiter().GetResult();
212             }
```
# FWH.Common.Workflow.WorkflowStatePayload

## Summary

|||
|:---|:---|
| Class: | FWH.Common.Workflow.WorkflowStatePayload |
| Assembly: | FWH.Common.Workflow |
| **File(s):** | E:\github\FunWasHad\src\FWH.Common.Workflow\WorkflowService.cs |
| **Line coverage:** | 100% (1 of 1) |
| Covered lines: | 1 |
| Uncovered lines: | 0 |
| Coverable lines: | 1 |
| Total lines: | 212 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **get_IsChoice()** | 100% | 1 | 1 | 100% |

## File(s)

### E:\github\FunWasHad\src\FWH.Common.Workflow\WorkflowService.cs
```
  1             using System;
  2             using System.Linq;
  3             using System.Collections.Generic;
  4             using System.Threading.Tasks;
  5             using FWH.Common.Workflow.Models;
  6             using Microsoft.Extensions.Logging;
  7             using FWH.Common.Workflow.Controllers;
  8             using FWH.Common.Workflow.Logging;
  9             using System.Diagnostics;
 10             
 11             namespace FWH.Common.Workflow;
 12             
 13             public record WorkflowChoiceOption(int Order, string DisplayText, string TargetNodeId, string? Condition = null);
 14  ✔  471     public record WorkflowStatePayload(bool IsChoice, string? Text, IReadOnlyList<WorkflowChoiceOption> Choices, string? Nod
 15             
 16             /// <summary>
 17             /// Service facade for workflow operations.
 18             /// Delegates to IWorkflowController for business logic.
 19             /// Single Responsibility: Provide service interface for workflow operations.
 20             /// </summary>
 21             public class WorkflowService : IWorkflowService
 22             {
 23                 private readonly IWorkflowController _controller;
 24                 private readonly ILogger<WorkflowService> _logger;
 25                 private readonly ICorrelationIdService _correlationIdService;
 26             
 27                 public WorkflowService(
 28                     IWorkflowController controller,
 29                     ILogger<WorkflowService> logger,
 30                     ICorrelationIdService? correlationIdService = null)
 31                 {
 32                     _controller = controller;
 33                     _logger = logger;
 34                     _correlationIdService = correlationIdService ?? new CorrelationIdService();
 35                 }
 36             
 37                 public async Task<WorkflowDefinition> ImportWorkflowAsync(string plantUmlText, string? id = null, string? name = nul
 38                 {
 39                     var sw = Stopwatch.StartNew();
 40                     var correlationId = _correlationIdService.GenerateCorrelationId();
 41             
 42                     using var scope = _logger.BeginCorrelatedScope(
 43                         _correlationIdService,
 44                         "ImportWorkflow",
 45                         new Dictionary<string, object>
 46                         {
 47                             ["WorkflowId"] = id ?? "auto-generated",
 48                             ["Name"] = name ?? "unnamed"
 49                         });
 50             
 51                     try
 52                     {
 53                         _logger.LogOperationStart(_correlationIdService, "ImportWorkflow", new Dictionary<string, object>
 54                         {
 55                             ["WorkflowId"] = id ?? "auto-generated"
 56                         });
 57             
 58                         var result = await _controller.ImportWorkflowAsync(plantUmlText, id, name);
 59             
 60                         sw.Stop();
 61                         _logger.LogOperationComplete(_correlationIdService, "ImportWorkflow", sw.Elapsed, new Dictionary<string, obj
 62                         {
 63                             ["WorkflowId"] = result.Id,
 64                             ["NodeCount"] = result.Nodes.Count,
 65                             ["TransitionCount"] = result.Transitions.Count
 66                         });
 67             
 68                         return result;
 69                     }
 70                     catch (Exception ex)
 71                     {
 72                         sw.Stop();
 73                         _logger.LogOperationFailure(_correlationIdService, "ImportWorkflow", ex, sw.Elapsed, new Dictionary<string, 
 74                         {
 75                             ["WorkflowId"] = id ?? "auto-generated"
 76                         });
 77                         throw;
 78                     }
 79                 }
 80             
 81                 public async Task StartInstanceAsync(string workflowId)
 82                 {
 83                     using var scope = _logger.BeginCorrelatedScope(
 84                         _correlationIdService,
 85                         "StartInstance",
 86                         new Dictionary<string, object> { ["WorkflowId"] = workflowId });
 87             
 88                     try
 89                     {
 90                         await _controller.StartInstanceAsync(workflowId);
 91                         _logger.LogInformation("Started instance for workflow {WorkflowId}", workflowId);
 92                     }
 93                     catch (Exception ex)
 94                     {
 95                         _logger.LogError(ex, "Failed to start instance for workflow {WorkflowId}", workflowId);
 96                         throw;
 97                     }
 98                 }
 99             
100                 public async Task RestartInstanceAsync(string workflowId)
101                 {
102                     using var scope = _logger.BeginCorrelatedScope(
103                         _correlationIdService,
104                         "RestartInstance",
105                         new Dictionary<string, object> { ["WorkflowId"] = workflowId });
106             
107                     try
108                     {
109                         await _controller.RestartInstanceAsync(workflowId);
110                         _logger.LogInformation("Restarted instance for workflow {WorkflowId}", workflowId);
111                     }
112                     catch (Exception ex)
113                     {
114                         _logger.LogError(ex, "Failed to restart instance for workflow {WorkflowId}", workflowId);
115                         throw;
116                     }
117                 }
118             
119                 public async Task<WorkflowStatePayload> GetCurrentStatePayloadAsync(string workflowId)
120                 {
121                     var sw = Stopwatch.StartNew();
122             
123                     using var scope = _logger.BeginCorrelatedScope(
124                         _correlationIdService,
125                         "GetCurrentState",
126                         new Dictionary<string, object> { ["WorkflowId"] = workflowId });
127             
128                     try
129                     {
130                         var result = await _controller.GetCurrentStatePayloadAsync(workflowId);
131             
132                         sw.Stop();
133                         _logger.LogOperationComplete(_correlationIdService, "GetCurrentState", sw.Elapsed, new Dictionary<string, ob
134                         {
135                             ["WorkflowId"] = workflowId,
136                             ["IsChoice"] = result.IsChoice,
137                             ["ChoiceCount"] = result.Choices?.Count ?? 0
138                         });
139             
140                         return result;
141                     }
142                     catch (Exception ex)
143                     {
144                         sw.Stop();
145                         _logger.LogOperationFailure(_correlationIdService, "GetCurrentState", ex, sw.Elapsed, new Dictionary<string,
146                         {
147                             ["WorkflowId"] = workflowId
148                         });
149                         throw;
150                     }
151                 }
152             
153                 public async Task<bool> AdvanceByChoiceValueAsync(string workflowId, object? choiceValue)
154                 {
155                     var sw = Stopwatch.StartNew();
156             
157                     using var scope = _logger.BeginCorrelatedScope(
158                         _correlationIdService,
159                         "AdvanceByChoice",
160                         new Dictionary<string, object>
161                         {
162                             ["WorkflowId"] = workflowId,
163                             ["ChoiceValue"] = choiceValue?.ToString() ?? "null"
164                         });
165             
166                     try
167                     {
168                         _logger.LogOperationStart(_correlationIdService, "AdvanceByChoice", new Dictionary<string, object>
169                         {
170                             ["WorkflowId"] = workflowId,
171                             ["ChoiceValue"] = choiceValue?.ToString() ?? "null"
172                         });
173             
174                         var result = await _controller.AdvanceByChoiceValueAsync(workflowId, choiceValue);
175             
176                         sw.Stop();
177                         _logger.LogOperationComplete(_correlationIdService, "AdvanceByChoice", sw.Elapsed, new Dictionary<string, ob
178                         {
179                             ["WorkflowId"] = workflowId,
180                             ["Success"] = result
181                         });
182             
183                         return result;
184                     }
185                     catch (Exception ex)
186                     {
187                         sw.Stop();
188                         _logger.LogOperationFailure(_correlationIdService, "AdvanceByChoice", ex, sw.Elapsed, new Dictionary<string,
189                         {
190                             ["WorkflowId"] = workflowId,
191                             ["ChoiceValue"] = choiceValue?.ToString() ?? "null"
192                         });
193                         throw;
194                     }
195                 }
196             
197                 // Backwards-compatible sync wrappers
198                 public WorkflowDefinition ImportWorkflow(string plantUmlText, string? id = null, string? name = null)
199                     => ImportWorkflowAsync(plantUmlText, id, name).GetAwaiter().GetResult();
200             
201                 public void StartInstance(string workflowId)
202                     => StartInstanceAsync(workflowId).GetAwaiter().GetResult();
203             
204                 public void RestartInstance(string workflowId)
205                     => RestartInstanceAsync(workflowId).GetAwaiter().GetResult();
206             
207                 public WorkflowStatePayload GetCurrentStatePayload(string workflowId)
208                     => GetCurrentStatePayloadAsync(workflowId).GetAwaiter().GetResult();
209             
210                 public bool AdvanceByChoiceValue(string workflowId, object? choiceValue)
211                     => AdvanceByChoiceValueAsync(workflowId, choiceValue).GetAwaiter().GetResult();
212             }
```
# FWH.MarketingApi.Controllers.FeedbackController

## Summary

|||
|:---|:---|
| Class: | FWH.MarketingApi.Controllers.FeedbackController |
| Assembly: | FWH.MarketingApi |
| **File(s):** | E:\github\FunWasHad\src\FWH.MarketingApi\Controllers\FeedbackController.cs |
| **Line coverage:** | 57.6% (120 of 208) |
| Covered lines: | 120 |
| Uncovered lines: | 88 |
| Coverable lines: | 208 |
| Total lines: | 407 |
| **Branch coverage:** | 50% (24 of 48) |
| Covered branches: | 24 |
| Total branches: | 48 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **.cctor()** | 100% | 1 | 1 | 100% |
| **.ctor(...)** | 50.0% | 6 | 6 | 100% |
| **SubmitFeedback()** | 64.28% | 16 | 14 | 80.0% |
| **UploadImage()** | 50.0% | 12 | 10 | 73.33% |
| **UploadVideo()** | 50.0% | 12 | 10 | 73.91% |
| **GetFeedback()** | 100% | 2 | 2 | 100% |
| **GetAttachment()** | 0% | 6 | 2 | 0% |
| **GetBusinessFeedback()** | 0% | 20 | 4 | 0% |
| **GetFeedbackStats()** | 100% | 2 | 1 | 0% |

## File(s)

### E:\github\FunWasHad\src\FWH.MarketingApi\Controllers\FeedbackController.cs
```
  1            using FWH.MarketingApi.Data;
  2            using FWH.MarketingApi.Models;
  3            using Microsoft.AspNetCore.Mvc;
  4            using Microsoft.EntityFrameworkCore;
  5            
  6            namespace FWH.MarketingApi.Controllers;
  7            
  8            /// <summary>
  9            /// API controller for submitting and managing user feedback to businesses.
 10            /// Implements TR-API-003: Feedback endpoints.
 11            /// </summary>
 12            /// <remarks>
 13            /// This controller provides all feedback-related endpoints as specified in TR-API-003:
 14            /// - Feedback submission (TR-API-003)
 15            /// - Image and video attachment uploads (TR-MEDIA-001, TR-MEDIA-002)
 16            /// - Feedback retrieval and statistics
 17            /// </remarks>
 18            [ApiController]
 19            [Route("api/[controller]")]
 20            public class FeedbackController : ControllerBase
 21            {
 22                private readonly MarketingDbContext _context;
 23                private readonly ILogger<FeedbackController> _logger;
 24                private readonly FWH.MarketingApi.Services.IBlobStorageService _blobStorage;
 25                private const long MaxFileSize = 50 * 1024 * 1024; // 50MB
 26  ✔   1         private static readonly string[] AllowedImageTypes = { "image/jpeg", "image/png", "image/gif", "image/webp" };
 27  ✔   1         private static readonly string[] AllowedVideoTypes = { "video/mp4", "video/quicktime", "video/x-msvideo" };
 28            
 29  ✔  13         public FeedbackController(
 30  ✔  13             MarketingDbContext context,
 31  ✔  13             ILogger<FeedbackController> logger,
 32  ✔  13             FWH.MarketingApi.Services.IBlobStorageService blobStorage)
 33  ✔  13         {
 34  ✓  13  ◑          _context = context ?? throw new ArgumentNullException(nameof(context));
 35  ✓  13  ◑          _logger = logger ?? throw new ArgumentNullException(nameof(logger));
 36  ✓  13  ◑          _blobStorage = blobStorage ?? throw new ArgumentNullException(nameof(blobStorage));
 37  ✔  13         }
 38            
 39                /// <summary>
 40                /// Submit text feedback to a business.
 41                /// Implements TR-API-003: POST /api/feedback.
 42                /// </summary>
 43                /// <param name="request">Feedback details including business ID, user info, feedback type, and message</param>
 44                /// <returns>Created feedback with ID</returns>
 45                /// <exception cref="BadRequestResult">Thrown when request is invalid, feedback type is invalid, rating is out of ra
 46                /// <exception cref="NotFoundResult">Thrown when business is not found</exception>
 47                /// <remarks>
 48                /// Validates feedback according to TR-API-004 (validation requirements).
 49                /// Rating must be between 1 and 5 if provided.
 50                /// </remarks>
 51                [HttpPost]
 52                [ProducesResponseType(StatusCodes.Status201Created)]
 53                [ProducesResponseType(StatusCodes.Status400BadRequest)]
 54                [ProducesResponseType(StatusCodes.Status404NotFound)]
 55                public async Task<ActionResult<Feedback>> SubmitFeedback([FromBody] SubmitFeedbackRequest request)
 56  ✔   6         {
 57  ✓   6  ◑          if (request == null)
 58  ❌  0             {
 59  ❌  0                 return BadRequest("Request body is required");
 60                    }
 61            
 62                    // Validate business exists and is subscribed
 63  ✔   6             var business = await _context.Businesses.FindAsync(request.BusinessId);
 64  ✔   6  ●          if (business == null)
 65  ✔   1             {
 66  ✔   1                 return NotFound($"Business {request.BusinessId} not found");
 67                    }
 68            
 69  ✓   5  ◑          if (!business.IsSubscribed)
 70  ❌  0             {
 71  ❌  0                 return BadRequest("Business is not subscribed to feedback service");
 72                    }
 73            
 74                    // Validate feedback type
 75  ✔   5             var validTypes = new[] { "review", "complaint", "suggestion", "compliment" };
 76  ✓   5  ◑          if (!validTypes.Contains(request.FeedbackType.ToLower()))
 77  ❌  0             {
 78  ❌  0                 return BadRequest($"Invalid feedback type. Must be one of: {string.Join(", ", validTypes)}");
 79                    }
 80            
 81                    // Validate rating if provided
 82  ✓   5  ◑          if (request.Rating.HasValue && (request.Rating < 1 || request.Rating > 5))
 83  ❌  0             {
 84  ❌  0                 return BadRequest("Rating must be between 1 and 5");
 85                    }
 86            
 87  ✔   5             var feedback = new Feedback
 88  ✔   5             {
 89  ✔   5                 BusinessId = request.BusinessId,
 90  ✔   5                 UserId = request.UserId,
 91  ✔   5                 UserName = request.UserName,
 92  ✔   5                 UserEmail = request.UserEmail,
 93  ✔   5                 FeedbackType = request.FeedbackType.ToLower(),
 94  ✔   5                 Subject = request.Subject,
 95  ✔   5                 Message = request.Message,
 96  ✔   5                 Rating = request.Rating,
 97  ✔   5                 IsPublic = request.IsPublic,
 98  ✔   5                 IsApproved = false, // Requires moderation
 99  ✔   5                 Latitude = request.Latitude,
100  ✔   5                 Longitude = request.Longitude,
101  ✔   5                 SubmittedAt = DateTimeOffset.UtcNow
102  ✔   5             };
103            
104  ✔   5             _context.Feedbacks.Add(feedback);
105  ✔   5             await _context.SaveChangesAsync();
106            
107  ✔   5             _logger.LogInformation("Feedback {FeedbackId} submitted for business {BusinessId} by user {UserId}",
108  ✔   5                 feedback.Id, request.BusinessId, request.UserId);
109            
110  ✔   5             return CreatedAtAction(nameof(GetFeedback), new { id = feedback.Id }, feedback);
111  ✔   6         }
112            
113                /// <summary>
114                /// Upload an image attachment for feedback.
115                /// Implements TR-API-003: POST /api/feedback/{feedbackId}/attachments/image.
116                /// Implements TR-MEDIA-001: Attachment upload handling and TR-MEDIA-002: Content type support.
117                /// </summary>
118                /// <param name="feedbackId">Feedback ID to attach the image to</param>
119                /// <param name="file">Image file (JPEG, PNG, GIF, or WebP, max 50MB)</param>
120                /// <returns>Created attachment with metadata</returns>
121                /// <exception cref="BadRequestResult">Thrown when file is missing, file size exceeds 50MB, or content type is not a
122                /// <exception cref="NotFoundResult">Thrown when feedback is not found</exception>
123                /// <remarks>
124                /// Validates file size (max 50MB) and content type according to TR-MEDIA-002.
125                /// Allowed image types: image/jpeg, image/png, image/gif, image/webp.
126                /// </remarks>
127                [HttpPost("{feedbackId}/attachments/image")]
128                [ProducesResponseType(StatusCodes.Status201Created)]
129                [ProducesResponseType(StatusCodes.Status400BadRequest)]
130                [ProducesResponseType(StatusCodes.Status404NotFound)]
131                [RequestSizeLimit(MaxFileSize)]
132                public async Task<ActionResult<FeedbackAttachment>> UploadImage(long feedbackId, IFormFile file)
133  ✔   2         {
134  ✓   2  ◑          if (file == null || file.Length == 0)
135  ❌  0             {
136  ❌  0                 return BadRequest("File is required");
137                    }
138            
139  ✓   2  ◑          if (file.Length > MaxFileSize)
140  ❌  0             {
141  ❌  0                 return BadRequest($"File size exceeds maximum of {MaxFileSize / (1024 * 1024)}MB");
142                    }
143            
144  ✓   2  ◑          if (!AllowedImageTypes.Contains(file.ContentType.ToLower()))
145  ❌  0             {
146  ❌  0                 return BadRequest($"Invalid image type. Allowed types: {string.Join(", ", AllowedImageTypes)}");
147                    }
148            
149  ✔   2             var feedback = await _context.Feedbacks.FindAsync(feedbackId);
150  ✓   2  ◑          if (feedback == null)
151  ❌  0             {
152  ❌  0                 return NotFound($"Feedback {feedbackId} not found");
153                    }
154            
155                    // Upload file to blob storage
156                    string storageUrl;
157                    string? thumbnailUrl;
158            
159                    try
160  ✔   2             {
161  ✔   2                 using var fileStream = file.OpenReadStream();
162  ✔   2                 (storageUrl, thumbnailUrl) = await _blobStorage.UploadWithThumbnailAsync(
163  ✔   2                     fileStream,
164  ✔   2                     file.FileName,
165  ✔   2                     file.ContentType,
166  ✔   2                     $"feedback/{feedbackId}/images",
167  ✔   2                     generateThumbnail: true,
168  ✔   2                     cancellationToken: default);
169  ✔   2             }
170  ❌  0             catch (Exception ex)
171  ❌  0             {
172  ❌  0                 _logger.LogError(ex, "Failed to upload image attachment for feedback {FeedbackId}", feedbackId);
173  ❌  0                 return StatusCode(StatusCodes.Status500InternalServerError, "Failed to upload file");
174                    }
175            
176  ✔   2             var attachment = new FeedbackAttachment
177  ✔   2             {
178  ✔   2                 FeedbackId = feedbackId,
179  ✔   2                 AttachmentType = "image",
180  ✔   2                 FileName = file.FileName,
181  ✔   2                 ContentType = file.ContentType,
182  ✔   2                 StorageUrl = storageUrl,
183  ✔   2                 ThumbnailUrl = thumbnailUrl,
184  ✔   2                 FileSizeBytes = file.Length,
185  ✔   2                 UploadedAt = DateTimeOffset.UtcNow
186  ✔   2             };
187            
188  ✔   2             _context.FeedbackAttachments.Add(attachment);
189  ✔   2             await _context.SaveChangesAsync();
190            
191  ✔   2             _logger.LogInformation("Image attachment {AttachmentId} uploaded for feedback {FeedbackId}",
192  ✔   2                 attachment.Id, feedbackId);
193            
194  ✔   2             return CreatedAtAction(nameof(GetAttachment), new { id = attachment.Id }, attachment);
195  ✔   2         }
196            
197                /// <summary>
198                /// Upload a video attachment for feedback.
199                /// Implements TR-API-003: POST /api/feedback/{feedbackId}/attachments/video.
200                /// Implements TR-MEDIA-001: Attachment upload handling and TR-MEDIA-002: Content type support.
201                /// </summary>
202                /// <param name="feedbackId">Feedback ID to attach the video to</param>
203                /// <param name="file">Video file (MP4, QuickTime, or AVI, max 50MB)</param>
204                /// <returns>Created attachment with metadata</returns>
205                /// <exception cref="BadRequestResult">Thrown when file is missing, file size exceeds 50MB, or content type is not a
206                /// <exception cref="NotFoundResult">Thrown when feedback is not found</exception>
207                /// <remarks>
208                /// Validates file size (max 50MB) and content type according to TR-MEDIA-002.
209                /// Allowed video types: video/mp4, video/quicktime, video/x-msvideo.
210                /// </remarks>
211                [HttpPost("{feedbackId}/attachments/video")]
212                [ProducesResponseType(StatusCodes.Status201Created)]
213                [ProducesResponseType(StatusCodes.Status400BadRequest)]
214                [ProducesResponseType(StatusCodes.Status404NotFound)]
215                [RequestSizeLimit(MaxFileSize)]
216                public async Task<ActionResult<FeedbackAttachment>> UploadVideo(long feedbackId, IFormFile file)
217  ✔   1         {
218  ✓   1  ◑          if (file == null || file.Length == 0)
219  ❌  0             {
220  ❌  0                 return BadRequest("File is required");
221                    }
222            
223  ✓   1  ◑          if (file.Length > MaxFileSize)
224  ❌  0             {
225  ❌  0                 return BadRequest($"File size exceeds maximum of {MaxFileSize / (1024 * 1024)}MB");
226                    }
227            
228  ✓   1  ◑          if (!AllowedVideoTypes.Contains(file.ContentType.ToLower()))
229  ❌  0             {
230  ❌  0                 return BadRequest($"Invalid video type. Allowed types: {string.Join(", ", AllowedVideoTypes)}");
231                    }
232            
233  ✔   1             var feedback = await _context.Feedbacks.FindAsync(feedbackId);
234  ✓   1  ◑          if (feedback == null)
235  ❌  0             {
236  ❌  0                 return NotFound($"Feedback {feedbackId} not found");
237                    }
238            
239                    // Upload file to blob storage
240                    string storageUrl;
241                    string? thumbnailUrl;
242            
243                    try
244  ✔   1             {
245  ✔   1                 using var fileStream = file.OpenReadStream();
246  ✔   1                 (storageUrl, thumbnailUrl) = await _blobStorage.UploadWithThumbnailAsync(
247  ✔   1                     fileStream,
248  ✔   1                     file.FileName,
249  ✔   1                     file.ContentType,
250  ✔   1                     $"feedback/{feedbackId}/videos",
251  ✔   1                     generateThumbnail: false, // Video thumbnail generation not yet implemented
252  ✔   1                     cancellationToken: default);
253  ✔   1             }
254  ❌  0             catch (Exception ex)
255  ❌  0             {
256  ❌  0                 _logger.LogError(ex, "Failed to upload video attachment for feedback {FeedbackId}", feedbackId);
257  ❌  0                 return StatusCode(StatusCodes.Status500InternalServerError, "Failed to upload file");
258                    }
259            
260  ✔   1             var attachment = new FeedbackAttachment
261  ✔   1             {
262  ✔   1                 FeedbackId = feedbackId,
263  ✔   1                 AttachmentType = "video",
264  ✔   1                 FileName = file.FileName,
265  ✔   1                 ContentType = file.ContentType,
266  ✔   1                 StorageUrl = storageUrl,
267  ✔   1                 ThumbnailUrl = thumbnailUrl,
268  ✔   1                 FileSizeBytes = file.Length,
269  ✔   1                 DurationSeconds = null, // Would be extracted from video metadata
270  ✔   1                 UploadedAt = DateTimeOffset.UtcNow
271  ✔   1             };
272            
273  ✔   1             _context.FeedbackAttachments.Add(attachment);
274  ✔   1             await _context.SaveChangesAsync();
275            
276  ✔   1             _logger.LogInformation("Video attachment {AttachmentId} uploaded for feedback {FeedbackId}",
277  ✔   1                 attachment.Id, feedbackId);
278            
279  ✔   1             return CreatedAtAction(nameof(GetAttachment), new { id = attachment.Id }, attachment);
280  ✔   1         }
281            
282                /// <summary>
283                /// Get feedback by ID.
284                /// Implements TR-API-003: GET /api/feedback/{id}.
285                /// </summary>
286                /// <param name="id">Feedback ID</param>
287                /// <returns>Feedback with business and attachments</returns>
288                /// <exception cref="NotFoundResult">Thrown when feedback is not found</exception>
289                [HttpGet("{id}")]
290                [ProducesResponseType(StatusCodes.Status200OK)]
291                [ProducesResponseType(StatusCodes.Status404NotFound)]
292                public async Task<ActionResult<Feedback>> GetFeedback(long id)
293  ✔   2         {
294  ✔   2             var feedback = await _context.Feedbacks
295  ✔   2                 .Include(f => f.Business)
296  ✔   2                 .Include(f => f.Attachments)
297  ✔   2                 .FirstOrDefaultAsync(f => f.Id == id);
298            
299  ✔   2  ●          if (feedback == null)
300  ✔   1             {
301  ✔   1                 return NotFound();
302                    }
303            
304  ✔   1             return Ok(feedback);
305  ✔   2         }
306            
307                /// <summary>
308                /// Get attachment by ID.
309                /// </summary>
310                /// <param name="id">Attachment ID</param>
311                [HttpGet("attachments/{id}")]
312                [ProducesResponseType(StatusCodes.Status200OK)]
313                [ProducesResponseType(StatusCodes.Status404NotFound)]
314                public async Task<ActionResult<FeedbackAttachment>> GetAttachment(long id)
315  ❌  0         {
316  ❌  0             var attachment = await _context.FeedbackAttachments.FindAsync(id);
317            
318  ❌  0  ○          if (attachment == null)
319  ❌  0             {
320  ❌  0                 return NotFound();
321                    }
322            
323  ❌  0             return Ok(attachment);
324  ❌  0         }
325            
326                /// <summary>
327                /// Get all feedback for a business with pagination.
328                /// </summary>
329                /// <param name="businessId">Business ID</param>
330                /// <param name="includeAttachments">Include attachment details</param>
331                /// <param name="publicOnly">Only return public, approved feedback</param>
332                /// <param name="page">Page number (1-based, default: 1)</param>
333                /// <param name="pageSize">Items per page (default: 20, max: 100)</param>
334                [HttpGet("business/{businessId}")]
335                [ProducesResponseType(StatusCodes.Status200OK)]
336                public async Task<ActionResult<PagedResult<Feedback>>> GetBusinessFeedback(
337                    long businessId,
338                    [FromQuery] bool includeAttachments = false,
339                    [FromQuery] bool publicOnly = true,
340                    [FromQuery] int page = 1,
341                    [FromQuery] int pageSize = 20)
342  ❌  0         {
343  ❌  0             var pagination = new FWH.MarketingApi.Models.PaginationParameters { Page = page, PageSize = pageSize };
344  ❌  0             pagination.Validate();
345            
346  ❌  0             var query = _context.Feedbacks
347  ❌  0                 .Where(f => f.BusinessId == businessId);
348            
349  ❌  0  ○          if (publicOnly)
350  ❌  0             {
351  ❌  0                 query = query.Where(f => f.IsPublic && f.IsApproved);
352  ❌  0             }
353            
354  ❌  0  ○          if (includeAttachments)
355  ❌  0             {
356  ❌  0                 query = query.Include(f => f.Attachments);
357  ❌  0             }
358            
359  ❌  0             var totalCount = await query.CountAsync();
360  ❌  0             var feedback = await query
361  ❌  0                 .OrderByDescending(f => f.SubmittedAt)
362  ❌  0                 .Skip(pagination.Skip)
363  ❌  0                 .Take(pagination.Take)
364  ❌  0                 .ToListAsync();
365            
366  ❌  0             var result = new FWH.MarketingApi.Models.PagedResult<Feedback>
367  ❌  0             {
368  ❌  0                 Items = feedback,
369  ❌  0                 Page = pagination.Page,
370  ❌  0                 PageSize = pagination.PageSize,
371  ❌  0                 TotalCount = totalCount
372  ❌  0             };
373            
374  ❌  0             _logger.LogDebug("Retrieved {Count} feedback items (page {Page}) for business {BusinessId}",
375  ❌  0                 feedback.Count, pagination.Page, businessId);
376  ❌  0             return Ok(result);
377  ❌  0         }
378            
379                /// <summary>
380                /// Get feedback statistics for a business.
381                /// </summary>
382                /// <param name="businessId">Business ID</param>
383                [HttpGet("business/{businessId}/stats")]
384                [ProducesResponseType(StatusCodes.Status200OK)]
385                public async Task<ActionResult<object>> GetFeedbackStats(long businessId)
386  ❌  0         {
387  ❌  0             var feedback = await _context.Feedbacks
388  ❌  0                 .Where(f => f.BusinessId == businessId && f.IsPublic && f.IsApproved)
389  ❌  0                 .ToListAsync();
390            
391  ❌  0             var stats = new
392  ❌  0             {
393  ❌  0                 TotalCount = feedback.Count,
394  ❌  0                 AverageRating = feedback.Where(f => f.Rating.HasValue).Average(f => f.Rating),
395  ❌  0                 RatingDistribution = feedback
396  ❌  0                     .Where(f => f.Rating.HasValue)
397  ❌  0                     .GroupBy(f => f.Rating)
398  ❌  0                     .ToDictionary(g => g.Key!.Value, g => g.Count()),
399  ❌  0                 TypeDistribution = feedback
400  ❌  0                     .GroupBy(f => f.FeedbackType)
401  ❌  0                     .ToDictionary(g => g.Key, g => g.Count()),
402  ❌  0                 RecentCount = feedback.Count(f => f.SubmittedAt >= DateTimeOffset.UtcNow.AddDays(-30))
403  ❌  0             };
404            
405  ❌  0             return Ok(stats);
406  ❌  0         }
407            }
```
# FWH.MarketingApi.Controllers.MarketingController

## Summary

|||
|:---|:---|
| Class: | FWH.MarketingApi.Controllers.MarketingController |
| Assembly: | FWH.MarketingApi |
| **File(s):** | E:\github\FunWasHad\src\FWH.MarketingApi\Controllers\MarketingController.cs |
| **Line coverage:** | 0% (0 of 256) |
| Covered lines: | 0 |
| Uncovered lines: | 256 |
| Coverable lines: | 256 |
| Total lines: | 462 |
| **Branch coverage:** | 0% (0 of 36) |
| Covered branches: | 0 |
| Total branches: | 36 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **.ctor(...)** | 0% | 20 | 4 | 0% |
| **GetBusinessMarketing()** | 0% | 6 | 2 | 0% |
| **GetTheme()** | 0% | 6 | 2 | 0% |
| **GetCoupons()** | 100% | 2 | 1 | 0% |
| **GetMenu()** | 0% | 6 | 2 | 0% |
| **GetMenuCategories()** | 100% | 2 | 1 | 0% |
| **GetNews()** | 100% | 2 | 1 | 0% |
| **GetNearbyBusinesses()** | 0% | 156 | 12 | 0% |
| **CalculateDistance(...)** | 100% | 2 | 1 | 0% |
| **GetCityMarketing()** | 0% | 156 | 12 | 0% |
| **GetCityTheme()** | 0% | 6 | 2 | 0% |

## File(s)

### E:\github\FunWasHad\src\FWH.MarketingApi\Controllers\MarketingController.cs
```
  1           using FWH.MarketingApi.Data;
  2           using FWH.MarketingApi.Models;
  3           using Microsoft.AspNetCore.Mvc;
  4           using Microsoft.EntityFrameworkCore;
  5           using Npgsql;
  6           
  7           namespace FWH.MarketingApi.Controllers;
  8           
  9           /// <summary>
 10           /// API controller for retrieving business marketing data (themes, coupons, menus, news).
 11           /// Implements TR-API-002: Marketing endpoints.
 12           /// </summary>
 13           /// <remarks>
 14           /// This controller provides all marketing-related endpoints as specified in TR-API-002:
 15           /// - Complete marketing data retrieval
 16           /// - Theme, coupons, menu, and news endpoints
 17           /// - Nearby business discovery
 18           /// </remarks>
 19           [ApiController]
 20           [Route("api/[controller]")]
 21           public class MarketingController : ControllerBase
 22           {
 23               private readonly MarketingDbContext _context;
 24               private readonly ILogger<MarketingController> _logger;
 25           
 26  ❌ 0         public MarketingController(MarketingDbContext context, ILogger<MarketingController> logger)
 27  ❌ 0         {
 28  ❌ 0  ○          _context = context ?? throw new ArgumentNullException(nameof(context));
 29  ❌ 0  ○          _logger = logger ?? throw new ArgumentNullException(nameof(logger));
 30  ❌ 0         }
 31           
 32               /// <summary>
 33               /// Get complete marketing data for a business (theme, coupons, menu, news).
 34               /// Implements TR-API-002: GET /api/marketing/{businessId}.
 35               /// </summary>
 36               /// <param name="businessId">Business ID</param>
 37               /// <returns>Complete marketing data including theme, coupons, menu items, and news</returns>
 38               /// <exception cref="NotFoundResult">Thrown when business is not found or not subscribed</exception>
 39               [HttpGet("{businessId}")]
 40               [ProducesResponseType(StatusCodes.Status200OK)]
 41               [ProducesResponseType(StatusCodes.Status404NotFound)]
 42               public async Task<ActionResult<BusinessMarketingResponse>> GetBusinessMarketing(long businessId)
 43  ❌ 0         {
 44  ❌ 0             var business = await _context.Businesses
 45  ❌ 0                 .Include(b => b.Theme)
 46  ❌ 0                 .Include(b => b.Coupons.Where(c => c.IsActive && c.ValidFrom <= DateTimeOffset.UtcNow && c.ValidUntil >= Dat
 47  ❌ 0                 .Include(b => b.MenuItems.Where(m => m.IsAvailable))
 48  ❌ 0                 .Include(b => b.NewsItems.Where(n => n.IsPublished && n.PublishedAt <= DateTimeOffset.UtcNow))
 49  ❌ 0                 .FirstOrDefaultAsync(b => b.Id == businessId && b.IsSubscribed);
 50           
 51  ❌ 0  ○          if (business == null)
 52  ❌ 0             {
 53  ❌ 0                 _logger.LogWarning("Business {BusinessId} not found or not subscribed", businessId);
 54  ❌ 0                 return NotFound();
 55                   }
 56           
 57  ❌ 0             var response = new BusinessMarketingResponse
 58  ❌ 0             {
 59  ❌ 0                 BusinessId = business.Id,
 60  ❌ 0                 BusinessName = business.Name,
 61  ❌ 0                 Theme = business.Theme,
 62  ❌ 0                 Coupons = business.Coupons.OrderByDescending(c => c.CreatedAt).ToList(),
 63  ❌ 0                 MenuItems = business.MenuItems.OrderBy(m => m.Category).ThenBy(m => m.SortOrder).ToList(),
 64  ❌ 0                 NewsItems = business.NewsItems.OrderByDescending(n => n.PublishedAt).Take(10).ToList()
 65  ❌ 0             };
 66           
 67  ❌ 0             _logger.LogDebug("Retrieved marketing data for business {BusinessId}", businessId);
 68  ❌ 0             return Ok(response);
 69  ❌ 0         }
 70           
 71               /// <summary>
 72               /// Get active theme for a business.
 73               /// Implements TR-API-002: GET /api/marketing/{businessId}/theme.
 74               /// </summary>
 75               /// <param name="businessId">Business ID</param>
 76               /// <returns>Active business theme</returns>
 77               /// <exception cref="NotFoundResult">Thrown when theme is not found or business is not subscribed</exception>
 78               [HttpGet("{businessId}/theme")]
 79               [ProducesResponseType(StatusCodes.Status200OK)]
 80               [ProducesResponseType(StatusCodes.Status404NotFound)]
 81               public async Task<ActionResult<BusinessTheme>> GetTheme(long businessId)
 82  ❌ 0         {
 83  ❌ 0             var theme = await _context.BusinessThemes
 84  ❌ 0                 .Include(t => t.Business)
 85  ❌ 0                 .FirstOrDefaultAsync(t => t.BusinessId == businessId && t.IsActive && t.Business.IsSubscribed);
 86           
 87  ❌ 0  ○          if (theme == null)
 88  ❌ 0             {
 89  ❌ 0                 _logger.LogWarning("Theme not found for business {BusinessId}", businessId);
 90  ❌ 0                 return NotFound();
 91                   }
 92           
 93  ❌ 0             return Ok(theme);
 94  ❌ 0         }
 95           
 96               /// <summary>
 97               /// Get active coupons for a business with pagination.
 98               /// Implements TR-API-002: GET /api/marketing/{businessId}/coupons.
 99               /// </summary>
100               /// <param name="businessId">Business ID</param>
101               /// <param name="page">Page number (1-based, default: 1)</param>
102               /// <param name="pageSize">Items per page (default: 20, max: 100)</param>
103               /// <returns>Paginated list of active coupons for the business</returns>
104               [HttpGet("{businessId}/coupons")]
105               [ProducesResponseType(StatusCodes.Status200OK)]
106               public async Task<ActionResult<PagedResult<Coupon>>> GetCoupons(
107                   long businessId,
108                   [FromQuery] int page = 1,
109                   [FromQuery] int pageSize = 20)
110  ❌ 0         {
111  ❌ 0             var pagination = new PaginationParameters { Page = page, PageSize = pageSize };
112  ❌ 0             pagination.Validate();
113           
114  ❌ 0             var now = DateTimeOffset.UtcNow;
115  ❌ 0             var query = _context.Coupons
116  ❌ 0                 .Include(c => c.Business)
117  ❌ 0                 .Where(c => c.BusinessId == businessId
118  ❌ 0                     && c.IsActive
119  ❌ 0                     && c.ValidFrom <= now
120  ❌ 0                     && c.ValidUntil >= now
121  ❌ 0                     && c.Business.IsSubscribed
122  ❌ 0                     && (c.MaxRedemptions == null || c.CurrentRedemptions < c.MaxRedemptions));
123           
124  ❌ 0             var totalCount = await query.CountAsync();
125  ❌ 0             var coupons = await query
126  ❌ 0                 .OrderByDescending(c => c.CreatedAt)
127  ❌ 0                 .Skip(pagination.Skip)
128  ❌ 0                 .Take(pagination.Take)
129  ❌ 0                 .ToListAsync();
130           
131  ❌ 0             var result = new PagedResult<Coupon>
132  ❌ 0             {
133  ❌ 0                 Items = coupons,
134  ❌ 0                 Page = pagination.Page,
135  ❌ 0                 PageSize = pagination.PageSize,
136  ❌ 0                 TotalCount = totalCount
137  ❌ 0             };
138           
139  ❌ 0             _logger.LogDebug("Retrieved {Count} coupons (page {Page}) for business {BusinessId}",
140  ❌ 0                 coupons.Count, pagination.Page, businessId);
141  ❌ 0             return Ok(result);
142  ❌ 0         }
143           
144               /// <summary>
145               /// Get menu items for a business, optionally filtered by category.
146               /// Implements TR-API-002: GET /api/marketing/{businessId}/menu.
147               /// </summary>
148               /// <param name="businessId">Business ID</param>
149               /// <param name="category">Optional category filter</param>
150               /// <returns>List of menu items, optionally filtered by category</returns>
151               [HttpGet("{businessId}/menu")]
152               [ProducesResponseType(StatusCodes.Status200OK)]
153               public async Task<ActionResult<List<MenuItem>>> GetMenu(long businessId, [FromQuery] string? category = null)
154  ❌ 0         {
155  ❌ 0             var query = _context.MenuItems
156  ❌ 0                 .Include(m => m.Business)
157  ❌ 0                 .Where(m => m.BusinessId == businessId && m.IsAvailable && m.Business.IsSubscribed);
158           
159  ❌ 0  ○          if (!string.IsNullOrEmpty(category))
160  ❌ 0             {
161  ❌ 0                 query = query.Where(m => m.Category == category);
162  ❌ 0             }
163           
164  ❌ 0             var menuItems = await query
165  ❌ 0                 .OrderBy(m => m.Category)
166  ❌ 0                 .ThenBy(m => m.SortOrder)
167  ❌ 0                 .ThenBy(m => m.Name)
168  ❌ 0                 .ToListAsync();
169           
170  ❌ 0             _logger.LogDebug("Retrieved {Count} menu items for business {BusinessId}", menuItems.Count, businessId);
171  ❌ 0             return Ok(menuItems);
172  ❌ 0         }
173           
174               /// <summary>
175               /// Get menu categories for a business.
176               /// Implements TR-API-002: GET /api/marketing/{businessId}/menu/categories.
177               /// </summary>
178               /// <param name="businessId">Business ID</param>
179               /// <returns>List of distinct menu categories</returns>
180               [HttpGet("{businessId}/menu/categories")]
181               [ProducesResponseType(StatusCodes.Status200OK)]
182               public async Task<ActionResult<List<string>>> GetMenuCategories(long businessId)
183  ❌ 0         {
184  ❌ 0             var categories = await _context.MenuItems
185  ❌ 0                 .Include(m => m.Business)
186  ❌ 0                 .Where(m => m.BusinessId == businessId && m.IsAvailable && m.Business.IsSubscribed)
187  ❌ 0                 .Select(m => m.Category)
188  ❌ 0                 .Distinct()
189  ❌ 0                 .OrderBy(c => c)
190  ❌ 0                 .ToListAsync();
191           
192  ❌ 0             return Ok(categories);
193  ❌ 0         }
194           
195               /// <summary>
196               /// Get news items for a business with pagination.
197               /// Implements TR-API-002: GET /api/marketing/{businessId}/news.
198               /// </summary>
199               /// <param name="businessId">Business ID</param>
200               /// <param name="page">Page number (1-based, default: 1)</param>
201               /// <param name="pageSize">Items per page (default: 20, max: 100)</param>
202               /// <returns>Paginated list of published news items for the business</returns>
203               [HttpGet("{businessId}/news")]
204               [ProducesResponseType(StatusCodes.Status200OK)]
205               public async Task<ActionResult<PagedResult<NewsItem>>> GetNews(
206                   long businessId,
207                   [FromQuery] int page = 1,
208                   [FromQuery] int pageSize = 20)
209  ❌ 0         {
210  ❌ 0             var pagination = new PaginationParameters { Page = page, PageSize = pageSize };
211  ❌ 0             pagination.Validate();
212           
213  ❌ 0             var now = DateTimeOffset.UtcNow;
214  ❌ 0             var query = _context.NewsItems
215  ❌ 0                 .Include(n => n.Business)
216  ❌ 0                 .Where(n => n.BusinessId == businessId
217  ❌ 0                     && n.IsPublished
218  ❌ 0                     && n.PublishedAt <= now
219  ❌ 0                     && n.Business.IsSubscribed
220  ❌ 0                     && (n.ExpiresAt == null || n.ExpiresAt > now));
221           
222  ❌ 0             var totalCount = await query.CountAsync();
223  ❌ 0             var newsItems = await query
224  ❌ 0                 .OrderByDescending(n => n.IsFeatured)
225  ❌ 0                 .ThenByDescending(n => n.PublishedAt)
226  ❌ 0                 .Skip(pagination.Skip)
227  ❌ 0                 .Take(pagination.Take)
228  ❌ 0                 .ToListAsync();
229           
230  ❌ 0             var result = new PagedResult<NewsItem>
231  ❌ 0             {
232  ❌ 0                 Items = newsItems,
233  ❌ 0                 Page = pagination.Page,
234  ❌ 0                 PageSize = pagination.PageSize,
235  ❌ 0                 TotalCount = totalCount
236  ❌ 0             };
237           
238  ❌ 0             _logger.LogDebug("Retrieved {Count} news items (page {Page}) for business {BusinessId}",
239  ❌ 0                 newsItems.Count, pagination.Page, businessId);
240  ❌ 0             return Ok(result);
241  ❌ 0         }
242           
243               /// <summary>
244               /// Find businesses near a location.
245               /// Implements TR-API-002: GET /api/marketing/nearby.
246               /// </summary>
247               /// <param name="latitude">Latitude coordinate (-90 to 90)</param>
248               /// <param name="longitude">Longitude coordinate (-180 to 180)</param>
249               /// <param name="radiusMeters">Search radius in meters (default 1000, max 50000)</param>
250               /// <returns>List of businesses within the specified radius</returns>
251               /// <exception cref="BadRequestResult">Thrown when coordinates are invalid or radius is out of range</exception>
252               [HttpGet("nearby")]
253               [ProducesResponseType(StatusCodes.Status200OK)]
254               [ProducesResponseType(StatusCodes.Status400BadRequest)]
255               public async Task<ActionResult<List<Business>>> GetNearbyBusinesses(
256                   [FromQuery] double latitude,
257                   [FromQuery] double longitude,
258                   [FromQuery] int radiusMeters = 1000)
259  ❌ 0         {
260  ❌ 0  ○          if (latitude < -90 || latitude > 90)
261  ❌ 0             {
262  ❌ 0                 return BadRequest("Latitude must be between -90 and 90");
263                   }
264           
265  ❌ 0  ○          if (longitude < -180 || longitude > 180)
266  ❌ 0             {
267  ❌ 0                 return BadRequest("Longitude must be between -180 and 180");
268                   }
269           
270  ❌ 0  ○          if (radiusMeters <= 0 || radiusMeters > 50000)
271  ❌ 0             {
272  ❌ 0                 return BadRequest("Radius must be between 1 and 50000 meters");
273                   }
274           
275                   // Try to use PostGIS spatial queries for efficient distance-based filtering
276                   // If PostGIS is not available (e.g., in test environments), fall back to bounding box method
277                   List<Business> businesses;
278           
279                   try
280  ❌ 0             {
281                       // Use parameterized SQL with PostGIS for efficient spatial query
282                       // This query uses the spatial GIST index for optimal performance
283                       // FormattableString automatically parameterizes the values
284  ❌ 0                 businesses = await _context.Businesses
285  ❌ 0                     .FromSqlInterpolated($@"
286  ❌ 0                         SELECT b.*
287  ❌ 0                         FROM businesses b
288  ❌ 0                         WHERE b.is_subscribed = true
289  ❌ 0                           AND b.location_geometry IS NOT NULL
290  ❌ 0                           AND ST_DWithin(
291  ❌ 0                               b.location_geometry::geography,
292  ❌ 0                               ST_SetSRID(ST_MakePoint({longitude}, {latitude}), 4326)::geography,
293  ❌ 0                               {radiusMeters}
294  ❌ 0                           )
295  ❌ 0                         ORDER BY ST_Distance(
296  ❌ 0                             b.location_geometry::geography,
297  ❌ 0                             ST_SetSRID(ST_MakePoint({longitude}, {latitude}), 4326)::geography
298  ❌ 0                         )
299  ❌ 0                     ")
300  ❌ 0                     .ToListAsync();
301           
302  ❌ 0                 _logger.LogDebug("Found {Count} businesses within {Radius}m of ({Lat}, {Lon}) using PostGIS spatial query",
303  ❌ 0                     businesses.Count, radiusMeters, latitude, longitude);
304  ❌ 0             }
305  ❌ 0             catch (Exception ex) when (ex is Npgsql.PostgresException pgEx && (pgEx.SqlState == "0A000" || pgEx.Message.Cont
306  ❌ 0                                          ex.Message.Contains("postgis", StringComparison.OrdinalIgnoreCase) ||
307  ❌ 0                                          ex.Message.Contains("ST_DWithin", StringComparison.OrdinalIgnoreCase) ||
308  ❌ 0                                          ex.Message.Contains("location_geometry", StringComparison.OrdinalIgnoreCase))
309  ❌ 0             {
310                       // PostGIS is not available, fall back to bounding box method
311  ❌ 0                 _logger.LogWarning(ex, "PostGIS not available, falling back to bounding box query method");
312           
313                       // Simple bounding box query (fallback when PostGIS is not available)
314  ❌ 0                 var latDelta = radiusMeters / 111000.0; // Approximate degrees
315  ❌ 0                 var lonDelta = radiusMeters / (111000.0 * Math.Cos(latitude * Math.PI / 180.0));
316           
317  ❌ 0                 var allBusinesses = await _context.Businesses
318  ❌ 0                     .Where(b => b.IsSubscribed
319  ❌ 0                         && b.Latitude >= latitude - latDelta
320  ❌ 0                         && b.Latitude <= latitude + latDelta
321  ❌ 0                         && b.Longitude >= longitude - lonDelta
322  ❌ 0                         && b.Longitude <= longitude + lonDelta)
323  ❌ 0                     .ToListAsync();
324           
325                       // Filter by actual distance
326  ❌ 0                 businesses = allBusinesses
327  ❌ 0                     .Select(b => new
328  ❌ 0                     {
329  ❌ 0                         Business = b,
330  ❌ 0                         Distance = CalculateDistance(latitude, longitude, b.Latitude, b.Longitude)
331  ❌ 0                     })
332  ❌ 0                     .Where(x => x.Distance <= radiusMeters)
333  ❌ 0                     .OrderBy(x => x.Distance)
334  ❌ 0                     .Select(x => x.Business)
335  ❌ 0                     .ToList();
336           
337  ❌ 0                 _logger.LogDebug("Found {Count} businesses within {Radius}m of ({Lat}, {Lon}) using bounding box fallback",
338  ❌ 0                     businesses.Count, radiusMeters, latitude, longitude);
339  ❌ 0             }
340           
341  ❌ 0             return Ok(businesses);
342  ❌ 0         }
343           
344               private static double CalculateDistance(double lat1, double lon1, double lat2, double lon2)
345  ❌ 0         {
346                   const double earthRadiusMeters = 6371000;
347  ❌ 0             var dLat = (lat2 - lat1) * Math.PI / 180.0;
348  ❌ 0             var dLon = (lon2 - lon1) * Math.PI / 180.0;
349           
350  ❌ 0             var a = Math.Sin(dLat / 2) * Math.Sin(dLat / 2) +
351  ❌ 0                     Math.Cos(lat1 * Math.PI / 180.0) * Math.Cos(lat2 * Math.PI / 180.0) *
352  ❌ 0                     Math.Sin(dLon / 2) * Math.Sin(dLon / 2);
353           
354  ❌ 0             var c = 2 * Math.Atan2(Math.Sqrt(a), Math.Sqrt(1 - a));
355  ❌ 0             return earthRadiusMeters * c;
356  ❌ 0         }
357           
358               /// <summary>
359               /// Get marketing information for a city by name and state/country.
360               /// </summary>
361               /// <param name="cityName">City name</param>
362               /// <param name="state">State or province (optional)</param>
363               /// <param name="country">Country (optional)</param>
364               /// <returns>City marketing data including theme</returns>
365               [HttpGet("city")]
366               [ProducesResponseType(StatusCodes.Status200OK)]
367               [ProducesResponseType(StatusCodes.Status404NotFound)]
368               public async Task<ActionResult<CityMarketingResponse>> GetCityMarketing(
369                   [FromQuery] string cityName,
370                   [FromQuery] string? state = null,
371                   [FromQuery] string? country = null)
372  ❌ 0         {
373  ❌ 0  ○          if (string.IsNullOrWhiteSpace(cityName))
374  ❌ 0             {
375  ❌ 0                 return BadRequest("City name is required");
376                   }
377           
378                   // Use EF.Functions.ILike for case-insensitive comparison (PostgreSQL-specific)
379                   // For cross-database compatibility, could use ToLower() but ILike is more efficient
380  ❌ 0             var query = _context.Cities
381  ❌ 0                 .Include(c => c.Theme)
382  ❌ 0                 .Where(c => c.IsActive && EF.Functions.ILike(c.Name, cityName));
383           
384  ❌ 0  ○          if (!string.IsNullOrWhiteSpace(state))
385  ❌ 0             {
386  ❌ 0                 query = query.Where(c => EF.Functions.ILike(c.State, state));
387  ❌ 0             }
388           
389  ❌ 0  ○          if (!string.IsNullOrWhiteSpace(country))
390  ❌ 0             {
391  ❌ 0                 query = query.Where(c => EF.Functions.ILike(c.Country, country));
392  ❌ 0             }
393           
394  ❌ 0             var city = await query.FirstOrDefaultAsync();
395           
396  ❌ 0  ○          if (city == null)
397  ❌ 0             {
398  ❌ 0                 _logger.LogWarning("City not found: {CityName}, {State}, {Country}", cityName, state, country);
399  ❌ 0                 return NotFound();
400                   }
401           
402                   // Create theme DTO to avoid circular reference issues
403  ❌ 0             CityThemeDto? themeDto = null;
404  ❌ 0  ○          if (city.Theme != null && city.Theme.IsActive)
405  ❌ 0             {
406  ❌ 0                 themeDto = new CityThemeDto
407  ❌ 0                 {
408  ❌ 0                     Id = city.Theme.Id,
409  ❌ 0                     CityId = city.Theme.CityId,
410  ❌ 0                     ThemeName = city.Theme.ThemeName,
411  ❌ 0                     PrimaryColor = city.Theme.PrimaryColor,
412  ❌ 0                     SecondaryColor = city.Theme.SecondaryColor,
413  ❌ 0                     AccentColor = city.Theme.AccentColor,
414  ❌ 0                     BackgroundColor = city.Theme.BackgroundColor,
415  ❌ 0                     TextColor = city.Theme.TextColor,
416  ❌ 0                     LogoUrl = city.Theme.LogoUrl,
417  ❌ 0                     BackgroundImageUrl = city.Theme.BackgroundImageUrl,
418  ❌ 0                     CustomCss = city.Theme.CustomCss,
419  ❌ 0                     IsActive = city.Theme.IsActive,
420  ❌ 0                     CreatedAt = city.Theme.CreatedAt,
421  ❌ 0                     UpdatedAt = city.Theme.UpdatedAt
422  ❌ 0                 };
423  ❌ 0             }
424           
425  ❌ 0             var response = new CityMarketingResponse
426  ❌ 0             {
427  ❌ 0                 CityId = city.Id,
428  ❌ 0                 CityName = city.Name,
429  ❌ 0                 State = city.State,
430  ❌ 0                 Country = city.Country,
431  ❌ 0                 Description = city.Description,
432  ❌ 0                 Website = city.Website,
433  ❌ 0                 Theme = themeDto
434  ❌ 0             };
435           
436  ❌ 0             _logger.LogDebug("Retrieved marketing data for city: {CityName}", city.Name);
437  ❌ 0             return Ok(response);
438  ❌ 0         }
439           
440               /// <summary>
441               /// Get city theme by city ID.
442               /// </summary>
443               /// <param name="cityId">City ID</param>
444               /// <returns>City theme</returns>
445               [HttpGet("city/{cityId}/theme")]
446               [ProducesResponseType(StatusCodes.Status200OK)]
447               [ProducesResponseType(StatusCodes.Status404NotFound)]
448               public async Task<ActionResult<CityTheme>> GetCityTheme(long cityId)
449  ❌ 0         {
450  ❌ 0             var theme = await _context.CityThemes
451  ❌ 0                 .Include(t => t.City)
452  ❌ 0                 .FirstOrDefaultAsync(t => t.CityId == cityId && t.IsActive && t.City.IsActive);
453           
454  ❌ 0  ○          if (theme == null)
455  ❌ 0             {
456  ❌ 0                 _logger.LogWarning("Theme not found for city {CityId}", cityId);
457  ❌ 0                 return NotFound();
458                   }
459           
460  ❌ 0             return Ok(theme);
461  ❌ 0         }
462           }
```
# FWH.MarketingApi.Data.DatabaseMigrationService

## Summary

|||
|:---|:---|
| Class: | FWH.MarketingApi.Data.DatabaseMigrationService |
| Assembly: | FWH.MarketingApi |
| **File(s):** | E:\github\FunWasHad\src\FWH.MarketingApi\Data\DatabaseMigrationService.cs |
| **Line coverage:** | 58.6% (95 of 162) |
| Covered lines: | 95 |
| Uncovered lines: | 67 |
| Coverable lines: | 162 |
| Total lines: | 255 |
| **Branch coverage:** | 53.7% (29 of 54) |
| Covered branches: | 29 |
| Total branches: | 54 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **.ctor(...)** | 50.0% | 4 | 4 | 100% |
| **GetConnectionString()** | 11.11% | 229 | 18 | 13.33% |
| **ApplyMigrationsAsync()** | 62.50% | 11 | 8 | 63.88% |
| **EnsureDatabaseExistsAsync()** | 60.0% | 16 | 10 | 60.71% |
| **EnsureMigrationsTableAsync()** | 100% | 4 | 4 | 100% |
| **IsMigrationAppliedAsync()** | 100% | 4 | 4 | 100% |
| **ExecuteMigrationAsync()** | 100% | 11 | 10 | 82.60% |

## File(s)

### E:\github\FunWasHad\src\FWH.MarketingApi\Data\DatabaseMigrationService.cs
```
  1            using Microsoft.Extensions.Logging;
  2            using Npgsql;
  3            using System;
  4            using System.IO;
  5            using System.Linq;
  6            using System.Threading.Tasks;
  7            
  8            namespace FWH.MarketingApi.Data;
  9            
 10            /// <summary>
 11            /// Service for applying SQL-based database migrations.
 12            /// Reads .sql files from the Migrations folder and executes them in order.
 13            /// </summary>
 14            public class DatabaseMigrationService
 15            {
 16                private readonly string _connectionString;
 17                private readonly ILogger<DatabaseMigrationService> _logger;
 18            
 19  ✔   3         public DatabaseMigrationService(string connectionString, ILogger<DatabaseMigrationService> logger)
 20  ✔   3         {
 21  ✓   3  ◑          _connectionString = connectionString ?? throw new ArgumentNullException(nameof(connectionString));
 22  ✓   3  ◑          _logger = logger ?? throw new ArgumentNullException(nameof(logger));
 23  ✔   3         }
 24            
 25                /// <summary>
 26                /// Converts PostgreSQL URI format connection string to standard format if needed.
 27                /// NpgsqlConnectionStringBuilder doesn't support URI format directly.
 28                /// </summary>
 29                private string GetConnectionString()
 30  ✔  18         {
 31  ✔  18             var connectionString = _connectionString;
 32  ✓  18  ◑          if (connectionString.StartsWith("postgresql://", StringComparison.OrdinalIgnoreCase) ||
 33  ✔  18                 connectionString.StartsWith("postgres://", StringComparison.OrdinalIgnoreCase))
 34  ❌  0             {
 35                        try
 36  ❌  0                 {
 37                            // Parse the URI manually
 38  ❌  0                     var uri = new Uri(connectionString);
 39  ❌  0  ○                  var builder = new NpgsqlConnectionStringBuilder
 40  ❌  0                     {
 41  ❌  0                         Host = uri.Host,
 42  ❌  0                         Port = uri.Port > 0 ? uri.Port : 5432,
 43  ❌  0                         Database = uri.AbsolutePath.TrimStart('/'),
 44  ❌  0                         Username = uri.UserInfo.Split(':')[0],
 45  ❌  0                         Password = uri.UserInfo.Contains(':')
 46  ❌  0                             ? Uri.UnescapeDataString(uri.UserInfo.Split(':', 2)[1])
 47  ❌  0                             : string.Empty
 48  ❌  0                     };
 49            
 50                            // Parse query string parameters if present (e.g., ?sslmode=require)
 51  ❌  0  ○                  if (!string.IsNullOrEmpty(uri.Query) && uri.Query.Length > 1)
 52  ❌  0                     {
 53  ❌  0                         var query = uri.Query.Substring(1); // Remove leading '?'
 54  ❌  0                         var pairs = query.Split('&');
 55  ❌  0  ○                      foreach (var pair in pairs)
 56  ❌  0                         {
 57  ❌  0                             var keyValue = pair.Split('=', 2);
 58  ❌  0  ○                          if (keyValue.Length == 2 && !string.IsNullOrEmpty(keyValue[0]))
 59  ❌  0                             {
 60  ❌  0                                 var key = Uri.UnescapeDataString(keyValue[0]);
 61  ❌  0                                 var value = Uri.UnescapeDataString(keyValue[1]);
 62  ❌  0                                 builder[key] = value;
 63  ❌  0                             }
 64  ❌  0                         }
 65  ❌  0                     }
 66            
 67  ❌  0                     connectionString = builder.ToString();
 68  ❌  0                     _logger.LogDebug("Converted PostgreSQL URI to connection string format");
 69  ❌  0                 }
 70  ❌  0                 catch (Exception ex)
 71  ❌  0                 {
 72  ❌  0                     _logger.LogError(ex, "Failed to parse connection string URI format. Connection string starts with: {Pref
 73  ❌  0                         connectionString.Substring(0, Math.Min(20, connectionString.Length)));
 74  ❌  0                     throw new ArgumentException(
 75  ❌  0                         "Connection string is in URI format but cannot be parsed. " +
 76  ❌  0                         "Ensure Railway DATABASE_URL is properly formatted.", ex);
 77                        }
 78  ❌  0             }
 79            
 80  ✔  18             return connectionString;
 81  ✔  18         }
 82            
 83                public async Task ApplyMigrationsAsync()
 84  ✔   3         {
 85  ✔   3             _logger.LogDebug("Starting database migration process");
 86            
 87                    try
 88  ✔   3             {
 89                        // Ensure database exists before attempting to connect to it
 90  ✔   3                 await EnsureDatabaseExistsAsync();
 91            
 92                        // Ensure migrations table exists
 93  ✔   3                 await EnsureMigrationsTableAsync();
 94            
 95                        // Get migration files from Migrations directory
 96  ✔   3                 var migrationsPath = Path.Combine(AppDomain.CurrentDomain.BaseDirectory, "Migrations");
 97            
 98  ✓   3  ◑              if (!Directory.Exists(migrationsPath))
 99  ❌  0                 {
100  ❌  0                     _logger.LogWarning("Migrations directory not found at {Path}, skipping migrations", migrationsPath);
101  ❌  0                     return;
102                        }
103            
104  ✔   3                 var migrationFiles = Directory.GetFiles(migrationsPath, "*.sql")
105  ✔   6                     .OrderBy(f => Path.GetFileName(f))
106  ✔   3                     .ToList();
107            
108  ✓   3  ◑              if (migrationFiles.Count == 0)
109  ❌  0                 {
110  ❌  0                     _logger.LogDebug("No migration files found");
111  ❌  0                     return;
112                        }
113            
114  ✔   3                 _logger.LogDebug("Found {Count} migration files", migrationFiles.Count);
115            
116                        // Apply each migration
117  ✔  21  ●              foreach (var migrationFile in migrationFiles)
118  ✔   6                 {
119  ✔   6                     var migrationName = Path.GetFileNameWithoutExtension(migrationFile);
120            
121  ✓   6  ◑                  if (await IsMigrationAppliedAsync(migrationName))
122  ❌  0                     {
123  ❌  0                         _logger.LogDebug("Migration {Name} already applied, skipping", migrationName);
124  ❌  0                         continue;
125                            }
126            
127  ✔   6                     _logger.LogInformation("Applying migration: {Name}", migrationName);
128            
129  ✔   6                     var sql = await File.ReadAllTextAsync(migrationFile);
130  ✔   6                     await ExecuteMigrationAsync(sql, migrationName);
131            
132  ✔   6                     _logger.LogInformation("Successfully applied migration: {Name}", migrationName);
133  ✔   6                 }
134            
135  ✔   3                 _logger.LogInformation("Database migration process completed");
136  ✔   3             }
137  ❌  0             catch (Exception ex)
138  ❌  0             {
139  ❌  0                 _logger.LogError(ex, "Failed to apply database migrations");
140  ❌  0                 throw;
141                    }
142  ✔   3         }
143            
144                private async Task EnsureDatabaseExistsAsync()
145  ✔   3         {
146                    // Get connection string (converts URI format if needed)
147  ✔   3             var connectionString = GetConnectionString();
148  ✔   3             var builder = new NpgsqlConnectionStringBuilder(connectionString);
149            
150                    // If the connection string doesn't set a database explicitly, nothing to create.
151  ✔   3             var targetDatabase = builder.Database;
152  ✓   3  ◑          if (string.IsNullOrWhiteSpace(targetDatabase))
153  ❌  0             {
154  ❌  0                 _logger.LogDebug("No database specified in connection string; skipping database creation check.");
155  ❌  0                 return;
156                    }
157            
158                    // Connect to a known-existing maintenance DB to create/check the target DB.
159                    // 'postgres' is present on typical Postgres installations.
160  ✔   3             builder.Database = "postgres";
161            
162  ✔   3             await using var adminConnection = new NpgsqlConnection(builder.ConnectionString);
163  ✔   3             await adminConnection.OpenAsync();
164            
165                    const string existsSql = "SELECT 1 FROM pg_database WHERE datname = @db";
166  ✔   3             await using (var existsCommand = new NpgsqlCommand(existsSql, adminConnection))
167  ✔   3             {
168  ✔   3                 existsCommand.Parameters.AddWithValue("db", targetDatabase);
169  ✔   3                 var exists = await existsCommand.ExecuteScalarAsync() is not null;
170            
171  ✓   3  ◑              if (exists)
172  ✔   3                 {
173  ✔   3                     _logger.LogInformation("Database '{Database}' already exists", targetDatabase);
174  ✔   3                     return;
175                        }
176  ❌  0  ●          }
177            
178                    // CREATE DATABASE cannot be parameterized; quote identifier safely.
179  ❌  0             var quotedDbName = '"' + targetDatabase.Replace("\"", "\"\"") + '"';
180  ❌  0             var createSql = $"CREATE DATABASE {quotedDbName}";
181            
182  ❌  0             await using (var createCommand = new NpgsqlCommand(createSql, adminConnection))
183  ❌  0             {
184  ❌  0                 await createCommand.ExecuteNonQueryAsync();
185  ❌  0  ○          }
186            
187  ❌  0  ●          _logger.LogInformation("Database '{Database}' created", targetDatabase);
188  ✔   3         }
189            
190                private async Task EnsureMigrationsTableAsync()
191  ✔   3         {
192  ✔   3             var sql = @"
193  ✔   3                 CREATE TABLE IF NOT EXISTS __migrations (
194  ✔   3                     id SERIAL PRIMARY KEY,
195  ✔   3                     migration_name VARCHAR(255) NOT NULL UNIQUE,
196  ✔   3                     applied_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT (now() at time zone 'utc')
197  ✔   3                 );
198  ✔   3             ";
199            
200  ✔   3             var connectionString = GetConnectionString();
201  ✔   3             await using var connection = new NpgsqlConnection(connectionString);
202  ✔   3             await connection.OpenAsync();
203            
204  ✔   3             await using var command = new NpgsqlCommand(sql, connection);
205  ✔   3  ●          await command.ExecuteNonQueryAsync();
206  ✔   3         }
207            
208                private async Task<bool> IsMigrationAppliedAsync(string migrationName)
209  ✔   6         {
210  ✔   6             var sql = "SELECT COUNT(*) FROM __migrations WHERE migration_name = @name";
211            
212  ✔   6             var connectionString = GetConnectionString();
213  ✔   6             await using var connection = new NpgsqlConnection(connectionString);
214  ✔   6             await connection.OpenAsync();
215            
216  ✔   6             await using var command = new NpgsqlCommand(sql, connection);
217  ✔   6             command.Parameters.AddWithValue("name", migrationName);
218            
219  ✔   6             var result = await command.ExecuteScalarAsync();
220  ✔   6  ●          return Convert.ToInt32(result) > 0;
221  ✔   6         }
222            
223                private async Task ExecuteMigrationAsync(string sql, string migrationName)
224  ✔   6         {
225  ✔   6             var connectionString = GetConnectionString();
226  ✔   6             await using var connection = new NpgsqlConnection(connectionString);
227  ✔   6             await connection.OpenAsync();
228            
229  ✔   6  ●          await using var transaction = await connection.BeginTransactionAsync();
230            
231                    try
232  ✔   6             {
233                        // Execute migration SQL
234  ✔   6                 await using (var command = new NpgsqlCommand(sql, connection, transaction))
235  ✔   6                 {
236  ✔   6                     await command.ExecuteNonQueryAsync();
237  ✔   6  ●              }
238            
239                        // Record migration as applied
240  ✔   6                 var recordSql = "INSERT INTO __migrations (migration_name) VALUES (@name)";
241  ✔   6                 await using (var command = new NpgsqlCommand(recordSql, connection, transaction))
242  ✔   6                 {
243  ✔   6                     command.Parameters.AddWithValue("name", migrationName);
244  ✔   6                     await command.ExecuteNonQueryAsync();
245  ✔   6  ●              }
246            
247  ✔   6                 await transaction.CommitAsync();
248  ✔   6             }
249  ❌  0             catch
250  ❌  0             {
251  ❌  0                 await transaction.RollbackAsync();
252  ❌  0                 throw;
253                    }
254  ✔   6         }
255            }
```
# FWH.MarketingApi.Data.MarketingDbContext

## Summary

|||
|:---|:---|
| Class: | FWH.MarketingApi.Data.MarketingDbContext |
| Assembly: | FWH.MarketingApi |
| **File(s):** | E:\github\FunWasHad\src\FWH.MarketingApi\Data\MarketingDbContext.cs |
| **Line coverage:** | 5.2% (12 of 227) |
| Covered lines: | 12 |
| Uncovered lines: | 215 |
| Coverable lines: | 227 |
| Total lines: | 263 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **.ctor(...)** | 100% | 1 | 1 | 100% |
| **get_Businesses()** | 100% | 1 | 1 | 100% |
| **get_BusinessThemes()** | 100% | 2 | 1 | 0% |
| **get_Coupons()** | 100% | 2 | 1 | 0% |
| **get_MenuItems()** | 100% | 2 | 1 | 0% |
| **get_NewsItems()** | 100% | 2 | 1 | 0% |
| **get_Feedbacks()** | 100% | 1 | 1 | 100% |
| **get_FeedbackAttachments()** | 100% | 1 | 1 | 100% |
| **get_Cities()** | 100% | 1 | 1 | 100% |
| **get_CityThemes()** | 100% | 1 | 1 | 100% |
| **get_TourismMarkets()** | 100% | 1 | 1 | 100% |
| **get_CityTourismMarkets()** | 100% | 1 | 1 | 100% |
| **get_Airports()** | 100% | 1 | 1 | 100% |
| **get_AirportTourismMarkets()** | 100% | 1 | 1 | 100% |
| **OnModelCreating(...)** | 100% | 2 | 1 | 0% |

## File(s)

### E:\github\FunWasHad\src\FWH.MarketingApi\Data\MarketingDbContext.cs
```
  1            using FWH.MarketingApi.Models;
  2            using Microsoft.EntityFrameworkCore;
  3            
  4            namespace FWH.MarketingApi.Data;
  5            
  6            public class MarketingDbContext : DbContext
  7            {
  8  ✔  45         public MarketingDbContext(DbContextOptions<MarketingDbContext> options) : base(options)
  9  ✔  45         {
 10  ✔  45         }
 11            
 12  ✔  33         public DbSet<Business> Businesses => Set<Business>();
 13  ❌  0         public DbSet<BusinessTheme> BusinessThemes => Set<BusinessTheme>();
 14  ❌  0         public DbSet<Coupon> Coupons => Set<Coupon>();
 15  ❌  0         public DbSet<MenuItem> MenuItems => Set<MenuItem>();
 16  ❌  0         public DbSet<NewsItem> NewsItems => Set<NewsItem>();
 17  ✔  28         public DbSet<Feedback> Feedbacks => Set<Feedback>();
 18  ✔  21         public DbSet<FeedbackAttachment> FeedbackAttachments => Set<FeedbackAttachment>();
 19  ✔  37         public DbSet<City> Cities => Set<City>();
 20  ✔  20         public DbSet<CityTheme> CityThemes => Set<CityTheme>();
 21  ✔  32         public DbSet<TourismMarket> TourismMarkets => Set<TourismMarket>();
 22  ✔  32         public DbSet<CityTourismMarket> CityTourismMarkets => Set<CityTourismMarket>();
 23  ✔  37         public DbSet<Airport> Airports => Set<Airport>();
 24  ✔  32         public DbSet<AirportTourismMarket> AirportTourismMarkets => Set<AirportTourismMarket>();
 25            
 26                protected override void OnModelCreating(ModelBuilder modelBuilder)
 27  ❌  0         {
 28                    // Business configuration
 29  ❌  0             modelBuilder.Entity<Business>(entity =>
 30  ❌  0             {
 31  ❌  0                 entity.ToTable("businesses");
 32  ❌  0                 entity.HasKey(e => e.Id);
 33  ❌  0                 entity.Property(e => e.Name).IsRequired().HasMaxLength(200);
 34  ❌  0                 entity.Property(e => e.Address).IsRequired().HasMaxLength(500);
 35  ❌  0                 entity.Property(e => e.PhoneNumber).HasMaxLength(50);
 36  ❌  0                 entity.Property(e => e.Email).HasMaxLength(200);
 37  ❌  0                 entity.Property(e => e.Website).HasMaxLength(500);
 38  ❌  0                 entity.Property(e => e.CreatedAt).HasDefaultValueSql("now() at time zone 'utc'");
 39  ❌  0     
 40  ❌  0                 entity.HasIndex(e => new { e.Latitude, e.Longitude });
 41  ❌  0                 entity.HasIndex(e => e.IsSubscribed);
 42  ❌  0             });
 43            
 44                    // BusinessTheme configuration
 45  ❌  0             modelBuilder.Entity<BusinessTheme>(entity =>
 46  ❌  0             {
 47  ❌  0                 entity.ToTable("business_themes");
 48  ❌  0                 entity.HasKey(e => e.Id);
 49  ❌  0                 entity.Property(e => e.ThemeName).IsRequired().HasMaxLength(100);
 50  ❌  0                 entity.Property(e => e.PrimaryColor).HasMaxLength(20);
 51  ❌  0                 entity.Property(e => e.SecondaryColor).HasMaxLength(20);
 52  ❌  0                 entity.Property(e => e.CreatedAt).HasDefaultValueSql("now() at time zone 'utc'");
 53  ❌  0     
 54  ❌  0                 entity.HasOne(e => e.Business)
 55  ❌  0                     .WithOne(b => b.Theme)
 56  ❌  0                     .HasForeignKey<BusinessTheme>(e => e.BusinessId)
 57  ❌  0                     .OnDelete(DeleteBehavior.Cascade);
 58  ❌  0             });
 59            
 60                    // Coupon configuration
 61  ❌  0             modelBuilder.Entity<Coupon>(entity =>
 62  ❌  0             {
 63  ❌  0                 entity.ToTable("coupons");
 64  ❌  0                 entity.HasKey(e => e.Id);
 65  ❌  0                 entity.Property(e => e.Title).IsRequired().HasMaxLength(200);
 66  ❌  0                 entity.Property(e => e.Description).IsRequired();
 67  ❌  0                 entity.Property(e => e.Code).HasMaxLength(50);
 68  ❌  0                 entity.Property(e => e.CreatedAt).HasDefaultValueSql("now() at time zone 'utc'");
 69  ❌  0     
 70  ❌  0                 entity.HasOne(e => e.Business)
 71  ❌  0                     .WithMany(b => b.Coupons)
 72  ❌  0                     .HasForeignKey(e => e.BusinessId)
 73  ❌  0                     .OnDelete(DeleteBehavior.Cascade);
 74  ❌  0     
 75  ❌  0                 entity.HasIndex(e => new { e.BusinessId, e.IsActive });
 76  ❌  0                 entity.HasIndex(e => new { e.ValidFrom, e.ValidUntil });
 77  ❌  0             });
 78            
 79                    // MenuItem configuration
 80  ❌  0             modelBuilder.Entity<MenuItem>(entity =>
 81  ❌  0             {
 82  ❌  0                 entity.ToTable("menu_items");
 83  ❌  0                 entity.HasKey(e => e.Id);
 84  ❌  0                 entity.Property(e => e.Name).IsRequired().HasMaxLength(200);
 85  ❌  0                 entity.Property(e => e.Category).IsRequired().HasMaxLength(100);
 86  ❌  0                 entity.Property(e => e.Currency).HasMaxLength(10);
 87  ❌  0                 entity.Property(e => e.CreatedAt).HasDefaultValueSql("now() at time zone 'utc'");
 88  ❌  0     
 89  ❌  0                 entity.HasOne(e => e.Business)
 90  ❌  0                     .WithMany(b => b.MenuItems)
 91  ❌  0                     .HasForeignKey(e => e.BusinessId)
 92  ❌  0                     .OnDelete(DeleteBehavior.Cascade);
 93  ❌  0     
 94  ❌  0                 entity.HasIndex(e => new { e.BusinessId, e.Category, e.IsAvailable });
 95  ❌  0             });
 96            
 97                    // NewsItem configuration
 98  ❌  0             modelBuilder.Entity<NewsItem>(entity =>
 99  ❌  0             {
100  ❌  0                 entity.ToTable("news_items");
101  ❌  0                 entity.HasKey(e => e.Id);
102  ❌  0                 entity.Property(e => e.Title).IsRequired().HasMaxLength(200);
103  ❌  0                 entity.Property(e => e.Content).IsRequired();
104  ❌  0                 entity.Property(e => e.Author).HasMaxLength(100);
105  ❌  0                 entity.Property(e => e.CreatedAt).HasDefaultValueSql("now() at time zone 'utc'");
106  ❌  0     
107  ❌  0                 entity.HasOne(e => e.Business)
108  ❌  0                     .WithMany(b => b.NewsItems)
109  ❌  0                     .HasForeignKey(e => e.BusinessId)
110  ❌  0                     .OnDelete(DeleteBehavior.Cascade);
111  ❌  0     
112  ❌  0                 entity.HasIndex(e => new { e.BusinessId, e.IsPublished, e.PublishedAt });
113  ❌  0             });
114            
115                    // Feedback configuration
116  ❌  0             modelBuilder.Entity<Feedback>(entity =>
117  ❌  0             {
118  ❌  0                 entity.ToTable("feedback");
119  ❌  0                 entity.HasKey(e => e.Id);
120  ❌  0                 entity.Property(e => e.UserId).IsRequired().HasMaxLength(200);
121  ❌  0                 entity.Property(e => e.UserName).HasMaxLength(200);
122  ❌  0                 entity.Property(e => e.UserEmail).HasMaxLength(200);
123  ❌  0                 entity.Property(e => e.FeedbackType).IsRequired().HasMaxLength(50);
124  ❌  0                 entity.Property(e => e.Subject).IsRequired().HasMaxLength(200);
125  ❌  0                 entity.Property(e => e.Message).IsRequired();
126  ❌  0                 entity.Property(e => e.SubmittedAt).HasDefaultValueSql("now() at time zone 'utc'");
127  ❌  0     
128  ❌  0                 entity.HasOne(e => e.Business)
129  ❌  0                     .WithMany(b => b.Feedback)
130  ❌  0                     .HasForeignKey(e => e.BusinessId)
131  ❌  0                     .OnDelete(DeleteBehavior.Cascade);
132  ❌  0     
133  ❌  0                 entity.HasIndex(e => new { e.BusinessId, e.SubmittedAt });
134  ❌  0                 entity.HasIndex(e => new { e.UserId, e.SubmittedAt });
135  ❌  0                 entity.HasIndex(e => new { e.IsPublic, e.IsApproved });
136  ❌  0             });
137            
138                    // FeedbackAttachment configuration
139  ❌  0             modelBuilder.Entity<FeedbackAttachment>(entity =>
140  ❌  0             {
141  ❌  0                 entity.ToTable("feedback_attachments");
142  ❌  0                 entity.HasKey(e => e.Id);
143  ❌  0                 entity.Property(e => e.AttachmentType).IsRequired().HasMaxLength(20);
144  ❌  0                 entity.Property(e => e.FileName).IsRequired().HasMaxLength(500);
145  ❌  0                 entity.Property(e => e.ContentType).IsRequired().HasMaxLength(100);
146  ❌  0                 entity.Property(e => e.StorageUrl).IsRequired();
147  ❌  0                 entity.Property(e => e.UploadedAt).HasDefaultValueSql("now() at time zone 'utc'");
148  ❌  0     
149  ❌  0                 entity.HasOne(e => e.Feedback)
150  ❌  0                     .WithMany(f => f.Attachments)
151  ❌  0                     .HasForeignKey(e => e.FeedbackId)
152  ❌  0                     .OnDelete(DeleteBehavior.Cascade);
153  ❌  0             });
154            
155                    // City configuration
156  ❌  0             modelBuilder.Entity<City>(entity =>
157  ❌  0             {
158  ❌  0                 entity.ToTable("cities");
159  ❌  0                 entity.HasKey(e => e.Id);
160  ❌  0                 entity.Property(e => e.Name).IsRequired().HasMaxLength(200);
161  ❌  0                 entity.Property(e => e.State).IsRequired().HasMaxLength(100);
162  ❌  0                 entity.Property(e => e.Country).IsRequired().HasMaxLength(100);
163  ❌  0                 entity.Property(e => e.Description).HasMaxLength(2000);
164  ❌  0                 entity.Property(e => e.Website).HasMaxLength(500);
165  ❌  0                 entity.Property(e => e.CreatedAt).HasDefaultValueSql("now() at time zone 'utc'");
166  ❌  0     
167  ❌  0                 entity.HasIndex(e => new { e.Name, e.State, e.Country });
168  ❌  0                 entity.HasIndex(e => e.IsActive);
169  ❌  0             });
170            
171                    // CityTheme configuration
172  ❌  0             modelBuilder.Entity<CityTheme>(entity =>
173  ❌  0             {
174  ❌  0                 entity.ToTable("city_themes");
175  ❌  0                 entity.HasKey(e => e.Id);
176  ❌  0                 entity.Property(e => e.ThemeName).IsRequired().HasMaxLength(100);
177  ❌  0                 entity.Property(e => e.PrimaryColor).HasMaxLength(20);
178  ❌  0                 entity.Property(e => e.SecondaryColor).HasMaxLength(20);
179  ❌  0                 entity.Property(e => e.CreatedAt).HasDefaultValueSql("now() at time zone 'utc'");
180  ❌  0     
181  ❌  0                 entity.HasOne(e => e.City)
182  ❌  0                     .WithOne(c => c.Theme)
183  ❌  0                     .HasForeignKey<CityTheme>(e => e.CityId)
184  ❌  0                     .OnDelete(DeleteBehavior.Cascade);
185  ❌  0             });
186            
187                    // TourismMarket configuration
188  ❌  0             modelBuilder.Entity<TourismMarket>(entity =>
189  ❌  0             {
190  ❌  0                 entity.ToTable("tourism_markets");
191  ❌  0                 entity.HasKey(e => e.Id);
192  ❌  0                 entity.Property(e => e.Name).IsRequired().HasMaxLength(200);
193  ❌  0                 entity.Property(e => e.Description).HasMaxLength(2000);
194  ❌  0                 entity.Property(e => e.CreatedAt).HasDefaultValueSql("now() at time zone 'utc'");
195  ❌  0     
196  ❌  0                 entity.HasIndex(e => e.IsActive);
197  ❌  0             });
198            
199                    // CityTourismMarket configuration (join table)
200  ❌  0             modelBuilder.Entity<CityTourismMarket>(entity =>
201  ❌  0             {
202  ❌  0                 entity.ToTable("city_tourism_markets");
203  ❌  0                 entity.HasKey(e => e.Id);
204  ❌  0                 entity.Property(e => e.CreatedAt).HasDefaultValueSql("now() at time zone 'utc'");
205  ❌  0     
206  ❌  0                 entity.HasOne(e => e.City)
207  ❌  0                     .WithMany(c => c.CityTourismMarkets)
208  ❌  0                     .HasForeignKey(e => e.CityId)
209  ❌  0                     .OnDelete(DeleteBehavior.Cascade);
210  ❌  0     
211  ❌  0                 entity.HasOne(e => e.TourismMarket)
212  ❌  0                     .WithMany(t => t.CityTourismMarkets)
213  ❌  0                     .HasForeignKey(e => e.TourismMarketId)
214  ❌  0                     .OnDelete(DeleteBehavior.Cascade);
215  ❌  0     
216  ❌  0                 // Ensure unique combination of City and TourismMarket
217  ❌  0                 entity.HasIndex(e => new { e.CityId, e.TourismMarketId }).IsUnique();
218  ❌  0             });
219            
220                    // Airport configuration
221  ❌  0             modelBuilder.Entity<Airport>(entity =>
222  ❌  0             {
223  ❌  0                 entity.ToTable("airports");
224  ❌  0                 entity.HasKey(e => e.Id);
225  ❌  0                 entity.Property(e => e.Name).IsRequired().HasMaxLength(200);
226  ❌  0                 entity.Property(e => e.IataCode).IsRequired().HasMaxLength(3);
227  ❌  0                 entity.Property(e => e.IcaoCode).HasMaxLength(4);
228  ❌  0                 entity.Property(e => e.City).IsRequired().HasMaxLength(200);
229  ❌  0                 entity.Property(e => e.State).IsRequired().HasMaxLength(100);
230  ❌  0                 entity.Property(e => e.Country).IsRequired().HasMaxLength(100);
231  ❌  0                 entity.Property(e => e.Description).HasMaxLength(2000);
232  ❌  0                 entity.Property(e => e.Latitude).IsRequired();
233  ❌  0                 entity.Property(e => e.Longitude).IsRequired();
234  ❌  0                 entity.Property(e => e.CreatedAt).HasDefaultValueSql("now() at time zone 'utc'");
235  ❌  0     
236  ❌  0                 entity.HasIndex(e => e.IataCode);
237  ❌  0                 entity.HasIndex(e => e.IcaoCode);
238  ❌  0                 entity.HasIndex(e => new { e.Latitude, e.Longitude });
239  ❌  0                 entity.HasIndex(e => e.IsActive);
240  ❌  0             });
241            
242                    // AirportTourismMarket configuration (join table)
243  ❌  0             modelBuilder.Entity<AirportTourismMarket>(entity =>
244  ❌  0             {
245  ❌  0                 entity.ToTable("airport_tourism_markets");
246  ❌  0                 entity.HasKey(e => e.Id);
247  ❌  0                 entity.Property(e => e.CreatedAt).HasDefaultValueSql("now() at time zone 'utc'");
248  ❌  0     
249  ❌  0                 entity.HasOne(e => e.Airport)
250  ❌  0                     .WithMany(a => a.AirportTourismMarkets)
251  ❌  0                     .HasForeignKey(e => e.AirportId)
252  ❌  0                     .OnDelete(DeleteBehavior.Cascade);
253  ❌  0     
254  ❌  0                 entity.HasOne(e => e.TourismMarket)
255  ❌  0                     .WithMany(t => t.AirportTourismMarkets)
256  ❌  0                     .HasForeignKey(e => e.TourismMarketId)
257  ❌  0                     .OnDelete(DeleteBehavior.Cascade);
258  ❌  0     
259  ❌  0                 // Ensure unique combination of Airport and TourismMarket
260  ❌  0                 entity.HasIndex(e => new { e.AirportId, e.TourismMarketId }).IsUnique();
261  ❌  0             });
262  ❌  0         }
263            }
```
# FWH.MarketingApi.Middleware.ApiKeyAuthenticationMiddleware

## Summary

|||
|:---|:---|
| Class: | FWH.MarketingApi.Middleware.ApiKeyAuthenticationMiddleware |
| Assembly: | FWH.MarketingApi |
| **File(s):** | E:\github\FunWasHad\src\FWH.MarketingApi\Middleware\ApiKeyAuthenticationMiddleware.cs |
| **Line coverage:** | 90.7% (49 of 54) |
| Covered lines: | 49 |
| Uncovered lines: | 5 |
| Coverable lines: | 54 |
| Total lines: | 97 |
| **Branch coverage:** | 80% (24 of 30) |
| Covered branches: | 24 |
| Total branches: | 30 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **.ctor(...)** | 66.66% | 12 | 12 | 85.71% |
| **InvokeAsync()** | 100% | 14 | 14 | 100% |
| **VerifyRequestSignature(...)** | 50.0% | 4 | 4 | 76.92% |

## File(s)

### E:\github\FunWasHad\src\FWH.MarketingApi\Middleware\ApiKeyAuthenticationMiddleware.cs
```
 1           using System.Security.Cryptography;
 2           using System.Text;
 3           using Microsoft.Extensions.Primitives;
 4           
 5           namespace FWH.MarketingApi.Middleware;
 6           
 7           /// <summary>
 8           /// Middleware to authenticate requests using API key and request signing.
 9           /// Ensures only genuine builds of the app can call the API.
10           /// </summary>
11           public class ApiKeyAuthenticationMiddleware
12           {
13               private readonly RequestDelegate _next;
14               private readonly ILogger<ApiKeyAuthenticationMiddleware> _logger;
15               private readonly string _apiKey;
16               private readonly string _apiSecret;
17           
18  ✔  9         public ApiKeyAuthenticationMiddleware(
19  ✔  9             RequestDelegate next,
20  ✔  9             IConfiguration configuration,
21  ✔  9             ILogger<ApiKeyAuthenticationMiddleware> logger)
22  ✔  9         {
23  ✓  9  ◑          _next = next ?? throw new ArgumentNullException(nameof(next));
24  ✓  9  ◑          _logger = logger ?? throw new ArgumentNullException(nameof(logger));
25  ✔  9             ArgumentNullException.ThrowIfNull(configuration);
26           
27  ✔  9  ●          _apiKey = configuration["ApiSecurity:ApiKey"] ?? throw new InvalidOperationException("ApiSecurity:ApiKey is requ
28  ✔  8  ●          _apiSecret = configuration["ApiSecurity:ApiSecret"] ?? throw new InvalidOperationException("ApiSecurity:ApiSecre
29           
30  ✓  7  ◑          if (string.IsNullOrWhiteSpace(_apiKey) || string.IsNullOrWhiteSpace(_apiSecret))
31  ❌ 0             {
32  ❌ 0                 throw new InvalidOperationException("ApiSecurity:ApiKey and ApiSecurity:ApiSecret must be configured");
33                   }
34  ✔  7         }
35           
36               public async Task InvokeAsync(HttpContext context)
37  ✔  7         {
38                   // Skip authentication for health checks and Swagger
39  ✔  7  ●          if (context.Request.Path.StartsWithSegments("/health") ||
40  ✔  7                 context.Request.Path.StartsWithSegments("/swagger") ||
41  ✔  7                 context.Request.Path.StartsWithSegments("/metrics"))
42  ✔  2             {
43  ✔  2                 await _next(context);
44  ✔  2                 return;
45                   }
46           
47                   // Check for API key in header
48  ✔  5  ●          if (!context.Request.Headers.TryGetValue("X-API-Key", out var apiKeyHeader) ||
49  ✔  5                 apiKeyHeader != _apiKey)
50  ✔  2             {
51  ✔  2                 _logger.LogWarning("Unauthorized API request: Missing or invalid API key from {RemoteIpAddress}",
52  ✔  2                     context.Connection.RemoteIpAddress);
53  ✔  2                 context.Response.StatusCode = StatusCodes.Status401Unauthorized;
54  ✔  2                 await context.Response.WriteAsync("Unauthorized: Invalid API key");
55  ✔  2                 return;
56                   }
57           
58                   // Verify request signature if present (optional for now, can be enhanced)
59  ✔  3  ●          if (context.Request.Headers.TryGetValue("X-Request-Signature", out var signatureHeader))
60  ✔  2             {
61  ✔  2  ●              if (!VerifyRequestSignature(context, signatureHeader.ToString(), _apiSecret))
62  ✔  1                 {
63  ✔  1                     _logger.LogWarning("Unauthorized API request: Invalid request signature from {RemoteIpAddress}",
64  ✔  1                         context.Connection.RemoteIpAddress);
65  ✔  1                     context.Response.StatusCode = StatusCodes.Status401Unauthorized;
66  ✔  1                     await context.Response.WriteAsync("Unauthorized: Invalid request signature");
67  ✔  1                     return;
68                       }
69  ✔  1             }
70           
71  ✔  2             await _next(context);
72  ✔  7         }
73           
74               private static bool VerifyRequestSignature(HttpContext context, string providedSignature, string secret)
75  ✔  2         {
76                   try
77  ✔  2             {
78                       // Build the string to sign: method + path + query + body hash
79  ✔  2                 var method = context.Request.Method;
80  ✓  2  ◑              var path = context.Request.Path.Value ?? string.Empty;
81  ✓  2  ◑              var query = context.Request.QueryString.Value ?? string.Empty;
82           
83                       // For POST/PUT requests, we'd need to read the body, but that's complex in middleware
84                       // For now, we'll use a simpler approach: method + path + query
85  ✔  2                 var stringToSign = $"{method}{path}{query}";
86           
87  ✔  2                 using var hmac = new HMACSHA256(Encoding.UTF8.GetBytes(secret));
88  ✔  2                 var computedSignature = Convert.ToBase64String(hmac.ComputeHash(Encoding.UTF8.GetBytes(stringToSign)));
89           
90  ✔  2                 return string.Equals(computedSignature, providedSignature, StringComparison.Ordinal);
91                   }
92  ❌ 0             catch
93  ❌ 0             {
94  ❌ 0                 return false;
95                   }
96  ✔  2         }
97           }
```
# FWH.MarketingApi.Models.Airport

## Summary

|||
|:---|:---|
| Class: | FWH.MarketingApi.Models.Airport |
| Assembly: | FWH.MarketingApi |
| **File(s):** | E:\github\FunWasHad\src\FWH.MarketingApi\Models\Airport.cs |
| **Line coverage:** | 85.7% (12 of 14) |
| Covered lines: | 12 |
| Uncovered lines: | 2 |
| Coverable lines: | 14 |
| Total lines: | 24 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **get_Id()** | 100% | 1 | 1 | 100% |
| **get_Name()** | 100% | 1 | 1 | 100% |
| **get_IataCode()** | 100% | 1 | 1 | 100% |
| **get_IcaoCode()** | 100% | 1 | 1 | 100% |
| **get_City()** | 100% | 1 | 1 | 100% |
| **get_State()** | 100% | 1 | 1 | 100% |
| **get_Country()** | 100% | 1 | 1 | 100% |
| **get_Latitude()** | 100% | 1 | 1 | 100% |
| **get_Longitude()** | 100% | 1 | 1 | 100% |
| **get_Description()** | 100% | 2 | 1 | 0% |
| **get_IsActive()** | 100% | 1 | 1 | 100% |
| **get_CreatedAt()** | 100% | 1 | 1 | 100% |
| **get_UpdatedAt()** | 100% | 2 | 1 | 0% |
| **get_AirportTourismMarkets()** | 100% | 1 | 1 | 100% |

## File(s)

### E:\github\FunWasHad\src\FWH.MarketingApi\Models\Airport.cs
```
 1            namespace FWH.MarketingApi.Models;
 2            
 3            /// <summary>
 4            /// Represents an airport that can be associated with tourism markets.
 5            /// </summary>
 6            public class Airport
 7            {
 8  ✔  20         public long Id { get; set; }
 9  ✔  21         public required string Name { get; set; }
10  ✔  25         public required string IataCode { get; set; }
11  ✔  21         public string? IcaoCode { get; set; }
12  ✔  21         public required string City { get; set; }
13  ✔  21         public required string State { get; set; }
14  ✔  21         public required string Country { get; set; }
15  ✔  21         public double Latitude { get; set; }
16  ✔  21         public double Longitude { get; set; }
17  ❌  0         public string? Description { get; set; }
18  ✔  21         public bool IsActive { get; set; }
19  ✔  21         public DateTimeOffset CreatedAt { get; set; }
20  ❌  0         public DateTimeOffset? UpdatedAt { get; set; }
21            
22                // Navigation properties
23  ✔  48         public ICollection<AirportTourismMarket> AirportTourismMarkets { get; set; } = new List<AirportTourismMarket>();
24            }
```
# FWH.MarketingApi.Models.AirportTourismMarket

## Summary

|||
|:---|:---|
| Class: | FWH.MarketingApi.Models.AirportTourismMarket |
| Assembly: | FWH.MarketingApi |
| **File(s):** | E:\github\FunWasHad\src\FWH.MarketingApi\Models\AirportTourismMarket.cs |
| **Line coverage:** | 100% (6 of 6) |
| Covered lines: | 6 |
| Uncovered lines: | 0 |
| Coverable lines: | 6 |
| Total lines: | 14 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **get_Id()** | 100% | 1 | 1 | 100% |
| **get_AirportId()** | 100% | 1 | 1 | 100% |
| **get_Airport()** | 100% | 1 | 1 | 100% |
| **get_TourismMarketId()** | 100% | 1 | 1 | 100% |
| **get_TourismMarket()** | 100% | 1 | 1 | 100% |
| **get_CreatedAt()** | 100% | 1 | 1 | 100% |

## File(s)

### E:\github\FunWasHad\src\FWH.MarketingApi\Models\AirportTourismMarket.cs
```
 1            namespace FWH.MarketingApi.Models;
 2            
 3            /// <summary>
 4            /// Join entity for the many-to-many relationship between Airport and TourismMarket.
 5            /// </summary>
 6            public class AirportTourismMarket
 7            {
 8  ✔  30         public long Id { get; set; }
 9  ✔  31         public long AirportId { get; set; }
10  ✔  95         public Airport Airport { get; set; } = null!;
11  ✔  31         public long TourismMarketId { get; set; }
12  ✔  95         public TourismMarket TourismMarket { get; set; } = null!;
13  ✔  31         public DateTimeOffset CreatedAt { get; set; }
14            }
```
# FWH.MarketingApi.Models.Business

## Summary

|||
|:---|:---|
| Class: | FWH.MarketingApi.Models.Business |
| Assembly: | FWH.MarketingApi |
| **File(s):** | E:\github\FunWasHad\src\FWH.MarketingApi\Models\Business.cs |
| **Line coverage:** | 100% (17 of 17) |
| Covered lines: | 17 |
| Uncovered lines: | 0 |
| Coverable lines: | 17 |
| Total lines: | 27 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **get_Id()** | 100% | 1 | 1 | 100% |
| **get_Name()** | 100% | 1 | 1 | 100% |
| **get_Address()** | 100% | 1 | 1 | 100% |
| **get_Latitude()** | 100% | 1 | 1 | 100% |
| **get_Longitude()** | 100% | 1 | 1 | 100% |
| **get_PhoneNumber()** | 100% | 1 | 1 | 100% |
| **get_Email()** | 100% | 1 | 1 | 100% |
| **get_Website()** | 100% | 1 | 1 | 100% |
| **get_Description()** | 100% | 1 | 1 | 100% |
| **get_IsSubscribed()** | 100% | 1 | 1 | 100% |
| **get_CreatedAt()** | 100% | 1 | 1 | 100% |
| **get_SubscriptionExpiresAt()** | 100% | 1 | 1 | 100% |
| **get_Theme()** | 100% | 1 | 1 | 100% |
| **get_Coupons()** | 100% | 1 | 1 | 100% |
| **get_MenuItems()** | 100% | 1 | 1 | 100% |
| **get_NewsItems()** | 100% | 1 | 1 | 100% |
| **get_Feedback()** | 100% | 1 | 1 | 100% |

## File(s)

### E:\github\FunWasHad\src\FWH.MarketingApi\Models\Business.cs
```
 1            namespace FWH.MarketingApi.Models;
 2            
 3            /// <summary>
 4            /// Represents a business that can advertise through the mobile app.
 5            /// </summary>
 6            public class Business
 7            {
 8  ✔  21         public long Id { get; set; }
 9  ✔  21         public required string Name { get; set; }
10  ✔  21         public required string Address { get; set; }
11  ✔  21         public double Latitude { get; set; }
12  ✔  21         public double Longitude { get; set; }
13  ✔  12         public string? PhoneNumber { get; set; }
14  ✔  12         public string? Email { get; set; }
15  ✔  12         public string? Website { get; set; }
16  ✔  12         public string? Description { get; set; }
17  ✔  26         public bool IsSubscribed { get; set; }
18  ✔  21         public DateTimeOffset CreatedAt { get; set; }
19  ✔  12         public DateTimeOffset? SubscriptionExpiresAt { get; set; }
20            
21                // Navigation properties
22  ✔  12         public BusinessTheme? Theme { get; set; }
23  ✔  40         public ICollection<Coupon> Coupons { get; set; } = new List<Coupon>();
24  ✔  40         public ICollection<MenuItem> MenuItems { get; set; } = new List<MenuItem>();
25  ✔  40         public ICollection<NewsItem> NewsItems { get; set; } = new List<NewsItem>();
26  ✔  40         public ICollection<Feedback> Feedback { get; set; } = new List<Feedback>();
27            }
```
# FWH.MarketingApi.Models.BusinessMarketingResponse

## Summary

|||
|:---|:---|
| Class: | FWH.MarketingApi.Models.BusinessMarketingResponse |
| Assembly: | FWH.MarketingApi |
| **File(s):** | E:\github\FunWasHad\src\FWH.MarketingApi\Models\BusinessMarketingResponse.cs |
| **Line coverage:** | 0% (0 of 6) |
| Covered lines: | 0 |
| Uncovered lines: | 6 |
| Coverable lines: | 6 |
| Total lines: | 14 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **get_BusinessId()** | 100% | 2 | 1 | 0% |
| **get_BusinessName()** | 100% | 2 | 1 | 0% |
| **get_Theme()** | 100% | 2 | 1 | 0% |
| **get_Coupons()** | 100% | 2 | 1 | 0% |
| **get_MenuItems()** | 100% | 2 | 1 | 0% |
| **get_NewsItems()** | 100% | 2 | 1 | 0% |

## File(s)

### E:\github\FunWasHad\src\FWH.MarketingApi\Models\BusinessMarketingResponse.cs
```
 1           namespace FWH.MarketingApi.Models;
 2           
 3           /// <summary>
 4           /// Response model for business marketing data.
 5           /// </summary>
 6           public class BusinessMarketingResponse
 7           {
 8  ❌ 0         public long BusinessId { get; set; }
 9  ❌ 0         public required string BusinessName { get; set; }
10  ❌ 0         public BusinessTheme? Theme { get; set; }
11  ❌ 0         public List<Coupon> Coupons { get; set; } = new();
12  ❌ 0         public List<MenuItem> MenuItems { get; set; } = new();
13  ❌ 0         public List<NewsItem> NewsItems { get; set; } = new();
14           }
```
# FWH.MarketingApi.Models.BusinessTheme

## Summary

|||
|:---|:---|
| Class: | FWH.MarketingApi.Models.BusinessTheme |
| Assembly: | FWH.MarketingApi |
| **File(s):** | E:\github\FunWasHad\src\FWH.MarketingApi\Models\BusinessTheme.cs |
| **Line coverage:** | 0% (0 of 15) |
| Covered lines: | 0 |
| Uncovered lines: | 15 |
| Coverable lines: | 15 |
| Total lines: | 25 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **get_Id()** | 100% | 2 | 1 | 0% |
| **get_BusinessId()** | 100% | 2 | 1 | 0% |
| **get_Business()** | 100% | 2 | 1 | 0% |
| **get_ThemeName()** | 100% | 2 | 1 | 0% |
| **get_PrimaryColor()** | 100% | 2 | 1 | 0% |
| **get_SecondaryColor()** | 100% | 2 | 1 | 0% |
| **get_AccentColor()** | 100% | 2 | 1 | 0% |
| **get_BackgroundColor()** | 100% | 2 | 1 | 0% |
| **get_TextColor()** | 100% | 2 | 1 | 0% |
| **get_LogoUrl()** | 100% | 2 | 1 | 0% |
| **get_BackgroundImageUrl()** | 100% | 2 | 1 | 0% |
| **get_CustomCss()** | 100% | 2 | 1 | 0% |
| **get_IsActive()** | 100% | 2 | 1 | 0% |
| **get_CreatedAt()** | 100% | 2 | 1 | 0% |
| **get_UpdatedAt()** | 100% | 2 | 1 | 0% |

## File(s)

### E:\github\FunWasHad\src\FWH.MarketingApi\Models\BusinessTheme.cs
```
 1           namespace FWH.MarketingApi.Models;
 2           
 3           /// <summary>
 4           /// Theme settings for customizing the app appearance when at a business location.
 5           /// </summary>
 6           public class BusinessTheme
 7           {
 8  ❌ 0         public long Id { get; set; }
 9  ❌ 0         public long BusinessId { get; set; }
10  ❌ 0         public Business Business { get; set; } = null!;
11           
12  ❌ 0         public required string ThemeName { get; set; }
13  ❌ 0         public string? PrimaryColor { get; set; }
14  ❌ 0         public string? SecondaryColor { get; set; }
15  ❌ 0         public string? AccentColor { get; set; }
16  ❌ 0         public string? BackgroundColor { get; set; }
17  ❌ 0         public string? TextColor { get; set; }
18  ❌ 0         public string? LogoUrl { get; set; }
19  ❌ 0         public string? BackgroundImageUrl { get; set; }
20  ❌ 0         public string? CustomCss { get; set; }
21           
22  ❌ 0         public bool IsActive { get; set; }
23  ❌ 0         public DateTimeOffset CreatedAt { get; set; }
24  ❌ 0         public DateTimeOffset? UpdatedAt { get; set; }
25           }
```
# FWH.MarketingApi.Models.City

## Summary

|||
|:---|:---|
| Class: | FWH.MarketingApi.Models.City |
| Assembly: | FWH.MarketingApi |
| **File(s):** | E:\github\FunWasHad\src\FWH.MarketingApi\Models\City.cs |
| **Line coverage:** | 69.2% (9 of 13) |
| Covered lines: | 9 |
| Uncovered lines: | 4 |
| Coverable lines: | 13 |
| Total lines: | 23 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **get_Id()** | 100% | 1 | 1 | 100% |
| **get_Name()** | 100% | 1 | 1 | 100% |
| **get_State()** | 100% | 1 | 1 | 100% |
| **get_Country()** | 100% | 1 | 1 | 100% |
| **get_Latitude()** | 100% | 1 | 1 | 100% |
| **get_Longitude()** | 100% | 1 | 1 | 100% |
| **get_Description()** | 100% | 2 | 1 | 0% |
| **get_Website()** | 100% | 2 | 1 | 0% |
| **get_IsActive()** | 100% | 1 | 1 | 100% |
| **get_CreatedAt()** | 100% | 1 | 1 | 100% |
| **get_UpdatedAt()** | 100% | 2 | 1 | 0% |
| **get_Theme()** | 100% | 2 | 1 | 0% |
| **get_CityTourismMarkets()** | 100% | 1 | 1 | 100% |

## File(s)

### E:\github\FunWasHad\src\FWH.MarketingApi\Models\City.cs
```
 1            namespace FWH.MarketingApi.Models;
 2            
 3            /// <summary>
 4            /// Represents a city that can have marketing information (theme, logo, general info).
 5            /// </summary>
 6            public class City
 7            {
 8  ✔  20         public long Id { get; set; }
 9  ✔  25         public required string Name { get; set; }
10  ✔  21         public required string State { get; set; }
11  ✔  21         public required string Country { get; set; }
12  ✔  21         public double? Latitude { get; set; }
13  ✔  21         public double? Longitude { get; set; }
14  ❌  0         public string? Description { get; set; }
15  ❌  0         public string? Website { get; set; }
16  ✔  21         public bool IsActive { get; set; }
17  ✔  21         public DateTimeOffset CreatedAt { get; set; }
18  ❌  0         public DateTimeOffset? UpdatedAt { get; set; }
19            
20                // Navigation properties
21  ❌  0         public CityTheme? Theme { get; set; }
22  ✔  49         public ICollection<CityTourismMarket> CityTourismMarkets { get; set; } = new List<CityTourismMarket>();
23            }
```
# FWH.MarketingApi.Models.CityMarketingResponse

## Summary

|||
|:---|:---|
| Class: | FWH.MarketingApi.Models.CityMarketingResponse |
| Assembly: | FWH.MarketingApi |
| **File(s):** | E:\github\FunWasHad\src\FWH.MarketingApi\Models\CityMarketingResponse.cs |
| **Line coverage:** | 0% (0 of 7) |
| Covered lines: | 0 |
| Uncovered lines: | 7 |
| Coverable lines: | 7 |
| Total lines: | 17 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **get_CityId()** | 100% | 2 | 1 | 0% |
| **get_CityName()** | 100% | 2 | 1 | 0% |
| **get_State()** | 100% | 2 | 1 | 0% |
| **get_Country()** | 100% | 2 | 1 | 0% |
| **get_Description()** | 100% | 2 | 1 | 0% |
| **get_Website()** | 100% | 2 | 1 | 0% |
| **get_Theme()** | 100% | 2 | 1 | 0% |

## File(s)

### E:\github\FunWasHad\src\FWH.MarketingApi\Models\CityMarketingResponse.cs
```
 1           using FWH.MarketingApi.Models;
 2           
 3           namespace FWH.MarketingApi.Models;
 4           
 5           /// <summary>
 6           /// Response model for city marketing data.
 7           /// </summary>
 8           public class CityMarketingResponse
 9           {
10  ❌ 0         public long CityId { get; set; }
11  ❌ 0         public required string CityName { get; set; }
12  ❌ 0         public required string State { get; set; }
13  ❌ 0         public required string Country { get; set; }
14  ❌ 0         public string? Description { get; set; }
15  ❌ 0         public string? Website { get; set; }
16  ❌ 0         public CityThemeDto? Theme { get; set; }
17           }
```
# FWH.MarketingApi.Models.CityTheme

## Summary

|||
|:---|:---|
| Class: | FWH.MarketingApi.Models.CityTheme |
| Assembly: | FWH.MarketingApi |
| **File(s):** | E:\github\FunWasHad\src\FWH.MarketingApi\Models\CityTheme.cs |
| **Line coverage:** | 0% (0 of 15) |
| Covered lines: | 0 |
| Uncovered lines: | 15 |
| Coverable lines: | 15 |
| Total lines: | 25 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **get_Id()** | 100% | 2 | 1 | 0% |
| **get_CityId()** | 100% | 2 | 1 | 0% |
| **get_City()** | 100% | 2 | 1 | 0% |
| **get_ThemeName()** | 100% | 2 | 1 | 0% |
| **get_PrimaryColor()** | 100% | 2 | 1 | 0% |
| **get_SecondaryColor()** | 100% | 2 | 1 | 0% |
| **get_AccentColor()** | 100% | 2 | 1 | 0% |
| **get_BackgroundColor()** | 100% | 2 | 1 | 0% |
| **get_TextColor()** | 100% | 2 | 1 | 0% |
| **get_LogoUrl()** | 100% | 2 | 1 | 0% |
| **get_BackgroundImageUrl()** | 100% | 2 | 1 | 0% |
| **get_CustomCss()** | 100% | 2 | 1 | 0% |
| **get_IsActive()** | 100% | 2 | 1 | 0% |
| **get_CreatedAt()** | 100% | 2 | 1 | 0% |
| **get_UpdatedAt()** | 100% | 2 | 1 | 0% |

## File(s)

### E:\github\FunWasHad\src\FWH.MarketingApi\Models\CityTheme.cs
```
 1           namespace FWH.MarketingApi.Models;
 2           
 3           /// <summary>
 4           /// Theme settings for customizing the app appearance when in a city.
 5           /// </summary>
 6           public class CityTheme
 7           {
 8  ❌ 0         public long Id { get; set; }
 9  ❌ 0         public long CityId { get; set; }
10  ❌ 0         public City City { get; set; } = null!;
11           
12  ❌ 0         public required string ThemeName { get; set; }
13  ❌ 0         public string? PrimaryColor { get; set; }
14  ❌ 0         public string? SecondaryColor { get; set; }
15  ❌ 0         public string? AccentColor { get; set; }
16  ❌ 0         public string? BackgroundColor { get; set; }
17  ❌ 0         public string? TextColor { get; set; }
18  ❌ 0         public string? LogoUrl { get; set; }
19  ❌ 0         public string? BackgroundImageUrl { get; set; }
20  ❌ 0         public string? CustomCss { get; set; }
21           
22  ❌ 0         public bool IsActive { get; set; }
23  ❌ 0         public DateTimeOffset CreatedAt { get; set; }
24  ❌ 0         public DateTimeOffset? UpdatedAt { get; set; }
25           }
```
# FWH.MarketingApi.Models.CityThemeDto

## Summary

|||
|:---|:---|
| Class: | FWH.MarketingApi.Models.CityThemeDto |
| Assembly: | FWH.MarketingApi |
| **File(s):** | E:\github\FunWasHad\src\FWH.MarketingApi\Models\CityThemeDto.cs |
| **Line coverage:** | 0% (0 of 14) |
| Covered lines: | 0 |
| Uncovered lines: | 14 |
| Coverable lines: | 14 |
| Total lines: | 22 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **get_Id()** | 100% | 2 | 1 | 0% |
| **get_CityId()** | 100% | 2 | 1 | 0% |
| **get_ThemeName()** | 100% | 2 | 1 | 0% |
| **get_PrimaryColor()** | 100% | 2 | 1 | 0% |
| **get_SecondaryColor()** | 100% | 2 | 1 | 0% |
| **get_AccentColor()** | 100% | 2 | 1 | 0% |
| **get_BackgroundColor()** | 100% | 2 | 1 | 0% |
| **get_TextColor()** | 100% | 2 | 1 | 0% |
| **get_LogoUrl()** | 100% | 2 | 1 | 0% |
| **get_BackgroundImageUrl()** | 100% | 2 | 1 | 0% |
| **get_CustomCss()** | 100% | 2 | 1 | 0% |
| **get_IsActive()** | 100% | 2 | 1 | 0% |
| **get_CreatedAt()** | 100% | 2 | 1 | 0% |
| **get_UpdatedAt()** | 100% | 2 | 1 | 0% |

## File(s)

### E:\github\FunWasHad\src\FWH.MarketingApi\Models\CityThemeDto.cs
```
 1           namespace FWH.MarketingApi.Models;
 2           
 3           /// <summary>
 4           /// DTO for city theme data (without navigation properties to avoid circular references).
 5           /// </summary>
 6           public class CityThemeDto
 7           {
 8  ❌ 0         public long Id { get; set; }
 9  ❌ 0         public long CityId { get; set; }
10  ❌ 0         public required string ThemeName { get; set; }
11  ❌ 0         public string? PrimaryColor { get; set; }
12  ❌ 0         public string? SecondaryColor { get; set; }
13  ❌ 0         public string? AccentColor { get; set; }
14  ❌ 0         public string? BackgroundColor { get; set; }
15  ❌ 0         public string? TextColor { get; set; }
16  ❌ 0         public string? LogoUrl { get; set; }
17  ❌ 0         public string? BackgroundImageUrl { get; set; }
18  ❌ 0         public string? CustomCss { get; set; }
19  ❌ 0         public bool IsActive { get; set; }
20  ❌ 0         public DateTimeOffset CreatedAt { get; set; }
21  ❌ 0         public DateTimeOffset? UpdatedAt { get; set; }
22           }
```
# FWH.MarketingApi.Models.CityTourismMarket

## Summary

|||
|:---|:---|
| Class: | FWH.MarketingApi.Models.CityTourismMarket |
| Assembly: | FWH.MarketingApi |
| **File(s):** | E:\github\FunWasHad\src\FWH.MarketingApi\Models\CityTourismMarket.cs |
| **Line coverage:** | 100% (6 of 6) |
| Covered lines: | 6 |
| Uncovered lines: | 0 |
| Coverable lines: | 6 |
| Total lines: | 14 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **get_Id()** | 100% | 1 | 1 | 100% |
| **get_CityId()** | 100% | 1 | 1 | 100% |
| **get_City()** | 100% | 1 | 1 | 100% |
| **get_TourismMarketId()** | 100% | 1 | 1 | 100% |
| **get_TourismMarket()** | 100% | 1 | 1 | 100% |
| **get_CreatedAt()** | 100% | 1 | 1 | 100% |

## File(s)

### E:\github\FunWasHad\src\FWH.MarketingApi\Models\CityTourismMarket.cs
```
 1            namespace FWH.MarketingApi.Models;
 2            
 3            /// <summary>
 4            /// Join entity for the many-to-many relationship between City and TourismMarket.
 5            /// </summary>
 6            public class CityTourismMarket
 7            {
 8  ✔  30         public long Id { get; set; }
 9  ✔  31         public long CityId { get; set; }
10  ✔  96         public City City { get; set; } = null!;
11  ✔  31         public long TourismMarketId { get; set; }
12  ✔  96         public TourismMarket TourismMarket { get; set; } = null!;
13  ✔  31         public DateTimeOffset CreatedAt { get; set; }
14            }
```
# FWH.MarketingApi.Models.Coupon

## Summary

|||
|:---|:---|
| Class: | FWH.MarketingApi.Models.Coupon |
| Assembly: | FWH.MarketingApi |
| **File(s):** | E:\github\FunWasHad\src\FWH.MarketingApi\Models\Coupon.cs |
| **Line coverage:** | 0% (0 of 16) |
| Covered lines: | 0 |
| Uncovered lines: | 16 |
| Coverable lines: | 16 |
| Total lines: | 27 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **get_Id()** | 100% | 2 | 1 | 0% |
| **get_BusinessId()** | 100% | 2 | 1 | 0% |
| **get_Business()** | 100% | 2 | 1 | 0% |
| **get_Title()** | 100% | 2 | 1 | 0% |
| **get_Description()** | 100% | 2 | 1 | 0% |
| **get_Code()** | 100% | 2 | 1 | 0% |
| **get_DiscountAmount()** | 100% | 2 | 1 | 0% |
| **get_DiscountPercentage()** | 100% | 2 | 1 | 0% |
| **get_ImageUrl()** | 100% | 2 | 1 | 0% |
| **get_TermsAndConditions()** | 100% | 2 | 1 | 0% |
| **get_ValidFrom()** | 100% | 2 | 1 | 0% |
| **get_ValidUntil()** | 100% | 2 | 1 | 0% |
| **get_MaxRedemptions()** | 100% | 2 | 1 | 0% |
| **get_CurrentRedemptions()** | 100% | 2 | 1 | 0% |
| **get_IsActive()** | 100% | 2 | 1 | 0% |
| **get_CreatedAt()** | 100% | 2 | 1 | 0% |

## File(s)

### E:\github\FunWasHad\src\FWH.MarketingApi\Models\Coupon.cs
```
 1           namespace FWH.MarketingApi.Models;
 2           
 3           /// <summary>
 4           /// Coupon or promotional offer from a business.
 5           /// </summary>
 6           public class Coupon
 7           {
 8  ❌ 0         public long Id { get; set; }
 9  ❌ 0         public long BusinessId { get; set; }
10  ❌ 0         public Business Business { get; set; } = null!;
11           
12  ❌ 0         public required string Title { get; set; }
13  ❌ 0         public required string Description { get; set; }
14  ❌ 0         public string? Code { get; set; }
15  ❌ 0         public decimal? DiscountAmount { get; set; }
16  ❌ 0         public decimal? DiscountPercentage { get; set; }
17  ❌ 0         public string? ImageUrl { get; set; }
18  ❌ 0         public string? TermsAndConditions { get; set; }
19           
20  ❌ 0         public DateTimeOffset ValidFrom { get; set; }
21  ❌ 0         public DateTimeOffset ValidUntil { get; set; }
22  ❌ 0         public int? MaxRedemptions { get; set; }
23  ❌ 0         public int CurrentRedemptions { get; set; }
24           
25  ❌ 0         public bool IsActive { get; set; }
26  ❌ 0         public DateTimeOffset CreatedAt { get; set; }
27           }
```
# FWH.MarketingApi.Models.Feedback

## Summary

|||
|:---|:---|
| Class: | FWH.MarketingApi.Models.Feedback |
| Assembly: | FWH.MarketingApi |
| **File(s):** | E:\github\FunWasHad\src\FWH.MarketingApi\Models\Feedback.cs |
| **Line coverage:** | 100% (21 of 21) |
| Covered lines: | 21 |
| Uncovered lines: | 0 |
| Coverable lines: | 21 |
| Total lines: | 39 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **get_Id()** | 100% | 1 | 1 | 100% |
| **get_BusinessId()** | 100% | 1 | 1 | 100% |
| **get_Business()** | 100% | 1 | 1 | 100% |
| **get_UserId()** | 100% | 1 | 1 | 100% |
| **get_UserName()** | 100% | 1 | 1 | 100% |
| **get_UserEmail()** | 100% | 1 | 1 | 100% |
| **get_FeedbackType()** | 100% | 1 | 1 | 100% |
| **get_Subject()** | 100% | 1 | 1 | 100% |
| **get_Message()** | 100% | 1 | 1 | 100% |
| **get_Rating()** | 100% | 1 | 1 | 100% |
| **get_SubmittedAt()** | 100% | 1 | 1 | 100% |
| **get_ReviewedAt()** | 100% | 1 | 1 | 100% |
| **get_ReviewedBy()** | 100% | 1 | 1 | 100% |
| **get_BusinessResponse()** | 100% | 1 | 1 | 100% |
| **get_RespondedAt()** | 100% | 1 | 1 | 100% |
| **get_IsPublic()** | 100% | 1 | 1 | 100% |
| **get_IsApproved()** | 100% | 1 | 1 | 100% |
| **get_ModerationNotes()** | 100% | 1 | 1 | 100% |
| **get_Latitude()** | 100% | 1 | 1 | 100% |
| **get_Longitude()** | 100% | 1 | 1 | 100% |
| **get_Attachments()** | 100% | 1 | 1 | 100% |

## File(s)

### E:\github\FunWasHad\src\FWH.MarketingApi\Models\Feedback.cs
```
 1            using System.ComponentModel.DataAnnotations;
 2            
 3            namespace FWH.MarketingApi.Models;
 4            
 5            /// <summary>
 6            /// User feedback submitted to a business.
 7            /// </summary>
 8            public class Feedback
 9            {
10  ✔  34         public long Id { get; set; }
11  ✔  23         public long BusinessId { get; set; }
12  ✔  39         public Business Business { get; set; } = null!;
13            
14  ✔  23         public required string UserId { get; set; } // Device ID or user account ID
15  ✔  23         public string? UserName { get; set; }
16  ✔  23         public string? UserEmail { get; set; }
17            
18  ✔  24         public required string FeedbackType { get; set; } // "review", "complaint", "suggestion", "compliment"
19  ✔  23         public required string Subject { get; set; }
20  ✔  23         public required string Message { get; set; }
21  ✔  24         public int? Rating { get; set; } // 1-5 stars
22            
23  ✔  23         public DateTimeOffset SubmittedAt { get; set; }
24  ✔  18         public DateTimeOffset? ReviewedAt { get; set; }
25  ✔  18         public string? ReviewedBy { get; set; }
26  ✔  18         public string? BusinessResponse { get; set; }
27  ✔  18         public DateTimeOffset? RespondedAt { get; set; }
28            
29  ✔  23         public bool IsPublic { get; set; }
30  ✔  23         public bool IsApproved { get; set; }
31  ✔  18         public string? ModerationNotes { get; set; }
32            
33                // Location context
34  ✔  23         public double? Latitude { get; set; }
35  ✔  23         public double? Longitude { get; set; }
36            
37                // Navigation properties
38  ✔  39         public ICollection<FeedbackAttachment> Attachments { get; set; } = new List<FeedbackAttachment>();
39            }
```
# FWH.MarketingApi.Models.FeedbackAttachment

## Summary

|||
|:---|:---|
| Class: | FWH.MarketingApi.Models.FeedbackAttachment |
| Assembly: | FWH.MarketingApi |
| **File(s):** | E:\github\FunWasHad\src\FWH.MarketingApi\Models\FeedbackAttachment.cs |
| **Line coverage:** | 100% (11 of 11) |
| Covered lines: | 11 |
| Uncovered lines: | 0 |
| Coverable lines: | 11 |
| Total lines: | 21 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **get_Id()** | 100% | 1 | 1 | 100% |
| **get_FeedbackId()** | 100% | 1 | 1 | 100% |
| **get_Feedback()** | 100% | 1 | 1 | 100% |
| **get_AttachmentType()** | 100% | 1 | 1 | 100% |
| **get_FileName()** | 100% | 1 | 1 | 100% |
| **get_ContentType()** | 100% | 1 | 1 | 100% |
| **get_StorageUrl()** | 100% | 1 | 1 | 100% |
| **get_ThumbnailUrl()** | 100% | 1 | 1 | 100% |
| **get_FileSizeBytes()** | 100% | 1 | 1 | 100% |
| **get_DurationSeconds()** | 100% | 1 | 1 | 100% |
| **get_UploadedAt()** | 100% | 1 | 1 | 100% |

## File(s)

### E:\github\FunWasHad\src\FWH.MarketingApi\Models\FeedbackAttachment.cs
```
 1            namespace FWH.MarketingApi.Models;
 2            
 3            /// <summary>
 4            /// Media attachment for feedback (image or video).
 5            /// </summary>
 6            public class FeedbackAttachment
 7            {
 8  ✔  12         public long Id { get; set; }
 9  ✔   9         public long FeedbackId { get; set; }
10  ✔  14         public Feedback Feedback { get; set; } = null!;
11            
12  ✔  11         public required string AttachmentType { get; set; } // "image", "video"
13  ✔  10         public required string FileName { get; set; }
14  ✔  10         public required string ContentType { get; set; }
15  ✔  15         public required string StorageUrl { get; set; }
16  ✔   9         public string? ThumbnailUrl { get; set; }
17  ✔  10         public long? FileSizeBytes { get; set; }
18  ✔   7         public int? DurationSeconds { get; set; } // For videos
19            
20  ✔   9         public DateTimeOffset UploadedAt { get; set; }
21            }
```
# FWH.MarketingApi.Models.MenuItem

## Summary

|||
|:---|:---|
| Class: | FWH.MarketingApi.Models.MenuItem |
| Assembly: | FWH.MarketingApi |
| **File(s):** | E:\github\FunWasHad\src\FWH.MarketingApi\Models\MenuItem.cs |
| **Line coverage:** | 0% (0 of 16) |
| Covered lines: | 0 |
| Uncovered lines: | 16 |
| Coverable lines: | 16 |
| Total lines: | 28 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **get_Id()** | 100% | 2 | 1 | 0% |
| **get_BusinessId()** | 100% | 2 | 1 | 0% |
| **get_Business()** | 100% | 2 | 1 | 0% |
| **get_Name()** | 100% | 2 | 1 | 0% |
| **get_Description()** | 100% | 2 | 1 | 0% |
| **get_Category()** | 100% | 2 | 1 | 0% |
| **get_Price()** | 100% | 2 | 1 | 0% |
| **get_Currency()** | 100% | 2 | 1 | 0% |
| **get_ImageUrl()** | 100% | 2 | 1 | 0% |
| **get_IsAvailable()** | 100% | 2 | 1 | 0% |
| **get_SortOrder()** | 100% | 2 | 1 | 0% |
| **get_Calories()** | 100% | 2 | 1 | 0% |
| **get_Allergens()** | 100% | 2 | 1 | 0% |
| **get_DietaryTags()** | 100% | 2 | 1 | 0% |
| **get_CreatedAt()** | 100% | 2 | 1 | 0% |
| **get_UpdatedAt()** | 100% | 2 | 1 | 0% |

## File(s)

### E:\github\FunWasHad\src\FWH.MarketingApi\Models\MenuItem.cs
```
 1           namespace FWH.MarketingApi.Models;
 2           
 3           /// <summary>
 4           /// Menu item from a business (e.g., restaurant menu).
 5           /// </summary>
 6           public class MenuItem
 7           {
 8  ❌ 0         public long Id { get; set; }
 9  ❌ 0         public long BusinessId { get; set; }
10  ❌ 0         public Business Business { get; set; } = null!;
11           
12  ❌ 0         public required string Name { get; set; }
13  ❌ 0         public string? Description { get; set; }
14  ❌ 0         public required string Category { get; set; }
15  ❌ 0         public decimal? Price { get; set; }
16  ❌ 0         public string? Currency { get; set; }
17  ❌ 0         public string? ImageUrl { get; set; }
18  ❌ 0         public bool IsAvailable { get; set; }
19  ❌ 0         public int SortOrder { get; set; }
20           
21               // Nutritional information (optional)
22  ❌ 0         public int? Calories { get; set; }
23  ❌ 0         public string? Allergens { get; set; }
24  ❌ 0         public string? DietaryTags { get; set; } // e.g., "vegetarian,gluten-free"
25           
26  ❌ 0         public DateTimeOffset CreatedAt { get; set; }
27  ❌ 0         public DateTimeOffset? UpdatedAt { get; set; }
28           }
```
# FWH.MarketingApi.Models.NewsItem

## Summary

|||
|:---|:---|
| Class: | FWH.MarketingApi.Models.NewsItem |
| Assembly: | FWH.MarketingApi |
| **File(s):** | E:\github\FunWasHad\src\FWH.MarketingApi\Models\NewsItem.cs |
| **Line coverage:** | 0% (0 of 14) |
| Covered lines: | 0 |
| Uncovered lines: | 14 |
| Coverable lines: | 14 |
| Total lines: | 25 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **get_Id()** | 100% | 2 | 1 | 0% |
| **get_BusinessId()** | 100% | 2 | 1 | 0% |
| **get_Business()** | 100% | 2 | 1 | 0% |
| **get_Title()** | 100% | 2 | 1 | 0% |
| **get_Content()** | 100% | 2 | 1 | 0% |
| **get_Summary()** | 100% | 2 | 1 | 0% |
| **get_ImageUrl()** | 100% | 2 | 1 | 0% |
| **get_Author()** | 100% | 2 | 1 | 0% |
| **get_PublishedAt()** | 100% | 2 | 1 | 0% |
| **get_ExpiresAt()** | 100% | 2 | 1 | 0% |
| **get_IsPublished()** | 100% | 2 | 1 | 0% |
| **get_IsFeatured()** | 100% | 2 | 1 | 0% |
| **get_CreatedAt()** | 100% | 2 | 1 | 0% |
| **get_UpdatedAt()** | 100% | 2 | 1 | 0% |

## File(s)

### E:\github\FunWasHad\src\FWH.MarketingApi\Models\NewsItem.cs
```
 1           namespace FWH.MarketingApi.Models;
 2           
 3           /// <summary>
 4           /// News item or announcement from a business.
 5           /// </summary>
 6           public class NewsItem
 7           {
 8  ❌ 0         public long Id { get; set; }
 9  ❌ 0         public long BusinessId { get; set; }
10  ❌ 0         public Business Business { get; set; } = null!;
11           
12  ❌ 0         public required string Title { get; set; }
13  ❌ 0         public required string Content { get; set; }
14  ❌ 0         public string? Summary { get; set; }
15  ❌ 0         public string? ImageUrl { get; set; }
16  ❌ 0         public string? Author { get; set; }
17           
18  ❌ 0         public DateTimeOffset PublishedAt { get; set; }
19  ❌ 0         public DateTimeOffset? ExpiresAt { get; set; }
20  ❌ 0         public bool IsPublished { get; set; }
21  ❌ 0         public bool IsFeatured { get; set; }
22           
23  ❌ 0         public DateTimeOffset CreatedAt { get; set; }
24  ❌ 0         public DateTimeOffset? UpdatedAt { get; set; }
25           }
```
# FWH.MarketingApi.Models.PagedResult<T>

## Summary

|||
|:---|:---|
| Class: | FWH.MarketingApi.Models.PagedResult<T> |
| Assembly: | FWH.MarketingApi |
| **File(s):** | E:\github\FunWasHad\src\FWH.MarketingApi\Models\PaginationModels.cs |
| **Line coverage:** | 0% (0 of 7) |
| Covered lines: | 0 |
| Uncovered lines: | 7 |
| Coverable lines: | 7 |
| Total lines: | 79 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **get_Items()** | 100% | 2 | 1 | 0% |
| **get_Page()** | 100% | 2 | 1 | 0% |
| **get_PageSize()** | 100% | 2 | 1 | 0% |
| **get_TotalCount()** | 100% | 2 | 1 | 0% |
| **get_TotalPages()** | 100% | 2 | 1 | 0% |
| **get_HasPreviousPage()** | 100% | 2 | 1 | 0% |
| **get_HasNextPage()** | 100% | 2 | 1 | 0% |

## File(s)

### E:\github\FunWasHad\src\FWH.MarketingApi\Models\PaginationModels.cs
```
 1           namespace FWH.MarketingApi.Models;
 2           
 3           /// <summary>
 4           /// Pagination parameters for list endpoints.
 5           /// </summary>
 6           public class PaginationParameters
 7           {
 8               /// <summary>
 9               /// Page number (1-based). Defaults to 1.
10               /// </summary>
11               public int Page { get; set; } = 1;
12           
13               /// <summary>
14               /// Number of items per page. Defaults to 20, maximum 100.
15               /// </summary>
16               public int PageSize { get; set; } = 20;
17           
18               /// <summary>
19               /// Validates and normalizes pagination parameters.
20               /// </summary>
21               public void Validate()
22               {
23                   if (Page < 1) Page = 1;
24                   if (PageSize < 1) PageSize = 20;
25                   if (PageSize > 100) PageSize = 100;
26               }
27           
28               /// <summary>
29               /// Gets the number of items to skip for the current page.
30               /// </summary>
31               public int Skip => (Page - 1) * PageSize;
32           
33               /// <summary>
34               /// Gets the number of items to take for the current page.
35               /// </summary>
36               public int Take => PageSize;
37           }
38           
39           /// <summary>
40           /// Paginated result with metadata.
41           /// </summary>
42           /// <typeparam name="T">Type of items in the result</typeparam>
43           public class PagedResult<T>
44           {
45               /// <summary>
46               /// Items for the current page.
47               /// </summary>
48  ❌ 0         public required List<T> Items { get; init; }
49           
50               /// <summary>
51               /// Current page number (1-based).
52               /// </summary>
53  ❌ 0         public int Page { get; init; }
54           
55               /// <summary>
56               /// Number of items per page.
57               /// </summary>
58  ❌ 0         public int PageSize { get; init; }
59           
60               /// <summary>
61               /// Total number of items across all pages.
62               /// </summary>
63  ❌ 0         public int TotalCount { get; init; }
64           
65               /// <summary>
66               /// Total number of pages.
67               /// </summary>
68  ❌ 0         public int TotalPages => (int)Math.Ceiling(TotalCount / (double)PageSize);
69           
70               /// <summary>
71               /// Whether there is a previous page.
72               /// </summary>
73  ❌ 0         public bool HasPreviousPage => Page > 1;
74           
75               /// <summary>
76               /// Whether there is a next page.
77               /// </summary>
78  ❌ 0         public bool HasNextPage => Page < TotalPages;
79           }
```
# FWH.MarketingApi.Models.PaginationParameters

## Summary

|||
|:---|:---|
| Class: | FWH.MarketingApi.Models.PaginationParameters |
| Assembly: | FWH.MarketingApi |
| **File(s):** | E:\github\FunWasHad\src\FWH.MarketingApi\Models\PaginationModels.cs |
| **Line coverage:** | 0% (0 of 9) |
| Covered lines: | 0 |
| Uncovered lines: | 9 |
| Coverable lines: | 9 |
| Total lines: | 79 |
| **Branch coverage:** | 0% (0 of 6) |
| Covered branches: | 0 |
| Total branches: | 6 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **get_Page()** | 100% | 2 | 1 | 0% |
| **get_PageSize()** | 100% | 2 | 1 | 0% |
| **Validate()** | 0% | 42 | 6 | 0% |
| **get_Skip()** | 100% | 2 | 1 | 0% |
| **get_Take()** | 100% | 2 | 1 | 0% |

## File(s)

### E:\github\FunWasHad\src\FWH.MarketingApi\Models\PaginationModels.cs
```
 1           namespace FWH.MarketingApi.Models;
 2           
 3           /// <summary>
 4           /// Pagination parameters for list endpoints.
 5           /// </summary>
 6           public class PaginationParameters
 7           {
 8               /// <summary>
 9               /// Page number (1-based). Defaults to 1.
10               /// </summary>
11  ❌ 0         public int Page { get; set; } = 1;
12           
13               /// <summary>
14               /// Number of items per page. Defaults to 20, maximum 100.
15               /// </summary>
16  ❌ 0         public int PageSize { get; set; } = 20;
17           
18               /// <summary>
19               /// Validates and normalizes pagination parameters.
20               /// </summary>
21               public void Validate()
22  ❌ 0         {
23  ❌ 0  ○          if (Page < 1) Page = 1;
24  ❌ 0  ○          if (PageSize < 1) PageSize = 20;
25  ❌ 0  ○          if (PageSize > 100) PageSize = 100;
26  ❌ 0         }
27           
28               /// <summary>
29               /// Gets the number of items to skip for the current page.
30               /// </summary>
31  ❌ 0         public int Skip => (Page - 1) * PageSize;
32           
33               /// <summary>
34               /// Gets the number of items to take for the current page.
35               /// </summary>
36  ❌ 0         public int Take => PageSize;
37           }
38           
39           /// <summary>
40           /// Paginated result with metadata.
41           /// </summary>
42           /// <typeparam name="T">Type of items in the result</typeparam>
43           public class PagedResult<T>
44           {
45               /// <summary>
46               /// Items for the current page.
47               /// </summary>
48               public required List<T> Items { get; init; }
49           
50               /// <summary>
51               /// Current page number (1-based).
52               /// </summary>
53               public int Page { get; init; }
54           
55               /// <summary>
56               /// Number of items per page.
57               /// </summary>
58               public int PageSize { get; init; }
59           
60               /// <summary>
61               /// Total number of items across all pages.
62               /// </summary>
63               public int TotalCount { get; init; }
64           
65               /// <summary>
66               /// Total number of pages.
67               /// </summary>
68               public int TotalPages => (int)Math.Ceiling(TotalCount / (double)PageSize);
69           
70               /// <summary>
71               /// Whether there is a previous page.
72               /// </summary>
73               public bool HasPreviousPage => Page > 1;
74           
75               /// <summary>
76               /// Whether there is a next page.
77               /// </summary>
78               public bool HasNextPage => Page < TotalPages;
79           }
```
# FWH.MarketingApi.Models.SubmitFeedbackRequest

## Summary

|||
|:---|:---|
| Class: | FWH.MarketingApi.Models.SubmitFeedbackRequest |
| Assembly: | FWH.MarketingApi |
| **File(s):** | E:\github\FunWasHad\src\FWH.MarketingApi\Models\SubmitFeedbackRequest.cs |
| **Line coverage:** | 100% (11 of 11) |
| Covered lines: | 11 |
| Uncovered lines: | 0 |
| Coverable lines: | 11 |
| Total lines: | 89 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **get_BusinessId()** | 100% | 1 | 1 | 100% |
| **get_UserId()** | 100% | 1 | 1 | 100% |
| **get_UserName()** | 100% | 1 | 1 | 100% |
| **get_UserEmail()** | 100% | 1 | 1 | 100% |
| **get_FeedbackType()** | 100% | 1 | 1 | 100% |
| **get_Subject()** | 100% | 1 | 1 | 100% |
| **get_Message()** | 100% | 1 | 1 | 100% |
| **get_Rating()** | 100% | 1 | 1 | 100% |
| **get_IsPublic()** | 100% | 1 | 1 | 100% |
| **get_Latitude()** | 100% | 1 | 1 | 100% |
| **get_Longitude()** | 100% | 1 | 1 | 100% |

## File(s)

### E:\github\FunWasHad\src\FWH.MarketingApi\Models\SubmitFeedbackRequest.cs
```
 1            using System.ComponentModel.DataAnnotations;
 2            
 3            namespace FWH.MarketingApi.Models;
 4            
 5            /// <summary>
 6            /// Request model for submitting feedback.
 7            /// Implements TR-API-003: Feedback endpoints request validation.
 8            /// Implements TR-API-004: Validation requirements.
 9            /// </summary>
10            /// <remarks>
11            /// Used by the feedback submission endpoint (TR-API-003).
12            /// All fields are validated according to TR-API-004 and TR-SEC-001.
13            /// </remarks>
14            public class SubmitFeedbackRequest
15            {
16                /// <summary>
17                /// Business ID to submit feedback for.
18                /// </summary>
19                [Required]
20                [Range(1, long.MaxValue, ErrorMessage = "Business ID must be greater than 0.")]
21  ✔  49         public long BusinessId { get; set; }
22            
23                /// <summary>
24                /// User ID (device ID or user account ID).
25                /// </summary>
26                [Required]
27                [MaxLength(100, ErrorMessage = "User ID must not exceed 100 characters.")]
28  ✔  42         public required string UserId { get; set; }
29            
30                /// <summary>
31                /// Optional user name.
32                /// </summary>
33                [MaxLength(200, ErrorMessage = "User name must not exceed 200 characters.")]
34  ✔  33         public string? UserName { get; set; }
35            
36                /// <summary>
37                /// Optional user email address.
38                /// </summary>
39                [EmailAddress(ErrorMessage = "Invalid email address format.")]
40                [MaxLength(255, ErrorMessage = "Email must not exceed 255 characters.")]
41  ✔  29         public string? UserEmail { get; set; }
42            
43                /// <summary>
44                /// Feedback type: "review", "complaint", "suggestion", or "compliment".
45                /// </summary>
46                [Required]
47                [RegularExpression("^(review|complaint|suggestion|compliment)$", ErrorMessage = "Feedback type must be one of: revie
48  ✔  42         public required string FeedbackType { get; set; }
49            
50                /// <summary>
51                /// Feedback subject line.
52                /// </summary>
53                [Required]
54                [MinLength(1, ErrorMessage = "Subject is required.")]
55                [MaxLength(200, ErrorMessage = "Subject must not exceed 200 characters.")]
56  ✔  37         public required string Subject { get; set; }
57            
58                /// <summary>
59                /// Feedback message content.
60                /// </summary>
61                [Required]
62                [MinLength(1, ErrorMessage = "Message is required.")]
63                [MaxLength(5000, ErrorMessage = "Message must not exceed 5000 characters.")]
64  ✔  37         public required string Message { get; set; }
65            
66                /// <summary>
67                /// Optional rating (1-5 stars).
68                /// Must be between 1 and 5 if provided.
69                /// </summary>
70                [Range(1, 5, ErrorMessage = "Rating must be between 1 and 5.")]
71  ✔  47         public int? Rating { get; set; }
72            
73                /// <summary>
74                /// Whether the feedback should be publicly visible.
75                /// </summary>
76  ✔  34         public bool IsPublic { get; set; }
77            
78                /// <summary>
79                /// Optional latitude coordinate when feedback was submitted.
80                /// </summary>
81                [Range(-90, 90, ErrorMessage = "Latitude must be between -90 and 90 degrees.")]
82  ✔  29         public double? Latitude { get; set; }
83            
84                /// <summary>
85                /// Optional longitude coordinate when feedback was submitted.
86                /// </summary>
87                [Range(-180, 180, ErrorMessage = "Longitude must be between -180 and 180 degrees.")]
88  ✔  29         public double? Longitude { get; set; }
89            }
```
# FWH.MarketingApi.Models.TourismMarket

## Summary

|||
|:---|:---|
| Class: | FWH.MarketingApi.Models.TourismMarket |
| Assembly: | FWH.MarketingApi |
| **File(s):** | E:\github\FunWasHad\src\FWH.MarketingApi\Models\TourismMarket.cs |
| **Line coverage:** | 87.5% (7 of 8) |
| Covered lines: | 7 |
| Uncovered lines: | 1 |
| Coverable lines: | 8 |
| Total lines: | 18 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **get_Id()** | 100% | 1 | 1 | 100% |
| **get_Name()** | 100% | 1 | 1 | 100% |
| **get_Description()** | 100% | 1 | 1 | 100% |
| **get_IsActive()** | 100% | 1 | 1 | 100% |
| **get_CreatedAt()** | 100% | 1 | 1 | 100% |
| **get_UpdatedAt()** | 100% | 2 | 1 | 0% |
| **get_CityTourismMarkets()** | 100% | 1 | 1 | 100% |
| **get_AirportTourismMarkets()** | 100% | 1 | 1 | 100% |

## File(s)

### E:\github\FunWasHad\src\FWH.MarketingApi\Models\TourismMarket.cs
```
 1            namespace FWH.MarketingApi.Models;
 2            
 3            /// <summary>
 4            /// Represents a tourism market that can contain multiple cities.
 5            /// </summary>
 6            public class TourismMarket
 7            {
 8  ✔  20         public long Id { get; set; }
 9  ✔  28         public required string Name { get; set; }
10  ✔  20         public string? Description { get; set; }
11  ✔  20         public bool IsActive { get; set; }
12  ✔  20         public DateTimeOffset CreatedAt { get; set; }
13  ❌  0         public DateTimeOffset? UpdatedAt { get; set; }
14            
15                // Navigation properties
16  ✔  47         public ICollection<CityTourismMarket> CityTourismMarkets { get; set; } = new List<CityTourismMarket>();
17  ✔  47         public ICollection<AirportTourismMarket> AirportTourismMarkets { get; set; } = new List<AirportTourismMarket>();
18            }
```
# FWH.MarketingApi.Models.UploadAttachmentRequest

## Summary

|||
|:---|:---|
| Class: | FWH.MarketingApi.Models.UploadAttachmentRequest |
| Assembly: | FWH.MarketingApi |
| **File(s):** | E:\github\FunWasHad\src\FWH.MarketingApi\Models\UploadAttachmentRequest.cs |
| **Line coverage:** | 0% (0 of 5) |
| Covered lines: | 0 |
| Uncovered lines: | 5 |
| Coverable lines: | 5 |
| Total lines: | 13 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **get_FeedbackId()** | 100% | 2 | 1 | 0% |
| **get_AttachmentType()** | 100% | 2 | 1 | 0% |
| **get_FileName()** | 100% | 2 | 1 | 0% |
| **get_ContentType()** | 100% | 2 | 1 | 0% |
| **get_FileData()** | 100% | 2 | 1 | 0% |

## File(s)

### E:\github\FunWasHad\src\FWH.MarketingApi\Models\UploadAttachmentRequest.cs
```
 1           namespace FWH.MarketingApi.Models;
 2           
 3           /// <summary>
 4           /// Request model for uploading feedback attachments.
 5           /// </summary>
 6           public class UploadAttachmentRequest
 7           {
 8  ❌ 0         public long FeedbackId { get; set; }
 9  ❌ 0         public required string AttachmentType { get; set; }
10  ❌ 0         public required string FileName { get; set; }
11  ❌ 0         public required string ContentType { get; set; }
12  ❌ 0         public required byte[] FileData { get; set; }
13           }
```
# FWH.MarketingApi.Services.LocalFileBlobStorageService

## Summary

|||
|:---|:---|
| Class: | FWH.MarketingApi.Services.LocalFileBlobStorageService |
| Assembly: | FWH.MarketingApi |
| **File(s):** | E:\github\FunWasHad\src\FWH.MarketingApi\Services\LocalFileBlobStorageService.cs |
| **Line coverage:** | 76.4% (91 of 119) |
| Covered lines: | 91 |
| Uncovered lines: | 28 |
| Coverable lines: | 119 |
| Total lines: | 203 |
| **Branch coverage:** | 71% (27 of 38) |
| Covered branches: | 27 |
| Total branches: | 38 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **.ctor(...)** | 50.0% | 9 | 8 | 76.47% |
| **UploadAsync()** | 87.50% | 8 | 8 | 95.65% |
| **UploadWithThumbnailAsync()** | 100% | 4 | 4 | 100% |
| **DeleteAsync(...)** | 75.00% | 4 | 4 | 70.58% |
| **GetAsync(...)** | 75.00% | 4 | 4 | 68.75% |
| **ExistsAsync(...)** | 50.0% | 2 | 2 | 60.0% |
| **StorageUrlToFilePath(...)** | 50.0% | 5 | 4 | 66.66% |
| **SanitizeFileName(...)** | 75.00% | 5 | 4 | 66.66% |

## File(s)

### E:\github\FunWasHad\src\FWH.MarketingApi\Services\LocalFileBlobStorageService.cs
```
  1            using System.IO;
  2            
  3            namespace FWH.MarketingApi.Services;
  4            
  5            /// <summary>
  6            /// Local file system implementation of blob storage.
  7            /// Used for development and can be used for Railway with persistent volumes.
  8            /// </summary>
  9            public class LocalFileBlobStorageService : IBlobStorageService
 10            {
 11                private readonly string _basePath;
 12                private readonly string _baseUrl;
 13                private readonly ILogger<LocalFileBlobStorageService> _logger;
 14            
 15  ✔  16         public LocalFileBlobStorageService(
 16  ✔  16             IConfiguration configuration,
 17  ✔  16             ILogger<LocalFileBlobStorageService> logger)
 18  ✔  16         {
 19  ✓  16  ◑          _logger = logger ?? throw new ArgumentNullException(nameof(logger));
 20  ✔  16             ArgumentNullException.ThrowIfNull(configuration);
 21            
 22                    // Get storage path from configuration, default to ./uploads in current directory
 23  ✓  16  ◑          _basePath = configuration["BlobStorage:LocalPath"]
 24  ✔  16                 ?? Path.Combine(Directory.GetCurrentDirectory(), "uploads");
 25            
 26                    // Get base URL for serving files, default to /uploads
 27  ✓  16  ◑          _baseUrl = configuration["BlobStorage:BaseUrl"] ?? "/uploads";
 28            
 29                    // Ensure base directory exists
 30  ✓  16  ◑          if (!Directory.Exists(_basePath))
 31  ❌  0             {
 32  ❌  0                 Directory.CreateDirectory(_basePath);
 33  ❌  0                 _logger.LogInformation("Created blob storage directory: {BasePath}", _basePath);
 34  ❌  0             }
 35            
 36  ✔  16             _logger.LogInformation("Local file blob storage initialized. Base path: {BasePath}, Base URL: {BaseUrl}",
 37  ✔  16                 _basePath, _baseUrl);
 38  ✔  16         }
 39            
 40                public async Task<string> UploadAsync(
 41                    Stream fileStream,
 42                    string fileName,
 43                    string contentType,
 44                    string container,
 45                    CancellationToken cancellationToken = default)
 46  ✔  15         {
 47  ✔  15  ●          if (fileStream == null)
 48  ✔   1                 throw new ArgumentNullException(nameof(fileStream));
 49  ✔  14  ●          if (string.IsNullOrWhiteSpace(fileName))
 50  ✔   3                 throw new ArgumentException("File name cannot be null or empty", nameof(fileName));
 51  ✓  11  ◑          if (string.IsNullOrWhiteSpace(container))
 52  ❌  0                 throw new ArgumentException("Container cannot be null or empty", nameof(container));
 53            
 54                    // Sanitize file name
 55  ✔  11             var sanitizedFileName = SanitizeFileName(fileName);
 56  ✔  11             var uniqueFileName = $"{Guid.NewGuid()}_{sanitizedFileName}";
 57            
 58                    // Create container directory
 59  ✔  11             var containerPath = Path.Combine(_basePath, container);
 60  ✔  11  ●          if (!Directory.Exists(containerPath))
 61  ✔  10             {
 62  ✔  10                 Directory.CreateDirectory(containerPath);
 63  ✔  10             }
 64            
 65                    // Full file path
 66  ✔  11             var filePath = Path.Combine(containerPath, uniqueFileName);
 67            
 68                    // Write file
 69  ✔  11             using (var fileStreamWriter = new FileStream(filePath, FileMode.Create, FileAccess.Write, FileShare.None))
 70  ✔  11             {
 71  ✔  11                 await fileStream.CopyToAsync(fileStreamWriter, cancellationToken);
 72  ✔  11             }
 73            
 74                    // Return public URL
 75  ✔  11             var storageUrl = $"{_baseUrl.TrimEnd('/')}/{container}/{uniqueFileName}";
 76  ✔  11             _logger.LogDebug("Uploaded file to {StorageUrl}", storageUrl);
 77            
 78  ✔  11             return storageUrl;
 79  ✔  11         }
 80            
 81                public async Task<(string StorageUrl, string? ThumbnailUrl)> UploadWithThumbnailAsync(
 82                    Stream fileStream,
 83                    string fileName,
 84                    string contentType,
 85                    string container,
 86                    bool generateThumbnail = false,
 87                    CancellationToken cancellationToken = default)
 88  ✔   4         {
 89  ✔   4             var storageUrl = await UploadAsync(fileStream, fileName, contentType, container, cancellationToken);
 90            
 91                    // Thumbnail generation would be implemented here for images/videos
 92                    // For now, return null for thumbnail
 93  ✔   4             string? thumbnailUrl = null;
 94            
 95  ✔   4  ●          if (generateThumbnail && contentType.StartsWith("image/", StringComparison.OrdinalIgnoreCase))
 96  ✔   3             {
 97                        // TODO: Implement thumbnail generation for images
 98  ✔   3                 _logger.LogDebug("Thumbnail generation requested but not yet implemented for {FileName}", fileName);
 99  ✔   3             }
100            
101  ✔   4             return (storageUrl, thumbnailUrl);
102  ✔   4         }
103            
104                public Task<bool> DeleteAsync(string storageUrl, CancellationToken cancellationToken = default)
105  ✔   2         {
106  ✓   2  ◑          if (string.IsNullOrWhiteSpace(storageUrl))
107  ❌  0                 return Task.FromResult(false);
108            
109                    try
110  ✔   2             {
111  ✔   2                 var filePath = StorageUrlToFilePath(storageUrl);
112  ✔   2  ●              if (File.Exists(filePath))
113  ✔   1                 {
114  ✔   1                     File.Delete(filePath);
115  ✔   1                     _logger.LogDebug("Deleted file: {StorageUrl}", storageUrl);
116  ✔   1                     return Task.FromResult(true);
117                        }
118  ✔   1             }
119  ❌  0             catch (Exception ex)
120  ❌  0             {
121  ❌  0                 _logger.LogWarning(ex, "Error deleting file: {StorageUrl}", storageUrl);
122  ❌  0             }
123            
124  ✔   1             return Task.FromResult(false);
125  ✔   2         }
126            
127                public Task<Stream?> GetAsync(string storageUrl, CancellationToken cancellationToken = default)
128  ✔   3         {
129  ✓   3  ◑          if (string.IsNullOrWhiteSpace(storageUrl))
130  ❌  0                 return Task.FromResult<Stream?>(null);
131            
132                    try
133  ✔   3             {
134  ✔   3                 var filePath = StorageUrlToFilePath(storageUrl);
135  ✔   3  ●              if (File.Exists(filePath))
136  ✔   2                 {
137  ✔   2                     var stream = new FileStream(filePath, FileMode.Open, FileAccess.Read, FileShare.Read);
138  ✔   2                     return Task.FromResult<Stream?>(stream);
139                        }
140  ✔   1             }
141  ❌  0             catch (Exception ex)
142  ❌  0             {
143  ❌  0                 _logger.LogWarning(ex, "Error reading file: {StorageUrl}", storageUrl);
144  ❌  0             }
145            
146  ✔   1             return Task.FromResult<Stream?>(null);
147  ✔   3         }
148            
149                public Task<bool> ExistsAsync(string storageUrl, CancellationToken cancellationToken = default)
150  ✔   3         {
151  ✓   3  ◑          if (string.IsNullOrWhiteSpace(storageUrl))
152  ❌  0                 return Task.FromResult(false);
153            
154                    try
155  ✔   3             {
156  ✔   3                 var filePath = StorageUrlToFilePath(storageUrl);
157  ✔   3                 return Task.FromResult(File.Exists(filePath));
158                    }
159  ❌  0             catch
160  ❌  0             {
161  ❌  0                 return Task.FromResult(false);
162                    }
163  ✔   3         }
164            
165                private string StorageUrlToFilePath(string storageUrl)
166  ✔   8         {
167                    // Remove base URL prefix
168  ✔   8             var relativePath = storageUrl;
169  ✓   8  ◑          if (storageUrl.StartsWith(_baseUrl, StringComparison.OrdinalIgnoreCase))
170  ✔   8             {
171  ✔   8                 relativePath = storageUrl.Substring(_baseUrl.Length).TrimStart('/');
172  ✔   8             }
173  ❌  0  ◑          else if (storageUrl.StartsWith("/uploads/", StringComparison.OrdinalIgnoreCase))
174  ❌  0             {
175  ❌  0                 relativePath = storageUrl.Substring("/uploads/".Length);
176  ❌  0             }
177            
178  ✔   8             return Path.Combine(_basePath, relativePath);
179  ✔   8         }
180            
181                private static string SanitizeFileName(string fileName)
182  ✔  11         {
183                    // Remove path separators and other dangerous characters
184  ✔  11             var invalidChars = Path.GetInvalidFileNameChars();
185  ✔  11             var sanitized = string.Join("_", fileName.Split(invalidChars, StringSplitOptions.RemoveEmptyEntries));
186            
187                    // Remove ".." to prevent directory traversal
188  ✔  12  ●          while (sanitized.Contains("..", StringComparison.Ordinal))
189  ✔   1             {
190  ✔   1                 sanitized = sanitized.Replace("..", "", StringComparison.Ordinal);
191  ✔   1             }
192            
193                    // Limit length
194  ✓  11  ◑          if (sanitized.Length > 255)
195  ❌  0             {
196  ❌  0                 var extension = Path.GetExtension(sanitized);
197  ❌  0                 var nameWithoutExt = Path.GetFileNameWithoutExtension(sanitized);
198  ❌  0                 sanitized = nameWithoutExt.Substring(0, Math.Min(255 - extension.Length, nameWithoutExt.Length)) + extension
199  ❌  0             }
200            
201  ✔  11             return sanitized;
202  ✔  11         }
203            }
```
# Program

## Summary

|||
|:---|:---|
| Class: | Program |
| Assembly: | FWH.MarketingApi |
| **File(s):** | E:\github\FunWasHad\src\FWH.MarketingApi\Program.cs |
| **Line coverage:** | 79.5% (78 of 98) |
| Covered lines: | 78 |
| Uncovered lines: | 20 |
| Coverable lines: | 98 |
| Total lines: | 155 |
| **Branch coverage:** | 71.4% (10 of 14) |
| Covered branches: | 10 |
| Total branches: | 14 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **<Main>$()** | 75.00% | 13 | 12 | 83.11% |
| **ApplyDatabaseMigrationsAsync()** | 50.0% | 2 | 2 | 66.66% |

## File(s)

### E:\github\FunWasHad\src\FWH.MarketingApi\Program.cs
```
  1           using FWH.MarketingApi.Data;
  2           using Microsoft.EntityFrameworkCore;
  3           using Microsoft.Extensions.Hosting;
  4           
  5  ✔  3     var builder = WebApplication.CreateBuilder(args);
  6           
  7           // Configure Kestrel to listen on all interfaces (0.0.0.0) in Development
  8           // This allows Android devices and emulators to connect via host IP
  9  ✔  3  ●  if (builder.Environment.IsDevelopment())
 10  ✔  3     {
 11  ✔  3         builder.WebHost.ConfigureKestrel(options =>
 12  ❌ 0         {
 13  ✔  3             // Listen on all interfaces for HTTP (port configured by Aspire: 4750)
 14  ❌ 0             options.ListenAnyIP(4750);
 15  ✔  3     
 16  ✔  3             // Listen on all interfaces for HTTPS (port configured by Aspire: 4749)
 17  ❌ 0             options.ListenAnyIP(4749, listenOptions =>
 18  ❌ 0             {
 19  ❌ 0                 listenOptions.UseHttps();
 20  ❌ 0             });
 21  ✔  3         });
 22  ✔  3     }
 23           
 24           // Add Aspire service defaults (telemetry, health checks, resilience)
 25  ✔  3     builder.AddServiceDefaults();
 26           
 27           // Add PostgreSQL with Aspire
 28  ✔  3     builder.AddNpgsqlDbContext<MarketingDbContext>("marketing");
 29           
 30           // Add controllers with JSON options to handle circular references
 31  ✔  3     builder.Services.AddControllers()
 32  ✔  3         .AddJsonOptions(options =>
 33  ✔  3         {
 34  ✔  3             options.JsonSerializerOptions.ReferenceHandler = System.Text.Json.Serialization.ReferenceHandler.IgnoreCycles;
 35  ✔  6         });
 36           
 37           // Add problem details
 38  ✔  3     builder.Services.AddProblemDetails();
 39           
 40           // Add blob storage service
 41           // For Railway staging, use local file storage with persistent volume
 42           // For production, consider cloud storage (S3, Azure Blob, etc.)
 43  ✔  3     builder.Services.AddSingleton<FWH.MarketingApi.Services.IBlobStorageService,
 44  ✔  3         FWH.MarketingApi.Services.LocalFileBlobStorageService>();
 45           
 46           // Add Swagger/OpenAPI for Debug and Staging builds
 47           #if DEBUG || STAGING
 48  ✔  3     builder.Services.AddEndpointsApiExplorer();
 49  ✔  3     builder.Services.AddSwaggerGen(options =>
 50  ✔  2     {
 51  ✔  2         options.SwaggerDoc("v1", new()
 52  ✔  2         {
 53  ✔  2             Title = "FunWasHad Marketing API",
 54  ✔  2             Version = "v1",
 55  ✔  2             Description = "REST API for business marketing data, feedback, and attachments. Implements TR-API-002 and TR-API
 56  ✔  2         });
 57  ✔  3     
 58  ✔  3         // Include XML comments in Swagger documentation
 59  ✔  2         var xmlFile = $"{System.Reflection.Assembly.GetExecutingAssembly().GetName().Name}.xml";
 60  ✔  2         var xmlPath = Path.Combine(AppContext.BaseDirectory, xmlFile);
 61  ✔  2  ●      if (File.Exists(xmlPath))
 62  ✔  2         {
 63  ✔  2             options.IncludeXmlComments(xmlPath);
 64  ✔  2         }
 65  ✔  5     });
 66           #endif
 67           
 68  ✔  3     var app = builder.Build();
 69           
 70           // Apply database migrations on startup
 71  ✔  3     await ApplyDatabaseMigrationsAsync(app);
 72           
 73           // Map Aspire default endpoints (health checks, metrics)
 74  ✔  3     app.MapDefaultEndpoints();
 75           
 76           // Enable Swagger UI for Debug and Staging builds
 77           #if DEBUG || STAGING
 78  ✔  3     app.UseSwagger();
 79  ✔  3     app.UseSwaggerUI(options =>
 80  ✔  3     {
 81  ✔  3         options.SwaggerEndpoint("/swagger/v1/swagger.json", "FunWasHad Marketing API v1");
 82  ✔  3         options.RoutePrefix = "swagger";
 83  ✔  3         options.DisplayRequestDuration();
 84  ✔  6     });
 85           #endif
 86           
 87           // Configure error handling
 88  ✓  3  ◑  if (!app.Environment.IsDevelopment())
 89  ❌ 0     {
 90  ❌ 0         app.UseExceptionHandler();
 91  ❌ 0         app.UseHsts();
 92  ❌ 0     }
 93           
 94           // Add API key authentication middleware
 95           // Note: In Development/Staging, authentication is optional (can be disabled via config)
 96  ✔  3     var requireAuth = app.Configuration.GetValue<bool>("ApiSecurity:RequireAuthentication", defaultValue: true);
 97  ✓  3  ◑  if (requireAuth)
 98  ❌ 0     {
 99  ❌ 0         app.UseMiddleware<FWH.MarketingApi.Middleware.ApiKeyAuthenticationMiddleware>();
100  ❌ 0     }
101           
102  ✔  3     app.UseHttpsRedirection();
103           
104           // Serve static files from uploads directory
105  ✓  3  ◑  var uploadsPath = app.Configuration["BlobStorage:LocalPath"]
106  ✔  3         ?? Path.Combine(Directory.GetCurrentDirectory(), "uploads");
107  ✔  3  ●  if (Directory.Exists(uploadsPath))
108  ✔  3     {
109  ✔  3         app.UseStaticFiles(new StaticFileOptions
110  ✔  3         {
111  ✔  3             FileProvider = new Microsoft.Extensions.FileProviders.PhysicalFileProvider(uploadsPath),
112  ✔  3             RequestPath = "/uploads"
113  ✔  3         });
114  ✔  3         app.Logger.LogInformation("Static file serving enabled for uploads at /uploads");
115  ✔  3     }
116           
117  ✔  3     app.MapControllers();
118           
119           static async Task ApplyDatabaseMigrationsAsync(WebApplication app)
120  ✔  3     {
121  ✔  3         using var scope = app.Services.CreateScope();
122  ✔  3         var logger = scope.ServiceProvider.GetRequiredService<ILogger<Program>>();
123           
124               try
125  ✔  3         {
126  ✔  3             logger.LogDebug("Checking for database migrations...");
127           
128                   // Get connection string from configuration
129  ✔  3             var configuration = scope.ServiceProvider.GetRequiredService<IConfiguration>();
130  ✔  3             var connectionString = configuration.GetConnectionString("marketing");
131           
132  ✓  3  ◑          if (string.IsNullOrEmpty(connectionString))
133  ❌ 0             {
134  ❌ 0                 logger.LogWarning("Database connection string 'marketing' not found. Skipping migrations (likely using in-me
135  ❌ 0                 return;
136                   }
137           
138                   // Create and run migration service
139  ✔  3             var migrationLogger = scope.ServiceProvider.GetRequiredService<ILogger<DatabaseMigrationService>>();
140  ✔  3             var migrationService = new DatabaseMigrationService(connectionString, migrationLogger);
141           
142  ✔  3             await migrationService.ApplyMigrationsAsync();
143           
144  ✔  3             logger.LogInformation("Database migrations completed successfully");
145  ✔  3         }
146  ❌ 0         catch (Exception ex)
147  ❌ 0         {
148  ❌ 0             logger.LogError(ex, "Failed to apply database migrations");
149  ❌ 0             throw;
150               }
151  ✔  3     }
152           
153  ✔  3     app.Run();
154           
155           public partial class Program { }
```
# FWH.Mobile.App

## Summary

|||
|:---|:---|
| Class: | FWH.Mobile.App |
| Assembly: | FWH.Mobile |
| **File(s):** | E:\github\FunWasHad\src\FWH.Mobile\FWH.Mobile\App.axaml<br />E:\github\FunWasHad\src\FWH.Mobile\FWH.Mobile\App.axaml.cs |
| **Line coverage:** | 0% (0 of 405) |
| Covered lines: | 0 |
| Uncovered lines: | 405 |
| Coverable lines: | 405 |
| Total lines: | 704 |
| **Branch coverage:** | 0% (0 of 124) |
| Covered branches: | 0 |
| Total branches: | 124 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **!XamlIlPopulate(...)** | 0% | 6 | 2 | 0% |
| **.cctor()** | 0% | 156 | 12 | 0% |
| **get_ServiceProvider()** | 100% | 2 | 1 | 0% |
| **BuildConfiguration()** | 0% | 110 | 10 | 0% |
| **LoadAndroidAsset(...)** | 0% | 600 | 24 | 0% |
| **GetHostIpAddress(...)** | 0% | 20 | 4 | 0% |
| **TryRegisterPlatformCameraServices(...)** | 0% | 702 | 26 | 0% |
| **EnsureDatabaseInitializedAsync()** | 0% | 20 | 4 | 0% |
| **Initialize()** | 100% | 2 | 1 | 0% |
| **OnFrameworkInitializationCompleted()** | 0% | 20 | 4 | 0% |
| **StartLocationTrackingAsync()** | 0% | 20 | 4 | 0% |
| **InitializeWorkflowAsync()** | 0% | 20 | 4 | 0% |
| **LoadWorkflowFileAsync()** | 0% | 812 | 28 | 0% |
| **DisableAvaloniaDataAnnotationValidation()** | 0% | 6 | 2 | 0% |

## File(s)

### E:\github\FunWasHad\src\FWH.Mobile\FWH.Mobile\App.axaml
```
 1  ❌ 0  ○  <Application xmlns="https://github.com/avaloniaui"
 2                        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
 3                        xmlns:local="using:FWH.Mobile"
 4                        x:Class="FWH.Mobile.App"
 5  ❌ 0                  RequestedThemeVariant="Default">
 6                        <!-- "Default" ThemeVariant follows system theme variant. "Dark" or "Light" are other available options. --
 7           
 8               <Application.DataTemplates>
 9  ❌ 0             <local:ViewLocator/>
10               </Application.DataTemplates>
11           
12               <Application.Styles>
13  ❌ 0             <FluentTheme />
14               </Application.Styles>
15           </Application>
```
### E:\github\FunWasHad\src\FWH.Mobile\FWH.Mobile\App.axaml.cs
```
  1           using System;
  2           using System.Linq;
  3           using System.IO;
  4           using System.Threading;
  5           using System.Threading.Tasks;
  6           
  7           using Avalonia;
  8           using Avalonia.Controls;
  9           using Avalonia.Controls.ApplicationLifetimes;
 10           using Avalonia.Data.Core;
 11           using Avalonia.Data.Core.Plugins;
 12           using Avalonia.Markup.Xaml;
 13           using Avalonia.Threading;
 14           using Microsoft.Extensions.Configuration;
 15           using Microsoft.Extensions.DependencyInjection;
 16           using Microsoft.Extensions.Logging;
 17           
 18           using FWH.Mobile.Configuration;
 19           using FWH.Mobile.ViewModels;
 20           using FWH.Mobile.Views;
 21           using FWH.Common.Chat.Services;
 22           using FWH.Common.Chat.ViewModels;
 23           using FWH.Common.Workflow;
 24           using FWH.Common.Workflow.Extensions;
 25           using FWH.Common.Chat;
 26           using FWH.Common.Chat.Extensions;
 27           using FWH.Common.Location;
 28           using FWH.Common.Location.Extensions;
 29           using FWH.Mobile.Data.Extensions;
 30           using FWH.Common.Imaging.Extensions;
 31           using FWH.Mobile.Services;
 32           using FWH.Mobile.Options;
 33           using FWH.Orchestrix.Mediator.Remote.Extensions;
 34           
 35           namespace FWH.Mobile;
 36           
 37           public partial class App : Application
 38           {
 39  ❌ 0         private static bool _isDatabaseInitialized = false;
 40  ❌ 0         private static readonly SemaphoreSlim _initializationLock = new SemaphoreSlim(1, 1);
 41           
 42               static App()
 43  ❌ 0         {
 44                   // Build configuration
 45  ❌ 0             var configuration = BuildConfiguration();
 46           
 47  ❌ 0             var services = new ServiceCollection();
 48           
 49                   // Register configuration
 50  ❌ 0             services.AddSingleton<IConfiguration>(configuration);
 51           
 52                   // Register API settings
 53  ❌ 0  ○          var apiSettings = configuration.GetSection("ApiSettings").Get<ApiSettings>() ?? new ApiSettings();
 54  ❌ 0             services.AddSingleton(apiSettings);
 55           
 56                   // Register location settings
 57  ❌ 0  ○          var locationSettings = configuration.GetSection("LocationSettings").Get<LocationSettings>() ?? new LocationSetti
 58  ❌ 0             services.AddSingleton(locationSettings);
 59           
 60                   // Register log store and configure logging to use Avalonia logger
 61  ❌ 0             var logStore = new FWH.Mobile.Logging.AvaloniaLogStore(maxEntries: 1000);
 62  ❌ 0             services.AddSingleton(logStore);
 63           
 64  ❌ 0             services.AddLogging(builder =>
 65  ❌ 0             {
 66  ❌ 0                 builder.AddConfiguration(configuration.GetSection("Logging"));
 67  ❌ 0                 builder.AddConsole(); // Enable console logging for Android logcat
 68  ❌ 0                 builder.AddProvider(new FWH.Mobile.Logging.AvaloniaLoggerProvider(logStore));
 69  ❌ 0             });
 70           
 71                   // Note: Service discovery is available when Microsoft.Extensions.ServiceDiscovery package is added
 72                   // For now, using direct URL configuration for mobile app
 73                   // services.AddServiceDiscovery();
 74           
 75                   // Register platform service first (needed for database path)
 76  ❌ 0             services.AddSingleton<IPlatformService, PlatformService>();
 77           
 78                   // Get the platform-specific database path
 79  ❌ 0             var platformService = new PlatformService();
 80  ❌ 0             var databasePath = platformService.GetDatabasePath("fwh_mobile.db");
 81  ❌ 0             var connectionString = $"DataSource={databasePath}";
 82           
 83                   // Register data services with persistent database
 84  ❌ 0             services.AddDataServices(connectionString);
 85           
 86                   // Register workflow services using extension method
 87  ❌ 0             services.AddWorkflowServices();
 88           
 89                   // Register chat services using extension method
 90                   // This now includes platform detection and camera service factory
 91  ❌ 0             services.AddChatServices();
 92           
 93                   // Register location services (includes GPS service factory)
 94                   // Requires IPlatformService from AddChatServices() to be registered first
 95  ❌ 0             services.AddLocationServices();
 96           
 97           
 98                   // Register MediatR handlers for remote API calls
 99  ❌ 0             services.AddRemoteMediatorHandlers();
100           
101                   // Get API base addresses from configuration
102                   string locationApiBaseAddress;
103                   string marketingApiBaseAddress;
104           
105                   // Check for environment variable overrides first
106  ❌ 0             var locationEnvVar = Environment.GetEnvironmentVariable("LOCATION_API_BASE_URL");
107  ❌ 0             var marketingEnvVar = Environment.GetEnvironmentVariable("MARKETING_API_BASE_URL");
108           
109  ❌ 0  ○          if (!string.IsNullOrEmpty(locationEnvVar) && !string.IsNullOrEmpty(marketingEnvVar))
110  ❌ 0             {
111                       // Use environment variables if set
112  ❌ 0                 locationApiBaseAddress = locationEnvVar;
113  ❌ 0                 marketingApiBaseAddress = marketingEnvVar;
114  ❌ 0             }
115                   else
116  ❌ 0             {
117                       // Use configured URLs from appsettings (supports both full URLs for staging and IP/port for development)
118  ❌ 0                 locationApiBaseAddress = apiSettings.GetLocationApiBaseUrl();
119  ❌ 0                 marketingApiBaseAddress = apiSettings.GetMarketingApiBaseUrl();
120  ❌ 0             }
121           
122                   // Register API authentication service
123  ❌ 0  ○          var apiKey = configuration["ApiSecurity:ApiKey"] ?? "dev-api-key-change-in-production";
124  ❌ 0  ○          var apiSecret = configuration["ApiSecurity:ApiSecret"] ?? "dev-api-secret-change-in-production";
125  ❌ 0             services.AddSingleton<FWH.Mobile.Services.IApiAuthenticationService>(sp =>
126  ❌ 0             {
127  ❌ 0                 var logger = sp.GetService<ILogger<FWH.Mobile.Services.ApiAuthenticationService>>();
128  ❌ 0                 return new FWH.Mobile.Services.ApiAuthenticationService(apiKey, apiSecret, logger);
129  ❌ 0             });
130           
131  ❌ 0             services.AddApiHttpClients(options =>
132  ❌ 0             {
133  ❌ 0                 options.LocationApiBaseUrl = locationApiBaseAddress;
134  ❌ 0                 options.MarketingApiBaseUrl = marketingApiBaseAddress;
135  ❌ 0             });
136           
137                   // Keep ILocationService registered for GetNearbyBusinessesActionHandler and other services that need it
138  ❌ 0             services.AddSingleton<ILocationService>(sp =>
139  ❌ 0             {
140  ❌ 0                 var clientFactory = sp.GetRequiredService<IHttpClientFactory>();
141  ❌ 0                 var loggerFactory = sp.GetRequiredService<ILoggerFactory>();
142  ❌ 0                 var httpClient = clientFactory.CreateClient("LocationApi");
143  ❌ 0     
144  ❌ 0                 return new LocationApiClient(
145  ❌ 0                     httpClient,
146  ❌ 0                     Microsoft.Extensions.Options.Options.Create(new LocationApiClientOptions
147  ❌ 0                     {
148  ❌ 0                         BaseAddress = locationApiBaseAddress,
149  ❌ 0                         Timeout = TimeSpan.FromSeconds(30)
150  ❌ 0                     }),
151  ❌ 0                     loggerFactory.CreateLogger<LocationApiClient>());
152  ❌ 0             });
153           
154                   // Register image service
155  ❌ 0             services.AddSingleton<IImageService, ImageService>();
156           
157                   // Register theme service
158  ❌ 0             services.AddSingleton<IThemeService, ThemeService>();
159           
160                   // Register location tracking service
161  ❌ 0             services.AddSingleton<ILocationTrackingService, LocationTrackingService>();
162           
163                   // Register location workflow service for address-based workflows
164  ❌ 0             services.AddSingleton<LocationWorkflowService>();
165           
166                   // Register activity tracking service
167  ❌ 0             services.AddSingleton<ActivityTrackingService>();
168           
169                   // Register activity tracking ViewModel
170  ❌ 0             services.AddSingleton<ActivityTrackingViewModel>();
171           
172                   // Register movement state logger (for demonstration)
173  ❌ 0             services.AddSingleton<MovementStateLogger>();
174           
175                   // Register movement state ViewModel
176  ❌ 0             services.AddSingleton<MovementStateViewModel>();
177           
178                   // Register main ViewModel for navigation
179  ❌ 0             services.AddSingleton<MainViewModel>();
180           
181                   // Register imaging services
182  ❌ 0             services.AddImagingServices();
183           
184                   // Register notification service (uses chat UI for notifications)
185  ❌ 0             services.AddSingleton<INotificationService, ChatNotificationService>();
186           
187                   // Register workflow action handler for GPS + nearby businesses
188  ❌ 0             services.AddScoped<GetNearbyBusinessesActionHandler>();
189  ❌ 0             services.AddScoped<FWH.Common.Workflow.Actions.IWorkflowActionHandler>(sp =>
190  ❌ 0                 sp.GetRequiredService<GetNearbyBusinessesActionHandler>());
191           
192                   // Register platform-specific camera services using runtime detection
193                   // These extension methods will be no-ops if the platform assembly isn't loaded
194  ❌ 0             TryRegisterPlatformCameraServices(services);
195           
196                   // Register camera capture ViewModel
197  ❌ 0             services.AddSingleton<CameraCaptureViewModel>(sp =>
198  ❌ 0             {
199  ❌ 0                 var cameraService = sp.GetRequiredService<ICameraService>();
200  ❌ 0                 var logger = sp.GetService<ILogger<CameraCaptureViewModel>>();
201  ❌ 0                 var imageService = sp.GetService<IImageService>();
202  ❌ 0                 return new CameraCaptureViewModel(cameraService, logger, imageService);
203  ❌ 0             });
204           
205                   // Register log viewer ViewModel
206  ❌ 0             services.AddSingleton<LogViewerViewModel>();
207           
208                   try
209  ❌ 0             {
210  ❌ 0                 ServiceProvider = services.BuildServiceProvider();
211  ❌ 0                 ServiceProvider.InitializeWorkflowActionHandlers();
212  ❌ 0             }
213  ❌ 0             catch (Exception ex)
214  ❌ 0             {
215                       // Log to Android log if possible, but don't crash
216  ❌ 0                 System.Diagnostics.Debug.WriteLine($"CRITICAL: Failed to build service provider: {ex}");
217  ❌ 0                 System.Diagnostics.Debug.WriteLine($"Exception details: {ex.Message}");
218  ❌ 0                 System.Diagnostics.Debug.WriteLine($"Stack trace: {ex.StackTrace}");
219  ❌ 0                 throw; // Re-throw to prevent app from starting in broken state
220                   }
221           
222                   // Database initialization deferred to OnFrameworkInitializationCompleted
223                   // to avoid blocking the UI thread during app startup
224           
225  ❌ 0         }
226           
227  ❌ 0         public static IServiceProvider ServiceProvider { get; }
228           
229               /// <summary>
230               /// Builds the application configuration from appsettings.json files
231               /// </summary>
232               private static IConfiguration BuildConfiguration()
233  ❌ 0         {
234  ❌ 0             var builder = new ConfigurationBuilder();
235           
236                   // Get environment name (Staging, Development, Production, etc.)
237  ❌ 0  ○          var environment = Environment.GetEnvironmentVariable("ASPNETCORE_ENVIRONMENT")
238  ❌ 0                 ?? Environment.GetEnvironmentVariable("DOTNET_ENVIRONMENT")
239  ❌ 0                 ?? "Development";
240           
241  ❌ 0  ○          if (OperatingSystem.IsAndroid())
242  ❌ 0             {
243                       // On Android, read from assets
244  ❌ 0                 var appSettingsStream = LoadAndroidAsset("appsettings.json");
245  ❌ 0  ○              if (appSettingsStream != null)
246  ❌ 0                 {
247  ❌ 0                     builder.AddJsonStream(appSettingsStream);
248  ❌ 0                 }
249           
250                       // Load environment-specific appsettings file
251  ❌ 0                 var envSettingsStream = LoadAndroidAsset($"appsettings.{environment}.json");
252  ❌ 0  ○              if (envSettingsStream != null)
253  ❌ 0                 {
254  ❌ 0                     builder.AddJsonStream(envSettingsStream);
255  ❌ 0                 }
256  ❌ 0             }
257                   else
258  ❌ 0             {
259                       // On Desktop/iOS, read from file system
260  ❌ 0                 builder
261  ❌ 0                     .SetBasePath(Directory.GetCurrentDirectory())
262  ❌ 0                     .AddJsonFile("appsettings.json", optional: false, reloadOnChange: true)
263  ❌ 0                     .AddJsonFile($"appsettings.{environment}.json", optional: true, reloadOnChange: true);
264  ❌ 0             }
265           
266  ❌ 0             builder.AddEnvironmentVariables();
267           
268  ❌ 0             return builder.Build();
269  ❌ 0         }
270           
271               /// <summary>
272               /// Loads a file from Android assets.
273               /// </summary>
274               /// <param name="fileName">The name of the asset file</param>
275               /// <returns>Stream containing the asset content, or null if not found</returns>
276               private static Stream? LoadAndroidAsset(string fileName)
277  ❌ 0         {
278  ❌ 0  ○          if (!OperatingSystem.IsAndroid())
279  ❌ 0                 return null;
280           
281                   try
282  ❌ 0             {
283                       // Use reflection to access Android assets to avoid compile-time dependency
284  ❌ 0                 var contextType = Type.GetType("Android.App.Application, Mono.Android");
285  ❌ 0  ○              var contextProperty = contextType?.GetProperty("Context");
286  ❌ 0  ○              var context = contextProperty?.GetValue(null);
287           
288  ❌ 0  ○              var assetsProperty = context?.GetType().GetProperty("Assets");
289  ❌ 0  ○              var assets = assetsProperty?.GetValue(context);
290           
291  ❌ 0  ○              var openMethod = assets?.GetType().GetMethod("Open", new[] { typeof(string) });
292  ❌ 0  ○              var stream = openMethod?.Invoke(assets, new object[] { fileName }) as Stream;
293           
294  ❌ 0  ○              if (stream != null)
295  ❌ 0                 {
296  ❌ 0  ○                  var logger = ServiceProvider?.GetService<ILogger<App>>();
297  ❌ 0  ○                  logger?.LogDebug("Loaded Android asset: {FileName}", fileName);
298  ❌ 0                     return stream;
299                       }
300  ❌ 0             }
301  ❌ 0             catch (Exception ex)
302  ❌ 0             {
303  ❌ 0  ○              var logger = ServiceProvider?.GetService<ILogger<App>>();
304  ❌ 0  ○              logger?.LogWarning(ex, "Failed to load Android asset '{FileName}'", fileName);
305  ❌ 0             }
306           
307  ❌ 0             return null;
308  ❌ 0         }
309           
310               /// <summary>
311               /// Gets the host machine's IP address from configuration.
312               /// The IP address is populated at build time by the MSBuild target in FWH.Mobile.csproj.
313               /// </summary>
314               /// <param name="configuration">The configuration instance</param>
315               /// <returns>The host IP address from configuration, or null if not set</returns>
316               private static string? GetHostIpAddress(IConfiguration configuration)
317  ❌ 0         {
318  ❌ 0             var hostIp = configuration["ApiSettings:HostIpAddress"];
319           
320  ❌ 0  ○          if (string.IsNullOrEmpty(hostIp) || hostIp == "HOST_IP_PLACEHOLDER")
321  ❌ 0             {
322  ❌ 0                 return null;
323                   }
324           
325  ❌ 0             return hostIp;
326  ❌ 0         }
327           
328               /// <summary>
329               /// Attempts to register platform-specific camera and GPS services using reflection
330               /// to avoid compile-time dependencies
331               /// </summary>
332               private static void TryRegisterPlatformCameraServices(IServiceCollection services)
333  ❌ 0         {
334                   try
335  ❌ 0             {
336                       // Try to find and invoke Android extension methods
337  ❌ 0                 var androidAssembly = AppDomain.CurrentDomain.GetAssemblies()
338  ❌ 0                     .FirstOrDefault(a => a.GetName().Name == "FWH.Mobile.Android");
339           
340  ❌ 0  ○              if (androidAssembly != null)
341  ❌ 0                 {
342  ❌ 0                     var androidExtensions = androidAssembly.GetType("FWH.Mobile.Android.AndroidServiceCollectionExtensions")
343           
344                           // Register camera service
345  ❌ 0  ○                  var addAndroidCameraMethod = androidExtensions?.GetMethod("AddAndroidCameraService");
346  ❌ 0  ○                  addAndroidCameraMethod?.Invoke(null, new object[] { services });
347           
348                           // Register GPS service
349  ❌ 0  ○                  var addAndroidGpsMethod = androidExtensions?.GetMethod("AddAndroidGpsService");
350  ❌ 0  ○                  addAndroidGpsMethod?.Invoke(null, new object[] { services });
351  ❌ 0                 }
352  ❌ 0             }
353  ❌ 0             catch
354  ❌ 0             {
355                       // Silently ignore - Android platform not available
356  ❌ 0             }
357           
358                   try
359  ❌ 0             {
360                       // Try to find and invoke iOS extension methods
361  ❌ 0                 var iosAssembly = AppDomain.CurrentDomain.GetAssemblies()
362  ❌ 0                     .FirstOrDefault(a => a.GetName().Name == "FWH.Mobile.iOS");
363           
364  ❌ 0  ○              if (iosAssembly != null)
365  ❌ 0                 {
366  ❌ 0                     var iosExtensions = iosAssembly.GetType("FWH.Mobile.iOS.iOSServiceCollectionExtensions");
367           
368                           // Register camera service
369  ❌ 0  ○                  var addIOSCameraMethod = iosExtensions?.GetMethod("AddIOSCameraService");
370  ❌ 0  ○                  addIOSCameraMethod?.Invoke(null, new object[] { services });
371           
372                           // Register GPS service
373  ❌ 0  ○                  var addIOSGpsMethod = iosExtensions?.GetMethod("AddIOSGpsService");
374  ❌ 0  ○                  addIOSGpsMethod?.Invoke(null, new object[] { services });
375  ❌ 0                 }
376  ❌ 0             }
377  ❌ 0             catch
378  ❌ 0             {
379                       // Silently ignore - iOS platform not available
380  ❌ 0             }
381           
382                   try
383  ❌ 0             {
384                       // Try to find and invoke Desktop extension methods
385  ❌ 0                 var desktopAssembly = AppDomain.CurrentDomain.GetAssemblies()
386  ❌ 0                     .FirstOrDefault(a => a.GetName().Name == "FWH.Mobile.Desktop");
387           
388  ❌ 0  ○              if (desktopAssembly != null)
389  ❌ 0                 {
390  ❌ 0                     var desktopExtensions = desktopAssembly.GetType("FWH.Mobile.Desktop.DesktopServiceCollectionExtensions")
391           
392                           // Register GPS service (Desktop doesn't have camera service yet)
393  ❌ 0  ○                  var addDesktopGpsMethod = desktopExtensions?.GetMethod("AddDesktopGpsService");
394  ❌ 0  ○                  addDesktopGpsMethod?.Invoke(null, new object[] { services });
395  ❌ 0                 }
396  ❌ 0             }
397  ❌ 0             catch
398  ❌ 0             {
399                       // Silently ignore - Desktop platform not available or Windows SDK not available
400  ❌ 0             }
401  ❌ 0         }
402           
403               /// <summary>
404               /// Ensures the database is initialized with all migrations applied.
405               /// Safe to call multiple times.
406               /// TR-MOBILE-001: Includes DeviceLocationHistory table for local tracking.
407               /// </summary>
408               private static async Task EnsureDatabaseInitializedAsync()
409  ❌ 0         {
410  ❌ 0  ○          if (_isDatabaseInitialized)
411  ❌ 0                 return;
412           
413  ❌ 0             await _initializationLock.WaitAsync();
414                   try
415  ❌ 0             {
416  ❌ 0  ○              if (_isDatabaseInitialized)
417  ❌ 0                     return;
418           
419  ❌ 0                 using var scope = ServiceProvider.CreateScope();
420  ❌ 0                 var migrationService = scope.ServiceProvider.GetRequiredService<FWH.Mobile.Data.Services.MobileDatabaseMigra
421  ❌ 0                 var logger = scope.ServiceProvider.GetRequiredService<Microsoft.Extensions.Logging.ILogger<App>>();
422           
423                       // Log database connection info for debugging
424  ❌ 0                 var connectionInfo = migrationService.GetConnectionInfo();
425  ❌ 0                 logger.LogDebug("Initializing database at: {ConnectionInfo}", connectionInfo);
426           
427                       // Ensure database exists and apply any pending migrations
428  ❌ 0                 await migrationService.EnsureDatabaseAsync();
429           
430  ❌ 0                 logger.LogInformation("Database initialization completed successfully");
431           
432  ❌ 0                 _isDatabaseInitialized = true;
433  ❌ 0             }
434  ❌ 0             catch (Exception ex)
435  ❌ 0             {
436  ❌ 0                 using var scope = ServiceProvider.CreateScope();
437  ❌ 0                 var logger = scope.ServiceProvider.GetRequiredService<Microsoft.Extensions.Logging.ILogger<App>>();
438  ❌ 0                 logger.LogError(ex, "Failed to initialize database: {Message}", ex.Message);
439  ❌ 0                 throw;
440                   }
441                   finally
442  ❌ 0             {
443  ❌ 0                 _initializationLock.Release();
444  ❌ 0             }
445  ❌ 0         }
446           
447               public override void Initialize()
448  ❌ 0         {
449  ❌ 0             AvaloniaXamlLoader.Load(this);
450  ❌ 0         }
451           
452               public override void OnFrameworkInitializationCompleted()
453  ❌ 0         {
454                   // Create UI immediately to prevent ANR - don't await anything before showing UI
455  ❌ 0  ○          if (ApplicationLifetime is IClassicDesktopStyleApplicationLifetime desktop)
456  ❌ 0             {
457                       // Avoid duplicate validations from both Avalonia and the CommunityToolkit.
458  ❌ 0                 DisableAvaloniaDataAnnotationValidation();
459           
460  ❌ 0                 var chatViewModel = ServiceProvider.GetRequiredService<ChatViewModel>();
461  ❌ 0                 var logViewerViewModel = ServiceProvider.GetRequiredService<LogViewerViewModel>();
462           
463  ❌ 0                 var mainWindow = new MainWindow
464  ❌ 0                 {
465  ❌ 0                     DataContext = chatViewModel,
466  ❌ 0                     Tag = logViewerViewModel, // Pass log viewer ViewModel via Tag
467  ❌ 0                     Width = 800,
468  ❌ 0                     Height = 600,
469  ❌ 0                     Title = "Fun Was Had"
470  ❌ 0                 };
471           
472  ❌ 0                 desktop.MainWindow = mainWindow;
473  ❌ 0                 mainWindow.Show();
474           
475                       // Initialize everything in background to avoid blocking UI
476  ❌ 0                 _ = Task.Run(async () =>
477  ❌ 0                 {
478  ❌ 0                     try
479  ❌ 0                     {
480  ❌ 0                         // Initialize database with timeout to prevent hanging
481  ❌ 0                         using var dbCts = new CancellationTokenSource(TimeSpan.FromSeconds(10));
482  ❌ 0                         await EnsureDatabaseInitializedAsync().WaitAsync(dbCts.Token).ConfigureAwait(false);
483  ❌ 0     
484  ❌ 0                         // Initialize workflow with timeout
485  ❌ 0                         using var workflowCts = new CancellationTokenSource(TimeSpan.FromSeconds(5));
486  ❌ 0                         await InitializeWorkflowAsync().WaitAsync(workflowCts.Token).ConfigureAwait(false);
487  ❌ 0     
488  ❌ 0                         // Start location tracking (already has internal timeouts)
489  ❌ 0                         await StartLocationTrackingAsync().ConfigureAwait(false);
490  ❌ 0                     }
491  ❌ 0                     catch (OperationCanceledException)
492  ❌ 0                     {
493  ❌ 0                         var logger = ServiceProvider?.GetService<ILogger<App>>();
494  ❌ 0                         logger?.LogWarning("Background initialization timed out");
495  ❌ 0                     }
496  ❌ 0                     catch (Exception ex)
497  ❌ 0                     {
498  ❌ 0                         var logger = ServiceProvider?.GetService<ILogger<App>>();
499  ❌ 0                         logger?.LogError(ex, "Background initialization error");
500  ❌ 0                     }
501  ❌ 0                 });
502  ❌ 0             }
503  ❌ 0  ○          else if (ApplicationLifetime is ISingleViewApplicationLifetime singleViewPlatform)
504  ❌ 0             {
505                       // Create MainView immediately on UI thread - don't await anything
506  ❌ 0                 var chatViewModel = ServiceProvider.GetRequiredService<ChatViewModel>();
507           
508  ❌ 0                 singleViewPlatform.MainView = new MainView
509  ❌ 0                 {
510  ❌ 0                     DataContext = chatViewModel
511  ❌ 0                 };
512           
513                       // Initialize everything in background to avoid ANR
514                       // Use Task.Run to ensure it's on a background thread
515  ❌ 0                 _ = Task.Run(async () =>
516  ❌ 0                 {
517  ❌ 0                     try
518  ❌ 0                     {
519  ❌ 0                         // Initialize database first with timeout to prevent hanging
520  ❌ 0                         using var dbCts = new CancellationTokenSource(TimeSpan.FromSeconds(10));
521  ❌ 0                         await EnsureDatabaseInitializedAsync().WaitAsync(dbCts.Token).ConfigureAwait(false);
522  ❌ 0     
523  ❌ 0                         // Then initialize workflow with timeout
524  ❌ 0                         using var workflowCts = new CancellationTokenSource(TimeSpan.FromSeconds(5));
525  ❌ 0                         await InitializeWorkflowAsync().WaitAsync(workflowCts.Token).ConfigureAwait(false);
526  ❌ 0     
527  ❌ 0                         // Finally start location tracking (already has internal timeouts)
528  ❌ 0                         await StartLocationTrackingAsync().ConfigureAwait(false);
529  ❌ 0                     }
530  ❌ 0                     catch (OperationCanceledException)
531  ❌ 0                     {
532  ❌ 0                         var logger = ServiceProvider?.GetService<ILogger<App>>();
533  ❌ 0                         logger?.LogWarning("Background initialization timed out - app will continue");
534  ❌ 0                     }
535  ❌ 0                     catch (Exception ex)
536  ❌ 0                     {
537  ❌ 0                         var logger = ServiceProvider?.GetService<ILogger<App>>();
538  ❌ 0                         logger?.LogError(ex, "Background initialization error");
539  ❌ 0                     }
540  ❌ 0                 });
541  ❌ 0             }
542           
543  ❌ 0             base.OnFrameworkInitializationCompleted();
544  ❌ 0         }
545           
546               private async Task StartLocationTrackingAsync()
547  ❌ 0         {
548                   try
549  ❌ 0             {
550  ❌ 0                 var trackingService = ServiceProvider.GetRequiredService<ILocationTrackingService>();
551           
552                       // Start tracking with default settings (50m threshold, 30s interval)
553  ❌ 0                 await trackingService.StartTrackingAsync();
554           
555  ❌ 0                 var logger = ServiceProvider.GetRequiredService<ILogger<App>>();
556  ❌ 0                 logger.LogInformation("Location tracking started successfully");
557           
558                       // Start activity tracking service
559  ❌ 0                 var activityTracking = ServiceProvider.GetRequiredService<ActivityTrackingService>();
560  ❌ 0                 activityTracking.StartMonitoring();
561           
562  ❌ 0                 logger.LogInformation("Activity tracking started successfully");
563           
564                       // Start movement state logger for demonstration
565  ❌ 0                 var stateLogger = ServiceProvider.GetRequiredService<MovementStateLogger>();
566  ❌ 0                 stateLogger.StartLogging();
567           
568  ❌ 0                 logger.LogInformation("Movement state logging started successfully");
569  ❌ 0             }
570  ❌ 0             catch (Exception ex)
571  ❌ 0             {
572                       // Don't fail app startup if location tracking fails
573  ❌ 0  ○              var logger = ServiceProvider?.GetService<ILogger<App>>();
574  ❌ 0  ○              logger?.LogError(ex, "Failed to start location tracking");
575  ❌ 0             }
576  ❌ 0         }
577           
578               private async Task InitializeWorkflowAsync()
579  ❌ 0  ○      {
580                   // Always start chat to ensure initial messages are shown even if workflow file is missing
581  ❌ 0             var chatService = ServiceProvider.GetRequiredService<ChatService>();
582  ❌ 0             await chatService.StartAsync();
583           
584  ❌ 0             string? pumlContent = null;
585           
586                   try
587  ❌ 0             {
588                       // Try to load workflow.puml from platform-specific location
589  ❌ 0                 pumlContent = await LoadWorkflowFileAsync();
590           
591  ❌ 0  ○              if (string.IsNullOrEmpty(pumlContent))
592  ❌ 0                 {
593                           // Fallback workflow if file cannot be loaded
594  ❌ 0                     throw new InvalidOperationException("Cannot locate workflow definition file.");
595                       }
596           
597                       // Import the workflow
598  ❌ 0                 var workflowService = ServiceProvider.GetRequiredService<IWorkflowService>();
599  ❌ 0                 var workflow = await workflowService.ImportWorkflowAsync(
600  ❌ 0                     pumlContent,
601  ❌ 0                     "fun-was-had-main",
602  ❌ 0                     "Fun Was Had");
603           
604                       // Render the first activity node from the workflow
605  ❌ 0                 await chatService.RenderWorkflowStateAsync(workflow.Id);
606  ❌ 0             }
607  ❌ 0             catch (Exception)
608  ❌ 0             {
609                       // Silently fail - workflow initialization is optional
610  ❌ 0             }
611  ❌ 0         }
612           
613               /// <summary>
614               /// Loads workflow.puml file from platform-specific location
615               /// </summary>
616               private async Task<string?> LoadWorkflowFileAsync()
617  ❌ 0         {
618                   // For Android, try loading from assets first
619  ❌ 0  ○          if (OperatingSystem.IsAndroid())
620  ❌ 0             {
621                       try
622  ❌ 0                 {
623                           // On Android, assets are accessed via reflection to avoid compile-time dependency
624  ❌ 0                     var contextType = Type.GetType("Android.App.Application, Mono.Android");
625  ❌ 0  ○                  var contextProperty = contextType?.GetProperty("Context");
626  ❌ 0  ○                  var context = contextProperty?.GetValue(null);
627           
628  ❌ 0  ○                  var assetsProperty = context?.GetType().GetProperty("Assets");
629  ❌ 0  ○                  var assets = assetsProperty?.GetValue(context);
630           
631  ❌ 0  ○                  var openMethod = assets?.GetType().GetMethod("Open", new[] { typeof(string) });
632  ❌ 0  ○                  var stream = openMethod?.Invoke(assets, new object[] { "workflow.puml" }) as Stream;
633           
634  ❌ 0  ○                  if (stream != null)
635  ❌ 0                     {
636  ❌ 0                         using (stream)
637  ❌ 0                         using (var reader = new StreamReader(stream))
638  ❌ 0                         {
639  ❌ 0                             return await reader.ReadToEndAsync();
640                               }
641                           }
642  ❌ 0                 }
643  ❌ 0                 catch (Exception ex)
644  ❌ 0                 {
645  ❌ 0  ○                  var logger = ServiceProvider?.GetService<ILogger<App>>();
646  ❌ 0  ○                  logger?.LogWarning(ex, "Failed to load workflow.puml from Android assets");
647  ❌ 0                 }
648  ❌ 0             }
649           
650                   // For other platforms (Desktop, iOS, Browser), try file system
651                   try
652  ❌ 0             {
653  ❌ 0                 var currentDir = Directory.GetCurrentDirectory();
654  ❌ 0                 var pumlPath = Path.Combine(currentDir, "workflow.puml");
655           
656  ❌ 0  ○              if (!File.Exists(pumlPath))
657  ❌ 0                 {
658                           // Try alternative path (for development/deployment scenarios)
659  ❌ 0                     var baseDir = AppDomain.CurrentDomain.BaseDirectory;
660  ❌ 0                     pumlPath = Path.Combine(baseDir, "workflow.puml");
661  ❌ 0                 }
662           
663  ❌ 0  ○              if (File.Exists(pumlPath))
664  ❌ 0                 {
665  ❌ 0                     return await File.ReadAllTextAsync(pumlPath);
666                       }
667  ❌ 0             }
668  ❌ 0             catch (Exception ex)
669  ❌ 0             {
670  ❌ 0  ○              var logger = ServiceProvider?.GetService<ILogger<App>>();
671  ❌ 0  ○              logger?.LogWarning(ex, "Failed to load workflow.puml from file system");
672  ❌ 0             }
673           
674  ❌ 0             return null;
675  ❌ 0         }
676           
677               private void DisableAvaloniaDataAnnotationValidation()
678  ❌ 0         {
679                   // Get an array of plugins to remove
680  ❌ 0             var dataValidationPluginsToRemove =
681  ❌ 0                 BindingPlugins.DataValidators.OfType<DataAnnotationsValidationPlugin>().ToArray();
682           
683                   // remove each entry found
684  ❌ 0  ○          foreach (var plugin in dataValidationPluginsToRemove)
685  ❌ 0             {
686  ❌ 0                 BindingPlugins.DataValidators.Remove(plugin);
687  ❌ 0             }
688  ❌ 0         }
689           }
```
# FWH.Mobile.ChatInputControl

## Summary

|||
|:---|:---|
| Class: | FWH.Mobile.ChatInputControl |
| Assembly: | FWH.Mobile |
| **File(s):** | E:\github\FunWasHad\src\FWH.Mobile\FWH.Mobile\Views\ChatInputControl.axaml<br />E:\github\FunWasHad\src\FWH.Mobile\FWH.Mobile\Views\ChatInputControl.axaml.cs |
| **Line coverage:** | 0% (0 of 139) |
| Covered lines: | 0 |
| Uncovered lines: | 139 |
| Coverable lines: | 139 |
| Total lines: | 249 |
| **Branch coverage:** | 0% (0 of 54) |
| Covered branches: | 0 |
| Total branches: | 54 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **!XamlIlPopulate(...)** | 0% | 20 | 4 | 0% |
| **.ctor()** | 100% | 2 | 1 | 0% |
| **OnCameraRequested()** | 0% | 1806 | 42 | 0% |
| **Build_4(...)** | 100% | 2 | 1 | 0% |
| **ShowCameraError(...)** | 0% | 6 | 2 | 0% |
| **OnImageCaptured(...)** | 0% | 42 | 6 | 0% |

## File(s)

### E:\github\FunWasHad\src\FWH.Mobile\FWH.Mobile\Views\ChatInputControl.axaml
```
  1  ❌ 0  ○  <UserControl xmlns="https://github.com/avaloniaui"
  2                        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
  3                        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
  4                        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
  5                        xmlns:local="clr-namespace:FWH.Common.Chat.ViewModels;assembly=FWH.Common.Chat"
  6                        xmlns:conv="clr-namespace:FWH.Mobile.ViewModels;assembly=FWH.Mobile"
  7                        xmlns:controls="clr-namespace:FWH.Mobile.Views;assembly=FWH.Mobile"
  8                        mc:Ignorable="d" d:DesignWidth="800" d:DesignHeight="450"
  9                        x:Class="FWH.Mobile.ChatInputControl"
 10                        x:DataType="local:ChatInputViewModel">
 11               <UserControl.Resources>
 12  ❌ 0             <conv:ChatInputModeToTextVisibility x:Key="TextVisibility"/>
 13  ❌ 0             <conv:ChatInputModeToChoiceVisibility x:Key="ChoiceVisibility"/>
 14  ❌ 0             <conv:ChatInputModeToPhotoVisibility x:Key="PhotoVisibility"/>
 15               </UserControl.Resources>
 16               <Design.DataContext>
 17                   <!-- Design-time removed to avoid needing parameterless ctor -->
 18                   <x:Null />
 19               </Design.DataContext>
 20  ❌ 0         <Panel Margin="0">
 21                   <!-- Text Input Mode -->
 22  ❌ 0             <Grid IsVisible="{Binding InputMode, Mode=OneWay, Converter={StaticResource TextVisibility}}"
 23                         HorizontalAlignment="Stretch"
 24  ❌ 0                   VerticalAlignment="Stretch"
 25  ❌ 0                   ColumnDefinitions="*,Auto"
 26                         ColumnSpacing="8"
 27  ❌ 0                   Margin="8">
 28  ❌ 0                 <TextBox Grid.Column="0"
 29                                AcceptsReturn="True"
 30  ❌ 0                          TextWrapping="Wrap"
 31  ❌ 0                          Text="{Binding Text, Mode=TwoWay}"
 32                                HorizontalAlignment="Stretch"
 33  ❌ 0                          VerticalAlignment="Stretch"/>
 34  ❌ 0                 <Button Grid.Column="1"
 35  ❌ 0                         Command="{Binding SendCommand}"
 36  ❌ 0                         ToolTip.Tip="Send">
 37  ❌ 0                     <TextBlock Text="➤" FontSize="18" />
 38                       </Button>
 39                   </Grid>
 40           
 41                   <!-- Image/Camera Mode -->
 42  ❌ 0             <Grid IsVisible="{Binding InputMode, Converter={StaticResource PhotoVisibility}}"
 43                         HorizontalAlignment="Stretch"
 44  ❌ 0                   VerticalAlignment="Stretch"
 45  ❌ 0                   RowDefinitions="*,Auto"
 46                         RowSpacing="8"
 47  ❌ 0                   Margin="8">
 48  ❌ 0                 <Border Grid.Row="0"
 49                               Background="#F5F5F5"
 50  ❌ 0                         BorderBrush="#E0E0E0"
 51                               BorderThickness="1"
 52  ❌ 0                         CornerRadius="8"
 53                               Padding="16">
 54  ❌ 0                     <StackPanel HorizontalAlignment="Center"
 55                                       VerticalAlignment="Center"
 56  ❌ 0                                 Spacing="12">
 57  ❌ 0                         <TextBlock Text="📷"
 58                                          FontSize="48"
 59  ❌ 0                                    HorizontalAlignment="Center" />
 60  ❌ 0                         <TextBlock Text="Take a photo"
 61                                          FontSize="16"
 62  ❌ 0                                    Foreground="#757575"
 63                                          HorizontalAlignment="Center" />
 64                           </StackPanel>
 65                       </Border>
 66  ❌ 0                 <Button Grid.Row="1"
 67  ❌ 0                         Command="{Binding OpenCameraCommand}"
 68                               HorizontalAlignment="Center"
 69  ❌ 0                         Padding="24,12"
 70                               MinWidth="60"
 71  ❌ 0                         MinHeight="60"
 72  ❌ 0                         ToolTip.Tip="Open Camera">
 73  ❌ 0                     <TextBlock Text="📷" FontSize="24" />
 74                       </Button>
 75                   </Grid>
 76           
 77                   <!-- Choice Mode -->
 78  ❌ 0             <Grid IsVisible="{Binding InputMode, Converter={StaticResource ChoiceVisibility}}"
 79                         HorizontalAlignment="Stretch"
 80  ❌ 0                   VerticalAlignment="Stretch"
 81  ❌ 0                   RowDefinitions="Auto,*"
 82                         RowSpacing="8"
 83  ❌ 0                   Margin="8">
 84  ❌ 0                 <TextBlock Grid.Row="0"
 85  ❌ 0                            Text="{Binding Choices.Prompt}"
 86                                  TextWrapping="Wrap"
 87  ❌ 0                            TextAlignment="Right"/>
 88  ❌ 0                 <ItemsControl Grid.Row="1"
 89  ❌ 0                               ItemsSource="{Binding Choices.Choices}"
 90                                     HorizontalAlignment="Right">
 91                           <ItemsControl.ItemTemplate>
 92  ❌ 0                         <DataTemplate DataType="local:ChoicesItem">
 93  ❌ 0                             <Button Content="{Binding ChoiceText}"
 94  ❌ 0                                     Command="{Binding SelectChoiceCommand}"
 95  ❌ 0                                     CommandParameter="{Binding}"
 96                                           Margin="0,4"/>
 97                               </DataTemplate>
 98                           </ItemsControl.ItemTemplate>
 99                       </ItemsControl>
100                   </Grid>
101               </Panel>
102           </UserControl>
```
### E:\github\FunWasHad\src\FWH.Mobile\FWH.Mobile\Views\ChatInputControl.axaml.cs
```
  1           using Avalonia;
  2           using Avalonia.Controls;
  3           using Avalonia.Markup.Xaml;
  4           using FWH.Mobile.ViewModels;
  5           using Microsoft.Extensions.DependencyInjection;
  6           using FWH.Common.Chat.ViewModels;
  7           using FWH.Common.Chat;
  8           using FWH.Common.Chat.Services;
  9           using FWH.Mobile.Services;
 10           using Microsoft.Extensions.Logging;
 11           using System;
 12           using System.Diagnostics;
 13           using System.Threading.Tasks;
 14           
 15           namespace FWH.Mobile;
 16           
 17           public partial class ChatInputControl : UserControl
 18           {
 19               private readonly ChatService? _chatService;
 20               private readonly INotificationService? _notificationService;
 21           
 22  ❌ 0         public ChatInputControl()
 23  ❌ 0         {
 24  ❌ 0             InitializeComponent();
 25           
 26  ❌ 0             System.Diagnostics.Debug.WriteLine("ChatInputControl: Constructor called");
 27  ❌ 0             var chatInput = App.ServiceProvider.GetRequiredService<FWH.Common.Chat.ViewModels.ChatInputViewModel>();
 28  ❌ 0             _chatService = App.ServiceProvider.GetService<ChatService>();
 29  ❌ 0             _notificationService = App.ServiceProvider.GetService<INotificationService>();
 30           
 31  ❌ 0             DataContext = chatInput;
 32           
 33                   // Wire up camera event handler
 34  ❌ 0             System.Diagnostics.Debug.WriteLine("ChatInputControl: Wiring up CameraRequested event handler");
 35  ❌ 0             chatInput.CameraRequested += OnCameraRequested;
 36  ❌ 0             chatInput.ImageCaptured += OnImageCaptured;
 37  ❌ 0             System.Diagnostics.Debug.WriteLine("ChatInputControl: Event handlers wired up successfully");
 38  ❌ 0         }
 39           
 40               private async void OnCameraRequested(object? sender, EventArgs e)
 41  ❌ 0         {
 42                   try
 43  ❌ 0             {
 44  ❌ 0                 Debug.WriteLine("ChatInputControl: OnCameraRequested called");
 45  ❌ 0  ○              var logger = App.ServiceProvider?.GetService<ILogger<ChatInputControl>>();
 46  ❌ 0  ○              logger?.LogInformation("Camera requested from ChatInputControl");
 47  ❌ 0                 Debug.WriteLine("ChatInputControl: Camera requested from ChatInputControl");
 48           
 49                       // Get the camera service and capture a photo
 50  ❌ 0  ○              var cameraService = App.ServiceProvider?.GetService<FWH.Common.Chat.Services.ICameraService>();
 51  ❌ 0  ○              if (cameraService == null)
 52  ❌ 0                 {
 53  ❌ 0                     Debug.WriteLine("ChatInputControl: ERROR - Camera service is null - not registered in DI");
 54  ❌ 0  ○                  logger?.LogError("Camera service is null - not registered in DI");
 55  ❌ 0                     ShowCameraError("Camera service not available");
 56  ❌ 0                     return;
 57                       }
 58           
 59  ❌ 0                 Debug.WriteLine($"ChatInputControl: Camera service retrieved, type: {cameraService.GetType().Name}");
 60  ❌ 0  ○              logger?.LogDebug("Camera service retrieved, type: {Type}", cameraService.GetType().Name);
 61  ❌ 0  ○              logger?.LogInformation("Calling TakePhotoAsync...");
 62  ❌ 0                 Debug.WriteLine("ChatInputControl: Calling TakePhotoAsync...");
 63           
 64  ❌ 0                 var imageBytes = await cameraService.TakePhotoAsync();
 65           
 66  ❌ 0  ○              Debug.WriteLine($"ChatInputControl: TakePhotoAsync completed. ImageBytes length: {imageBytes?.Length ?? 0}")
 67  ❌ 0  ○              logger?.LogInformation("TakePhotoAsync completed. ImageBytes length: {Length}", imageBytes?.Length ?? 0);
 68           
 69  ❌ 0  ○              if (imageBytes != null && imageBytes.Length > 0)
 70  ❌ 0                 {
 71                           // Store image via ImageService if available
 72  ❌ 0  ○                  var imageService = App.ServiceProvider?.GetService<IImageService>();
 73  ❌ 0  ○                  if (imageService != null)
 74  ❌ 0                     {
 75                               try
 76  ❌ 0                         {
 77  ❌ 0                             await imageService.StoreImageAsync(
 78  ❌ 0                                 imageBytes,
 79  ❌ 0                                 "user_upload",
 80  ❌ 0                                 null,
 81  ❌ 0                                 "User",
 82  ❌ 0                                 null,
 83  ❌ 0                                 "image/jpeg",
 84  ❌ 0                                 $"chat_{DateTimeOffset.UtcNow:yyyyMMdd_HHmmss}.jpg");
 85  ❌ 0  ○                          logger?.LogDebug("Stored chat image via ImageService");
 86  ❌ 0                         }
 87  ❌ 0                         catch (Exception storeEx)
 88  ❌ 0                         {
 89  ❌ 0  ○                          logger?.LogWarning(storeEx, "Failed to store chat image via ImageService");
 90  ❌ 0                         }
 91  ❌ 0                     }
 92           
 93                           // Update the ImagePayload with the captured image
 94  ❌ 0                     var chatInput = DataContext as ChatInputViewModel;
 95  ❌ 0  ○                  if (chatInput?.CurrentImage != null)
 96  ❌ 0                     {
 97  ❌ 0                         chatInput.CurrentImage.Image = imageBytes;
 98           
 99                               // Raise event to notify that image was captured
100  ❌ 0                         chatInput.RaiseImageCaptured(imageBytes);
101  ❌ 0                     }
102  ❌ 0                 }
103                       else
104  ❌ 0                 {
105                           // Camera could not capture image - show notification
106  ❌ 0  ○                  logger?.LogWarning("Camera returned null or empty image bytes");
107  ❌ 0                     ShowCameraError("Camera could not be opened. Please try again or check camera permissions.");
108  ❌ 0                 }
109  ❌ 0             }
110  ❌ 0             catch (Exception ex)
111  ❌ 0             {
112  ❌ 0  ○              var logger = App.ServiceProvider?.GetService<ILogger<ChatInputControl>>();
113  ❌ 0  ○              logger?.LogError(ex, "Error capturing photo");
114  ❌ 0                 ShowCameraError($"Camera error: {ex.Message}");
115  ❌ 0             }
116  ❌ 0         }
117           
118               private void ShowCameraError(string message)
119  ❌ 0         {
120                   // Use notification service to show error
121                   // This will display in chat UI with emoji prefix and log to debug output
122  ❌ 0  ○          _notificationService?.ShowError(message, "Camera Error");
123  ❌ 0         }
124           
125               private void OnImageCaptured(object? sender, byte[] imageBytes)
126  ❌ 0         {
127                   try
128  ❌ 0             {
129                       // Image was captured, advance the workflow
130                       // For camera nodes, we treat them as non-choice nodes that auto-advance
131  ❌ 0                 var chatInput = DataContext as ChatInputViewModel;
132  ❌ 0  ○              if (chatInput != null)
133  ❌ 0                 {
134                           // Clear the input mode back to text
135  ❌ 0                     chatInput.ClearInput();
136  ❌ 0                 }
137           
138                       // The ChatService should handle advancing the workflow
139                       // This is handled by the OnImageCaptured in ChatService
140  ❌ 0             }
141  ❌ 0             catch (Exception ex)
142  ❌ 0             {
143  ❌ 0  ○              var logger = App.ServiceProvider?.GetService<ILogger<ChatInputControl>>();
144  ❌ 0  ○              logger?.LogError(ex, "Error after image capture");
145  ❌ 0             }
146  ❌ 0         }
147           }
```
# FWH.Mobile.ChatListControl

## Summary

|||
|:---|:---|
| Class: | FWH.Mobile.ChatListControl |
| Assembly: | FWH.Mobile |
| **File(s):** | E:\github\FunWasHad\src\FWH.Mobile\FWH.Mobile\Views\ChatListControl.axaml<br />E:\github\FunWasHad\src\FWH.Mobile\FWH.Mobile\Views\ChatListControl.axaml.cs |
| **Line coverage:** | 0% (0 of 54) |
| Covered lines: | 0 |
| Uncovered lines: | 54 |
| Coverable lines: | 54 |
| Total lines: | 141 |
| **Branch coverage:** | 0% (0 of 4) |
| Covered branches: | 0 |
| Total branches: | 4 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **!XamlIlPopulate(...)** | 0% | 20 | 4 | 0% |
| **.ctor()** | 100% | 2 | 1 | 0% |
| **Build_5(...)** | 100% | 2 | 1 | 0% |
| **Build_6(...)** | 100% | 2 | 1 | 0% |
| **Build_7(...)** | 100% | 2 | 1 | 0% |
| **Build_8(...)** | 100% | 2 | 1 | 0% |

## File(s)

### E:\github\FunWasHad\src\FWH.Mobile\FWH.Mobile\Views\ChatListControl.axaml
```
  1  ❌ 0  ○  <UserControl xmlns="https://github.com/avaloniaui"
  2                        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
  3                        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
  4                        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
  5                        xmlns:local="clr-namespace:FWH.Common.Chat.ViewModels;assembly=FWH.Common.Chat"
  6                        xmlns:conv="clr-namespace:FWH.Mobile.ViewModels;assembly=FWH.Mobile"
  7                        mc:Ignorable="d"
  8                        d:DesignWidth="800" d:DesignHeight="600"
  9                        x:Class="FWH.Mobile.ChatListControl"
 10                        x:DataType="local:ChatListViewModel">
 11           
 12               <!-- Optional: Resources for converters (recommended for alignment & colors) -->
 13               <UserControl.Resources>
 14  ❌ 0             <conv:AuthorToAlignmentConverter x:Key="AuthorToAlignment"/>
 15  ❌ 0             <conv:AuthorToBrushConverter x:Key="AuthorToBackground"/>
 16  ❌ 0             <conv:ByteArrayToImageConverter x:Key="ByteArrayToImage"/>
 17               </UserControl.Resources>
 18           
 19               <Design.DataContext>
 20                   <!-- Design-time removed to avoid needing parameterless ctor -->
 21                   <x:Null />
 22               </Design.DataContext>
 23           
 24               <!-- Use ListBox instead of ItemsControl+ScrollViewer for better mobile support -->
 25  ❌ 0         <ListBox ItemsSource="{Binding Entries}"
 26                        Background="Transparent"
 27  ❌ 0                  SelectionMode="Single"
 28                        Margin="8">
 29           
 30                   <ListBox.ItemsPanel>
 31  ❌ 0                 <ItemsPanelTemplate>
 32  ❌ 0                     <StackPanel Spacing="12"/>
 33                       </ItemsPanelTemplate>
 34                   </ListBox.ItemsPanel>
 35           
 36                   <ListBox.Styles>
 37  ❌ 0                 <Style Selector="ListBoxItem">
 38  ❌ 0                     <Setter Property="Padding" Value="0"/>
 39  ❌ 0                     <Setter Property="Margin" Value="0"/>
 40  ❌ 0                     <Setter Property="Background" Value="Transparent"/>
 41  ❌ 0                     <Setter Property="Template">
 42  ❌ 0                         <ControlTemplate>
 43  ❌ 0                             <ContentPresenter Content="{TemplateBinding Content}"
 44  ❌ 0                                             ContentTemplate="{TemplateBinding ContentTemplate}"/>
 45                               </ControlTemplate>
 46                           </Setter>
 47                       </Style>
 48                   </ListBox.Styles>
 49           
 50                   <ListBox.DataTemplates>
 51           
 52                       <!-- Text Message -->
 53  ❌ 0                 <DataTemplate DataType="{x:Type local:TextChatEntry}">
 54  ❌ 0                     <Border Background="{Binding Author, Converter={StaticResource AuthorToBackground}}"
 55                                   CornerRadius="15"
 56  ❌ 0                             Padding="12"
 57  ❌ 0                             HorizontalAlignment="{Binding Author, Converter={StaticResource AuthorToAlignment}}"
 58                                   BoxShadow="0 2 8 0 #44000000"
 59  ❌ 0                             Margin="4">
 60  ❌ 0                         <TextBlock Text="{Binding Text}"
 61                                          TextWrapping="Wrap"
 62  ❌ 0                                    Foreground="White"
 63                                          FontSize="15"/>
 64                           </Border>
 65                       </DataTemplate>
 66           
 67                       <!-- Image Message -->
 68  ❌ 0                 <DataTemplate DataType="{x:Type local:ImageChatEntry}">
 69  ❌ 0                     <Border Background="{Binding Author, Converter={StaticResource AuthorToBackground}}"
 70                                   CornerRadius="15"
 71  ❌ 0                             Padding="4"
 72                                   MaxWidth="400"
 73  ❌ 0                             HorizontalAlignment="{Binding Author, Converter={StaticResource AuthorToAlignment}}"
 74                                   BoxShadow="0 2 8 0 #44000000"
 75  ❌ 0                             Margin="4">
 76  ❌ 0                         <StackPanel Spacing="4">
 77  ❌ 0                             <TextBlock Text="Captured Image Preview"
 78                                              FontWeight="Bold"
 79  ❌ 0                                        FontSize="14"
 80                                              Foreground="White"
 81  ❌ 0                                        IsVisible="{Binding Image, Converter={x:Static ObjectConverters.IsNotNull}}"/>
 82  ❌ 0                             <Image Source="{Binding Image, Converter={StaticResource ByteArrayToImage}}"
 83                                          Stretch="Uniform"
 84  ❌ 0                                    MaxHeight="300"
 85  ❌ 0                                    IsVisible="{Binding Image, Converter={x:Static ObjectConverters.IsNotNull}}"/>
 86  ❌ 0                             <TextBlock Text="📷 Waiting for photo..."
 87                                              FontSize="14"
 88  ❌ 0                                        Foreground="White"
 89                                              HorizontalAlignment="Center"
 90  ❌ 0                                        IsVisible="{Binding Image, Converter={x:Static ObjectConverters.IsNull}}"/>
 91                               </StackPanel>
 92                           </Border>
 93                       </DataTemplate>
 94           
 95                       <!-- Choice Message (Bot asks, User selects) -->
 96  ❌ 0                 <DataTemplate DataType="{x:Type local:ChoiceChatEntry}">
 97  ❌ 0                     <StackPanel MaxWidth="500"
 98                                       Spacing="8"
 99  ❌ 0                                 Margin="4">
100           
101                               <!-- Optional prompt/title -->
102  ❌ 0                         <TextBlock Text="{Binding Prompt}"
103                                          FontWeight="SemiBold"
104  ❌ 0                                    Foreground="#FF333333"
105                                          TextWrapping="Wrap"
106  ❌ 0                                    IsVisible="{Binding Prompt, Converter={x:Static StringConverters.IsNotNullOrEmpty}}"/>
107           
108                               <!-- Show selected choice after user picks -->
109  ❌ 0                         <Border Background="{Binding Author, Converter={StaticResource AuthorToBackground}}"
110                                       CornerRadius="15"
111  ❌ 0                                 Padding="12"
112  ❌ 0                                 IsVisible="{Binding SelectedChoice, Converter={x:Static ObjectConverters.IsNotNull}}"
113                                       BoxShadow="0 2 8 0 #44000000">
114  ❌ 0                             <TextBlock Text="{Binding SelectedChoice.ChoiceText}"
115                                              Foreground="White"
116  ❌ 0                                        FontWeight="Medium"/>
117                               </Border>
118           
119                           </StackPanel>
120                       </DataTemplate>
121           
122                   </ListBox.DataTemplates>
123               </ListBox>
124           </UserControl>
```
### E:\github\FunWasHad\src\FWH.Mobile\FWH.Mobile\Views\ChatListControl.axaml.cs
```
 1           using Avalonia;
 2           using Avalonia.Controls;
 3           using Avalonia.Markup.Xaml;
 4           using FWH.Mobile.ViewModels;
 5           using Microsoft.Extensions.DependencyInjection;
 6           using FWH.Common.Chat.ViewModels;
 7           
 8           namespace FWH.Mobile;
 9           
10           public partial class ChatListControl : UserControl
11           {
12  ❌ 0         public ChatListControl()
13  ❌ 0         {
14  ❌ 0             InitializeComponent();
15  ❌ 0             DataContext = App.ServiceProvider.GetRequiredService<FWH.Common.Chat.ViewModels.ChatListViewModel>();
16  ❌ 0         }
17           }
```
# FWH.Mobile.Configuration.ApiSettings

## Summary

|||
|:---|:---|
| Class: | FWH.Mobile.Configuration.ApiSettings |
| Assembly: | FWH.Mobile |
| **File(s):** | E:\github\FunWasHad\src\FWH.Mobile\FWH.Mobile\Configuration\ApiSettings.cs |
| **Line coverage:** | 0% (0 of 20) |
| Covered lines: | 0 |
| Uncovered lines: | 20 |
| Coverable lines: | 20 |
| Total lines: | 72 |
| **Branch coverage:** | 0% (0 of 12) |
| Covered branches: | 0 |
| Total branches: | 12 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **get_HostIpAddress()** | 100% | 2 | 1 | 0% |
| **get_LocationApiPort()** | 100% | 2 | 1 | 0% |
| **get_MarketingApiPort()** | 100% | 2 | 1 | 0% |
| **get_UseHttps()** | 100% | 2 | 1 | 0% |
| **get_LocationApiBaseUrl()** | 100% | 2 | 1 | 0% |
| **get_MarketingApiBaseUrl()** | 100% | 2 | 1 | 0% |
| **GetLocationApiBaseUrl()** | 0% | 42 | 6 | 0% |
| **GetMarketingApiBaseUrl()** | 0% | 42 | 6 | 0% |

## File(s)

### E:\github\FunWasHad\src\FWH.Mobile\FWH.Mobile\Configuration\ApiSettings.cs
```
 1           namespace FWH.Mobile.Configuration;
 2           
 3           /// <summary>
 4           /// API settings loaded from appsettings.json
 5           /// </summary>
 6           public sealed class ApiSettings
 7           {
 8               /// <summary>
 9               /// The IP address of the host machine running the APIs.
10               /// Defaults to 10.0.2.2 (Android emulator alias for localhost)
11               /// </summary>
12  ❌ 0         public string HostIpAddress { get; set; } = "10.0.2.2";
13           
14               /// <summary>
15               /// Port for the Location API
16               /// </summary>
17  ❌ 0         public int LocationApiPort { get; set; } = 4748;
18           
19               /// <summary>
20               /// Port for the Marketing API
21               /// </summary>
22  ❌ 0         public int MarketingApiPort { get; set; } = 4749;
23           
24               /// <summary>
25               /// Whether to use HTTPS for API connections
26               /// </summary>
27  ❌ 0         public bool UseHttps { get; set; } = false;
28           
29               /// <summary>
30               /// Full base URL for the Location API (overrides HostIpAddress/Port if set).
31               /// Used for staging/production environments with full URLs (e.g., Railway).
32               /// </summary>
33  ❌ 0         public string? LocationApiBaseUrl { get; set; }
34           
35               /// <summary>
36               /// Full base URL for the Marketing API (overrides HostIpAddress/Port if set).
37               /// Used for staging/production environments with full URLs (e.g., Railway).
38               /// </summary>
39  ❌ 0         public string? MarketingApiBaseUrl { get; set; }
40           
41               /// <summary>
42               /// Gets the base URL for the Location API
43               /// </summary>
44               public string GetLocationApiBaseUrl()
45  ❌ 0         {
46                   // If full URL is provided (e.g., for staging), use it directly
47  ❌ 0  ○          if (!string.IsNullOrWhiteSpace(LocationApiBaseUrl))
48  ❌ 0             {
49  ❌ 0  ○              return LocationApiBaseUrl.EndsWith('/') ? LocationApiBaseUrl : LocationApiBaseUrl + "/";
50                   }
51           
52                   // Otherwise, construct from HostIpAddress and Port
53  ❌ 0  ○          var protocol = UseHttps ? "https" : "http";
54  ❌ 0             return $"{protocol}://{HostIpAddress}:{LocationApiPort}/";
55  ❌ 0         }
56           
57               /// <summary>
58               /// Gets the base URL for the Marketing API
59               /// </summary>
60               public string GetMarketingApiBaseUrl()
61  ❌ 0         {
62                   // If full URL is provided (e.g., for staging), use it directly
63  ❌ 0  ○          if (!string.IsNullOrWhiteSpace(MarketingApiBaseUrl))
64  ❌ 0             {
65  ❌ 0  ○              return MarketingApiBaseUrl.EndsWith('/') ? MarketingApiBaseUrl : MarketingApiBaseUrl + "/";
66                   }
67           
68                   // Otherwise, construct from HostIpAddress and Port
69  ❌ 0  ○          var protocol = UseHttps ? "https" : "http";
70  ❌ 0             return $"{protocol}://{HostIpAddress}:{MarketingApiPort}/";
71  ❌ 0         }
72           }
```
# FWH.Mobile.Configuration.LocationSettings

## Summary

|||
|:---|:---|
| Class: | FWH.Mobile.Configuration.LocationSettings |
| Assembly: | FWH.Mobile |
| **File(s):** | E:\github\FunWasHad\src\FWH.Mobile\FWH.Mobile\Configuration\LocationSettings.cs |
| **Line coverage:** | 64.2% (9 of 14) |
| Covered lines: | 9 |
| Uncovered lines: | 5 |
| Coverable lines: | 14 |
| Total lines: | 52 |
| **Branch coverage:** | 18.7% (3 of 16) |
| Covered branches: | 3 |
| Total branches: | 16 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **get_SpeedUnit()** | 100% | 1 | 1 | 100% |
| **get_PollingIntervalMode()** | 100% | 1 | 1 | 100% |
| **get_UseMph()** | 0% | 6 | 2 | 0% |
| **get_UseKmh()** | 0% | 42 | 6 | 0% |
| **GetPollingInterval()** | 37.50% | 10 | 8 | 66.66% |
| **get_IsTrackingEnabled()** | 100% | 1 | 1 | 100% |

## File(s)

### E:\github\FunWasHad\src\FWH.Mobile\FWH.Mobile\Configuration\LocationSettings.cs
```
 1            using System;
 2            
 3            namespace FWH.Mobile.Configuration;
 4            
 5            /// <summary>
 6            /// Location tracking settings loaded from appsettings.json
 7            /// </summary>
 8            public sealed class LocationSettings
 9            {
10                /// <summary>
11                /// Speed unit preference for display.
12                /// Valid values: "mph" (miles per hour) or "kmh" (kilometers per hour).
13                /// Default: "mph"
14                /// </summary>
15  ✔  14         public string SpeedUnit { get; set; } = "mph";
16            
17                /// <summary>
18                /// Polling interval mode for location tracking.
19                /// Valid values: "fast" (0.5 seconds), "normal" (1.0 seconds), "off" (0.0 seconds - tracking disabled).
20                /// Default: "normal"
21                /// </summary>
22  ✔  70         public string PollingIntervalMode { get; set; } = "normal";
23            
24                /// <summary>
25                /// Gets whether speed should be displayed in miles per hour.
26                /// </summary>
27  ❌  0  ○      public bool UseMph => SpeedUnit?.ToLowerInvariant() == "mph";
28            
29                /// <summary>
30                /// Gets whether speed should be displayed in kilometers per hour.
31                /// </summary>
32  ❌  0  ○      public bool UseKmh => SpeedUnit?.ToLowerInvariant() == "kmh" || SpeedUnit?.ToLowerInvariant() == "km/h";
33            
34                /// <summary>
35                /// Gets the polling interval as a TimeSpan based on the configured mode.
36                /// </summary>
37                public TimeSpan GetPollingInterval()
38  ✔  42         {
39  ✓  42  ◔          return PollingIntervalMode?.ToLowerInvariant() switch
40  ✔  42             {
41  ❌  0                 "fast" => TimeSpan.FromSeconds(0.5),
42  ✔  42                 "normal" => TimeSpan.FromSeconds(1.0),
43  ❌  0                 "off" => TimeSpan.Zero,
44  ❌  0                 _ => TimeSpan.FromSeconds(1.0) // Default to normal
45  ✔  42             };
46  ✔  42         }
47            
48                /// <summary>
49                /// Gets whether location tracking is enabled (polling interval is not zero).
50                /// </summary>
51  ✔  27         public bool IsTrackingEnabled => GetPollingInterval() > TimeSpan.Zero;
52            }
```
# FWH.Mobile.Logging.AvaloniaLogEntry

## Summary

|||
|:---|:---|
| Class: | FWH.Mobile.Logging.AvaloniaLogEntry |
| Assembly: | FWH.Mobile |
| **File(s):** | E:\github\FunWasHad\src\FWH.Mobile\FWH.Mobile\Logging\AvaloniaLogEntry.cs |
| **Line coverage:** | 0% (0 of 38) |
| Covered lines: | 0 |
| Uncovered lines: | 38 |
| Coverable lines: | 38 |
| Total lines: | 49 |
| **Branch coverage:** | 0% (0 of 21) |
| Covered branches: | 0 |
| Total branches: | 21 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **.ctor(...)** | 100% | 2 | 1 | 0% |
| **get_Id()** | 100% | 2 | 1 | 0% |
| **get_TimestampUtc()** | 100% | 2 | 1 | 0% |
| **get_Level()** | 100% | 2 | 1 | 0% |
| **get_Category()** | 100% | 2 | 1 | 0% |
| **get_EventId()** | 100% | 2 | 1 | 0% |
| **get_Message()** | 100% | 2 | 1 | 0% |
| **get_Exception()** | 100% | 2 | 1 | 0% |
| **get_LevelShort()** | 0% | 56 | 7 | 0% |
| **get_LevelColor()** | 0% | 56 | 7 | 0% |
| **get_LevelBackgroundColor()** | 0% | 56 | 7 | 0% |

## File(s)

### E:\github\FunWasHad\src\FWH.Mobile\FWH.Mobile\Logging\AvaloniaLogEntry.cs
```
 1           using System;
 2           using Avalonia.Media;
 3           using Microsoft.Extensions.Logging;
 4           
 5           namespace FWH.Mobile.Logging;
 6           
 7  ❌ 0     public sealed record AvaloniaLogEntry(
 8  ❌ 0         long Id,
 9  ❌ 0         DateTimeOffset TimestampUtc,
10  ❌ 0         LogLevel Level,
11  ❌ 0         string Category,
12  ❌ 0         EventId EventId,
13  ❌ 0         string Message,
14  ❌ 0         Exception? Exception)
15           {
16  ❌ 0  ○      public string LevelShort => Level switch
17  ❌ 0         {
18  ❌ 0             LogLevel.Trace => "TRC",
19  ❌ 0             LogLevel.Debug => "DBG",
20  ❌ 0             LogLevel.Information => "INF",
21  ❌ 0             LogLevel.Warning => "WRN",
22  ❌ 0             LogLevel.Error => "ERR",
23  ❌ 0             LogLevel.Critical => "CRT",
24  ❌ 0             _ => Level.ToString()
25  ❌ 0         };
26           
27  ❌ 0  ○      public IBrush LevelColor => Level switch
28  ❌ 0         {
29  ❌ 0             LogLevel.Trace => Brushes.Gray,
30  ❌ 0             LogLevel.Debug => Brushes.Cyan,
31  ❌ 0             LogLevel.Information => Brushes.White,
32  ❌ 0             LogLevel.Warning => Brushes.Yellow,
33  ❌ 0             LogLevel.Error => Brushes.Red,
34  ❌ 0             LogLevel.Critical => Brushes.Magenta,
35  ❌ 0             _ => Brushes.White
36  ❌ 0         };
37           
38  ❌ 0  ○      public IBrush LevelBackgroundColor => Level switch
39  ❌ 0         {
40  ❌ 0             LogLevel.Trace => new SolidColorBrush(Color.FromRgb(40, 40, 40)),      // Dark gray
41  ❌ 0             LogLevel.Debug => new SolidColorBrush(Color.FromRgb(0, 60, 80)),       // Dark cyan/teal
42  ❌ 0             LogLevel.Information => new SolidColorBrush(Color.FromRgb(20, 40, 60)), // Dark blue-gray
43  ❌ 0             LogLevel.Warning => new SolidColorBrush(Color.FromRgb(100, 80, 0)),    // Dark yellow/orange
44  ❌ 0             LogLevel.Error => new SolidColorBrush(Color.FromRgb(80, 0, 0)),        // Dark red
45  ❌ 0             LogLevel.Critical => new SolidColorBrush(Color.FromRgb(80, 0, 60)),    // Dark magenta/purple
46  ❌ 0             _ => new SolidColorBrush(Color.FromRgb(30, 30, 30))                    // Default dark
47  ❌ 0         };
48           }
49           
```
# FWH.Mobile.Logging.AvaloniaLoggerProvider

## Summary

|||
|:---|:---|
| Class: | FWH.Mobile.Logging.AvaloniaLoggerProvider |
| Assembly: | FWH.Mobile |
| **File(s):** | E:\github\FunWasHad\src\FWH.Mobile\FWH.Mobile\Logging\AvaloniaLoggerProvider.cs |
| **Line coverage:** | 14.7% (13 of 88) |
| Covered lines: | 13 |
| Uncovered lines: | 75 |
| Coverable lines: | 88 |
| Total lines: | 157 |
| **Branch coverage:** | 2% (1 of 50) |
| Covered branches: | 1 |
| Total branches: | 50 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **.ctor(...)** | 50.0% | 2 | 2 | 100% |
| **CreateLogger(...)** | 100% | 1 | 1 | 100% |
| **SetScopeProvider(...)** | 100% | 2 | 1 | 0% |
| **Dispose()** | 100% | 1 | 1 | 100% |
| **.ctor(...)** | 100% | 1 | 1 | 100% |
| **BeginScope(...)** | 0% | 20 | 4 | 0% |
| **IsEnabled(...)** | 100% | 2 | 1 | 0% |
| **Log(...)** | 0% | 72 | 8 | 0% |
| **FormatScope(...)** | 0% | 600 | 24 | 0% |
| **FormatValue(...)** | 0% | 156 | 12 | 0% |
| **.cctor()** | 100% | 2 | 1 | 0% |
| **Dispose()** | 100% | 2 | 1 | 0% |

## File(s)

### E:\github\FunWasHad\src\FWH.Mobile\FWH.Mobile\Logging\AvaloniaLoggerProvider.cs
```
  1           using System;
  2           using System.Collections;
  3           using System.Collections.Concurrent;
  4           using System.Linq;
  5           using System.Text;
  6           using System.Threading;
  7           using Microsoft.Extensions.Logging;
  8           
  9           namespace FWH.Mobile.Logging;
 10           
 11           public sealed class AvaloniaLoggerProvider : ILoggerProvider, ISupportExternalScope
 12           {
 13               private static long _logEntryIdCounter = 0;
 14               private readonly AvaloniaLogStore _store;
 15  ✔  3         private readonly ConcurrentDictionary<string, AvaloniaLogger> _loggers = new(StringComparer.Ordinal);
 16           
 17               private IExternalScopeProvider? _scopeProvider;
 18           
 19  ✔  3         public AvaloniaLoggerProvider(AvaloniaLogStore store)
 20  ✔  3         {
 21  ✓  3  ◑          _store = store ?? throw new ArgumentNullException(nameof(store));
 22  ✔  3         }
 23           
 24               public ILogger CreateLogger(string categoryName)
 25  ✔  7             => _loggers.GetOrAdd(categoryName, name => new AvaloniaLogger(name, _store, () => _scopeProvider));
 26           
 27               public void SetScopeProvider(IExternalScopeProvider scopeProvider)
 28  ❌ 0             => _scopeProvider = scopeProvider;
 29           
 30  ✔  1         public void Dispose() => _loggers.Clear();
 31           
 32               private sealed class AvaloniaLogger : ILogger
 33               {
 34                   private readonly string _category;
 35                   private readonly AvaloniaLogStore _store;
 36                   private readonly Func<IExternalScopeProvider?> _getScopeProvider;
 37           
 38  ✔  3             public AvaloniaLogger(string category, AvaloniaLogStore store, Func<IExternalScopeProvider?> getScopeProvider)
 39  ✔  3             {
 40  ✔  3                 _category = category;
 41  ✔  3                 _store = store;
 42  ✔  3                 _getScopeProvider = getScopeProvider;
 43  ✔  3             }
 44           
 45                   public IDisposable BeginScope<TState>(TState state)
 46                       where TState : notnull
 47  ❌ 0             {
 48  ❌ 0                 var scopeProvider = _getScopeProvider();
 49  ❌ 0  ○              return scopeProvider?.Push(state) ?? NullScope.Instance;
 50  ❌ 0             }
 51           
 52  ❌ 0             public bool IsEnabled(LogLevel logLevel) => true;
 53           
 54                   public void Log<TState>(
 55                       LogLevel logLevel,
 56                       EventId eventId,
 57                       TState state,
 58                       Exception? exception,
 59                       Func<TState, Exception?, string> formatter)
 60  ❌ 0             {
 61  ❌ 0  ○              if (formatter is null)
 62  ❌ 0                     throw new ArgumentNullException(nameof(formatter));
 63           
 64  ❌ 0                 var message = formatter(state, exception);
 65           
 66  ❌ 0                 var scopeProvider = _getScopeProvider();
 67  ❌ 0  ○              if (scopeProvider is not null)
 68  ❌ 0                 {
 69  ❌ 0                     scopeProvider.ForEachScope((scope, _) =>
 70  ❌ 0                     {
 71  ❌ 0  ○                      if (scope is null)
 72  ❌ 0                             return;
 73  ❌ 0     
 74  ❌ 0                         var scopeString = FormatScope(scope);
 75  ❌ 0  ○                      if (message.Length == 0)
 76  ❌ 0                             message = scopeString;
 77  ❌ 0                         else
 78  ❌ 0                             message = $"{message} | {scopeString}";
 79  ❌ 0                     }, state: (object?)null);
 80  ❌ 0                 }
 81           
 82  ❌ 0                 var logId = Interlocked.Increment(ref _logEntryIdCounter);
 83  ❌ 0                 _store.Add(new AvaloniaLogEntry(
 84  ❌ 0                     Id: logId,
 85  ❌ 0                     TimestampUtc: DateTimeOffset.UtcNow,
 86  ❌ 0                     Level: logLevel,
 87  ❌ 0                     Category: _category,
 88  ❌ 0                     EventId: eventId,
 89  ❌ 0                     Message: message,
 90  ❌ 0                     Exception: exception));
 91  ❌ 0             }
 92           
 93                   private static string FormatScope(object scope)
 94  ❌ 0             {
 95                       // Handle dictionaries and key-value pair collections
 96  ❌ 0  ○              if (scope is IEnumerable<KeyValuePair<string, object?>> kvpEnum)
 97  ❌ 0                 {
 98  ❌ 0                     var parts = kvpEnum
 99  ❌ 0                         .Where(kvp => kvp.Key != null)
100  ❌ 0                         .Select(kvp => $"{kvp.Key}={FormatValue(kvp.Value)}")
101  ❌ 0                         .ToList();
102  ❌ 0  ○                  return parts.Count > 0 ? string.Join(", ", parts) : scope.ToString() ?? string.Empty;
103                       }
104           
105                       // Handle IDictionary<string, object?>
106  ❌ 0  ○              if (scope is IDictionary<string, object?> dict)
107  ❌ 0                 {
108  ❌ 0                     var parts = dict
109  ❌ 0                         .Where(kvp => kvp.Key != null)
110  ❌ 0                         .Select(kvp => $"{kvp.Key}={FormatValue(kvp.Value)}")
111  ❌ 0                         .ToList();
112  ❌ 0  ○                  return parts.Count > 0 ? string.Join(", ", parts) : scope.ToString() ?? string.Empty;
113                       }
114           
115                       // Handle IDictionary (non-generic)
116  ❌ 0  ○              if (scope is IDictionary dictNonGeneric)
117  ❌ 0                 {
118  ❌ 0                     var parts = new List<string>();
119  ❌ 0  ○                  foreach (DictionaryEntry entry in dictNonGeneric)
120  ❌ 0                     {
121  ❌ 0  ○                      if (entry.Key != null)
122  ❌ 0                         {
123  ❌ 0                             parts.Add($"{entry.Key}={FormatValue(entry.Value)}");
124  ❌ 0                         }
125  ❌ 0                     }
126  ❌ 0  ○                  return parts.Count > 0 ? string.Join(", ", parts) : scope.ToString() ?? string.Empty;
127                       }
128           
129                       // Default to ToString() for other types
130  ❌ 0  ○              return scope.ToString() ?? string.Empty;
131  ❌ 0             }
132           
133                   private static string FormatValue(object? value)
134  ❌ 0             {
135  ❌ 0  ○              if (value == null)
136  ❌ 0                     return "null";
137           
138                       // Handle collections
139  ❌ 0  ○              if (value is IEnumerable enumerable && value is not string)
140  ❌ 0                 {
141  ❌ 0  ○                  var items = enumerable.Cast<object?>().Select(FormatValue).ToList();
142  ❌ 0                     return $"[{string.Join(", ", items)}]";
143                       }
144           
145                       // Handle complex objects - use ToString() but limit length
146  ❌ 0  ○              var str = value.ToString() ?? "null";
147  ❌ 0  ○              return str.Length > 100 ? str.Substring(0, 100) + "..." : str;
148  ❌ 0             }
149           
150                   private sealed class NullScope : IDisposable
151                   {
152  ❌ 0                 public static readonly NullScope Instance = new();
153  ❌ 0                 public void Dispose() { }
154                   }
155               }
156           }
157           
```
# FWH.Mobile.Logging.AvaloniaLogStore

## Summary

|||
|:---|:---|
| Class: | FWH.Mobile.Logging.AvaloniaLogStore |
| Assembly: | FWH.Mobile |
| **File(s):** | E:\github\FunWasHad\src\FWH.Mobile\FWH.Mobile\Logging\AvaloniaLogStore.cs |
| **Line coverage:** | 33.3% (9 of 27) |
| Covered lines: | 9 |
| Uncovered lines: | 18 |
| Coverable lines: | 27 |
| Total lines: | 52 |
| **Branch coverage:** | 25% (2 of 8) |
| Covered branches: | 2 |
| Total branches: | 8 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **.ctor(...)** | 100% | 2 | 2 | 100% |
| **get_Entries()** | 100% | 1 | 1 | 100% |
| **Add(...)** | 0% | 4 | 2 | 25.00% |
| **AddOnUiThread(...)** | 0% | 6 | 2 | 0% |
| **Clear()** | 0% | 6 | 2 | 0% |

## File(s)

### E:\github\FunWasHad\src\FWH.Mobile\FWH.Mobile\Logging\AvaloniaLogStore.cs
```
 1           using System;
 2           using System.Collections.ObjectModel;
 3           using Avalonia.Threading;
 4           
 5           namespace FWH.Mobile.Logging;
 6           
 7           public sealed class AvaloniaLogStore
 8           {
 9               private readonly int _maxEntries;
10           
11  ✔  7         public AvaloniaLogStore(int maxEntries = 1000)
12  ✔  7         {
13  ✔  7  ●          if (maxEntries <= 0)
14  ✔  2                 throw new ArgumentOutOfRangeException(nameof(maxEntries));
15           
16  ✔  5             _maxEntries = maxEntries;
17  ✔  5         }
18           
19  ✔  8         public ObservableCollection<AvaloniaLogEntry> Entries { get; } = new();
20           
21               public void Add(AvaloniaLogEntry entry)
22  ✔  1         {
23  ✔  1             ArgumentNullException.ThrowIfNull(entry);
24           
25  ❌ 0  ○          if (Dispatcher.UIThread.CheckAccess())
26  ❌ 0             {
27  ❌ 0                 AddOnUiThread(entry);
28  ❌ 0                 return;
29                   }
30           
31  ❌ 0             Dispatcher.UIThread.Post(() => AddOnUiThread(entry));
32  ❌ 0         }
33           
34               private void AddOnUiThread(AvaloniaLogEntry entry)
35  ❌ 0         {
36  ❌ 0             Entries.Add(entry);
37  ❌ 0  ○          while (Entries.Count > _maxEntries)
38  ❌ 0                 Entries.RemoveAt(0);
39  ❌ 0         }
40           
41               public void Clear()
42  ❌ 0         {
43  ❌ 0  ○          if (Dispatcher.UIThread.CheckAccess())
44  ❌ 0             {
45  ❌ 0                 Entries.Clear();
46  ❌ 0                 return;
47                   }
48           
49  ❌ 0             Dispatcher.UIThread.Post(() => Entries.Clear());
50  ❌ 0         }
51           }
52           
```
# FWH.Mobile.Options.LocationApiClientOptions

## Summary

|||
|:---|:---|
| Class: | FWH.Mobile.Options.LocationApiClientOptions |
| Assembly: | FWH.Mobile |
| **File(s):** | E:\github\FunWasHad\src\FWH.Mobile\FWH.Mobile\Options\LocationApiClientOptions.cs |
| **Line coverage:** | 0% (0 of 9) |
| Covered lines: | 0 |
| Uncovered lines: | 9 |
| Coverable lines: | 9 |
| Total lines: | 41 |
| **Branch coverage:** | 0% (0 of 2) |
| Covered branches: | 0 |
| Total branches: | 2 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **get_BaseAddress()** | 100% | 2 | 1 | 0% |
| **get_Timeout()** | 100% | 2 | 1 | 0% |
| **GetDefaultBaseAddress()** | 0% | 6 | 2 | 0% |

## File(s)

### E:\github\FunWasHad\src\FWH.Mobile\FWH.Mobile\Options\LocationApiClientOptions.cs
```
 1           using System;
 2           
 3           namespace FWH.Mobile.Options;
 4           
 5           /// <summary>
 6           /// Options for connecting to the Location Web API.
 7           /// </summary>
 8           public sealed class LocationApiClientOptions
 9           {
10               /// <summary>
11               /// Base address for the Location API.
12               /// Default is platform-specific:
13               /// - Android: http://10.0.2.2:4748/ (emulator's host machine alias + HTTP port)
14               /// - Other platforms: https://localhost:4747/ (HTTPS port)
15               ///
16               /// For Android physical devices, set LOCATION_API_BASE_URL environment variable
17               /// to your machine's IP address (e.g., http://192.168.1.100:4748/)
18               /// </summary>
19  ❌ 0         public string BaseAddress { get; set; } = GetDefaultBaseAddress();
20           
21               /// <summary>
22               /// HTTP timeout for API calls.
23               /// </summary>
24  ❌ 0         public TimeSpan Timeout { get; set; } = TimeSpan.FromSeconds(30);
25           
26               private static string GetDefaultBaseAddress()
27  ❌ 0         {
28                   // Detect platform at runtime instead of compile-time
29  ❌ 0  ○          if (OperatingSystem.IsAndroid())
30  ❌ 0             {
31                       // Android emulator: 10.0.2.2 is special alias for host machine's localhost
32                       // Use HTTP port 4748 (not HTTPS 4747) to avoid certificate issues in development
33  ❌ 0                 return "http://10.0.2.2:4748/";
34                   }
35                   else
36  ❌ 0             {
37                       // Desktop/iOS: Use HTTPS with actual port where API is running
38  ❌ 0                 return "https://localhost:4747/";
39                   }
40  ❌ 0         }
41           }
```
# FWH.Mobile.Services.ActivityTrackingService

## Summary

|||
|:---|:---|
| Class: | FWH.Mobile.Services.ActivityTrackingService |
| Assembly: | FWH.Mobile |
| **File(s):** | E:\github\FunWasHad\src\FWH.Mobile\FWH.Mobile\Services\ActivityTrackingService.cs |
| **Line coverage:** | 0% (0 of 163) |
| Covered lines: | 0 |
| Uncovered lines: | 163 |
| Coverable lines: | 163 |
| Total lines: | 283 |
| **Branch coverage:** | 0% (0 of 50) |
| Covered branches: | 0 |
| Total branches: | 50 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **.ctor(...)** | 0% | 42 | 6 | 0% |
| **get_IsTrackingActivity()** | 100% | 2 | 1 | 0% |
| **get_CurrentActivityType()** | 100% | 2 | 1 | 0% |
| **get_TotalDistanceMeters()** | 100% | 2 | 1 | 0% |
| **get_TotalDistanceMiles()** | 100% | 2 | 1 | 0% |
| **get_MaxSpeedMph()** | 100% | 2 | 1 | 0% |
| **get_ActivityDuration()** | 0% | 6 | 2 | 0% |
| **get_AverageSpeedMph()** | 0% | 20 | 4 | 0% |
| **StartMonitoring()** | 100% | 2 | 1 | 0% |
| **StopMonitoring()** | 0% | 6 | 2 | 0% |
| **OnMovementStateChanged(...)** | 0% | 702 | 26 | 0% |
| **OnLocationUpdated(...)** | 100% | 2 | 1 | 0% |
| **StartWalkingActivity(...)** | 100% | 2 | 1 | 0% |
| **StartRidingActivity(...)** | 0% | 6 | 2 | 0% |
| **TransitionToRiding(...)** | 0% | 6 | 2 | 0% |
| **TransitionToWalking(...)** | 100% | 2 | 1 | 0% |
| **EndActivity(...)** | 0% | 6 | 2 | 0% |
| **StartActivity(...)** | 100% | 2 | 1 | 0% |
| **EndActivity()** | 100% | 2 | 1 | 0% |
| **GetActivitySummary()** | 0% | 20 | 4 | 0% |

## File(s)

### E:\github\FunWasHad\src\FWH.Mobile\FWH.Mobile\Services\ActivityTrackingService.cs
```
  1           using FWH.Mobile.Services;
  2           using FWH.Common.Chat.Services;
  3           using Microsoft.Extensions.Logging;
  4           using System;
  5           using System.Threading.Tasks;
  6           
  7           namespace FWH.Mobile.Services;
  8           
  9           /// <summary>
 10           /// Service that tracks user activities based on movement state transitions.
 11           /// Provides statistics and notifications for walking and riding activities.
 12           /// </summary>
 13           public class ActivityTrackingService
 14           {
 15               private readonly ILocationTrackingService _locationTrackingService;
 16               private readonly INotificationService _notificationService;
 17               private readonly ILogger<ActivityTrackingService> _logger;
 18           
 19               // Activity tracking state
 20               private bool _isTrackingActivity;
 21               private DateTimeOffset _activityStartTime;
 22  ❌ 0         private MovementState _currentActivityType = MovementState.Unknown;
 23               private double _totalDistanceMeters;
 24               private double _maxSpeedMph;
 25               private int _transitionCount;
 26           
 27  ❌ 0         public ActivityTrackingService(
 28  ❌ 0             ILocationTrackingService locationTrackingService,
 29  ❌ 0             INotificationService notificationService,
 30  ❌ 0             ILogger<ActivityTrackingService> logger)
 31  ❌ 0         {
 32  ❌ 0  ○          _locationTrackingService = locationTrackingService ?? throw new ArgumentNullException(nameof(locationTrackingSer
 33  ❌ 0  ○          _notificationService = notificationService ?? throw new ArgumentNullException(nameof(notificationService));
 34  ❌ 0  ○          _logger = logger ?? throw new ArgumentNullException(nameof(logger));
 35  ❌ 0         }
 36           
 37               /// <summary>
 38               /// Gets whether activity tracking is currently active.
 39               /// </summary>
 40  ❌ 0         public bool IsTrackingActivity => _isTrackingActivity;
 41           
 42               /// <summary>
 43               /// Gets the current activity type being tracked.
 44               /// </summary>
 45  ❌ 0         public MovementState CurrentActivityType => _currentActivityType;
 46           
 47               /// <summary>
 48               /// Gets the total distance traveled in the current activity (meters).
 49               /// </summary>
 50  ❌ 0         public double TotalDistanceMeters => _totalDistanceMeters;
 51           
 52               /// <summary>
 53               /// Gets the total distance traveled in miles.
 54               /// </summary>
 55  ❌ 0         public double TotalDistanceMiles => _totalDistanceMeters / 1609.34;
 56           
 57               /// <summary>
 58               /// Gets the maximum speed reached during the current activity (mph).
 59               /// </summary>
 60  ❌ 0         public double MaxSpeedMph => _maxSpeedMph;
 61           
 62               /// <summary>
 63               /// Gets the duration of the current activity.
 64               /// </summary>
 65  ❌ 0  ○      public TimeSpan ActivityDuration => _isTrackingActivity
 66  ❌ 0             ? DateTimeOffset.UtcNow - _activityStartTime
 67  ❌ 0             : TimeSpan.Zero;
 68           
 69               /// <summary>
 70               /// Gets the average speed for the current activity (mph).
 71               /// </summary>
 72               public double AverageSpeedMph
 73               {
 74                   get
 75  ❌ 0             {
 76  ❌ 0                 var duration = ActivityDuration;
 77  ❌ 0  ○              if (duration.TotalSeconds <= 0 || _totalDistanceMeters <= 0)
 78  ❌ 0                     return 0;
 79           
 80  ❌ 0                 var avgSpeedMps = _totalDistanceMeters / duration.TotalSeconds;
 81  ❌ 0                 return GpsCalculator.MetersPerSecondToMph(avgSpeedMps);
 82  ❌ 0             }
 83               }
 84           
 85               /// <summary>
 86               /// Starts monitoring movement state transitions and tracking activities.
 87               /// </summary>
 88               public void StartMonitoring()
 89  ❌ 0         {
 90  ❌ 0             _locationTrackingService.MovementStateChanged += OnMovementStateChanged;
 91  ❌ 0             _locationTrackingService.LocationUpdated += OnLocationUpdated;
 92           
 93  ❌ 0             _logger.LogInformation("Activity tracking monitoring started");
 94  ❌ 0         }
 95           
 96               /// <summary>
 97               /// Stops monitoring movement state transitions.
 98               /// </summary>
 99               public void StopMonitoring()
100  ❌ 0         {
101  ❌ 0             _locationTrackingService.MovementStateChanged -= OnMovementStateChanged;
102  ❌ 0             _locationTrackingService.LocationUpdated -= OnLocationUpdated;
103           
104  ❌ 0  ○          if (_isTrackingActivity)
105  ❌ 0             {
106  ❌ 0                 EndActivity();
107  ❌ 0             }
108           
109  ❌ 0             _logger.LogInformation("Activity tracking monitoring stopped");
110  ❌ 0         }
111           
112               private void OnMovementStateChanged(object? sender, MovementStateChangedEventArgs e)
113  ❌ 0         {
114                   try
115  ❌ 0             {
116  ❌ 0                 _logger.LogInformation(
117  ❌ 0                     "Movement state transition: {Previous} → {Current}, Speed: {Speed:F1} mph",
118  ❌ 0                     e.PreviousState,
119  ❌ 0                     e.CurrentState,
120  ❌ 0                     e.CurrentSpeedMph ?? 0);
121           
122                       // Handle transitions from stationary
123  ❌ 0  ○              if (e.PreviousState == MovementState.Stationary || e.PreviousState == MovementState.Unknown)
124  ❌ 0                 {
125  ❌ 0  ○                  if (e.CurrentState == MovementState.Walking)
126  ❌ 0                     {
127  ❌ 0                         StartWalkingActivity(e);
128  ❌ 0                     }
129  ❌ 0  ○                  else if (e.CurrentState == MovementState.Riding)
130  ❌ 0                     {
131  ❌ 0                         StartRidingActivity(e);
132  ❌ 0                     }
133  ❌ 0                 }
134                       // Handle transitions between activities
135  ❌ 0  ○              else if (e.PreviousState == MovementState.Walking && e.CurrentState == MovementState.Riding)
136  ❌ 0                 {
137  ❌ 0                     TransitionToRiding(e);
138  ❌ 0                 }
139  ❌ 0  ○              else if (e.PreviousState == MovementState.Riding && e.CurrentState == MovementState.Walking)
140  ❌ 0                 {
141  ❌ 0                     TransitionToWalking(e);
142  ❌ 0                 }
143                       // Handle transitions to stationary
144  ❌ 0  ○              else if (e.CurrentState == MovementState.Stationary)
145  ❌ 0                 {
146  ❌ 0  ○                  if (e.PreviousState == MovementState.Walking || e.PreviousState == MovementState.Riding)
147  ❌ 0                     {
148  ❌ 0                         EndActivity(e);
149  ❌ 0                     }
150  ❌ 0                 }
151           
152                       // Track max speed
153  ❌ 0  ○              if (e.CurrentSpeedMph.HasValue && e.CurrentSpeedMph.Value > _maxSpeedMph)
154  ❌ 0                 {
155  ❌ 0                     _maxSpeedMph = e.CurrentSpeedMph.Value;
156  ❌ 0                 }
157           
158  ❌ 0                 _transitionCount++;
159  ❌ 0             }
160  ❌ 0             catch (Exception ex)
161  ❌ 0             {
162  ❌ 0                 _logger.LogError(ex, "Error handling movement state change");
163  ❌ 0             }
164  ❌ 0         }
165           
166               private void OnLocationUpdated(object? sender, FWH.Common.Location.Models.GpsCoordinates e)
167  ❌ 0         {
168                   // Distance tracking is handled in the location tracking service
169                   // We could add additional tracking here if needed
170  ❌ 0         }
171           
172               private void StartWalkingActivity(MovementStateChangedEventArgs e)
173  ❌ 0         {
174  ❌ 0             StartActivity(MovementState.Walking);
175           
176  ❌ 0             _notificationService.ShowSuccess(
177  ❌ 0                 "Your walking activity is now being tracked",
178  ❌ 0                 "Walking started");
179           
180  ❌ 0             _logger.LogInformation("Started walking activity");
181  ❌ 0         }
182           
183               private void StartRidingActivity(MovementStateChangedEventArgs e)
184  ❌ 0         {
185  ❌ 0             StartActivity(MovementState.Riding);
186           
187  ❌ 0  ○          var speedText = e.CurrentSpeedMph.HasValue
188  ❌ 0                 ? $" at {e.CurrentSpeedMph:F1} mph"
189  ❌ 0                 : "";
190           
191  ❌ 0             _notificationService.ShowSuccess(
192  ❌ 0                 $"Your riding activity is now being tracked{speedText}",
193  ❌ 0                 "Riding started");
194           
195  ❌ 0             _logger.LogInformation("Started riding activity at {Speed:F1} mph", e.CurrentSpeedMph ?? 0);
196  ❌ 0         }
197           
198               private void TransitionToRiding(MovementStateChangedEventArgs e)
199  ❌ 0         {
200  ❌ 0             _currentActivityType = MovementState.Riding;
201           
202  ❌ 0  ○          var speedText = e.CurrentSpeedMph.HasValue
203  ❌ 0                 ? $"{e.CurrentSpeedMph:F1} mph"
204  ❌ 0                 : "riding speed";
205           
206  ❌ 0             _notificationService.ShowInfo(
207  ❌ 0                 $"You're now traveling at {speedText}",
208  ❌ 0                 "Now riding");
209           
210  ❌ 0             _logger.LogInformation("Transitioned from walking to riding at {Speed:F1} mph", e.CurrentSpeedMph ?? 0);
211  ❌ 0         }
212           
213               private void TransitionToWalking(MovementStateChangedEventArgs e)
214  ❌ 0         {
215  ❌ 0             _currentActivityType = MovementState.Walking;
216           
217  ❌ 0             _notificationService.ShowInfo(
218  ❌ 0                 "You've slowed down to walking pace",
219  ❌ 0                 "Now walking");
220           
221  ❌ 0             _logger.LogInformation("Transitioned from riding to walking");
222  ❌ 0         }
223           
224               private void EndActivity(MovementStateChangedEventArgs e)
225  ❌ 0         {
226  ❌ 0             var duration = ActivityDuration;
227  ❌ 0             var distance = TotalDistanceMiles;
228  ❌ 0             var avgSpeed = AverageSpeedMph;
229  ❌ 0  ○          var activityType = _currentActivityType == MovementState.Walking ? "Walking" : "Riding";
230           
231  ❌ 0             _notificationService.ShowSuccess(
232  ❌ 0                 $"Duration: {duration.TotalMinutes:F0} min\n" +
233  ❌ 0                 $"Distance: {distance:F2} miles\n" +
234  ❌ 0                 $"Avg Speed: {avgSpeed:F1} mph\n" +
235  ❌ 0                 $"Max Speed: {_maxSpeedMph:F1} mph",
236  ❌ 0                 $"{activityType} activity completed");
237           
238  ❌ 0             _logger.LogInformation(
239  ❌ 0                 "{Activity} activity ended - Duration: {Duration:F0} min, Distance: {Distance:F2} miles, Avg Speed: {AvgSpee
240  ❌ 0                 activityType,
241  ❌ 0                 duration.TotalMinutes,
242  ❌ 0                 distance,
243  ❌ 0                 avgSpeed);
244           
245  ❌ 0             EndActivity();
246  ❌ 0         }
247           
248               private void StartActivity(MovementState activityType)
249  ❌ 0         {
250  ❌ 0             _isTrackingActivity = true;
251  ❌ 0             _activityStartTime = DateTimeOffset.UtcNow;
252  ❌ 0             _currentActivityType = activityType;
253  ❌ 0             _totalDistanceMeters = 0;
254  ❌ 0             _maxSpeedMph = 0;
255  ❌ 0             _transitionCount = 0;
256  ❌ 0         }
257           
258               private void EndActivity()
259  ❌ 0         {
260  ❌ 0             _isTrackingActivity = false;
261  ❌ 0             _currentActivityType = MovementState.Unknown;
262  ❌ 0         }
263           
264               /// <summary>
265               /// Gets a summary of the current activity.
266               /// </summary>
267               public string GetActivitySummary()
268  ❌ 0         {
269  ❌ 0  ○          if (!_isTrackingActivity)
270  ❌ 0                 return "No active activity";
271           
272  ❌ 0  ○          var activityName = _currentActivityType == MovementState.Walking ? "Walking" : "Riding";
273  ❌ 0             var duration = ActivityDuration;
274           
275  ❌ 0             return $"{activityName}\n" +
276  ❌ 0                    $"Duration: {duration.Hours:D2}:{duration.Minutes:D2}:{duration.Seconds:D2}\n" +
277  ❌ 0                    $"Distance: {TotalDistanceMiles:F2} miles\n" +
278  ❌ 0                    $"Current Speed: {_locationTrackingService.CurrentSpeedMph:F1} mph\n" +
279  ❌ 0                    $"Avg Speed: {AverageSpeedMph:F1} mph\n" +
280  ❌ 0                    $"Max Speed: {MaxSpeedMph:F1} mph\n" +
281  ❌ 0                    $"Transitions: {_transitionCount}";
282  ❌ 0         }
283           }
```
# FWH.Mobile.Services.ApiAuthenticationService

## Summary

|||
|:---|:---|
| Class: | FWH.Mobile.Services.ApiAuthenticationService |
| Assembly: | FWH.Mobile |
| **File(s):** | E:\github\FunWasHad\src\FWH.Mobile\FWH.Mobile\Services\ApiAuthenticationService.cs |
| **Line coverage:** | 0% (0 of 43) |
| Covered lines: | 0 |
| Uncovered lines: | 43 |
| Coverable lines: | 43 |
| Total lines: | 88 |
| **Branch coverage:** | 0% (0 of 18) |
| Covered branches: | 0 |
| Total branches: | 18 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **.ctor(...)** | 0% | 20 | 4 | 0% |
| **AddAuthenticationHeaders(...)** | 0% | 6 | 2 | 0% |
| **GenerateRequestSignature(...)** | 0% | 156 | 12 | 0% |

## File(s)

### E:\github\FunWasHad\src\FWH.Mobile\FWH.Mobile\Services\ApiAuthenticationService.cs
```
 1           using System.Security.Cryptography;
 2           using System.Text;
 3           using Microsoft.Extensions.Logging;
 4           
 5           namespace FWH.Mobile.Services;
 6           
 7           /// <summary>
 8           /// Service for adding API authentication headers to HTTP requests.
 9           /// Ensures only genuine builds of the app can call the API.
10           /// </summary>
11           public interface IApiAuthenticationService
12           {
13               /// <summary>
14               /// Adds authentication headers to the HTTP request.
15               /// </summary>
16               void AddAuthenticationHeaders(HttpRequestMessage request, string? requestBody = null);
17           }
18           
19           /// <summary>
20           /// Implementation of API authentication service using API key and request signing.
21           /// </summary>
22           public class ApiAuthenticationService : IApiAuthenticationService
23           {
24               private readonly string _apiKey;
25               private readonly string _apiSecret;
26               private readonly ILogger<ApiAuthenticationService>? _logger;
27           
28  ❌ 0         public ApiAuthenticationService(
29  ❌ 0             string apiKey,
30  ❌ 0             string apiSecret,
31  ❌ 0             ILogger<ApiAuthenticationService>? logger = null)
32  ❌ 0         {
33  ❌ 0  ○          if (string.IsNullOrWhiteSpace(apiKey))
34  ❌ 0                 throw new ArgumentException("API key cannot be null or empty", nameof(apiKey));
35  ❌ 0  ○          if (string.IsNullOrWhiteSpace(apiSecret))
36  ❌ 0                 throw new ArgumentException("API secret cannot be null or empty", nameof(apiSecret));
37           
38  ❌ 0             _apiKey = apiKey;
39  ❌ 0             _apiSecret = apiSecret;
40  ❌ 0             _logger = logger;
41  ❌ 0         }
42           
43               public void AddAuthenticationHeaders(HttpRequestMessage request, string? requestBody = null)
44  ❌ 0         {
45                   // Add API key header
46  ❌ 0             request.Headers.Add("X-API-Key", _apiKey);
47           
48                   // Generate and add request signature
49  ❌ 0             var signature = GenerateRequestSignature(request, requestBody);
50  ❌ 0  ○          if (!string.IsNullOrEmpty(signature))
51  ❌ 0             {
52  ❌ 0                 request.Headers.Add("X-Request-Signature", signature);
53  ❌ 0             }
54  ❌ 0         }
55           
56               private string GenerateRequestSignature(HttpRequestMessage request, string? requestBody)
57  ❌ 0         {
58                   try
59  ❌ 0             {
60                       // Build the string to sign: method + path + query + body hash
61  ❌ 0                 var method = request.Method.Method;
62  ❌ 0  ○              var path = request.RequestUri?.AbsolutePath ?? string.Empty;
63  ❌ 0  ○              var query = request.RequestUri?.Query ?? string.Empty;
64           
65                       // Include body hash if present
66  ❌ 0                 var bodyHash = string.Empty;
67  ❌ 0  ○              if (!string.IsNullOrEmpty(requestBody))
68  ❌ 0                 {
69  ❌ 0                     using var sha256 = SHA256.Create();
70  ❌ 0                     var bodyBytes = Encoding.UTF8.GetBytes(requestBody);
71  ❌ 0                     var hashBytes = sha256.ComputeHash(bodyBytes);
72  ❌ 0                     bodyHash = Convert.ToBase64String(hashBytes);
73  ❌ 0                 }
74           
75  ❌ 0                 var stringToSign = $"{method}{path}{query}{bodyHash}";
76           
77  ❌ 0                 using var hmac = new HMACSHA256(Encoding.UTF8.GetBytes(_apiSecret));
78  ❌ 0                 var signature = Convert.ToBase64String(hmac.ComputeHash(Encoding.UTF8.GetBytes(stringToSign)));
79           
80  ❌ 0                 return signature;
81                   }
82  ❌ 0             catch (Exception ex)
83  ❌ 0             {
84  ❌ 0  ○              _logger?.LogWarning(ex, "Failed to generate request signature");
85  ❌ 0                 return string.Empty;
86                   }
87  ❌ 0         }
88           }
```
# FWH.Mobile.Services.ChatNotificationService

## Summary

|||
|:---|:---|
| Class: | FWH.Mobile.Services.ChatNotificationService |
| Assembly: | FWH.Mobile |
| **File(s):** | E:\github\FunWasHad\src\FWH.Mobile\FWH.Mobile\Services\ChatNotificationService.cs |
| **Line coverage:** | 0% (0 of 33) |
| Covered lines: | 0 |
| Uncovered lines: | 33 |
| Coverable lines: | 33 |
| Total lines: | 61 |
| **Branch coverage:** | 0% (0 of 18) |
| Covered branches: | 0 |
| Total branches: | 18 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **.ctor(...)** | 0% | 6 | 2 | 0% |
| **ShowError(...)** | 0% | 20 | 4 | 0% |
| **ShowSuccess(...)** | 0% | 20 | 4 | 0% |
| **ShowInfo(...)** | 0% | 20 | 4 | 0% |
| **ShowWarning(...)** | 0% | 20 | 4 | 0% |

## File(s)

### E:\github\FunWasHad\src\FWH.Mobile\FWH.Mobile\Services\ChatNotificationService.cs
```
 1           using System;
 2           using FWH.Common.Chat.ViewModels;
 3           using Microsoft.Extensions.Logging;
 4           
 5           namespace FWH.Mobile.Services;
 6           
 7           /// <summary>
 8           /// Simple notification service that uses the chat interface for user notifications.
 9           /// Logging is used as a secondary channel for development/troubleshooting.
10           /// </summary>
11           public class ChatNotificationService : INotificationService
12           {
13               private readonly ChatListViewModel _chatList;
14               private readonly ILogger<ChatNotificationService>? _logger;
15           
16  ❌ 0         public ChatNotificationService(ChatListViewModel chatList, ILogger<ChatNotificationService>? logger = null)
17  ❌ 0         {
18  ❌ 0  ○          _chatList = chatList ?? throw new ArgumentNullException(nameof(chatList));
19  ❌ 0             _logger = logger;
20  ❌ 0         }
21           
22               public void ShowError(string message, string? title = null)
23  ❌ 0         {
24  ❌ 0  ○          var fullMessage = title != null ? $"{title}: {message}" : message;
25  ❌ 0  ○          _logger?.LogError("Notification: {Message}", fullMessage);
26           
27  ❌ 0             _chatList.AddEntry(new TextChatEntry(
28  ❌ 0                 ChatAuthors.Bot,
29  ❌ 0                 $"❌ {fullMessage}"));
30  ❌ 0         }
31           
32               public void ShowSuccess(string message, string? title = null)
33  ❌ 0         {
34  ❌ 0  ○          var fullMessage = title != null ? $"{title}: {message}" : message;
35  ❌ 0  ○          _logger?.LogInformation("Notification: {Message}", fullMessage);
36           
37  ❌ 0             _chatList.AddEntry(new TextChatEntry(
38  ❌ 0                 ChatAuthors.Bot,
39  ❌ 0                 $"✅ {fullMessage}"));
40  ❌ 0         }
41           
42               public void ShowInfo(string message, string? title = null)
43  ❌ 0         {
44  ❌ 0  ○          var fullMessage = title != null ? $"{title}: {message}" : message;
45  ❌ 0  ○          _logger?.LogInformation("Notification: {Message}", fullMessage);
46           
47  ❌ 0             _chatList.AddEntry(new TextChatEntry(
48  ❌ 0                 ChatAuthors.Bot,
49  ❌ 0                 $"ℹ️ {fullMessage}"));
50  ❌ 0         }
51           
52               public void ShowWarning(string message, string? title = null)
53  ❌ 0         {
54  ❌ 0  ○          var fullMessage = title != null ? $"{title}: {message}" : message;
55  ❌ 0  ○          _logger?.LogWarning("Notification: {Message}", fullMessage);
56           
57  ❌ 0             _chatList.AddEntry(new TextChatEntry(
58  ❌ 0                 ChatAuthors.Bot,
59  ❌ 0                 $"⚠️ {fullMessage}"));
60  ❌ 0         }
61           }
```
# FWH.Mobile.Services.GetNearbyBusinessesActionHandler

## Summary

|||
|:---|:---|
| Class: | FWH.Mobile.Services.GetNearbyBusinessesActionHandler |
| Assembly: | FWH.Mobile |
| **File(s):** | E:\github\FunWasHad\src\FWH.Mobile\FWH.Mobile\Services\GetNearbyBusinessesActionHandler.cs |
| **Line coverage:** | 0% (0 of 168) |
| Covered lines: | 0 |
| Uncovered lines: | 168 |
| Coverable lines: | 168 |
| Total lines: | 246 |
| **Branch coverage:** | 0% (0 of 34) |
| Covered branches: | 0 |
| Total branches: | 34 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **get_Name()** | 100% | 2 | 1 | 0% |
| **.ctor(...)** | 0% | 72 | 8 | 0% |
| **HandleAsync()** | 0% | 702 | 26 | 0% |

## File(s)

### E:\github\FunWasHad\src\FWH.Mobile\FWH.Mobile\Services\GetNearbyBusinessesActionHandler.cs
```
  1           using System;
  2           using System.Collections.Generic;
  3           using System.Linq;
  4           using System.Threading;
  5           using System.Threading.Tasks;
  6           using FWH.Common.Location;
  7           using FWH.Common.Location.Models;
  8           using FWH.Common.Workflow.Actions;
  9           using Microsoft.Extensions.Logging;
 10           
 11           namespace FWH.Mobile.Services;
 12           
 13           /// <summary>
 14           /// Workflow action handler that retrieves current GPS location and finds nearby businesses.
 15           /// Stores results in workflow state for use by subsequent nodes.
 16           /// </summary>
 17           public class GetNearbyBusinessesActionHandler : IWorkflowActionHandler
 18           {
 19               private readonly IGpsService _gpsService;
 20               private readonly ILocationService _locationService;
 21               private readonly INotificationService _notificationService;
 22               private readonly ILogger<GetNearbyBusinessesActionHandler> _logger;
 23           
 24  ❌ 0         public string Name => "get_nearby_businesses";
 25           
 26  ❌ 0         public GetNearbyBusinessesActionHandler(
 27  ❌ 0             IGpsService gpsService,
 28  ❌ 0             ILocationService locationService,
 29  ❌ 0             INotificationService notificationService,
 30  ❌ 0             ILogger<GetNearbyBusinessesActionHandler> logger)
 31  ❌ 0         {
 32  ❌ 0  ○          _gpsService = gpsService ?? throw new ArgumentNullException(nameof(gpsService));
 33  ❌ 0  ○          _locationService = locationService ?? throw new ArgumentNullException(nameof(locationService));
 34  ❌ 0  ○          _notificationService = notificationService ?? throw new ArgumentNullException(nameof(notificationService));
 35  ❌ 0  ○          _logger = logger ?? throw new ArgumentNullException(nameof(logger));
 36  ❌ 0         }
 37           
 38               public async Task<IDictionary<string, string>?> HandleAsync(
 39                   ActionHandlerContext context,
 40                   IDictionary<string, string> parameters,
 41                   CancellationToken cancellationToken = default)
 42  ❌ 0         {
 43  ❌ 0             _logger.LogInformation("Starting GPS location and nearby business search");
 44           
 45                   // Parse radius from parameters (default 1000m)
 46  ❌ 0             var radiusMeters = 1000;
 47  ❌ 0  ○          if (parameters.TryGetValue("radius", out var radiusStr) && int.TryParse(radiusStr, out var radius))
 48  ❌ 0             {
 49  ❌ 0                 radiusMeters = radius;
 50  ❌ 0             }
 51           
 52                   // Parse categories filter if provided
 53  ❌ 0             IEnumerable<string>? categories = null;
 54  ❌ 0  ○          if (parameters.TryGetValue("categories", out var categoriesStr) && !string.IsNullOrWhiteSpace(categoriesStr))
 55  ❌ 0             {
 56  ❌ 0                 categories = categoriesStr.Split(',').Select(c => c.Trim()).Where(c => !string.IsNullOrEmpty(c));
 57  ❌ 0             }
 58           
 59                   try
 60  ❌ 0             {
 61                       // Step 1: Check GPS availability
 62  ❌ 0  ○              if (!_gpsService.IsLocationAvailable)
 63  ❌ 0                 {
 64  ❌ 0                     _logger.LogWarning("GPS location services not available");
 65  ❌ 0                     _notificationService.ShowInfo(
 66  ❌ 0                         "Location services are not available. Please enable GPS.",
 67  ❌ 0                         "Location Required");
 68           
 69                           // Try to request permission
 70  ❌ 0                     var granted = await _gpsService.RequestLocationPermissionAsync();
 71  ❌ 0  ○                  if (!granted)
 72  ❌ 0                     {
 73  ❌ 0                         _logger.LogWarning("GPS permission denied by user");
 74  ❌ 0                         _notificationService.ShowError(
 75  ❌ 0                             "Location permission denied. Cannot find nearby businesses.",
 76  ❌ 0                             "Permission Required");
 77           
 78  ❌ 0                         return new Dictionary<string, string>
 79  ❌ 0                         {
 80  ❌ 0                             ["status"] = "permission_denied",
 81  ❌ 0                             ["error"] = "Location permission not granted"
 82  ❌ 0                         };
 83                           }
 84  ❌ 0                 }
 85           
 86                       // Step 2: Get current GPS location
 87  ❌ 0                 _notificationService.ShowInfo("Getting your current location...", "Please Wait");
 88  ❌ 0                 _logger.LogInformation("Requesting current GPS coordinates");
 89           
 90  ❌ 0                 GpsCoordinates? coordinates = null;
 91                       try
 92  ❌ 0                 {
 93  ❌ 0                     coordinates = await _gpsService.GetCurrentLocationAsync(cancellationToken);
 94  ❌ 0                 }
 95  ❌ 0                 catch (LocationServicesException ex)
 96  ❌ 0                 {
 97  ❌ 0                     _logger.LogError(ex,
 98  ❌ 0                         "Location service error. Platform: {Platform}, Operation: {Operation}, Diagnostics: {Diagnostics}",
 99  ❌ 0                         ex.Platform,
100  ❌ 0                         ex.Operation,
101  ❌ 0                         string.Join(", ", ex.Diagnostics.Select(kvp => $"{kvp.Key}={kvp.Value}")));
102           
103  ❌ 0                     var errorMessage = $"Location service error: {ex.Message}";
104  ❌ 0  ○                  if (ex.Diagnostics.Count > 0)
105  ❌ 0                     {
106  ❌ 0                         var diagInfo = string.Join(", ", ex.Diagnostics
107  ❌ 0                             .Where(kvp => kvp.Key != "StackTrace")
108  ❌ 0                             .Select(kvp => $"{kvp.Key}={kvp.Value}"));
109  ❌ 0                         errorMessage += $"\nDetails: {diagInfo}";
110  ❌ 0                     }
111           
112  ❌ 0                     _notificationService.ShowError(errorMessage, "Location Service Error");
113           
114  ❌ 0                     return new Dictionary<string, string>
115  ❌ 0                     {
116  ❌ 0                         ["status"] = "error",
117  ❌ 0                         ["error"] = ex.Message,
118  ❌ 0                         ["platform"] = ex.Platform,
119  ❌ 0                         ["operation"] = ex.Operation,
120  ❌ 0                         ["diagnostics"] = string.Join("; ", ex.Diagnostics.Select(kvp => $"{kvp.Key}={kvp.Value}"))
121  ❌ 0                     };
122                       }
123           
124  ❌ 0  ○              if (coordinates == null || !coordinates.IsValid())
125  ❌ 0                 {
126  ❌ 0                     _logger.LogWarning("Failed to retrieve valid GPS coordinates");
127  ❌ 0                     _notificationService.ShowError(
128  ❌ 0                         "Could not get your current location. Please check GPS settings.",
129  ❌ 0                         "Location Error");
130           
131  ❌ 0                     return new Dictionary<string, string>
132  ❌ 0                     {
133  ❌ 0                         ["status"] = "location_unavailable",
134  ❌ 0                         ["error"] = "Could not retrieve GPS coordinates"
135  ❌ 0                     };
136                       }
137           
138  ❌ 0                 _logger.LogInformation("GPS coordinates retrieved: {Latitude}, {Longitude} (accuracy: {Accuracy}m)",
139  ❌ 0                     coordinates.Latitude, coordinates.Longitude, coordinates.AccuracyMeters);
140           
141                       // Step 3: Find nearby businesses
142  ❌ 0                 _notificationService.ShowInfo($"Finding businesses within {radiusMeters}m...", "Searching");
143  ❌ 0                 _logger.LogInformation("Searching for businesses within {Radius}m at {Latitude}, {Longitude}",
144  ❌ 0                     radiusMeters, coordinates.Latitude, coordinates.Longitude);
145           
146  ❌ 0                 var businesses = await _locationService.GetNearbyBusinessesAsync(
147  ❌ 0                     coordinates.Latitude,
148  ❌ 0                     coordinates.Longitude,
149  ❌ 0                     radiusMeters,
150  ❌ 0                     categories,
151  ❌ 0                     cancellationToken);
152           
153  ❌ 0                 var businessList = businesses.ToList();
154  ❌ 0                 _logger.LogInformation("Found {Count} nearby businesses", businessList.Count);
155           
156                       // Step 4: Prepare results
157  ❌ 0  ○              var result = new Dictionary<string, string>
158  ❌ 0                 {
159  ❌ 0                     ["status"] = "success",
160  ❌ 0                     ["latitude"] = coordinates.Latitude.ToString("F6"),
161  ❌ 0                     ["longitude"] = coordinates.Longitude.ToString("F6"),
162  ❌ 0                     ["accuracy"] = coordinates.AccuracyMeters?.ToString("F0") ?? "unknown",
163  ❌ 0                     ["radius"] = radiusMeters.ToString(),
164  ❌ 0                     ["count"] = businessList.Count.ToString()
165  ❌ 0                 };
166           
167  ❌ 0  ○              if (businessList.Any())
168  ❌ 0                 {
169                           // Store top 5 business names
170  ❌ 0                     var topBusinesses = businessList.Take(5).ToList();
171  ❌ 0                     result["businesses"] = string.Join(",", topBusinesses.Select(b => b.Name));
172  ❌ 0                     result["closest_business"] = topBusinesses.First().Name;
173  ❌ 0                     result["closest_distance"] = (topBusinesses.First().DistanceMeters ?? 0).ToString("F0");
174           
175                           // Show success notification with details
176  ❌ 0                     var message = $"Found {businessList.Count} businesses nearby!\n\n" +
177  ❌ 0                                   $"Closest: {topBusinesses.First().Name} ({(topBusinesses.First().DistanceMeters ?? 0):F0}m
178           
179  ❌ 0  ○                  if (topBusinesses.Count > 1)
180  ❌ 0                     {
181  ❌ 0                         message += "\n\nOther nearby:\n" +
182  ❌ 0                                    string.Join("\n", topBusinesses.Skip(1).Take(4).Select(b =>
183  ❌ 0                                        $"• {b.Name} ({(b.DistanceMeters ?? 0):F0}m)"));
184  ❌ 0                     }
185           
186  ❌ 0                     _notificationService.ShowSuccess(message, "Nearby Businesses");
187  ❌ 0                 }
188                       else
189  ❌ 0                 {
190                           // No businesses found
191  ❌ 0                     _notificationService.ShowInfo(
192  ❌ 0                         $"No businesses found within {radiusMeters}m of your location.",
193  ❌ 0                         "Search Complete");
194           
195  ❌ 0                     result["businesses"] = string.Empty;
196  ❌ 0                 }
197           
198  ❌ 0                 _logger.LogInformation("Successfully completed location and business search");
199  ❌ 0                 return result;
200                   }
201  ❌ 0             catch (OperationCanceledException)
202  ❌ 0             {
203  ❌ 0                 _logger.LogInformation("Location search cancelled by user");
204  ❌ 0                 _notificationService.ShowWarning("Search cancelled", "Cancelled");
205           
206  ❌ 0                 return new Dictionary<string, string>
207  ❌ 0                 {
208  ❌ 0                     ["status"] = "cancelled",
209  ❌ 0                     ["error"] = "Operation cancelled"
210  ❌ 0                 };
211                   }
212  ❌ 0             catch (LocationServicesException ex)
213  ❌ 0             {
214                       // This should already be handled above, but catch here as a safety net
215  ❌ 0                 _logger.LogError(ex,
216  ❌ 0                     "Location service error in action handler. Platform: {Platform}, Operation: {Operation}",
217  ❌ 0                     ex.Platform,
218  ❌ 0                     ex.Operation);
219           
220  ❌ 0                 _notificationService.ShowError(
221  ❌ 0                     $"Location service error: {ex.Message}",
222  ❌ 0                     "Location Service Error");
223           
224  ❌ 0                 return new Dictionary<string, string>
225  ❌ 0                 {
226  ❌ 0                     ["status"] = "error",
227  ❌ 0                     ["error"] = ex.Message,
228  ❌ 0                     ["platform"] = ex.Platform,
229  ❌ 0                     ["operation"] = ex.Operation
230  ❌ 0                 };
231                   }
232  ❌ 0             catch (Exception ex)
233  ❌ 0             {
234  ❌ 0                 _logger.LogError(ex, "Error during location and business search");
235  ❌ 0                 _notificationService.ShowError(
236  ❌ 0                     $"An error occurred: {ex.Message}",
237  ❌ 0                     "Search Error");
238           
239  ❌ 0                 return new Dictionary<string, string>
240  ❌ 0                 {
241  ❌ 0                     ["status"] = "error",
242  ❌ 0                     ["error"] = ex.Message
243  ❌ 0                 };
244                   }
245  ❌ 0         }
246           }
```
# FWH.Mobile.Services.GpsCalculator

## Summary

|||
|:---|:---|
| Class: | FWH.Mobile.Services.GpsCalculator |
| Assembly: | FWH.Mobile |
| **File(s):** | E:\github\FunWasHad\src\FWH.Mobile\FWH.Mobile\Services\GpsCalculator.cs |
| **Line coverage:** | 48.4% (31 of 64) |
| Covered lines: | 31 |
| Uncovered lines: | 33 |
| Coverable lines: | 64 |
| Total lines: | 184 |
| **Branch coverage:** | 100% (2 of 2) |
| Covered branches: | 2 |
| Total branches: | 2 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **CalculateDistance(...)** | 100% | 1 | 1 | 100% |
| **CalculateSpeed(...)** | 100% | 2 | 2 | 100% |
| **CalculateSpeed(...)** | 100% | 1 | 1 | 100% |
| **MetersPerSecondToMph(...)** | 100% | 1 | 1 | 100% |
| **MetersPerSecondToKmh(...)** | 100% | 1 | 1 | 100% |
| **MphToMetersPerSecond(...)** | 100% | 2 | 1 | 0% |
| **KmhToMetersPerSecond(...)** | 100% | 2 | 1 | 0% |
| **IsWalkingSpeed(...)** | 100% | 2 | 1 | 0% |
| **IsRidingSpeed(...)** | 100% | 2 | 1 | 0% |
| **DegreesToRadians(...)** | 100% | 1 | 1 | 100% |
| **RadiansToDegrees(...)** | 100% | 2 | 1 | 0% |
| **CalculateBearing(...)** | 100% | 2 | 1 | 0% |
| **IsWithinRadius(...)** | 100% | 2 | 1 | 0% |

## File(s)

### E:\github\FunWasHad\src\FWH.Mobile\FWH.Mobile\Services\GpsCalculator.cs
```
  1             namespace FWH.Mobile.Services;
  2             
  3             /// <summary>
  4             /// Utility class for GPS coordinate calculations.
  5             /// </summary>
  6             public static class GpsCalculator
  7             {
  8                 private const double EarthRadiusMeters = 6371000.0; // Earth's radius in meters
  9                 private const double MpsToMphFactor = 2.23694; // Conversion factor
 10                 private const double MpsToKmhFactor = 3.6; // Conversion factor
 11             
 12                 /// <summary>
 13                 /// Calculates the distance between two GPS coordinates using the Haversine formula.
 14                 /// </summary>
 15                 /// <param name="lat1">Latitude of first point in degrees</param>
 16                 /// <param name="lon1">Longitude of first point in degrees</param>
 17                 /// <param name="lat2">Latitude of second point in degrees</param>
 18                 /// <param name="lon2">Longitude of second point in degrees</param>
 19                 /// <returns>Distance in meters</returns>
 20                 public static double CalculateDistance(double lat1, double lon1, double lat2, double lon2)
 21  ✔   57         {
 22                     // Convert to radians
 23  ✔   57             var lat1Rad = DegreesToRadians(lat1);
 24  ✔   57             var lat2Rad = DegreesToRadians(lat2);
 25  ✔   57             var deltaLat = DegreesToRadians(lat2 - lat1);
 26  ✔   57             var deltaLon = DegreesToRadians(lon2 - lon1);
 27             
 28                     // Haversine formula
 29  ✔   57             var a = Math.Sin(deltaLat / 2) * Math.Sin(deltaLat / 2) +
 30  ✔   57                     Math.Cos(lat1Rad) * Math.Cos(lat2Rad) *
 31  ✔   57                     Math.Sin(deltaLon / 2) * Math.Sin(deltaLon / 2);
 32             
 33  ✔   57             var c = 2 * Math.Atan2(Math.Sqrt(a), Math.Sqrt(1 - a));
 34             
 35  ✔   57             return EarthRadiusMeters * c;
 36  ✔   57         }
 37             
 38                 /// <summary>
 39                 /// Calculates the speed based on distance traveled and time elapsed.
 40                 /// </summary>
 41                 /// <param name="distanceMeters">Distance traveled in meters</param>
 42                 /// <param name="timeElapsed">Time elapsed during travel</param>
 43                 /// <returns>Speed in meters per second, or null if time is invalid</returns>
 44                 public static double? CalculateSpeed(double distanceMeters, TimeSpan timeElapsed)
 45  ✔   19         {
 46  ✔   19  ●          if (timeElapsed.TotalSeconds <= 0)
 47  ✔   18             {
 48  ✔   18                 return null;
 49                     }
 50             
 51  ✔    1             return distanceMeters / timeElapsed.TotalSeconds;
 52  ✔   19         }
 53             
 54                 /// <summary>
 55                 /// Calculates the speed between two GPS coordinates with timestamps.
 56                 /// </summary>
 57                 /// <param name="lat1">Latitude of first point</param>
 58                 /// <param name="lon1">Longitude of first point</param>
 59                 /// <param name="time1">Timestamp of first point</param>
 60                 /// <param name="lat2">Latitude of second point</param>
 61                 /// <param name="lon2">Longitude of second point</param>
 62                 /// <param name="time2">Timestamp of second point</param>
 63                 /// <returns>Speed in meters per second, or null if time difference is invalid</returns>
 64                 public static double? CalculateSpeed(
 65                     double lat1, double lon1, DateTimeOffset time1,
 66                     double lat2, double lon2, DateTimeOffset time2)
 67  ✔   19         {
 68  ✔   19             var distance = CalculateDistance(lat1, lon1, lat2, lon2);
 69  ✔   19             var timeElapsed = time2 - time1;
 70             
 71  ✔   19             return CalculateSpeed(distance, timeElapsed);
 72  ✔   19         }
 73             
 74                 /// <summary>
 75                 /// Converts speed from meters per second to miles per hour.
 76                 /// </summary>
 77                 public static double MetersPerSecondToMph(double metersPerSecond)
 78  ✔    4         {
 79  ✔    4             return metersPerSecond * MpsToMphFactor;
 80  ✔    4         }
 81             
 82                 /// <summary>
 83                 /// Converts speed from meters per second to kilometers per hour.
 84                 /// </summary>
 85                 public static double MetersPerSecondToKmh(double metersPerSecond)
 86  ✔    1         {
 87  ✔    1             return metersPerSecond * MpsToKmhFactor;
 88  ✔    1         }
 89             
 90                 /// <summary>
 91                 /// Converts speed from miles per hour to meters per second.
 92                 /// </summary>
 93                 public static double MphToMetersPerSecond(double mph)
 94  ❌   0         {
 95  ❌   0             return mph / MpsToMphFactor;
 96  ❌   0         }
 97             
 98                 /// <summary>
 99                 /// Converts speed from kilometers per hour to meters per second.
100                 /// </summary>
101                 public static double KmhToMetersPerSecond(double kmh)
102  ❌   0         {
103  ❌   0             return kmh / MpsToKmhFactor;
104  ❌   0         }
105             
106                 /// <summary>
107                 /// Determines if the speed indicates walking (< 5 mph / 8 km/h).
108                 /// </summary>
109                 public static bool IsWalkingSpeed(double speedMetersPerSecond)
110  ❌   0         {
111  ❌   0             var speedMph = MetersPerSecondToMph(speedMetersPerSecond);
112  ❌   0             return speedMph < 5.0;
113  ❌   0         }
114             
115                 /// <summary>
116                 /// Determines if the speed indicates riding (>= 5 mph / 8 km/h).
117                 /// </summary>
118                 public static bool IsRidingSpeed(double speedMetersPerSecond)
119  ❌   0         {
120  ❌   0             var speedMph = MetersPerSecondToMph(speedMetersPerSecond);
121  ❌   0             return speedMph >= 5.0;
122  ❌   0         }
123             
124                 /// <summary>
125                 /// Converts degrees to radians.
126                 /// </summary>
127                 private static double DegreesToRadians(double degrees)
128  ✔  228         {
129  ✔  228             return degrees * Math.PI / 180.0;
130  ✔  228         }
131             
132                 /// <summary>
133                 /// Converts radians to degrees.
134                 /// </summary>
135                 public static double RadiansToDegrees(double radians)
136  ❌   0         {
137  ❌   0             return radians * 180.0 / Math.PI;
138  ❌   0         }
139             
140                 /// <summary>
141                 /// Calculates the bearing (direction) from one point to another.
142                 /// </summary>
143                 /// <param name="lat1">Latitude of first point in degrees</param>
144                 /// <param name="lon1">Longitude of first point in degrees</param>
145                 /// <param name="lat2">Latitude of second point in degrees</param>
146                 /// <param name="lon2">Longitude of second point in degrees</param>
147                 /// <returns>Bearing in degrees (0-360, where 0/360 is North)</returns>
148                 public static double CalculateBearing(double lat1, double lon1, double lat2, double lon2)
149  ❌   0         {
150  ❌   0             var lat1Rad = DegreesToRadians(lat1);
151  ❌   0             var lat2Rad = DegreesToRadians(lat2);
152  ❌   0             var deltaLon = DegreesToRadians(lon2 - lon1);
153             
154  ❌   0             var y = Math.Sin(deltaLon) * Math.Cos(lat2Rad);
155  ❌   0             var x = Math.Cos(lat1Rad) * Math.Sin(lat2Rad) -
156  ❌   0                     Math.Sin(lat1Rad) * Math.Cos(lat2Rad) * Math.Cos(deltaLon);
157             
158  ❌   0             var bearing = Math.Atan2(y, x);
159  ❌   0             bearing = RadiansToDegrees(bearing);
160  ❌   0             bearing = (bearing + 360) % 360;
161             
162  ❌   0             return bearing;
163  ❌   0         }
164             
165                 /// <summary>
166                 /// Checks if a point is within a given radius of another point.
167                 /// </summary>
168                 /// <param name="centerLat">Latitude of center point</param>
169                 /// <param name="centerLon">Longitude of center point</param>
170                 /// <param name="pointLat">Latitude of point to check</param>
171                 /// <param name="pointLon">Longitude of point to check</param>
172                 /// <param name="radiusMeters">Radius in meters</param>
173                 /// <returns>True if point is within radius</returns>
174                 public static bool IsWithinRadius(
175                     double centerLat,
176                     double centerLon,
177                     double pointLat,
178                     double pointLon,
179                     double radiusMeters)
180  ❌   0         {
181  ❌   0             var distance = CalculateDistance(centerLat, centerLon, pointLat, pointLon);
182  ❌   0             return distance <= radiusMeters;
183  ❌   0         }
184             }
```
# FWH.Mobile.Services.ImageService

## Summary

|||
|:---|:---|
| Class: | FWH.Mobile.Services.ImageService |
| Assembly: | FWH.Mobile |
| **File(s):** | E:\github\FunWasHad\src\FWH.Mobile\FWH.Mobile\Services\ImageService.cs |
| **Line coverage:** | 0% (0 of 143) |
| Covered lines: | 0 |
| Uncovered lines: | 143 |
| Coverable lines: | 143 |
| Total lines: | 224 |
| **Branch coverage:** | 0% (0 of 38) |
| Covered branches: | 0 |
| Total branches: | 38 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **.ctor(...)** | 0% | 20 | 4 | 0% |
| **GetImageAsync()** | 0% | 156 | 12 | 0% |
| **StoreImageAsync()** | 0% | 156 | 12 | 0% |
| **GetImageByEntityAsync()** | 0% | 6 | 2 | 0% |
| **DeleteImageAsync()** | 0% | 6 | 2 | 0% |
| **GetImageUriAsync()** | 0% | 42 | 6 | 0% |

## File(s)

### E:\github\FunWasHad\src\FWH.Mobile\FWH.Mobile\Services\ImageService.cs
```
  1           using FWH.Mobile.Data.Data;
  2           using FWH.Mobile.Data.Entities;
  3           using Microsoft.EntityFrameworkCore;
  4           using Microsoft.Extensions.Logging;
  5           using System;
  6           using System.Linq;
  7           using System.Net.Http;
  8           using System.Threading.Tasks;
  9           
 10           namespace FWH.Mobile.Services;
 11           
 12           /// <summary>
 13           /// Service for managing images and logos, including storage in SQLite database.
 14           /// </summary>
 15           public class ImageService : IImageService
 16           {
 17               private readonly NotesDbContext _dbContext;
 18               private readonly IHttpClientFactory? _httpClientFactory;
 19               private readonly ILogger<ImageService> _logger;
 20           
 21  ❌ 0         public ImageService(
 22  ❌ 0             NotesDbContext dbContext,
 23  ❌ 0             ILogger<ImageService> logger,
 24  ❌ 0             IHttpClientFactory? httpClientFactory = null)
 25  ❌ 0         {
 26  ❌ 0  ○          _dbContext = dbContext ?? throw new ArgumentNullException(nameof(dbContext));
 27  ❌ 0  ○          _logger = logger ?? throw new ArgumentNullException(nameof(logger));
 28  ❌ 0             _httpClientFactory = httpClientFactory;
 29  ❌ 0         }
 30           
 31               public async Task<byte[]?> GetImageAsync(string sourceUrl, string imageType, string? entityType = null, long? entity
 32  ❌ 0         {
 33  ❌ 0  ○          if (string.IsNullOrEmpty(sourceUrl))
 34  ❌ 0                 return null;
 35           
 36                   try
 37  ❌ 0             {
 38                       // First, try to get from database
 39  ❌ 0                 var existingImage = await _dbContext.Images
 40  ❌ 0                     .Where(i => i.SourceUrl == sourceUrl && i.ImageType == imageType)
 41  ❌ 0                     .FirstOrDefaultAsync();
 42           
 43  ❌ 0  ○              if (existingImage != null)
 44  ❌ 0                 {
 45                           // Update last accessed time
 46  ❌ 0                     existingImage.LastAccessedAt = DateTimeOffset.UtcNow;
 47  ❌ 0                     await _dbContext.SaveChangesAsync();
 48  ❌ 0                     _logger.LogDebug("Retrieved image from cache: {SourceUrl}", sourceUrl);
 49  ❌ 0                     return existingImage.ImageData;
 50                       }
 51           
 52                       // Not in database, download and store
 53  ❌ 0  ○              if (_httpClientFactory == null)
 54  ❌ 0                 {
 55  ❌ 0                     _logger.LogWarning("HttpClientFactory not available, cannot download image: {SourceUrl}", sourceUrl);
 56  ❌ 0                     return null;
 57                       }
 58           
 59  ❌ 0                 using var httpClient = _httpClientFactory.CreateClient();
 60  ❌ 0                 httpClient.Timeout = TimeSpan.FromSeconds(30);
 61           
 62  ❌ 0                 var response = await httpClient.GetAsync(sourceUrl);
 63  ❌ 0  ○              if (!response.IsSuccessStatusCode)
 64  ❌ 0                 {
 65  ❌ 0                     _logger.LogWarning("Failed to download image: {SourceUrl}, Status: {StatusCode}", sourceUrl, response.St
 66  ❌ 0                     return null;
 67                       }
 68           
 69  ❌ 0                 var imageData = await response.Content.ReadAsByteArrayAsync();
 70  ❌ 0  ○              var contentType = response.Content.Headers.ContentType?.MediaType ?? "image/png";
 71           
 72                       // Store in database
 73  ❌ 0                 var imageId = await StoreImageAsync(
 74  ❌ 0                     imageData,
 75  ❌ 0                     imageType,
 76  ❌ 0                     sourceUrl,
 77  ❌ 0                     entityType,
 78  ❌ 0                     entityId,
 79  ❌ 0                     contentType);
 80           
 81  ❌ 0                 _logger.LogInformation("Downloaded and stored image: {SourceUrl}, Size: {Size} bytes, ImageId: {ImageId}",
 82  ❌ 0                     sourceUrl, imageData.Length, imageId);
 83           
 84  ❌ 0                 return imageData;
 85                   }
 86  ❌ 0             catch (Exception ex)
 87  ❌ 0             {
 88  ❌ 0                 _logger.LogError(ex, "Error getting image: {SourceUrl}", sourceUrl);
 89  ❌ 0                 return null;
 90                   }
 91  ❌ 0         }
 92           
 93               public async Task<long> StoreImageAsync(
 94                   byte[] imageData,
 95                   string imageType,
 96                   string? sourceUrl = null,
 97                   string? entityType = null,
 98                   long? entityId = null,
 99                   string contentType = "image/png",
100                   string? fileName = null)
101  ❌ 0         {
102  ❌ 0  ○          if (imageData == null || imageData.Length == 0)
103  ❌ 0                 throw new ArgumentException("Image data cannot be null or empty", nameof(imageData));
104           
105                   try
106  ❌ 0             {
107                       // Check if image already exists
108  ❌ 0                 ImageEntity? existingImage = null;
109  ❌ 0  ○              if (!string.IsNullOrEmpty(sourceUrl))
110  ❌ 0                 {
111  ❌ 0                     existingImage = await _dbContext.Images
112  ❌ 0                         .Where(i => i.SourceUrl == sourceUrl && i.ImageType == imageType)
113  ❌ 0                         .FirstOrDefaultAsync();
114  ❌ 0                 }
115  ❌ 0  ○              else if (entityType != null && entityId.HasValue)
116  ❌ 0                 {
117  ❌ 0                     existingImage = await _dbContext.Images
118  ❌ 0                         .Where(i => i.ImageType == imageType && i.EntityType == entityType && i.EntityId == entityId)
119  ❌ 0                         .FirstOrDefaultAsync();
120  ❌ 0                 }
121           
122  ❌ 0  ○              if (existingImage != null)
123  ❌ 0                 {
124                           // Update existing image
125  ❌ 0                     existingImage.ImageData = imageData;
126  ❌ 0                     existingImage.ContentType = contentType;
127  ❌ 0                     existingImage.FileName = fileName;
128  ❌ 0                     existingImage.FileSizeBytes = imageData.Length;
129  ❌ 0                     existingImage.LastAccessedAt = DateTimeOffset.UtcNow;
130  ❌ 0                     await _dbContext.SaveChangesAsync();
131  ❌ 0                     _logger.LogDebug("Updated existing image: ImageId: {ImageId}", existingImage.Id);
132  ❌ 0                     return existingImage.Id;
133                       }
134           
135                       // Create new image entity
136  ❌ 0                 var image = new ImageEntity
137  ❌ 0                 {
138  ❌ 0                     SourceUrl = sourceUrl,
139  ❌ 0                     ImageType = imageType,
140  ❌ 0                     EntityType = entityType,
141  ❌ 0                     EntityId = entityId,
142  ❌ 0                     ImageData = imageData,
143  ❌ 0                     ContentType = contentType,
144  ❌ 0                     FileName = fileName,
145  ❌ 0                     FileSizeBytes = imageData.Length,
146  ❌ 0                     CreatedAt = DateTimeOffset.UtcNow,
147  ❌ 0                     LastAccessedAt = DateTimeOffset.UtcNow
148  ❌ 0                 };
149           
150  ❌ 0                 _dbContext.Images.Add(image);
151  ❌ 0                 await _dbContext.SaveChangesAsync();
152           
153  ❌ 0                 _logger.LogInformation("Stored new image: ImageId: {ImageId}, Type: {ImageType}, Size: {Size} bytes",
154  ❌ 0                     image.Id, imageType, imageData.Length);
155           
156  ❌ 0                 return image.Id;
157                   }
158  ❌ 0             catch (Exception ex)
159  ❌ 0             {
160  ❌ 0                 _logger.LogError(ex, "Error storing image: {ImageType}", imageType);
161  ❌ 0                 throw;
162                   }
163  ❌ 0         }
164           
165               public async Task<byte[]?> GetImageByEntityAsync(string imageType, string entityType, long entityId)
166  ❌ 0         {
167                   try
168  ❌ 0             {
169  ❌ 0                 var image = await _dbContext.Images
170  ❌ 0                     .Where(i => i.ImageType == imageType && i.EntityType == entityType && i.EntityId == entityId)
171  ❌ 0                     .FirstOrDefaultAsync();
172           
173  ❌ 0  ○              if (image != null)
174  ❌ 0                 {
175  ❌ 0                     image.LastAccessedAt = DateTimeOffset.UtcNow;
176  ❌ 0                     await _dbContext.SaveChangesAsync();
177  ❌ 0                     return image.ImageData;
178                       }
179           
180  ❌ 0                 return null;
181                   }
182  ❌ 0             catch (Exception ex)
183  ❌ 0             {
184  ❌ 0                 _logger.LogError(ex, "Error getting image by entity: {ImageType}, {EntityType}, {EntityId}",
185  ❌ 0                     imageType, entityType, entityId);
186  ❌ 0                 return null;
187                   }
188  ❌ 0         }
189           
190               public async Task DeleteImageAsync(long imageId)
191  ❌ 0         {
192                   try
193  ❌ 0             {
194  ❌ 0                 var image = await _dbContext.Images.FindAsync(imageId);
195  ❌ 0  ○              if (image != null)
196  ❌ 0                 {
197  ❌ 0                     _dbContext.Images.Remove(image);
198  ❌ 0                     await _dbContext.SaveChangesAsync();
199  ❌ 0                     _logger.LogInformation("Deleted image: ImageId: {ImageId}", imageId);
200  ❌ 0                 }
201  ❌ 0             }
202  ❌ 0             catch (Exception ex)
203  ❌ 0             {
204  ❌ 0                 _logger.LogError(ex, "Error deleting image: {ImageId}", imageId);
205  ❌ 0                 throw;
206                   }
207  ❌ 0         }
208           
209               public async Task<string?> GetImageUriAsync(string sourceUrl, string imageType, string? entityType = null, long? ent
210  ❌ 0         {
211  ❌ 0             var imageData = await GetImageAsync(sourceUrl, imageType, entityType, entityId);
212  ❌ 0  ○          if (imageData == null)
213  ❌ 0                 return null;
214           
215                   // Get content type from database
216  ❌ 0             var image = await _dbContext.Images
217  ❌ 0                 .Where(i => i.SourceUrl == sourceUrl && i.ImageType == imageType)
218  ❌ 0                 .FirstOrDefaultAsync();
219           
220  ❌ 0  ○          var contentType = image?.ContentType ?? "image/png";
221  ❌ 0             var base64 = Convert.ToBase64String(imageData);
222  ❌ 0             return $"data:{contentType};base64,{base64}";
223  ❌ 0         }
224           }
```
# FWH.Mobile.Services.LocationAddressChangedEventArgs

## Summary

|||
|:---|:---|
| Class: | FWH.Mobile.Services.LocationAddressChangedEventArgs |
| Assembly: | FWH.Mobile |
| **File(s):** | E:\github\FunWasHad\src\FWH.Mobile\FWH.Mobile\Services\ILocationTrackingService.cs |
| **Line coverage:** | 0% (0 of 15) |
| Covered lines: | 0 |
| Uncovered lines: | 15 |
| Coverable lines: | 15 |
| Total lines: | 137 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **get_PreviousAddress()** | 100% | 2 | 1 | 0% |
| **get_CurrentAddress()** | 100% | 2 | 1 | 0% |
| **get_Location()** | 100% | 2 | 1 | 0% |
| **get_Timestamp()** | 100% | 2 | 1 | 0% |
| **.ctor(...)** | 100% | 2 | 1 | 0% |

## File(s)

### E:\github\FunWasHad\src\FWH.Mobile\FWH.Mobile\Services\ILocationTrackingService.cs
```
  1           using FWH.Common.Location.Models;
  2           
  3           namespace FWH.Mobile.Services;
  4           
  5           /// <summary>
  6           /// Service for tracking device location changes and updating the backend API.
  7           /// Monitors location changes and sends updates when device moves more than threshold distance.
  8           /// </summary>
  9           public interface ILocationTrackingService
 10           {
 11               /// <summary>
 12               /// Starts tracking location changes.
 13               /// </summary>
 14               Task StartTrackingAsync(CancellationToken cancellationToken = default);
 15           
 16               /// <summary>
 17               /// Stops tracking location changes.
 18               /// </summary>
 19               Task StopTrackingAsync();
 20           
 21               /// <summary>
 22               /// Gets whether location tracking is currently active.
 23               /// </summary>
 24               bool IsTracking { get; }
 25           
 26               /// <summary>
 27               /// Gets the last known location.
 28               /// </summary>
 29               GpsCoordinates? LastKnownLocation { get; }
 30           
 31               /// <summary>
 32               /// Gets the current movement state of the device.
 33               /// </summary>
 34               MovementState CurrentMovementState { get; }
 35           
 36               /// <summary>
 37               /// Gets the current speed in meters per second (if available).
 38               /// </summary>
 39               double? CurrentSpeedMetersPerSecond { get; }
 40           
 41               /// <summary>
 42               /// Gets the current speed in miles per hour (if available).
 43               /// </summary>
 44               double? CurrentSpeedMph { get; }
 45           
 46               /// <summary>
 47               /// Gets the current speed in kilometers per hour (if available).
 48               /// </summary>
 49               double? CurrentSpeedKmh { get; }
 50           
 51               /// <summary>
 52               /// Gets the current address (if available).
 53               /// This is determined when the device remains stationary and the location is resolved to an address.
 54               /// </summary>
 55               string? CurrentAddress { get; }
 56           
 57               /// <summary>
 58               /// Gets or sets the minimum distance in meters that triggers a location update.
 59               /// Default: 50 meters.
 60               /// </summary>
 61               double MinimumDistanceMeters { get; set; }
 62           
 63               /// <summary>
 64               /// Gets or sets the polling interval for checking location changes.
 65               /// Default: 30 seconds.
 66               /// </summary>
 67               TimeSpan PollingInterval { get; set; }
 68           
 69               /// <summary>
 70               /// Gets or sets the minimum duration a device must remain stationary before being considered "Stationary".
 71               /// Default: 3 minutes (3 consecutive polls with no significant movement).
 72               /// </summary>
 73               TimeSpan StationaryThresholdDuration { get; set; }
 74           
 75               /// <summary>
 76               /// Gets or sets the distance threshold for considering device as stationary.
 77               /// Movement less than this distance is considered stationary.
 78               /// Default: 10 meters.
 79               /// </summary>
 80               double StationaryDistanceThresholdMeters { get; set; }
 81           
 82               /// <summary>
 83               /// Gets or sets the speed threshold in MPH for distinguishing walking from riding.
 84               /// Speed below this threshold is considered walking, at or above is considered riding.
 85               /// Default: 5.0 mph.
 86               /// </summary>
 87               double WalkingRidingSpeedThresholdMph { get; set; }
 88           
 89               /// <summary>
 90               /// Gets or sets the countdown duration before checking for address change when device becomes stationary.
 91               /// Default: 1 minute.
 92               /// </summary>
 93               TimeSpan StationaryAddressCheckDelay { get; set; }
 94           
 95               /// <summary>
 96               /// Event raised when location is updated.
 97               /// </summary>
 98               event EventHandler<GpsCoordinates>? LocationUpdated;
 99           
100               /// <summary>
101               /// Event raised when location update fails.
102               /// </summary>
103               event EventHandler<Exception>? LocationUpdateFailed;
104           
105               /// <summary>
106               /// Event raised when movement state changes (stationary to moving or vice versa).
107               /// </summary>
108               event EventHandler<MovementStateChangedEventArgs>? MovementStateChanged;
109           
110               /// <summary>
111               /// Event raised when the device address changes after remaining stationary for the countdown duration.
112               /// </summary>
113               event EventHandler<LocationAddressChangedEventArgs>? NewLocationAddress;
114           }
115           
116           /// <summary>
117           /// Event args for when a location address changes.
118           /// </summary>
119           public class LocationAddressChangedEventArgs : EventArgs
120           {
121  ❌ 0         public string? PreviousAddress { get; }
122  ❌ 0         public string CurrentAddress { get; }
123  ❌ 0         public GpsCoordinates Location { get; }
124  ❌ 0         public DateTimeOffset Timestamp { get; }
125           
126  ❌ 0         public LocationAddressChangedEventArgs(
127  ❌ 0             string? previousAddress,
128  ❌ 0             string currentAddress,
129  ❌ 0             GpsCoordinates location,
130  ❌ 0             DateTimeOffset timestamp)
131  ❌ 0         {
132  ❌ 0             PreviousAddress = previousAddress;
133  ❌ 0             CurrentAddress = currentAddress;
134  ❌ 0             Location = location;
135  ❌ 0             Timestamp = timestamp;
136  ❌ 0         }
137           }
```
# FWH.Mobile.Services.LocationApiClient

## Summary

|||
|:---|:---|
| Class: | FWH.Mobile.Services.LocationApiClient |
| Assembly: | FWH.Mobile |
| **File(s):** | E:\github\FunWasHad\src\FWH.Mobile\FWH.Mobile\Services\LocationApiClient.cs |
| **Line coverage:** | 0% (0 of 113) |
| Covered lines: | 0 |
| Uncovered lines: | 113 |
| Coverable lines: | 113 |
| Total lines: | 213 |
| **Branch coverage:** | 0% (0 of 30) |
| Covered branches: | 0 |
| Total branches: | 30 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **.ctor(...)** | 0% | 210 | 14 | 0% |
| **GetNearbyBusinessesAsync()** | 100% | 2 | 1 | 0% |
| **GetClosestBusinessAsync()** | 0% | 6 | 2 | 0% |
| **GetAddressAsync()** | 0% | 20 | 4 | 0% |
| **UpdateDeviceLocationAsync()** | 0% | 6 | 2 | 0% |
| **SendCollectionRequestAsync()** | 0% | 6 | 2 | 0% |
| **BuildNearbyUri(...)** | 0% | 20 | 4 | 0% |
| **BuildClosestUri(...)** | 100% | 2 | 1 | 0% |
| **AppendCoordinateParameters(...)** | 100% | 2 | 1 | 0% |
| **EnsureTrailingSlash(...)** | 0% | 6 | 2 | 0% |

## File(s)

### E:\github\FunWasHad\src\FWH.Mobile\FWH.Mobile\Services\LocationApiClient.cs
```
  1           using System.Globalization;
  2           using System.Net;
  3           using System.Net.Http.Json;
  4           using System.Text;
  5           using System.Text.Json;
  6           using FWH.Common.Location;
  7           using FWH.Common.Location.Models;
  8           using FWH.Mobile.Options;
  9           using Microsoft.Extensions.Logging;
 10           using Microsoft.Extensions.Options;
 11           
 12           namespace FWH.Mobile.Services;
 13           
 14           /// <summary>
 15           /// Typed HttpClient that proxies requests to the Location Web API.
 16           /// </summary>
 17           public sealed class LocationApiClient : ILocationService
 18           {
 19               private readonly HttpClient _httpClient;
 20               private readonly ILogger<LocationApiClient> _logger;
 21  ❌ 0         private readonly JsonSerializerOptions _serializerOptions = new(JsonSerializerDefaults.Web);
 22           
 23  ❌ 0         public LocationApiClient(HttpClient httpClient, IOptions<LocationApiClientOptions> options, ILogger<LocationApiClien
 24  ❌ 0         {
 25  ❌ 0  ○          _httpClient = httpClient ?? throw new ArgumentNullException(nameof(httpClient));
 26  ❌ 0  ○          _logger = logger ?? throw new ArgumentNullException(nameof(logger));
 27  ❌ 0             ArgumentNullException.ThrowIfNull(options);
 28           
 29  ❌ 0  ○          var resolvedOptions = options.Value ?? throw new ArgumentNullException(nameof(options));
 30  ❌ 0  ○          if (string.IsNullOrWhiteSpace(resolvedOptions.BaseAddress))
 31  ❌ 0             {
 32  ❌ 0                 throw new InvalidOperationException("The Location API base address has not been configured.");
 33                   }
 34           
 35                   // Only set BaseAddress if not already configured by HttpClient factory
 36  ❌ 0  ○          if (_httpClient.BaseAddress == null)
 37  ❌ 0             {
 38  ❌ 0                 _httpClient.BaseAddress = EnsureTrailingSlash(resolvedOptions.BaseAddress);
 39  ❌ 0             }
 40           
 41                   // Update timeout if specified and different from default
 42  ❌ 0  ○          if (resolvedOptions.Timeout > TimeSpan.Zero && _httpClient.Timeout != resolvedOptions.Timeout)
 43  ❌ 0             {
 44  ❌ 0                 _httpClient.Timeout = resolvedOptions.Timeout;
 45  ❌ 0             }
 46  ❌ 0         }
 47           
 48               public async Task<IEnumerable<BusinessLocation>> GetNearbyBusinessesAsync(
 49                   double latitude,
 50                   double longitude,
 51                   int radiusMeters,
 52                   IEnumerable<string>? categories = null,
 53                   CancellationToken cancellationToken = default)
 54  ❌ 0         {
 55  ❌ 0             var requestUri = BuildNearbyUri(latitude, longitude, radiusMeters, categories);
 56  ❌ 0             return await SendCollectionRequestAsync(requestUri, cancellationToken);
 57  ❌ 0         }
 58           
 59               public async Task<BusinessLocation?> GetClosestBusinessAsync(
 60                   double latitude,
 61                   double longitude,
 62                   int maxDistanceMeters = 1000,
 63                   CancellationToken cancellationToken = default)
 64  ❌ 0         {
 65  ❌ 0             var requestUri = BuildClosestUri(latitude, longitude, maxDistanceMeters);
 66           
 67                   try
 68  ❌ 0             {
 69  ❌ 0                 using var response = await _httpClient.GetAsync(requestUri, cancellationToken);
 70           
 71  ❌ 0  ○              if (response.StatusCode == HttpStatusCode.NotFound)
 72  ❌ 0                 {
 73  ❌ 0                     return null;
 74                       }
 75           
 76  ❌ 0                 response.EnsureSuccessStatusCode();
 77  ❌ 0                 return await response.Content.ReadFromJsonAsync<BusinessLocation>(_serializerOptions, cancellationToken);
 78                   }
 79  ❌ 0             catch (Exception ex) when (ex is HttpRequestException or TaskCanceledException)
 80  ❌ 0             {
 81  ❌ 0                 _logger.LogError(ex, "Failed to fetch closest business from Location API.");
 82  ❌ 0                 return null;
 83                   }
 84  ❌ 0         }
 85           
 86               public async Task<string?> GetAddressAsync(
 87                   double latitude,
 88                   double longitude,
 89                   int maxDistanceMeters = 500,
 90                   CancellationToken cancellationToken = default)
 91  ❌ 0         {
 92                   // Try to get address from closest business first
 93  ❌ 0             var closestBusiness = await GetClosestBusinessAsync(
 94  ❌ 0                 latitude,
 95  ❌ 0                 longitude,
 96  ❌ 0                 maxDistanceMeters,
 97  ❌ 0                 cancellationToken);
 98           
 99  ❌ 0  ○          if (closestBusiness != null && !string.IsNullOrEmpty(closestBusiness.Address))
100  ❌ 0             {
101  ❌ 0                 return closestBusiness.Address;
102                   }
103           
104                   // Location API doesn't have a dedicated reverse geocoding endpoint yet
105                   // Return null to indicate address could not be determined
106                   // The OverpassLocationService implementation handles actual reverse geocoding
107  ❌ 0             return null;
108  ❌ 0         }
109           
110               /// <summary>
111               /// Updates the device location on the server.
112               /// </summary>
113               /// <param name="deviceId">Unique device identifier</param>
114               /// <param name="latitude">Device latitude</param>
115               /// <param name="longitude">Device longitude</param>
116               /// <param name="accuracyMeters">GPS accuracy in meters</param>
117               /// <param name="timestamp">Timestamp when location was captured</param>
118               /// <param name="cancellationToken">Cancellation token</param>
119               /// <returns>True if update was successful</returns>
120               public async Task<bool> UpdateDeviceLocationAsync(
121                   string deviceId,
122                   double latitude,
123                   double longitude,
124                   double? accuracyMeters = null,
125                   DateTimeOffset? timestamp = null,
126                   CancellationToken cancellationToken = default)
127  ❌ 0         {
128                   try
129  ❌ 0             {
130  ❌ 0  ○              var request = new
131  ❌ 0                 {
132  ❌ 0                     DeviceId = deviceId,
133  ❌ 0                     Latitude = latitude,
134  ❌ 0                     Longitude = longitude,
135  ❌ 0                     AccuracyMeters = accuracyMeters,
136  ❌ 0                     Timestamp = timestamp ?? DateTimeOffset.UtcNow
137  ❌ 0                 };
138           
139  ❌ 0                 using var response = await _httpClient.PostAsJsonAsync(
140  ❌ 0                     "api/locations/device",
141  ❌ 0                     request,
142  ❌ 0                     _serializerOptions,
143  ❌ 0                     cancellationToken);
144           
145  ❌ 0                 response.EnsureSuccessStatusCode();
146  ❌ 0                 return true;
147                   }
148  ❌ 0             catch (Exception ex) when (ex is HttpRequestException or TaskCanceledException)
149  ❌ 0             {
150  ❌ 0                 _logger.LogError(ex, "Failed to update device location");
151  ❌ 0                 return false;
152                   }
153  ❌ 0         }
154           
155               private async Task<IEnumerable<BusinessLocation>> SendCollectionRequestAsync(string requestUri, CancellationToken ca
156  ❌ 0         {
157                   try
158  ❌ 0             {
159  ❌ 0                 using var response = await _httpClient.GetAsync(requestUri, cancellationToken);
160  ❌ 0                 response.EnsureSuccessStatusCode();
161           
162  ❌ 0                 var locations = await response.Content.ReadFromJsonAsync<List<BusinessLocation>>(_serializerOptions, cancell
163  ❌ 0  ○              return locations ?? Enumerable.Empty<BusinessLocation>();
164                   }
165  ❌ 0             catch (Exception ex) when (ex is HttpRequestException or TaskCanceledException)
166  ❌ 0             {
167  ❌ 0                 _logger.LogError(ex, "Failed to fetch nearby businesses from Location API.");
168  ❌ 0                 return Enumerable.Empty<BusinessLocation>();
169                   }
170  ❌ 0         }
171           
172               private static string BuildNearbyUri(double latitude, double longitude, int radiusMeters, IEnumerable<string>? categ
173  ❌ 0         {
174  ❌ 0             var builder = new StringBuilder("api/locations/nearby?");
175  ❌ 0             AppendCoordinateParameters(builder, latitude, longitude);
176  ❌ 0             builder.Append("&radiusMeters=");
177  ❌ 0             builder.Append(radiusMeters.ToString(CultureInfo.InvariantCulture));
178           
179  ❌ 0  ○          if (categories != null)
180  ❌ 0             {
181  ❌ 0  ○              foreach (var category in categories.Where(c => !string.IsNullOrWhiteSpace(c)))
182  ❌ 0                 {
183  ❌ 0                     builder.Append("&categories=");
184  ❌ 0                     builder.Append(Uri.EscapeDataString(category));
185  ❌ 0                 }
186  ❌ 0             }
187           
188  ❌ 0             return builder.ToString();
189  ❌ 0         }
190           
191               private static string BuildClosestUri(double latitude, double longitude, int maxDistanceMeters)
192  ❌ 0         {
193  ❌ 0             var builder = new StringBuilder("api/locations/closest?");
194  ❌ 0             AppendCoordinateParameters(builder, latitude, longitude);
195  ❌ 0             builder.Append("&maxDistanceMeters=");
196  ❌ 0             builder.Append(maxDistanceMeters.ToString(CultureInfo.InvariantCulture));
197  ❌ 0             return builder.ToString();
198  ❌ 0         }
199           
200               private static void AppendCoordinateParameters(StringBuilder builder, double latitude, double longitude)
201  ❌ 0         {
202  ❌ 0             builder.Append("latitude=");
203  ❌ 0             builder.Append(latitude.ToString(CultureInfo.InvariantCulture));
204  ❌ 0             builder.Append("&longitude=");
205  ❌ 0             builder.Append(longitude.ToString(CultureInfo.InvariantCulture));
206  ❌ 0         }
207           
208               private static Uri EnsureTrailingSlash(string baseAddress)
209  ❌ 0         {
210  ❌ 0  ○          var formatted = baseAddress.EndsWith('/') ? baseAddress : baseAddress + "/";
211  ❌ 0             return new Uri(formatted, UriKind.Absolute);
212  ❌ 0         }
213           }
```
# FWH.Mobile.Services.LocationTrackingService

## Summary

|||
|:---|:---|
| Class: | FWH.Mobile.Services.LocationTrackingService |
| Assembly: | FWH.Mobile |
| **File(s):** | E:\github\FunWasHad\src\FWH.Mobile\FWH.Mobile\Services\LocationTrackingService.cs |
| **Line coverage:** | 53.5% (330 of 616) |
| Covered lines: | 330 |
| Uncovered lines: | 286 |
| Coverable lines: | 616 |
| Total lines: | 899 |
| **Branch coverage:** | 44.6% (83 of 186) |
| Covered branches: | 83 |
| Total branches: | 186 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **.ctor(...)** | 50.0% | 12 | 12 | 91.17% |
| **get_IsTracking()** | 100% | 2 | 2 | 100% |
| **get_LastKnownLocation()** | 100% | 2 | 1 | 0% |
| **get_CurrentMovementState()** | 100% | 2 | 1 | 0% |
| **get_CurrentSpeedMetersPerSecond()** | 100% | 2 | 1 | 0% |
| **get_CurrentSpeedMph()** | 100% | 2 | 2 | 100% |
| **get_CurrentSpeedKmh()** | 0% | 6 | 2 | 0% |
| **get_CurrentAddress()** | 100% | 2 | 1 | 0% |
| **get_MinimumDistanceMeters()** | 100% | 1 | 1 | 100% |
| **get_PollingInterval()** | 100% | 1 | 1 | 100% |
| **get_StationaryThresholdDuration()** | 100% | 1 | 1 | 100% |
| **get_StationaryDistanceThresholdMeters()** | 100% | 1 | 1 | 100% |
| **get_WalkingRidingSpeedThresholdMph()** | 100% | 1 | 1 | 100% |
| **get_StationaryAddressCheckDelay()** | 100% | 1 | 1 | 100% |
| **StartTrackingAsync()** | 75.00% | 9 | 8 | 80.0% |
| **<StartTrackingAsync()** | 100% | 7 | 6 | 75.75% |
| **StopTrackingAsync()** | 62.50% | 8 | 8 | 85.71% |
| **TrackLocationLoopAsync()** | 79.16% | 27 | 24 | 82.14% |
| **TrackMovement(...)** | 100% | 2 | 2 | 100% |
| **UpdateMovementState(...)** | 92.85% | 14 | 14 | 92.50% |
| **StartStationaryCountdown()** | 100% | 2 | 2 | 66.66% |
| **ResetStationaryCountdown()** | 100% | 2 | 2 | 100% |
| **CheckForAddressChangeAsync()** | 0% | 210 | 14 | 0% |
| **SaveStationaryPlaceAsync()** | 0% | 342 | 18 | 0% |
| **<SaveStationaryPlaceAsync()** | 0% | 6 | 2 | 0% |
| **<SaveStationaryPlaceAsync()** | 0% | 6 | 2 | 0% |
| **ExtractCityStateCountryFromAddress(...)** | 0% | 342 | 18 | 0% |
| **DetermineMovementState(...)** | 38.23% | 102 | 34 | 61.11% |
| **ShouldSendLocationUpdate(...)** | 100% | 2 | 2 | 100% |
| **SendLocationUpdateAsync()** | 75.00% | 4 | 4 | 100% |
| **OnNewLocationAddress()** | 0% | 6 | 2 | 0% |
| **Dispose()** | 100% | 2 | 1 | 0% |
| **Dispose(...)** | 0% | 42 | 6 | 0% |

## File(s)

### E:\github\FunWasHad\src\FWH.Mobile\FWH.Mobile\Services\LocationTrackingService.cs
```
  1             using FWH.Common.Location;
  2             using FWH.Common.Location.Models;
  3             using FWH.Mobile.Configuration;
  4             using FWH.Mobile.Data.Data;
  5             using FWH.Mobile.Data.Entities;
  6             using Microsoft.EntityFrameworkCore;
  7             using Microsoft.Extensions.Logging;
  8             using System;
  9             using System.Collections.Generic;
 10             using System.Globalization;
 11             using System.Linq;
 12             using System.Net.Http;
 13             using System.Net.Http.Json;
 14             using System.Threading;
 15             using System.Threading.Tasks;
 16             
 17             namespace FWH.Mobile.Services;
 18             
 19             /// <summary>
 20             /// Implementation of location tracking service that monitors device location
 21             /// and stores updates in local SQLite database (NOT sent to API).
 22             /// Also tracks movement state transitions (stationary ↔ walking ↔ riding).
 23             /// Monitors for address changes when device remains stationary.
 24             /// TR-MOBILE-001: Device location is tracked locally only, never sent to API.
 25             /// </summary>
 26             public class LocationTrackingService : ILocationTrackingService, IDisposable
 27             {
 28                 private readonly IGpsService _gpsService;
 29                 private readonly NotesDbContext _dbContext;
 30                 private readonly ILocationService _locationService;
 31                 private readonly LocationWorkflowService? _locationWorkflowService;
 32                 private readonly LocationSettings _locationSettings;
 33                 private readonly ILogger<LocationTrackingService> _logger;
 34                 private readonly IImageService? _imageService;
 35                 private readonly IThemeService? _themeService;
 36                 private readonly string _deviceId;
 37                 private CancellationTokenSource? _trackingCts;
 38                 private Task? _trackingTask;
 39                 private GpsCoordinates? _lastKnownLocation;
 40                 private GpsCoordinates? _lastReportedLocation;
 41             
 42                 // Movement state tracking
 43  ✔   15         private MovementState _currentMovementState = MovementState.Unknown;
 44  ✔   15         private DateTimeOffset _lastStateChangeTime = DateTimeOffset.UtcNow;
 45  ✔   15         private readonly Queue<(DateTimeOffset timestamp, double distance, double? speed)> _recentMovements = new();
 46                 private const int MaxRecentMovements = 10;
 47             
 48                 // Speed tracking
 49                 private double? _currentSpeedMetersPerSecond;
 50                 private DateTimeOffset? _lastLocationTime;
 51             
 52                 // Stationary address tracking
 53                 private CancellationTokenSource? _stationaryCountdownCts;
 54                 private string? _lastKnownAddress;
 55                 private GpsCoordinates? _stationaryLocationForAddressCheck;
 56             
 57  ✔   15         public LocationTrackingService(
 58  ✔   15             IGpsService gpsService,
 59  ✔   15             NotesDbContext dbContext,
 60  ✔   15             ILocationService locationService,
 61  ✔   15             LocationSettings locationSettings,
 62  ✔   15             ILogger<LocationTrackingService> logger,
 63  ✔   15             LocationWorkflowService? locationWorkflowService = null,
 64  ✔   15             IImageService? imageService = null,
 65  ✔   15             IThemeService? themeService = null)
 66  ✔   15         {
 67  ✓   15  ◑          _gpsService = gpsService ?? throw new ArgumentNullException(nameof(gpsService));
 68  ✓   15  ◑          _dbContext = dbContext ?? throw new ArgumentNullException(nameof(dbContext));
 69  ✓   15  ◑          _locationService = locationService ?? throw new ArgumentNullException(nameof(locationService));
 70  ✓   15  ◑          _locationSettings = locationSettings ?? throw new ArgumentNullException(nameof(locationSettings));
 71  ✓   15  ◑          _logger = logger ?? throw new ArgumentNullException(nameof(logger));
 72  ✔   15             _locationWorkflowService = locationWorkflowService;
 73  ✔   15             _imageService = imageService;
 74  ✔   15             _themeService = themeService;
 75             
 76  ✔   15             _deviceId = Guid.NewGuid().ToString();
 77             
 78  ✔   15             MinimumDistanceMeters = 50.0;
 79  ✔   15             PollingInterval = _locationSettings.GetPollingInterval();
 80  ✔   15             StationaryThresholdDuration = TimeSpan.FromMinutes(3);
 81  ✔   15             StationaryDistanceThresholdMeters = 10.0;
 82  ✔   15             WalkingRidingSpeedThresholdMph = 5.0;
 83  ✔   15             StationaryAddressCheckDelay = TimeSpan.FromMinutes(1);
 84             
 85                     // Subscribe to NewLocationAddress event to trigger workflow
 86  ✔   15             NewLocationAddress += OnNewLocationAddress;
 87             
 88  ✓   15  ◑          if (!_locationSettings.IsTrackingEnabled)
 89  ❌   0             {
 90  ❌   0                 _logger.LogWarning("Location tracking is configured as 'off' (PollingIntervalMode='off'). Tracking will be d
 91  ❌   0             }
 92  ✔   15         }
 93             
 94  ✔   28  ●      public bool IsTracking => _trackingTask != null && !_trackingTask.IsCompleted;
 95  ❌   0         public GpsCoordinates? LastKnownLocation => _lastKnownLocation;
 96  ❌   0         public MovementState CurrentMovementState => _currentMovementState;
 97  ❌   0         public double? CurrentSpeedMetersPerSecond => _currentSpeedMetersPerSecond;
 98  ✔   13  ●      public double? CurrentSpeedMph => _currentSpeedMetersPerSecond.HasValue
 99  ✔   13             ? GpsCalculator.MetersPerSecondToMph(_currentSpeedMetersPerSecond.Value)
100  ✔   13             : null;
101  ❌   0  ○      public double? CurrentSpeedKmh => _currentSpeedMetersPerSecond.HasValue
102  ❌   0             ? GpsCalculator.MetersPerSecondToKmh(_currentSpeedMetersPerSecond.Value)
103  ❌   0             : null;
104  ❌   0         public string? CurrentAddress => _lastKnownAddress;
105  ✔   51         public double MinimumDistanceMeters { get; set; }
106  ✔   69         public TimeSpan PollingInterval { get; set; }
107  ✔   54         public TimeSpan StationaryThresholdDuration { get; set; }
108  ✔   32         public double StationaryDistanceThresholdMeters { get; set; }
109  ✔   29         public double WalkingRidingSpeedThresholdMph { get; set; }
110  ✔   31         public TimeSpan StationaryAddressCheckDelay { get; set; }
111             
112                 public event EventHandler<GpsCoordinates>? LocationUpdated;
113                 public event EventHandler<Exception>? LocationUpdateFailed;
114                 public event EventHandler<MovementStateChangedEventArgs>? MovementStateChanged;
115                 public event EventHandler<LocationAddressChangedEventArgs>? NewLocationAddress;
116             
117                 public async Task StartTrackingAsync(CancellationToken cancellationToken = default)
118  ✔   12         {
119  ✓   12  ◑          if (IsTracking)
120  ❌   0             {
121  ❌   0                 _logger.LogWarning("Location tracking is already active");
122  ❌   0                 return;
123                     }
124             
125  ✓   12  ◑          if (!_locationSettings.IsTrackingEnabled)
126  ❌   0             {
127  ❌   0                 _logger.LogWarning("Location tracking is disabled (PollingIntervalMode='off'). Cannot start tracking.");
128  ❌   0                 return;
129                     }
130             
131  ✔   12  ●          if (!_gpsService.IsLocationAvailable)
132  ✔    2             {
133  ✔    2                 _logger.LogWarning("GPS service is not available");
134  ✔    2                 var hasPermission = await _gpsService.RequestLocationPermissionAsync();
135  ✔    2  ●              if (!hasPermission)
136  ✔    1                 {
137  ✔    1                     _logger.LogWarning("Location permission not yet granted, tracking will start when permission is availabl
138                             // Don't throw - allow tracking to start and it will work once permission is granted
139                             // The tracking loop will handle the case where location is not available
140  ✔    1                 }
141  ✔    2             }
142             
143  ✔   12             _logger.LogDebug("Starting location tracking with {Distance}m threshold and {Speed} mph walking/riding threshold
144  ✔   12                 MinimumDistanceMeters, WalkingRidingSpeedThresholdMph);
145             
146  ✔   12             _trackingCts = CancellationTokenSource.CreateLinkedTokenSource(cancellationToken);
147  ✔   12             _trackingTask = TrackLocationLoopAsync(_trackingCts.Token);
148             
149                     // Initialize with current location asynchronously (non-blocking)
150                     // Don't await this to prevent blocking UI thread during app startup
151  ✔   12             _ = Task.Run(async () =>
152  ✔   12             {
153  ✔   12                 try
154  ✔   12                 {
155  ✔   12                     // Use a shorter timeout for initial location to avoid ANR
156  ✔   12                     using var timeoutCts = new CancellationTokenSource(TimeSpan.FromSeconds(5));
157  ✔   12                     var initialLocation = await _gpsService.GetCurrentLocationAsync(timeoutCts.Token).ConfigureAwait(false);
158  ✔   12     
159  ✔   11  ●                  if (initialLocation != null && initialLocation.IsValid())
160  ✔   10                     {
161  ✔   10                         _lastKnownLocation = initialLocation;
162  ✔   10                         _lastReportedLocation = initialLocation;
163  ✔   10                         _lastLocationTime = initialLocation.Timestamp;
164  ✔   10                         _logger.LogInformation("Location tracking initialized with current location: {Latitude:F6}, {Longitu
165  ✔   10                             initialLocation.Latitude, initialLocation.Longitude);
166  ✔   12     
167  ✔   12                         // Trigger location updated event for initial location
168  ✔   10  ●                      LocationUpdated?.Invoke(this, initialLocation);
169  ✔   10                     }
170  ✔   12                     else
171  ✔    1                     {
172  ✔    1                         _logger.LogDebug("Could not get initial location, tracking loop will obtain it");
173  ✔    1                     }
174  ✔   11                 }
175  ✔    1                 catch (LocationServicesException ex)
176  ✔    1                 {
177  ✔    1                     _logger.LogWarning(ex,
178  ✔    1                         "Location service error during initialization. Platform: {Platform}, Operation: {Operation}. Trackin
179  ✔    1                         ex.Platform,
180  ✔    1                         ex.Operation);
181  ✔    1                 }
182  ❌   0                 catch (OperationCanceledException)
183  ❌   0                 {
184  ❌   0                     _logger.LogDebug("Initial location request timed out, tracking loop will obtain location");
185  ❌   0                 }
186  ❌   0                 catch (Exception ex)
187  ❌   0                 {
188  ❌   0                     _logger.LogDebug(ex, "Initial location request completed, tracking loop will obtain location");
189  ❌   0                 }
190  ✔   24             }, cancellationToken);
191  ✔   12         }
192             
193                 public async Task StopTrackingAsync()
194  ✔   12         {
195  ✓   12  ◑          if (!IsTracking)
196  ❌   0             {
197  ❌   0                 return;
198                     }
199             
200  ✔   12             _logger.LogDebug("Stopping location tracking");
201             
202  ✔   12             ResetStationaryCountdown();
203             
204  ✓   12  ◑          _trackingCts?.Cancel();
205             
206  ✔   12  ●          if (_trackingTask != null)
207  ✔   12             {
208                         try
209  ✔   12                 {
210  ✔   12                     await _trackingTask;
211  ❌   0                 }
212  ✔   12                 catch (OperationCanceledException)
213  ✔   12                 {
214                             // Expected when stopping
215  ✔   12                 }
216  ✔   12             }
217             
218  ✓   12  ◑          _trackingCts?.Dispose();
219  ✔   12             _trackingCts = null;
220  ✔   12             _trackingTask = null;
221             
222  ✔   12             _logger.LogDebug("Location tracking stopped");
223  ✔   12         }
224             
225                 private async Task TrackLocationLoopAsync(CancellationToken cancellationToken)
226  ✔   12         {
227  ✓   31  ◑          while (!cancellationToken.IsCancellationRequested)
228  ✔   31             {
229                         try
230  ✔   31                 {
231                             // Get current location
232  ✔   31                     var currentLocation = await _gpsService.GetCurrentLocationAsync(cancellationToken);
233             
234  ✔   30  ●                  if (currentLocation == null || !currentLocation.IsValid())
235  ✔    1                     {
236  ✔    1                         _logger.LogWarning("Failed to get valid GPS coordinates");
237  ✔    1                         await Task.Delay(PollingInterval, cancellationToken);
238  ❌   0                         continue;
239                             }
240             
241  ✔   29                     _lastKnownLocation = currentLocation;
242  ✔   29                     var currentTime = currentLocation.Timestamp;
243             
244                             // Use device's instant speed if available, otherwise calculate from distance/time
245  ✔   29                     double? speed = currentLocation.SpeedMetersPerSecond;
246             
247                             // Calculate distance from last known location
248  ✔   29                     double? distanceMoved = null;
249             
250  ✔   29  ●                  if (_lastReportedLocation != null && _lastLocationTime.HasValue)
251  ✔   19                     {
252  ✔   19                         distanceMoved = GpsCalculator.CalculateDistance(
253  ✔   19                             _lastReportedLocation.Latitude,
254  ✔   19                             _lastReportedLocation.Longitude,
255  ✔   19                             currentLocation.Latitude,
256  ✔   19                             currentLocation.Longitude);
257             
258                                 // If device didn't provide speed, calculate it from distance/time
259  ✔   19  ●                      if (!speed.HasValue)
260  ✔   19                         {
261  ✔   19                             speed = GpsCalculator.CalculateSpeed(
262  ✔   19                                 _lastReportedLocation.Latitude,
263  ✔   19                                 _lastReportedLocation.Longitude,
264  ✔   19                                 _lastLocationTime.Value,
265  ✔   19                                 currentLocation.Latitude,
266  ✔   19                                 currentLocation.Longitude,
267  ✔   19                                 currentTime);
268  ✔   19                         }
269             
270                                 // Update current speed tracking
271  ✔   19  ●                      if (speed.HasValue && speed.Value >= 0)
272  ✔    1                         {
273  ✔    1                             _currentSpeedMetersPerSecond = speed.Value;
274             
275  ✓    1  ◑                          _logger.LogDebug(
276  ✔    1                                 "Speed: {SpeedMph:F1} mph ({SpeedKmh:F1} km/h, {SpeedMs:F2} m/s) {Source}",
277  ✔    1                                 GpsCalculator.MetersPerSecondToMph(speed.Value),
278  ✔    1                                 GpsCalculator.MetersPerSecondToKmh(speed.Value),
279  ✔    1                                 speed.Value,
280  ✔    1                                 currentLocation.SpeedMetersPerSecond.HasValue ? "[device]" : "[calculated]");
281  ✔    1                         }
282             
283                                 // Track recent movements for state detection
284  ✔   19                         TrackMovement(currentTime, distanceMoved.Value, speed);
285             
286                                 // Detect and update movement state
287  ✔   19                         UpdateMovementState(distanceMoved.Value, speed);
288  ✔   19                     }
289                             else
290  ✔   10                     {
291                                 // First location reading
292  ✔   10                         _lastLocationTime = currentTime;
293  ✔   10                     }
294             
295                             // Check if we should send update
296  ✔   29  ●                  if (ShouldSendLocationUpdate(currentLocation))
297  ✔   11                     {
298  ✔   11                         await SendLocationUpdateAsync(currentLocation, cancellationToken);
299  ✔   11                         _lastLocationTime = currentTime;
300  ✔   11                     }
301             
302                             // Wait for next polling interval
303  ✔   29                     await Task.Delay(PollingInterval, cancellationToken);
304  ✔   19                 }
305  ✔   11                 catch (OperationCanceledException)
306  ✔   11                 {
307                             // Normal cancellation
308  ✔   11                     throw;
309                         }
310  ✔    1                 catch (LocationServicesException ex)
311  ✔    1                 {
312                             // Log detailed location service exception with all diagnostics
313  ✔    1                     _logger.LogError(ex,
314  ✔    1                         "Location service error in tracking loop. Platform: {Platform}, Operation: {Operation}, Diagnostics:
315  ✔    1                         ex.Platform,
316  ✔    1                         ex.Operation,
317  ✔    4                         string.Join(", ", ex.Diagnostics.Select(kvp => $"{kvp.Key}={kvp.Value}")));
318  ✓    1  ◑                  LocationUpdateFailed?.Invoke(this, ex);
319             
320                             // Wait before retrying
321                             try
322  ✔    1                     {
323  ✔    1                         await Task.Delay(PollingInterval, cancellationToken);
324  ❌   0                     }
325  ✔    1                     catch (OperationCanceledException)
326  ✔    1                     {
327  ✔    1                         throw;
328                             }
329  ❌   0                 }
330  ❌   0                 catch (Exception ex)
331  ❌   0                 {
332  ❌   0                     _logger.LogError(ex, "Error in location tracking loop");
333  ❌   0  ○                  LocationUpdateFailed?.Invoke(this, ex);
334             
335                             // Wait before retrying
336                             try
337  ❌   0                     {
338  ❌   0                         await Task.Delay(PollingInterval, cancellationToken);
339  ❌   0                     }
340  ❌   0                     catch (OperationCanceledException)
341  ❌   0                     {
342  ❌   0                         throw;
343                             }
344  ❌   0                 }
345  ✔   19             }
346  ❌   0         }
347             
348                 private void TrackMovement(DateTimeOffset timestamp, double distance, double? speed)
349  ✔   19         {
350                     // Add new movement data
351  ✔   19             _recentMovements.Enqueue((timestamp, distance, speed));
352             
353                     // Keep only recent movements
354  ✔   20  ●          while (_recentMovements.Count > MaxRecentMovements)
355  ✔    1             {
356  ✔    1                 _recentMovements.Dequeue();
357  ✔    1             }
358  ✔   19         }
359             
360                 private void UpdateMovementState(double distanceMoved, double? speed)
361  ✔   19         {
362  ✔   19             var newState = DetermineMovementState(distanceMoved, speed);
363             
364                     // Check if state has changed
365  ✔   19  ●          if (newState != _currentMovementState && newState != MovementState.Unknown)
366  ✔    2             {
367  ✔    2                 var previousState = _currentMovementState;
368  ✔    2                 var transitionTime = DateTimeOffset.UtcNow;
369  ✔    2                 var durationInPreviousState = transitionTime - _lastStateChangeTime;
370             
371  ✔    2                 _logger.LogInformation(
372  ✔    2                     "Movement state changed: {Previous} → {Current} (duration: {Duration:F0}s, distance: {Distance:F1}m, spe
373  ✔    2                     previousState,
374  ✔    2                     newState,
375  ✔    2                     durationInPreviousState.TotalSeconds,
376  ✔    2                     distanceMoved,
377  ✔    2                     CurrentSpeedMph ?? 0);
378             
379  ✔    2                 _currentMovementState = newState;
380  ✔    2                 _lastStateChangeTime = transitionTime;
381             
382                         // Handle stationary state transition
383  ✔    2  ●              if (newState == MovementState.Stationary)
384  ✔    1                 {
385  ✔    1                     StartStationaryCountdown();
386  ✔    1                 }
387  ✓    1  ◑              else if (previousState == MovementState.Stationary)
388  ❌   0                 {
389                             // Movement detected, cancel countdown
390  ❌   0                     ResetStationaryCountdown();
391  ❌   0                 }
392             
393                         // Raise state change event
394  ✔    2                 var eventArgs = new MovementStateChangedEventArgs(
395  ✔    2                     previousState,
396  ✔    2                     newState,
397  ✔    2                     transitionTime,
398  ✔    2                     distanceMoved,
399  ✔    2                     durationInPreviousState,
400  ✔    2                     _currentSpeedMetersPerSecond);
401             
402  ✔    2  ●              MovementStateChanged?.Invoke(this, eventArgs);
403  ✔    2             }
404  ✔   17  ●          else if (_currentMovementState == MovementState.Stationary && _stationaryCountdownCts != null)
405  ✔    7             {
406                         // Still stationary and countdown is active, reset it on any location change
407  ✔    7                     _logger.LogTrace("Location changed while stationary, resetting address check countdown");
408  ✔    7                 ResetStationaryCountdown();
409  ✔    7                 StartStationaryCountdown();
410  ✔    7             }
411  ✔   19         }
412             
413                 private void StartStationaryCountdown()
414  ✔    8         {
415                     // Cancel any existing countdown
416  ✔    8             ResetStationaryCountdown();
417             
418  ✔    8  ●          if (_lastKnownLocation == null)
419  ❌   0                 return;
420             
421  ✔    8             _logger.LogDebug("Device became stationary, starting {Delay} countdown for address change check",
422  ✔    8                 StationaryAddressCheckDelay);
423             
424  ✔    8             _stationaryLocationForAddressCheck = _lastKnownLocation;
425  ✔    8             _stationaryCountdownCts = new CancellationTokenSource();
426             
427                     // Start countdown task
428  ✔    8             _ = Task.Run(async () =>
429  ✔    8             {
430  ✔    8                 try
431  ✔    8                 {
432  ✔    8                     await Task.Delay(StationaryAddressCheckDelay, _stationaryCountdownCts.Token);
433  ✔    8     
434  ✔    8                     // Countdown expired, check for address change
435  ❌   0                     if (_stationaryLocationForAddressCheck != null)
436  ❌   0                     {
437  ❌   0                         await CheckForAddressChangeAsync(_stationaryLocationForAddressCheck);
438  ❌   0                     }
439  ❌   0                 }
440  ✔    8                 catch (OperationCanceledException)
441  ✔    8                 {
442  ✔    8                     _logger.LogDebug("Stationary countdown cancelled");
443  ✔    8                 }
444  ❌   0                 catch (Exception ex)
445  ❌   0                 {
446  ❌   0                     _logger.LogError(ex, "Error during stationary address check");
447  ❌   0                 }
448  ✔   16             }, _stationaryCountdownCts.Token);
449  ✔    8         }
450             
451                 private void ResetStationaryCountdown()
452  ✔   27         {
453  ✔   27  ●          if (_stationaryCountdownCts != null)
454  ✔    8             {
455  ✔    8                 _logger.LogDebug("Cancelling stationary address check countdown");
456  ✔    8                 _stationaryCountdownCts.Cancel();
457  ✔    8                 _stationaryCountdownCts.Dispose();
458  ✔    8                 _stationaryCountdownCts = null;
459  ✔    8                 _stationaryLocationForAddressCheck = null;
460  ✔    8             }
461  ✔   27         }
462             
463                 private async Task CheckForAddressChangeAsync(GpsCoordinates location)
464  ❌   0         {
465                     try
466  ❌   0             {
467  ❌   0                 _logger.LogDebug("Checking for address change at ({Lat:F6}, {Lon:F6})",
468  ❌   0                     location.Latitude, location.Longitude);
469             
470                         // Try to get address from location service (reverse geocoding)
471  ❌   0                 var currentAddress = await _locationService.GetAddressAsync(
472  ❌   0                     location.Latitude,
473  ❌   0                     location.Longitude,
474  ❌   0                     maxDistanceMeters: 500, // Check within 500m for address data
475  ❌   0                     cancellationToken: default);
476             
477                         // Try to get closest business
478  ❌   0                 BusinessLocation? closestBusiness = null;
479                         try
480  ❌   0                 {
481  ❌   0                     closestBusiness = await _locationService.GetClosestBusinessAsync(
482  ❌   0                         location.Latitude,
483  ❌   0                         location.Longitude,
484  ❌   0                         maxDistanceMeters: 100, // Check within 100m for businesses
485  ❌   0                         cancellationToken: default);
486  ❌   0                 }
487  ❌   0                 catch (Exception ex)
488  ❌   0                 {
489  ❌   0                     _logger.LogDebug(ex, "Error getting closest business, continuing without business info");
490  ❌   0                 }
491             
492                         // Fallback to coordinates if no address found
493  ❌   0  ○              if (string.IsNullOrEmpty(currentAddress))
494  ❌   0                 {
495  ❌   0                     currentAddress = $"{location.Latitude:F6}, {location.Longitude:F6}";
496  ❌   0                     _logger.LogDebug("No address found, using coordinates as fallback");
497  ❌   0                 }
498             
499  ❌   0  ○              _logger.LogTrace("Current address: {Address}, Previous address: {PreviousAddress}",
500  ❌   0                     currentAddress, _lastKnownAddress ?? "none");
501             
502                         // Check if address has changed
503  ❌   0  ○              if (_lastKnownAddress != currentAddress)
504  ❌   0                 {
505  ❌   0  ○                  _logger.LogInformation("Address changed: {Previous} → {Current}",
506  ❌   0                         _lastKnownAddress ?? "none", currentAddress);
507             
508  ❌   0                     var eventArgs = new LocationAddressChangedEventArgs(
509  ❌   0                         _lastKnownAddress,
510  ❌   0                         currentAddress,
511  ❌   0                         location,
512  ❌   0                         DateTimeOffset.UtcNow);
513             
514  ❌   0                     _lastKnownAddress = currentAddress;
515             
516                             // Raise event
517  ❌   0  ○                  NewLocationAddress?.Invoke(this, eventArgs);
518  ❌   0                 }
519                         else
520  ❌   0                 {
521  ❌   0                     _logger.LogDebug("Address unchanged: {Address}", currentAddress);
522  ❌   0                 }
523             
524                         // Save place where user became stationary (only if address changed or this is first time)
525  ❌   0  ○              if (_lastKnownAddress != currentAddress || _lastKnownAddress == null)
526  ❌   0                 {
527  ❌   0                     await SaveStationaryPlaceAsync(location, currentAddress, closestBusiness);
528  ❌   0                 }
529  ❌   0             }
530  ❌   0             catch (Exception ex)
531  ❌   0             {
532  ❌   0                 _logger.LogError(ex, "Error checking for address change");
533  ❌   0             }
534  ❌   0         }
535             
536                 private async Task SaveStationaryPlaceAsync(
537                     GpsCoordinates location,
538                     string address,
539                     BusinessLocation? business)
540  ❌   0         {
541                     try
542  ❌   0             {
543  ❌   0                 var place = new StationaryPlaceEntity
544  ❌   0                 {
545  ❌   0                     DeviceId = _deviceId,
546  ❌   0                     Latitude = location.Latitude,
547  ❌   0                     Longitude = location.Longitude,
548  ❌   0                     Address = address,
549  ❌   0                     StationaryAt = DateTimeOffset.UtcNow,
550  ❌   0                     CreatedAt = DateTimeOffset.UtcNow
551  ❌   0                 };
552             
553                         // Add business information if available
554  ❌   0  ○              if (business != null)
555  ❌   0                 {
556  ❌   0                     place.BusinessName = business.Name;
557  ❌   0                     place.Category = business.Category;
558                             // Use business address if available, otherwise use the resolved address
559  ❌   0  ○                  if (!string.IsNullOrEmpty(business.Address))
560  ❌   0                     {
561  ❌   0                         place.Address = business.Address;
562  ❌   0                     }
563  ❌   0                 }
564             
565  ❌   0                 _dbContext.StationaryPlaces.Add(place);
566  ❌   0                 await _dbContext.SaveChangesAsync();
567             
568  ❌   0  ○              _logger.LogInformation("Saved stationary place: {BusinessName} at {Address}",
569  ❌   0                     place.BusinessName ?? "Unknown", place.Address);
570             
571                         // Apply business theme if available (only when business has an Id, e.g. from Marketing DB)
572  ❌   0  ○              if (business != null && business.Id != null && _themeService != null)
573  ❌   0                 {
574  ❌   0                     var businessId = business.Id.Value;
575  ❌   0                     _ = Task.Run(async () =>
576  ❌   0                     {
577  ❌   0                         try
578  ❌   0                         {
579  ❌   0                             var applied = await _themeService.ApplyBusinessThemeAsync(businessId);
580  ❌   0  ○                          if (applied)
581  ❌   0                             {
582  ❌   0                                 _logger.LogInformation("Applied business theme for business {BusinessId}", businessId);
583  ❌   0                             }
584  ❌   0                         }
585  ❌   0                         catch (Exception ex)
586  ❌   0                         {
587  ❌   0                             _logger.LogWarning(ex, "Failed to apply business theme for business {BusinessId}", businessId);
588  ❌   0                         }
589  ❌   0                     });
590  ❌   0                 }
591  ❌   0  ○              else if (business == null && _themeService != null)
592  ❌   0                 {
593                             // No business detected, check for city theme
594  ❌   0                     var (city, state, country) = ExtractCityStateCountryFromAddress(address);
595  ❌   0  ○                  if (!string.IsNullOrEmpty(city))
596  ❌   0                     {
597  ❌   0                         _ = Task.Run(async () =>
598  ❌   0                         {
599  ❌   0                             try
600  ❌   0                             {
601  ❌   0                                 var applied = await _themeService.ApplyCityThemeAsync(city, state, country);
602  ❌   0  ○                              if (applied)
603  ❌   0                                 {
604  ❌   0                                     _logger.LogInformation("Applied city theme for city {CityName}", city);
605  ❌   0                                 }
606  ❌   0                             }
607  ❌   0                             catch (Exception ex)
608  ❌   0                             {
609  ❌   0                                 _logger.LogWarning(ex, "Failed to apply city theme for city {CityName}", city);
610  ❌   0                             }
611  ❌   0                         });
612  ❌   0                     }
613  ❌   0                 }
614  ❌   0             }
615  ❌   0             catch (Exception ex)
616  ❌   0             {
617  ❌   0                 _logger.LogError(ex, "Error saving stationary place");
618  ❌   0             }
619  ❌   0         }
620             
621                 /// <summary>
622                 /// Extracts city, state, and country from an address string.
623                 /// </summary>
624                 private static (string? city, string? state, string? country) ExtractCityStateCountryFromAddress(string address)
625  ❌   0         {
626  ❌   0  ○          if (string.IsNullOrWhiteSpace(address))
627  ❌   0                 return (null, null, null);
628             
629                     // Simple parsing: look for common patterns
630                     // Format: "Street, City, State Country" or "Street, City, State, Country"
631  ❌   0             var parts = address.Split(',', StringSplitOptions.RemoveEmptyEntries | StringSplitOptions.TrimEntries);
632             
633  ❌   0  ○          if (parts.Length < 2)
634  ❌   0                 return (null, null, null);
635             
636                     // Last part might be "State Country" or just "Country"
637  ❌   0             var lastPart = parts[^1];
638  ❌   0  ○          var secondLastPart = parts.Length >= 3 ? parts[^2] : null;
639             
640  ❌   0             string? city = null;
641  ❌   0             string? state = null;
642  ❌   0             string? country = null;
643             
644                     // Try to extract city (usually second-to-last or third-to-last)
645  ❌   0  ○          if (parts.Length >= 2)
646  ❌   0             {
647  ❌   0                 city = parts[^2];
648  ❌   0             }
649             
650                     // Try to extract state and country from last part
651  ❌   0             var lastPartWords = lastPart.Split(' ', StringSplitOptions.RemoveEmptyEntries);
652  ❌   0  ○          if (lastPartWords.Length >= 2)
653  ❌   0             {
654                         // Assume format: "State Country"
655  ❌   0                 state = string.Join(" ", lastPartWords.Take(lastPartWords.Length - 1));
656  ❌   0                 country = lastPartWords[^1];
657  ❌   0             }
658  ❌   0  ○          else if (lastPartWords.Length == 1)
659  ❌   0             {
660                         // Could be either state or country - assume country if it's a known country code/name
661  ❌   0                 var possibleCountry = lastPartWords[0];
662  ❌   0  ○              if (possibleCountry.Length == 2 || possibleCountry.Equals("USA", StringComparison.OrdinalIgnoreCase) ||
663  ❌   0                     possibleCountry.Equals("United States", StringComparison.OrdinalIgnoreCase))
664  ❌   0                 {
665  ❌   0                     country = possibleCountry;
666  ❌   0                 }
667                         else
668  ❌   0                 {
669  ❌   0                     state = possibleCountry;
670  ❌   0                 }
671  ❌   0             }
672             
673  ❌   0             return (city, state, country);
674  ❌   0         }
675             
676                 private MovementState DetermineMovementState(double currentDistance, double? currentSpeed)
677  ✔   19         {
678  ✓   19  ◑          if (_recentMovements.Count == 0)
679  ❌   0             {
680  ❌   0                 return MovementState.Unknown;
681                     }
682             
683                     // Get movements within the stationary threshold duration
684  ✔   19             var thresholdTime = DateTimeOffset.UtcNow - StationaryThresholdDuration;
685  ✔   19             var recentMovementsInWindow = _recentMovements
686  ✔  101                 .Where(m => m.timestamp >= thresholdTime)
687  ✔   19                 .ToList();
688             
689                     // Need sufficient data points to make determination
690  ✔   19             var requiredSamples = Math.Max(3, (int)(StationaryThresholdDuration.TotalSeconds / PollingInterval.TotalSeconds)
691  ✔   19  ●          if (recentMovementsInWindow.Count < requiredSamples)
692  ✔   11             {
693                         // Not enough data yet, but check if currently moving with valid speed
694  ✔   11  ●              if (currentSpeed.HasValue && currentDistance >= MinimumDistanceMeters)
695  ✔    1                 {
696  ✔    1                     var speedMph = GpsCalculator.MetersPerSecondToMph(currentSpeed.Value);
697  ✓    1  ◑                  if (speedMph >= WalkingRidingSpeedThresholdMph)
698  ❌   0                     {
699  ❌   0                         return MovementState.Riding;
700                             }
701  ✓    1  ◑                  else if (speedMph > 0)
702  ✔    1                     {
703  ✔    1                         return MovementState.Walking;
704                             }
705  ❌   0                 }
706             
707  ✔   10                 return _currentMovementState;
708                     }
709             
710                     // Calculate statistics
711  ✔   67             var avgDistance = recentMovementsInWindow.Average(m => m.distance);
712  ✔   67             var maxDistance = recentMovementsInWindow.Max(m => m.distance);
713             
714                     // Calculate average speed from movements with speed data
715  ✔   67             var movementsWithSpeed = recentMovementsInWindow.Where(m => m.speed.HasValue).ToList();
716  ✓    8  ◑          double? avgSpeed = movementsWithSpeed.Any()
717  ❌   0                 ? movementsWithSpeed.Average(m => m.speed!.Value)
718  ✔    8                 : null;
719             
720  ✓    8  ◑          _logger.LogDebug(
721  ✔    8                 "Movement analysis: avg={AvgDist:F1}m, max={MaxDist:F1}m, avgSpeed={AvgSpeed:F2} m/s ({AvgSpeedMph:F1} mph),
722  ✔    8                 avgDistance,
723  ✔    8                 maxDistance,
724  ✔    8                 avgSpeed ?? 0,
725  ✔    8                 avgSpeed.HasValue ? GpsCalculator.MetersPerSecondToMph(avgSpeed.Value) : 0,
726  ✔    8                 recentMovementsInWindow.Count);
727             
728                     // Determine state based on movement patterns and speed
729             
730                     // Check for stationary state
731  ✓    8  ◑          if (maxDistance < StationaryDistanceThresholdMeters && avgDistance < StationaryDistanceThresholdMeters / 2)
732  ✔    8             {
733  ✔    8                 return MovementState.Stationary;
734                     }
735             
736                     // Check for continuous motion (walking or riding)
737  ❌   0  ○          if (currentDistance >= MinimumDistanceMeters || avgDistance >= StationaryDistanceThresholdMeters * 2 || maxDista
738  ❌   0             {
739                         // Device is moving, now determine if walking or riding based on speed
740  ❌   0  ○              double? speedToCheck = currentSpeed ?? avgSpeed;
741             
742  ❌   0  ○              if (speedToCheck.HasValue)
743  ❌   0                 {
744  ❌   0                     var speedMph = GpsCalculator.MetersPerSecondToMph(speedToCheck.Value);
745             
746  ❌   0  ○                  if (speedMph >= WalkingRidingSpeedThresholdMph)
747  ❌   0                     {
748  ❌   0                         return MovementState.Riding;
749                             }
750  ❌   0  ○                  else if (speedMph > 0)
751  ❌   0                     {
752  ❌   0                         return MovementState.Walking;
753                             }
754  ❌   0                 }
755             
756                         // Speed not available or invalid, use legacy Moving state
757  ❌   0                 return MovementState.Moving;
758                     }
759             
760                     // Maintain current state if unclear
761  ❌   0             return _currentMovementState;
762  ✔   19         }
763             
764                 private bool ShouldSendLocationUpdate(GpsCoordinates currentLocation)
765  ✔   29         {
766                     // Always send first location
767  ✔   29  ●          if (_lastReportedLocation == null)
768  ✔   10             {
769  ✔   10                 return true;
770                     }
771             
772                     // Calculate distance from last reported location
773  ✔   19             var distance = GpsCalculator.CalculateDistance(
774  ✔   19                 _lastReportedLocation.Latitude,
775  ✔   19                 _lastReportedLocation.Longitude,
776  ✔   19                 currentLocation.Latitude,
777  ✔   19                 currentLocation.Longitude);
778             
779  ✔   19             _logger.LogDebug("Distance from last reported location: {Distance:F2}m", distance);
780             
781  ✔   19             return distance >= MinimumDistanceMeters;
782  ✔   29         }
783             
784                 private async Task SendLocationUpdateAsync(GpsCoordinates location, CancellationToken cancellationToken)
785  ✔   11         {
786                     try
787  ✔   11             {
788  ✔   11                 _logger.LogDebug(
789  ✔   11                     "Storing location locally: ({Lat:F6}, {Lon:F6}) - State: {State}, Speed: {Speed:F1} mph",
790  ✔   11                     location.Latitude,
791  ✔   11                     location.Longitude,
792  ✔   11                     _currentMovementState,
793  ✔   11                     CurrentSpeedMph ?? 0);
794             
795                         // Store location in local SQLite database (never sent to API)
796  ✔   11                 var locationEntity = new DeviceLocationEntity
797  ✔   11                 {
798  ✔   11                     DeviceId = _deviceId,
799  ✔   11                     Latitude = location.Latitude,
800  ✔   11                     Longitude = location.Longitude,
801  ✔   11                     AccuracyMeters = location.AccuracyMeters,
802  ✔   11                     AltitudeMeters = location.AltitudeMeters,
803  ✔   11                     SpeedMetersPerSecond = _currentSpeedMetersPerSecond,
804  ✔   11                     HeadingDegrees = null, // Heading not available in GpsCoordinates
805  ✔   11                     MovementState = _currentMovementState.ToString(),
806  ✔   11                     Timestamp = location.Timestamp,
807  ✔   11                     CreatedAt = DateTimeOffset.UtcNow
808  ✔   11                 };
809             
810  ✔   11                 await _dbContext.DeviceLocationHistory.AddAsync(locationEntity, cancellationToken);
811  ✔   10                 await _dbContext.SaveChangesAsync(cancellationToken);
812             
813  ✔   10                 _logger.LogDebug("Location stored locally (ID: {LocationId})", locationEntity.Id);
814  ✔   10                 _lastReportedLocation = location;
815  ✔   10  ●              LocationUpdated?.Invoke(this, location);
816  ✔   10             }
817  ✔    1             catch (Exception ex)
818  ✔    1             {
819  ✔    1                 _logger.LogError(ex, "Failed to store location locally");
820  ✓    1  ◑              LocationUpdateFailed?.Invoke(this, ex);
821  ✔    1             }
822  ✔   11         }
823             
824                 private async void OnNewLocationAddress(object? sender, LocationAddressChangedEventArgs e)
825  ❌   0         {
826                     try
827  ❌   0             {
828  ❌   0                 _logger.LogDebug("NewLocationAddress event: {Address}", e.CurrentAddress);
829             
830  ❌   0  ○              if (_locationWorkflowService != null)
831  ❌   0                 {
832  ❌   0                     await _locationWorkflowService.HandleNewLocationAddressAsync(e);
833  ❌   0                 }
834                         else
835  ❌   0                 {
836  ❌   0                     _logger.LogWarning("LocationWorkflowService not available, cannot start location workflow");
837  ❌   0                 }
838  ❌   0             }
839  ❌   0             catch (Exception ex)
840  ❌   0             {
841  ❌   0                 _logger.LogError(ex, "Error handling NewLocationAddress event");
842  ❌   0             }
843  ❌   0         }
844             
845                 /// <summary>
846                 /// Disposes of all resources, ensuring proper cleanup of CancellationTokenSource instances.
847                 /// </summary>
848                 public void Dispose()
849  ❌   0         {
850  ❌   0             Dispose(true);
851  ❌   0             GC.SuppressFinalize(this);
852  ❌   0         }
853             
854                 /// <summary>
855                 /// Protected dispose method to handle resource cleanup.
856                 /// </summary>
857                 /// <param name="disposing">True if called from Dispose(), false if from finalizer</param>
858                 protected virtual void Dispose(bool disposing)
859  ❌   0         {
860  ❌   0  ○          if (disposing)
861  ❌   0             {
862                         // Stop tracking if still active
863  ❌   0  ○              if (IsTracking)
864  ❌   0                 {
865                             try
866  ❌   0                     {
867                                 // Use synchronous wait with timeout to avoid blocking indefinitely
868  ❌   0                         var stopTask = Task.Run(async () => await StopTrackingAsync());
869  ❌   0                         stopTask.Wait(TimeSpan.FromSeconds(5));
870  ❌   0                     }
871  ❌   0                     catch (Exception ex)
872  ❌   0                     {
873  ❌   0                         _logger.LogWarning(ex, "Error stopping tracking during disposal");
874  ❌   0                     }
875  ❌   0                 }
876             
877                         // Ensure stationary countdown is reset
878  ❌   0                 ResetStationaryCountdown();
879             
880                         // Dispose tracking cancellation token source if still exists
881  ❌   0  ○              if (_trackingCts != null)
882  ❌   0                 {
883                             try
884  ❌   0                     {
885  ❌   0                         _trackingCts.Cancel();
886  ❌   0                         _trackingCts.Dispose();
887  ❌   0                     }
888  ❌   0                     catch (Exception ex)
889  ❌   0                     {
890  ❌   0                         _logger.LogWarning(ex, "Error disposing tracking cancellation token source");
891  ❌   0                     }
892                             finally
893  ❌   0                     {
894  ❌   0                         _trackingCts = null;
895  ❌   0                     }
896  ❌   0                 }
897  ❌   0             }
898  ❌   0         }
899             }
```
# FWH.Mobile.Services.LocationWorkflowService

## Summary

|||
|:---|:---|
| Class: | FWH.Mobile.Services.LocationWorkflowService |
| Assembly: | FWH.Mobile |
| **File(s):** | E:\github\FunWasHad\src\FWH.Mobile\FWH.Mobile\Services\LocationWorkflowService.cs |
| **Line coverage:** | 0% (0 of 134) |
| Covered lines: | 0 |
| Uncovered lines: | 134 |
| Coverable lines: | 134 |
| Total lines: | 231 |
| **Branch coverage:** | 0% (0 of 38) |
| Covered branches: | 0 |
| Total branches: | 38 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **.cctor()** | 100% | 2 | 1 | 0% |
| **.ctor(...)** | 0% | 42 | 6 | 0% |
| **HandleNewLocationAddressAsync()** | 0% | 20 | 4 | 0% |
| **GenerateAddressHash(...)** | 100% | 2 | 1 | 0% |
| **SetWorkflowVariablesAsync()** | 0% | 6 | 2 | 0% |
| **LoadLocationWorkflowFileAsync()** | 0% | 702 | 26 | 0% |

## File(s)

### E:\github\FunWasHad\src\FWH.Mobile\FWH.Mobile\Services\LocationWorkflowService.cs
```
  1           using System;
  2           using System.IO;
  3           using System.Linq;
  4           using System.Security.Cryptography;
  5           using System.Text;
  6           using System.Threading.Tasks;
  7           using FWH.Common.Location.Models;
  8           using FWH.Common.Workflow;
  9           using FWH.Mobile.Data.Repositories;
 10           using Microsoft.Extensions.Logging;
 11           
 12           namespace FWH.Mobile.Services;
 13           
 14           /// <summary>
 15           /// Service that manages location-based workflow instances.
 16           /// Handles creation, retrieval, and state management of workflows triggered by address changes.
 17           /// </summary>
 18           public class LocationWorkflowService
 19           {
 20               private readonly IWorkflowService _workflowService;
 21               private readonly IWorkflowRepository _workflowRepository;
 22               private readonly ILogger<LocationWorkflowService> _logger;
 23               private const string LocationWorkflowFileKey = "new-location.puml";
 24               private const int AddressTimeWindowHours = 24;
 25           
 26               // Cache for workflow file content to avoid repeated file I/O
 27               private static string? _cachedWorkflowContent;
 28  ❌ 0         private static readonly object _cacheLock = new object();
 29           
 30  ❌ 0         public LocationWorkflowService(
 31  ❌ 0             IWorkflowService workflowService,
 32  ❌ 0             IWorkflowRepository workflowRepository,
 33  ❌ 0             ILogger<LocationWorkflowService> logger)
 34  ❌ 0         {
 35  ❌ 0  ○          _workflowService = workflowService ?? throw new ArgumentNullException(nameof(workflowService));
 36  ❌ 0  ○          _workflowRepository = workflowRepository ?? throw new ArgumentNullException(nameof(workflowRepository));
 37  ❌ 0  ○          _logger = logger ?? throw new ArgumentNullException(nameof(logger));
 38  ❌ 0         }
 39           
 40               /// <summary>
 41               /// Handles a new location address event by starting or resuming appropriate workflow.
 42               /// </summary>
 43               /// <param name="eventArgs">Event arguments containing address and location information</param>
 44               public async Task HandleNewLocationAddressAsync(LocationAddressChangedEventArgs eventArgs)
 45  ❌ 0         {
 46                   try
 47  ❌ 0             {
 48  ❌ 0                 _logger.LogInformation("Handling new location address: {Address}", eventArgs.CurrentAddress);
 49           
 50                       // Generate workflow ID based on address hash
 51  ❌ 0                 var addressHash = GenerateAddressHash(eventArgs.CurrentAddress);
 52  ❌ 0                 var workflowId = $"location:{addressHash}";
 53           
 54                       // Check for existing workflow within 24-hour window
 55  ❌ 0                 var since = DateTimeOffset.UtcNow.AddHours(-AddressTimeWindowHours);
 56  ❌ 0                 var existingWorkflows = await _workflowRepository.FindByNamePatternAsync(
 57  ❌ 0                     workflowId,
 58  ❌ 0                     since);
 59           
 60  ❌ 0                 var existingWorkflow = existingWorkflows.FirstOrDefault();
 61           
 62  ❌ 0  ○              if (existingWorkflow != null)
 63  ❌ 0                 {
 64  ❌ 0                     _logger.LogInformation(
 65  ❌ 0                         "Found existing workflow {WorkflowId} for address {Address}, resuming from node {NodeId}",
 66  ❌ 0                         existingWorkflow.Id,
 67  ❌ 0                         eventArgs.CurrentAddress,
 68  ❌ 0                         existingWorkflow.CurrentNodeId);
 69           
 70                           // Resume existing workflow
 71  ❌ 0                     await _workflowService.StartInstanceAsync(existingWorkflow.Id);
 72  ❌ 0                 }
 73                       else
 74  ❌ 0                 {
 75  ❌ 0                     _logger.LogInformation(
 76  ❌ 0                         "No recent workflow found for address {Address}, starting new workflow {WorkflowId}",
 77  ❌ 0                         eventArgs.CurrentAddress,
 78  ❌ 0                         workflowId);
 79           
 80                           // Load workflow definition
 81  ❌ 0                     var pumlContent = await LoadLocationWorkflowFileAsync();
 82  ❌ 0  ○                  if (string.IsNullOrEmpty(pumlContent))
 83  ❌ 0                     {
 84  ❌ 0                         _logger.LogWarning("Failed to load {FileName}, cannot start location workflow", LocationWorkflowFile
 85  ❌ 0                         return;
 86                           }
 87           
 88                           // Import and start new workflow with address-specific variables
 89  ❌ 0                     var workflow = await _workflowService.ImportWorkflowAsync(
 90  ❌ 0                         pumlContent,
 91  ❌ 0                         workflowId,
 92  ❌ 0                         $"Location: {eventArgs.CurrentAddress}");
 93           
 94                           // Set workflow variables
 95  ❌ 0                     await SetWorkflowVariablesAsync(workflow.Id, eventArgs);
 96           
 97  ❌ 0                     _logger.LogInformation(
 98  ❌ 0                         "Started new location workflow {WorkflowId} for address {Address}",
 99  ❌ 0                         workflow.Id,
100  ❌ 0                         eventArgs.CurrentAddress);
101  ❌ 0                 }
102  ❌ 0             }
103  ❌ 0             catch (Exception ex)
104  ❌ 0             {
105  ❌ 0                 _logger.LogError(ex, "Error handling new location address: {Address}", eventArgs.CurrentAddress);
106  ❌ 0             }
107  ❌ 0         }
108           
109               /// <summary>
110               /// Generates a consistent hash for an address to use as workflow key.
111               /// </summary>
112               private static string GenerateAddressHash(string address)
113  ❌ 0         {
114  ❌ 0             using var sha256 = SHA256.Create();
115  ❌ 0             var hashBytes = sha256.ComputeHash(Encoding.UTF8.GetBytes(address));
116  ❌ 0             return Convert.ToHexString(hashBytes).Substring(0, 16).ToLowerInvariant();
117  ❌ 0         }
118           
119               /// <summary>
120               /// Sets initial variables for a location workflow instance.
121               /// </summary>
122               private async Task SetWorkflowVariablesAsync(string workflowId, LocationAddressChangedEventArgs eventArgs)
123  ❌ 0         {
124                   // Note: Variable setting would require extension to workflow system
125                   // For now, log the variables that should be set
126  ❌ 0  ○          _logger.LogDebug(
127  ❌ 0                 "Workflow {WorkflowId} variables: address={Address}, lat={Lat}, lon={Lon}, previous={Previous}, timestamp={T
128  ❌ 0                 workflowId,
129  ❌ 0                 eventArgs.CurrentAddress,
130  ❌ 0                 eventArgs.Location.Latitude,
131  ❌ 0                 eventArgs.Location.Longitude,
132  ❌ 0                 eventArgs.PreviousAddress ?? "none",
133  ❌ 0                 eventArgs.Timestamp);
134           
135                   // TODO: Once workflow variable system is implemented, set:
136                   // - address: eventArgs.CurrentAddress
137                   // - latitude: eventArgs.Location.Latitude
138                   // - longitude: eventArgs.Location.Longitude
139                   // - previous_address: eventArgs.PreviousAddress
140                   // - timestamp: eventArgs.Timestamp
141                   // - is_first_visit: (eventArgs.PreviousAddress == null)
142           
143  ❌ 0             await Task.CompletedTask;
144  ❌ 0         }
145           
146               /// <summary>
147               /// Loads the new-location.puml file from platform-specific location.
148               /// Uses caching to avoid repeated file I/O operations.
149               /// </summary>
150               private async Task<string?> LoadLocationWorkflowFileAsync()
151  ❌ 0         {
152                   // Return cached content if available
153  ❌ 0             lock (_cacheLock)
154  ❌ 0             {
155  ❌ 0  ○              if (_cachedWorkflowContent != null)
156  ❌ 0                 {
157  ❌ 0                     _logger.LogDebug("Using cached workflow file content");
158  ❌ 0                     return _cachedWorkflowContent;
159                       }
160  ❌ 0             }
161           
162  ❌ 0             string? content = null;
163           
164                   // For Android, try loading from assets first
165  ❌ 0  ○          if (OperatingSystem.IsAndroid())
166  ❌ 0             {
167                       try
168  ❌ 0                 {
169  ❌ 0                     var contextType = Type.GetType("Android.App.Application, Mono.Android");
170  ❌ 0  ○                  var contextProperty = contextType?.GetProperty("Context");
171  ❌ 0  ○                  var context = contextProperty?.GetValue(null);
172           
173  ❌ 0  ○                  var assetsProperty = context?.GetType().GetProperty("Assets");
174  ❌ 0  ○                  var assets = assetsProperty?.GetValue(context);
175           
176  ❌ 0  ○                  var openMethod = assets?.GetType().GetMethod("Open", new[] { typeof(string) });
177  ❌ 0  ○                  var stream = openMethod?.Invoke(assets, new object[] { LocationWorkflowFileKey }) as Stream;
178           
179  ❌ 0  ○                  if (stream != null)
180  ❌ 0                     {
181  ❌ 0                         using (stream)
182  ❌ 0                         using (var reader = new StreamReader(stream))
183  ❌ 0                         {
184  ❌ 0                             content = await reader.ReadToEndAsync();
185  ❌ 0                         }
186  ❌ 0                     }
187  ❌ 0                 }
188  ❌ 0                 catch (Exception ex)
189  ❌ 0                 {
190  ❌ 0                     _logger.LogWarning(ex, "Failed to load {FileName} from Android assets", LocationWorkflowFileKey);
191  ❌ 0                 }
192  ❌ 0             }
193           
194                   // For other platforms, try file system if not loaded from assets
195  ❌ 0  ○          if (content == null)
196  ❌ 0             {
197                       try
198  ❌ 0                 {
199  ❌ 0                     var currentDir = Directory.GetCurrentDirectory();
200  ❌ 0                     var pumlPath = Path.Combine(currentDir, LocationWorkflowFileKey);
201           
202  ❌ 0  ○                  if (!File.Exists(pumlPath))
203  ❌ 0                     {
204  ❌ 0                         var baseDir = AppDomain.CurrentDomain.BaseDirectory;
205  ❌ 0                         pumlPath = Path.Combine(baseDir, LocationWorkflowFileKey);
206  ❌ 0                     }
207           
208  ❌ 0  ○                  if (File.Exists(pumlPath))
209  ❌ 0                     {
210  ❌ 0                         content = await File.ReadAllTextAsync(pumlPath);
211  ❌ 0                     }
212  ❌ 0                 }
213  ❌ 0                 catch (Exception ex)
214  ❌ 0                 {
215  ❌ 0                     _logger.LogWarning(ex, "Failed to load {FileName} from file system", LocationWorkflowFileKey);
216  ❌ 0                 }
217  ❌ 0             }
218           
219                   // Cache the content if successfully loaded
220  ❌ 0  ○          if (content != null)
221  ❌ 0             {
222  ❌ 0                 lock (_cacheLock)
223  ❌ 0                 {
224  ❌ 0                     _cachedWorkflowContent = content;
225  ❌ 0                     _logger.LogDebug("Cached workflow file content (length: {Length} chars)", content.Length);
226  ❌ 0                 }
227  ❌ 0             }
228           
229  ❌ 0             return content;
230  ❌ 0         }
231           }
```
# FWH.Mobile.Services.MovementStateChangedEventArgs

## Summary

|||
|:---|:---|
| Class: | FWH.Mobile.Services.MovementStateChangedEventArgs |
| Assembly: | FWH.Mobile |
| **File(s):** | E:\github\FunWasHad\src\FWH.Mobile\FWH.Mobile\Services\MovementState.cs |
| **Line coverage:** | 36.5% (15 of 41) |
| Covered lines: | 15 |
| Uncovered lines: | 26 |
| Coverable lines: | 41 |
| Total lines: | 120 |
| **Branch coverage:** | 0% (0 of 8) |
| Covered branches: | 0 |
| Total branches: | 8 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **get_PreviousState()** | 100% | 2 | 1 | 0% |
| **get_CurrentState()** | 100% | 2 | 1 | 0% |
| **get_TransitionTime()** | 100% | 2 | 1 | 0% |
| **get_TriggerDistanceMeters()** | 100% | 2 | 1 | 0% |
| **get_DurationInPreviousState()** | 100% | 2 | 1 | 0% |
| **get_CurrentSpeedMetersPerSecond()** | 100% | 2 | 1 | 0% |
| **get_CurrentSpeedMph()** | 0% | 6 | 2 | 0% |
| **get_CurrentSpeedKmh()** | 0% | 6 | 2 | 0% |
| **.ctor(...)** | 100% | 1 | 1 | 100% |
| **ToString()** | 0% | 20 | 4 | 0% |

## File(s)

### E:\github\FunWasHad\src\FWH.Mobile\FWH.Mobile\Services\MovementState.cs
```
  1           namespace FWH.Mobile.Services;
  2           
  3           /// <summary>
  4           /// Represents the current movement state of the device.
  5           /// </summary>
  6           public enum MovementState
  7           {
  8               /// <summary>
  9               /// State is unknown or not yet determined.
 10               /// </summary>
 11               Unknown = 0,
 12           
 13               /// <summary>
 14               /// Device is stationary (not moving significantly).
 15               /// </summary>
 16               Stationary = 1,
 17           
 18               /// <summary>
 19               /// Device is moving at walking speed (< 5 mph / 8 km/h).
 20               /// Continuous motion with speed less than 5 mph.
 21               /// </summary>
 22               Walking = 2,
 23           
 24               /// <summary>
 25               /// Device is moving at riding speed (≥ 5 mph / 8 km/h).
 26               /// Continuous motion with speed greater than or equal to 5 mph.
 27               /// </summary>
 28               Riding = 3,
 29           
 30               /// <summary>
 31               /// Device is moving but speed cannot be determined yet.
 32               /// Legacy state for backward compatibility.
 33               /// </summary>
 34               Moving = 4
 35           }
 36           
 37           /// <summary>
 38           /// Event args for movement state transitions.
 39           /// </summary>
 40           public class MovementStateChangedEventArgs : EventArgs
 41           {
 42               /// <summary>
 43               /// Previous movement state.
 44               /// </summary>
 45  ❌ 0         public MovementState PreviousState { get; }
 46           
 47               /// <summary>
 48               /// Current movement state.
 49               /// </summary>
 50  ❌ 0         public MovementState CurrentState { get; }
 51           
 52               /// <summary>
 53               /// Timestamp when the state transition occurred.
 54               /// </summary>
 55  ❌ 0         public DateTimeOffset TransitionTime { get; }
 56           
 57               /// <summary>
 58               /// The distance that triggered the transition (if moving).
 59               /// </summary>
 60  ❌ 0         public double? TriggerDistanceMeters { get; }
 61           
 62               /// <summary>
 63               /// Duration in the previous state before transitioning.
 64               /// </summary>
 65  ❌ 0         public TimeSpan DurationInPreviousState { get; }
 66           
 67               /// <summary>
 68               /// Current speed in meters per second (if available).
 69               /// </summary>
 70  ❌ 0         public double? CurrentSpeedMetersPerSecond { get; }
 71           
 72               /// <summary>
 73               /// Current speed in miles per hour (if available).
 74               /// </summary>
 75  ❌ 0  ○      public double? CurrentSpeedMph => CurrentSpeedMetersPerSecond.HasValue
 76  ❌ 0             ? CurrentSpeedMetersPerSecond.Value * 2.23694
 77  ❌ 0             : null;
 78           
 79               /// <summary>
 80               /// Current speed in kilometers per hour (if available).
 81               /// </summary>
 82  ❌ 0  ○      public double? CurrentSpeedKmh => CurrentSpeedMetersPerSecond.HasValue
 83  ❌ 0             ? CurrentSpeedMetersPerSecond.Value * 3.6
 84  ❌ 0             : null;
 85           
 86  ✔  2         public MovementStateChangedEventArgs(
 87  ✔  2             MovementState previousState,
 88  ✔  2             MovementState currentState,
 89  ✔  2             DateTimeOffset transitionTime,
 90  ✔  2             double? triggerDistanceMeters,
 91  ✔  2             TimeSpan durationInPreviousState,
 92  ✔  2             double? currentSpeedMetersPerSecond = null)
 93  ✔  2         {
 94  ✔  2             PreviousState = previousState;
 95  ✔  2             CurrentState = currentState;
 96  ✔  2             TransitionTime = transitionTime;
 97  ✔  2             TriggerDistanceMeters = triggerDistanceMeters;
 98  ✔  2             DurationInPreviousState = durationInPreviousState;
 99  ✔  2             CurrentSpeedMetersPerSecond = currentSpeedMetersPerSecond;
100  ✔  2         }
101           
102               public override string ToString()
103  ❌ 0         {
104  ❌ 0             var result = $"{PreviousState} → {CurrentState} at {TransitionTime:HH:mm:ss} " +
105  ❌ 0                          $"(duration: {DurationInPreviousState.TotalSeconds:F0}s";
106           
107  ❌ 0  ○          if (TriggerDistanceMeters.HasValue)
108  ❌ 0             {
109  ❌ 0                 result += $", distance: {TriggerDistanceMeters:F1}m";
110  ❌ 0             }
111           
112  ❌ 0  ○          if (CurrentSpeedMph.HasValue)
113  ❌ 0             {
114  ❌ 0                 result += $", speed: {CurrentSpeedMph:F1} mph";
115  ❌ 0             }
116           
117  ❌ 0             result += ")";
118  ❌ 0             return result;
119  ❌ 0         }
120           }
```
# FWH.Mobile.Services.MovementStateLogger

## Summary

|||
|:---|:---|
| Class: | FWH.Mobile.Services.MovementStateLogger |
| Assembly: | FWH.Mobile |
| **File(s):** | E:\github\FunWasHad\src\FWH.Mobile\FWH.Mobile\Services\MovementStateLogger.cs |
| **Line coverage:** | 0% (0 of 87) |
| Covered lines: | 0 |
| Uncovered lines: | 87 |
| Coverable lines: | 87 |
| Total lines: | 132 |
| **Branch coverage:** | 0% (0 of 28) |
| Covered branches: | 0 |
| Total branches: | 28 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **.ctor(...)** | 0% | 20 | 4 | 0% |
| **StartLogging()** | 100% | 2 | 1 | 0% |
| **StopLogging()** | 100% | 2 | 1 | 0% |
| **OnMovementStateChanged(...)** | 0% | 42 | 6 | 0% |
| **LogTransitionMessage(...)** | 0% | 342 | 18 | 0% |
| **OnLocationUpdated(...)** | 100% | 2 | 1 | 0% |
| **LogCurrentState()** | 100% | 2 | 1 | 0% |

## File(s)

### E:\github\FunWasHad\src\FWH.Mobile\FWH.Mobile\Services\MovementStateLogger.cs
```
  1           using FWH.Mobile.Services;
  2           using Microsoft.Extensions.Logging;
  3           using System;
  4           
  5           namespace FWH.Mobile.Services;
  6           
  7           /// <summary>
  8           /// Demonstration service that logs movement state transitions to console.
  9           /// This shows how to use the walking/riding detection feature.
 10           /// </summary>
 11           public class MovementStateLogger
 12           {
 13               private readonly ILocationTrackingService _locationTrackingService;
 14               private readonly ILogger<MovementStateLogger> _logger;
 15           
 16  ❌ 0         public MovementStateLogger(
 17  ❌ 0             ILocationTrackingService locationTrackingService,
 18  ❌ 0             ILogger<MovementStateLogger> logger)
 19  ❌ 0         {
 20  ❌ 0  ○          _locationTrackingService = locationTrackingService ?? throw new ArgumentNullException(nameof(locationTrackingSer
 21  ❌ 0  ○          _logger = logger ?? throw new ArgumentNullException(nameof(logger));
 22  ❌ 0         }
 23           
 24               /// <summary>
 25               /// Starts logging movement state transitions.
 26               /// </summary>
 27               public void StartLogging()
 28  ❌ 0         {
 29  ❌ 0             _locationTrackingService.MovementStateChanged += OnMovementStateChanged;
 30  ❌ 0             _locationTrackingService.LocationUpdated += OnLocationUpdated;
 31           
 32  ❌ 0             _logger.LogDebug("Movement state logging started");
 33  ❌ 0             LogCurrentState();
 34  ❌ 0         }
 35           
 36               /// <summary>
 37               /// Stops logging movement state transitions.
 38               /// </summary>
 39               public void StopLogging()
 40  ❌ 0         {
 41  ❌ 0             _locationTrackingService.MovementStateChanged -= OnMovementStateChanged;
 42  ❌ 0             _locationTrackingService.LocationUpdated -= OnLocationUpdated;
 43           
 44  ❌ 0             _logger.LogDebug("Movement state logging stopped");
 45  ❌ 0         }
 46           
 47               private void OnMovementStateChanged(object? sender, MovementStateChangedEventArgs e)
 48  ❌ 0         {
 49  ❌ 0             var message = $"""
 50  ❌ 0                 ================================================================================
 51  ❌ 0                 MOVEMENT STATE CHANGED
 52  ❌ 0                 ================================================================================
 53  ❌ 0                 Previous State:    {e.PreviousState}
 54  ❌ 0                 Current State:     {e.CurrentState}
 55  ❌ 0                 Transition Time:   {e.TransitionTime:yyyy-MM-dd HH:mm:ss}
 56  ❌ 0                 Duration in State: {e.DurationInPreviousState.TotalMinutes:F1} minutes
 57  ❌ 0                 """;
 58           
 59  ❌ 0  ○          if (e.TriggerDistanceMeters.HasValue)
 60  ❌ 0             {
 61  ❌ 0  ○              message += $"\nTrigger Distance:  {e.TriggerDistanceMeters:F1} meters ({e.TriggerDistanceMeters / 1609.34:F2
 62  ❌ 0             }
 63           
 64  ❌ 0  ○          if (e.CurrentSpeedMph.HasValue)
 65  ❌ 0             {
 66  ❌ 0                 message += $"""
 67  ❌ 0     
 68  ❌ 0                     Current Speed:     {e.CurrentSpeedMph:F1} mph ({e.CurrentSpeedKmh:F1} km/h)
 69  ❌ 0                     Speed (m/s):       {e.CurrentSpeedMetersPerSecond:F2}
 70  ❌ 0                     """;
 71  ❌ 0             }
 72           
 73  ❌ 0             message += "\n================================================================================";
 74           
 75  ❌ 0             _logger.LogInformation(message);
 76           
 77                   // Log specific transition messages
 78  ❌ 0             LogTransitionMessage(e);
 79  ❌ 0         }
 80           
 81               private void LogTransitionMessage(MovementStateChangedEventArgs e)
 82  ❌ 0         {
 83  ❌ 0  ○          var message = e switch
 84  ❌ 0             {
 85  ❌ 0                 { PreviousState: MovementState.Stationary, CurrentState: MovementState.Walking }
 86  ❌ 0                     => "🚶 Started walking",
 87  ❌ 0     
 88  ❌ 0                 { PreviousState: MovementState.Stationary, CurrentState: MovementState.Riding }
 89  ❌ 0                     => $"🚴 Started riding at {e.CurrentSpeedMph:F1} mph",
 90  ❌ 0     
 91  ❌ 0                 { PreviousState: MovementState.Walking, CurrentState: MovementState.Riding }
 92  ❌ 0                     => $"⬆️  Accelerated from walking to riding ({e.CurrentSpeedMph:F1} mph)",
 93  ❌ 0     
 94  ❌ 0                 { PreviousState: MovementState.Riding, CurrentState: MovementState.Walking }
 95  ❌ 0                     => "⬇️  Slowed down from riding to walking",
 96  ❌ 0     
 97  ❌ 0                 { PreviousState: MovementState.Walking, CurrentState: MovementState.Stationary }
 98  ❌ 0                     => $"⏸️  Stopped walking (walked for {e.DurationInPreviousState.TotalMinutes:F1} minutes)",
 99  ❌ 0     
100  ❌ 0                 { PreviousState: MovementState.Riding, CurrentState: MovementState.Stationary }
101  ❌ 0                     => $"⏸️  Stopped riding (rode for {e.DurationInPreviousState.TotalMinutes:F1} minutes)",
102  ❌ 0     
103  ❌ 0                 _ => $"State transition: {e.PreviousState} → {e.CurrentState}"
104  ❌ 0             };
105           
106  ❌ 0             _logger.LogInformation(message);
107  ❌ 0         }
108           
109               private void OnLocationUpdated(object? sender, FWH.Common.Location.Models.GpsCoordinates e)
110  ❌ 0         {
111  ❌ 0             var state = _locationTrackingService.CurrentMovementState;
112  ❌ 0             var speed = _locationTrackingService.CurrentSpeedMph;
113           
114  ❌ 0             _logger.LogDebug(
115  ❌ 0                 "Location updated: ({Lat:F6}, {Lon:F6}) - State: {State}, Speed: {Speed:F1} mph",
116  ❌ 0                 e.Latitude,
117  ❌ 0                 e.Longitude,
118  ❌ 0                 state,
119  ❌ 0                 speed ?? 0);
120  ❌ 0         }
121           
122               private void LogCurrentState()
123  ❌ 0         {
124  ❌ 0             var state = _locationTrackingService.CurrentMovementState;
125  ❌ 0             var speed = _locationTrackingService.CurrentSpeedMph;
126           
127  ❌ 0             _logger.LogInformation(
128  ❌ 0                 "Current Movement State: {State}, Speed: {Speed:F1} mph",
129  ❌ 0                 state,
130  ❌ 0                 speed ?? 0);
131  ❌ 0         }
132           }
```
# FWH.Mobile.Services.ThemeService

## Summary

|||
|:---|:---|
| Class: | FWH.Mobile.Services.ThemeService |
| Assembly: | FWH.Mobile |
| **File(s):** | E:\github\FunWasHad\src\FWH.Mobile\FWH.Mobile\Services\ThemeService.cs |
| **Line coverage:** | 0% (0 of 162) |
| Covered lines: | 0 |
| Uncovered lines: | 162 |
| Coverable lines: | 162 |
| Total lines: | 282 |
| **Branch coverage:** | 0% (0 of 50) |
| Covered branches: | 0 |
| Total branches: | 50 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **.ctor(...)** | 0% | 42 | 6 | 0% |
| **get_CurrentThemeName()** | 100% | 2 | 1 | 0% |
| **ApplyBusinessThemeAsync()** | 0% | 20 | 4 | 0% |
| **ApplyCityThemeAsync()** | 0% | 110 | 10 | 0% |
| **ResetToDefaultTheme()** | 0% | 6 | 2 | 0% |
| **ApplyTheme(...)** | 0% | 506 | 22 | 0% |
| **TryParseColor(...)** | 0% | 42 | 6 | 0% |
| **get_ThemeName()** | 100% | 2 | 1 | 0% |
| **get_PrimaryColor()** | 100% | 2 | 1 | 0% |
| **get_SecondaryColor()** | 100% | 2 | 1 | 0% |
| **get_AccentColor()** | 100% | 2 | 1 | 0% |
| **get_BackgroundColor()** | 100% | 2 | 1 | 0% |
| **get_TextColor()** | 100% | 2 | 1 | 0% |
| **get_IsActive()** | 100% | 2 | 1 | 0% |
| **get_Theme()** | 100% | 2 | 1 | 0% |
| **get_ThemeName()** | 100% | 2 | 1 | 0% |
| **get_PrimaryColor()** | 100% | 2 | 1 | 0% |
| **get_SecondaryColor()** | 100% | 2 | 1 | 0% |
| **get_AccentColor()** | 100% | 2 | 1 | 0% |
| **get_BackgroundColor()** | 100% | 2 | 1 | 0% |
| **get_TextColor()** | 100% | 2 | 1 | 0% |
| **get_IsActive()** | 100% | 2 | 1 | 0% |

## File(s)

### E:\github\FunWasHad\src\FWH.Mobile\FWH.Mobile\Services\ThemeService.cs
```
  1           using System;
  2           using System.Net.Http;
  3           using System.Net.Http.Json;
  4           using System.Threading.Tasks;
  5           using Avalonia;
  6           using Avalonia.Controls;
  7           using Avalonia.Media;
  8           using Avalonia.Styling;
  9           using FWH.Mobile.Configuration;
 10           using Microsoft.Extensions.Logging;
 11           
 12           namespace FWH.Mobile.Services;
 13           
 14           /// <summary>
 15           /// Service for managing and applying themes to the Avalonia application.
 16           /// Retrieves themes from the Marketing API and applies them to application resources.
 17           /// </summary>
 18           public class ThemeService : IThemeService
 19           {
 20               private readonly IHttpClientFactory _httpClientFactory;
 21               private readonly ApiSettings _apiSettings;
 22               private readonly ILogger<ThemeService> _logger;
 23               private string? _currentThemeName;
 24           
 25               // Theme resource keys
 26               private const string PrimaryColorKey = "ThemePrimaryColor";
 27               private const string SecondaryColorKey = "ThemeSecondaryColor";
 28               private const string AccentColorKey = "ThemeAccentColor";
 29               private const string BackgroundColorKey = "ThemeBackgroundColor";
 30               private const string TextColorKey = "ThemeTextColor";
 31           
 32  ❌ 0         public ThemeService(
 33  ❌ 0             IHttpClientFactory httpClientFactory,
 34  ❌ 0             ApiSettings apiSettings,
 35  ❌ 0             ILogger<ThemeService> logger)
 36  ❌ 0         {
 37  ❌ 0  ○          _httpClientFactory = httpClientFactory ?? throw new ArgumentNullException(nameof(httpClientFactory));
 38  ❌ 0  ○          _apiSettings = apiSettings ?? throw new ArgumentNullException(nameof(apiSettings));
 39  ❌ 0  ○          _logger = logger ?? throw new ArgumentNullException(nameof(logger));
 40  ❌ 0         }
 41           
 42  ❌ 0         public string? CurrentThemeName => _currentThemeName;
 43           
 44               /// <summary>
 45               /// Applies a business theme to the application.
 46               /// </summary>
 47               public async Task<bool> ApplyBusinessThemeAsync(long businessId)
 48  ❌ 0         {
 49                   try
 50  ❌ 0             {
 51  ❌ 0                 var httpClient = _httpClientFactory.CreateClient("MarketingApi");
 52  ❌ 0                 var themeUrl = $"api/marketing/{businessId}/theme";
 53           
 54  ❌ 0                 var theme = await httpClient.GetFromJsonAsync<BusinessThemeDto>(themeUrl);
 55           
 56  ❌ 0  ○              if (theme == null || !theme.IsActive)
 57  ❌ 0                 {
 58  ❌ 0                     _logger.LogDebug("No active theme found for business {BusinessId}", businessId);
 59  ❌ 0                     return false;
 60                       }
 61           
 62  ❌ 0                 ApplyTheme(theme.ThemeName, theme.PrimaryColor, theme.SecondaryColor,
 63  ❌ 0                     theme.AccentColor, theme.BackgroundColor, theme.TextColor);
 64           
 65  ❌ 0                 _logger.LogInformation("Applied business theme '{ThemeName}' for business {BusinessId}",
 66  ❌ 0                     theme.ThemeName, businessId);
 67           
 68  ❌ 0                 return true;
 69                   }
 70  ❌ 0             catch (HttpRequestException ex)
 71  ❌ 0             {
 72  ❌ 0                 _logger.LogWarning(ex, "Failed to retrieve business theme for business {BusinessId}", businessId);
 73  ❌ 0                 return false;
 74                   }
 75  ❌ 0             catch (TaskCanceledException ex)
 76  ❌ 0             {
 77  ❌ 0                 _logger.LogWarning(ex, "Request timeout retrieving business theme for business {BusinessId}", businessId);
 78  ❌ 0                 return false;
 79                   }
 80  ❌ 0             catch (OperationCanceledException)
 81  ❌ 0             {
 82  ❌ 0                 _logger.LogInformation("Applying business theme was cancelled for business {BusinessId}", businessId);
 83  ❌ 0                 return false;
 84                   }
 85  ❌ 0             catch (Exception ex)
 86  ❌ 0             {
 87  ❌ 0                 _logger.LogError(ex, "Error applying business theme for business {BusinessId}", businessId);
 88  ❌ 0                 return false;
 89                   }
 90  ❌ 0         }
 91           
 92               /// <summary>
 93               /// Applies a city theme to the application.
 94               /// </summary>
 95               public async Task<bool> ApplyCityThemeAsync(string cityName, string? state = null, string? country = null)
 96  ❌ 0         {
 97                   try
 98  ❌ 0             {
 99  ❌ 0                 var httpClient = _httpClientFactory.CreateClient("MarketingApi");
100  ❌ 0                 var queryBuilder = new System.Text.StringBuilder();
101  ❌ 0                 queryBuilder.Append("api/marketing/city?cityName=");
102  ❌ 0                 queryBuilder.Append(Uri.EscapeDataString(cityName));
103  ❌ 0  ○              if (!string.IsNullOrEmpty(state))
104  ❌ 0                 {
105  ❌ 0                     queryBuilder.Append("&state=");
106  ❌ 0                     queryBuilder.Append(Uri.EscapeDataString(state));
107  ❌ 0                 }
108  ❌ 0  ○              if (!string.IsNullOrEmpty(country))
109  ❌ 0                 {
110  ❌ 0                     queryBuilder.Append("&country=");
111  ❌ 0                     queryBuilder.Append(Uri.EscapeDataString(country));
112  ❌ 0                 }
113           
114  ❌ 0                 var cityUrl = queryBuilder.ToString();
115  ❌ 0                 var cityResponse = await httpClient.GetFromJsonAsync<CityMarketingResponseDto>(cityUrl);
116           
117  ❌ 0  ○              if (cityResponse?.Theme == null || !cityResponse.Theme.IsActive)
118  ❌ 0                 {
119  ❌ 0                     _logger.LogDebug("No active theme found for city {CityName}", cityName);
120  ❌ 0                     return false;
121                       }
122           
123  ❌ 0                 var theme = cityResponse.Theme;
124  ❌ 0                 ApplyTheme(theme.ThemeName, theme.PrimaryColor, theme.SecondaryColor,
125  ❌ 0                     theme.AccentColor, theme.BackgroundColor, theme.TextColor);
126           
127  ❌ 0                 _logger.LogInformation("Applied city theme '{ThemeName}' for city {CityName}",
128  ❌ 0                     theme.ThemeName, cityName);
129           
130  ❌ 0                 return true;
131                   }
132  ❌ 0             catch (HttpRequestException ex)
133  ❌ 0             {
134  ❌ 0                 _logger.LogWarning(ex, "Failed to retrieve city theme for city {CityName}", cityName);
135  ❌ 0                 return false;
136                   }
137  ❌ 0             catch (TaskCanceledException ex)
138  ❌ 0             {
139  ❌ 0                 _logger.LogWarning(ex, "Request timeout retrieving city theme for city {CityName}", cityName);
140  ❌ 0                 return false;
141                   }
142  ❌ 0             catch (OperationCanceledException)
143  ❌ 0             {
144  ❌ 0                 _logger.LogInformation("Applying city theme was cancelled for city {CityName}", cityName);
145  ❌ 0                 return false;
146                   }
147  ❌ 0             catch (Exception ex)
148  ❌ 0             {
149  ❌ 0                 _logger.LogError(ex, "Error applying city theme for city {CityName}", cityName);
150  ❌ 0                 return false;
151                   }
152  ❌ 0         }
153           
154               /// <summary>
155               /// Resets the theme to default (removes any applied theme).
156               /// </summary>
157               public void ResetToDefaultTheme()
158  ❌ 0         {
159  ❌ 0             var app = Application.Current;
160  ❌ 0  ○          if (app == null)
161  ❌ 0                 return;
162           
163  ❌ 0             var resources = app.Resources;
164           
165                   // Remove theme colors
166  ❌ 0             resources.Remove(PrimaryColorKey);
167  ❌ 0             resources.Remove(SecondaryColorKey);
168  ❌ 0             resources.Remove(AccentColorKey);
169  ❌ 0             resources.Remove(BackgroundColorKey);
170  ❌ 0             resources.Remove(TextColorKey);
171           
172  ❌ 0             _currentThemeName = null;
173  ❌ 0             _logger.LogInformation("Reset to default theme");
174  ❌ 0         }
175           
176               /// <summary>
177               /// Applies theme colors to application resources.
178               /// </summary>
179               private void ApplyTheme(string themeName, string? primaryColor, string? secondaryColor,
180                   string? accentColor, string? backgroundColor, string? textColor)
181  ❌ 0         {
182  ❌ 0             var app = Application.Current;
183  ❌ 0  ○          if (app == null)
184  ❌ 0             {
185  ❌ 0                 _logger.LogWarning("Cannot apply theme: Application.Current is null");
186  ❌ 0                 return;
187                   }
188           
189  ❌ 0             var resources = app.Resources;
190           
191                   // Apply colors if provided
192  ❌ 0  ○          if (!string.IsNullOrEmpty(primaryColor) && TryParseColor(primaryColor, out var primary))
193  ❌ 0             {
194  ❌ 0                 resources[PrimaryColorKey] = primary;
195  ❌ 0             }
196           
197  ❌ 0  ○          if (!string.IsNullOrEmpty(secondaryColor) && TryParseColor(secondaryColor, out var secondary))
198  ❌ 0             {
199  ❌ 0                 resources[SecondaryColorKey] = secondary;
200  ❌ 0             }
201           
202  ❌ 0  ○          if (!string.IsNullOrEmpty(accentColor) && TryParseColor(accentColor, out var accent))
203  ❌ 0             {
204  ❌ 0                 resources[AccentColorKey] = accent;
205  ❌ 0             }
206           
207  ❌ 0  ○          if (!string.IsNullOrEmpty(backgroundColor) && TryParseColor(backgroundColor, out var background))
208  ❌ 0             {
209  ❌ 0                 resources[BackgroundColorKey] = background;
210  ❌ 0             }
211           
212  ❌ 0  ○          if (!string.IsNullOrEmpty(textColor) && TryParseColor(textColor, out var text))
213  ❌ 0             {
214  ❌ 0                 resources[TextColorKey] = text;
215  ❌ 0             }
216           
217  ❌ 0             _currentThemeName = themeName;
218  ❌ 0         }
219           
220               /// <summary>
221               /// Attempts to parse a color string (hex format like #RRGGBB or #AARRGGBB) into an Avalonia Color.
222               /// </summary>
223               private static bool TryParseColor(string colorString, out Color color)
224  ❌ 0         {
225  ❌ 0             color = Colors.Transparent;
226           
227  ❌ 0  ○          if (string.IsNullOrWhiteSpace(colorString))
228  ❌ 0                 return false;
229           
230                   // Remove # if present
231  ❌ 0             var hex = colorString.TrimStart('#');
232           
233                   // Handle both 6-digit and 8-digit hex colors
234  ❌ 0  ○          if (hex.Length == 6)
235  ❌ 0             {
236                       // Add alpha channel (fully opaque)
237  ❌ 0                 hex = "FF" + hex;
238  ❌ 0             }
239           
240  ❌ 0  ○          if (hex.Length != 8)
241  ❌ 0                 return false;
242           
243                   try
244  ❌ 0             {
245  ❌ 0                 var argb = Convert.ToUInt32(hex, 16);
246  ❌ 0                 color = Color.FromUInt32(argb);
247  ❌ 0                 return true;
248                   }
249  ❌ 0             catch
250  ❌ 0             {
251  ❌ 0                 return false;
252                   }
253  ❌ 0         }
254           
255               // DTOs for API responses
256               private class BusinessThemeDto
257               {
258  ❌ 0             public string ThemeName { get; set; } = string.Empty;
259  ❌ 0             public string? PrimaryColor { get; set; }
260  ❌ 0             public string? SecondaryColor { get; set; }
261  ❌ 0             public string? AccentColor { get; set; }
262  ❌ 0             public string? BackgroundColor { get; set; }
263  ❌ 0             public string? TextColor { get; set; }
264  ❌ 0             public bool IsActive { get; set; }
265               }
266           
267               private class CityMarketingResponseDto
268               {
269  ❌ 0             public CityThemeDto? Theme { get; set; }
270               }
271           
272               private class CityThemeDto
273               {
274  ❌ 0             public string ThemeName { get; set; } = string.Empty;
275  ❌ 0             public string? PrimaryColor { get; set; }
276  ❌ 0             public string? SecondaryColor { get; set; }
277  ❌ 0             public string? AccentColor { get; set; }
278  ❌ 0             public string? BackgroundColor { get; set; }
279  ❌ 0             public string? TextColor { get; set; }
280  ❌ 0             public bool IsActive { get; set; }
281               }
282           }
```
# FWH.Mobile.ViewLocator

## Summary

|||
|:---|:---|
| Class: | FWH.Mobile.ViewLocator |
| Assembly: | FWH.Mobile |
| **File(s):** | E:\github\FunWasHad\src\FWH.Mobile\FWH.Mobile\ViewLocator.cs |
| **Line coverage:** | 0% (0 of 13) |
| Covered lines: | 0 |
| Uncovered lines: | 13 |
| Coverable lines: | 13 |
| Total lines: | 31 |
| **Branch coverage:** | 0% (0 of 4) |
| Covered branches: | 0 |
| Total branches: | 4 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **Build(...)** | 0% | 20 | 4 | 0% |
| **Match(...)** | 100% | 2 | 1 | 0% |

## File(s)

### E:\github\FunWasHad\src\FWH.Mobile\FWH.Mobile\ViewLocator.cs
```
 1           using System;
 2           
 3           using Avalonia.Controls;
 4           using Avalonia.Controls.Templates;
 5           
 6           using FWH.Mobile.ViewModels;
 7           
 8           namespace FWH.Mobile;
 9           public class ViewLocator : IDataTemplate
10           {
11               public Control? Build(object? param)
12  ❌ 0         {
13  ❌ 0  ○          if (param is null)
14  ❌ 0                 return null;
15           
16  ❌ 0             var name = param.GetType().FullName!.Replace("ViewModel", "View", StringComparison.Ordinal);
17  ❌ 0             var type = Type.GetType(name);
18           
19  ❌ 0  ○          if (type != null)
20  ❌ 0             {
21  ❌ 0                 return (Control)Activator.CreateInstance(type)!;
22                   }
23           
24  ❌ 0             return new TextBlock { Text = "Not Found: " + name };
25  ❌ 0         }
26           
27               public bool Match(object? data)
28  ❌ 0         {
29  ❌ 0             return data is ViewModelBase;
30  ❌ 0         }
31           }
```
# FWH.Mobile.ViewModels.ActivityTrackingViewModel

## Summary

|||
|:---|:---|
| Class: | FWH.Mobile.ViewModels.ActivityTrackingViewModel |
| Assembly: | FWH.Mobile |
| **File(s):** | E:\github\FunWasHad\src\FWH.Mobile\FWH.Mobile\ViewModels\ActivityTrackingViewModel.cs |
| **Line coverage:** | 0% (0 of 39) |
| Covered lines: | 0 |
| Uncovered lines: | 39 |
| Coverable lines: | 39 |
| Total lines: | 88 |
| **Branch coverage:** | 0% (0 of 12) |
| Covered branches: | 0 |
| Total branches: | 12 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **.ctor(...)** | 0% | 42 | 6 | 0% |
| **OnMovementStateChanged(...)** | 100% | 2 | 1 | 0% |
| **UpdateDisplay()** | 0% | 42 | 6 | 0% |
| **RefreshDisplay()** | 100% | 2 | 1 | 0% |
| **Dispose()** | 100% | 2 | 1 | 0% |

## File(s)

### E:\github\FunWasHad\src\FWH.Mobile\FWH.Mobile\ViewModels\ActivityTrackingViewModel.cs
```
 1           using CommunityToolkit.Mvvm.ComponentModel;
 2           using CommunityToolkit.Mvvm.Input;
 3           using FWH.Mobile.Configuration;
 4           using FWH.Mobile.Services;
 5           using System;
 6           using System.Threading.Tasks;
 7           
 8           namespace FWH.Mobile.ViewModels;
 9           
10           /// <summary>
11           /// ViewModel for displaying activity tracking information.
12           /// </summary>
13           public partial class ActivityTrackingViewModel : ObservableObject
14           {
15               private readonly ActivityTrackingService _activityTrackingService;
16               private readonly ILocationTrackingService _locationTrackingService;
17               private readonly LocationSettings _locationSettings;
18           
19               [ObservableProperty]
20  ❌ 0         private string _currentState = "Unknown";
21           
22               [ObservableProperty]
23  ❌ 0         private string _currentSpeed = "0.0 mph";
24           
25               [ObservableProperty]
26  ❌ 0         private string _activitySummary = "No active activity";
27           
28               [ObservableProperty]
29               private bool _isTracking;
30           
31  ❌ 0         public ActivityTrackingViewModel(
32  ❌ 0             ActivityTrackingService activityTrackingService,
33  ❌ 0             ILocationTrackingService locationTrackingService,
34  ❌ 0             LocationSettings locationSettings)
35  ❌ 0         {
36  ❌ 0  ○          _activityTrackingService = activityTrackingService ?? throw new ArgumentNullException(nameof(activityTrackingSer
37  ❌ 0  ○          _locationTrackingService = locationTrackingService ?? throw new ArgumentNullException(nameof(locationTrackingSer
38  ❌ 0  ○          _locationSettings = locationSettings ?? throw new ArgumentNullException(nameof(locationSettings));
39           
40                   // Subscribe to state changes
41  ❌ 0             _locationTrackingService.MovementStateChanged += OnMovementStateChanged;
42           
43                   // Start monitoring
44  ❌ 0             _activityTrackingService.StartMonitoring();
45           
46                   // Update initial state
47  ❌ 0             UpdateDisplay();
48  ❌ 0         }
49           
50               private void OnMovementStateChanged(object? sender, MovementStateChangedEventArgs e)
51  ❌ 0         {
52                   // Update display on state change
53  ❌ 0             UpdateDisplay();
54  ❌ 0         }
55           
56               private void UpdateDisplay()
57  ❌ 0         {
58  ❌ 0             CurrentState = _locationTrackingService.CurrentMovementState.ToString();
59           
60                   // Display speed based on configured unit preference
61  ❌ 0  ○          if (_locationSettings.UseKmh)
62  ❌ 0             {
63  ❌ 0                 var speed = _locationTrackingService.CurrentSpeedKmh;
64  ❌ 0  ○              CurrentSpeed = speed.HasValue ? $"{speed:F1} km/h" : "0.0 km/h";
65  ❌ 0             }
66                   else
67  ❌ 0             {
68                       // Default to mph
69  ❌ 0                 var speed = _locationTrackingService.CurrentSpeedMph;
70  ❌ 0  ○              CurrentSpeed = speed.HasValue ? $"{speed:F1} mph" : "0.0 mph";
71  ❌ 0             }
72           
73  ❌ 0             ActivitySummary = _activityTrackingService.GetActivitySummary();
74  ❌ 0             IsTracking = _activityTrackingService.IsTrackingActivity;
75  ❌ 0         }
76           
77               [RelayCommand]
78               private void RefreshDisplay()
79  ❌ 0         {
80  ❌ 0             UpdateDisplay();
81  ❌ 0         }
82           
83               public void Dispose()
84  ❌ 0         {
85  ❌ 0             _locationTrackingService.MovementStateChanged -= OnMovementStateChanged;
86  ❌ 0             _activityTrackingService.StopMonitoring();
87  ❌ 0         }
88           }
```
# FWH.Mobile.ViewModels.AuthorToAlignmentConverter

## Summary

|||
|:---|:---|
| Class: | FWH.Mobile.ViewModels.AuthorToAlignmentConverter |
| Assembly: | FWH.Mobile |
| **File(s):** | E:\github\FunWasHad\src\FWH.Mobile\FWH.Mobile\ViewModels\ChatConverters.cs |
| **Line coverage:** | 0% (0 of 2) |
| Covered lines: | 0 |
| Uncovered lines: | 2 |
| Coverable lines: | 2 |
| Total lines: | 81 |
| **Branch coverage:** | 0% (0 of 4) |
| Covered branches: | 0 |
| Total branches: | 4 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **Convert(...)** | 0% | 20 | 4 | 0% |
| **ConvertBack(...)** | 100% | 2 | 1 | 0% |

## File(s)

### E:\github\FunWasHad\src\FWH.Mobile\FWH.Mobile\ViewModels\ChatConverters.cs
```
 1           using System;
 2           using Avalonia.Data.Converters;
 3           using Avalonia.Layout;
 4           using Avalonia.Media;
 5           using System.Globalization;
 6           using Avalonia.Media.Imaging;
 7           using System.IO;
 8           
 9           namespace FWH.Mobile.ViewModels;
10           
11           public class AuthorToAlignmentConverter : IValueConverter
12           {
13               public object Convert(object? value, Type targetType, object? parameter, CultureInfo culture)
14  ❌ 0  ○          => value is FWH.Common.Chat.ViewModels.ChatAuthors.User ? HorizontalAlignment.Right : HorizontalAlignment.Left;
15           
16               public object? ConvertBack(object? value, Type targetType, object? parameter, CultureInfo culture)
17  ❌ 0             => throw new NotImplementedException();
18           }
19           
20           public class AuthorToBrushConverter : IValueConverter
21           {
22               public object Convert(object? value, Type targetType, object? parameter, CultureInfo culture)
23                   => value is FWH.Common.Chat.ViewModels.ChatAuthors.User ? Brushes.DodgerBlue : Brushes.Gray;
24           
25               public object? ConvertBack(object? value, Type targetType, object? parameter, CultureInfo culture)
26                   => throw new NotImplementedException();
27           }
28           
29           public class ChatInputModeToTextVisibility : IValueConverter
30           {
31               public object Convert(object? value, Type targetType, object? parameter, CultureInfo culture)
32                   => value is FWH.Common.Chat.ViewModels.ChatInputModes.Text;
33           
34               public object? ConvertBack(object? value, Type targetType, object? parameter, CultureInfo culture)
35                   => throw new NotImplementedException();
36           }
37           
38           public class ChatInputModeToChoiceVisibility : IValueConverter
39           {
40               public object Convert(object? value, Type targetType, object? parameter, CultureInfo culture)
41                   => value is FWH.Common.Chat.ViewModels.ChatInputModes.Choice;
42           
43               public object? ConvertBack(object? value, Type targetType, object? parameter, CultureInfo culture)
44                   => throw new NotImplementedException();
45           }
46           
47           public class ChatInputModeToPhotoVisibility : IValueConverter
48           {
49               public object Convert(object? value, Type targetType, object? parameter, CultureInfo culture)
50                   => value is FWH.Common.Chat.ViewModels.ChatInputModes.Image;
51           
52               public object? ConvertBack(object? value, Type targetType, object? parameter, CultureInfo culture)
53                   => throw new NotImplementedException();
54           }
55           
56           /// <summary>
57           /// Converts byte array to Bitmap for Avalonia Image controls.
58           /// Returns null for null or empty byte arrays to prevent Source.Stream null exceptions.
59           /// </summary>
60           public class ByteArrayToImageConverter : IValueConverter
61           {
62               public object? Convert(object? value, Type targetType, object? parameter, CultureInfo culture)
63               {
64                   if (value is not byte[] bytes || bytes.Length == 0)
65                       return null;
66           
67                   try
68                   {
69                       using var stream = new MemoryStream(bytes);
70                       return new Bitmap(stream);
71                   }
72                   catch
73                   {
74                       // Return null if image cannot be loaded
75                       return null;
76                   }
77               }
78           
79               public object? ConvertBack(object? value, Type targetType, object? parameter, CultureInfo culture)
80                   => throw new NotImplementedException();
81           }
```
# FWH.Mobile.ViewModels.AuthorToBrushConverter

## Summary

|||
|:---|:---|
| Class: | FWH.Mobile.ViewModels.AuthorToBrushConverter |
| Assembly: | FWH.Mobile |
| **File(s):** | E:\github\FunWasHad\src\FWH.Mobile\FWH.Mobile\ViewModels\ChatConverters.cs |
| **Line coverage:** | 0% (0 of 2) |
| Covered lines: | 0 |
| Uncovered lines: | 2 |
| Coverable lines: | 2 |
| Total lines: | 81 |
| **Branch coverage:** | 0% (0 of 4) |
| Covered branches: | 0 |
| Total branches: | 4 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **Convert(...)** | 0% | 20 | 4 | 0% |
| **ConvertBack(...)** | 100% | 2 | 1 | 0% |

## File(s)

### E:\github\FunWasHad\src\FWH.Mobile\FWH.Mobile\ViewModels\ChatConverters.cs
```
 1           using System;
 2           using Avalonia.Data.Converters;
 3           using Avalonia.Layout;
 4           using Avalonia.Media;
 5           using System.Globalization;
 6           using Avalonia.Media.Imaging;
 7           using System.IO;
 8           
 9           namespace FWH.Mobile.ViewModels;
10           
11           public class AuthorToAlignmentConverter : IValueConverter
12           {
13               public object Convert(object? value, Type targetType, object? parameter, CultureInfo culture)
14                   => value is FWH.Common.Chat.ViewModels.ChatAuthors.User ? HorizontalAlignment.Right : HorizontalAlignment.Left;
15           
16               public object? ConvertBack(object? value, Type targetType, object? parameter, CultureInfo culture)
17                   => throw new NotImplementedException();
18           }
19           
20           public class AuthorToBrushConverter : IValueConverter
21           {
22               public object Convert(object? value, Type targetType, object? parameter, CultureInfo culture)
23  ❌ 0  ○          => value is FWH.Common.Chat.ViewModels.ChatAuthors.User ? Brushes.DodgerBlue : Brushes.Gray;
24           
25               public object? ConvertBack(object? value, Type targetType, object? parameter, CultureInfo culture)
26  ❌ 0             => throw new NotImplementedException();
27           }
28           
29           public class ChatInputModeToTextVisibility : IValueConverter
30           {
31               public object Convert(object? value, Type targetType, object? parameter, CultureInfo culture)
32                   => value is FWH.Common.Chat.ViewModels.ChatInputModes.Text;
33           
34               public object? ConvertBack(object? value, Type targetType, object? parameter, CultureInfo culture)
35                   => throw new NotImplementedException();
36           }
37           
38           public class ChatInputModeToChoiceVisibility : IValueConverter
39           {
40               public object Convert(object? value, Type targetType, object? parameter, CultureInfo culture)
41                   => value is FWH.Common.Chat.ViewModels.ChatInputModes.Choice;
42           
43               public object? ConvertBack(object? value, Type targetType, object? parameter, CultureInfo culture)
44                   => throw new NotImplementedException();
45           }
46           
47           public class ChatInputModeToPhotoVisibility : IValueConverter
48           {
49               public object Convert(object? value, Type targetType, object? parameter, CultureInfo culture)
50                   => value is FWH.Common.Chat.ViewModels.ChatInputModes.Image;
51           
52               public object? ConvertBack(object? value, Type targetType, object? parameter, CultureInfo culture)
53                   => throw new NotImplementedException();
54           }
55           
56           /// <summary>
57           /// Converts byte array to Bitmap for Avalonia Image controls.
58           /// Returns null for null or empty byte arrays to prevent Source.Stream null exceptions.
59           /// </summary>
60           public class ByteArrayToImageConverter : IValueConverter
61           {
62               public object? Convert(object? value, Type targetType, object? parameter, CultureInfo culture)
63               {
64                   if (value is not byte[] bytes || bytes.Length == 0)
65                       return null;
66           
67                   try
68                   {
69                       using var stream = new MemoryStream(bytes);
70                       return new Bitmap(stream);
71                   }
72                   catch
73                   {
74                       // Return null if image cannot be loaded
75                       return null;
76                   }
77               }
78           
79               public object? ConvertBack(object? value, Type targetType, object? parameter, CultureInfo culture)
80                   => throw new NotImplementedException();
81           }
```
# FWH.Mobile.ViewModels.ByteArrayToImageConverter

## Summary

|||
|:---|:---|
| Class: | FWH.Mobile.ViewModels.ByteArrayToImageConverter |
| Assembly: | FWH.Mobile |
| **File(s):** | E:\github\FunWasHad\src\FWH.Mobile\FWH.Mobile\ViewModels\ChatConverters.cs |
| **Line coverage:** | 0% (0 of 11) |
| Covered lines: | 0 |
| Uncovered lines: | 11 |
| Coverable lines: | 11 |
| Total lines: | 81 |
| **Branch coverage:** | 0% (0 of 4) |
| Covered branches: | 0 |
| Total branches: | 4 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **Convert(...)** | 0% | 20 | 4 | 0% |
| **ConvertBack(...)** | 100% | 2 | 1 | 0% |

## File(s)

### E:\github\FunWasHad\src\FWH.Mobile\FWH.Mobile\ViewModels\ChatConverters.cs
```
 1           using System;
 2           using Avalonia.Data.Converters;
 3           using Avalonia.Layout;
 4           using Avalonia.Media;
 5           using System.Globalization;
 6           using Avalonia.Media.Imaging;
 7           using System.IO;
 8           
 9           namespace FWH.Mobile.ViewModels;
10           
11           public class AuthorToAlignmentConverter : IValueConverter
12           {
13               public object Convert(object? value, Type targetType, object? parameter, CultureInfo culture)
14                   => value is FWH.Common.Chat.ViewModels.ChatAuthors.User ? HorizontalAlignment.Right : HorizontalAlignment.Left;
15           
16               public object? ConvertBack(object? value, Type targetType, object? parameter, CultureInfo culture)
17                   => throw new NotImplementedException();
18           }
19           
20           public class AuthorToBrushConverter : IValueConverter
21           {
22               public object Convert(object? value, Type targetType, object? parameter, CultureInfo culture)
23                   => value is FWH.Common.Chat.ViewModels.ChatAuthors.User ? Brushes.DodgerBlue : Brushes.Gray;
24           
25               public object? ConvertBack(object? value, Type targetType, object? parameter, CultureInfo culture)
26                   => throw new NotImplementedException();
27           }
28           
29           public class ChatInputModeToTextVisibility : IValueConverter
30           {
31               public object Convert(object? value, Type targetType, object? parameter, CultureInfo culture)
32                   => value is FWH.Common.Chat.ViewModels.ChatInputModes.Text;
33           
34               public object? ConvertBack(object? value, Type targetType, object? parameter, CultureInfo culture)
35                   => throw new NotImplementedException();
36           }
37           
38           public class ChatInputModeToChoiceVisibility : IValueConverter
39           {
40               public object Convert(object? value, Type targetType, object? parameter, CultureInfo culture)
41                   => value is FWH.Common.Chat.ViewModels.ChatInputModes.Choice;
42           
43               public object? ConvertBack(object? value, Type targetType, object? parameter, CultureInfo culture)
44                   => throw new NotImplementedException();
45           }
46           
47           public class ChatInputModeToPhotoVisibility : IValueConverter
48           {
49               public object Convert(object? value, Type targetType, object? parameter, CultureInfo culture)
50                   => value is FWH.Common.Chat.ViewModels.ChatInputModes.Image;
51           
52               public object? ConvertBack(object? value, Type targetType, object? parameter, CultureInfo culture)
53                   => throw new NotImplementedException();
54           }
55           
56           /// <summary>
57           /// Converts byte array to Bitmap for Avalonia Image controls.
58           /// Returns null for null or empty byte arrays to prevent Source.Stream null exceptions.
59           /// </summary>
60           public class ByteArrayToImageConverter : IValueConverter
61           {
62               public object? Convert(object? value, Type targetType, object? parameter, CultureInfo culture)
63  ❌ 0         {
64  ❌ 0  ○          if (value is not byte[] bytes || bytes.Length == 0)
65  ❌ 0                 return null;
66           
67                   try
68  ❌ 0             {
69  ❌ 0                 using var stream = new MemoryStream(bytes);
70  ❌ 0                 return new Bitmap(stream);
71                   }
72  ❌ 0             catch
73  ❌ 0             {
74                       // Return null if image cannot be loaded
75  ❌ 0                 return null;
76                   }
77  ❌ 0         }
78           
79               public object? ConvertBack(object? value, Type targetType, object? parameter, CultureInfo culture)
80  ❌ 0             => throw new NotImplementedException();
81           }
```
# FWH.Mobile.ViewModels.CameraCaptureViewModel

## Summary

|||
|:---|:---|
| Class: | FWH.Mobile.ViewModels.CameraCaptureViewModel |
| Assembly: | FWH.Mobile |
| **File(s):** | E:\github\FunWasHad\src\FWH.Mobile\FWH.Mobile\ViewModels\CameraCaptureViewModel.cs |
| **Line coverage:** | 0% (0 of 58) |
| Covered lines: | 0 |
| Uncovered lines: | 58 |
| Coverable lines: | 58 |
| Total lines: | 117 |
| **Branch coverage:** | 0% (0 of 18) |
| Covered branches: | 0 |
| Total branches: | 18 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **.ctor(...)** | 0% | 6 | 2 | 0% |
| **CapturePhotoAsync()** | 0% | 210 | 14 | 0% |
| **ClearPhoto()** | 100% | 2 | 1 | 0% |
| **GetCapturedImageBytes()** | 0% | 6 | 2 | 0% |

## File(s)

### E:\github\FunWasHad\src\FWH.Mobile\FWH.Mobile\ViewModels\CameraCaptureViewModel.cs
```
  1           //using Avalonia.Media.Imaging;
  2           using CommunityToolkit.Mvvm.ComponentModel;
  3           using CommunityToolkit.Mvvm.Input;
  4           using FWH.Common.Chat.Services;
  5           using FWH.Mobile.Services;
  6           using Microsoft.Extensions.Logging;
  7           using System;
  8           using System.IO;
  9           using System.Threading.Tasks;
 10           
 11           namespace FWH.Mobile.ViewModels;
 12           
 13           /// <summary>
 14           /// ViewModel for the camera capture control
 15           /// </summary>
 16           public partial class CameraCaptureViewModel : ObservableObject
 17           {
 18               private readonly ICameraService _cameraService;
 19               private readonly ILogger<CameraCaptureViewModel>? _logger;
 20               private readonly IImageService? _imageService;
 21           
 22               [ObservableProperty]
 23               private byte[]? _capturedImage;
 24           
 25               [ObservableProperty]
 26               private bool _isCameraAvailable;
 27           
 28               [ObservableProperty]
 29               private bool _hasImage;
 30           
 31               [ObservableProperty]
 32               private bool _isCapturing;
 33           
 34               [ObservableProperty]
 35  ❌ 0         private string _statusMessage = "Tap to capture photo";
 36           
 37  ❌ 0         public CameraCaptureViewModel(
 38  ❌ 0             ICameraService cameraService,
 39  ❌ 0             ILogger<CameraCaptureViewModel>? logger = null,
 40  ❌ 0             IImageService? imageService = null)
 41  ❌ 0         {
 42  ❌ 0  ○          _cameraService = cameraService ?? throw new ArgumentNullException(nameof(cameraService));
 43  ❌ 0             _logger = logger;
 44  ❌ 0             _imageService = imageService;
 45                   // Defer IsCameraAvailable check until Activity is available
 46                   // Initialize to false - will be updated when actually needed
 47  ❌ 0             IsCameraAvailable = false;
 48  ❌ 0         }
 49           
 50               [RelayCommand]
 51               private async Task CapturePhotoAsync()
 52  ❌ 0         {
 53                   // Check camera availability when actually needed (Activity should be available by now)
 54  ❌ 0  ○          if (!IsCameraAvailable)
 55  ❌ 0             {
 56                       try
 57  ❌ 0                 {
 58  ❌ 0                     IsCameraAvailable = _cameraService.IsCameraAvailable;
 59  ❌ 0                 }
 60  ❌ 0                 catch (Exception ex)
 61  ❌ 0                 {
 62  ❌ 0  ○                  _logger?.LogWarning(ex, "Failed to check camera availability");
 63  ❌ 0                     IsCameraAvailable = false;
 64  ❌ 0                 }
 65  ❌ 0             }
 66           
 67  ❌ 0  ○          if (IsCapturing || !IsCameraAvailable)
 68  ❌ 0                 return;
 69           
 70                   try
 71  ❌ 0             {
 72  ❌ 0                 IsCapturing = true;
 73  ❌ 0                 StatusMessage = "Opening camera...";
 74           
 75  ❌ 0                 var imageBytes = await _cameraService.TakePhotoAsync();
 76           
 77  ❌ 0  ○              if (imageBytes != null && imageBytes.Length > 0)
 78  ❌ 0                 {
 79  ❌ 0                     CapturedImage = imageBytes;
 80  ❌ 0                     HasImage = true;
 81  ❌ 0                     StatusMessage = "Photo captured successfully!";
 82  ❌ 0                 }
 83                       else
 84  ❌ 0                 {
 85  ❌ 0                     StatusMessage = "Photo capture cancelled";
 86  ❌ 0                 }
 87  ❌ 0             }
 88  ❌ 0             catch (Exception ex)
 89  ❌ 0             {
 90  ❌ 0                 StatusMessage = $"Error: {ex.Message}";
 91  ❌ 0  ○              _logger?.LogError(ex, "Camera capture error");
 92  ❌ 0             }
 93                   finally
 94  ❌ 0             {
 95  ❌ 0                 IsCapturing = false;
 96  ❌ 0             }
 97  ❌ 0         }
 98           
 99               [RelayCommand]
100               private void ClearPhoto()
101  ❌ 0         {
102  ❌ 0             CapturedImage = null;
103  ❌ 0             HasImage = false;
104  ❌ 0             StatusMessage = "Tap to capture photo";
105  ❌ 0         }
106           
107               /// <summary>
108               /// Gets the captured image bytes (JPEG format)
109               /// </summary>
110               public byte[]? GetCapturedImageBytes()
111  ❌ 0         {
112  ❌ 0  ○          if (CapturedImage == null)
113  ❌ 0                 return null;
114           
115  ❌ 0             return CapturedImage;
116  ❌ 0         }
117           }
```
# FWH.Mobile.ViewModels.ChatInputModeToChoiceVisibility

## Summary

|||
|:---|:---|
| Class: | FWH.Mobile.ViewModels.ChatInputModeToChoiceVisibility |
| Assembly: | FWH.Mobile |
| **File(s):** | E:\github\FunWasHad\src\FWH.Mobile\FWH.Mobile\ViewModels\ChatConverters.cs |
| **Line coverage:** | 0% (0 of 2) |
| Covered lines: | 0 |
| Uncovered lines: | 2 |
| Coverable lines: | 2 |
| Total lines: | 81 |
| **Branch coverage:** | 0% (0 of 2) |
| Covered branches: | 0 |
| Total branches: | 2 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **Convert(...)** | 0% | 6 | 2 | 0% |
| **ConvertBack(...)** | 100% | 2 | 1 | 0% |

## File(s)

### E:\github\FunWasHad\src\FWH.Mobile\FWH.Mobile\ViewModels\ChatConverters.cs
```
 1           using System;
 2           using Avalonia.Data.Converters;
 3           using Avalonia.Layout;
 4           using Avalonia.Media;
 5           using System.Globalization;
 6           using Avalonia.Media.Imaging;
 7           using System.IO;
 8           
 9           namespace FWH.Mobile.ViewModels;
10           
11           public class AuthorToAlignmentConverter : IValueConverter
12           {
13               public object Convert(object? value, Type targetType, object? parameter, CultureInfo culture)
14                   => value is FWH.Common.Chat.ViewModels.ChatAuthors.User ? HorizontalAlignment.Right : HorizontalAlignment.Left;
15           
16               public object? ConvertBack(object? value, Type targetType, object? parameter, CultureInfo culture)
17                   => throw new NotImplementedException();
18           }
19           
20           public class AuthorToBrushConverter : IValueConverter
21           {
22               public object Convert(object? value, Type targetType, object? parameter, CultureInfo culture)
23                   => value is FWH.Common.Chat.ViewModels.ChatAuthors.User ? Brushes.DodgerBlue : Brushes.Gray;
24           
25               public object? ConvertBack(object? value, Type targetType, object? parameter, CultureInfo culture)
26                   => throw new NotImplementedException();
27           }
28           
29           public class ChatInputModeToTextVisibility : IValueConverter
30           {
31               public object Convert(object? value, Type targetType, object? parameter, CultureInfo culture)
32                   => value is FWH.Common.Chat.ViewModels.ChatInputModes.Text;
33           
34               public object? ConvertBack(object? value, Type targetType, object? parameter, CultureInfo culture)
35                   => throw new NotImplementedException();
36           }
37           
38           public class ChatInputModeToChoiceVisibility : IValueConverter
39           {
40               public object Convert(object? value, Type targetType, object? parameter, CultureInfo culture)
41  ❌ 0  ○          => value is FWH.Common.Chat.ViewModels.ChatInputModes.Choice;
42           
43               public object? ConvertBack(object? value, Type targetType, object? parameter, CultureInfo culture)
44  ❌ 0             => throw new NotImplementedException();
45           }
46           
47           public class ChatInputModeToPhotoVisibility : IValueConverter
48           {
49               public object Convert(object? value, Type targetType, object? parameter, CultureInfo culture)
50                   => value is FWH.Common.Chat.ViewModels.ChatInputModes.Image;
51           
52               public object? ConvertBack(object? value, Type targetType, object? parameter, CultureInfo culture)
53                   => throw new NotImplementedException();
54           }
55           
56           /// <summary>
57           /// Converts byte array to Bitmap for Avalonia Image controls.
58           /// Returns null for null or empty byte arrays to prevent Source.Stream null exceptions.
59           /// </summary>
60           public class ByteArrayToImageConverter : IValueConverter
61           {
62               public object? Convert(object? value, Type targetType, object? parameter, CultureInfo culture)
63               {
64                   if (value is not byte[] bytes || bytes.Length == 0)
65                       return null;
66           
67                   try
68                   {
69                       using var stream = new MemoryStream(bytes);
70                       return new Bitmap(stream);
71                   }
72                   catch
73                   {
74                       // Return null if image cannot be loaded
75                       return null;
76                   }
77               }
78           
79               public object? ConvertBack(object? value, Type targetType, object? parameter, CultureInfo culture)
80                   => throw new NotImplementedException();
81           }
```
# FWH.Mobile.ViewModels.ChatInputModeToPhotoVisibility

## Summary

|||
|:---|:---|
| Class: | FWH.Mobile.ViewModels.ChatInputModeToPhotoVisibility |
| Assembly: | FWH.Mobile |
| **File(s):** | E:\github\FunWasHad\src\FWH.Mobile\FWH.Mobile\ViewModels\ChatConverters.cs |
| **Line coverage:** | 0% (0 of 2) |
| Covered lines: | 0 |
| Uncovered lines: | 2 |
| Coverable lines: | 2 |
| Total lines: | 81 |
| **Branch coverage:** | 0% (0 of 2) |
| Covered branches: | 0 |
| Total branches: | 2 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **Convert(...)** | 0% | 6 | 2 | 0% |
| **ConvertBack(...)** | 100% | 2 | 1 | 0% |

## File(s)

### E:\github\FunWasHad\src\FWH.Mobile\FWH.Mobile\ViewModels\ChatConverters.cs
```
 1           using System;
 2           using Avalonia.Data.Converters;
 3           using Avalonia.Layout;
 4           using Avalonia.Media;
 5           using System.Globalization;
 6           using Avalonia.Media.Imaging;
 7           using System.IO;
 8           
 9           namespace FWH.Mobile.ViewModels;
10           
11           public class AuthorToAlignmentConverter : IValueConverter
12           {
13               public object Convert(object? value, Type targetType, object? parameter, CultureInfo culture)
14                   => value is FWH.Common.Chat.ViewModels.ChatAuthors.User ? HorizontalAlignment.Right : HorizontalAlignment.Left;
15           
16               public object? ConvertBack(object? value, Type targetType, object? parameter, CultureInfo culture)
17                   => throw new NotImplementedException();
18           }
19           
20           public class AuthorToBrushConverter : IValueConverter
21           {
22               public object Convert(object? value, Type targetType, object? parameter, CultureInfo culture)
23                   => value is FWH.Common.Chat.ViewModels.ChatAuthors.User ? Brushes.DodgerBlue : Brushes.Gray;
24           
25               public object? ConvertBack(object? value, Type targetType, object? parameter, CultureInfo culture)
26                   => throw new NotImplementedException();
27           }
28           
29           public class ChatInputModeToTextVisibility : IValueConverter
30           {
31               public object Convert(object? value, Type targetType, object? parameter, CultureInfo culture)
32                   => value is FWH.Common.Chat.ViewModels.ChatInputModes.Text;
33           
34               public object? ConvertBack(object? value, Type targetType, object? parameter, CultureInfo culture)
35                   => throw new NotImplementedException();
36           }
37           
38           public class ChatInputModeToChoiceVisibility : IValueConverter
39           {
40               public object Convert(object? value, Type targetType, object? parameter, CultureInfo culture)
41                   => value is FWH.Common.Chat.ViewModels.ChatInputModes.Choice;
42           
43               public object? ConvertBack(object? value, Type targetType, object? parameter, CultureInfo culture)
44                   => throw new NotImplementedException();
45           }
46           
47           public class ChatInputModeToPhotoVisibility : IValueConverter
48           {
49               public object Convert(object? value, Type targetType, object? parameter, CultureInfo culture)
50  ❌ 0  ○          => value is FWH.Common.Chat.ViewModels.ChatInputModes.Image;
51           
52               public object? ConvertBack(object? value, Type targetType, object? parameter, CultureInfo culture)
53  ❌ 0             => throw new NotImplementedException();
54           }
55           
56           /// <summary>
57           /// Converts byte array to Bitmap for Avalonia Image controls.
58           /// Returns null for null or empty byte arrays to prevent Source.Stream null exceptions.
59           /// </summary>
60           public class ByteArrayToImageConverter : IValueConverter
61           {
62               public object? Convert(object? value, Type targetType, object? parameter, CultureInfo culture)
63               {
64                   if (value is not byte[] bytes || bytes.Length == 0)
65                       return null;
66           
67                   try
68                   {
69                       using var stream = new MemoryStream(bytes);
70                       return new Bitmap(stream);
71                   }
72                   catch
73                   {
74                       // Return null if image cannot be loaded
75                       return null;
76                   }
77               }
78           
79               public object? ConvertBack(object? value, Type targetType, object? parameter, CultureInfo culture)
80                   => throw new NotImplementedException();
81           }
```
# FWH.Mobile.ViewModels.ChatInputModeToTextVisibility

## Summary

|||
|:---|:---|
| Class: | FWH.Mobile.ViewModels.ChatInputModeToTextVisibility |
| Assembly: | FWH.Mobile |
| **File(s):** | E:\github\FunWasHad\src\FWH.Mobile\FWH.Mobile\ViewModels\ChatConverters.cs |
| **Line coverage:** | 0% (0 of 2) |
| Covered lines: | 0 |
| Uncovered lines: | 2 |
| Coverable lines: | 2 |
| Total lines: | 81 |
| **Branch coverage:** | 0% (0 of 2) |
| Covered branches: | 0 |
| Total branches: | 2 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **Convert(...)** | 0% | 6 | 2 | 0% |
| **ConvertBack(...)** | 100% | 2 | 1 | 0% |

## File(s)

### E:\github\FunWasHad\src\FWH.Mobile\FWH.Mobile\ViewModels\ChatConverters.cs
```
 1           using System;
 2           using Avalonia.Data.Converters;
 3           using Avalonia.Layout;
 4           using Avalonia.Media;
 5           using System.Globalization;
 6           using Avalonia.Media.Imaging;
 7           using System.IO;
 8           
 9           namespace FWH.Mobile.ViewModels;
10           
11           public class AuthorToAlignmentConverter : IValueConverter
12           {
13               public object Convert(object? value, Type targetType, object? parameter, CultureInfo culture)
14                   => value is FWH.Common.Chat.ViewModels.ChatAuthors.User ? HorizontalAlignment.Right : HorizontalAlignment.Left;
15           
16               public object? ConvertBack(object? value, Type targetType, object? parameter, CultureInfo culture)
17                   => throw new NotImplementedException();
18           }
19           
20           public class AuthorToBrushConverter : IValueConverter
21           {
22               public object Convert(object? value, Type targetType, object? parameter, CultureInfo culture)
23                   => value is FWH.Common.Chat.ViewModels.ChatAuthors.User ? Brushes.DodgerBlue : Brushes.Gray;
24           
25               public object? ConvertBack(object? value, Type targetType, object? parameter, CultureInfo culture)
26                   => throw new NotImplementedException();
27           }
28           
29           public class ChatInputModeToTextVisibility : IValueConverter
30           {
31               public object Convert(object? value, Type targetType, object? parameter, CultureInfo culture)
32  ❌ 0  ○          => value is FWH.Common.Chat.ViewModels.ChatInputModes.Text;
33           
34               public object? ConvertBack(object? value, Type targetType, object? parameter, CultureInfo culture)
35  ❌ 0             => throw new NotImplementedException();
36           }
37           
38           public class ChatInputModeToChoiceVisibility : IValueConverter
39           {
40               public object Convert(object? value, Type targetType, object? parameter, CultureInfo culture)
41                   => value is FWH.Common.Chat.ViewModels.ChatInputModes.Choice;
42           
43               public object? ConvertBack(object? value, Type targetType, object? parameter, CultureInfo culture)
44                   => throw new NotImplementedException();
45           }
46           
47           public class ChatInputModeToPhotoVisibility : IValueConverter
48           {
49               public object Convert(object? value, Type targetType, object? parameter, CultureInfo culture)
50                   => value is FWH.Common.Chat.ViewModels.ChatInputModes.Image;
51           
52               public object? ConvertBack(object? value, Type targetType, object? parameter, CultureInfo culture)
53                   => throw new NotImplementedException();
54           }
55           
56           /// <summary>
57           /// Converts byte array to Bitmap for Avalonia Image controls.
58           /// Returns null for null or empty byte arrays to prevent Source.Stream null exceptions.
59           /// </summary>
60           public class ByteArrayToImageConverter : IValueConverter
61           {
62               public object? Convert(object? value, Type targetType, object? parameter, CultureInfo culture)
63               {
64                   if (value is not byte[] bytes || bytes.Length == 0)
65                       return null;
66           
67                   try
68                   {
69                       using var stream = new MemoryStream(bytes);
70                       return new Bitmap(stream);
71                   }
72                   catch
73                   {
74                       // Return null if image cannot be loaded
75                       return null;
76                   }
77               }
78           
79               public object? ConvertBack(object? value, Type targetType, object? parameter, CultureInfo culture)
80                   => throw new NotImplementedException();
81           }
```
# FWH.Mobile.ViewModels.LogViewerViewModel

## Summary

|||
|:---|:---|
| Class: | FWH.Mobile.ViewModels.LogViewerViewModel |
| Assembly: | FWH.Mobile |
| **File(s):** | E:\github\FunWasHad\src\FWH.Mobile\FWH.Mobile\ViewModels\LogViewerViewModel.cs |
| **Line coverage:** | 0% (0 of 93) |
| Covered lines: | 0 |
| Uncovered lines: | 93 |
| Coverable lines: | 93 |
| Total lines: | 167 |
| **Branch coverage:** | 0% (0 of 40) |
| Covered branches: | 0 |
| Total branches: | 40 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **.ctor(...)** | 0% | 6 | 2 | 0% |
| **get_Entries()** | 100% | 2 | 1 | 0% |
| **get_FilteredEntries()** | 100% | 2 | 1 | 0% |
| **get_ClearCommand()** | 100% | 2 | 1 | 0% |
| **get_ScrollToEndCommand()** | 100% | 2 | 1 | 0% |
| **get_TogglePauseCommand()** | 100% | 2 | 1 | 0% |
| **get_IsPaused()** | 100% | 2 | 1 | 0% |
| **set_IsPaused(...)** | 0% | 6 | 2 | 0% |
| **get_PauseButtonText()** | 0% | 6 | 2 | 0% |
| **get_PauseButtonToolTip()** | 0% | 6 | 2 | 0% |
| **get_SelectedLogLevel()** | 100% | 2 | 1 | 0% |
| **set_SelectedLogLevel(...)** | 0% | 6 | 2 | 0% |
| **get_LogLevels()** | 100% | 2 | 1 | 0% |
| **OnEntriesCollectionChanged(...)** | 0% | 210 | 14 | 0% |
| **TogglePause()** | 0% | 6 | 2 | 0% |
| **UpdateFilteredEntries(...)** | 0% | 72 | 8 | 0% |
| **.ctor(...)** | 0% | 6 | 2 | 0% |
| **CanExecute(...)** | 100% | 2 | 1 | 0% |
| **Execute(...)** | 100% | 2 | 1 | 0% |
| **add_CanExecuteChanged(...)** | 100% | 2 | 1 | 0% |
| **OnPropertyChanged(...)** | 0% | 6 | 2 | 0% |

## File(s)

### E:\github\FunWasHad\src\FWH.Mobile\FWH.Mobile\ViewModels\LogViewerViewModel.cs
```
  1           using System;
  2           using System.Collections.ObjectModel;
  3           using System.Collections.Specialized;
  4           using System.ComponentModel;
  5           using System.Linq;
  6           using System.Runtime.CompilerServices;
  7           using System.Windows.Input;
  8           using FWH.Mobile.Logging;
  9           using Microsoft.Extensions.Logging;
 10           
 11           namespace FWH.Mobile.ViewModels;
 12           
 13           public sealed class LogViewerViewModel : INotifyPropertyChanged
 14           {
 15               private readonly AvaloniaLogStore _store;
 16  ❌ 0         private LogLevel _selectedLogLevel = LogLevel.Trace;
 17  ❌ 0         private readonly ObservableCollection<AvaloniaLogEntry> _filteredEntries = new();
 18               private bool _isPaused;
 19           
 20  ❌ 0         public LogViewerViewModel(AvaloniaLogStore store)
 21  ❌ 0         {
 22  ❌ 0  ○          _store = store ?? throw new ArgumentNullException(nameof(store));
 23  ❌ 0             ClearCommand = new RelayCommand(_store.Clear);
 24  ❌ 0  ○          ScrollToEndCommand = new RelayCommand(() => ScrollToEndRequested?.Invoke());
 25  ❌ 0             TogglePauseCommand = new RelayCommand(TogglePause);
 26           
 27                   // Initialize filtered entries and subscribe to changes
 28  ❌ 0             UpdateFilteredEntries(scrollToEnd: false);
 29  ❌ 0             _store.Entries.CollectionChanged += OnEntriesCollectionChanged;
 30  ❌ 0         }
 31           
 32  ❌ 0         public ObservableCollection<AvaloniaLogEntry> Entries => _store.Entries;
 33           
 34  ❌ 0         public ObservableCollection<AvaloniaLogEntry> FilteredEntries => _filteredEntries;
 35           
 36  ❌ 0         public ICommand ClearCommand { get; }
 37           
 38  ❌ 0         public ICommand ScrollToEndCommand { get; }
 39           
 40  ❌ 0         public ICommand TogglePauseCommand { get; }
 41           
 42               public bool IsPaused
 43               {
 44  ❌ 0             get => _isPaused;
 45                   private set
 46  ❌ 0             {
 47  ❌ 0  ○              if (_isPaused != value)
 48  ❌ 0                 {
 49  ❌ 0                     _isPaused = value;
 50  ❌ 0                     OnPropertyChanged();
 51  ❌ 0                     OnPropertyChanged(nameof(PauseButtonText));
 52  ❌ 0                     OnPropertyChanged(nameof(PauseButtonToolTip));
 53  ❌ 0                 }
 54  ❌ 0             }
 55               }
 56           
 57  ❌ 0  ○      public string PauseButtonText => _isPaused ? "▶" : "⏸";
 58           
 59  ❌ 0  ○      public string PauseButtonToolTip => _isPaused ? "Resume logging" : "Pause logging";
 60           
 61               public event Action? ScrollToEndRequested;
 62           
 63               public LogLevel SelectedLogLevel
 64               {
 65  ❌ 0             get => _selectedLogLevel;
 66                   set
 67  ❌ 0             {
 68  ❌ 0  ○              if (_selectedLogLevel != value)
 69  ❌ 0                 {
 70  ❌ 0                     _selectedLogLevel = value;
 71  ❌ 0                     OnPropertyChanged();
 72  ❌ 0                     UpdateFilteredEntries(scrollToEnd: true);
 73  ❌ 0                 }
 74  ❌ 0             }
 75               }
 76           
 77  ❌ 0         public LogLevel[] LogLevels { get; } = new[]
 78  ❌ 0         {
 79  ❌ 0             LogLevel.Trace,
 80  ❌ 0             LogLevel.Debug,
 81  ❌ 0             LogLevel.Information,
 82  ❌ 0             LogLevel.Warning,
 83  ❌ 0             LogLevel.Error,
 84  ❌ 0             LogLevel.Critical
 85  ❌ 0         };
 86           
 87               private void OnEntriesCollectionChanged(object? sender, NotifyCollectionChangedEventArgs e)
 88  ❌ 0         {
 89                   // If paused, don't process new entries
 90  ❌ 0  ○          if (_isPaused && e.Action == NotifyCollectionChangedAction.Add)
 91  ❌ 0             {
 92  ❌ 0                 return;
 93                   }
 94           
 95  ❌ 0  ○          if (e.Action == NotifyCollectionChangedAction.Add && e.NewItems != null)
 96  ❌ 0             {
 97                       // Only add new entries that match the filter
 98  ❌ 0                 var newEntries = e.NewItems.Cast<AvaloniaLogEntry>()
 99  ❌ 0                     .Where(entry => entry.Level >= _selectedLogLevel)
100  ❌ 0                     .ToList();
101           
102  ❌ 0  ○              foreach (var entry in newEntries)
103  ❌ 0                 {
104  ❌ 0                     _filteredEntries.Add(entry);
105  ❌ 0                 }
106           
107                       // Scroll to end when new entries are added
108  ❌ 0  ○              if (newEntries.Any())
109  ❌ 0                 {
110  ❌ 0  ○                  ScrollToEndRequested?.Invoke();
111  ❌ 0                 }
112  ❌ 0             }
113                   else
114  ❌ 0             {
115                       // Rebuild filtered list for any other collection change (Reset, Remove, Replace, Move)
116  ❌ 0                 UpdateFilteredEntries(scrollToEnd: false);
117  ❌ 0             }
118  ❌ 0         }
119           
120               private void TogglePause()
121  ❌ 0         {
122  ❌ 0             IsPaused = !IsPaused;
123           
124                   // If resuming, update filtered entries to catch up on any missed entries
125  ❌ 0  ○          if (!IsPaused)
126  ❌ 0             {
127  ❌ 0                 UpdateFilteredEntries(scrollToEnd: true);
128  ❌ 0             }
129  ❌ 0         }
130           
131               private void UpdateFilteredEntries(bool scrollToEnd = false)
132  ❌ 0         {
133                   // Clear and rebuild filtered list to maintain order and filter correctly
134  ❌ 0             _filteredEntries.Clear();
135           
136  ❌ 0  ○          foreach (var entry in _store.Entries.Where(entry => entry.Level >= _selectedLogLevel))
137  ❌ 0             {
138  ❌ 0                 _filteredEntries.Add(entry);
139  ❌ 0             }
140           
141                   // Only scroll to end if explicitly requested (e.g., when filter changes)
142  ❌ 0  ○          if (scrollToEnd && _filteredEntries.Count > 0)
143  ❌ 0             {
144  ❌ 0  ○              ScrollToEndRequested?.Invoke();
145  ❌ 0             }
146  ❌ 0         }
147           
148               private sealed class RelayCommand : ICommand
149               {
150                   private readonly Action _execute;
151           
152  ❌ 0  ○          public RelayCommand(Action execute) => _execute = execute ?? throw new ArgumentNullException(nameof(execute));
153           
154  ❌ 0             public bool CanExecute(object? parameter) => true;
155           
156  ❌ 0             public void Execute(object? parameter) => _execute();
157           
158  ❌ 0             public event EventHandler? CanExecuteChanged { add { } remove { } }
159               }
160           
161               public event PropertyChangedEventHandler? PropertyChanged;
162           
163               private void OnPropertyChanged([CallerMemberName] string? propertyName = null)
164  ❌ 0         {
165  ❌ 0  ○          PropertyChanged?.Invoke(this, new PropertyChangedEventArgs(propertyName));
166  ❌ 0         }
167           }
```
# FWH.Mobile.ViewModels.MainViewModel

## Summary

|||
|:---|:---|
| Class: | FWH.Mobile.ViewModels.MainViewModel |
| Assembly: | FWH.Mobile |
| **File(s):** | E:\github\FunWasHad\src\FWH.Mobile\FWH.Mobile\ViewModels\MainViewModel.cs |
| **Line coverage:** | 0% (0 of 28) |
| Covered lines: | 0 |
| Uncovered lines: | 28 |
| Coverable lines: | 28 |
| Total lines: | 74 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **.ctor()** | 100% | 2 | 1 | 0% |
| **get_ShowLogViewAlways()** | 100% | 2 | 1 | 0% |
| **NavigateToChat()** | 100% | 2 | 1 | 0% |
| **NavigateToMap()** | 100% | 2 | 1 | 0% |
| **NavigateToSettings()** | 100% | 2 | 1 | 0% |
| **NavigateToLog()** | 100% | 2 | 1 | 0% |
| **NavigateToPlaces()** | 100% | 2 | 1 | 0% |

## File(s)

### E:\github\FunWasHad\src\FWH.Mobile\FWH.Mobile\ViewModels\MainViewModel.cs
```
 1           using Avalonia.Controls;
 2           using CommunityToolkit.Mvvm.ComponentModel;
 3           using CommunityToolkit.Mvvm.Input;
 4           using FWH.Mobile.Views;
 5           
 6           namespace FWH.Mobile.ViewModels;
 7           
 8           /// <summary>
 9           /// ViewModel for MainView that handles navigation between different views.
10           /// </summary>
11           public partial class MainViewModel : ObservableObject
12           {
13               [ObservableProperty]
14               private UserControl? _currentView;
15           
16               [ObservableProperty]
17  ❌ 0         private string _currentViewName = "Chat";
18           
19               /// <summary>
20               /// Gets whether the log view should always be visible (when not in RELEASE build).
21               /// </summary>
22               public bool ShowLogViewAlways
23               {
24                   get
25  ❌ 0             {
26           #if DEBUG || STAGING
27  ❌ 0                 return true;
28           #else
29                       return false;
30           #endif
31  ❌ 0             }
32               }
33           
34  ❌ 0         public MainViewModel()
35  ❌ 0         {
36                   // Start with Chat view
37  ❌ 0             NavigateToChat();
38  ❌ 0         }
39           
40               [RelayCommand]
41               private void NavigateToChat()
42  ❌ 0         {
43  ❌ 0             CurrentView = new ChatView();
44  ❌ 0             CurrentViewName = "Chat";
45  ❌ 0         }
46           
47               [RelayCommand]
48               private void NavigateToMap()
49  ❌ 0         {
50  ❌ 0             CurrentView = new MapView();
51  ❌ 0             CurrentViewName = "Map";
52  ❌ 0         }
53           
54               [RelayCommand]
55               private void NavigateToSettings()
56  ❌ 0         {
57  ❌ 0             CurrentView = new SettingsView();
58  ❌ 0             CurrentViewName = "Settings";
59  ❌ 0         }
60           
61               [RelayCommand]
62               private void NavigateToLog()
63  ❌ 0         {
64  ❌ 0             CurrentView = new LogView();
65  ❌ 0             CurrentViewName = "Log";
66  ❌ 0         }
67           
68               [RelayCommand]
69               private void NavigateToPlaces()
70  ❌ 0         {
71  ❌ 0             CurrentView = new PlacesView();
72  ❌ 0             CurrentViewName = "Places";
73  ❌ 0         }
74           }
```
# FWH.Mobile.ViewModels.MovementStateViewModel

## Summary

|||
|:---|:---|
| Class: | FWH.Mobile.ViewModels.MovementStateViewModel |
| Assembly: | FWH.Mobile |
| **File(s):** | E:\github\FunWasHad\src\FWH.Mobile\FWH.Mobile\ViewModels\MovementStateViewModel.cs |
| **Line coverage:** | 0% (0 of 154) |
| Covered lines: | 0 |
| Uncovered lines: | 154 |
| Coverable lines: | 154 |
| Total lines: | 246 |
| **Branch coverage:** | 0% (0 of 38) |
| Covered branches: | 0 |
| Total branches: | 38 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **.ctor(...)** | 0% | 72 | 8 | 0% |
| **get_DisplayAddress()** | 0% | 6 | 2 | 0% |
| **OnMovementStateChanged(...)** | 100% | 2 | 1 | 0% |
| **OnLocationUpdated(...)** | 100% | 2 | 1 | 0% |
| **OnNewLocationAddress(...)** | 100% | 2 | 1 | 0% |
| **UpdateAddress()** | 0% | 42 | 6 | 0% |
| **CheckForBusinessAsync()** | 0% | 6 | 2 | 0% |
| **UpdateMovementState(...)** | 0% | 42 | 6 | 0% |
| **UpdateSpeed()** | 0% | 42 | 6 | 0% |
| **UpdateTrackingStatus()** | 0% | 6 | 2 | 0% |
| **UpdateCoordinates()** | 0% | 42 | 6 | 0% |
| **Refresh()** | 100% | 2 | 1 | 0% |

## File(s)

### E:\github\FunWasHad\src\FWH.Mobile\FWH.Mobile\ViewModels\MovementStateViewModel.cs
```
  1           using CommunityToolkit.Mvvm.ComponentModel;
  2           using FWH.Common.Location;
  3           using FWH.Mobile.Configuration;
  4           using FWH.Mobile.Services;
  5           using Microsoft.Extensions.Logging;
  6           using System.Threading.Tasks;
  7           
  8           namespace FWH.Mobile.ViewModels;
  9           
 10           /// <summary>
 11           /// ViewModel for displaying real-time movement state information.
 12           /// Shows current movement state, speed, and tracking status.
 13           /// </summary>
 14           public partial class MovementStateViewModel : ObservableObject
 15           {
 16               private readonly ILocationTrackingService _locationTrackingService;
 17               private readonly ILocationService _locationService;
 18               private readonly LocationSettings _locationSettings;
 19               private readonly ILogger<MovementStateViewModel> _logger;
 20           
 21               [ObservableProperty]
 22  ❌ 0         private string _movementStateText = "Unknown";
 23           
 24               [ObservableProperty]
 25  ❌ 0         private string _movementStateColor = "#808080"; // Gray for Unknown
 26           
 27               [ObservableProperty]
 28  ❌ 0         private string _speedText = "--";
 29           
 30               [ObservableProperty]
 31  ❌ 0         private string _trackingStatusText = "Tracking: Stopped";
 32           
 33               [ObservableProperty]
 34  ❌ 0         private string _trackingStatusColor = "#DC3545"; // Red for stopped
 35           
 36               [ObservableProperty]
 37               private double? _latitude;
 38           
 39               [ObservableProperty]
 40               private double? _longitude;
 41           
 42               [ObservableProperty]
 43  ❌ 0         private string _coordinatesText = "--";
 44           
 45               [ObservableProperty]
 46  ❌ 0         private string _currentAddress = "--";
 47           
 48               [ObservableProperty]
 49  ❌ 0         private bool _hasAddress = false;
 50           
 51               [ObservableProperty]
 52               private string? _businessName;
 53           
 54               /// <summary>
 55               /// Gets the display address - shows business name if available, otherwise shows address.
 56               /// </summary>
 57  ❌ 0  ○      public string DisplayAddress => !string.IsNullOrEmpty(BusinessName) ? BusinessName : CurrentAddress;
 58           
 59  ❌ 0         public MovementStateViewModel(
 60  ❌ 0             ILocationTrackingService locationTrackingService,
 61  ❌ 0             ILocationService locationService,
 62  ❌ 0             LocationSettings locationSettings,
 63  ❌ 0             ILogger<MovementStateViewModel> logger)
 64  ❌ 0         {
 65  ❌ 0  ○          _locationTrackingService = locationTrackingService ?? throw new ArgumentNullException(nameof(locationTrackingSer
 66  ❌ 0  ○          _locationService = locationService ?? throw new ArgumentNullException(nameof(locationService));
 67  ❌ 0  ○          _locationSettings = locationSettings ?? throw new ArgumentNullException(nameof(locationSettings));
 68  ❌ 0  ○          _logger = logger ?? throw new ArgumentNullException(nameof(logger));
 69           
 70                   // Subscribe to events
 71  ❌ 0             _locationTrackingService.MovementStateChanged += OnMovementStateChanged;
 72  ❌ 0             _locationTrackingService.LocationUpdated += OnLocationUpdated;
 73  ❌ 0             _locationTrackingService.NewLocationAddress += OnNewLocationAddress;
 74           
 75                   // Initialize with current state
 76  ❌ 0             UpdateMovementState(_locationTrackingService.CurrentMovementState);
 77  ❌ 0             UpdateSpeed();
 78  ❌ 0             UpdateTrackingStatus();
 79  ❌ 0             UpdateCoordinates();
 80  ❌ 0             UpdateAddress();
 81  ❌ 0         }
 82           
 83               private void OnMovementStateChanged(object? sender, MovementStateChangedEventArgs e)
 84  ❌ 0         {
 85  ❌ 0             _logger.LogDebug("Movement state changed from {Previous} to {Current}", e.PreviousState, e.CurrentState);
 86  ❌ 0             UpdateMovementState(e.CurrentState);
 87  ❌ 0             UpdateSpeed();
 88  ❌ 0         }
 89           
 90               private void OnLocationUpdated(object? sender, Common.Location.Models.GpsCoordinates e)
 91  ❌ 0         {
 92  ❌ 0             _logger.LogDebug("Location updated: ({Lat}, {Lon})", e.Latitude, e.Longitude);
 93  ❌ 0             Latitude = e.Latitude;
 94  ❌ 0             Longitude = e.Longitude;
 95  ❌ 0             UpdateCoordinates();
 96  ❌ 0             UpdateSpeed();
 97  ❌ 0             UpdateTrackingStatus();
 98  ❌ 0         }
 99           
100               private void OnNewLocationAddress(object? sender, LocationAddressChangedEventArgs e)
101  ❌ 0         {
102  ❌ 0             _logger.LogInformation("Address changed to: {Address}", e.CurrentAddress);
103  ❌ 0             CurrentAddress = e.CurrentAddress;
104  ❌ 0             HasAddress = !string.IsNullOrEmpty(e.CurrentAddress);
105  ❌ 0         }
106           
107               private void UpdateAddress()
108  ❌ 0         {
109  ❌ 0             var address = _locationTrackingService.CurrentAddress;
110  ❌ 0  ○          if (!string.IsNullOrEmpty(address))
111  ❌ 0             {
112  ❌ 0                 CurrentAddress = address;
113  ❌ 0                 HasAddress = true;
114  ❌ 0             }
115                   else
116  ❌ 0             {
117  ❌ 0                 CurrentAddress = "--";
118  ❌ 0                 HasAddress = false;
119  ❌ 0             }
120  ❌ 0             OnPropertyChanged(nameof(DisplayAddress));
121           
122                   // Check for business if we have coordinates
123  ❌ 0  ○          if (Latitude.HasValue && Longitude.HasValue)
124  ❌ 0             {
125  ❌ 0                 var location = new Common.Location.Models.GpsCoordinates
126  ❌ 0                 {
127  ❌ 0                     Latitude = Latitude.Value,
128  ❌ 0                     Longitude = Longitude.Value
129  ❌ 0                 };
130  ❌ 0                 _ = CheckForBusinessAsync(location);
131  ❌ 0             }
132  ❌ 0         }
133           
134               private async Task CheckForBusinessAsync(Common.Location.Models.GpsCoordinates location)
135  ❌ 0         {
136                   try
137  ❌ 0             {
138  ❌ 0                 var business = await _locationService.GetClosestBusinessAsync(
139  ❌ 0                     location.Latitude,
140  ❌ 0                     location.Longitude,
141  ❌ 0                     maxDistanceMeters: 100, // Check within 100m for businesses
142  ❌ 0                     cancellationToken: default);
143           
144  ❌ 0  ○              if (business != null)
145  ❌ 0                 {
146  ❌ 0                     BusinessName = business.Name;
147  ❌ 0                     _logger.LogDebug("Found business at current location: {BusinessName}", business.Name);
148  ❌ 0                     OnPropertyChanged(nameof(DisplayAddress));
149  ❌ 0                 }
150                       else
151  ❌ 0                 {
152  ❌ 0                     BusinessName = null;
153  ❌ 0                     OnPropertyChanged(nameof(DisplayAddress));
154  ❌ 0                 }
155  ❌ 0             }
156  ❌ 0             catch (Exception ex)
157  ❌ 0             {
158  ❌ 0                 _logger.LogWarning(ex, "Error checking for business at current location");
159  ❌ 0                 BusinessName = null;
160  ❌ 0                 OnPropertyChanged(nameof(DisplayAddress));
161  ❌ 0             }
162  ❌ 0         }
163           
164               private void UpdateMovementState(MovementState state)
165  ❌ 0         {
166  ❌ 0             MovementStateText = $"{state}";
167           
168  ❌ 0  ○          MovementStateColor = state switch
169  ❌ 0             {
170  ❌ 0                 MovementState.Unknown => "#6C757D", // Gray
171  ❌ 0                 MovementState.Stationary => "#007BFF", // Blue
172  ❌ 0                 MovementState.Walking => "#28A745", // Green
173  ❌ 0                 MovementState.Riding => "#FFC107", // Yellow/Amber
174  ❌ 0                 MovementState.Moving => "#17A2B8", // Cyan
175  ❌ 0                 _ => "#6C757D"
176  ❌ 0             };
177  ❌ 0         }
178           
179               private void UpdateSpeed()
180  ❌ 0         {
181  ❌ 0             var speedMph = _locationTrackingService.CurrentSpeedMph;
182  ❌ 0             var speedKmh = _locationTrackingService.CurrentSpeedKmh;
183           
184  ❌ 0  ○          if (!speedMph.HasValue || !speedKmh.HasValue)
185  ❌ 0             {
186  ❌ 0                 SpeedText = "--";
187  ❌ 0                 return;
188                   }
189           
190                   // Display speed based on configured unit preference
191  ❌ 0  ○          if (_locationSettings.UseKmh)
192  ❌ 0             {
193  ❌ 0                 SpeedText = $"{speedKmh.Value:F1} km/h";
194  ❌ 0             }
195                   else
196  ❌ 0             {
197                       // Default to mph
198  ❌ 0                 SpeedText = $"{speedMph.Value:F1} mph";
199  ❌ 0             }
200  ❌ 0         }
201           
202               private void UpdateTrackingStatus()
203  ❌ 0         {
204  ❌ 0  ○          if (_locationTrackingService.IsTracking)
205  ❌ 0             {
206  ❌ 0                 TrackingStatusText = "Tracking: Active";
207  ❌ 0                 TrackingStatusColor = "#28A745"; // Green
208  ❌ 0             }
209                   else
210  ❌ 0             {
211  ❌ 0                 TrackingStatusText = "Tracking: Stopped";
212  ❌ 0                 TrackingStatusColor = "#DC3545"; // Red
213  ❌ 0             }
214  ❌ 0         }
215           
216               private void UpdateCoordinates()
217  ❌ 0         {
218  ❌ 0  ○          if (Latitude.HasValue && Longitude.HasValue)
219  ❌ 0             {
220  ❌ 0                 CoordinatesText = $"{Latitude.Value:F6}, {Longitude.Value:F6}";
221  ❌ 0             }
222  ❌ 0  ○          else if (_locationTrackingService.LastKnownLocation != null)
223  ❌ 0             {
224  ❌ 0                 var loc = _locationTrackingService.LastKnownLocation;
225  ❌ 0                 Latitude = loc.Latitude;
226  ❌ 0                 Longitude = loc.Longitude;
227  ❌ 0                 CoordinatesText = $"{loc.Latitude:F6}, {loc.Longitude:F6}";
228  ❌ 0             }
229                   else
230  ❌ 0             {
231  ❌ 0                 CoordinatesText = "--";
232  ❌ 0             }
233  ❌ 0         }
234           
235               /// <summary>
236               /// Refreshes all displayed data from the tracking service.
237               /// </summary>
238               public void Refresh()
239  ❌ 0         {
240  ❌ 0             UpdateMovementState(_locationTrackingService.CurrentMovementState);
241  ❌ 0             UpdateSpeed();
242  ❌ 0             UpdateTrackingStatus();
243  ❌ 0             UpdateCoordinates();
244  ❌ 0             UpdateAddress();
245  ❌ 0         }
246           }
```
# FWH.Mobile.ViewModels.PlaceItem

## Summary

|||
|:---|:---|
| Class: | FWH.Mobile.ViewModels.PlaceItem |
| Assembly: | FWH.Mobile |
| **File(s):** | E:\github\FunWasHad\src\FWH.Mobile\FWH.Mobile\ViewModels\PlacesViewModel.cs |
| **Line coverage:** | 0% (0 of 29) |
| Covered lines: | 0 |
| Uncovered lines: | 29 |
| Coverable lines: | 29 |
| Total lines: | 540 |
| **Branch coverage:** | 0% (0 of 10) |
| Covered branches: | 0 |
| Total branches: | 10 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **get_Id()** | 100% | 2 | 1 | 0% |
| **get_BusinessName()** | 100% | 2 | 1 | 0% |
| **get_Address()** | 100% | 2 | 1 | 0% |
| **get_City()** | 100% | 2 | 1 | 0% |
| **get_Category()** | 100% | 2 | 1 | 0% |
| **get_Latitude()** | 100% | 2 | 1 | 0% |
| **get_Longitude()** | 100% | 2 | 1 | 0% |
| **get_StationaryAt()** | 100% | 2 | 1 | 0% |
| **get_LocalTime()** | 100% | 2 | 1 | 0% |
| **get_IsFavorite()** | 100% | 2 | 1 | 0% |
| **get_LogoUrl()** | 100% | 2 | 1 | 0% |
| **set_LogoUrl(...)** | 0% | 6 | 2 | 0% |
| **get_PrimaryColor()** | 100% | 2 | 1 | 0% |
| **get_SecondaryColor()** | 100% | 2 | 1 | 0% |
| **get_AccentColor()** | 100% | 2 | 1 | 0% |
| **get_BackgroundColor()** | 100% | 2 | 1 | 0% |
| **get_TextColor()** | 100% | 2 | 1 | 0% |
| **get_BackgroundImageUrl()** | 100% | 2 | 1 | 0% |
| **get_DisplayName()** | 0% | 20 | 4 | 0% |
| **get_DisplayAddress()** | 0% | 6 | 2 | 0% |
| **OnPropertyChanged(...)** | 0% | 6 | 2 | 0% |

## File(s)

### E:\github\FunWasHad\src\FWH.Mobile\FWH.Mobile\ViewModels\PlacesViewModel.cs
```
  1           using System;
  2           using System.Collections.Generic;
  3           using System.Collections.ObjectModel;
  4           using System.ComponentModel;
  5           using System.Globalization;
  6           using System.Linq;
  7           using System.Net.Http;
  8           using System.Net.Http.Json;
  9           using System.Runtime.CompilerServices;
 10           using System.Threading.Tasks;
 11           using System.Windows.Input;
 12           using FWH.Mobile.Configuration;
 13           using FWH.Mobile.Data.Data;
 14           using FWH.Mobile.Services;
 15           using FWH.Mobile.Data.Entities;
 16           using Microsoft.EntityFrameworkCore;
 17           using Microsoft.Extensions.Logging;
 18           
 19           namespace FWH.Mobile.ViewModels;
 20           
 21           /// <summary>
 22           /// ViewModel for displaying places where the user became stationary.
 23           /// Shows a reverse chronological list of businesses and locations.
 24           /// </summary>
 25           public class PlacesViewModel : INotifyPropertyChanged
 26           {
 27               private readonly NotesDbContext _dbContext;
 28               private readonly ILogger<PlacesViewModel> _logger;
 29               private readonly string _deviceId;
 30               private readonly IImageService? _imageService;
 31               private readonly IHttpClientFactory? _httpClientFactory;
 32               private readonly ApiSettings? _apiSettings;
 33               private bool _isLoading;
 34               private readonly ObservableCollection<PlaceItem> _allPlaces = new();
 35           
 36               public PlacesViewModel(
 37                   NotesDbContext dbContext,
 38                   ILogger<PlacesViewModel> logger,
 39                   string deviceId,
 40                   IImageService? imageService = null,
 41                   IHttpClientFactory? httpClientFactory = null,
 42                   ApiSettings? apiSettings = null)
 43               {
 44                   _dbContext = dbContext ?? throw new ArgumentNullException(nameof(dbContext));
 45                   _logger = logger ?? throw new ArgumentNullException(nameof(logger));
 46                   _deviceId = deviceId ?? throw new ArgumentNullException(nameof(deviceId));
 47                   _imageService = imageService;
 48                   _httpClientFactory = httpClientFactory;
 49                   _apiSettings = apiSettings;
 50                   Places = new ObservableCollection<PlaceItem>();
 51                   Places.CollectionChanged += (_, _) => OnPropertyChanged(nameof(IsEmpty));
 52           
 53                   DeletePlaceCommand = new RelayCommand<PlaceItem>(DeletePlace);
 54                   ToggleFavoriteCommand = new RelayCommand<PlaceItem>(ToggleFavorite);
 55                   FilterModes = new[] { "All", "Favorites" };
 56           
 57                   _ = LoadPlacesAsync();
 58               }
 59           
 60               public ObservableCollection<PlaceItem> Places { get; }
 61           
 62               public bool IsLoading
 63               {
 64                   get => _isLoading;
 65                   private set
 66                   {
 67                       if (_isLoading != value)
 68                       {
 69                           _isLoading = value;
 70                           OnPropertyChanged();
 71                           OnPropertyChanged(nameof(IsEmpty));
 72                       }
 73                   }
 74               }
 75           
 76               public bool IsEmpty => !IsLoading && Places.Count == 0;
 77           
 78               public ICommand DeletePlaceCommand { get; }
 79               public ICommand ToggleFavoriteCommand { get; }
 80           
 81               public string[] FilterModes { get; }
 82           
 83               private string _filterMode = "All";
 84               public string FilterMode
 85               {
 86                   get => _filterMode;
 87                   set
 88                   {
 89                       if (_filterMode != value)
 90                       {
 91                           _filterMode = value;
 92                           OnPropertyChanged();
 93                           ApplyFilter();
 94                       }
 95                   }
 96               }
 97           
 98               public async Task LoadPlacesAsync()
 99               {
100                   try
101                   {
102                       IsLoading = true;
103           
104                       var places = await _dbContext.StationaryPlaces
105                           .Where(p => p.DeviceId == _deviceId)
106                           .OrderByDescending(p => p.StationaryAt)
107                           .ToListAsync();
108           
109                       _allPlaces.Clear();
110                       var placesNeedingLogoFetch = new List<(PlaceItem item, string businessName, double lat, double lon)>();
111           
112                       foreach (var place in places)
113                       {
114                           var city = ExtractCityFromAddress(place.Address);
115                           var localTime = ConvertToLocalTime(place.StationaryAt, place.Longitude);
116           
117                           var placeItem = new PlaceItem
118                           {
119                               Id = place.Id,
120                               BusinessName = place.BusinessName,
121                               Address = place.Address,
122                               City = city,
123                               Category = place.Category,
124                               Latitude = place.Latitude,
125                               Longitude = place.Longitude,
126                               StationaryAt = place.StationaryAt,
127                               LocalTime = localTime,
128                               IsFavorite = place.IsFavorite,
129                               // Use cached marketing info if available
130                               LogoUrl = place.LogoUrl,
131                               PrimaryColor = place.PrimaryColor,
132                               SecondaryColor = place.SecondaryColor,
133                               AccentColor = place.AccentColor,
134                               BackgroundColor = place.BackgroundColor,
135                               TextColor = place.TextColor,
136                               BackgroundImageUrl = place.BackgroundImageUrl
137                           };
138           
139                           _allPlaces.Add(placeItem);
140           
141                           // Only fetch logo if business name is available and marketing info is not cached or stale
142                           if (!string.IsNullOrEmpty(place.BusinessName) &&
143                               (place.MarketingInfoCachedAt == null ||
144                                place.MarketingInfoCachedAt < DateTimeOffset.UtcNow.AddHours(-24)))
145                           {
146                               placesNeedingLogoFetch.Add((placeItem, place.BusinessName, place.Latitude, place.Longitude));
147                           }
148                       }
149           
150                       ApplyFilter();
151                       _logger.LogInformation("Loaded {Count} places", _allPlaces.Count);
152           
153                       // Batch fetch logos for places that need them (limit to avoid overwhelming the API)
154                       if (placesNeedingLogoFetch.Count > 0)
155                       {
156                           _logger.LogDebug("Fetching marketing info for {Count} places", placesNeedingLogoFetch.Count);
157                           // Process in batches to avoid overwhelming the API
158                           const int batchSize = 5;
159                           for (int i = 0; i < placesNeedingLogoFetch.Count; i += batchSize)
160                           {
161                               var batch = placesNeedingLogoFetch.Skip(i).Take(batchSize);
162                               var tasks = batch.Select(p => FetchBusinessLogoAsync(p.item, p.businessName, p.lat, p.lon));
163                               await Task.WhenAll(tasks);
164                           }
165                       }
166                   }
167                   catch (DbUpdateException ex)
168                   {
169                       _logger.LogError(ex, "Database error loading places");
170                   }
171                   catch (OperationCanceledException)
172                   {
173                       _logger.LogInformation("Loading places was cancelled");
174                   }
175                   catch (Exception ex)
176                   {
177                       _logger.LogError(ex, "Error loading places");
178                   }
179                   finally
180                   {
181                       IsLoading = false;
182                   }
183               }
184           
185               private void ApplyFilter()
186               {
187                   Places.Clear();
188                   var filtered = _filterMode == "Favorites"
189                       ? _allPlaces.Where(p => p.IsFavorite)
190                       : _allPlaces;
191           
192                   foreach (var place in filtered.OrderByDescending(p => p.StationaryAt))
193                   {
194                       Places.Add(place);
195                   }
196               }
197           
198               private async void ToggleFavorite(PlaceItem? place)
199               {
200                   if (place == null)
201                       return;
202           
203                   try
204                   {
205                       var entity = await _dbContext.StationaryPlaces.FindAsync(place.Id);
206                       if (entity != null)
207                       {
208                           entity.IsFavorite = !entity.IsFavorite;
209                           await _dbContext.SaveChangesAsync();
210           
211                           place.IsFavorite = entity.IsFavorite;
212                           _logger.LogInformation("Toggled favorite for place: {PlaceId}, IsFavorite: {IsFavorite}", place.Id, plac
213           
214                           // Reapply filter if we're showing favorites
215                           if (_filterMode == "Favorites" && !place.IsFavorite)
216                           {
217                               ApplyFilter();
218                           }
219                       }
220                   }
221                   catch (DbUpdateException ex)
222                   {
223                       _logger.LogError(ex, "Database error toggling favorite for place: {PlaceId}", place.Id);
224                   }
225                   catch (OperationCanceledException)
226                   {
227                       _logger.LogDebug("Toggle favorite operation was cancelled for place: {PlaceId}", place.Id);
228                   }
229                   catch (Exception ex)
230                   {
231                       _logger.LogError(ex, "Error toggling favorite for place: {PlaceId}", place.Id);
232                   }
233               }
234           
235               private async void DeletePlace(PlaceItem? place)
236               {
237                   if (place == null)
238                       return;
239           
240                   try
241                   {
242                       var entity = await _dbContext.StationaryPlaces.FindAsync(place.Id);
243                       if (entity != null)
244                       {
245                           _dbContext.StationaryPlaces.Remove(entity);
246                           await _dbContext.SaveChangesAsync();
247           
248                           _allPlaces.Remove(place);
249                           Places.Remove(place);
250                           _logger.LogInformation("Deleted place: {PlaceId}", place.Id);
251                       }
252                   }
253                   catch (DbUpdateException ex)
254                   {
255                       _logger.LogError(ex, "Database error deleting place: {PlaceId}", place.Id);
256                   }
257                   catch (OperationCanceledException)
258                   {
259                       _logger.LogDebug("Delete place operation was cancelled for place: {PlaceId}", place.Id);
260                   }
261                   catch (Exception ex)
262                   {
263                       _logger.LogError(ex, "Error deleting place: {PlaceId}", place.Id);
264                   }
265               }
266           
267               private static string? ExtractCityFromAddress(string? address)
268               {
269                   if (string.IsNullOrEmpty(address))
270                       return null;
271           
272                   // Try to extract city from address
273                   // Address format is typically: "Street, City, State ZIP" or "Street, City, Country"
274                   var parts = address.Split(',');
275                   if (parts.Length >= 2)
276                   {
277                       // City is usually the second-to-last or last part
278                       // Try to find a part that looks like a city (not a ZIP code)
279                       for (int i = parts.Length - 1; i >= 0; i--)
280                       {
281                           var part = parts[i].Trim();
282                           // Skip if it looks like a ZIP code (all digits or digits with dash)
283                           if (System.Text.RegularExpressions.Regex.IsMatch(part, @"^\d{5}(-\d{4})?$"))
284                               continue;
285                           // Skip if it's very short (likely state abbreviation)
286                           if (part.Length <= 3 && part.All(char.IsLetter))
287                               continue;
288                           // Return the first part that looks like a city
289                           if (part.Length > 3)
290                               return part;
291                       }
292                   }
293           
294                   return null;
295               }
296           
297               private async Task FetchBusinessLogoAsync(PlaceItem placeItem, string businessName, double latitude, double longitud
298               {
299                   if (_httpClientFactory == null || _apiSettings == null)
300                   {
301                       _logger.LogDebug("HttpClientFactory or ApiSettings not available, skipping logo fetch for {BusinessName}", b
302                       return;
303                   }
304           
305                   if (string.IsNullOrWhiteSpace(businessName))
306                   {
307                       _logger.LogDebug("Business name is empty, skipping logo fetch");
308                       return;
309                   }
310           
311                   try
312                   {
313                       // Create HTTP client for marketing API
314                       using var httpClient = _httpClientFactory.CreateClient("MarketingApi");
315                       var marketingApiUrl = _apiSettings.GetMarketingApiBaseUrl();
316                       if (string.IsNullOrWhiteSpace(marketingApiUrl))
317                       {
318                           _logger.LogWarning("Marketing API base URL is not configured");
319                           return;
320                       }
321           
322                       httpClient.BaseAddress = new Uri(marketingApiUrl);
323                       httpClient.Timeout = TimeSpan.FromSeconds(10);
324           
325                       // Find nearby businesses in marketing API
326                       var nearbyUrl = $"api/marketing/nearby?latitude={latitude.ToString(CultureInfo.InvariantCulture)}&longitude=
327                       var businesses = await httpClient.GetFromJsonAsync<List<MarketingBusinessDto>>(nearbyUrl);
328           
329                       if (businesses == null || !businesses.Any())
330                       {
331                           _logger.LogDebug("No nearby businesses found for {BusinessName} at ({Lat}, {Lon})", businessName, latitu
332                           return;
333                       }
334           
335                       // Try to match by business name (case-insensitive, partial match)
336                       var matchedBusiness = businesses.FirstOrDefault(b =>
337                           !string.IsNullOrEmpty(b.Name) &&
338                           b.Name.Equals(businessName, StringComparison.OrdinalIgnoreCase));
339           
340                       // If no exact match, try partial match
341                       if (matchedBusiness == null)
342                       {
343                           matchedBusiness = businesses.FirstOrDefault(b =>
344                               !string.IsNullOrEmpty(b.Name) &&
345                               (b.Name.Contains(businessName, StringComparison.OrdinalIgnoreCase) ||
346                                businessName.Contains(b.Name, StringComparison.OrdinalIgnoreCase)));
347                       }
348           
349                       if (matchedBusiness == null)
350                       {
351                           _logger.LogDebug("No matching business found for {BusinessName}", businessName);
352                           return;
353                       }
354           
355                       // Get business theme to retrieve marketing info
356                       var themeUrl = $"api/marketing/{matchedBusiness.Id}/theme";
357                       var theme = await httpClient.GetFromJsonAsync<BusinessThemeDto>(themeUrl);
358           
359                       if (theme == null)
360                       {
361                           _logger.LogDebug("No theme found for business {BusinessId}", matchedBusiness.Id);
362                           return;
363                       }
364           
365                       // Store images via ImageService if available
366                       if (_imageService != null)
367                       {
368                           if (!string.IsNullOrEmpty(theme.LogoUrl))
369                           {
370                               await _imageService.GetImageAsync(
371                                   theme.LogoUrl,
372                                   "business_logo",
373                                   "Business",
374                                   matchedBusiness.Id);
375                           }
376           
377                           if (!string.IsNullOrEmpty(theme.BackgroundImageUrl))
378                           {
379                               await _imageService.GetImageAsync(
380                                   theme.BackgroundImageUrl,
381                                   "business_background",
382                                   "Business",
383                                   matchedBusiness.Id);
384                           }
385                       }
386           
387                       // Update PlaceItem for UI
388                       placeItem.LogoUrl = theme.LogoUrl;
389                       placeItem.PrimaryColor = theme.PrimaryColor;
390                       placeItem.SecondaryColor = theme.SecondaryColor;
391                       placeItem.AccentColor = theme.AccentColor;
392                       placeItem.BackgroundColor = theme.BackgroundColor;
393                       placeItem.TextColor = theme.TextColor;
394                       placeItem.BackgroundImageUrl = theme.BackgroundImageUrl;
395           
396                       // Update database entity
397                       var entity = await _dbContext.StationaryPlaces.FindAsync(placeItem.Id);
398                       if (entity != null)
399                       {
400                           entity.BusinessId = matchedBusiness.Id;
401                           entity.LogoUrl = theme.LogoUrl;
402                           entity.PrimaryColor = theme.PrimaryColor;
403                           entity.SecondaryColor = theme.SecondaryColor;
404                           entity.AccentColor = theme.AccentColor;
405                           entity.BackgroundColor = theme.BackgroundColor;
406                           entity.TextColor = theme.TextColor;
407                           entity.BackgroundImageUrl = theme.BackgroundImageUrl;
408                           entity.MarketingInfoCachedAt = DateTimeOffset.UtcNow;
409                           await _dbContext.SaveChangesAsync();
410                       }
411           
412                       _logger.LogDebug("Refreshed marketing info for business: {BusinessName}, BusinessId: {BusinessId}",
413                           businessName, matchedBusiness.Id);
414                   }
415                   catch (HttpRequestException ex)
416                   {
417                       _logger.LogWarning(ex, "HTTP error refreshing marketing info for business: {BusinessName}", businessName);
418                   }
419                   catch (TaskCanceledException ex)
420                   {
421                       _logger.LogWarning(ex, "Request timeout refreshing marketing info for business: {BusinessName}", businessNam
422                   }
423                   catch (DbUpdateException ex)
424                   {
425                       _logger.LogWarning(ex, "Database error saving marketing info for business: {BusinessName}", businessName);
426                   }
427                   catch (OperationCanceledException)
428                   {
429                       _logger.LogDebug("Marketing info fetch cancelled for business: {BusinessName}", businessName);
430                   }
431                   catch (Exception ex)
432                   {
433                       _logger.LogWarning(ex, "Error refreshing marketing info for business: {BusinessName}", businessName);
434                   }
435               }
436           
437               private static DateTimeOffset ConvertToLocalTime(DateTimeOffset utcTime, double longitude)
438               {
439                   // Simple timezone approximation: each 15 degrees of longitude ≈ 1 hour
440                   // This is a rough approximation and doesn't account for political boundaries
441                   // For a production app, you'd want to use a proper timezone service
442                   var offsetHours = (int)Math.Round(longitude / 15.0);
443                   var timeZoneOffset = TimeSpan.FromHours(offsetHours);
444           
445                   return new DateTimeOffset(utcTime.DateTime, timeZoneOffset);
446               }
447           
448               // DTOs for Marketing API responses
449               private class MarketingBusinessDto
450               {
451                   public long Id { get; set; }
452                   public string Name { get; set; } = string.Empty;
453                   public string Address { get; set; } = string.Empty;
454                   public double Latitude { get; set; }
455                   public double Longitude { get; set; }
456               }
457           
458               private class BusinessThemeDto
459               {
460                   public long Id { get; set; }
461                   public long BusinessId { get; set; }
462                   public string ThemeName { get; set; } = string.Empty;
463                   public string? LogoUrl { get; set; }
464                   public string? PrimaryColor { get; set; }
465                   public string? SecondaryColor { get; set; }
466                   public string? AccentColor { get; set; }
467                   public string? BackgroundColor { get; set; }
468                   public string? TextColor { get; set; }
469                   public string? BackgroundImageUrl { get; set; }
470               }
471           
472               public event PropertyChangedEventHandler? PropertyChanged;
473           
474               protected virtual void OnPropertyChanged([CallerMemberName] string? propertyName = null)
475               {
476                   PropertyChanged?.Invoke(this, new PropertyChangedEventArgs(propertyName));
477               }
478           
479               private sealed class RelayCommand<T> : ICommand
480               {
481                   private readonly Action<T?> _execute;
482           
483                   public RelayCommand(Action<T?> execute) => _execute = execute ?? throw new ArgumentNullException(nameof(execute)
484           
485                   public bool CanExecute(object? parameter) => true;
486           
487                   public void Execute(object? parameter) => _execute(parameter is T item ? item : default);
488           
489                   public event EventHandler? CanExecuteChanged { add { } remove { } }
490               }
491           }
492           
493           /// <summary>
494           /// Represents a place item for display in the UI.
495           /// </summary>
496           public class PlaceItem : INotifyPropertyChanged
497           {
498               private string? _logoUrl;
499           
500  ❌ 0         public long Id { get; set; }
501  ❌ 0         public string? BusinessName { get; set; }
502  ❌ 0         public string? Address { get; set; }
503  ❌ 0         public string? City { get; set; }
504  ❌ 0         public string? Category { get; set; }
505  ❌ 0         public double Latitude { get; set; }
506  ❌ 0         public double Longitude { get; set; }
507  ❌ 0         public DateTimeOffset StationaryAt { get; set; }
508  ❌ 0         public DateTimeOffset LocalTime { get; set; }
509  ❌ 0         public bool IsFavorite { get; set; }
510           
511               public string? LogoUrl
512               {
513  ❌ 0             get => _logoUrl;
514                   set
515  ❌ 0             {
516  ❌ 0  ○              if (_logoUrl != value)
517  ❌ 0                 {
518  ❌ 0                     _logoUrl = value;
519  ❌ 0                     OnPropertyChanged();
520  ❌ 0                 }
521  ❌ 0             }
522               }
523           
524  ❌ 0         public string? PrimaryColor { get; set; }
525  ❌ 0         public string? SecondaryColor { get; set; }
526  ❌ 0         public string? AccentColor { get; set; }
527  ❌ 0         public string? BackgroundColor { get; set; }
528  ❌ 0         public string? TextColor { get; set; }
529  ❌ 0         public string? BackgroundImageUrl { get; set; }
530           
531  ❌ 0  ○      public string DisplayName => BusinessName ?? Address ?? $"{Latitude:F6}, {Longitude:F6}";
532  ❌ 0  ○      public string DisplayAddress => Address ?? $"{Latitude:F6}, {Longitude:F6}";
533           
534               public event PropertyChangedEventHandler? PropertyChanged;
535           
536               protected virtual void OnPropertyChanged([CallerMemberName] string? propertyName = null)
537  ❌ 0         {
538  ❌ 0  ○          PropertyChanged?.Invoke(this, new PropertyChangedEventArgs(propertyName));
539  ❌ 0         }
540           }
```
# FWH.Mobile.ViewModels.PlacesViewModel

## Summary

|||
|:---|:---|
| Class: | FWH.Mobile.ViewModels.PlacesViewModel |
| Assembly: | FWH.Mobile |
| **File(s):** | E:\github\FunWasHad\src\FWH.Mobile\FWH.Mobile\ViewModels\PlacesViewModel.cs |
| **Line coverage:** | 0% (0 of 338) |
| Covered lines: | 0 |
| Uncovered lines: | 338 |
| Coverable lines: | 338 |
| Total lines: | 540 |
| **Branch coverage:** | 0% (0 of 96) |
| Covered branches: | 0 |
| Total branches: | 96 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **.ctor(...)** | 0% | 42 | 6 | 0% |
| **get_Places()** | 100% | 2 | 1 | 0% |
| **get_IsLoading()** | 100% | 2 | 1 | 0% |
| **set_IsLoading(...)** | 0% | 6 | 2 | 0% |
| **get_IsEmpty()** | 0% | 6 | 2 | 0% |
| **get_DeletePlaceCommand()** | 100% | 2 | 1 | 0% |
| **get_ToggleFavoriteCommand()** | 100% | 2 | 1 | 0% |
| **get_FilterModes()** | 100% | 2 | 1 | 0% |
| **get_FilterMode()** | 100% | 2 | 1 | 0% |
| **set_FilterMode(...)** | 0% | 6 | 2 | 0% |
| **LoadPlacesAsync()** | 0% | 210 | 14 | 0% |
| **ApplyFilter()** | 0% | 20 | 4 | 0% |
| **ToggleFavorite()** | 0% | 72 | 8 | 0% |
| **DeletePlace()** | 0% | 20 | 4 | 0% |
| **ExtractCityFromAddress(...)** | 0% | 272 | 16 | 0% |
| **FetchBusinessLogoAsync()** | 0% | 702 | 26 | 0% |
| **ConvertToLocalTime(...)** | 100% | 2 | 1 | 0% |
| **get_Id()** | 100% | 2 | 1 | 0% |
| **get_Name()** | 100% | 2 | 1 | 0% |
| **get_Address()** | 100% | 2 | 1 | 0% |
| **get_Latitude()** | 100% | 2 | 1 | 0% |
| **get_Longitude()** | 100% | 2 | 1 | 0% |
| **get_Id()** | 100% | 2 | 1 | 0% |
| **get_BusinessId()** | 100% | 2 | 1 | 0% |
| **get_ThemeName()** | 100% | 2 | 1 | 0% |
| **get_LogoUrl()** | 100% | 2 | 1 | 0% |
| **get_PrimaryColor()** | 100% | 2 | 1 | 0% |
| **get_SecondaryColor()** | 100% | 2 | 1 | 0% |
| **get_AccentColor()** | 100% | 2 | 1 | 0% |
| **get_BackgroundColor()** | 100% | 2 | 1 | 0% |
| **get_TextColor()** | 100% | 2 | 1 | 0% |
| **get_BackgroundImageUrl()** | 100% | 2 | 1 | 0% |
| **OnPropertyChanged(...)** | 0% | 6 | 2 | 0% |
| **.ctor(...)** | 0% | 6 | 2 | 0% |
| **CanExecute(...)** | 100% | 2 | 1 | 0% |
| **Execute(...)** | 0% | 6 | 2 | 0% |
| **add_CanExecuteChanged(...)** | 100% | 2 | 1 | 0% |

## File(s)

### E:\github\FunWasHad\src\FWH.Mobile\FWH.Mobile\ViewModels\PlacesViewModel.cs
```
  1           using System;
  2           using System.Collections.Generic;
  3           using System.Collections.ObjectModel;
  4           using System.ComponentModel;
  5           using System.Globalization;
  6           using System.Linq;
  7           using System.Net.Http;
  8           using System.Net.Http.Json;
  9           using System.Runtime.CompilerServices;
 10           using System.Threading.Tasks;
 11           using System.Windows.Input;
 12           using FWH.Mobile.Configuration;
 13           using FWH.Mobile.Data.Data;
 14           using FWH.Mobile.Services;
 15           using FWH.Mobile.Data.Entities;
 16           using Microsoft.EntityFrameworkCore;
 17           using Microsoft.Extensions.Logging;
 18           
 19           namespace FWH.Mobile.ViewModels;
 20           
 21           /// <summary>
 22           /// ViewModel for displaying places where the user became stationary.
 23           /// Shows a reverse chronological list of businesses and locations.
 24           /// </summary>
 25           public class PlacesViewModel : INotifyPropertyChanged
 26           {
 27               private readonly NotesDbContext _dbContext;
 28               private readonly ILogger<PlacesViewModel> _logger;
 29               private readonly string _deviceId;
 30               private readonly IImageService? _imageService;
 31               private readonly IHttpClientFactory? _httpClientFactory;
 32               private readonly ApiSettings? _apiSettings;
 33               private bool _isLoading;
 34  ❌ 0         private readonly ObservableCollection<PlaceItem> _allPlaces = new();
 35           
 36  ❌ 0         public PlacesViewModel(
 37  ❌ 0             NotesDbContext dbContext,
 38  ❌ 0             ILogger<PlacesViewModel> logger,
 39  ❌ 0             string deviceId,
 40  ❌ 0             IImageService? imageService = null,
 41  ❌ 0             IHttpClientFactory? httpClientFactory = null,
 42  ❌ 0             ApiSettings? apiSettings = null)
 43  ❌ 0         {
 44  ❌ 0  ○          _dbContext = dbContext ?? throw new ArgumentNullException(nameof(dbContext));
 45  ❌ 0  ○          _logger = logger ?? throw new ArgumentNullException(nameof(logger));
 46  ❌ 0  ○          _deviceId = deviceId ?? throw new ArgumentNullException(nameof(deviceId));
 47  ❌ 0             _imageService = imageService;
 48  ❌ 0             _httpClientFactory = httpClientFactory;
 49  ❌ 0             _apiSettings = apiSettings;
 50  ❌ 0             Places = new ObservableCollection<PlaceItem>();
 51  ❌ 0             Places.CollectionChanged += (_, _) => OnPropertyChanged(nameof(IsEmpty));
 52           
 53  ❌ 0             DeletePlaceCommand = new RelayCommand<PlaceItem>(DeletePlace);
 54  ❌ 0             ToggleFavoriteCommand = new RelayCommand<PlaceItem>(ToggleFavorite);
 55  ❌ 0             FilterModes = new[] { "All", "Favorites" };
 56           
 57  ❌ 0             _ = LoadPlacesAsync();
 58  ❌ 0         }
 59           
 60  ❌ 0         public ObservableCollection<PlaceItem> Places { get; }
 61           
 62               public bool IsLoading
 63               {
 64  ❌ 0             get => _isLoading;
 65                   private set
 66  ❌ 0             {
 67  ❌ 0  ○              if (_isLoading != value)
 68  ❌ 0                 {
 69  ❌ 0                     _isLoading = value;
 70  ❌ 0                     OnPropertyChanged();
 71  ❌ 0                     OnPropertyChanged(nameof(IsEmpty));
 72  ❌ 0                 }
 73  ❌ 0             }
 74               }
 75           
 76  ❌ 0  ○      public bool IsEmpty => !IsLoading && Places.Count == 0;
 77           
 78  ❌ 0         public ICommand DeletePlaceCommand { get; }
 79  ❌ 0         public ICommand ToggleFavoriteCommand { get; }
 80           
 81  ❌ 0         public string[] FilterModes { get; }
 82           
 83  ❌ 0         private string _filterMode = "All";
 84               public string FilterMode
 85               {
 86  ❌ 0             get => _filterMode;
 87                   set
 88  ❌ 0             {
 89  ❌ 0  ○              if (_filterMode != value)
 90  ❌ 0                 {
 91  ❌ 0                     _filterMode = value;
 92  ❌ 0                     OnPropertyChanged();
 93  ❌ 0                     ApplyFilter();
 94  ❌ 0                 }
 95  ❌ 0             }
 96               }
 97           
 98               public async Task LoadPlacesAsync()
 99  ❌ 0         {
100                   try
101  ❌ 0             {
102  ❌ 0                 IsLoading = true;
103           
104  ❌ 0                 var places = await _dbContext.StationaryPlaces
105  ❌ 0                     .Where(p => p.DeviceId == _deviceId)
106  ❌ 0                     .OrderByDescending(p => p.StationaryAt)
107  ❌ 0                     .ToListAsync();
108           
109  ❌ 0                 _allPlaces.Clear();
110  ❌ 0                 var placesNeedingLogoFetch = new List<(PlaceItem item, string businessName, double lat, double lon)>();
111           
112  ❌ 0  ○              foreach (var place in places)
113  ❌ 0                 {
114  ❌ 0                     var city = ExtractCityFromAddress(place.Address);
115  ❌ 0                     var localTime = ConvertToLocalTime(place.StationaryAt, place.Longitude);
116           
117  ❌ 0                     var placeItem = new PlaceItem
118  ❌ 0                     {
119  ❌ 0                         Id = place.Id,
120  ❌ 0                         BusinessName = place.BusinessName,
121  ❌ 0                         Address = place.Address,
122  ❌ 0                         City = city,
123  ❌ 0                         Category = place.Category,
124  ❌ 0                         Latitude = place.Latitude,
125  ❌ 0                         Longitude = place.Longitude,
126  ❌ 0                         StationaryAt = place.StationaryAt,
127  ❌ 0                         LocalTime = localTime,
128  ❌ 0                         IsFavorite = place.IsFavorite,
129  ❌ 0                         // Use cached marketing info if available
130  ❌ 0                         LogoUrl = place.LogoUrl,
131  ❌ 0                         PrimaryColor = place.PrimaryColor,
132  ❌ 0                         SecondaryColor = place.SecondaryColor,
133  ❌ 0                         AccentColor = place.AccentColor,
134  ❌ 0                         BackgroundColor = place.BackgroundColor,
135  ❌ 0                         TextColor = place.TextColor,
136  ❌ 0                         BackgroundImageUrl = place.BackgroundImageUrl
137  ❌ 0                     };
138           
139  ❌ 0                     _allPlaces.Add(placeItem);
140           
141                           // Only fetch logo if business name is available and marketing info is not cached or stale
142  ❌ 0  ○                  if (!string.IsNullOrEmpty(place.BusinessName) &&
143  ❌ 0                         (place.MarketingInfoCachedAt == null ||
144  ❌ 0                          place.MarketingInfoCachedAt < DateTimeOffset.UtcNow.AddHours(-24)))
145  ❌ 0                     {
146  ❌ 0                         placesNeedingLogoFetch.Add((placeItem, place.BusinessName, place.Latitude, place.Longitude));
147  ❌ 0                     }
148  ❌ 0                 }
149           
150  ❌ 0                 ApplyFilter();
151  ❌ 0                 _logger.LogInformation("Loaded {Count} places", _allPlaces.Count);
152           
153                       // Batch fetch logos for places that need them (limit to avoid overwhelming the API)
154  ❌ 0  ○              if (placesNeedingLogoFetch.Count > 0)
155  ❌ 0                 {
156  ❌ 0                     _logger.LogDebug("Fetching marketing info for {Count} places", placesNeedingLogoFetch.Count);
157                           // Process in batches to avoid overwhelming the API
158                           const int batchSize = 5;
159  ❌ 0  ○                  for (int i = 0; i < placesNeedingLogoFetch.Count; i += batchSize)
160  ❌ 0                     {
161  ❌ 0                         var batch = placesNeedingLogoFetch.Skip(i).Take(batchSize);
162  ❌ 0                         var tasks = batch.Select(p => FetchBusinessLogoAsync(p.item, p.businessName, p.lat, p.lon));
163  ❌ 0                         await Task.WhenAll(tasks);
164  ❌ 0                     }
165  ❌ 0                 }
166  ❌ 0             }
167  ❌ 0             catch (DbUpdateException ex)
168  ❌ 0             {
169  ❌ 0                 _logger.LogError(ex, "Database error loading places");
170  ❌ 0             }
171  ❌ 0             catch (OperationCanceledException)
172  ❌ 0             {
173  ❌ 0                 _logger.LogInformation("Loading places was cancelled");
174  ❌ 0             }
175  ❌ 0             catch (Exception ex)
176  ❌ 0             {
177  ❌ 0                 _logger.LogError(ex, "Error loading places");
178  ❌ 0             }
179                   finally
180  ❌ 0             {
181  ❌ 0                 IsLoading = false;
182  ❌ 0             }
183  ❌ 0         }
184           
185               private void ApplyFilter()
186  ❌ 0         {
187  ❌ 0             Places.Clear();
188  ❌ 0  ○          var filtered = _filterMode == "Favorites"
189  ❌ 0                 ? _allPlaces.Where(p => p.IsFavorite)
190  ❌ 0                 : _allPlaces;
191           
192  ❌ 0  ○          foreach (var place in filtered.OrderByDescending(p => p.StationaryAt))
193  ❌ 0             {
194  ❌ 0                 Places.Add(place);
195  ❌ 0             }
196  ❌ 0         }
197           
198               private async void ToggleFavorite(PlaceItem? place)
199  ❌ 0         {
200  ❌ 0  ○          if (place == null)
201  ❌ 0                 return;
202           
203                   try
204  ❌ 0             {
205  ❌ 0                 var entity = await _dbContext.StationaryPlaces.FindAsync(place.Id);
206  ❌ 0  ○              if (entity != null)
207  ❌ 0                 {
208  ❌ 0                     entity.IsFavorite = !entity.IsFavorite;
209  ❌ 0                     await _dbContext.SaveChangesAsync();
210           
211  ❌ 0                     place.IsFavorite = entity.IsFavorite;
212  ❌ 0                     _logger.LogInformation("Toggled favorite for place: {PlaceId}, IsFavorite: {IsFavorite}", place.Id, plac
213           
214                           // Reapply filter if we're showing favorites
215  ❌ 0  ○                  if (_filterMode == "Favorites" && !place.IsFavorite)
216  ❌ 0                     {
217  ❌ 0                         ApplyFilter();
218  ❌ 0                     }
219  ❌ 0                 }
220  ❌ 0             }
221  ❌ 0             catch (DbUpdateException ex)
222  ❌ 0             {
223  ❌ 0                 _logger.LogError(ex, "Database error toggling favorite for place: {PlaceId}", place.Id);
224  ❌ 0             }
225  ❌ 0             catch (OperationCanceledException)
226  ❌ 0             {
227  ❌ 0                 _logger.LogDebug("Toggle favorite operation was cancelled for place: {PlaceId}", place.Id);
228  ❌ 0             }
229  ❌ 0             catch (Exception ex)
230  ❌ 0             {
231  ❌ 0                 _logger.LogError(ex, "Error toggling favorite for place: {PlaceId}", place.Id);
232  ❌ 0             }
233  ❌ 0         }
234           
235               private async void DeletePlace(PlaceItem? place)
236  ❌ 0         {
237  ❌ 0  ○          if (place == null)
238  ❌ 0                 return;
239           
240                   try
241  ❌ 0             {
242  ❌ 0                 var entity = await _dbContext.StationaryPlaces.FindAsync(place.Id);
243  ❌ 0  ○              if (entity != null)
244  ❌ 0                 {
245  ❌ 0                     _dbContext.StationaryPlaces.Remove(entity);
246  ❌ 0                     await _dbContext.SaveChangesAsync();
247           
248  ❌ 0                     _allPlaces.Remove(place);
249  ❌ 0                     Places.Remove(place);
250  ❌ 0                     _logger.LogInformation("Deleted place: {PlaceId}", place.Id);
251  ❌ 0                 }
252  ❌ 0             }
253  ❌ 0             catch (DbUpdateException ex)
254  ❌ 0             {
255  ❌ 0                 _logger.LogError(ex, "Database error deleting place: {PlaceId}", place.Id);
256  ❌ 0             }
257  ❌ 0             catch (OperationCanceledException)
258  ❌ 0             {
259  ❌ 0                 _logger.LogDebug("Delete place operation was cancelled for place: {PlaceId}", place.Id);
260  ❌ 0             }
261  ❌ 0             catch (Exception ex)
262  ❌ 0             {
263  ❌ 0                 _logger.LogError(ex, "Error deleting place: {PlaceId}", place.Id);
264  ❌ 0             }
265  ❌ 0         }
266           
267               private static string? ExtractCityFromAddress(string? address)
268  ❌ 0         {
269  ❌ 0  ○          if (string.IsNullOrEmpty(address))
270  ❌ 0                 return null;
271           
272                   // Try to extract city from address
273                   // Address format is typically: "Street, City, State ZIP" or "Street, City, Country"
274  ❌ 0             var parts = address.Split(',');
275  ❌ 0  ○          if (parts.Length >= 2)
276  ❌ 0             {
277                       // City is usually the second-to-last or last part
278                       // Try to find a part that looks like a city (not a ZIP code)
279  ❌ 0  ○              for (int i = parts.Length - 1; i >= 0; i--)
280  ❌ 0                 {
281  ❌ 0                     var part = parts[i].Trim();
282                           // Skip if it looks like a ZIP code (all digits or digits with dash)
283  ❌ 0  ○                  if (System.Text.RegularExpressions.Regex.IsMatch(part, @"^\d{5}(-\d{4})?$"))
284  ❌ 0                         continue;
285                           // Skip if it's very short (likely state abbreviation)
286  ❌ 0  ○                  if (part.Length <= 3 && part.All(char.IsLetter))
287  ❌ 0                         continue;
288                           // Return the first part that looks like a city
289  ❌ 0  ○                  if (part.Length > 3)
290  ❌ 0                         return part;
291  ❌ 0                 }
292  ❌ 0             }
293           
294  ❌ 0             return null;
295  ❌ 0         }
296           
297               private async Task FetchBusinessLogoAsync(PlaceItem placeItem, string businessName, double latitude, double longitud
298  ❌ 0         {
299  ❌ 0  ○          if (_httpClientFactory == null || _apiSettings == null)
300  ❌ 0             {
301  ❌ 0                 _logger.LogDebug("HttpClientFactory or ApiSettings not available, skipping logo fetch for {BusinessName}", b
302  ❌ 0                 return;
303                   }
304           
305  ❌ 0  ○          if (string.IsNullOrWhiteSpace(businessName))
306  ❌ 0             {
307  ❌ 0                 _logger.LogDebug("Business name is empty, skipping logo fetch");
308  ❌ 0                 return;
309                   }
310           
311                   try
312  ❌ 0             {
313                       // Create HTTP client for marketing API
314  ❌ 0                 using var httpClient = _httpClientFactory.CreateClient("MarketingApi");
315  ❌ 0                 var marketingApiUrl = _apiSettings.GetMarketingApiBaseUrl();
316  ❌ 0  ○              if (string.IsNullOrWhiteSpace(marketingApiUrl))
317  ❌ 0                 {
318  ❌ 0                     _logger.LogWarning("Marketing API base URL is not configured");
319  ❌ 0                     return;
320                       }
321           
322  ❌ 0                 httpClient.BaseAddress = new Uri(marketingApiUrl);
323  ❌ 0                 httpClient.Timeout = TimeSpan.FromSeconds(10);
324           
325                       // Find nearby businesses in marketing API
326  ❌ 0                 var nearbyUrl = $"api/marketing/nearby?latitude={latitude.ToString(CultureInfo.InvariantCulture)}&longitude=
327  ❌ 0                 var businesses = await httpClient.GetFromJsonAsync<List<MarketingBusinessDto>>(nearbyUrl);
328           
329  ❌ 0  ○              if (businesses == null || !businesses.Any())
330  ❌ 0                 {
331  ❌ 0                     _logger.LogDebug("No nearby businesses found for {BusinessName} at ({Lat}, {Lon})", businessName, latitu
332  ❌ 0                     return;
333                       }
334           
335                       // Try to match by business name (case-insensitive, partial match)
336  ❌ 0                 var matchedBusiness = businesses.FirstOrDefault(b =>
337  ❌ 0  ○                  !string.IsNullOrEmpty(b.Name) &&
338  ❌ 0                     b.Name.Equals(businessName, StringComparison.OrdinalIgnoreCase));
339           
340                       // If no exact match, try partial match
341  ❌ 0  ○              if (matchedBusiness == null)
342  ❌ 0                 {
343  ❌ 0                     matchedBusiness = businesses.FirstOrDefault(b =>
344  ❌ 0  ○                      !string.IsNullOrEmpty(b.Name) &&
345  ❌ 0                         (b.Name.Contains(businessName, StringComparison.OrdinalIgnoreCase) ||
346  ❌ 0                          businessName.Contains(b.Name, StringComparison.OrdinalIgnoreCase)));
347  ❌ 0                 }
348           
349  ❌ 0  ○              if (matchedBusiness == null)
350  ❌ 0                 {
351  ❌ 0                     _logger.LogDebug("No matching business found for {BusinessName}", businessName);
352  ❌ 0                     return;
353                       }
354           
355                       // Get business theme to retrieve marketing info
356  ❌ 0                 var themeUrl = $"api/marketing/{matchedBusiness.Id}/theme";
357  ❌ 0                 var theme = await httpClient.GetFromJsonAsync<BusinessThemeDto>(themeUrl);
358           
359  ❌ 0  ○              if (theme == null)
360  ❌ 0                 {
361  ❌ 0                     _logger.LogDebug("No theme found for business {BusinessId}", matchedBusiness.Id);
362  ❌ 0                     return;
363                       }
364           
365                       // Store images via ImageService if available
366  ❌ 0  ○              if (_imageService != null)
367  ❌ 0                 {
368  ❌ 0  ○                  if (!string.IsNullOrEmpty(theme.LogoUrl))
369  ❌ 0                     {
370  ❌ 0                         await _imageService.GetImageAsync(
371  ❌ 0                             theme.LogoUrl,
372  ❌ 0                             "business_logo",
373  ❌ 0                             "Business",
374  ❌ 0                             matchedBusiness.Id);
375  ❌ 0                     }
376           
377  ❌ 0  ○                  if (!string.IsNullOrEmpty(theme.BackgroundImageUrl))
378  ❌ 0                     {
379  ❌ 0                         await _imageService.GetImageAsync(
380  ❌ 0                             theme.BackgroundImageUrl,
381  ❌ 0                             "business_background",
382  ❌ 0                             "Business",
383  ❌ 0                             matchedBusiness.Id);
384  ❌ 0                     }
385  ❌ 0                 }
386           
387                       // Update PlaceItem for UI
388  ❌ 0                 placeItem.LogoUrl = theme.LogoUrl;
389  ❌ 0                 placeItem.PrimaryColor = theme.PrimaryColor;
390  ❌ 0                 placeItem.SecondaryColor = theme.SecondaryColor;
391  ❌ 0                 placeItem.AccentColor = theme.AccentColor;
392  ❌ 0                 placeItem.BackgroundColor = theme.BackgroundColor;
393  ❌ 0                 placeItem.TextColor = theme.TextColor;
394  ❌ 0                 placeItem.BackgroundImageUrl = theme.BackgroundImageUrl;
395           
396                       // Update database entity
397  ❌ 0                 var entity = await _dbContext.StationaryPlaces.FindAsync(placeItem.Id);
398  ❌ 0  ○              if (entity != null)
399  ❌ 0                 {
400  ❌ 0                     entity.BusinessId = matchedBusiness.Id;
401  ❌ 0                     entity.LogoUrl = theme.LogoUrl;
402  ❌ 0                     entity.PrimaryColor = theme.PrimaryColor;
403  ❌ 0                     entity.SecondaryColor = theme.SecondaryColor;
404  ❌ 0                     entity.AccentColor = theme.AccentColor;
405  ❌ 0                     entity.BackgroundColor = theme.BackgroundColor;
406  ❌ 0                     entity.TextColor = theme.TextColor;
407  ❌ 0                     entity.BackgroundImageUrl = theme.BackgroundImageUrl;
408  ❌ 0                     entity.MarketingInfoCachedAt = DateTimeOffset.UtcNow;
409  ❌ 0                     await _dbContext.SaveChangesAsync();
410  ❌ 0                 }
411           
412  ❌ 0                 _logger.LogDebug("Refreshed marketing info for business: {BusinessName}, BusinessId: {BusinessId}",
413  ❌ 0                     businessName, matchedBusiness.Id);
414  ❌ 0             }
415  ❌ 0             catch (HttpRequestException ex)
416  ❌ 0             {
417  ❌ 0                 _logger.LogWarning(ex, "HTTP error refreshing marketing info for business: {BusinessName}", businessName);
418  ❌ 0             }
419  ❌ 0             catch (TaskCanceledException ex)
420  ❌ 0             {
421  ❌ 0                 _logger.LogWarning(ex, "Request timeout refreshing marketing info for business: {BusinessName}", businessNam
422  ❌ 0             }
423  ❌ 0             catch (DbUpdateException ex)
424  ❌ 0             {
425  ❌ 0                 _logger.LogWarning(ex, "Database error saving marketing info for business: {BusinessName}", businessName);
426  ❌ 0             }
427  ❌ 0             catch (OperationCanceledException)
428  ❌ 0             {
429  ❌ 0                 _logger.LogDebug("Marketing info fetch cancelled for business: {BusinessName}", businessName);
430  ❌ 0             }
431  ❌ 0             catch (Exception ex)
432  ❌ 0             {
433  ❌ 0                 _logger.LogWarning(ex, "Error refreshing marketing info for business: {BusinessName}", businessName);
434  ❌ 0             }
435  ❌ 0         }
436           
437               private static DateTimeOffset ConvertToLocalTime(DateTimeOffset utcTime, double longitude)
438  ❌ 0         {
439                   // Simple timezone approximation: each 15 degrees of longitude ≈ 1 hour
440                   // This is a rough approximation and doesn't account for political boundaries
441                   // For a production app, you'd want to use a proper timezone service
442  ❌ 0             var offsetHours = (int)Math.Round(longitude / 15.0);
443  ❌ 0             var timeZoneOffset = TimeSpan.FromHours(offsetHours);
444           
445  ❌ 0             return new DateTimeOffset(utcTime.DateTime, timeZoneOffset);
446  ❌ 0         }
447           
448               // DTOs for Marketing API responses
449               private class MarketingBusinessDto
450               {
451  ❌ 0             public long Id { get; set; }
452  ❌ 0             public string Name { get; set; } = string.Empty;
453  ❌ 0             public string Address { get; set; } = string.Empty;
454  ❌ 0             public double Latitude { get; set; }
455  ❌ 0             public double Longitude { get; set; }
456               }
457           
458               private class BusinessThemeDto
459               {
460  ❌ 0             public long Id { get; set; }
461  ❌ 0             public long BusinessId { get; set; }
462  ❌ 0             public string ThemeName { get; set; } = string.Empty;
463  ❌ 0             public string? LogoUrl { get; set; }
464  ❌ 0             public string? PrimaryColor { get; set; }
465  ❌ 0             public string? SecondaryColor { get; set; }
466  ❌ 0             public string? AccentColor { get; set; }
467  ❌ 0             public string? BackgroundColor { get; set; }
468  ❌ 0             public string? TextColor { get; set; }
469  ❌ 0             public string? BackgroundImageUrl { get; set; }
470               }
471           
472               public event PropertyChangedEventHandler? PropertyChanged;
473           
474               protected virtual void OnPropertyChanged([CallerMemberName] string? propertyName = null)
475  ❌ 0         {
476  ❌ 0  ○          PropertyChanged?.Invoke(this, new PropertyChangedEventArgs(propertyName));
477  ❌ 0         }
478           
479               private sealed class RelayCommand<T> : ICommand
480               {
481                   private readonly Action<T?> _execute;
482           
483  ❌ 0  ○          public RelayCommand(Action<T?> execute) => _execute = execute ?? throw new ArgumentNullException(nameof(execute)
484           
485  ❌ 0             public bool CanExecute(object? parameter) => true;
486           
487  ❌ 0  ○          public void Execute(object? parameter) => _execute(parameter is T item ? item : default);
488           
489  ❌ 0             public event EventHandler? CanExecuteChanged { add { } remove { } }
490               }
491           }
492           
493           /// <summary>
494           /// Represents a place item for display in the UI.
495           /// </summary>
496           public class PlaceItem : INotifyPropertyChanged
497           {
498               private string? _logoUrl;
499           
500               public long Id { get; set; }
501               public string? BusinessName { get; set; }
502               public string? Address { get; set; }
503               public string? City { get; set; }
504               public string? Category { get; set; }
505               public double Latitude { get; set; }
506               public double Longitude { get; set; }
507               public DateTimeOffset StationaryAt { get; set; }
508               public DateTimeOffset LocalTime { get; set; }
509               public bool IsFavorite { get; set; }
510           
511               public string? LogoUrl
512               {
513                   get => _logoUrl;
514                   set
515                   {
516                       if (_logoUrl != value)
517                       {
518                           _logoUrl = value;
519                           OnPropertyChanged();
520                       }
521                   }
522               }
523           
524               public string? PrimaryColor { get; set; }
525               public string? SecondaryColor { get; set; }
526               public string? AccentColor { get; set; }
527               public string? BackgroundColor { get; set; }
528               public string? TextColor { get; set; }
529               public string? BackgroundImageUrl { get; set; }
530           
531               public string DisplayName => BusinessName ?? Address ?? $"{Latitude:F6}, {Longitude:F6}";
532               public string DisplayAddress => Address ?? $"{Latitude:F6}, {Longitude:F6}";
533           
534               public event PropertyChangedEventHandler? PropertyChanged;
535           
536               protected virtual void OnPropertyChanged([CallerMemberName] string? propertyName = null)
537               {
538                   PropertyChanged?.Invoke(this, new PropertyChangedEventArgs(propertyName));
539               }
540           }
```
# FWH.Mobile.Views.CameraCaptureControl

## Summary

|||
|:---|:---|
| Class: | FWH.Mobile.Views.CameraCaptureControl |
| Assembly: | FWH.Mobile |
| **File(s):** | E:\github\FunWasHad\src\FWH.Mobile\FWH.Mobile\Views\CameraCaptureControl.axaml<br />E:\github\FunWasHad\src\FWH.Mobile\FWH.Mobile\Views\CameraCaptureControl.axaml.cs |
| **Line coverage:** | 0% (0 of 53) |
| Covered lines: | 0 |
| Uncovered lines: | 53 |
| Coverable lines: | 53 |
| Total lines: | 118 |
| **Branch coverage:** | 0% (0 of 2) |
| Covered branches: | 0 |
| Total branches: | 2 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **!XamlIlPopulate(...)** | 0% | 6 | 2 | 0% |
| **.ctor()** | 100% | 2 | 1 | 0% |
| **InitializeComponent()** | 100% | 2 | 1 | 0% |

## File(s)

### E:\github\FunWasHad\src\FWH.Mobile\FWH.Mobile\Views\CameraCaptureControl.axaml
```
  1  ❌ 0  ○  <UserControl xmlns="https://github.com/avaloniaui"
  2                        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
  3                        xmlns:vm="using:FWH.Mobile.ViewModels"
  4                        x:Class="FWH.Mobile.Views.CameraCaptureControl"
  5                        x:DataType="vm:CameraCaptureViewModel">
  6           
  7  ❌ 0         <Grid RowDefinitions="Auto,*,Auto">
  8           
  9                   <!-- Status Bar -->
 10  ❌ 0             <Border Grid.Row="0"
 11                           Background="#F5F5F5"
 12  ❌ 0                     Padding="12,8"
 13                           BorderBrush="#E0E0E0"
 14  ❌ 0                     BorderThickness="0,0,0,1">
 15  ❌ 0                 <TextBlock Text="{Binding StatusMessage}"
 16                                  FontSize="14"
 17  ❌ 0                            HorizontalAlignment="Center"
 18                                  VerticalAlignment="Center"
 19  ❌ 0                            TextWrapping="Wrap" />
 20                   </Border>
 21           
 22                   <!-- Image Display Area -->
 23  ❌ 0             <Border Grid.Row="1"
 24                           Background="#FAFAFA"
 25  ❌ 0                     Padding="16"
 26                           ClipToBounds="True">
 27  ❌ 0                 <StackPanel>
 28  ❌ 0                     <TextBlock Text="Captured Image Preview" FontWeight="Bold" FontSize="16" />
 29                           <!-- Show captured image when available -->
 30  ❌ 0                     <Image Source="{Binding CapturedImage}"
 31                                  Stretch="Uniform"
 32  ❌ 0                            IsVisible="{Binding HasImage}"
 33                                  HorizontalAlignment="Center"
 34  ❌ 0                            VerticalAlignment="Center" />
 35           
 36                           <!-- Placeholder when no image -->
 37  ❌ 0                     <StackPanel IsVisible="{Binding !HasImage}"
 38                                       HorizontalAlignment="Center"
 39  ❌ 0                                 VerticalAlignment="Center"
 40                                       Spacing="12">
 41  ❌ 0                         <TextBlock Text="📷"
 42                                          FontSize="64"
 43  ❌ 0                                    HorizontalAlignment="Center" />
 44  ❌ 0                         <TextBlock Text="No photo captured"
 45                                          FontSize="16"
 46  ❌ 0                                    Foreground="#757575"
 47                                          HorizontalAlignment="Center" />
 48                           </StackPanel>
 49                       </StackPanel>
 50                   </Border>
 51           
 52                   <!-- Action Buttons -->
 53  ❌ 0             <StackPanel Grid.Row="2"
 54                               Orientation="Horizontal"
 55  ❌ 0                         HorizontalAlignment="Center"
 56                               Spacing="12"
 57  ❌ 0                         Margin="16">
 58           
 59                       <!-- Capture Button -->
 60  ❌ 0                 <Button Command="{Binding CapturePhotoCommand}"
 61  ❌ 0                         IsEnabled="{Binding IsCameraAvailable}"
 62                               Padding="24,12"
 63  ❌ 0                         MinWidth="60"
 64                               MinHeight="60"
 65  ❌ 0                         HorizontalContentAlignment="Center"
 66  ❌ 0                         ToolTip.Tip="Take Photo">
 67  ❌ 0                     <TextBlock Text="📷" FontSize="24" />
 68                       </Button>
 69           
 70                       <!-- Clear Button -->
 71  ❌ 0                 <Button Command="{Binding ClearPhotoCommand}"
 72  ❌ 0                         IsVisible="{Binding HasImage}"
 73                               Padding="24,12"
 74  ❌ 0                         MinWidth="60"
 75                               MinHeight="60"
 76  ❌ 0                         HorizontalContentAlignment="Center"
 77  ❌ 0                         ToolTip.Tip="Clear">
 78  ❌ 0                     <TextBlock Text="✕" FontSize="24" />
 79                       </Button>
 80                   </StackPanel>
 81           
 82                   <!-- Loading Overlay -->
 83  ❌ 0             <Border Grid.Row="0"
 84                           Grid.RowSpan="3"
 85  ❌ 0                     Background="#CC000000"
 86  ❌ 0                     IsVisible="{Binding IsCapturing}">
 87  ❌ 0                 <StackPanel HorizontalAlignment="Center"
 88                                   VerticalAlignment="Center"
 89  ❌ 0                             Spacing="12">
 90  ❌ 0                     <ProgressBar IsIndeterminate="True"
 91                                        Width="200"
 92  ❌ 0                                  Height="4" />
 93  ❌ 0                     <TextBlock Text="Opening camera..."
 94                                      FontSize="16"
 95  ❌ 0                                Foreground="White"
 96                                      HorizontalAlignment="Center" />
 97                       </StackPanel>
 98                   </Border>
 99               </Grid>
100           </UserControl>
```
### E:\github\FunWasHad\src\FWH.Mobile\FWH.Mobile\Views\CameraCaptureControl.axaml.cs
```
 1           using Avalonia.Controls;
 2           using Avalonia.Markup.Xaml;
 3           
 4           namespace FWH.Mobile.Views;
 5           
 6           public partial class CameraCaptureControl : UserControl
 7           {
 8  ❌ 0         public CameraCaptureControl()
 9  ❌ 0         {
10  ❌ 0             InitializeComponent();
11  ❌ 0             DataContext = App.ServiceProvider.GetService(typeof(ViewModels.CameraCaptureViewModel));
12  ❌ 0         }
13           
14               private void InitializeComponent()
15  ❌ 0         {
16  ❌ 0             AvaloniaXamlLoader.Load(this);
17  ❌ 0         }
18           }
```
# FWH.Mobile.Views.ChatView

## Summary

|||
|:---|:---|
| Class: | FWH.Mobile.Views.ChatView |
| Assembly: | FWH.Mobile |
| **File(s):** | E:\github\FunWasHad\src\FWH.Mobile\FWH.Mobile\Views\ChatView.axaml<br />E:\github\FunWasHad\src\FWH.Mobile\FWH.Mobile\Views\ChatView.axaml.cs |
| **Line coverage:** | 0% (0 of 15) |
| Covered lines: | 0 |
| Uncovered lines: | 15 |
| Coverable lines: | 15 |
| Total lines: | 39 |
| **Branch coverage:** | 0% (0 of 2) |
| Covered branches: | 0 |
| Total branches: | 2 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **!XamlIlPopulate(...)** | 0% | 6 | 2 | 0% |
| **.ctor()** | 100% | 2 | 1 | 0% |

## File(s)

### E:\github\FunWasHad\src\FWH.Mobile\FWH.Mobile\Views\ChatView.axaml
```
 1  ❌ 0  ○  <UserControl xmlns="https://github.com/avaloniaui"
 2                        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
 3                        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
 4                        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
 5                        xmlns:mobile="using:FWH.Mobile"
 6                        xmlns:views="using:FWH.Mobile.Views"
 7                        xmlns:vm="clr-namespace:FWH.Common.Chat.ViewModels;assembly=FWH.Common.Chat"
 8                        mc:Ignorable="d" d:DesignWidth="800" d:DesignHeight="450"
 9                        x:Class="FWH.Mobile.Views.ChatView"
10                        x:DataType="vm:ChatViewModel">
11  ❌ 0         <Grid>
12                   <Grid.RowDefinitions>
13  ❌ 0                 <RowDefinition Height="*" />
14  ❌ 0                 <RowDefinition Height="Auto" />
15                   </Grid.RowDefinitions>
16           
17  ❌ 0             <mobile:ChatListControl Grid.Row="0" DataContext="{Binding ChatList}" />
18  ❌ 0             <mobile:ChatInputControl Grid.Row="1" DataContext="{Binding ChatInput}" />
19               </Grid>
20           </UserControl>
```
### E:\github\FunWasHad\src\FWH.Mobile\FWH.Mobile\Views\ChatView.axaml.cs
```
 1           using Avalonia.Controls;
 2           using FWH.Common.Chat.ViewModels;
 3           using Microsoft.Extensions.DependencyInjection;
 4           
 5           namespace FWH.Mobile.Views;
 6           
 7           public partial class ChatView : UserControl
 8           {
 9  ❌ 0         public ChatView()
10  ❌ 0         {
11  ❌ 0             InitializeComponent();
12           
13  ❌ 0             Loaded += (_, _) =>
14  ❌ 0             {
15  ❌ 0                 // Set DataContext for ChatViewModel
16  ❌ 0                 DataContext = App.ServiceProvider.GetRequiredService<ChatViewModel>();
17  ❌ 0             };
18  ❌ 0         }
19           }
```
# FWH.Mobile.Views.FavoriteIconConverter

## Summary

|||
|:---|:---|
| Class: | FWH.Mobile.Views.FavoriteIconConverter |
| Assembly: | FWH.Mobile |
| **File(s):** | E:\github\FunWasHad\src\FWH.Mobile\FWH.Mobile\Views\FavoriteIconConverter.cs |
| **Line coverage:** | 0% (0 of 8) |
| Covered lines: | 0 |
| Uncovered lines: | 8 |
| Coverable lines: | 8 |
| Total lines: | 151 |
| **Branch coverage:** | 0% (0 of 6) |
| Covered branches: | 0 |
| Total branches: | 6 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **Convert(...)** | 0% | 42 | 6 | 0% |
| **ConvertBack(...)** | 100% | 2 | 1 | 0% |

## File(s)

### E:\github\FunWasHad\src\FWH.Mobile\FWH.Mobile\Views\FavoriteIconConverter.cs
```
  1           using System;
  2           using System.Collections.Generic;
  3           using System.Globalization;
  4           using System.IO;
  5           using System.Net.Http;
  6           using System.Threading.Tasks;
  7           using Avalonia.Data.Converters;
  8           using Avalonia.Media.Imaging;
  9           using FWH.Mobile.Services;
 10           using Microsoft.Extensions.DependencyInjection;
 11           
 12           namespace FWH.Mobile.Views;
 13           
 14           /// <summary>
 15           /// Converter to display star icon based on favorite status.
 16           /// </summary>
 17           public class FavoriteIconConverter : IValueConverter
 18           {
 19               public object? Convert(object? value, Type targetType, object? parameter, CultureInfo culture)
 20  ❌ 0         {
 21  ❌ 0  ○          if (value is bool isFavorite)
 22  ❌ 0             {
 23  ❌ 0  ○              return isFavorite ? "⭐" : "☆";
 24                   }
 25  ❌ 0             return "☆";
 26  ❌ 0         }
 27           
 28               public object? ConvertBack(object? value, Type targetType, object? parameter, CultureInfo culture)
 29  ❌ 0         {
 30  ❌ 0             throw new NotImplementedException();
 31               }
 32           }
 33           
 34           /// <summary>
 35           /// Converter to display tooltip text based on favorite status.
 36           /// </summary>
 37           public class FavoriteTooltipConverter : IValueConverter
 38           {
 39               public object? Convert(object? value, Type targetType, object? parameter, CultureInfo culture)
 40               {
 41                   if (value is bool isFavorite)
 42                   {
 43                       return isFavorite ? "Remove from favorites" : "Add to favorites";
 44                   }
 45                   return "Add to favorites";
 46               }
 47           
 48               public object? ConvertBack(object? value, Type targetType, object? parameter, CultureInfo culture)
 49               {
 50                   throw new NotImplementedException();
 51               }
 52           }
 53           
 54           /// <summary>
 55           /// Converter to load images from URL strings using ImageService.
 56           /// </summary>
 57           public class UrlToImageConverter : IValueConverter
 58           {
 59               private static readonly Dictionary<string, Bitmap?> _imageCache = new();
 60           
 61               public object? Convert(object? value, Type targetType, object? parameter, CultureInfo culture)
 62               {
 63                   if (value is not string url || string.IsNullOrEmpty(url))
 64                       return null;
 65           
 66                   // Check cache first
 67                   if (_imageCache.TryGetValue(url, out var cachedBitmap))
 68                       return cachedBitmap;
 69           
 70                   // Get ImageService from DI
 71                   var imageService = App.ServiceProvider?.GetService<IImageService>();
 72                   if (imageService == null)
 73                   {
 74                       // Fallback to direct download if ImageService not available
 75                       return LoadImageDirectly(url);
 76                   }
 77           
 78                   // Load image via ImageService (which will cache in database)
 79                   try
 80                   {
 81                       var task = Task.Run(async () =>
 82                       {
 83                           try
 84                           {
 85                               // Extract image type from parameter if provided
 86                               var imageType = parameter?.ToString() ?? "general";
 87                               var imageData = await imageService.GetImageAsync(url, imageType);
 88           
 89                               if (imageData != null && imageData.Length > 0)
 90                               {
 91                                   using var stream = new System.IO.MemoryStream(imageData);
 92                                   return new Bitmap(stream);
 93                               }
 94                           }
 95                           catch (Exception ex)
 96                           {
 97                               System.Diagnostics.Debug.WriteLine($"Error loading image via ImageService: {ex.Message}");
 98                           }
 99                           return null;
100                       });
101           
102                       // Wait for result (blocks UI thread - not ideal but works)
103                       var bitmap = task.Result;
104                       if (bitmap != null)
105                       {
106                           _imageCache[url] = bitmap;
107                       }
108                       return bitmap;
109                   }
110                   catch
111                   {
112                       return null;
113                   }
114               }
115           
116               private static Bitmap? LoadImageDirectly(string url)
117               {
118                   try
119                   {
120                       using var httpClient = new HttpClient();
121                       var task = Task.Run(async () =>
122                       {
123                           try
124                           {
125                               var response = await httpClient.GetAsync(url);
126                               if (response.IsSuccessStatusCode)
127                               {
128                                   var stream = await response.Content.ReadAsStreamAsync();
129                                   return new Bitmap(stream);
130                               }
131                           }
132                           catch
133                           {
134                               // Ignore errors
135                           }
136                           return null;
137                       });
138           
139                       return task.Result;
140                   }
141                   catch
142                   {
143                       return null;
144                   }
145               }
146           
147               public object? ConvertBack(object? value, Type targetType, object? parameter, CultureInfo culture)
148               {
149                   throw new NotImplementedException();
150               }
151           }
```
# FWH.Mobile.Views.FavoriteTooltipConverter

## Summary

|||
|:---|:---|
| Class: | FWH.Mobile.Views.FavoriteTooltipConverter |
| Assembly: | FWH.Mobile |
| **File(s):** | E:\github\FunWasHad\src\FWH.Mobile\FWH.Mobile\Views\FavoriteIconConverter.cs |
| **Line coverage:** | 0% (0 of 8) |
| Covered lines: | 0 |
| Uncovered lines: | 8 |
| Coverable lines: | 8 |
| Total lines: | 151 |
| **Branch coverage:** | 0% (0 of 6) |
| Covered branches: | 0 |
| Total branches: | 6 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **Convert(...)** | 0% | 42 | 6 | 0% |
| **ConvertBack(...)** | 100% | 2 | 1 | 0% |

## File(s)

### E:\github\FunWasHad\src\FWH.Mobile\FWH.Mobile\Views\FavoriteIconConverter.cs
```
  1           using System;
  2           using System.Collections.Generic;
  3           using System.Globalization;
  4           using System.IO;
  5           using System.Net.Http;
  6           using System.Threading.Tasks;
  7           using Avalonia.Data.Converters;
  8           using Avalonia.Media.Imaging;
  9           using FWH.Mobile.Services;
 10           using Microsoft.Extensions.DependencyInjection;
 11           
 12           namespace FWH.Mobile.Views;
 13           
 14           /// <summary>
 15           /// Converter to display star icon based on favorite status.
 16           /// </summary>
 17           public class FavoriteIconConverter : IValueConverter
 18           {
 19               public object? Convert(object? value, Type targetType, object? parameter, CultureInfo culture)
 20               {
 21                   if (value is bool isFavorite)
 22                   {
 23                       return isFavorite ? "⭐" : "☆";
 24                   }
 25                   return "☆";
 26               }
 27           
 28               public object? ConvertBack(object? value, Type targetType, object? parameter, CultureInfo culture)
 29               {
 30                   throw new NotImplementedException();
 31               }
 32           }
 33           
 34           /// <summary>
 35           /// Converter to display tooltip text based on favorite status.
 36           /// </summary>
 37           public class FavoriteTooltipConverter : IValueConverter
 38           {
 39               public object? Convert(object? value, Type targetType, object? parameter, CultureInfo culture)
 40  ❌ 0         {
 41  ❌ 0  ○          if (value is bool isFavorite)
 42  ❌ 0             {
 43  ❌ 0  ○              return isFavorite ? "Remove from favorites" : "Add to favorites";
 44                   }
 45  ❌ 0             return "Add to favorites";
 46  ❌ 0         }
 47           
 48               public object? ConvertBack(object? value, Type targetType, object? parameter, CultureInfo culture)
 49  ❌ 0         {
 50  ❌ 0             throw new NotImplementedException();
 51               }
 52           }
 53           
 54           /// <summary>
 55           /// Converter to load images from URL strings using ImageService.
 56           /// </summary>
 57           public class UrlToImageConverter : IValueConverter
 58           {
 59               private static readonly Dictionary<string, Bitmap?> _imageCache = new();
 60           
 61               public object? Convert(object? value, Type targetType, object? parameter, CultureInfo culture)
 62               {
 63                   if (value is not string url || string.IsNullOrEmpty(url))
 64                       return null;
 65           
 66                   // Check cache first
 67                   if (_imageCache.TryGetValue(url, out var cachedBitmap))
 68                       return cachedBitmap;
 69           
 70                   // Get ImageService from DI
 71                   var imageService = App.ServiceProvider?.GetService<IImageService>();
 72                   if (imageService == null)
 73                   {
 74                       // Fallback to direct download if ImageService not available
 75                       return LoadImageDirectly(url);
 76                   }
 77           
 78                   // Load image via ImageService (which will cache in database)
 79                   try
 80                   {
 81                       var task = Task.Run(async () =>
 82                       {
 83                           try
 84                           {
 85                               // Extract image type from parameter if provided
 86                               var imageType = parameter?.ToString() ?? "general";
 87                               var imageData = await imageService.GetImageAsync(url, imageType);
 88           
 89                               if (imageData != null && imageData.Length > 0)
 90                               {
 91                                   using var stream = new System.IO.MemoryStream(imageData);
 92                                   return new Bitmap(stream);
 93                               }
 94                           }
 95                           catch (Exception ex)
 96                           {
 97                               System.Diagnostics.Debug.WriteLine($"Error loading image via ImageService: {ex.Message}");
 98                           }
 99                           return null;
100                       });
101           
102                       // Wait for result (blocks UI thread - not ideal but works)
103                       var bitmap = task.Result;
104                       if (bitmap != null)
105                       {
106                           _imageCache[url] = bitmap;
107                       }
108                       return bitmap;
109                   }
110                   catch
111                   {
112                       return null;
113                   }
114               }
115           
116               private static Bitmap? LoadImageDirectly(string url)
117               {
118                   try
119                   {
120                       using var httpClient = new HttpClient();
121                       var task = Task.Run(async () =>
122                       {
123                           try
124                           {
125                               var response = await httpClient.GetAsync(url);
126                               if (response.IsSuccessStatusCode)
127                               {
128                                   var stream = await response.Content.ReadAsStreamAsync();
129                                   return new Bitmap(stream);
130                               }
131                           }
132                           catch
133                           {
134                               // Ignore errors
135                           }
136                           return null;
137                       });
138           
139                       return task.Result;
140                   }
141                   catch
142                   {
143                       return null;
144                   }
145               }
146           
147               public object? ConvertBack(object? value, Type targetType, object? parameter, CultureInfo culture)
148               {
149                   throw new NotImplementedException();
150               }
151           }
```
# FWH.Mobile.Views.LogView

## Summary

|||
|:---|:---|
| Class: | FWH.Mobile.Views.LogView |
| Assembly: | FWH.Mobile |
| **File(s):** | E:\github\FunWasHad\src\FWH.Mobile\FWH.Mobile\Views\LogView.axaml<br />E:\github\FunWasHad\src\FWH.Mobile\FWH.Mobile\Views\LogView.axaml.cs |
| **Line coverage:** | 0% (0 of 14) |
| Covered lines: | 0 |
| Uncovered lines: | 14 |
| Coverable lines: | 14 |
| Total lines: | 31 |
| **Branch coverage:** | 0% (0 of 4) |
| Covered branches: | 0 |
| Total branches: | 4 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **!XamlIlPopulate(...)** | 0% | 6 | 2 | 0% |
| **.ctor()** | 100% | 2 | 1 | 0% |

## File(s)

### E:\github\FunWasHad\src\FWH.Mobile\FWH.Mobile\Views\LogView.axaml
```
1  ❌ 0  ○  <UserControl xmlns="https://github.com/avaloniaui"
2                        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
3                        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
4                        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
5                        xmlns:views="using:FWH.Mobile.Views"
6                        mc:Ignorable="d" d:DesignWidth="800" d:DesignHeight="450"
7                        x:Class="FWH.Mobile.Views.LogView">
8  ❌ 0         <views:LogViewerControl Name="LogViewer" />
9           </UserControl>
```
### E:\github\FunWasHad\src\FWH.Mobile\FWH.Mobile\Views\LogView.axaml.cs
```
 1           using Avalonia.Controls;
 2           using FWH.Mobile.ViewModels;
 3           using Microsoft.Extensions.DependencyInjection;
 4           
 5           namespace FWH.Mobile.Views;
 6           
 7           public partial class LogView : UserControl
 8           {
 9  ❌ 0         public LogView()
10  ❌ 0         {
11  ❌ 0             InitializeComponent();
12           
13  ❌ 0             Loaded += (_, _) =>
14  ❌ 0             {
15  ❌ 0                 var logViewer = this.FindControl<LogViewerControl>("LogViewer");
16  ❌ 0  ○              if (logViewer != null)
17  ❌ 0                 {
18  ❌ 0                     logViewer.DataContext = App.ServiceProvider.GetRequiredService<LogViewerViewModel>();
19  ❌ 0                 }
20  ❌ 0             };
21  ❌ 0         }
22           }
```
# FWH.Mobile.Views.LogViewerControl

## Summary

|||
|:---|:---|
| Class: | FWH.Mobile.Views.LogViewerControl |
| Assembly: | FWH.Mobile |
| **File(s):** | E:\github\FunWasHad\src\FWH.Mobile\FWH.Mobile\Views\LogViewerControl.axaml<br />E:\github\FunWasHad\src\FWH.Mobile\FWH.Mobile\Views\LogViewerControl.axaml.cs |
| **Line coverage:** | 0% (0 of 69) |
| Covered lines: | 0 |
| Uncovered lines: | 69 |
| Coverable lines: | 69 |
| Total lines: | 124 |
| **Branch coverage:** | 0% (0 of 10) |
| Covered branches: | 0 |
| Total branches: | 10 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **!XamlIlPopulate(...)** | 0% | 6 | 2 | 0% |
| **.ctor()** | 100% | 2 | 1 | 0% |
| **OnPropertyChanged(...)** | 0% | 42 | 6 | 0% |
| **ScrollToEnd()** | 0% | 6 | 2 | 0% |
| **Build_1(...)** | 100% | 2 | 1 | 0% |

## File(s)

### E:\github\FunWasHad\src\FWH.Mobile\FWH.Mobile\Views\LogViewerControl.axaml
```
 1  ❌ 0  ○  <UserControl xmlns="https://github.com/avaloniaui"
 2                        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
 3                        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
 4                        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
 5                        xmlns:vm="clr-namespace:FWH.Mobile.ViewModels"
 6                        mc:Ignorable="d" d:DesignWidth="800" d:DesignHeight="250"
 7                        x:Class="FWH.Mobile.Views.LogViewerControl"
 8                        x:DataType="vm:LogViewerViewModel">
 9           
10  ❌ 0         <DockPanel>
11  ❌ 0             <StackPanel DockPanel.Dock="Top" Orientation="Horizontal" Margin="0,0,0,6">
12  ❌ 0                 <Button Content="✕"
13  ❌ 0                         Command="{Binding ClearCommand}"
14  ❌ 0                         ToolTip.Tip="Clear logs"
15                               HorizontalAlignment="Left"
16  ❌ 0                         Margin="0,0,6,0"
17                               Width="32"
18  ❌ 0                         Height="32" />
19           
20  ❌ 0                 <Button Content="{Binding PauseButtonText}"
21  ❌ 0                         Command="{Binding TogglePauseCommand}"
22  ❌ 0                         ToolTip.Tip="{Binding PauseButtonToolTip}"
23                               HorizontalAlignment="Left"
24  ❌ 0                         Margin="0,0,6,0"
25                               Width="32"
26  ❌ 0                         Height="32" />
27           
28  ❌ 0                 <ComboBox ItemsSource="{Binding LogLevels}"
29  ❌ 0                           SelectedItem="{Binding SelectedLogLevel}"
30                                 MinWidth="120"
31  ❌ 0                           Margin="0,0,6,0" />
32           
33  ❌ 0                 <Button Content="⬇"
34  ❌ 0                         Command="{Binding ScrollToEndCommand}"
35  ❌ 0                         ToolTip.Tip="Scroll to end"
36                               HorizontalAlignment="Left"
37  ❌ 0                         Width="32"
38                               Height="32" />
39                   </StackPanel>
40           
41  ❌ 0             <Border BorderBrush="#3A3A3A" BorderThickness="1" CornerRadius="4" Padding="6">
42  ❌ 0                 <ScrollViewer x:Name="LogScrollViewer">
43  ❌ 0                     <ItemsControl ItemsSource="{Binding FilteredEntries}">
44                               <ItemsControl.ItemTemplate>
45  ❌ 0                             <DataTemplate>
46  ❌ 0                                 <Border Background="{Binding LevelBackgroundColor}"
47                                               Padding="4,2"
48  ❌ 0                                         Margin="0,0,0,1">
49  ❌ 0                                     <TextBlock FontFamily="Consolas" FontSize="12" TextWrapping="Wrap" Foreground="#FFFFFF">
50  ❌ 0                                         <Run Text="[" Foreground="#888888" />
51  ❌ 0                                         <Run Text="{Binding Id}" Foreground="#AAAAAA" />
52  ❌ 0                                         <Run Text="]" Foreground="#888888" />
53  ❌ 0                                         <Run Text=" " />
54  ❌ 0                                         <Run Text="{Binding TimestampUtc}" Foreground="#CCCCCC" />
55  ❌ 0                                         <Run Text=" " />
56  ❌ 0                                         <Run Text="{Binding LevelShort}" FontWeight="Bold" />
57  ❌ 0                                         <Run Text=" " />
58  ❌ 0                                         <Run Text="{Binding Category}" Foreground="#DDDDDD" />
59  ❌ 0                                         <Run Text=": " />
60  ❌ 0                                         <Run Text="{Binding Message}" />
61                                           </TextBlock>
62                                       </Border>
63                                   </DataTemplate>
64                               </ItemsControl.ItemTemplate>
65                           </ItemsControl>
66                       </ScrollViewer>
67                   </Border>
68               </DockPanel>
69           </UserControl>
```
### E:\github\FunWasHad\src\FWH.Mobile\FWH.Mobile\Views\LogViewerControl.axaml.cs
```
 1           using Avalonia.Controls;
 2           using Avalonia.Data;
 3           using Avalonia.Threading;
 4           using FWH.Mobile.ViewModels;
 5           using System;
 6           
 7           namespace FWH.Mobile.Views;
 8           
 9           public partial class LogViewerControl : UserControl
10           {
11               private LogViewerViewModel? _currentViewModel;
12           
13  ❌ 0         public LogViewerControl()
14  ❌ 0         {
15  ❌ 0             InitializeComponent();
16  ❌ 0             PropertyChanged += OnPropertyChanged;
17  ❌ 0         }
18           
19               private void OnPropertyChanged(object? sender, Avalonia.AvaloniaPropertyChangedEventArgs e)
20  ❌ 0         {
21  ❌ 0  ○          if (e.Property == DataContextProperty)
22  ❌ 0             {
23                       // Unsubscribe from previous view model
24  ❌ 0  ○              if (_currentViewModel != null)
25  ❌ 0                 {
26  ❌ 0                     _currentViewModel.ScrollToEndRequested -= ScrollToEnd;
27  ❌ 0                 }
28           
29                       // Subscribe to new view model
30  ❌ 0  ○              if (DataContext is LogViewerViewModel viewModel)
31  ❌ 0                 {
32  ❌ 0                     _currentViewModel = viewModel;
33  ❌ 0                     viewModel.ScrollToEndRequested += ScrollToEnd;
34  ❌ 0                 }
35                       else
36  ❌ 0                 {
37  ❌ 0                     _currentViewModel = null;
38  ❌ 0                 }
39  ❌ 0             }
40  ❌ 0         }
41           
42               private void ScrollToEnd()
43  ❌ 0         {
44  ❌ 0  ○          if (LogScrollViewer != null)
45  ❌ 0             {
46                       // Use Dispatcher to ensure scrolling happens after UI updates are complete
47                       // Post with Render priority to ensure it happens after layout
48  ❌ 0                 Dispatcher.UIThread.Post(() =>
49  ❌ 0                 {
50  ❌ 0                     LogScrollViewer?.ScrollToEnd();
51  ❌ 0                 }, DispatcherPriority.Render);
52  ❌ 0             }
53  ❌ 0         }
54           }
55           
```
# FWH.Mobile.Views.MainView

## Summary

|||
|:---|:---|
| Class: | FWH.Mobile.Views.MainView |
| Assembly: | FWH.Mobile |
| **File(s):** | E:\github\FunWasHad\src\FWH.Mobile\FWH.Mobile\Views\MainView.axaml<br />E:\github\FunWasHad\src\FWH.Mobile\FWH.Mobile\Views\MainView.axaml.cs |
| **Line coverage:** | 0% (0 of 59) |
| Covered lines: | 0 |
| Uncovered lines: | 59 |
| Coverable lines: | 59 |
| Total lines: | 117 |
| **Branch coverage:** | 0% (0 of 8) |
| Covered branches: | 0 |
| Total branches: | 8 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **!XamlIlPopulate(...)** | 0% | 6 | 2 | 0% |
| **.ctor()** | 0% | 42 | 6 | 0% |
| **get_ViewModel()** | 100% | 2 | 1 | 0% |
| **set_ViewModel(...)** | 100% | 2 | 1 | 0% |

## File(s)

### E:\github\FunWasHad\src\FWH.Mobile\FWH.Mobile\Views\MainView.axaml
```
 1  ❌ 0  ○  <UserControl xmlns="https://github.com/avaloniaui"
 2                        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
 3                        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
 4                        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
 5                        xmlns:vm="using:FWH.Mobile.ViewModels"
 6                        xmlns:views="using:FWH.Mobile.Views"
 7                        mc:Ignorable="d" d:DesignWidth="800" d:DesignHeight="450"
 8                        x:Class="FWH.Mobile.Views.MainView"
 9                        x:DataType="vm:MainViewModel">
10  ❌ 0         <Grid x:Name="MainGrid">
11                   <Grid.RowDefinitions>
12  ❌ 0                 <RowDefinition Height="*" />
13  ❌ 0                 <RowDefinition Height="*" />
14  ❌ 0                 <RowDefinition Height="Auto" />
15                   </Grid.RowDefinitions>
16           
17                   <!-- Content Area -->
18  ❌ 0             <ContentControl Grid.Row="0"
19  ❌ 0                             Content="{Binding CurrentView}" />
20           
21                   <!-- Log View (shown in lower half when not in RELEASE) -->
22  ❌ 0             <views:LogView Grid.Row="1"
23  ❌ 0                            x:Name="LogViewControl"
24  ❌ 0                            IsVisible="{Binding ShowLogViewAlways}" />
25           
26                   <!-- Toolbar -->
27  ❌ 0             <Border Grid.Row="2"
28                           BorderBrush="#E0E0E0"
29  ❌ 0                     BorderThickness="0,1,0,0"
30                           Background="#F8F9FA"
31  ❌ 0                     Padding="8">
32  ❌ 0                 <StackPanel Orientation="Horizontal"
33                                  Spacing="8"
34  ❌ 0                            HorizontalAlignment="Center">
35  ❌ 0                     <Button Command="{Binding NavigateToChatCommand}"
36                                   Padding="16,8"
37  ❌ 0                             MinWidth="60"
38                                   MinHeight="60"
39  ❌ 0                             ToolTip.Tip="Chat">
40  ❌ 0                         <TextBlock Text="💬" FontSize="24" />
41                           </Button>
42  ❌ 0                     <Button Command="{Binding NavigateToMapCommand}"
43                                   Padding="16,8"
44  ❌ 0                             MinWidth="60"
45                                   MinHeight="60"
46  ❌ 0                             ToolTip.Tip="Map">
47  ❌ 0                         <TextBlock Text="🗺️" FontSize="24" />
48                           </Button>
49  ❌ 0                     <Button Command="{Binding NavigateToSettingsCommand}"
50                                   Padding="16,8"
51  ❌ 0                             MinWidth="60"
52                                   MinHeight="60"
53  ❌ 0                             ToolTip.Tip="Settings">
54  ❌ 0                         <TextBlock Text="⚙️" FontSize="24" />
55                           </Button>
56  ❌ 0                     <Button Command="{Binding NavigateToLogCommand}"
57                                   Padding="16,8"
58  ❌ 0                             MinWidth="60"
59                                   MinHeight="60"
60  ❌ 0                             ToolTip.Tip="Log">
61  ❌ 0                         <TextBlock Text="📋" FontSize="24" />
62                           </Button>
63  ❌ 0                     <Button Command="{Binding NavigateToPlacesCommand}"
64                                   Padding="16,8"
65  ❌ 0                             MinWidth="60"
66                                   MinHeight="60"
67  ❌ 0                             ToolTip.Tip="Places">
68  ❌ 0                         <TextBlock Text="📍" FontSize="24" />
69                           </Button>
70                       </StackPanel>
71                   </Border>
72               </Grid>
73           </UserControl>
```
### E:\github\FunWasHad\src\FWH.Mobile\FWH.Mobile\Views\MainView.axaml.cs
```
 1           using Avalonia.Controls;
 2           using Avalonia.Layout;
 3           using FWH.Mobile.ViewModels;
 4           using FWH.Common.Chat.ViewModels;
 5           using Microsoft.Extensions.DependencyInjection;
 6           using System;
 7           
 8           namespace FWH.Mobile.Views;
 9           
10           public partial class MainView : UserControl
11           {
12  ❌ 0         public MainView()
13  ❌ 0         {
14  ❌ 0             InitializeComponent();
15           
16                   // Set DataContext to MainViewModel
17  ❌ 0             var viewModel = App.ServiceProvider.GetRequiredService<MainViewModel>();
18  ❌ 0             DataContext = viewModel;
19           
20                   // Set up log view row height based on build configuration
21  ❌ 0             this.Loaded += (s, e) =>
22  ❌ 0             {
23  ❌ 0                 var grid = this.FindControl<Grid>("MainGrid");
24  ❌ 0  ○              if (grid != null && grid.RowDefinitions.Count > 1)
25  ❌ 0                 {
26  ❌ 0                     var logViewRow = grid.RowDefinitions[1];
27  ❌ 0  ○                  if (viewModel.ShowLogViewAlways)
28  ❌ 0                     {
29  ❌ 0                         logViewRow.Height = new GridLength(1, GridUnitType.Star);
30  ❌ 0                     }
31  ❌ 0                     else
32  ❌ 0                     {
33  ❌ 0                         logViewRow.Height = new GridLength(0);
34  ❌ 0                     }
35  ❌ 0                 }
36  ❌ 0             };
37  ❌ 0         }
38           
39               public MainViewModel? ViewModel
40               {
41  ❌ 0             get => DataContext as MainViewModel;
42  ❌ 0             set => DataContext = value;
43               }
44           }
```
# FWH.Mobile.Views.MainWindow

## Summary

|||
|:---|:---|
| Class: | FWH.Mobile.Views.MainWindow |
| Assembly: | FWH.Mobile |
| **File(s):** | E:\github\FunWasHad\src\FWH.Mobile\FWH.Mobile\Views\MainWindow.axaml<br />E:\github\FunWasHad\src\FWH.Mobile\FWH.Mobile\Views\MainWindow.axaml.cs |
| **Line coverage:** | 0% (0 of 8) |
| Covered lines: | 0 |
| Uncovered lines: | 8 |
| Coverable lines: | 8 |
| Total lines: | 26 |
| **Branch coverage:** | 0% (0 of 2) |
| Covered branches: | 0 |
| Total branches: | 2 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **!XamlIlPopulate(...)** | 0% | 6 | 2 | 0% |
| **.ctor()** | 100% | 2 | 1 | 0% |

## File(s)

### E:\github\FunWasHad\src\FWH.Mobile\FWH.Mobile\Views\MainWindow.axaml
```
 1  ❌ 0  ○  <Window xmlns="https://github.com/avaloniaui"
 2                   xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
 3                   xmlns:vm="using:FWH.Mobile.ViewModels"
 4                   xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
 5                   xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
 6                   xmlns:views="clr-namespace:FWH.Mobile.Views"
 7                   mc:Ignorable="d" d:DesignWidth="800" d:DesignHeight="450"
 8                   x:Class="FWH.Mobile.Views.MainWindow"
 9  ❌ 0             Icon="/Assets/avalonia-logo.ico"
10  ❌ 0             Title="#FunWasHad">
11  ❌ 0         <views:MainView x:Name="MainView" />
12           
13           </Window>
14           
```
### E:\github\FunWasHad\src\FWH.Mobile\FWH.Mobile\Views\MainWindow.axaml.cs
```
 1           using Avalonia.Controls;
 2           using FWH.Mobile.ViewModels;
 3           
 4           namespace FWH.Mobile.Views;
 5           public partial class MainWindow : Window
 6           {
 7  ❌ 0         public MainWindow()
 8  ❌ 0         {
 9  ❌ 0             InitializeComponent();
10  ❌ 0         }
11           }
12           
```
# FWH.Mobile.Views.MapView

## Summary

|||
|:---|:---|
| Class: | FWH.Mobile.Views.MapView |
| Assembly: | FWH.Mobile |
| **File(s):** | E:\github\FunWasHad\src\FWH.Mobile\FWH.Mobile\Views\MapView.axaml<br />E:\github\FunWasHad\src\FWH.Mobile\FWH.Mobile\Views\MapView.axaml.cs |
| **Line coverage:** | 0% (0 of 85) |
| Covered lines: | 0 |
| Uncovered lines: | 85 |
| Coverable lines: | 85 |
| Total lines: | 146 |
| **Branch coverage:** | 0% (0 of 36) |
| Covered branches: | 0 |
| Total branches: | 36 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **!XamlIlPopulate(...)** | 0% | 6 | 2 | 0% |
| **.ctor()** | 100% | 2 | 1 | 0% |
| **OnLocationUpdated(...)** | 100% | 2 | 1 | 0% |
| **OnMovementStateChanged(...)** | 100% | 2 | 1 | 0% |
| **InitializeMap()** | 0% | 72 | 8 | 0% |
| **UpdateMapLocation()** | 0% | 156 | 12 | 0% |
| **GetEmojiForMovementState(...)** | 0% | 42 | 6 | 0% |

## File(s)

### E:\github\FunWasHad\src\FWH.Mobile\FWH.Mobile\Views\MapView.axaml
```
 1  ❌ 0  ○  <UserControl xmlns="https://github.com/avaloniaui"
 2                        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
 3                        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
 4                        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
 5                        xmlns:views="using:FWH.Mobile.Views"
 6                        xmlns:mapsui="using:Mapsui.UI.Avalonia"
 7                        mc:Ignorable="d" d:DesignWidth="800" d:DesignHeight="450"
 8                        x:Class="FWH.Mobile.Views.MapView">
 9  ❌ 0         <Grid>
10                   <Grid.RowDefinitions>
11  ❌ 0                 <RowDefinition Height="Auto" />
12  ❌ 0                 <RowDefinition Height="*" />
13                   </Grid.RowDefinitions>
14           
15  ❌ 0             <views:MovementStateControl Grid.Row="0" Margin="8" Name="MovementState" />
16           
17  ❌ 0             <Border Grid.Row="1"
18                           BorderBrush="#E0E0E0"
19  ❌ 0                     BorderThickness="1"
20                           CornerRadius="4"
21  ❌ 0                     Margin="8"
22                           Background="#FFFFFF">
23  ❌ 0                 <mapsui:MapControl x:Name="LocationMap"
24                                          HorizontalAlignment="Stretch"
25  ❌ 0                                    VerticalAlignment="Stretch" />
26                   </Border>
27               </Grid>
28           </UserControl>
```
### E:\github\FunWasHad\src\FWH.Mobile\FWH.Mobile\Views\MapView.axaml.cs
```
  1           using Avalonia.Controls;
  2           using FWH.Mobile.ViewModels;
  3           using FWH.Mobile.Services;
  4           using Mapsui;
  5           using Mapsui.Layers;
  6           using Mapsui.Projections;
  7           using Mapsui.Styles;
  8           using Mapsui.Tiling;
  9           using Mapsui.UI.Avalonia;
 10           using Microsoft.Extensions.DependencyInjection;
 11           using System;
 12           
 13           namespace FWH.Mobile.Views;
 14           
 15           public partial class MapView : UserControl
 16           {
 17               private MovementStateViewModel? _viewModel;
 18               private Services.ILocationTrackingService? _locationTrackingService;
 19  ❌ 0         private MovementState _currentMovementState = FWH.Mobile.Services.MovementState.Unknown;
 20           
 21  ❌ 0         public MapView()
 22  ❌ 0         {
 23  ❌ 0             InitializeComponent();
 24           
 25  ❌ 0             Loaded += (_, _) =>
 26  ❌ 0             {
 27  ❌ 0                 // Set DataContext for MovementStateControl (control named "MovementState" in AXAML)
 28  ❌ 0                 var movementStateControl = this.FindControl<MovementStateControl>("MovementState");
 29  ❌ 0  ○              if (movementStateControl != null)
 30  ❌ 0                 {
 31  ❌ 0                     _viewModel = App.ServiceProvider.GetRequiredService<MovementStateViewModel>();
 32  ❌ 0                     movementStateControl.DataContext = _viewModel;
 33  ❌ 0     
 34  ❌ 0                     // Subscribe to location and movement state updates
 35  ❌ 0                     _locationTrackingService = App.ServiceProvider.GetRequiredService<Services.ILocationTrackingService>();
 36  ❌ 0                     _locationTrackingService.LocationUpdated += OnLocationUpdated;
 37  ❌ 0                     _locationTrackingService.MovementStateChanged += OnMovementStateChanged;
 38  ❌ 0     
 39  ❌ 0                     // Get current movement state
 40  ❌ 0                     _currentMovementState = _locationTrackingService.CurrentMovementState;
 41  ❌ 0                 }
 42  ❌ 0     
 43  ❌ 0                 // Initialize map
 44  ❌ 0                 InitializeMap();
 45  ❌ 0     
 46  ❌ 0                 // Update map with current location if available
 47  ❌ 0  ○              if (_viewModel != null && _viewModel.Latitude.HasValue && _viewModel.Longitude.HasValue)
 48  ❌ 0                 {
 49  ❌ 0                     UpdateMapLocation();
 50  ❌ 0                 }
 51  ❌ 0             };
 52  ❌ 0         }
 53           
 54               private void OnLocationUpdated(object? sender, Common.Location.Models.GpsCoordinates e)
 55  ❌ 0         {
 56  ❌ 0             UpdateMapLocation();
 57  ❌ 0         }
 58           
 59               private void OnMovementStateChanged(object? sender, MovementStateChangedEventArgs e)
 60  ❌ 0         {
 61  ❌ 0             _currentMovementState = e.CurrentState;
 62  ❌ 0             UpdateMapLocation();
 63  ❌ 0         }
 64           
 65               private void InitializeMap()
 66  ❌ 0         {
 67  ❌ 0             var locationMap = this.FindControl<MapControl>("LocationMap");
 68  ❌ 0  ○          if (locationMap?.Map == null)
 69  ❌ 0                 return;
 70           
 71                   // Add OpenStreetMap tile layer
 72  ❌ 0             locationMap.Map.Layers.Add(OpenStreetMap.CreateTileLayer());
 73           
 74                   // Set initial map view (Mapsui 5: use Navigator.CenterOnAndZoomTo instead of Home)
 75  ❌ 0             var resolutions = locationMap.Map.Navigator.Resolutions;
 76  ❌ 0  ○          if (resolutions.Count > 9)
 77  ❌ 0                 locationMap.Map.Navigator.CenterOnAndZoomTo(new MPoint(0, 0), resolutions[9]);
 78           
 79                   // Subscribe to location updates if view model is available
 80  ❌ 0  ○          if (_viewModel != null)
 81  ❌ 0             {
 82  ❌ 0                 UpdateMapLocation();
 83  ❌ 0             }
 84  ❌ 0         }
 85           
 86               private void UpdateMapLocation()
 87  ❌ 0         {
 88  ❌ 0             var locationMap = this.FindControl<MapControl>("LocationMap");
 89  ❌ 0  ○          if (locationMap?.Map == null || _viewModel == null || !_viewModel.Latitude.HasValue || !_viewModel.Longitude.Has
 90  ❌ 0                 return;
 91           
 92  ❌ 0             var lat = _viewModel.Latitude.Value;
 93  ❌ 0             var lon = _viewModel.Longitude.Value;
 94           
 95                   // Convert WGS84 (lat/lon) to Web Mercator (used by maps)
 96  ❌ 0             var (x, y) = SphericalMercator.FromLonLat(lon, lat);
 97           
 98                   // Center map on location (Mapsui 5: use Navigator.CenterOnAndZoomTo)
 99                   // TODO: Restore device marker layer when Mapsui 5 MemoryLayer API is confirmed
100  ❌ 0             var resolutions = locationMap.Map.Navigator.Resolutions;
101  ❌ 0  ○          if (resolutions.Count > 15)
102  ❌ 0                 locationMap.Map.Navigator.CenterOnAndZoomTo(new MPoint(x, y), resolutions[15]);
103  ❌ 0             locationMap.Refresh();
104  ❌ 0         }
105           
106               private static string GetEmojiForMovementState(FWH.Mobile.Services.MovementState state)
107  ❌ 0         {
108  ❌ 0  ○          return state switch
109  ❌ 0             {
110  ❌ 0                 FWH.Mobile.Services.MovementState.Unknown => "😊",
111  ❌ 0                 FWH.Mobile.Services.MovementState.Stationary => "😊",
112  ❌ 0                 FWH.Mobile.Services.MovementState.Walking => "🚶",
113  ❌ 0                 FWH.Mobile.Services.MovementState.Riding => "🚕",
114  ❌ 0                 FWH.Mobile.Services.MovementState.Moving => "🚕", // Use taxi for Moving as well
115  ❌ 0                 _ => "😊" // Default to smiley
116  ❌ 0             };
117  ❌ 0         }
118           }
```
# FWH.Mobile.Views.MovementStateControl

## Summary

|||
|:---|:---|
| Class: | FWH.Mobile.Views.MovementStateControl |
| Assembly: | FWH.Mobile |
| **File(s):** | E:\github\FunWasHad\src\FWH.Mobile\FWH.Mobile\Views\MovementStateControl.axaml<br />E:\github\FunWasHad\src\FWH.Mobile\FWH.Mobile\Views\MovementStateControl.axaml.cs |
| **Line coverage:** | 0% (0 of 84) |
| Covered lines: | 0 |
| Uncovered lines: | 84 |
| Coverable lines: | 84 |
| Total lines: | 187 |
| **Branch coverage:** | 0% (0 of 28) |
| Covered branches: | 0 |
| Total branches: | 28 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **!XamlIlPopulate(...)** | 0% | 6 | 2 | 0% |
| **.ctor()** | 100% | 2 | 1 | 0% |
| **OnDataContextChanged(...)** | 0% | 20 | 4 | 0% |
| **OnViewModelPropertyChanged(...)** | 0% | 20 | 4 | 0% |
| **InitializeMap()** | 0% | 42 | 6 | 0% |
| **UpdateMapLocation()** | 0% | 156 | 12 | 0% |

## File(s)

### E:\github\FunWasHad\src\FWH.Mobile\FWH.Mobile\Views\MovementStateControl.axaml
```
 1  ❌ 0  ○  <UserControl xmlns="https://github.com/avaloniaui"
 2                        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
 3                        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
 4                        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
 5                        xmlns:vm="using:FWH.Mobile.ViewModels"
 6                        xmlns:mapsui="using:Mapsui.UI.Avalonia"
 7                        mc:Ignorable="d" d:DesignWidth="800" d:DesignHeight="400"
 8                        x:Class="FWH.Mobile.Views.MovementStateControl"
 9                        x:DataType="vm:MovementStateViewModel">
10           
11  ❌ 0         <Border BorderBrush="#E0E0E0"
12                       BorderThickness="1"
13  ❌ 0                 CornerRadius="8"
14                       Padding="12"
15  ❌ 0                 Background="#FAFAFA">
16  ❌ 0             <Grid RowDefinitions="Auto,Auto,Auto,Auto,200">
17           
18                       <!-- Row 0: Movement State & Tracking Status -->
19  ❌ 0                 <Grid Grid.Row="0" ColumnDefinitions="*,Auto" Margin="0,0,0,8">
20                           <!-- Movement State -->
21  ❌ 0                     <StackPanel Grid.Column="0" Orientation="Horizontal" Spacing="8">
22                               <!-- Status Indicator Circle -->
23  ❌ 0                         <Ellipse Width="16" Height="16"
24  ❌ 0                                  Fill="{Binding MovementStateColor}"
25                                        VerticalAlignment="Center"/>
26           
27                               <!-- Movement State Text -->
28  ❌ 0                         <TextBlock Text="{Binding MovementStateText}"
29                                          FontSize="16"
30  ❌ 0                                    FontWeight="SemiBold"
31                                          VerticalAlignment="Center"/>
32                           </StackPanel>
33           
34                           <!-- Tracking Status -->
35  ❌ 0                     <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="6">
36  ❌ 0                         <Ellipse Width="10" Height="10"
37  ❌ 0                                  Fill="{Binding TrackingStatusColor}"
38                                        VerticalAlignment="Center"/>
39  ❌ 0                         <TextBlock Text="{Binding TrackingStatusText}"
40                                          FontSize="12"
41  ❌ 0                                    Foreground="#6C757D"
42                                          VerticalAlignment="Center"/>
43                           </StackPanel>
44                       </Grid>
45           
46                       <!-- Row 1: Speed -->
47  ❌ 0                 <StackPanel Grid.Row="1" Orientation="Horizontal" Spacing="6" Margin="0,0,0,6">
48  ❌ 0                     <TextBlock Text="Speed:"
49                                      FontSize="13"
50  ❌ 0                                FontWeight="Medium"
51                                      Foreground="#495057"/>
52  ❌ 0                     <TextBlock Text="{Binding SpeedText}"
53                                      FontSize="13"
54  ❌ 0                                Foreground="#212529"/>
55                       </StackPanel>
56           
57                       <!-- Row 2: Coordinates -->
58  ❌ 0                 <StackPanel Grid.Row="2" Orientation="Horizontal" Spacing="6" Margin="0,0,0,6">
59  ❌ 0                     <TextBlock Text="Location:"
60                                      FontSize="13"
61  ❌ 0                                FontWeight="Medium"
62                                      Foreground="#495057"/>
63  ❌ 0                     <TextBlock Text="{Binding CoordinatesText}"
64                                      FontSize="13"
65  ❌ 0                                FontFamily="Consolas"
66                                      Foreground="#212529"/>
67                       </StackPanel>
68           
69                       <!-- Row 3: Address -->
70  ❌ 0                 <StackPanel Grid.Row="3"
71                                   Orientation="Horizontal"
72  ❌ 0                             Spacing="6"
73                                   Margin="0,0,0,8">
74  ❌ 0                     <TextBlock Text="Address:"
75                                      FontSize="13"
76  ❌ 0                                FontWeight="Medium"
77                                      Foreground="#495057"/>
78  ❌ 0                     <TextBlock Text="{Binding DisplayAddress}"
79                                      FontSize="13"
80  ❌ 0                                Foreground="#212529"
81                                      TextWrapping="Wrap"
82  ❌ 0                                MaxWidth="600"/>
83                       </StackPanel>
84           
85                       <!-- Row 4: Map -->
86  ❌ 0                 <Border Grid.Row="4"
87                               BorderBrush="#E0E0E0"
88  ❌ 0                         BorderThickness="1"
89                               CornerRadius="4"
90  ❌ 0                         Background="#FFFFFF">
91  ❌ 0                     <mapsui:MapControl x:Name="LocationMap"
92                                              Height="200"
93  ❌ 0                                        HorizontalAlignment="Stretch"
94                                              VerticalAlignment="Stretch" />
95                       </Border>
96                   </Grid>
97               </Border>
98           </UserControl>
```
### E:\github\FunWasHad\src\FWH.Mobile\FWH.Mobile\Views\MovementStateControl.axaml.cs
```
 1           using Avalonia.Controls;
 2           using FWH.Mobile.ViewModels;
 3           using Mapsui;
 4           using Mapsui.Projections;
 5           using Mapsui.Tiling;
 6           using Mapsui.UI.Avalonia;
 7           using System;
 8           
 9           namespace FWH.Mobile.Views;
10           
11           /// <summary>
12           /// UserControl that displays real-time movement state information.
13           /// Shows current movement state, speed, location, and tracking status.
14           /// Includes a native map control showing the device location.
15           /// </summary>
16           public partial class MovementStateControl : UserControl
17           {
18               private MovementStateViewModel? _viewModel;
19           
20  ❌ 0         public MovementStateControl()
21  ❌ 0         {
22  ❌ 0             InitializeComponent();
23  ❌ 0             InitializeMap();
24  ❌ 0             DataContextChanged += OnDataContextChanged;
25  ❌ 0         }
26           
27               private void OnDataContextChanged(object? sender, EventArgs e)
28  ❌ 0         {
29  ❌ 0  ○          if (DataContext is MovementStateViewModel viewModel)
30  ❌ 0             {
31                       // Unsubscribe from previous view model
32  ❌ 0  ○              if (_viewModel != null)
33  ❌ 0                 {
34  ❌ 0                     _viewModel.PropertyChanged -= OnViewModelPropertyChanged;
35  ❌ 0                 }
36           
37  ❌ 0                 _viewModel = viewModel;
38  ❌ 0                 viewModel.PropertyChanged += OnViewModelPropertyChanged;
39           
40                       // Update map with initial location
41  ❌ 0                 UpdateMapLocation();
42  ❌ 0             }
43  ❌ 0         }
44           
45               private void OnViewModelPropertyChanged(object? sender, System.ComponentModel.PropertyChangedEventArgs e)
46  ❌ 0         {
47  ❌ 0  ○          if (e.PropertyName == nameof(MovementStateViewModel.Latitude) ||
48  ❌ 0                 e.PropertyName == nameof(MovementStateViewModel.Longitude))
49  ❌ 0             {
50  ❌ 0                 UpdateMapLocation();
51  ❌ 0             }
52  ❌ 0         }
53           
54               private void InitializeMap()
55  ❌ 0         {
56  ❌ 0  ○          if (LocationMap?.Map == null)
57  ❌ 0                 return;
58           
59                   // Add OpenStreetMap tile layer
60  ❌ 0             LocationMap.Map.Layers.Add(OpenStreetMap.CreateTileLayer());
61           
62                   // Set initial view (Mapsui 5: use Navigator.CenterOnAndZoomTo)
63  ❌ 0             var resolutions = LocationMap.Map.Navigator.Resolutions;
64  ❌ 0  ○          if (resolutions.Count > 9)
65  ❌ 0                 LocationMap.Map.Navigator.CenterOnAndZoomTo(new MPoint(0, 0), resolutions[9]);
66  ❌ 0         }
67           
68               private void UpdateMapLocation()
69  ❌ 0         {
70  ❌ 0  ○          if (LocationMap?.Map == null || _viewModel == null)
71  ❌ 0                 return;
72           
73  ❌ 0  ○          if (!_viewModel.Latitude.HasValue || !_viewModel.Longitude.HasValue)
74  ❌ 0                 return;
75           
76  ❌ 0             var lat = _viewModel.Latitude.Value;
77  ❌ 0             var lon = _viewModel.Longitude.Value;
78           
79                   // Convert WGS84 (lat/lon) to Web Mercator (used by maps)
80  ❌ 0             var (x, y) = SphericalMercator.FromLonLat(lon, lat);
81           
82                   // Center map on location (Mapsui 5: use Navigator.CenterOnAndZoomTo)
83                   // TODO: Restore device marker when Mapsui 5 MemoryLayer API is confirmed
84  ❌ 0             var resolutions = LocationMap.Map.Navigator.Resolutions;
85  ❌ 0  ○          if (resolutions.Count > 15)
86  ❌ 0                 LocationMap.Map.Navigator.CenterOnAndZoomTo(new MPoint(x, y), resolutions[15]);
87  ❌ 0             LocationMap.Refresh();
88  ❌ 0         }
89           }
```
# FWH.Mobile.Views.PlacesView

## Summary

|||
|:---|:---|
| Class: | FWH.Mobile.Views.PlacesView |
| Assembly: | FWH.Mobile |
| **File(s):** | E:\github\FunWasHad\src\FWH.Mobile\FWH.Mobile\Views\PlacesView.axaml<br />E:\github\FunWasHad\src\FWH.Mobile\FWH.Mobile\Views\PlacesView.axaml.cs |
| **Line coverage:** | 0% (0 of 108) |
| Covered lines: | 0 |
| Uncovered lines: | 108 |
| Coverable lines: | 108 |
| Total lines: | 206 |
| **Branch coverage:** | 0% (0 of 4) |
| Covered branches: | 0 |
| Total branches: | 4 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **!XamlIlPopulate(...)** | 0% | 20 | 4 | 0% |
| **.ctor()** | 100% | 2 | 1 | 0% |
| **Build_4(...)** | 100% | 2 | 1 | 0% |

## File(s)

### E:\github\FunWasHad\src\FWH.Mobile\FWH.Mobile\Views\PlacesView.axaml
```
  1  ❌ 0  ○  <UserControl xmlns="https://github.com/avaloniaui"
  2                        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
  3                        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
  4                        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
  5                        xmlns:vm="using:FWH.Mobile.ViewModels"
  6                        xmlns:local="using:FWH.Mobile.Views"
  7                        mc:Ignorable="d" d:DesignWidth="800" d:DesignHeight="450"
  8                        x:Class="FWH.Mobile.Views.PlacesView"
  9                        x:DataType="vm:PlacesViewModel">
 10               <UserControl.Resources>
 11  ❌ 0             <local:UrlToImageConverter x:Key="UrlToImageConverter" />
 12  ❌ 0             <local:FavoriteTooltipConverter x:Key="FavoriteTooltipConverter" />
 13  ❌ 0             <local:FavoriteIconConverter x:Key="FavoriteIconConverter" />
 14               </UserControl.Resources>
 15  ❌ 0         <Grid>
 16                   <Grid.RowDefinitions>
 17  ❌ 0                 <RowDefinition Height="Auto" />
 18  ❌ 0                 <RowDefinition Height="*" />
 19                   </Grid.RowDefinitions>
 20           
 21                   <!-- Header -->
 22  ❌ 0             <Border Grid.Row="0"
 23                           Background="#F8F9FA"
 24  ❌ 0                     BorderBrush="#E0E0E0"
 25                           BorderThickness="0,0,0,1"
 26  ❌ 0                     Padding="16">
 27  ❌ 0                 <Grid ColumnDefinitions="*,Auto">
 28  ❌ 0                     <TextBlock Grid.Column="0"
 29  ❌ 0                                Text="Places"
 30                                      FontSize="24"
 31  ❌ 0                                FontWeight="Bold"
 32                                      VerticalAlignment="Center" />
 33  ❌ 0                     <ComboBox Grid.Column="1"
 34  ❌ 0                               ItemsSource="{Binding FilterModes}"
 35  ❌ 0                               SelectedItem="{Binding FilterMode}"
 36                                     MinWidth="120"
 37  ❌ 0                               VerticalAlignment="Center" />
 38                       </Grid>
 39                   </Border>
 40           
 41                   <!-- Places List -->
 42  ❌ 0             <ScrollViewer Grid.Row="1"
 43                                 VerticalScrollBarVisibility="Auto">
 44  ❌ 0                 <ItemsControl ItemsSource="{Binding Places}"
 45                                     Margin="8">
 46                           <ItemsControl.ItemTemplate>
 47  ❌ 0                         <DataTemplate DataType="vm:PlaceItem">
 48  ❌ 0                             <Border Background="White"
 49                                           BorderBrush="#E0E0E0"
 50  ❌ 0                                     BorderThickness="0,0,0,1"
 51                                           Padding="16,12"
 52  ❌ 0                                     Margin="0,0,0,4">
 53  ❌ 0                                 <Grid ColumnDefinitions="Auto,*,Auto,Auto">
 54                                           <!-- Logo or Icon/Emoji -->
 55  ❌ 0                                     <Border Grid.Column="0"
 56                                                   Width="48"
 57  ❌ 0                                             Height="48"
 58                                                   CornerRadius="4"
 59  ❌ 0                                             Background="#F0F0F0"
 60                                                   VerticalAlignment="Center"
 61  ❌ 0                                             Margin="0,0,16,0">
 62  ❌ 0                                         <Grid>
 63  ❌ 0                                             <Image Source="{Binding LogoUrl, Converter={StaticResource UrlToImageConverter}}
 64                                                          Stretch="Uniform"
 65  ❌ 0                                                    IsVisible="{Binding LogoUrl, Converter={x:Static StringConverters.IsNotNu
 66  ❌ 0                                             <TextBlock Text="📍"
 67                                                              FontSize="32"
 68  ❌ 0                                                        HorizontalAlignment="Center"
 69                                                              VerticalAlignment="Center"
 70  ❌ 0                                                        IsVisible="{Binding LogoUrl, Converter={x:Static StringConverters.IsN
 71                                               </Grid>
 72                                           </Border>
 73           
 74                                           <!-- Place Info -->
 75  ❌ 0                                     <StackPanel Grid.Column="1"
 76                                                       Spacing="4">
 77                                               <!-- Business Name or Address -->
 78  ❌ 0                                         <TextBlock Text="{Binding DisplayName}"
 79                                                          FontSize="18"
 80  ❌ 0                                                    FontWeight="SemiBold"
 81                                                          TextWrapping="Wrap" />
 82           
 83                                               <!-- City -->
 84  ❌ 0                                         <TextBlock Text="{Binding City}"
 85                                                          FontSize="14"
 86  ❌ 0                                                    Foreground="#666666"
 87                                                          TextWrapping="Wrap"
 88  ❌ 0                                                    IsVisible="{Binding City, Converter={x:Static StringConverters.IsNotNullO
 89           
 90                                               <!-- Date and Time Visited (Local Time) -->
 91  ❌ 0                                         <TextBlock FontSize="12"
 92                                                          Foreground="#999999"
 93  ❌ 0                                                    Margin="0,4,0,0">
 94                                                   <TextBlock.Text>
 95  ❌ 0                                                 <MultiBinding StringFormat="{}{0:g}">
 96  ❌ 0                                                     <Binding Path="LocalTime" />
 97                                                       </MultiBinding>
 98                                                   </TextBlock.Text>
 99                                               </TextBlock>
100                                           </StackPanel>
101           
102                                           <!-- Favorite Button -->
103  ❌ 0                                     <Button Grid.Column="2"
104  ❌ 0                                             Command="{Binding $parent[ItemsControl].DataContext.ToggleFavoriteCommand}"
105  ❌ 0                                             CommandParameter="{Binding}"
106                                                   Padding="8"
107  ❌ 0                                             MinWidth="40"
108                                                   MinHeight="40"
109  ❌ 0                                             Margin="8,0,0,0"
110  ❌ 0                                             ToolTip.Tip="{Binding IsFavorite, Converter={StaticResource FavoriteTooltipConve
111  ❌ 0                                         <TextBlock FontSize="18"
112  ❌ 0                                                    Text="{Binding IsFavorite, Converter={StaticResource FavoriteIconConverte
113                                           </Button>
114           
115                                           <!-- Delete Button -->
116  ❌ 0                                     <Button Grid.Column="3"
117  ❌ 0                                             Command="{Binding $parent[ItemsControl].DataContext.DeletePlaceCommand}"
118  ❌ 0                                             CommandParameter="{Binding}"
119                                                   Padding="8"
120  ❌ 0                                             MinWidth="40"
121                                                   MinHeight="40"
122  ❌ 0                                             Margin="8,0,0,0"
123  ❌ 0                                             ToolTip.Tip="Delete place">
124  ❌ 0                                         <TextBlock Text="✕" FontSize="18" />
125                                           </Button>
126                                       </Grid>
127                                   </Border>
128                               </DataTemplate>
129                           </ItemsControl.ItemTemplate>
130                       </ItemsControl>
131                   </ScrollViewer>
132           
133                   <!-- Loading Indicator -->
134  ❌ 0             <TextBlock Grid.Row="1"
135  ❌ 0                        Text="Loading places..."
136                              FontSize="16"
137  ❌ 0                        Foreground="#999999"
138                              HorizontalAlignment="Center"
139  ❌ 0                        VerticalAlignment="Center"
140  ❌ 0                        IsVisible="{Binding IsLoading}" />
141           
142                   <!-- Empty State -->
143  ❌ 0             <TextBlock Grid.Row="1"
144  ❌ 0                        Text="No places yet. Places will appear here when you become stationary at a location."
145                              FontSize="16"
146  ❌ 0                        Foreground="#999999"
147                              HorizontalAlignment="Center"
148  ❌ 0                        VerticalAlignment="Center"
149                              TextWrapping="Wrap"
150  ❌ 0                        Margin="32"
151  ❌ 0                        IsVisible="{Binding IsEmpty}" />
152               </Grid>
153           </UserControl>
```
### E:\github\FunWasHad\src\FWH.Mobile\FWH.Mobile\Views\PlacesView.axaml.cs
```
 1           using Avalonia.Controls;
 2           using FWH.Mobile.Configuration;
 3           using FWH.Mobile.Data.Data;
 4           using FWH.Mobile.Services;
 5           using FWH.Mobile.ViewModels;
 6           using Microsoft.EntityFrameworkCore;
 7           using Microsoft.Extensions.DependencyInjection;
 8           using Microsoft.Extensions.Logging;
 9           using System.Linq;
10           
11           namespace FWH.Mobile.Views;
12           
13           public partial class PlacesView : UserControl
14           {
15  ❌ 0         public PlacesView()
16  ❌ 0         {
17  ❌ 0             InitializeComponent();
18           
19  ❌ 0             Loaded += async (_, _) =>
20  ❌ 0             {
21  ❌ 0                 var dbContext = App.ServiceProvider.GetRequiredService<NotesDbContext>();
22  ❌ 0                 var logger = App.ServiceProvider.GetRequiredService<ILogger<PlacesViewModel>>();
23  ❌ 0     
24  ❌ 0                 // Get device ID from LocationTrackingService (it generates one per instance)
25  ❌ 0                 // We'll use the most recent device ID from the database as a fallback
26  ❌ 0                 var locationTrackingService = App.ServiceProvider.GetRequiredService<ILocationTrackingService>();
27  ❌ 0                 string deviceId;
28  ❌ 0     
29  ❌ 0                 // Try to get device ID from existing location records
30  ❌ 0                 try
31  ❌ 0                 {
32  ❌ 0                     var recentLocation = await dbContext.DeviceLocationHistory
33  ❌ 0                         .OrderByDescending(l => l.Timestamp)
34  ❌ 0                         .FirstOrDefaultAsync();
35  ❌ 0     
36  ❌ 0                     deviceId = recentLocation?.DeviceId ?? "default-device";
37  ❌ 0                 }
38  ❌ 0                 catch
39  ❌ 0                 {
40  ❌ 0                     deviceId = "default-device";
41  ❌ 0                 }
42  ❌ 0     
43  ❌ 0                 var imageService = App.ServiceProvider.GetService<IImageService>();
44  ❌ 0                 var httpClientFactory = App.ServiceProvider.GetService<System.Net.Http.IHttpClientFactory>();
45  ❌ 0                 var apiSettings = App.ServiceProvider.GetService<ApiSettings>();
46  ❌ 0                 var viewModel = new PlacesViewModel(dbContext, logger, deviceId, imageService, httpClientFactory, apiSetting
47  ❌ 0                 DataContext = viewModel;
48  ❌ 0     
49  ❌ 0                 // Refresh places when view becomes visible
50  ❌ 0                 await viewModel.LoadPlacesAsync();
51  ❌ 0             };
52  ❌ 0         }
53           }
```
# FWH.Mobile.Views.SettingsView

## Summary

|||
|:---|:---|
| Class: | FWH.Mobile.Views.SettingsView |
| Assembly: | FWH.Mobile |
| **File(s):** | E:\github\FunWasHad\src\FWH.Mobile\FWH.Mobile\Views\SettingsView.axaml<br />E:\github\FunWasHad\src\FWH.Mobile\FWH.Mobile\Views\SettingsView.axaml.cs |
| **Line coverage:** | 0% (0 of 6) |
| Covered lines: | 0 |
| Uncovered lines: | 6 |
| Coverable lines: | 6 |
| Total lines: | 19 |
| **Branch coverage:** | 0% (0 of 2) |
| Covered branches: | 0 |
| Total branches: | 2 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **!XamlIlPopulate(...)** | 0% | 6 | 2 | 0% |
| **.ctor()** | 100% | 2 | 1 | 0% |

## File(s)

### E:\github\FunWasHad\src\FWH.Mobile\FWH.Mobile\Views\SettingsView.axaml
```
1  ❌ 0  ○  <UserControl xmlns="https://github.com/avaloniaui"
2                        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
3                        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
4                        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
5                        mc:Ignorable="d" d:DesignWidth="800" d:DesignHeight="450"
6                        x:Class="FWH.Mobile.Views.SettingsView">
7  ❌ 0         <TextBlock Text="Settings" HorizontalAlignment="Center" VerticalAlignment="Center" FontSize="18" />
8           </UserControl>
```
### E:\github\FunWasHad\src\FWH.Mobile\FWH.Mobile\Views\SettingsView.axaml.cs
```
 1           using Avalonia.Controls;
 2           
 3           namespace FWH.Mobile.Views;
 4           
 5           public partial class SettingsView : UserControl
 6           {
 7  ❌ 0         public SettingsView()
 8  ❌ 0         {
 9  ❌ 0             InitializeComponent();
10  ❌ 0         }
11           }
```
# FWH.Mobile.Views.UrlToImageConverter

## Summary

|||
|:---|:---|
| Class: | FWH.Mobile.Views.UrlToImageConverter |
| Assembly: | FWH.Mobile |
| **File(s):** | E:\github\FunWasHad\src\FWH.Mobile\FWH.Mobile\Views\FavoriteIconConverter.cs |
| **Line coverage:** | 0% (0 of 68) |
| Covered lines: | 0 |
| Uncovered lines: | 68 |
| Coverable lines: | 68 |
| Total lines: | 151 |
| **Branch coverage:** | 0% (0 of 12) |
| Covered branches: | 0 |
| Total branches: | 12 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **.cctor()** | 100% | 2 | 1 | 0% |
| **Convert(...)** | 0% | 156 | 12 | 0% |
| **LoadImageDirectly(...)** | 100% | 2 | 1 | 0% |
| **ConvertBack(...)** | 100% | 2 | 1 | 0% |

## File(s)

### E:\github\FunWasHad\src\FWH.Mobile\FWH.Mobile\Views\FavoriteIconConverter.cs
```
  1           using System;
  2           using System.Collections.Generic;
  3           using System.Globalization;
  4           using System.IO;
  5           using System.Net.Http;
  6           using System.Threading.Tasks;
  7           using Avalonia.Data.Converters;
  8           using Avalonia.Media.Imaging;
  9           using FWH.Mobile.Services;
 10           using Microsoft.Extensions.DependencyInjection;
 11           
 12           namespace FWH.Mobile.Views;
 13           
 14           /// <summary>
 15           /// Converter to display star icon based on favorite status.
 16           /// </summary>
 17           public class FavoriteIconConverter : IValueConverter
 18           {
 19               public object? Convert(object? value, Type targetType, object? parameter, CultureInfo culture)
 20               {
 21                   if (value is bool isFavorite)
 22                   {
 23                       return isFavorite ? "⭐" : "☆";
 24                   }
 25                   return "☆";
 26               }
 27           
 28               public object? ConvertBack(object? value, Type targetType, object? parameter, CultureInfo culture)
 29               {
 30                   throw new NotImplementedException();
 31               }
 32           }
 33           
 34           /// <summary>
 35           /// Converter to display tooltip text based on favorite status.
 36           /// </summary>
 37           public class FavoriteTooltipConverter : IValueConverter
 38           {
 39               public object? Convert(object? value, Type targetType, object? parameter, CultureInfo culture)
 40               {
 41                   if (value is bool isFavorite)
 42                   {
 43                       return isFavorite ? "Remove from favorites" : "Add to favorites";
 44                   }
 45                   return "Add to favorites";
 46               }
 47           
 48               public object? ConvertBack(object? value, Type targetType, object? parameter, CultureInfo culture)
 49               {
 50                   throw new NotImplementedException();
 51               }
 52           }
 53           
 54           /// <summary>
 55           /// Converter to load images from URL strings using ImageService.
 56           /// </summary>
 57           public class UrlToImageConverter : IValueConverter
 58           {
 59  ❌ 0         private static readonly Dictionary<string, Bitmap?> _imageCache = new();
 60           
 61               public object? Convert(object? value, Type targetType, object? parameter, CultureInfo culture)
 62  ❌ 0         {
 63  ❌ 0  ○          if (value is not string url || string.IsNullOrEmpty(url))
 64  ❌ 0                 return null;
 65           
 66                   // Check cache first
 67  ❌ 0  ○          if (_imageCache.TryGetValue(url, out var cachedBitmap))
 68  ❌ 0                 return cachedBitmap;
 69           
 70                   // Get ImageService from DI
 71  ❌ 0  ○          var imageService = App.ServiceProvider?.GetService<IImageService>();
 72  ❌ 0  ○          if (imageService == null)
 73  ❌ 0             {
 74                       // Fallback to direct download if ImageService not available
 75  ❌ 0                 return LoadImageDirectly(url);
 76                   }
 77           
 78                   // Load image via ImageService (which will cache in database)
 79                   try
 80  ❌ 0             {
 81  ❌ 0                 var task = Task.Run(async () =>
 82  ❌ 0                 {
 83  ❌ 0                     try
 84  ❌ 0                     {
 85  ❌ 0                         // Extract image type from parameter if provided
 86  ❌ 0                         var imageType = parameter?.ToString() ?? "general";
 87  ❌ 0                         var imageData = await imageService.GetImageAsync(url, imageType);
 88  ❌ 0     
 89  ❌ 0                         if (imageData != null && imageData.Length > 0)
 90  ❌ 0                         {
 91  ❌ 0                             using var stream = new System.IO.MemoryStream(imageData);
 92  ❌ 0                             return new Bitmap(stream);
 93  ❌ 0                         }
 94  ❌ 0                     }
 95  ❌ 0                     catch (Exception ex)
 96  ❌ 0                     {
 97  ❌ 0                         System.Diagnostics.Debug.WriteLine($"Error loading image via ImageService: {ex.Message}");
 98  ❌ 0                     }
 99  ❌ 0                     return null;
100  ❌ 0                 });
101           
102                       // Wait for result (blocks UI thread - not ideal but works)
103  ❌ 0                 var bitmap = task.Result;
104  ❌ 0  ○              if (bitmap != null)
105  ❌ 0                 {
106  ❌ 0                     _imageCache[url] = bitmap;
107  ❌ 0                 }
108  ❌ 0                 return bitmap;
109                   }
110  ❌ 0             catch
111  ❌ 0             {
112  ❌ 0                 return null;
113                   }
114  ❌ 0         }
115           
116               private static Bitmap? LoadImageDirectly(string url)
117  ❌ 0         {
118                   try
119  ❌ 0             {
120  ❌ 0                 using var httpClient = new HttpClient();
121  ❌ 0                 var task = Task.Run(async () =>
122  ❌ 0                 {
123  ❌ 0                     try
124  ❌ 0                     {
125  ❌ 0                         var response = await httpClient.GetAsync(url);
126  ❌ 0                         if (response.IsSuccessStatusCode)
127  ❌ 0                         {
128  ❌ 0                             var stream = await response.Content.ReadAsStreamAsync();
129  ❌ 0                             return new Bitmap(stream);
130  ❌ 0                         }
131  ❌ 0                     }
132  ❌ 0                     catch
133  ❌ 0                     {
134  ❌ 0                         // Ignore errors
135  ❌ 0                     }
136  ❌ 0                     return null;
137  ❌ 0                 });
138           
139  ❌ 0                 return task.Result;
140                   }
141  ❌ 0             catch
142  ❌ 0             {
143  ❌ 0                 return null;
144                   }
145  ❌ 0         }
146           
147               public object? ConvertBack(object? value, Type targetType, object? parameter, CultureInfo culture)
148  ❌ 0         {
149  ❌ 0             throw new NotImplementedException();
150               }
151           }
```
# FWH.Mobile.Data.Data.NotesDbContext

## Summary

|||
|:---|:---|
| Class: | FWH.Mobile.Data.Data.NotesDbContext |
| Assembly: | FWH.Mobile.Data |
| **File(s):** | E:\github\FunWasHad\src\FWH.Mobile.Data\Data\NotesDbContext.cs |
| **Line coverage:** | 100% (98 of 98) |
| Covered lines: | 98 |
| Uncovered lines: | 0 |
| Coverable lines: | 98 |
| Total lines: | 136 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **get_Notes()** | 100% | 1 | 1 | 100% |
| **get_WorkflowDefinitions()** | 100% | 1 | 1 | 100% |
| **get_NodeEntities()** | 100% | 1 | 1 | 100% |
| **get_TransitionEntities()** | 100% | 1 | 1 | 100% |
| **get_StartPointEntities()** | 100% | 1 | 1 | 100% |
| **get_ConfigurationSettings()** | 100% | 1 | 1 | 100% |
| **get_DeviceLocationHistory()** | 100% | 1 | 1 | 100% |
| **get_StationaryPlaces()** | 100% | 1 | 1 | 100% |
| **get_CityMarketingInfo()** | 100% | 1 | 1 | 100% |
| **get_Images()** | 100% | 1 | 1 | 100% |
| **.ctor(...)** | 100% | 1 | 1 | 100% |
| **OnModelCreating(...)** | 100% | 1 | 1 | 100% |

## File(s)

### E:\github\FunWasHad\src\FWH.Mobile.Data\Data\NotesDbContext.cs
```
  1              using Microsoft.EntityFrameworkCore;
  2              using FWH.Mobile.Data.Models;
  3              using FWH.Mobile.Data.Entities;
  4              
  5              namespace FWH.Mobile.Data.Data;
  6              
  7              public class NotesDbContext : DbContext
  8              {
  9  ✔   244         public DbSet<Note> Notes { get; set; } = null!;
 10              
 11  ✔  1179         public DbSet<WorkflowDefinitionEntity> WorkflowDefinitions { get; set; } = null!;
 12  ✔   245         public DbSet<NodeEntity> NodeEntities { get; set; } = null!;
 13  ✔   245         public DbSet<TransitionEntity> TransitionEntities { get; set; } = null!;
 14  ✔   245         public DbSet<StartPointEntity> StartPointEntities { get; set; } = null!;
 15              
 16  ✔   242         public DbSet<ConfigurationSetting> ConfigurationSettings { get; set; } = null!;
 17              
 18                  /// <summary>
 19                  /// Device location history - tracked locally, never sent to API
 20                  /// TR-MOBILE-001: Local-only device location tracking
 21                  /// </summary>
 22  ✔   259         public DbSet<DeviceLocationEntity> DeviceLocationHistory { get; set; } = null!;
 23              
 24                  /// <summary>
 25                  /// Places where the user became stationary - stores business information when available
 26                  /// </summary>
 27  ✔   242         public DbSet<StationaryPlaceEntity> StationaryPlaces { get; set; } = null!;
 28              
 29                  /// <summary>
 30                  /// Cached city marketing information
 31                  /// </summary>
 32  ✔   242         public DbSet<CityMarketingInfoEntity> CityMarketingInfo { get; set; } = null!;
 33              
 34                  /// <summary>
 35                  /// Stored images and logos
 36                  /// </summary>
 37  ✔   242         public DbSet<ImageEntity> Images { get; set; } = null!;
 38              
 39  ✔   363         public NotesDbContext(DbContextOptions<NotesDbContext> options) : base(options) { }
 40              
 41                  protected override void OnModelCreating(ModelBuilder modelBuilder)
 42  ✔     4         {
 43  ✔     4             modelBuilder.Entity<Note>(b =>
 44  ✔     4             {
 45  ✔     4                 b.HasKey(n => n.Id);
 46  ✔     4                 b.Property(n => n.Title).IsRequired();
 47  ✔     4                 b.Property(n => n.Content).IsRequired();
 48  ✔     4                 b.Property(n => n.CreatedAt).IsRequired();
 49  ✔     8             });
 50              
 51  ✔     4             modelBuilder.Entity<WorkflowDefinitionEntity>(b =>
 52  ✔     4             {
 53  ✔     4                 b.HasKey(w => w.Id);
 54  ✔     4                 b.Property(w => w.Name).IsRequired();
 55  ✔     4                 b.Property(w => w.CreatedAt).IsRequired();
 56  ✔     4                 b.HasMany(w => w.Nodes).WithOne(n => n.WorkflowDefinition).HasForeignKey(n => n.WorkflowDefinitionEntityId).
 57  ✔     4                 b.HasMany(w => w.Transitions).WithOne(t => t.WorkflowDefinition).HasForeignKey(t => t.WorkflowDefinitionEnti
 58  ✔     4                 b.HasMany(w => w.StartPoints).WithOne(s => s.WorkflowDefinition).HasForeignKey(s => s.WorkflowDefinitionEnti
 59  ✔     8             });
 60              
 61  ✔     4             modelBuilder.Entity<NodeEntity>(b =>
 62  ✔     4             {
 63  ✔     4                 b.HasKey(n => n.Id);
 64  ✔     4                 b.Property(n => n.NodeId).IsRequired();
 65  ✔     4                 b.Property(n => n.Text).IsRequired();
 66  ✔     8             });
 67              
 68  ✔     4             modelBuilder.Entity<TransitionEntity>(b =>
 69  ✔     4             {
 70  ✔     4                 b.HasKey(t => t.Id);
 71  ✔     4                 b.Property(t => t.FromNodeId).IsRequired();
 72  ✔     4                 b.Property(t => t.ToNodeId).IsRequired();
 73  ✔     8             });
 74              
 75  ✔     4             modelBuilder.Entity<StartPointEntity>(b =>
 76  ✔     4             {
 77  ✔     4                 b.HasKey(s => s.Id);
 78  ✔     8             });
 79              
 80  ✔     4             modelBuilder.Entity<ConfigurationSetting>(b =>
 81  ✔     4             {
 82  ✔     4                 b.HasKey(c => c.Key);
 83  ✔     4                 b.Property(c => c.Key).IsRequired().HasMaxLength(200);
 84  ✔     4                 b.Property(c => c.Value).IsRequired();
 85  ✔     4                 b.Property(c => c.ValueType).IsRequired().HasMaxLength(50);
 86  ✔     4                 b.Property(c => c.Category).HasMaxLength(100);
 87  ✔     4                 b.Property(c => c.Description).HasMaxLength(500);
 88  ✔     4                 b.Property(c => c.UpdatedAt).IsRequired();
 89  ✔     4                 b.HasIndex(c => c.Category);
 90  ✔     8             });
 91              
 92  ✔     4             modelBuilder.Entity<DeviceLocationEntity>(b =>
 93  ✔     4             {
 94  ✔     4                 b.HasKey(l => l.Id);
 95  ✔     4                 b.Property(l => l.DeviceId).IsRequired().HasMaxLength(100);
 96  ✔     4                 b.Property(l => l.Latitude).IsRequired();
 97  ✔     4                 b.Property(l => l.Longitude).IsRequired();
 98  ✔     4                 b.Property(l => l.MovementState).IsRequired().HasMaxLength(20);
 99  ✔     4                 b.Property(l => l.Timestamp).IsRequired();
100  ✔     4                 b.Property(l => l.CreatedAt).IsRequired();
101  ✔     4                 b.Property(l => l.Address).HasMaxLength(500);
102  ✔     4     
103  ✔     4                 // Indexes for efficient querying
104  ✔     4                 b.HasIndex(l => l.DeviceId);
105  ✔     4                 b.HasIndex(l => l.Timestamp);
106  ✔     4                 b.HasIndex(l => new { l.DeviceId, l.Timestamp });
107  ✔     8             });
108              
109  ✔     4             modelBuilder.Entity<StationaryPlaceEntity>(b =>
110  ✔     4             {
111  ✔     4                 b.HasKey(p => p.Id);
112  ✔     4                 b.Property(p => p.DeviceId).IsRequired().HasMaxLength(100);
113  ✔     4                 b.Property(p => p.Latitude).IsRequired();
114  ✔     4                 b.Property(p => p.Longitude).IsRequired();
115  ✔     4                 b.Property(p => p.StationaryAt).IsRequired();
116  ✔     4                 b.Property(p => p.CreatedAt).IsRequired();
117  ✔     4                 b.Property(p => p.BusinessName).HasMaxLength(200);
118  ✔     4                 b.Property(p => p.Address).HasMaxLength(500);
119  ✔     4                 b.Property(p => p.Category).HasMaxLength(100);
120  ✔     4                 b.Property(p => p.IsFavorite).IsRequired().HasDefaultValue(false);
121  ✔     4                 b.Property(p => p.LogoUrl).HasMaxLength(500);
122  ✔     4                 b.Property(p => p.PrimaryColor).HasMaxLength(20);
123  ✔     4                 b.Property(p => p.SecondaryColor).HasMaxLength(20);
124  ✔     4                 b.Property(p => p.AccentColor).HasMaxLength(20);
125  ✔     4                 b.Property(p => p.BackgroundColor).HasMaxLength(20);
126  ✔     4                 b.Property(p => p.TextColor).HasMaxLength(20);
127  ✔     4                 b.Property(p => p.BackgroundImageUrl).HasMaxLength(500);
128  ✔     4     
129  ✔     4                 // Indexes for efficient querying (reverse chronological)
130  ✔     4                 b.HasIndex(p => p.DeviceId);
131  ✔     4                 b.HasIndex(p => p.StationaryAt).IsDescending();
132  ✔     4                 b.HasIndex(p => new { p.DeviceId, p.StationaryAt }).IsDescending();
133  ✔     4                 b.HasIndex(p => new { p.DeviceId, p.IsFavorite });
134  ✔     8             });
135  ✔     4         }
136              }
```
# FWH.Mobile.Data.DependencyInjection.ServiceCollectionExtensions

## Summary

|||
|:---|:---|
| Class: | FWH.Mobile.Data.DependencyInjection.ServiceCollectionExtensions |
| Assembly: | FWH.Mobile.Data |
| **File(s):** | E:\github\FunWasHad\src\FWH.Mobile.Data\DependencyInjection\ServiceCollectionExtensions.cs |
| **Line coverage:** | 0% (0 of 9) |
| Covered lines: | 0 |
| Uncovered lines: | 9 |
| Coverable lines: | 9 |
| Total lines: | 22 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **AddMobileData(...)** | 100% | 2 | 1 | 0% |

## File(s)

### E:\github\FunWasHad\src\FWH.Mobile.Data\DependencyInjection\ServiceCollectionExtensions.cs
```
 1           using Microsoft.EntityFrameworkCore;
 2           using Microsoft.Extensions.DependencyInjection;
 3           using FWH.Mobile.Data.Data;
 4           using FWH.Mobile.Data.Repositories;
 5           
 6           namespace FWH.Mobile.Data.DependencyInjection;
 7           
 8           public static class ServiceCollectionExtensions
 9           {
10               public static IServiceCollection AddMobileData(this IServiceCollection services, string connectionString)
11  ❌ 0         {
12  ❌ 0             services.AddDbContext<NotesDbContext>(options => options.UseSqlite(connectionString));
13  ❌ 0             services.AddScoped<INoteRepository, EfNoteRepository>();
14  ❌ 0             services.AddScoped<IWorkflowRepository, EfWorkflowRepository>();
15           
16                   // Ensure DB created
17  ❌ 0             using var provider = services.BuildServiceProvider();
18  ❌ 0             var ctx = provider.GetRequiredService<NotesDbContext>();
19  ❌ 0             ctx.Database.EnsureCreated();
20  ❌ 0             return services;
21  ❌ 0         }
22           }
```
# FWH.Mobile.Data.Entities.CityMarketingInfoEntity

## Summary

|||
|:---|:---|
| Class: | FWH.Mobile.Data.Entities.CityMarketingInfoEntity |
| Assembly: | FWH.Mobile.Data |
| **File(s):** | E:\github\FunWasHad\src\FWH.Mobile.Data\Entities\CityMarketingInfoEntity.cs |
| **Line coverage:** | 0% (0 of 17) |
| Covered lines: | 0 |
| Uncovered lines: | 17 |
| Coverable lines: | 17 |
| Total lines: | 94 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **get_Id()** | 100% | 2 | 1 | 0% |
| **get_DeviceId()** | 100% | 2 | 1 | 0% |
| **get_CityName()** | 100% | 2 | 1 | 0% |
| **get_State()** | 100% | 2 | 1 | 0% |
| **get_Country()** | 100% | 2 | 1 | 0% |
| **get_CityId()** | 100% | 2 | 1 | 0% |
| **get_Description()** | 100% | 2 | 1 | 0% |
| **get_Website()** | 100% | 2 | 1 | 0% |
| **get_LogoUrl()** | 100% | 2 | 1 | 0% |
| **get_PrimaryColor()** | 100% | 2 | 1 | 0% |
| **get_SecondaryColor()** | 100% | 2 | 1 | 0% |
| **get_AccentColor()** | 100% | 2 | 1 | 0% |
| **get_BackgroundColor()** | 100% | 2 | 1 | 0% |
| **get_TextColor()** | 100% | 2 | 1 | 0% |
| **get_BackgroundImageUrl()** | 100% | 2 | 1 | 0% |
| **get_CreatedAt()** | 100% | 2 | 1 | 0% |
| **get_MarketingInfoCachedAt()** | 100% | 2 | 1 | 0% |

## File(s)

### E:\github\FunWasHad\src\FWH.Mobile.Data\Entities\CityMarketingInfoEntity.cs
```
 1           using System;
 2           
 3           namespace FWH.Mobile.Data.Entities;
 4           
 5           /// <summary>
 6           /// Entity for caching city marketing information locally.
 7           /// </summary>
 8           public class CityMarketingInfoEntity
 9           {
10               /// <summary>
11               /// Primary key for the city marketing info record
12               /// </summary>
13  ❌ 0         public long Id { get; set; }
14           
15               /// <summary>
16               /// Device identifier (generated GUID)
17               /// </summary>
18  ❌ 0         public string DeviceId { get; set; } = string.Empty;
19           
20               /// <summary>
21               /// City name
22               /// </summary>
23  ❌ 0         public string CityName { get; set; } = string.Empty;
24           
25               /// <summary>
26               /// State or province
27               /// </summary>
28  ❌ 0         public string? State { get; set; }
29           
30               /// <summary>
31               /// Country
32               /// </summary>
33  ❌ 0         public string? Country { get; set; }
34           
35               /// <summary>
36               /// City ID from marketing API (if registered)
37               /// </summary>
38  ❌ 0         public long? CityId { get; set; }
39           
40               /// <summary>
41               /// City description
42               /// </summary>
43  ❌ 0         public string? Description { get; set; }
44           
45               /// <summary>
46               /// City website
47               /// </summary>
48  ❌ 0         public string? Website { get; set; }
49           
50               /// <summary>
51               /// City logo URL from marketing API theme
52               /// </summary>
53  ❌ 0         public string? LogoUrl { get; set; }
54           
55               /// <summary>
56               /// Primary color from city theme
57               /// </summary>
58  ❌ 0         public string? PrimaryColor { get; set; }
59           
60               /// <summary>
61               /// Secondary color from city theme
62               /// </summary>
63  ❌ 0         public string? SecondaryColor { get; set; }
64           
65               /// <summary>
66               /// Accent color from city theme
67               /// </summary>
68  ❌ 0         public string? AccentColor { get; set; }
69           
70               /// <summary>
71               /// Background color from city theme
72               /// </summary>
73  ❌ 0         public string? BackgroundColor { get; set; }
74           
75               /// <summary>
76               /// Text color from city theme
77               /// </summary>
78  ❌ 0         public string? TextColor { get; set; }
79           
80               /// <summary>
81               /// Background image URL from city theme
82               /// </summary>
83  ❌ 0         public string? BackgroundImageUrl { get; set; }
84           
85               /// <summary>
86               /// When this record was created in the database
87               /// </summary>
88  ❌ 0         public DateTimeOffset CreatedAt { get; set; } = DateTimeOffset.UtcNow;
89           
90               /// <summary>
91               /// When marketing info was last fetched and cached
92               /// </summary>
93  ❌ 0         public DateTimeOffset? MarketingInfoCachedAt { get; set; }
94           }
```
# FWH.Mobile.Data.Entities.ConfigurationSetting

## Summary

|||
|:---|:---|
| Class: | FWH.Mobile.Data.Entities.ConfigurationSetting |
| Assembly: | FWH.Mobile.Data |
| **File(s):** | E:\github\FunWasHad\src\FWH.Mobile.Data\Entities\ConfigurationSetting.cs |
| **Line coverage:** | 0% (0 of 6) |
| Covered lines: | 0 |
| Uncovered lines: | 6 |
| Coverable lines: | 6 |
| Total lines: | 37 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **get_Key()** | 100% | 2 | 1 | 0% |
| **get_Value()** | 100% | 2 | 1 | 0% |
| **get_ValueType()** | 100% | 2 | 1 | 0% |
| **get_Category()** | 100% | 2 | 1 | 0% |
| **get_Description()** | 100% | 2 | 1 | 0% |
| **get_UpdatedAt()** | 100% | 2 | 1 | 0% |

## File(s)

### E:\github\FunWasHad\src\FWH.Mobile.Data\Entities\ConfigurationSetting.cs
```
 1           namespace FWH.Mobile.Data.Entities;
 2           
 3           /// <summary>
 4           /// Represents a configuration setting stored in the database.
 5           /// </summary>
 6           public class ConfigurationSetting
 7           {
 8               /// <summary>
 9               /// The unique key for this configuration setting.
10               /// </summary>
11  ❌ 0         public string Key { get; set; } = string.Empty;
12           
13               /// <summary>
14               /// The value of the configuration setting.
15               /// </summary>
16  ❌ 0         public string Value { get; set; } = string.Empty;
17           
18               /// <summary>
19               /// The data type of the value (e.g., "int", "string", "bool").
20               /// </summary>
21  ❌ 0         public string ValueType { get; set; } = "string";
22           
23               /// <summary>
24               /// Optional category for grouping related settings.
25               /// </summary>
26  ❌ 0         public string? Category { get; set; }
27           
28               /// <summary>
29               /// Optional description of what this setting controls.
30               /// </summary>
31  ❌ 0         public string? Description { get; set; }
32           
33               /// <summary>
34               /// When this setting was last updated.
35               /// </summary>
36  ❌ 0         public DateTime UpdatedAt { get; set; } = DateTime.UtcNow;
37           }
```
# FWH.Mobile.Data.Entities.DeviceLocationEntity

## Summary

|||
|:---|:---|
| Class: | FWH.Mobile.Data.Entities.DeviceLocationEntity |
| Assembly: | FWH.Mobile.Data |
| **File(s):** | E:\github\FunWasHad\src\FWH.Mobile.Data\Entities\DeviceLocationEntity.cs |
| **Line coverage:** | 91.6% (11 of 12) |
| Covered lines: | 11 |
| Uncovered lines: | 1 |
| Coverable lines: | 12 |
| Total lines: | 71 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **get_Id()** | 100% | 1 | 1 | 100% |
| **get_DeviceId()** | 100% | 1 | 1 | 100% |
| **get_Latitude()** | 100% | 1 | 1 | 100% |
| **get_Longitude()** | 100% | 1 | 1 | 100% |
| **get_AccuracyMeters()** | 100% | 1 | 1 | 100% |
| **get_AltitudeMeters()** | 100% | 1 | 1 | 100% |
| **get_SpeedMetersPerSecond()** | 100% | 1 | 1 | 100% |
| **get_HeadingDegrees()** | 100% | 1 | 1 | 100% |
| **get_MovementState()** | 100% | 1 | 1 | 100% |
| **get_Timestamp()** | 100% | 1 | 1 | 100% |
| **get_Address()** | 100% | 2 | 1 | 0% |
| **get_CreatedAt()** | 100% | 1 | 1 | 100% |

## File(s)

### E:\github\FunWasHad\src\FWH.Mobile.Data\Entities\DeviceLocationEntity.cs
```
 1            using System;
 2            
 3            namespace FWH.Mobile.Data.Entities;
 4            
 5            /// <summary>
 6            /// Entity for storing device location history in local SQLite database.
 7            /// Device location is tracked locally and NEVER sent to the API.
 8            /// TR-MOBILE-001: Local-only device location tracking
 9            /// </summary>
10            public class DeviceLocationEntity
11            {
12                /// <summary>
13                /// Primary key for the location record
14                /// </summary>
15  ✔  10         public long Id { get; set; }
16            
17                /// <summary>
18                /// Device identifier (generated GUID)
19                /// </summary>
20  ✔  24         public string DeviceId { get; set; } = string.Empty;
21            
22                /// <summary>
23                /// Latitude in decimal degrees
24                /// </summary>
25  ✔  12         public double Latitude { get; set; }
26            
27                /// <summary>
28                /// Longitude in decimal degrees
29                /// </summary>
30  ✔  12         public double Longitude { get; set; }
31            
32                /// <summary>
33                /// Accuracy of the location in meters (optional)
34                /// </summary>
35  ✔  12         public double? AccuracyMeters { get; set; }
36            
37                /// <summary>
38                /// Altitude above sea level in meters (optional)
39                /// </summary>
40  ✔  12         public double? AltitudeMeters { get; set; }
41            
42                /// <summary>
43                /// Speed in meters per second (optional)
44                /// </summary>
45  ✔  11         public double? SpeedMetersPerSecond { get; set; }
46            
47                /// <summary>
48                /// Heading/bearing in degrees (0-360, optional)
49                /// </summary>
50  ✔  11         public double? HeadingDegrees { get; set; }
51            
52                /// <summary>
53                /// Movement state at time of recording (Unknown, Stationary, Walking, Riding)
54                /// </summary>
55  ✔  25         public string MovementState { get; set; } = "Unknown";
56            
57                /// <summary>
58                /// Timestamp when the location was recorded
59                /// </summary>
60  ✔  11         public DateTimeOffset Timestamp { get; set; }
61            
62                /// <summary>
63                /// Address at this location (if reverse geocoded)
64                /// </summary>
65  ❌  0         public string? Address { get; set; }
66            
67                /// <summary>
68                /// When this record was created in the database
69                /// </summary>
70  ✔  22         public DateTimeOffset CreatedAt { get; set; } = DateTimeOffset.UtcNow;
71            }
```
# FWH.Mobile.Data.Entities.ImageEntity

## Summary

|||
|:---|:---|
| Class: | FWH.Mobile.Data.Entities.ImageEntity |
| Assembly: | FWH.Mobile.Data |
| **File(s):** | E:\github\FunWasHad\src\FWH.Mobile.Data\Entities\ImageEntity.cs |
| **Line coverage:** | 0% (0 of 11) |
| Covered lines: | 0 |
| Uncovered lines: | 11 |
| Coverable lines: | 11 |
| Total lines: | 64 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **get_Id()** | 100% | 2 | 1 | 0% |
| **get_SourceUrl()** | 100% | 2 | 1 | 0% |
| **get_ImageType()** | 100% | 2 | 1 | 0% |
| **get_EntityId()** | 100% | 2 | 1 | 0% |
| **get_EntityType()** | 100% | 2 | 1 | 0% |
| **get_ImageData()** | 100% | 2 | 1 | 0% |
| **get_ContentType()** | 100% | 2 | 1 | 0% |
| **get_FileName()** | 100% | 2 | 1 | 0% |
| **get_CreatedAt()** | 100% | 2 | 1 | 0% |
| **get_LastAccessedAt()** | 100% | 2 | 1 | 0% |
| **get_FileSizeBytes()** | 100% | 2 | 1 | 0% |

## File(s)

### E:\github\FunWasHad\src\FWH.Mobile.Data\Entities\ImageEntity.cs
```
 1           using System;
 2           
 3           namespace FWH.Mobile.Data.Entities;
 4           
 5           /// <summary>
 6           /// Entity for storing images and logos in the local SQLite database.
 7           /// </summary>
 8           public class ImageEntity
 9           {
10               /// <summary>
11               /// Primary key for the image record
12               /// </summary>
13  ❌ 0         public long Id { get; set; }
14           
15               /// <summary>
16               /// Original URL where the image was retrieved from (for reference)
17               /// </summary>
18  ❌ 0         public string? SourceUrl { get; set; }
19           
20               /// <summary>
21               /// Type/category of image (e.g., "business_logo", "city_logo", "background_image", "user_upload")
22               /// </summary>
23  ❌ 0         public string ImageType { get; set; } = string.Empty;
24           
25               /// <summary>
26               /// Associated entity ID (e.g., BusinessId, CityId, PlaceId)
27               /// </summary>
28  ❌ 0         public long? EntityId { get; set; }
29           
30               /// <summary>
31               /// Entity type (e.g., "Business", "City", "Place", "User")
32               /// </summary>
33  ❌ 0         public string? EntityType { get; set; }
34           
35               /// <summary>
36               /// Image data stored as byte array
37               /// </summary>
38  ❌ 0         public byte[] ImageData { get; set; } = Array.Empty<byte>();
39           
40               /// <summary>
41               /// MIME type of the image (e.g., "image/png", "image/jpeg")
42               /// </summary>
43  ❌ 0         public string ContentType { get; set; } = "image/png";
44           
45               /// <summary>
46               /// Original filename (if available)
47               /// </summary>
48  ❌ 0         public string? FileName { get; set; }
49           
50               /// <summary>
51               /// When this record was created in the database
52               /// </summary>
53  ❌ 0         public DateTimeOffset CreatedAt { get; set; } = DateTimeOffset.UtcNow;
54           
55               /// <summary>
56               /// When this image was last accessed/used
57               /// </summary>
58  ❌ 0         public DateTimeOffset? LastAccessedAt { get; set; }
59           
60               /// <summary>
61               /// File size in bytes
62               /// </summary>
63  ❌ 0         public int FileSizeBytes { get; set; }
64           }
```
# FWH.Mobile.Data.Entities.StationaryPlaceEntity

## Summary

|||
|:---|:---|
| Class: | FWH.Mobile.Data.Entities.StationaryPlaceEntity |
| Assembly: | FWH.Mobile.Data |
| **File(s):** | E:\github\FunWasHad\src\FWH.Mobile.Data\Entities\StationaryPlaceEntity.cs |
| **Line coverage:** | 0% (0 of 19) |
| Covered lines: | 0 |
| Uncovered lines: | 19 |
| Coverable lines: | 19 |
| Total lines: | 105 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **get_Id()** | 100% | 2 | 1 | 0% |
| **get_DeviceId()** | 100% | 2 | 1 | 0% |
| **get_BusinessName()** | 100% | 2 | 1 | 0% |
| **get_Address()** | 100% | 2 | 1 | 0% |
| **get_Category()** | 100% | 2 | 1 | 0% |
| **get_Latitude()** | 100% | 2 | 1 | 0% |
| **get_Longitude()** | 100% | 2 | 1 | 0% |
| **get_StationaryAt()** | 100% | 2 | 1 | 0% |
| **get_CreatedAt()** | 100% | 2 | 1 | 0% |
| **get_IsFavorite()** | 100% | 2 | 1 | 0% |
| **get_LogoUrl()** | 100% | 2 | 1 | 0% |
| **get_PrimaryColor()** | 100% | 2 | 1 | 0% |
| **get_SecondaryColor()** | 100% | 2 | 1 | 0% |
| **get_AccentColor()** | 100% | 2 | 1 | 0% |
| **get_BackgroundColor()** | 100% | 2 | 1 | 0% |
| **get_TextColor()** | 100% | 2 | 1 | 0% |
| **get_BackgroundImageUrl()** | 100% | 2 | 1 | 0% |
| **get_BusinessId()** | 100% | 2 | 1 | 0% |
| **get_MarketingInfoCachedAt()** | 100% | 2 | 1 | 0% |

## File(s)

### E:\github\FunWasHad\src\FWH.Mobile.Data\Entities\StationaryPlaceEntity.cs
```
  1           using System;
  2           
  3           namespace FWH.Mobile.Data.Entities;
  4           
  5           /// <summary>
  6           /// Entity for storing places where the user became stationary.
  7           /// Stores business information when available.
  8           /// </summary>
  9           public class StationaryPlaceEntity
 10           {
 11               /// <summary>
 12               /// Primary key for the place record
 13               /// </summary>
 14  ❌ 0         public long Id { get; set; }
 15           
 16               /// <summary>
 17               /// Device identifier (generated GUID)
 18               /// </summary>
 19  ❌ 0         public string DeviceId { get; set; } = string.Empty;
 20           
 21               /// <summary>
 22               /// Business name (if a business was found at this location)
 23               /// </summary>
 24  ❌ 0         public string? BusinessName { get; set; }
 25           
 26               /// <summary>
 27               /// Full address of the location
 28               /// </summary>
 29  ❌ 0         public string? Address { get; set; }
 30           
 31               /// <summary>
 32               /// Business category (e.g., restaurant, cafe, shop)
 33               /// </summary>
 34  ❌ 0         public string? Category { get; set; }
 35           
 36               /// <summary>
 37               /// Latitude in decimal degrees
 38               /// </summary>
 39  ❌ 0         public double Latitude { get; set; }
 40           
 41               /// <summary>
 42               /// Longitude in decimal degrees
 43               /// </summary>
 44  ❌ 0         public double Longitude { get; set; }
 45           
 46               /// <summary>
 47               /// Timestamp when the user became stationary at this location
 48               /// </summary>
 49  ❌ 0         public DateTimeOffset StationaryAt { get; set; }
 50           
 51               /// <summary>
 52               /// When this record was created in the database
 53               /// </summary>
 54  ❌ 0         public DateTimeOffset CreatedAt { get; set; } = DateTimeOffset.UtcNow;
 55           
 56               /// <summary>
 57               /// Whether this place is marked as a favorite
 58               /// </summary>
 59  ❌ 0         public bool IsFavorite { get; set; }
 60           
 61               /// <summary>
 62               /// Business logo URL from marketing API theme
 63               /// </summary>
 64  ❌ 0         public string? LogoUrl { get; set; }
 65           
 66               /// <summary>
 67               /// Primary color from business theme
 68               /// </summary>
 69  ❌ 0         public string? PrimaryColor { get; set; }
 70           
 71               /// <summary>
 72               /// Secondary color from business theme
 73               /// </summary>
 74  ❌ 0         public string? SecondaryColor { get; set; }
 75           
 76               /// <summary>
 77               /// Accent color from business theme
 78               /// </summary>
 79  ❌ 0         public string? AccentColor { get; set; }
 80           
 81               /// <summary>
 82               /// Background color from business theme
 83               /// </summary>
 84  ❌ 0         public string? BackgroundColor { get; set; }
 85           
 86               /// <summary>
 87               /// Text color from business theme
 88               /// </summary>
 89  ❌ 0         public string? TextColor { get; set; }
 90           
 91               /// <summary>
 92               /// Background image URL from business theme
 93               /// </summary>
 94  ❌ 0         public string? BackgroundImageUrl { get; set; }
 95           
 96               /// <summary>
 97               /// Business ID from marketing API (if registered)
 98               /// </summary>
 99  ❌ 0         public long? BusinessId { get; set; }
100           
101               /// <summary>
102               /// When marketing info was last fetched and cached
103               /// </summary>
104  ❌ 0         public DateTimeOffset? MarketingInfoCachedAt { get; set; }
105           }
```
# FWH.Mobile.Data.Extensions.DataServiceCollectionExtensions

## Summary

|||
|:---|:---|
| Class: | FWH.Mobile.Data.Extensions.DataServiceCollectionExtensions |
| Assembly: | FWH.Mobile.Data |
| **File(s):** | E:\github\FunWasHad\src\FWH.Mobile.Data\Extensions\DataServiceCollectionExtensions.cs |
| **Line coverage:** | 0% (0 of 25) |
| Covered lines: | 0 |
| Uncovered lines: | 25 |
| Coverable lines: | 25 |
| Total lines: | 87 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **AddDataServices(...)** | 100% | 2 | 1 | 0% |
| **AddNotesDbContext(...)** | 100% | 2 | 1 | 0% |
| **AddRepositories(...)** | 100% | 2 | 1 | 0% |
| **AddDataServicesWithCustomDb(...)** | 100% | 2 | 1 | 0% |

## File(s)

### E:\github\FunWasHad\src\FWH.Mobile.Data\Extensions\DataServiceCollectionExtensions.cs
```
 1           using Microsoft.Extensions.DependencyInjection;
 2           using Microsoft.EntityFrameworkCore;
 3           using FWH.Mobile.Data.Data;
 4           using FWH.Mobile.Data.Repositories;
 5           using FWH.Mobile.Data.Services;
 6           
 7           namespace FWH.Mobile.Data.Extensions;
 8           
 9           /// <summary>
10           /// Extension methods for registering data services with dependency injection.
11           /// Single Responsibility: Configure DI for data and repository components.
12           /// </summary>
13           public static class DataServiceCollectionExtensions
14           {
15               /// <summary>
16               /// Adds all data services to the service collection with in-memory SQLite database.
17               /// Includes DbContext and repositories.
18               /// </summary>
19               /// <param name="services">The service collection to add services to.</param>
20               /// <param name="connectionString">The SQLite connection string. Defaults to in-memory database.</param>
21               /// <returns>The service collection for chaining.</returns>
22               public static IServiceCollection AddDataServices(
23                   this IServiceCollection services,
24                   string connectionString = "DataSource=:memory:")
25  ❌ 0         {
26                   // Register DbContext with SQLite
27  ❌ 0             services.AddDbContext<NotesDbContext>(options =>
28  ❌ 0                 options.UseSqlite(connectionString));
29           
30                   // Register repositories
31  ❌ 0             services.AddScoped<INoteRepository, EfNoteRepository>();
32  ❌ 0             services.AddScoped<IWorkflowRepository, EfWorkflowRepository>();
33  ❌ 0             services.AddScoped<IConfigurationRepository, EfConfigurationRepository>();
34           
35                   // Register migration service
36  ❌ 0             services.AddScoped<MobileDatabaseMigrationService>();
37           
38  ❌ 0             return services;
39  ❌ 0         }
40           
41               /// <summary>
42               /// Adds DbContext with the specified database provider configuration.
43               /// </summary>
44               /// <param name="services">The service collection to add services to.</param>
45               /// <param name="optionsAction">Action to configure DbContext options.</param>
46               /// <returns>The service collection for chaining.</returns>
47               public static IServiceCollection AddNotesDbContext(
48                   this IServiceCollection services,
49                   Action<DbContextOptionsBuilder> optionsAction)
50  ❌ 0         {
51  ❌ 0             services.AddDbContext<NotesDbContext>(optionsAction);
52  ❌ 0             return services;
53  ❌ 0         }
54           
55               /// <summary>
56               /// Adds repository implementations to the service collection.
57               /// Requires DbContext to be registered first.
58               /// </summary>
59               /// <param name="services">The service collection to add services to.</param>
60               /// <returns>The service collection for chaining.</returns>
61               public static IServiceCollection AddRepositories(this IServiceCollection services)
62  ❌ 0         {
63  ❌ 0             services.AddScoped<INoteRepository, EfNoteRepository>();
64  ❌ 0             services.AddScoped<IWorkflowRepository, EfWorkflowRepository>();
65  ❌ 0             services.AddScoped<IConfigurationRepository, EfConfigurationRepository>();
66           
67  ❌ 0             return services;
68  ❌ 0         }
69           
70               /// <summary>
71               /// Adds data services with a custom DbContext configuration.
72               /// Useful for testing or custom database setups.
73               /// </summary>
74               /// <param name="services">The service collection to add services to.</param>
75               /// <param name="optionsAction">Action to configure DbContext options.</param>
76               /// <returns>The service collection for chaining.</returns>
77               public static IServiceCollection AddDataServicesWithCustomDb(
78                   this IServiceCollection services,
79                   Action<DbContextOptionsBuilder> optionsAction)
80  ❌ 0         {
81  ❌ 0             services.AddNotesDbContext(optionsAction);
82  ❌ 0             services.AddRepositories();
83  ❌ 0             services.AddScoped<MobileDatabaseMigrationService>();
84           
85  ❌ 0             return services;
86  ❌ 0         }
87           }
```
# FWH.Mobile.Data.Migrations.AddDeviceLocationHistory

## Summary

|||
|:---|:---|
| Class: | FWH.Mobile.Data.Migrations.AddDeviceLocationHistory |
| Assembly: | FWH.Mobile.Data |
| **File(s):** | E:\github\FunWasHad\src\FWH.Mobile.Data\Migrations\AddDeviceLocationHistory.cs |
| **Line coverage:** | 0% (0 of 40) |
| Covered lines: | 0 |
| Uncovered lines: | 40 |
| Coverable lines: | 40 |
| Total lines: | 61 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **Up(...)** | 100% | 2 | 1 | 0% |
| **Down(...)** | 100% | 2 | 1 | 0% |

## File(s)

### E:\github\FunWasHad\src\FWH.Mobile.Data\Migrations\AddDeviceLocationHistory.cs
```
 1           using Microsoft.EntityFrameworkCore.Migrations;
 2           
 3           #nullable disable
 4           
 5           namespace FWH.Mobile.Data.Migrations;
 6           
 7           /// <summary>
 8           /// Adds DeviceLocationHistory table for local device location tracking.
 9           /// TR-MOBILE-001: Device location tracked locally, never sent to API.
10           /// </summary>
11           public partial class AddDeviceLocationHistory : Migration
12           {
13               /// <inheritdoc />
14               protected override void Up(MigrationBuilder migrationBuilder)
15  ❌ 0         {
16  ❌ 0             migrationBuilder.CreateTable(
17  ❌ 0                 name: "DeviceLocationHistory",
18  ❌ 0                 columns: table => new
19  ❌ 0                 {
20  ❌ 0                     Id = table.Column<long>(type: "INTEGER", nullable: false)
21  ❌ 0                         .Annotation("Sqlite:Autoincrement", true),
22  ❌ 0                     DeviceId = table.Column<string>(type: "TEXT", maxLength: 100, nullable: false),
23  ❌ 0                     Latitude = table.Column<double>(type: "REAL", nullable: false),
24  ❌ 0                     Longitude = table.Column<double>(type: "REAL", nullable: false),
25  ❌ 0                     AccuracyMeters = table.Column<double>(type: "REAL", nullable: true),
26  ❌ 0                     AltitudeMeters = table.Column<double>(type: "REAL", nullable: true),
27  ❌ 0                     SpeedMetersPerSecond = table.Column<double>(type: "REAL", nullable: true),
28  ❌ 0                     HeadingDegrees = table.Column<double>(type: "REAL", nullable: true),
29  ❌ 0                     MovementState = table.Column<string>(type: "TEXT", maxLength: 20, nullable: false),
30  ❌ 0                     Timestamp = table.Column<DateTimeOffset>(type: "TEXT", nullable: false),
31  ❌ 0                     Address = table.Column<string>(type: "TEXT", maxLength: 500, nullable: true),
32  ❌ 0                     CreatedAt = table.Column<DateTimeOffset>(type: "TEXT", nullable: false)
33  ❌ 0                 },
34  ❌ 0                 constraints: table =>
35  ❌ 0                 {
36  ❌ 0                     table.PrimaryKey("PK_DeviceLocationHistory", x => x.Id);
37  ❌ 0                 });
38           
39  ❌ 0             migrationBuilder.CreateIndex(
40  ❌ 0                 name: "IX_DeviceLocationHistory_DeviceId",
41  ❌ 0                 table: "DeviceLocationHistory",
42  ❌ 0                 column: "DeviceId");
43           
44  ❌ 0             migrationBuilder.CreateIndex(
45  ❌ 0                 name: "IX_DeviceLocationHistory_Timestamp",
46  ❌ 0                 table: "DeviceLocationHistory",
47  ❌ 0                 column: "Timestamp");
48           
49  ❌ 0             migrationBuilder.CreateIndex(
50  ❌ 0                 name: "IX_DeviceLocationHistory_DeviceId_Timestamp",
51  ❌ 0                 table: "DeviceLocationHistory",
52  ❌ 0                 columns: new[] { "DeviceId", "Timestamp" });
53  ❌ 0         }
54           
55               /// <inheritdoc />
56               protected override void Down(MigrationBuilder migrationBuilder)
57  ❌ 0         {
58  ❌ 0             migrationBuilder.DropTable(
59  ❌ 0                 name: "DeviceLocationHistory");
60  ❌ 0         }
61           }
```
# FWH.Mobile.Data.Migrations.AddWorkflowRowVersion

## Summary

|||
|:---|:---|
| Class: | FWH.Mobile.Data.Migrations.AddWorkflowRowVersion |
| Assembly: | FWH.Mobile.Data |
| **File(s):** | E:\github\FunWasHad\src\FWH.Mobile.Data\Migrations\AddWorkflowRowVersion.cs |
| **Line coverage:** | 0% (0 of 13) |
| Covered lines: | 0 |
| Uncovered lines: | 13 |
| Coverable lines: | 13 |
| Total lines: | 30 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **Up(...)** | 100% | 2 | 1 | 0% |
| **Down(...)** | 100% | 2 | 1 | 0% |

## File(s)

### E:\github\FunWasHad\src\FWH.Mobile.Data\Migrations\AddWorkflowRowVersion.cs
```
 1           using Microsoft.EntityFrameworkCore.Migrations;
 2           
 3           #nullable disable
 4           
 5           namespace FWH.Mobile.Data.Migrations;
 6           
 7           /// <summary>
 8           /// Adds RowVersion column for optimistic concurrency control
 9           /// </summary>
10           public partial class AddWorkflowRowVersion : Migration
11           {
12               /// <inheritdoc />
13               protected override void Up(MigrationBuilder migrationBuilder)
14  ❌ 0         {
15  ❌ 0             migrationBuilder.AddColumn<byte[]>(
16  ❌ 0                 name: "RowVersion",
17  ❌ 0                 table: "WorkflowDefinitions",
18  ❌ 0                 type: "BLOB",
19  ❌ 0                 rowVersion: true,
20  ❌ 0                 nullable: true);
21  ❌ 0         }
22           
23               /// <inheritdoc />
24               protected override void Down(MigrationBuilder migrationBuilder)
25  ❌ 0         {
26  ❌ 0             migrationBuilder.DropColumn(
27  ❌ 0                 name: "RowVersion",
28  ❌ 0                 table: "WorkflowDefinitions");
29  ❌ 0         }
30           }
```
# FWH.Mobile.Data.Models.NodeEntity

## Summary

|||
|:---|:---|
| Class: | FWH.Mobile.Data.Models.NodeEntity |
| Assembly: | FWH.Mobile.Data |
| **File(s):** | E:\github\FunWasHad\src\FWH.Mobile.Data\Models\NodeEntity.cs |
| **Line coverage:** | 66.6% (4 of 6) |
| Covered lines: | 4 |
| Uncovered lines: | 2 |
| Coverable lines: | 6 |
| Total lines: | 21 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **get_Id()** | 100% | 2 | 1 | 0% |
| **get_NodeId()** | 100% | 1 | 1 | 100% |
| **get_Text()** | 100% | 1 | 1 | 100% |
| **get_Type()** | 100% | 1 | 1 | 100% |
| **get_WorkflowDefinitionEntityId()** | 100% | 1 | 1 | 100% |
| **get_WorkflowDefinition()** | 100% | 2 | 1 | 0% |

## File(s)

### E:\github\FunWasHad\src\FWH.Mobile.Data\Models\NodeEntity.cs
```
 1             using System.ComponentModel.DataAnnotations;
 2             using System.ComponentModel.DataAnnotations.Schema;
 3             
 4             namespace FWH.Mobile.Data.Models;
 5             
 6             public class NodeEntity
 7             {
 8                 [Key]
 9  ❌   0         public long Id { get; set; }
10             
11  ✔  780         public string NodeId { get; set; } = string.Empty;
12             
13  ✔  794         public string Text { get; set; } = string.Empty;
14             
15  ✔    2         public string? Type { get; set; }
16             
17  ✔    1         public string? WorkflowDefinitionEntityId { get; set; }
18             
19                 [ForeignKey(nameof(WorkflowDefinitionEntityId))]
20  ❌   0         public WorkflowDefinitionEntity? WorkflowDefinition { get; set; }
21             }
```
# FWH.Mobile.Data.Models.Note

## Summary

|||
|:---|:---|
| Class: | FWH.Mobile.Data.Models.Note |
| Assembly: | FWH.Mobile.Data |
| **File(s):** | E:\github\FunWasHad\src\FWH.Mobile.Data\Models\Note.cs |
| **Line coverage:** | 100% (4 of 4) |
| Covered lines: | 4 |
| Uncovered lines: | 0 |
| Coverable lines: | 4 |
| Total lines: | 9 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **get_Id()** | 100% | 1 | 1 | 100% |
| **get_Title()** | 100% | 1 | 1 | 100% |
| **get_Content()** | 100% | 1 | 1 | 100% |
| **get_CreatedAt()** | 100% | 1 | 1 | 100% |

## File(s)

### E:\github\FunWasHad\src\FWH.Mobile.Data\Models\Note.cs
```
1           namespace FWH.Mobile.Data.Models;
2           
3           public class Note
4           {
5  ✔  2         public long Id { get; set; }
6  ✔  3         public string Title { get; set; } = string.Empty;
7  ✔  2         public string Content { get; set; } = string.Empty;
8  ✔  1         public DateTime CreatedAt { get; set; } = DateTime.UtcNow;
9           }
```
# FWH.Mobile.Data.Models.StartPointEntity

## Summary

|||
|:---|:---|
| Class: | FWH.Mobile.Data.Models.StartPointEntity |
| Assembly: | FWH.Mobile.Data |
| **File(s):** | E:\github\FunWasHad\src\FWH.Mobile.Data\Models\StartPointEntity.cs |
| **Line coverage:** | 50% (2 of 4) |
| Covered lines: | 2 |
| Uncovered lines: | 2 |
| Coverable lines: | 4 |
| Total lines: | 17 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **get_Id()** | 100% | 2 | 1 | 0% |
| **get_NodeId()** | 100% | 1 | 1 | 100% |
| **get_WorkflowDefinitionEntityId()** | 100% | 1 | 1 | 100% |
| **get_WorkflowDefinition()** | 100% | 2 | 1 | 0% |

## File(s)

### E:\github\FunWasHad\src\FWH.Mobile.Data\Models\StartPointEntity.cs
```
 1             using System.ComponentModel.DataAnnotations;
 2             using System.ComponentModel.DataAnnotations.Schema;
 3             
 4             namespace FWH.Mobile.Data.Models;
 5             
 6             public class StartPointEntity
 7             {
 8                 [Key]
 9  ❌   0         public long Id { get; set; }
10             
11  ✔  183         public string? NodeId { get; set; }
12             
13  ✔    1         public string? WorkflowDefinitionEntityId { get; set; }
14             
15                 [ForeignKey(nameof(WorkflowDefinitionEntityId))]
16  ❌   0         public WorkflowDefinitionEntity? WorkflowDefinition { get; set; }
17             }
```
# FWH.Mobile.Data.Models.TransitionEntity

## Summary

|||
|:---|:---|
| Class: | FWH.Mobile.Data.Models.TransitionEntity |
| Assembly: | FWH.Mobile.Data |
| **File(s):** | E:\github\FunWasHad\src\FWH.Mobile.Data\Models\TransitionEntity.cs |
| **Line coverage:** | 66.6% (4 of 6) |
| Covered lines: | 4 |
| Uncovered lines: | 2 |
| Coverable lines: | 6 |
| Total lines: | 19 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **get_Id()** | 100% | 2 | 1 | 0% |
| **get_FromNodeId()** | 100% | 1 | 1 | 100% |
| **get_ToNodeId()** | 100% | 1 | 1 | 100% |
| **get_Condition()** | 100% | 1 | 1 | 100% |
| **get_WorkflowDefinitionEntityId()** | 100% | 1 | 1 | 100% |
| **get_WorkflowDefinition()** | 100% | 2 | 1 | 0% |

## File(s)

### E:\github\FunWasHad\src\FWH.Mobile.Data\Models\TransitionEntity.cs
```
 1             using System.ComponentModel.DataAnnotations;
 2             using System.ComponentModel.DataAnnotations.Schema;
 3             
 4             namespace FWH.Mobile.Data.Models;
 5             
 6             public class TransitionEntity
 7             {
 8                 [Key]
 9  ❌   0         public long Id { get; set; }
10             
11  ✔  519         public string FromNodeId { get; set; } = string.Empty;
12  ✔  480         public string ToNodeId { get; set; } = string.Empty;
13  ✔  248         public string? Condition { get; set; }
14             
15  ✔    1         public string? WorkflowDefinitionEntityId { get; set; }
16             
17                 [ForeignKey(nameof(WorkflowDefinitionEntityId))]
18  ❌   0         public WorkflowDefinitionEntity? WorkflowDefinition { get; set; }
19             }
```
# FWH.Mobile.Data.Models.WorkflowDefinitionEntity

## Summary

|||
|:---|:---|
| Class: | FWH.Mobile.Data.Models.WorkflowDefinitionEntity |
| Assembly: | FWH.Mobile.Data |
| **File(s):** | E:\github\FunWasHad\src\FWH.Mobile.Data\Models\WorkflowDefinitionEntity.cs |
| **Line coverage:** | 87.5% (7 of 8) |
| Covered lines: | 7 |
| Uncovered lines: | 1 |
| Coverable lines: | 8 |
| Total lines: | 30 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **get_Id()** | 100% | 1 | 1 | 100% |
| **get_Name()** | 100% | 1 | 1 | 100% |
| **get_CreatedAt()** | 100% | 1 | 1 | 100% |
| **get_Nodes()** | 100% | 1 | 1 | 100% |
| **get_Transitions()** | 100% | 1 | 1 | 100% |
| **get_StartPoints()** | 100% | 1 | 1 | 100% |
| **get_CurrentNodeId()** | 100% | 1 | 1 | 100% |
| **get_RowVersion()** | 100% | 2 | 1 | 0% |

## File(s)

### E:\github\FunWasHad\src\FWH.Mobile.Data\Models\WorkflowDefinitionEntity.cs
```
 1              using System.ComponentModel.DataAnnotations;
 2              using System.ComponentModel.DataAnnotations.Schema;
 3              
 4              namespace FWH.Mobile.Data.Models;
 5              
 6              public class WorkflowDefinitionEntity
 7              {
 8                  [Key]
 9  ✔  1112         public string Id { get; set; } = string.Empty;
10              
11  ✔   383         public string Name { get; set; } = string.Empty;
12              
13  ✔   372         public DateTime CreatedAt { get; set; } = DateTime.UtcNow;
14              
15  ✔   588         public List<NodeEntity> Nodes { get; set; } = new();
16              
17  ✔   438         public List<TransitionEntity> Transitions { get; set; } = new();
18              
19  ✔   375         public List<StartPointEntity> StartPoints { get; set; } = new();
20              
21                  // Persist the current node id for an in-memory instance so instances survive restarts
22  ✔   452         public string? CurrentNodeId { get; set; }
23              
24                  /// <summary>
25                  /// Row version for optimistic concurrency control.
26                  /// Automatically updated by EF Core on each save.
27                  /// </summary>
28                  [Timestamp]
29  ❌    0         public byte[]? RowVersion { get; set; }
30              }
```
# FWH.Mobile.Data.Repositories.EfConfigurationRepository

## Summary

|||
|:---|:---|
| Class: | FWH.Mobile.Data.Repositories.EfConfigurationRepository |
| Assembly: | FWH.Mobile.Data |
| **File(s):** | E:\github\FunWasHad\src\FWH.Mobile.Data\Repositories\EfConfigurationRepository.cs |
| **Line coverage:** | 0% (0 of 73) |
| Covered lines: | 0 |
| Uncovered lines: | 73 |
| Coverable lines: | 73 |
| Total lines: | 120 |
| **Branch coverage:** | 0% (0 of 18) |
| Covered branches: | 0 |
| Total branches: | 18 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **.ctor(...)** | 0% | 6 | 2 | 0% |
| **GetByKeyAsync()** | 100% | 2 | 1 | 0% |
| **GetByCategoryAsync()** | 100% | 2 | 1 | 0% |
| **GetAllAsync()** | 100% | 2 | 1 | 0% |
| **SetAsync()** | 0% | 6 | 2 | 0% |
| **SetIntAsync()** | 100% | 2 | 1 | 0% |
| **SetBoolAsync()** | 100% | 2 | 1 | 0% |
| **GetIntAsync()** | 0% | 20 | 4 | 0% |
| **GetBoolAsync()** | 0% | 20 | 4 | 0% |
| **GetStringAsync()** | 0% | 20 | 4 | 0% |
| **DeleteAsync()** | 0% | 6 | 2 | 0% |
| **ExistsAsync()** | 100% | 2 | 1 | 0% |

## File(s)

### E:\github\FunWasHad\src\FWH.Mobile.Data\Repositories\EfConfigurationRepository.cs
```
  1           using Microsoft.EntityFrameworkCore;
  2           using FWH.Mobile.Data.Data;
  3           using FWH.Mobile.Data.Entities;
  4           
  5           namespace FWH.Mobile.Data.Repositories;
  6           
  7           /// <summary>
  8           /// Entity Framework implementation of configuration repository.
  9           /// Single Responsibility: Database access for configuration settings.
 10           /// </summary>
 11           public class EfConfigurationRepository : IConfigurationRepository
 12           {
 13               private readonly NotesDbContext _context;
 14           
 15  ❌ 0         public EfConfigurationRepository(NotesDbContext context)
 16  ❌ 0         {
 17  ❌ 0  ○          _context = context ?? throw new ArgumentNullException(nameof(context));
 18  ❌ 0         }
 19           
 20               public async Task<ConfigurationSetting?> GetByKeyAsync(string key)
 21  ❌ 0         {
 22  ❌ 0             return await _context.ConfigurationSettings
 23  ❌ 0                 .FirstOrDefaultAsync(c => c.Key == key);
 24  ❌ 0         }
 25           
 26               public async Task<IEnumerable<ConfigurationSetting>> GetByCategoryAsync(string category)
 27  ❌ 0         {
 28  ❌ 0             return await _context.ConfigurationSettings
 29  ❌ 0                 .Where(c => c.Category == category)
 30  ❌ 0                 .ToListAsync();
 31  ❌ 0         }
 32           
 33               public async Task<IEnumerable<ConfigurationSetting>> GetAllAsync()
 34  ❌ 0         {
 35  ❌ 0             return await _context.ConfigurationSettings.ToListAsync();
 36  ❌ 0         }
 37           
 38               public async Task SetAsync(
 39                   string key,
 40                   string value,
 41                   string valueType = "string",
 42                   string? category = null,
 43                   string? description = null)
 44  ❌ 0         {
 45  ❌ 0             var existing = await GetByKeyAsync(key);
 46           
 47  ❌ 0  ○          if (existing != null)
 48  ❌ 0             {
 49  ❌ 0                 existing.Value = value;
 50  ❌ 0                 existing.ValueType = valueType;
 51  ❌ 0                 existing.Category = category;
 52  ❌ 0                 existing.Description = description;
 53  ❌ 0                 existing.UpdatedAt = DateTime.UtcNow;
 54  ❌ 0                 _context.ConfigurationSettings.Update(existing);
 55  ❌ 0             }
 56                   else
 57  ❌ 0             {
 58  ❌ 0                 var setting = new ConfigurationSetting
 59  ❌ 0                 {
 60  ❌ 0                     Key = key,
 61  ❌ 0                     Value = value,
 62  ❌ 0                     ValueType = valueType,
 63  ❌ 0                     Category = category,
 64  ❌ 0                     Description = description,
 65  ❌ 0                     UpdatedAt = DateTime.UtcNow
 66  ❌ 0                 };
 67  ❌ 0                 await _context.ConfigurationSettings.AddAsync(setting);
 68  ❌ 0             }
 69           
 70  ❌ 0             await _context.SaveChangesAsync();
 71  ❌ 0         }
 72           
 73               public async Task SetIntAsync(string key, int value, string? category = null, string? description = null)
 74  ❌ 0         {
 75  ❌ 0             await SetAsync(key, value.ToString(), "int", category, description);
 76  ❌ 0         }
 77           
 78               public async Task SetBoolAsync(string key, bool value, string? category = null, string? description = null)
 79  ❌ 0         {
 80  ❌ 0             await SetAsync(key, value.ToString().ToLower(), "bool", category, description);
 81  ❌ 0         }
 82           
 83               public async Task<int> GetIntAsync(string key, int defaultValue = 0)
 84  ❌ 0         {
 85  ❌ 0             var setting = await GetByKeyAsync(key);
 86  ❌ 0  ○          if (setting == null) return defaultValue;
 87           
 88  ❌ 0  ○          return int.TryParse(setting.Value, out var result) ? result : defaultValue;
 89  ❌ 0         }
 90           
 91               public async Task<bool> GetBoolAsync(string key, bool defaultValue = false)
 92  ❌ 0         {
 93  ❌ 0             var setting = await GetByKeyAsync(key);
 94  ❌ 0  ○          if (setting == null) return defaultValue;
 95           
 96  ❌ 0  ○          return bool.TryParse(setting.Value, out var result) ? result : defaultValue;
 97  ❌ 0         }
 98           
 99               public async Task<string> GetStringAsync(string key, string defaultValue = "")
100  ❌ 0         {
101  ❌ 0             var setting = await GetByKeyAsync(key);
102  ❌ 0  ○          return setting?.Value ?? defaultValue;
103  ❌ 0         }
104           
105               public async Task DeleteAsync(string key)
106  ❌ 0         {
107  ❌ 0             var setting = await GetByKeyAsync(key);
108  ❌ 0  ○          if (setting != null)
109  ❌ 0             {
110  ❌ 0                 _context.ConfigurationSettings.Remove(setting);
111  ❌ 0                 await _context.SaveChangesAsync();
112  ❌ 0             }
113  ❌ 0         }
114           
115               public async Task<bool> ExistsAsync(string key)
116  ❌ 0         {
117  ❌ 0             return await _context.ConfigurationSettings
118  ❌ 0                 .AnyAsync(c => c.Key == key);
119  ❌ 0         }
120           }
```
# FWH.Mobile.Data.Repositories.EfNoteRepository

## Summary

|||
|:---|:---|
| Class: | FWH.Mobile.Data.Repositories.EfNoteRepository |
| Assembly: | FWH.Mobile.Data |
| **File(s):** | E:\github\FunWasHad\src\FWH.Mobile.Data\Repositories\EfNoteRepository.cs |
| **Line coverage:** | 25% (15 of 60) |
| Covered lines: | 15 |
| Uncovered lines: | 45 |
| Coverable lines: | 60 |
| Total lines: | 101 |
| **Branch coverage:** | 25% (2 of 8) |
| Covered branches: | 2 |
| Total branches: | 8 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **.ctor(...)** | 50.0% | 2 | 2 | 100% |
| **CreateAsync()** | 50.0% | 3 | 2 | 50.0% |
| **GetByIdAsync()** | 100% | 1 | 1 | 57.14% |
| **GetAllAsync()** | 100% | 2 | 1 | 0% |
| **UpdateAsync()** | 0% | 6 | 2 | 0% |
| **DeleteAsync()** | 0% | 6 | 2 | 0% |

## File(s)

### E:\github\FunWasHad\src\FWH.Mobile.Data\Repositories\EfNoteRepository.cs
```
  1           using Microsoft.EntityFrameworkCore;
  2           using FWH.Mobile.Data.Data;
  3           using FWH.Mobile.Data.Models;
  4           
  5           namespace FWH.Mobile.Data.Repositories;
  6           
  7           public class EfNoteRepository : INoteRepository
  8           {
  9               private readonly NotesDbContext _context;
 10           
 11  ✔  1         public EfNoteRepository(NotesDbContext context)
 12  ✔  1         {
 13  ✓  1  ◑          _context = context ?? throw new ArgumentNullException(nameof(context));
 14  ✔  1         }
 15           
 16               public async Task<Note> CreateAsync(Note note, CancellationToken cancellationToken = default)
 17  ✔  1         {
 18  ✓  1  ◑          if (note == null)
 19  ❌ 0                 throw new ArgumentNullException(nameof(note));
 20           
 21                   try
 22  ✔  1             {
 23  ✔  1                 var entry = await _context.Notes.AddAsync(note, cancellationToken);
 24  ✔  1                 await _context.SaveChangesAsync(cancellationToken);
 25  ✔  1                 return entry.Entity;
 26                   }
 27  ❌ 0             catch (DbUpdateException)
 28  ❌ 0             {
 29  ❌ 0                 throw;
 30                   }
 31  ❌ 0             catch (OperationCanceledException)
 32  ❌ 0             {
 33  ❌ 0                 throw;
 34                   }
 35  ✔  1         }
 36           
 37               public async Task<Note?> GetByIdAsync(long id, CancellationToken cancellationToken = default)
 38  ✔  1         {
 39                   try
 40  ✔  1             {
 41  ✔  1                 return await _context.Notes.FindAsync(new object[] { id }, cancellationToken);
 42                   }
 43  ❌ 0             catch (OperationCanceledException)
 44  ❌ 0             {
 45  ❌ 0                 throw;
 46                   }
 47  ✔  1         }
 48           
 49               public async Task<IEnumerable<Note>> GetAllAsync(CancellationToken cancellationToken = default)
 50  ❌ 0         {
 51                   try
 52  ❌ 0             {
 53  ❌ 0                 return await _context.Notes.OrderByDescending(n => n.CreatedAt).ToListAsync(cancellationToken);
 54                   }
 55  ❌ 0             catch (OperationCanceledException)
 56  ❌ 0             {
 57  ❌ 0                 throw;
 58                   }
 59  ❌ 0         }
 60           
 61               public async Task<bool> UpdateAsync(Note note, CancellationToken cancellationToken = default)
 62  ❌ 0         {
 63  ❌ 0  ○          if (note == null)
 64  ❌ 0                 throw new ArgumentNullException(nameof(note));
 65           
 66                   try
 67  ❌ 0             {
 68  ❌ 0                 _context.Notes.Update(note);
 69  ❌ 0                 var affected = await _context.SaveChangesAsync(cancellationToken);
 70  ❌ 0                 return affected > 0;
 71                   }
 72  ❌ 0             catch (DbUpdateException)
 73  ❌ 0             {
 74  ❌ 0                 throw;
 75                   }
 76  ❌ 0             catch (OperationCanceledException)
 77  ❌ 0             {
 78  ❌ 0                 throw;
 79                   }
 80  ❌ 0         }
 81           
 82               public async Task<bool> DeleteAsync(long id, CancellationToken cancellationToken = default)
 83  ❌ 0         {
 84                   try
 85  ❌ 0             {
 86  ❌ 0                 var entity = await _context.Notes.FindAsync(new object[] { id }, cancellationToken);
 87  ❌ 0  ○              if (entity == null) return false;
 88  ❌ 0                 _context.Notes.Remove(entity);
 89  ❌ 0                 var affected = await _context.SaveChangesAsync(cancellationToken);
 90  ❌ 0                 return affected > 0;
 91                   }
 92  ❌ 0             catch (DbUpdateException)
 93  ❌ 0             {
 94  ❌ 0                 throw;
 95                   }
 96  ❌ 0             catch (OperationCanceledException)
 97  ❌ 0             {
 98  ❌ 0                 throw;
 99                   }
100  ❌ 0         }
101           }
```
# FWH.Mobile.Data.Repositories.EfWorkflowRepository

## Summary

|||
|:---|:---|
| Class: | FWH.Mobile.Data.Repositories.EfWorkflowRepository |
| Assembly: | FWH.Mobile.Data |
| **File(s):** | E:\github\FunWasHad\src\FWH.Mobile.Data\Repositories\EfWorkflowRepository.cs |
| **Line coverage:** | 54.2% (133 of 245) |
| Covered lines: | 133 |
| Uncovered lines: | 112 |
| Coverable lines: | 245 |
| Total lines: | 356 |
| **Branch coverage:** | 52.2% (23 of 44) |
| Covered branches: | 23 |
| Total branches: | 44 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **.ctor(...)** | 100% | 2 | 2 | 100% |
| **CreateAsync()** | 25.00% | 10 | 8 | 69.56% |
| **GetByIdAsync()** | 100% | 1 | 1 | 63.63% |
| **GetAllAsync()** | 100% | 1 | 1 | 45.45% |
| **FindByNamePatternAsync()** | 100% | 2 | 1 | 0% |
| **UpdateAsync()** | 63.63% | 63 | 22 | 55.93% |
| **DeleteAsync()** | 50.0% | 3 | 2 | 47.82% |
| **UpdateCurrentNodeIdAsync()** | 40.0% | 17 | 10 | 58.13% |

## File(s)

### E:\github\FunWasHad\src\FWH.Mobile.Data\Repositories\EfWorkflowRepository.cs
```
  1             using Microsoft.EntityFrameworkCore;
  2             using FWH.Mobile.Data.Data;
  3             using FWH.Mobile.Data.Models;
  4             using Microsoft.Extensions.Logging;
  5             
  6             namespace FWH.Mobile.Data.Repositories;
  7             
  8             public class EfWorkflowRepository : IWorkflowRepository
  9             {
 10                 private readonly NotesDbContext _context;
 11                 private readonly ILogger<EfWorkflowRepository> _logger;
 12             
 13  ✔   50         public EfWorkflowRepository(NotesDbContext context, ILogger<EfWorkflowRepository>? logger = null)
 14  ✔   50         {
 15  ✔   50             _context = context;
 16  ✔   50  ●          _logger = logger ?? Microsoft.Extensions.Logging.Abstractions.NullLogger<EfWorkflowRepository>.Instance;
 17  ✔   50         }
 18             
 19                 public async Task<WorkflowDefinitionEntity> CreateAsync(WorkflowDefinitionEntity def, CancellationToken cancellation
 20  ✔  180         {
 21  ✔  180             using var scope = _logger.BeginScope(new Dictionary<string, object> { ["Operation"] = "CreateWorkflow", ["Workfl
 22                     try
 23  ✔  180             {
 24  ✔  180                 _logger.LogDebug("Creating workflow {WorkflowId}", def.Id);
 25             
 26                         // Check if workflow already exists before attempting to create
 27  ✔  180                 var existing = await _context.WorkflowDefinitions
 28  ✔  180                     .FirstOrDefaultAsync(w => w.Id == def.Id, cancellationToken);
 29             
 30  ✓  179  ◑              if (existing != null)
 31  ❌   0                 {
 32  ❌   0                     _logger.LogWarning("Workflow {WorkflowId} already exists, cannot create. Use UpdateAsync instead.", def.
 33  ❌   0                     throw new InvalidOperationException($"Workflow '{def.Id}' already exists. Use UpdateAsync to modify it."
 34                         }
 35             
 36  ✔  179                 var entry = await _context.WorkflowDefinitions.AddAsync(def, cancellationToken);
 37  ✔  179                 await _context.SaveChangesAsync(cancellationToken);
 38  ✔  179                 _logger.LogInformation("Created workflow {WorkflowId}", def.Id);
 39  ✔  179                 return entry.Entity;
 40                     }
 41  ❌   0             catch (DbUpdateException ex) when (ex.InnerException?.Message?.Contains("UNIQUE constraint") == true)
 42  ❌   0             {
 43  ❌   0  ○              _logger.LogWarning(ex, "Unique constraint violation when creating workflow {WorkflowId}. Workflow already ex
 44  ❌   0  ○              throw new InvalidOperationException($"Workflow '{def?.Id}' already exists. Use UpdateAsync to modify it.", e
 45                     }
 46  ✔    1             catch (Exception ex)
 47  ✔    1             {
 48  ✓    1  ◑              _logger.LogError(ex, "Error creating workflow {WorkflowId}", def?.Id);
 49  ✔    1                 throw;
 50                     }
 51  ✔  179         }
 52             
 53                 public async Task<WorkflowDefinitionEntity?> GetByIdAsync(string id, CancellationToken cancellationToken = default)
 54  ✔  413         {
 55  ✔  413             using var scope = _logger.BeginScope(new Dictionary<string, object> { ["Operation"] = "GetById", ["WorkflowId"] 
 56                     try
 57  ✔  413             {
 58  ✔  413                 _logger.LogDebug("Loading workflow {WorkflowId}", id);
 59  ✔  413                 return await _context.WorkflowDefinitions
 60  ✔  413                     .Include(w => w.Nodes)
 61  ✔  413                     .Include(w => w.Transitions)
 62  ✔  413                     .Include(w => w.StartPoints)
 63  ✔  413                     .FirstOrDefaultAsync(w => w.Id == id, cancellationToken);
 64                     }
 65  ❌   0             catch (OperationCanceledException)
 66  ❌   0             {
 67  ❌   0                 _logger.LogInformation("Loading workflow {WorkflowId} was cancelled", id);
 68  ❌   0                 throw;
 69                     }
 70  ❌   0             catch (DbUpdateException ex)
 71  ❌   0             {
 72  ❌   0                 _logger.LogError(ex, "Database error loading workflow {WorkflowId}", id);
 73  ❌   0                 throw;
 74                     }
 75  ✔   14             catch (Exception ex)
 76  ✔   14             {
 77  ✔   14                 _logger.LogError(ex, "Error loading workflow {WorkflowId}", id);
 78  ✔   14                 throw;
 79                     }
 80  ✔  399         }
 81             
 82                 public async Task<IEnumerable<WorkflowDefinitionEntity>> GetAllAsync(CancellationToken cancellationToken = default)
 83  ✔    1         {
 84  ✔    1             using var scope = _logger.BeginScope(new Dictionary<string, object> { ["Operation"] = "GetAll" });
 85                     try
 86  ✔    1             {
 87  ✔    1                 _logger.LogDebug("Loading all workflows");
 88  ✔    1                 return await _context.WorkflowDefinitions
 89  ✔    1                     .Include(w => w.Nodes)
 90  ✔    1                     .Include(w => w.Transitions)
 91  ✔    1                     .Include(w => w.StartPoints)
 92  ✔    1                     .ToListAsync(cancellationToken);
 93                     }
 94  ❌   0             catch (OperationCanceledException)
 95  ❌   0             {
 96  ❌   0                 _logger.LogInformation("Loading all workflows was cancelled");
 97  ❌   0                 throw;
 98                     }
 99  ❌   0             catch (DbUpdateException ex)
100  ❌   0             {
101  ❌   0                 _logger.LogError(ex, "Database error loading all workflows");
102  ❌   0                 throw;
103                     }
104  ❌   0             catch (Exception ex)
105  ❌   0             {
106  ❌   0                 _logger.LogError(ex, "Error loading all workflows");
107  ❌   0                 throw;
108                     }
109  ✔    1         }
110             
111                 public async Task<IEnumerable<WorkflowDefinitionEntity>> FindByNamePatternAsync(
112                     string namePattern,
113                     DateTimeOffset since,
114                     CancellationToken cancellationToken = default)
115  ❌   0         {
116  ❌   0             using var scope = _logger.BeginScope(new Dictionary<string, object>
117  ❌   0             {
118  ❌   0                 ["Operation"] = "FindByNamePattern",
119  ❌   0                 ["Pattern"] = namePattern,
120  ❌   0                 ["Since"] = since
121  ❌   0             });
122             
123                     try
124  ❌   0             {
125  ❌   0                 _logger.LogDebug("Finding workflows matching pattern {Pattern} since {Since}", namePattern, since);
126             
127  ❌   0                 return await _context.WorkflowDefinitions
128  ❌   0                     .Include(w => w.Nodes)
129  ❌   0                     .Include(w => w.Transitions)
130  ❌   0                     .Include(w => w.StartPoints)
131  ❌   0                     .Where(w => w.Name.Contains(namePattern) && w.CreatedAt >= since)
132  ❌   0                     .OrderByDescending(w => w.CreatedAt)
133  ❌   0                     .ToListAsync(cancellationToken);
134                     }
135  ❌   0             catch (OperationCanceledException)
136  ❌   0             {
137  ❌   0                 _logger.LogInformation("Finding workflows by pattern {Pattern} was cancelled", namePattern);
138  ❌   0                 throw;
139                     }
140  ❌   0             catch (DbUpdateException ex)
141  ❌   0             {
142  ❌   0                 _logger.LogError(ex, "Database error finding workflows by name pattern {Pattern}", namePattern);
143  ❌   0                 throw;
144                     }
145  ❌   0             catch (Exception ex)
146  ❌   0             {
147  ❌   0                 _logger.LogError(ex, "Error finding workflows by name pattern {Pattern}", namePattern);
148  ❌   0                 throw;
149                     }
150  ❌   0         }
151             
152                 public async Task<WorkflowDefinitionEntity> UpdateAsync(WorkflowDefinitionEntity def, CancellationToken cancellation
153  ✔    1         {
154  ✔    1             using var scope = _logger.BeginScope(new Dictionary<string, object> { ["Operation"] = "UpdateWorkflow", ["Workfl
155             
156  ✔    1             int retryCount = 0;
157                     const int maxRetries = 3;
158             
159  ✓    1  ◑          while (retryCount < maxRetries)
160  ✔    1             {
161                         try
162  ✔    1                 {
163  ✔    1                     _logger.LogDebug("Updating workflow {WorkflowId} (attempt {RetryCount})", def.Id, retryCount + 1);
164  ✔    1                     var existing = await _context.WorkflowDefinitions
165  ✔    1                         .Include(w => w.Nodes)
166  ✔    1                         .Include(w => w.Transitions)
167  ✔    1                         .Include(w => w.StartPoints)
168  ✔    1                         .FirstOrDefaultAsync(w => w.Id == def.Id, cancellationToken);
169             
170  ✓    1  ◑                  if (existing == null)
171  ❌   0                     {
172  ❌   0                         _logger.LogWarning("Workflow {WorkflowId} not found for update", def.Id);
173  ❌   0                         throw new KeyNotFoundException($"Workflow '{def.Id}' not found");
174                             }
175             
176  ✔    1                     existing.Name = def.Name;
177  ✔    1                     existing.CurrentNodeId = def.CurrentNodeId;
178             
179                             // Remove existing children by querying the DbSets to ensure they have database-generated keys
180  ✔    1                     var oldNodes = await _context.NodeEntities.Where(n => n.WorkflowDefinitionEntityId == existing.Id).ToLis
181  ✔    2  ●                  if (oldNodes.Any()) _context.NodeEntities.RemoveRange(oldNodes);
182             
183  ✔    1                     var oldTransitions = await _context.TransitionEntities.Where(t => t.WorkflowDefinitionEntityId == existi
184  ✔    2  ●                  if (oldTransitions.Any()) _context.TransitionEntities.RemoveRange(oldTransitions);
185             
186  ✔    1                     var oldStartPoints = await _context.StartPointEntities.Where(s => s.WorkflowDefinitionEntityId == existi
187  ✔    2  ●                  if (oldStartPoints.Any()) _context.StartPointEntities.RemoveRange(oldStartPoints);
188             
189                             // Clear tracked navigation collections
190  ✔    1                     existing.Nodes.Clear();
191  ✔    1                     existing.Transitions.Clear();
192  ✔    1                     existing.StartPoints.Clear();
193             
194                             // Persist removals first so we can add fresh children cleanly
195  ✔    1                     await _context.SaveChangesAsync(cancellationToken);
196             
197                             // Prepare new children, creating fresh instances so tracking is clean
198  ✔    2                     var newNodes = def.Nodes.Select(n => new NodeEntity
199  ✔    2                     {
200  ✔    2                         NodeId = n.NodeId,
201  ✔    2                         Text = n.Text,
202  ✔    2                         Type = n.Type,
203  ✔    2                         WorkflowDefinitionEntityId = existing.Id
204  ✔    2                     }).ToList();
205             
206  ✔    2                     var newTransitions = def.Transitions.Select(t => new TransitionEntity
207  ✔    2                     {
208  ✔    2                         FromNodeId = t.FromNodeId,
209  ✔    2                         ToNodeId = t.ToNodeId,
210  ✔    2                         Condition = t.Condition,
211  ✔    2                         WorkflowDefinitionEntityId = existing.Id
212  ✔    2                     }).ToList();
213             
214  ✔    2                     var newStartPoints = def.StartPoints.Select(s => new StartPointEntity
215  ✔    2                     {
216  ✔    2                         NodeId = s.NodeId,
217  ✔    2                         WorkflowDefinitionEntityId = existing.Id
218  ✔    2                     }).ToList();
219             
220  ✔    2  ●                  if (newNodes.Any()) await _context.NodeEntities.AddRangeAsync(newNodes, cancellationToken);
221  ✔    2  ●                  if (newTransitions.Any()) await _context.TransitionEntities.AddRangeAsync(newTransitions, cancellationTo
222  ✔    2  ●                  if (newStartPoints.Any()) await _context.StartPointEntities.AddRangeAsync(newStartPoints, cancellationTo
223             
224  ✔    1                     await _context.SaveChangesAsync(cancellationToken);
225             
226                             // Reload and return the updated workflow with navigation properties
227  ✔    1                     var updated = await GetByIdAsync(existing.Id, cancellationToken);
228  ✔    1                     _logger.LogInformation("Updated workflow {WorkflowId}", def.Id);
229  ✔    1                     return updated!;
230                         }
231  ❌   0                 catch (DbUpdateConcurrencyException ex)
232  ❌   0                 {
233  ❌   0                     retryCount++;
234  ❌   0                     _logger.LogWarning(ex, "Concurrency conflict updating workflow {WorkflowId}, attempt {RetryCount}/{MaxRe
235  ❌   0                         def.Id, retryCount, maxRetries);
236             
237  ❌   0  ○                  if (retryCount >= maxRetries)
238  ❌   0                     {
239  ❌   0                         _logger.LogError("Max retries exceeded for workflow {WorkflowId} due to concurrency conflicts", def.
240  ❌   0                         throw new InvalidOperationException(
241  ❌   0                             $"Unable to update workflow '{def.Id}' after {maxRetries} attempts due to concurrent modificatio
242  ❌   0                             ex);
243                             }
244             
245                             // Refresh the context to get latest data
246  ❌   0  ○                  foreach (var entry in _context.ChangeTracker.Entries())
247  ❌   0                     {
248  ❌   0                         await entry.ReloadAsync(cancellationToken);
249  ❌   0                     }
250             
251                             // Small delay before retry with exponential backoff
252  ❌   0                     await Task.Delay(100 * retryCount, cancellationToken);
253  ❌   0                 }
254  ❌   0                 catch (Exception ex)
255  ❌   0                 {
256  ❌   0  ○                  _logger.LogError(ex, "Error updating workflow {WorkflowId}", def?.Id);
257  ❌   0                     throw;
258                         }
259  ❌   0             }
260             
261  ❌   0             throw new InvalidOperationException($"Unexpected state: exceeded retry loop for workflow '{def.Id}'");
262  ✔    1         }
263             
264                 public async Task<bool> DeleteAsync(string id, CancellationToken cancellationToken = default)
265  ✔    1         {
266  ✔    1             using var scope = _logger.BeginScope(new Dictionary<string, object> { ["Operation"] = "DeleteWorkflow", ["Workfl
267                     try
268  ✔    1             {
269  ✔    1                 _logger.LogDebug("Deleting workflow {WorkflowId}", id);
270  ✔    1                 var entity = await _context.WorkflowDefinitions.FindAsync(new object[] { id }, cancellationToken);
271  ✓    1  ◑              if (entity == null) return false;
272  ✔    1                 _context.WorkflowDefinitions.Remove(entity);
273  ✔    1                 var affected = await _context.SaveChangesAsync(cancellationToken);
274  ✔    1                 _logger.LogInformation("Deleted workflow {WorkflowId}", id);
275  ✔    1                 return affected > 0;
276                     }
277  ❌   0             catch (OperationCanceledException)
278  ❌   0             {
279  ❌   0                 _logger.LogInformation("Deleting workflow {WorkflowId} was cancelled", id);
280  ❌   0                 throw;
281                     }
282  ❌   0             catch (DbUpdateException ex)
283  ❌   0             {
284  ❌   0                 _logger.LogError(ex, "Database error deleting workflow {WorkflowId}", id);
285  ❌   0                 throw;
286                     }
287  ❌   0             catch (Exception ex)
288  ❌   0             {
289  ❌   0                 _logger.LogError(ex, "Error deleting workflow {WorkflowId}", id);
290  ❌   0                 throw;
291                     }
292  ✔    1         }
293             
294                 public async Task<bool> UpdateCurrentNodeIdAsync(string workflowDefinitionId, string? currentNodeId = null, Cancella
295  ✔   95         {
296  ✓   95  ◑          using var scope = _logger.BeginScope(new Dictionary<string, object> { ["Operation"] = "UpdateCurrentNodeId", ["W
297             
298  ✔   95             int retryCount = 0;
299                     const int maxRetries = 3;
300             
301  ✓   95  ◑          while (retryCount < maxRetries)
302  ✔   95             {
303                         try
304  ✔   95                 {
305  ✔   95                     _logger.LogDebug("Updating CurrentNodeId for {WorkflowId} to {NodeId} (attempt {RetryCount})",
306  ✔   95                         workflowDefinitionId, currentNodeId, retryCount + 1);
307             
308  ✔   95                     var existing = await _context.WorkflowDefinitions.FirstOrDefaultAsync(
309  ✔   95                         w => w.Id == workflowDefinitionId,
310  ✔   95                         cancellationToken);
311             
312  ✔   90  ●                  if (existing == null)
313  ✔   24                     {
314  ✔   24                         _logger.LogWarning("Workflow {WorkflowId} not found when updating CurrentNodeId", workflowDefinition
315  ✔   24                         return false;
316                             }
317             
318  ✔   66                     existing.CurrentNodeId = currentNodeId;
319  ✔   66                     _context.WorkflowDefinitions.Update(existing);
320  ✔   66                     await _context.SaveChangesAsync(cancellationToken);
321             
322  ✔   65                     _logger.LogInformation("Updated CurrentNodeId for {WorkflowId} to {NodeId}", workflowDefinitionId, curre
323  ✔   65                     return true;
324                         }
325  ❌   0                 catch (DbUpdateConcurrencyException ex)
326  ❌   0                 {
327  ❌   0                     retryCount++;
328  ❌   0                     _logger.LogWarning(ex, "Concurrency conflict updating CurrentNodeId for {WorkflowId}, attempt {RetryCoun
329  ❌   0                         workflowDefinitionId, retryCount, maxRetries);
330             
331  ❌   0  ○                  if (retryCount >= maxRetries)
332  ❌   0                     {
333  ❌   0                         _logger.LogError("Max retries exceeded for workflow {WorkflowId} CurrentNodeId update due to concurr
334  ❌   0                             workflowDefinitionId);
335  ❌   0                         return false; // Return false instead of throwing for this simpler operation
336                             }
337             
338                             // Refresh the context to get latest data
339  ❌   0  ○                  foreach (var entry in _context.ChangeTracker.Entries())
340  ❌   0                     {
341  ❌   0                         await entry.ReloadAsync(cancellationToken);
342  ❌   0                     }
343             
344                             // Small delay before retry with exponential backoff
345  ❌   0                     await Task.Delay(100 * retryCount, cancellationToken);
346  ❌   0                 }
347  ✔    6                 catch (Exception ex)
348  ✔    6                 {
349  ✔    6                     _logger.LogError(ex, "Error updating CurrentNodeId for {WorkflowId} to {NodeId}", workflowDefinitionId, 
350  ✔    6                     throw;
351                         }
352  ❌   0             }
353             
354  ❌   0             return false;
355  ✔   89         }
356             }
```
# FWH.Mobile.Data.Services.MobileDatabaseMigrationService

## Summary

|||
|:---|:---|
| Class: | FWH.Mobile.Data.Services.MobileDatabaseMigrationService |
| Assembly: | FWH.Mobile.Data |
| **File(s):** | E:\github\FunWasHad\src\FWH.Mobile.Data\Services\MobileDatabaseMigrationService.cs |
| **Line coverage:** | 0% (0 of 58) |
| Covered lines: | 0 |
| Uncovered lines: | 58 |
| Coverable lines: | 58 |
| Total lines: | 114 |
| **Branch coverage:** | 0% (0 of 12) |
| Covered branches: | 0 |
| Total branches: | 12 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **.ctor(...)** | 0% | 20 | 4 | 0% |
| **EnsureDatabaseAsync()** | 0% | 42 | 6 | 0% |
| **GetAppliedMigrationsAsync()** | 100% | 2 | 1 | 0% |
| **GetPendingMigrationsAsync()** | 100% | 2 | 1 | 0% |
| **GetConnectionInfo()** | 0% | 6 | 2 | 0% |

## File(s)

### E:\github\FunWasHad\src\FWH.Mobile.Data\Services\MobileDatabaseMigrationService.cs
```
  1           using FWH.Mobile.Data.Data;
  2           using Microsoft.EntityFrameworkCore;
  3           using Microsoft.Extensions.Logging;
  4           
  5           namespace FWH.Mobile.Data.Services;
  6           
  7           /// <summary>
  8           /// Service for managing SQLite database migrations in the mobile app.
  9           /// Ensures database schema is up-to-date with the latest migrations.
 10           /// </summary>
 11           public class MobileDatabaseMigrationService
 12           {
 13               private readonly NotesDbContext _dbContext;
 14               private readonly ILogger<MobileDatabaseMigrationService> _logger;
 15           
 16  ❌ 0         public MobileDatabaseMigrationService(
 17  ❌ 0             NotesDbContext dbContext,
 18  ❌ 0             ILogger<MobileDatabaseMigrationService> logger)
 19  ❌ 0         {
 20  ❌ 0  ○          _dbContext = dbContext ?? throw new ArgumentNullException(nameof(dbContext));
 21  ❌ 0  ○          _logger = logger ?? throw new ArgumentNullException(nameof(logger));
 22  ❌ 0         }
 23           
 24               /// <summary>
 25               /// Ensures the database exists and applies any pending migrations.
 26               /// Safe to call multiple times.
 27               /// </summary>
 28               public async Task EnsureDatabaseAsync(CancellationToken cancellationToken = default)
 29  ❌ 0         {
 30                   try
 31  ❌ 0             {
 32  ❌ 0                 _logger.LogInformation("Checking mobile database status...");
 33           
 34                       // Check if database exists
 35  ❌ 0                 var canConnect = await _dbContext.Database.CanConnectAsync(cancellationToken);
 36           
 37  ❌ 0  ○              if (!canConnect)
 38  ❌ 0                 {
 39  ❌ 0                     _logger.LogInformation("Creating mobile database...");
 40  ❌ 0                     await _dbContext.Database.EnsureCreatedAsync(cancellationToken);
 41  ❌ 0                     _logger.LogInformation("Mobile database created successfully");
 42  ❌ 0                     return;
 43                       }
 44           
 45                       // Check for pending migrations
 46  ❌ 0                 var pendingMigrations = await _dbContext.Database.GetPendingMigrationsAsync(cancellationToken);
 47  ❌ 0                 var pendingList = pendingMigrations.ToList();
 48           
 49  ❌ 0  ○              if (pendingList.Count == 0)
 50  ❌ 0                 {
 51  ❌ 0                     _logger.LogInformation("Mobile database is up to date");
 52  ❌ 0                     return;
 53                       }
 54           
 55  ❌ 0                 _logger.LogInformation("Applying {Count} pending migrations to mobile database", pendingList.Count);
 56  ❌ 0  ○              foreach (var migration in pendingList)
 57  ❌ 0                 {
 58  ❌ 0                     _logger.LogDebug("Pending migration: {Migration}", migration);
 59  ❌ 0                 }
 60           
 61                       // Apply migrations
 62  ❌ 0                 await _dbContext.Database.MigrateAsync(cancellationToken);
 63  ❌ 0                 _logger.LogInformation("Mobile database migrations applied successfully");
 64  ❌ 0             }
 65  ❌ 0             catch (Exception ex)
 66  ❌ 0             {
 67  ❌ 0                 _logger.LogError(ex, "Error ensuring mobile database: {Message}", ex.Message);
 68  ❌ 0                 throw;
 69                   }
 70  ❌ 0         }
 71           
 72               /// <summary>
 73               /// Gets the list of applied migrations.
 74               /// </summary>
 75               public async Task<IEnumerable<string>> GetAppliedMigrationsAsync(CancellationToken cancellationToken = default)
 76  ❌ 0         {
 77                   try
 78  ❌ 0             {
 79  ❌ 0                 var applied = await _dbContext.Database.GetAppliedMigrationsAsync(cancellationToken);
 80  ❌ 0                 return applied;
 81                   }
 82  ❌ 0             catch (Exception ex)
 83  ❌ 0             {
 84  ❌ 0                 _logger.LogError(ex, "Error getting applied migrations: {Message}", ex.Message);
 85  ❌ 0                 return Enumerable.Empty<string>();
 86                   }
 87  ❌ 0         }
 88           
 89               /// <summary>
 90               /// Gets the list of pending migrations.
 91               /// </summary>
 92               public async Task<IEnumerable<string>> GetPendingMigrationsAsync(CancellationToken cancellationToken = default)
 93  ❌ 0         {
 94                   try
 95  ❌ 0             {
 96  ❌ 0                 var pending = await _dbContext.Database.GetPendingMigrationsAsync(cancellationToken);
 97  ❌ 0                 return pending;
 98                   }
 99  ❌ 0             catch (Exception ex)
100  ❌ 0             {
101  ❌ 0                 _logger.LogError(ex, "Error getting pending migrations: {Message}", ex.Message);
102  ❌ 0                 return Enumerable.Empty<string>();
103                   }
104  ❌ 0         }
105           
106               /// <summary>
107               /// Gets database connection information (for diagnostics).
108               /// </summary>
109               public string GetConnectionInfo()
110  ❌ 0         {
111  ❌ 0             var connection = _dbContext.Database.GetConnectionString();
112  ❌ 0  ○          return connection ?? "No connection string configured";
113  ❌ 0         }
114           }
```
# FWH.Mobile.Data.Sqlite.SqliteDbInitializer

## Summary

|||
|:---|:---|
| Class: | FWH.Mobile.Data.Sqlite.SqliteDbInitializer |
| Assembly: | FWH.Mobile.Data |
| **File(s):** | E:\github\FunWasHad\src\FWH.Mobile.Data\Sqlite\SqliteDbInitializer.cs |
| **Line coverage:** | 0% (0 of 41) |
| Covered lines: | 0 |
| Uncovered lines: | 41 |
| Coverable lines: | 41 |
| Total lines: | 63 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **EnsureDatabase(...)** | 100% | 2 | 1 | 0% |

## File(s)

### E:\github\FunWasHad\src\FWH.Mobile.Data\Sqlite\SqliteDbInitializer.cs
```
 1           using Microsoft.Data.Sqlite;
 2           
 3           namespace FWH.Mobile.Data.Sqlite;
 4           
 5           /// <summary>
 6           /// Initializes SQLite database schema for mobile app local storage.
 7           /// TR-MOBILE-001: Includes DeviceLocationHistory for local-only location tracking.
 8           /// </summary>
 9           public static class SqliteDbInitializer
10           {
11               public static void EnsureDatabase(string connectionString)
12  ❌ 0         {
13  ❌ 0             using var conn = new SqliteConnection(connectionString);
14  ❌ 0             conn.Open();
15           
16                   // Notes table
17  ❌ 0             var cmd = conn.CreateCommand();
18  ❌ 0             cmd.CommandText = @"
19  ❌ 0     CREATE TABLE IF NOT EXISTS Notes (
20  ❌ 0         Id INTEGER PRIMARY KEY AUTOINCREMENT,
21  ❌ 0         Title TEXT NOT NULL,
22  ❌ 0         Content TEXT NOT NULL,
23  ❌ 0         CreatedAt TEXT NOT NULL
24  ❌ 0     );";
25  ❌ 0             cmd.ExecuteNonQuery();
26           
27                   // DeviceLocationHistory table
28                   // TR-MOBILE-001: Device location tracked locally, never sent to API
29  ❌ 0             cmd.CommandText = @"
30  ❌ 0     CREATE TABLE IF NOT EXISTS DeviceLocationHistory (
31  ❌ 0         Id INTEGER PRIMARY KEY AUTOINCREMENT,
32  ❌ 0         DeviceId TEXT NOT NULL,
33  ❌ 0         Latitude REAL NOT NULL,
34  ❌ 0         Longitude REAL NOT NULL,
35  ❌ 0         AccuracyMeters REAL,
36  ❌ 0         AltitudeMeters REAL,
37  ❌ 0         SpeedMetersPerSecond REAL,
38  ❌ 0         HeadingDegrees REAL,
39  ❌ 0         MovementState TEXT NOT NULL,
40  ❌ 0         Timestamp TEXT NOT NULL,
41  ❌ 0         Address TEXT,
42  ❌ 0         CreatedAt TEXT NOT NULL
43  ❌ 0     );";
44  ❌ 0             cmd.ExecuteNonQuery();
45           
46                   // Create indexes for efficient querying
47  ❌ 0             cmd.CommandText = @"
48  ❌ 0     CREATE INDEX IF NOT EXISTS IX_DeviceLocationHistory_DeviceId
49  ❌ 0         ON DeviceLocationHistory(DeviceId);";
50  ❌ 0             cmd.ExecuteNonQuery();
51           
52  ❌ 0             cmd.CommandText = @"
53  ❌ 0     CREATE INDEX IF NOT EXISTS IX_DeviceLocationHistory_Timestamp
54  ❌ 0         ON DeviceLocationHistory(Timestamp);";
55  ❌ 0             cmd.ExecuteNonQuery();
56           
57  ❌ 0             cmd.CommandText = @"
58  ❌ 0     CREATE INDEX IF NOT EXISTS IX_DeviceLocationHistory_DeviceId_Timestamp
59  ❌ 0         ON DeviceLocationHistory(DeviceId, Timestamp);";
60  ❌ 0             cmd.ExecuteNonQuery();
61  ❌ 0         }
62           }
63           
```
# FWH.Orchestrix.Contracts.Location.BusinessDto

## Summary

|||
|:---|:---|
| Class: | FWH.Orchestrix.Contracts.Location.BusinessDto |
| Assembly: | FWH.Orchestrix.Contracts |
| **File(s):** | E:\github\FunWasHad\src\FWH.Orchestrix.Contracts\Location\LocationContracts.cs |
| **Line coverage:** | 0% (0 of 10) |
| Covered lines: | 0 |
| Uncovered lines: | 10 |
| Coverable lines: | 10 |
| Total lines: | 111 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **.ctor(...)** | 100% | 2 | 1 | 0% |
| **get_Id()** | 100% | 2 | 1 | 0% |
| **get_Name()** | 100% | 2 | 1 | 0% |
| **get_Address()** | 100% | 2 | 1 | 0% |
| **get_Latitude()** | 100% | 2 | 1 | 0% |
| **get_Longitude()** | 100% | 2 | 1 | 0% |
| **get_DistanceMeters()** | 100% | 2 | 1 | 0% |
| **get_Category()** | 100% | 2 | 1 | 0% |
| **get_PhoneNumber()** | 100% | 2 | 1 | 0% |
| **get_Website()** | 100% | 2 | 1 | 0% |

## File(s)

### E:\github\FunWasHad\src\FWH.Orchestrix.Contracts\Location\LocationContracts.cs
```
  1           using FWH.Orchestrix.Contracts.Mediator;
  2           
  3           namespace FWH.Orchestrix.Contracts.Location;
  4           
  5           /// <summary>
  6           /// Base request for location-related operations.
  7           /// </summary>
  8           public abstract record LocationRequest : IMediatorRequest<LocationResponse>;
  9           
 10           /// <summary>
 11           /// Base response for location-related operations.
 12           /// </summary>
 13           public record LocationResponse
 14           {
 15               public bool Success { get; init; }
 16               public string? ErrorMessage { get; init; }
 17           }
 18           
 19           /// <summary>
 20           /// Request to update device location.
 21           /// </summary>
 22           public record UpdateDeviceLocationRequest : IMediatorRequest<UpdateDeviceLocationResponse>
 23           {
 24               public required string DeviceId { get; init; }
 25               public double Latitude { get; init; }
 26               public double Longitude { get; init; }
 27               public double? Accuracy { get; init; }
 28               public double? Altitude { get; init; }
 29               public double? Speed { get; init; }
 30               public double? Heading { get; init; }
 31               public DateTimeOffset Timestamp { get; init; }
 32           }
 33           
 34           /// <summary>
 35           /// Response to update device location.
 36           /// </summary>
 37           public record UpdateDeviceLocationResponse : LocationResponse
 38           {
 39               public long? LocationId { get; init; }
 40           }
 41           
 42           /// <summary>
 43           /// Request to get device location history.
 44           /// </summary>
 45           public record GetDeviceLocationHistoryRequest : IMediatorRequest<GetDeviceLocationHistoryResponse>
 46           {
 47               public required string DeviceId { get; init; }
 48               public DateTimeOffset? Since { get; init; }
 49               public DateTimeOffset? Until { get; init; }
 50               public int? Limit { get; init; }
 51           }
 52           
 53           /// <summary>
 54           /// Response to get device location history.
 55           /// </summary>
 56           public record GetDeviceLocationHistoryResponse : LocationResponse
 57           {
 58               public List<DeviceLocationDto> Locations { get; init; } = new();
 59           }
 60           
 61           /// <summary>
 62           /// Request to get nearby businesses.
 63           /// </summary>
 64           public record GetNearbyBusinessesRequest : IMediatorRequest<GetNearbyBusinessesResponse>
 65           {
 66               public double Latitude { get; init; }
 67               public double Longitude { get; init; }
 68               public int RadiusMeters { get; init; } = 100;
 69               public string[]? Tags { get; init; }
 70           }
 71           
 72           /// <summary>
 73           /// Response to get nearby businesses.
 74           /// </summary>
 75           public record GetNearbyBusinessesResponse : LocationResponse
 76           {
 77               public List<BusinessDto> Businesses { get; init; } = new();
 78               public int TotalCount { get; init; }
 79           }
 80           
 81           /// <summary>
 82           /// DTO for device location.
 83           /// </summary>
 84           public record DeviceLocationDto
 85           {
 86               public long Id { get; init; }
 87               public required string DeviceId { get; init; }
 88               public double Latitude { get; init; }
 89               public double Longitude { get; init; }
 90               public double? Accuracy { get; init; }
 91               public double? Altitude { get; init; }
 92               public double? Speed { get; init; }
 93               public double? Heading { get; init; }
 94               public DateTimeOffset Timestamp { get; init; }
 95           }
 96           
 97           /// <summary>
 98           /// DTO for business information.
 99           /// </summary>
100  ❌ 0     public record BusinessDto
101           {
102  ❌ 0         public long Id { get; init; }
103  ❌ 0         public required string Name { get; init; }
104  ❌ 0         public required string Address { get; init; }
105  ❌ 0         public double Latitude { get; init; }
106  ❌ 0         public double Longitude { get; init; }
107  ❌ 0         public double? DistanceMeters { get; init; }
108  ❌ 0         public string? Category { get; init; }
109  ❌ 0         public string? PhoneNumber { get; init; }
110  ❌ 0         public string? Website { get; init; }
111           }
```
# FWH.Orchestrix.Contracts.Location.DeviceLocationDto

## Summary

|||
|:---|:---|
| Class: | FWH.Orchestrix.Contracts.Location.DeviceLocationDto |
| Assembly: | FWH.Orchestrix.Contracts |
| **File(s):** | E:\github\FunWasHad\src\FWH.Orchestrix.Contracts\Location\LocationContracts.cs |
| **Line coverage:** | 0% (0 of 10) |
| Covered lines: | 0 |
| Uncovered lines: | 10 |
| Coverable lines: | 10 |
| Total lines: | 111 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **.ctor(...)** | 100% | 2 | 1 | 0% |
| **get_Id()** | 100% | 2 | 1 | 0% |
| **get_DeviceId()** | 100% | 2 | 1 | 0% |
| **get_Latitude()** | 100% | 2 | 1 | 0% |
| **get_Longitude()** | 100% | 2 | 1 | 0% |
| **get_Accuracy()** | 100% | 2 | 1 | 0% |
| **get_Altitude()** | 100% | 2 | 1 | 0% |
| **get_Speed()** | 100% | 2 | 1 | 0% |
| **get_Heading()** | 100% | 2 | 1 | 0% |
| **get_Timestamp()** | 100% | 2 | 1 | 0% |

## File(s)

### E:\github\FunWasHad\src\FWH.Orchestrix.Contracts\Location\LocationContracts.cs
```
  1           using FWH.Orchestrix.Contracts.Mediator;
  2           
  3           namespace FWH.Orchestrix.Contracts.Location;
  4           
  5           /// <summary>
  6           /// Base request for location-related operations.
  7           /// </summary>
  8           public abstract record LocationRequest : IMediatorRequest<LocationResponse>;
  9           
 10           /// <summary>
 11           /// Base response for location-related operations.
 12           /// </summary>
 13           public record LocationResponse
 14           {
 15               public bool Success { get; init; }
 16               public string? ErrorMessage { get; init; }
 17           }
 18           
 19           /// <summary>
 20           /// Request to update device location.
 21           /// </summary>
 22           public record UpdateDeviceLocationRequest : IMediatorRequest<UpdateDeviceLocationResponse>
 23           {
 24               public required string DeviceId { get; init; }
 25               public double Latitude { get; init; }
 26               public double Longitude { get; init; }
 27               public double? Accuracy { get; init; }
 28               public double? Altitude { get; init; }
 29               public double? Speed { get; init; }
 30               public double? Heading { get; init; }
 31               public DateTimeOffset Timestamp { get; init; }
 32           }
 33           
 34           /// <summary>
 35           /// Response to update device location.
 36           /// </summary>
 37           public record UpdateDeviceLocationResponse : LocationResponse
 38           {
 39               public long? LocationId { get; init; }
 40           }
 41           
 42           /// <summary>
 43           /// Request to get device location history.
 44           /// </summary>
 45           public record GetDeviceLocationHistoryRequest : IMediatorRequest<GetDeviceLocationHistoryResponse>
 46           {
 47               public required string DeviceId { get; init; }
 48               public DateTimeOffset? Since { get; init; }
 49               public DateTimeOffset? Until { get; init; }
 50               public int? Limit { get; init; }
 51           }
 52           
 53           /// <summary>
 54           /// Response to get device location history.
 55           /// </summary>
 56           public record GetDeviceLocationHistoryResponse : LocationResponse
 57           {
 58               public List<DeviceLocationDto> Locations { get; init; } = new();
 59           }
 60           
 61           /// <summary>
 62           /// Request to get nearby businesses.
 63           /// </summary>
 64           public record GetNearbyBusinessesRequest : IMediatorRequest<GetNearbyBusinessesResponse>
 65           {
 66               public double Latitude { get; init; }
 67               public double Longitude { get; init; }
 68               public int RadiusMeters { get; init; } = 100;
 69               public string[]? Tags { get; init; }
 70           }
 71           
 72           /// <summary>
 73           /// Response to get nearby businesses.
 74           /// </summary>
 75           public record GetNearbyBusinessesResponse : LocationResponse
 76           {
 77               public List<BusinessDto> Businesses { get; init; } = new();
 78               public int TotalCount { get; init; }
 79           }
 80           
 81           /// <summary>
 82           /// DTO for device location.
 83           /// </summary>
 84  ❌ 0     public record DeviceLocationDto
 85           {
 86  ❌ 0         public long Id { get; init; }
 87  ❌ 0         public required string DeviceId { get; init; }
 88  ❌ 0         public double Latitude { get; init; }
 89  ❌ 0         public double Longitude { get; init; }
 90  ❌ 0         public double? Accuracy { get; init; }
 91  ❌ 0         public double? Altitude { get; init; }
 92  ❌ 0         public double? Speed { get; init; }
 93  ❌ 0         public double? Heading { get; init; }
 94  ❌ 0         public DateTimeOffset Timestamp { get; init; }
 95           }
 96           
 97           /// <summary>
 98           /// DTO for business information.
 99           /// </summary>
100           public record BusinessDto
101           {
102               public long Id { get; init; }
103               public required string Name { get; init; }
104               public required string Address { get; init; }
105               public double Latitude { get; init; }
106               public double Longitude { get; init; }
107               public double? DistanceMeters { get; init; }
108               public string? Category { get; init; }
109               public string? PhoneNumber { get; init; }
110               public string? Website { get; init; }
111           }
```
# FWH.Orchestrix.Contracts.Location.GetDeviceLocationHistoryRequest

## Summary

|||
|:---|:---|
| Class: | FWH.Orchestrix.Contracts.Location.GetDeviceLocationHistoryRequest |
| Assembly: | FWH.Orchestrix.Contracts |
| **File(s):** | E:\github\FunWasHad\src\FWH.Orchestrix.Contracts\Location\LocationContracts.cs |
| **Line coverage:** | 0% (0 of 5) |
| Covered lines: | 0 |
| Uncovered lines: | 5 |
| Coverable lines: | 5 |
| Total lines: | 111 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **.ctor(...)** | 100% | 2 | 1 | 0% |
| **get_DeviceId()** | 100% | 2 | 1 | 0% |
| **get_Since()** | 100% | 2 | 1 | 0% |
| **get_Until()** | 100% | 2 | 1 | 0% |
| **get_Limit()** | 100% | 2 | 1 | 0% |

## File(s)

### E:\github\FunWasHad\src\FWH.Orchestrix.Contracts\Location\LocationContracts.cs
```
  1           using FWH.Orchestrix.Contracts.Mediator;
  2           
  3           namespace FWH.Orchestrix.Contracts.Location;
  4           
  5           /// <summary>
  6           /// Base request for location-related operations.
  7           /// </summary>
  8           public abstract record LocationRequest : IMediatorRequest<LocationResponse>;
  9           
 10           /// <summary>
 11           /// Base response for location-related operations.
 12           /// </summary>
 13           public record LocationResponse
 14           {
 15               public bool Success { get; init; }
 16               public string? ErrorMessage { get; init; }
 17           }
 18           
 19           /// <summary>
 20           /// Request to update device location.
 21           /// </summary>
 22           public record UpdateDeviceLocationRequest : IMediatorRequest<UpdateDeviceLocationResponse>
 23           {
 24               public required string DeviceId { get; init; }
 25               public double Latitude { get; init; }
 26               public double Longitude { get; init; }
 27               public double? Accuracy { get; init; }
 28               public double? Altitude { get; init; }
 29               public double? Speed { get; init; }
 30               public double? Heading { get; init; }
 31               public DateTimeOffset Timestamp { get; init; }
 32           }
 33           
 34           /// <summary>
 35           /// Response to update device location.
 36           /// </summary>
 37           public record UpdateDeviceLocationResponse : LocationResponse
 38           {
 39               public long? LocationId { get; init; }
 40           }
 41           
 42           /// <summary>
 43           /// Request to get device location history.
 44           /// </summary>
 45  ❌ 0     public record GetDeviceLocationHistoryRequest : IMediatorRequest<GetDeviceLocationHistoryResponse>
 46           {
 47  ❌ 0         public required string DeviceId { get; init; }
 48  ❌ 0         public DateTimeOffset? Since { get; init; }
 49  ❌ 0         public DateTimeOffset? Until { get; init; }
 50  ❌ 0         public int? Limit { get; init; }
 51           }
 52           
 53           /// <summary>
 54           /// Response to get device location history.
 55           /// </summary>
 56           public record GetDeviceLocationHistoryResponse : LocationResponse
 57           {
 58               public List<DeviceLocationDto> Locations { get; init; } = new();
 59           }
 60           
 61           /// <summary>
 62           /// Request to get nearby businesses.
 63           /// </summary>
 64           public record GetNearbyBusinessesRequest : IMediatorRequest<GetNearbyBusinessesResponse>
 65           {
 66               public double Latitude { get; init; }
 67               public double Longitude { get; init; }
 68               public int RadiusMeters { get; init; } = 100;
 69               public string[]? Tags { get; init; }
 70           }
 71           
 72           /// <summary>
 73           /// Response to get nearby businesses.
 74           /// </summary>
 75           public record GetNearbyBusinessesResponse : LocationResponse
 76           {
 77               public List<BusinessDto> Businesses { get; init; } = new();
 78               public int TotalCount { get; init; }
 79           }
 80           
 81           /// <summary>
 82           /// DTO for device location.
 83           /// </summary>
 84           public record DeviceLocationDto
 85           {
 86               public long Id { get; init; }
 87               public required string DeviceId { get; init; }
 88               public double Latitude { get; init; }
 89               public double Longitude { get; init; }
 90               public double? Accuracy { get; init; }
 91               public double? Altitude { get; init; }
 92               public double? Speed { get; init; }
 93               public double? Heading { get; init; }
 94               public DateTimeOffset Timestamp { get; init; }
 95           }
 96           
 97           /// <summary>
 98           /// DTO for business information.
 99           /// </summary>
100           public record BusinessDto
101           {
102               public long Id { get; init; }
103               public required string Name { get; init; }
104               public required string Address { get; init; }
105               public double Latitude { get; init; }
106               public double Longitude { get; init; }
107               public double? DistanceMeters { get; init; }
108               public string? Category { get; init; }
109               public string? PhoneNumber { get; init; }
110               public string? Website { get; init; }
111           }
```
# FWH.Orchestrix.Contracts.Location.GetDeviceLocationHistoryResponse

## Summary

|||
|:---|:---|
| Class: | FWH.Orchestrix.Contracts.Location.GetDeviceLocationHistoryResponse |
| Assembly: | FWH.Orchestrix.Contracts |
| **File(s):** | E:\github\FunWasHad\src\FWH.Orchestrix.Contracts\Location\LocationContracts.cs |
| **Line coverage:** | 0% (0 of 2) |
| Covered lines: | 0 |
| Uncovered lines: | 2 |
| Coverable lines: | 2 |
| Total lines: | 111 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **.ctor(...)** | 100% | 2 | 1 | 0% |
| **get_Locations()** | 100% | 2 | 1 | 0% |

## File(s)

### E:\github\FunWasHad\src\FWH.Orchestrix.Contracts\Location\LocationContracts.cs
```
  1           using FWH.Orchestrix.Contracts.Mediator;
  2           
  3           namespace FWH.Orchestrix.Contracts.Location;
  4           
  5           /// <summary>
  6           /// Base request for location-related operations.
  7           /// </summary>
  8           public abstract record LocationRequest : IMediatorRequest<LocationResponse>;
  9           
 10           /// <summary>
 11           /// Base response for location-related operations.
 12           /// </summary>
 13           public record LocationResponse
 14           {
 15               public bool Success { get; init; }
 16               public string? ErrorMessage { get; init; }
 17           }
 18           
 19           /// <summary>
 20           /// Request to update device location.
 21           /// </summary>
 22           public record UpdateDeviceLocationRequest : IMediatorRequest<UpdateDeviceLocationResponse>
 23           {
 24               public required string DeviceId { get; init; }
 25               public double Latitude { get; init; }
 26               public double Longitude { get; init; }
 27               public double? Accuracy { get; init; }
 28               public double? Altitude { get; init; }
 29               public double? Speed { get; init; }
 30               public double? Heading { get; init; }
 31               public DateTimeOffset Timestamp { get; init; }
 32           }
 33           
 34           /// <summary>
 35           /// Response to update device location.
 36           /// </summary>
 37           public record UpdateDeviceLocationResponse : LocationResponse
 38           {
 39               public long? LocationId { get; init; }
 40           }
 41           
 42           /// <summary>
 43           /// Request to get device location history.
 44           /// </summary>
 45           public record GetDeviceLocationHistoryRequest : IMediatorRequest<GetDeviceLocationHistoryResponse>
 46           {
 47               public required string DeviceId { get; init; }
 48               public DateTimeOffset? Since { get; init; }
 49               public DateTimeOffset? Until { get; init; }
 50               public int? Limit { get; init; }
 51           }
 52           
 53           /// <summary>
 54           /// Response to get device location history.
 55           /// </summary>
 56  ❌ 0     public record GetDeviceLocationHistoryResponse : LocationResponse
 57           {
 58  ❌ 0         public List<DeviceLocationDto> Locations { get; init; } = new();
 59           }
 60           
 61           /// <summary>
 62           /// Request to get nearby businesses.
 63           /// </summary>
 64           public record GetNearbyBusinessesRequest : IMediatorRequest<GetNearbyBusinessesResponse>
 65           {
 66               public double Latitude { get; init; }
 67               public double Longitude { get; init; }
 68               public int RadiusMeters { get; init; } = 100;
 69               public string[]? Tags { get; init; }
 70           }
 71           
 72           /// <summary>
 73           /// Response to get nearby businesses.
 74           /// </summary>
 75           public record GetNearbyBusinessesResponse : LocationResponse
 76           {
 77               public List<BusinessDto> Businesses { get; init; } = new();
 78               public int TotalCount { get; init; }
 79           }
 80           
 81           /// <summary>
 82           /// DTO for device location.
 83           /// </summary>
 84           public record DeviceLocationDto
 85           {
 86               public long Id { get; init; }
 87               public required string DeviceId { get; init; }
 88               public double Latitude { get; init; }
 89               public double Longitude { get; init; }
 90               public double? Accuracy { get; init; }
 91               public double? Altitude { get; init; }
 92               public double? Speed { get; init; }
 93               public double? Heading { get; init; }
 94               public DateTimeOffset Timestamp { get; init; }
 95           }
 96           
 97           /// <summary>
 98           /// DTO for business information.
 99           /// </summary>
100           public record BusinessDto
101           {
102               public long Id { get; init; }
103               public required string Name { get; init; }
104               public required string Address { get; init; }
105               public double Latitude { get; init; }
106               public double Longitude { get; init; }
107               public double? DistanceMeters { get; init; }
108               public string? Category { get; init; }
109               public string? PhoneNumber { get; init; }
110               public string? Website { get; init; }
111           }
```
# FWH.Orchestrix.Contracts.Location.GetNearbyBusinessesRequest

## Summary

|||
|:---|:---|
| Class: | FWH.Orchestrix.Contracts.Location.GetNearbyBusinessesRequest |
| Assembly: | FWH.Orchestrix.Contracts |
| **File(s):** | E:\github\FunWasHad\src\FWH.Orchestrix.Contracts\Location\LocationContracts.cs |
| **Line coverage:** | 0% (0 of 5) |
| Covered lines: | 0 |
| Uncovered lines: | 5 |
| Coverable lines: | 5 |
| Total lines: | 111 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **.ctor(...)** | 100% | 2 | 1 | 0% |
| **get_Latitude()** | 100% | 2 | 1 | 0% |
| **get_Longitude()** | 100% | 2 | 1 | 0% |
| **get_RadiusMeters()** | 100% | 2 | 1 | 0% |
| **get_Tags()** | 100% | 2 | 1 | 0% |

## File(s)

### E:\github\FunWasHad\src\FWH.Orchestrix.Contracts\Location\LocationContracts.cs
```
  1           using FWH.Orchestrix.Contracts.Mediator;
  2           
  3           namespace FWH.Orchestrix.Contracts.Location;
  4           
  5           /// <summary>
  6           /// Base request for location-related operations.
  7           /// </summary>
  8           public abstract record LocationRequest : IMediatorRequest<LocationResponse>;
  9           
 10           /// <summary>
 11           /// Base response for location-related operations.
 12           /// </summary>
 13           public record LocationResponse
 14           {
 15               public bool Success { get; init; }
 16               public string? ErrorMessage { get; init; }
 17           }
 18           
 19           /// <summary>
 20           /// Request to update device location.
 21           /// </summary>
 22           public record UpdateDeviceLocationRequest : IMediatorRequest<UpdateDeviceLocationResponse>
 23           {
 24               public required string DeviceId { get; init; }
 25               public double Latitude { get; init; }
 26               public double Longitude { get; init; }
 27               public double? Accuracy { get; init; }
 28               public double? Altitude { get; init; }
 29               public double? Speed { get; init; }
 30               public double? Heading { get; init; }
 31               public DateTimeOffset Timestamp { get; init; }
 32           }
 33           
 34           /// <summary>
 35           /// Response to update device location.
 36           /// </summary>
 37           public record UpdateDeviceLocationResponse : LocationResponse
 38           {
 39               public long? LocationId { get; init; }
 40           }
 41           
 42           /// <summary>
 43           /// Request to get device location history.
 44           /// </summary>
 45           public record GetDeviceLocationHistoryRequest : IMediatorRequest<GetDeviceLocationHistoryResponse>
 46           {
 47               public required string DeviceId { get; init; }
 48               public DateTimeOffset? Since { get; init; }
 49               public DateTimeOffset? Until { get; init; }
 50               public int? Limit { get; init; }
 51           }
 52           
 53           /// <summary>
 54           /// Response to get device location history.
 55           /// </summary>
 56           public record GetDeviceLocationHistoryResponse : LocationResponse
 57           {
 58               public List<DeviceLocationDto> Locations { get; init; } = new();
 59           }
 60           
 61           /// <summary>
 62           /// Request to get nearby businesses.
 63           /// </summary>
 64  ❌ 0     public record GetNearbyBusinessesRequest : IMediatorRequest<GetNearbyBusinessesResponse>
 65           {
 66  ❌ 0         public double Latitude { get; init; }
 67  ❌ 0         public double Longitude { get; init; }
 68  ❌ 0         public int RadiusMeters { get; init; } = 100;
 69  ❌ 0         public string[]? Tags { get; init; }
 70           }
 71           
 72           /// <summary>
 73           /// Response to get nearby businesses.
 74           /// </summary>
 75           public record GetNearbyBusinessesResponse : LocationResponse
 76           {
 77               public List<BusinessDto> Businesses { get; init; } = new();
 78               public int TotalCount { get; init; }
 79           }
 80           
 81           /// <summary>
 82           /// DTO for device location.
 83           /// </summary>
 84           public record DeviceLocationDto
 85           {
 86               public long Id { get; init; }
 87               public required string DeviceId { get; init; }
 88               public double Latitude { get; init; }
 89               public double Longitude { get; init; }
 90               public double? Accuracy { get; init; }
 91               public double? Altitude { get; init; }
 92               public double? Speed { get; init; }
 93               public double? Heading { get; init; }
 94               public DateTimeOffset Timestamp { get; init; }
 95           }
 96           
 97           /// <summary>
 98           /// DTO for business information.
 99           /// </summary>
100           public record BusinessDto
101           {
102               public long Id { get; init; }
103               public required string Name { get; init; }
104               public required string Address { get; init; }
105               public double Latitude { get; init; }
106               public double Longitude { get; init; }
107               public double? DistanceMeters { get; init; }
108               public string? Category { get; init; }
109               public string? PhoneNumber { get; init; }
110               public string? Website { get; init; }
111           }
```
# FWH.Orchestrix.Contracts.Location.GetNearbyBusinessesResponse

## Summary

|||
|:---|:---|
| Class: | FWH.Orchestrix.Contracts.Location.GetNearbyBusinessesResponse |
| Assembly: | FWH.Orchestrix.Contracts |
| **File(s):** | E:\github\FunWasHad\src\FWH.Orchestrix.Contracts\Location\LocationContracts.cs |
| **Line coverage:** | 0% (0 of 3) |
| Covered lines: | 0 |
| Uncovered lines: | 3 |
| Coverable lines: | 3 |
| Total lines: | 111 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **.ctor(...)** | 100% | 2 | 1 | 0% |
| **get_Businesses()** | 100% | 2 | 1 | 0% |
| **get_TotalCount()** | 100% | 2 | 1 | 0% |

## File(s)

### E:\github\FunWasHad\src\FWH.Orchestrix.Contracts\Location\LocationContracts.cs
```
  1           using FWH.Orchestrix.Contracts.Mediator;
  2           
  3           namespace FWH.Orchestrix.Contracts.Location;
  4           
  5           /// <summary>
  6           /// Base request for location-related operations.
  7           /// </summary>
  8           public abstract record LocationRequest : IMediatorRequest<LocationResponse>;
  9           
 10           /// <summary>
 11           /// Base response for location-related operations.
 12           /// </summary>
 13           public record LocationResponse
 14           {
 15               public bool Success { get; init; }
 16               public string? ErrorMessage { get; init; }
 17           }
 18           
 19           /// <summary>
 20           /// Request to update device location.
 21           /// </summary>
 22           public record UpdateDeviceLocationRequest : IMediatorRequest<UpdateDeviceLocationResponse>
 23           {
 24               public required string DeviceId { get; init; }
 25               public double Latitude { get; init; }
 26               public double Longitude { get; init; }
 27               public double? Accuracy { get; init; }
 28               public double? Altitude { get; init; }
 29               public double? Speed { get; init; }
 30               public double? Heading { get; init; }
 31               public DateTimeOffset Timestamp { get; init; }
 32           }
 33           
 34           /// <summary>
 35           /// Response to update device location.
 36           /// </summary>
 37           public record UpdateDeviceLocationResponse : LocationResponse
 38           {
 39               public long? LocationId { get; init; }
 40           }
 41           
 42           /// <summary>
 43           /// Request to get device location history.
 44           /// </summary>
 45           public record GetDeviceLocationHistoryRequest : IMediatorRequest<GetDeviceLocationHistoryResponse>
 46           {
 47               public required string DeviceId { get; init; }
 48               public DateTimeOffset? Since { get; init; }
 49               public DateTimeOffset? Until { get; init; }
 50               public int? Limit { get; init; }
 51           }
 52           
 53           /// <summary>
 54           /// Response to get device location history.
 55           /// </summary>
 56           public record GetDeviceLocationHistoryResponse : LocationResponse
 57           {
 58               public List<DeviceLocationDto> Locations { get; init; } = new();
 59           }
 60           
 61           /// <summary>
 62           /// Request to get nearby businesses.
 63           /// </summary>
 64           public record GetNearbyBusinessesRequest : IMediatorRequest<GetNearbyBusinessesResponse>
 65           {
 66               public double Latitude { get; init; }
 67               public double Longitude { get; init; }
 68               public int RadiusMeters { get; init; } = 100;
 69               public string[]? Tags { get; init; }
 70           }
 71           
 72           /// <summary>
 73           /// Response to get nearby businesses.
 74           /// </summary>
 75  ❌ 0     public record GetNearbyBusinessesResponse : LocationResponse
 76           {
 77  ❌ 0         public List<BusinessDto> Businesses { get; init; } = new();
 78  ❌ 0         public int TotalCount { get; init; }
 79           }
 80           
 81           /// <summary>
 82           /// DTO for device location.
 83           /// </summary>
 84           public record DeviceLocationDto
 85           {
 86               public long Id { get; init; }
 87               public required string DeviceId { get; init; }
 88               public double Latitude { get; init; }
 89               public double Longitude { get; init; }
 90               public double? Accuracy { get; init; }
 91               public double? Altitude { get; init; }
 92               public double? Speed { get; init; }
 93               public double? Heading { get; init; }
 94               public DateTimeOffset Timestamp { get; init; }
 95           }
 96           
 97           /// <summary>
 98           /// DTO for business information.
 99           /// </summary>
100           public record BusinessDto
101           {
102               public long Id { get; init; }
103               public required string Name { get; init; }
104               public required string Address { get; init; }
105               public double Latitude { get; init; }
106               public double Longitude { get; init; }
107               public double? DistanceMeters { get; init; }
108               public string? Category { get; init; }
109               public string? PhoneNumber { get; init; }
110               public string? Website { get; init; }
111           }
```
# FWH.Orchestrix.Contracts.Location.LocationRequest

## Summary

|||
|:---|:---|
| Class: | FWH.Orchestrix.Contracts.Location.LocationRequest |
| Assembly: | FWH.Orchestrix.Contracts |
| **File(s):** | E:\github\FunWasHad\src\FWH.Orchestrix.Contracts\Location\LocationContracts.cs |
| **Line coverage:** | 0% (0 of 1) |
| Covered lines: | 0 |
| Uncovered lines: | 1 |
| Coverable lines: | 1 |
| Total lines: | 111 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **.ctor(...)** | 100% | 2 | 1 | 0% |

## File(s)

### E:\github\FunWasHad\src\FWH.Orchestrix.Contracts\Location\LocationContracts.cs
```
  1           using FWH.Orchestrix.Contracts.Mediator;
  2           
  3           namespace FWH.Orchestrix.Contracts.Location;
  4           
  5           /// <summary>
  6           /// Base request for location-related operations.
  7           /// </summary>
  8  ❌ 0     public abstract record LocationRequest : IMediatorRequest<LocationResponse>;
  9           
 10           /// <summary>
 11           /// Base response for location-related operations.
 12           /// </summary>
 13           public record LocationResponse
 14           {
 15               public bool Success { get; init; }
 16               public string? ErrorMessage { get; init; }
 17           }
 18           
 19           /// <summary>
 20           /// Request to update device location.
 21           /// </summary>
 22           public record UpdateDeviceLocationRequest : IMediatorRequest<UpdateDeviceLocationResponse>
 23           {
 24               public required string DeviceId { get; init; }
 25               public double Latitude { get; init; }
 26               public double Longitude { get; init; }
 27               public double? Accuracy { get; init; }
 28               public double? Altitude { get; init; }
 29               public double? Speed { get; init; }
 30               public double? Heading { get; init; }
 31               public DateTimeOffset Timestamp { get; init; }
 32           }
 33           
 34           /// <summary>
 35           /// Response to update device location.
 36           /// </summary>
 37           public record UpdateDeviceLocationResponse : LocationResponse
 38           {
 39               public long? LocationId { get; init; }
 40           }
 41           
 42           /// <summary>
 43           /// Request to get device location history.
 44           /// </summary>
 45           public record GetDeviceLocationHistoryRequest : IMediatorRequest<GetDeviceLocationHistoryResponse>
 46           {
 47               public required string DeviceId { get; init; }
 48               public DateTimeOffset? Since { get; init; }
 49               public DateTimeOffset? Until { get; init; }
 50               public int? Limit { get; init; }
 51           }
 52           
 53           /// <summary>
 54           /// Response to get device location history.
 55           /// </summary>
 56           public record GetDeviceLocationHistoryResponse : LocationResponse
 57           {
 58               public List<DeviceLocationDto> Locations { get; init; } = new();
 59           }
 60           
 61           /// <summary>
 62           /// Request to get nearby businesses.
 63           /// </summary>
 64           public record GetNearbyBusinessesRequest : IMediatorRequest<GetNearbyBusinessesResponse>
 65           {
 66               public double Latitude { get; init; }
 67               public double Longitude { get; init; }
 68               public int RadiusMeters { get; init; } = 100;
 69               public string[]? Tags { get; init; }
 70           }
 71           
 72           /// <summary>
 73           /// Response to get nearby businesses.
 74           /// </summary>
 75           public record GetNearbyBusinessesResponse : LocationResponse
 76           {
 77               public List<BusinessDto> Businesses { get; init; } = new();
 78               public int TotalCount { get; init; }
 79           }
 80           
 81           /// <summary>
 82           /// DTO for device location.
 83           /// </summary>
 84           public record DeviceLocationDto
 85           {
 86               public long Id { get; init; }
 87               public required string DeviceId { get; init; }
 88               public double Latitude { get; init; }
 89               public double Longitude { get; init; }
 90               public double? Accuracy { get; init; }
 91               public double? Altitude { get; init; }
 92               public double? Speed { get; init; }
 93               public double? Heading { get; init; }
 94               public DateTimeOffset Timestamp { get; init; }
 95           }
 96           
 97           /// <summary>
 98           /// DTO for business information.
 99           /// </summary>
100           public record BusinessDto
101           {
102               public long Id { get; init; }
103               public required string Name { get; init; }
104               public required string Address { get; init; }
105               public double Latitude { get; init; }
106               public double Longitude { get; init; }
107               public double? DistanceMeters { get; init; }
108               public string? Category { get; init; }
109               public string? PhoneNumber { get; init; }
110               public string? Website { get; init; }
111           }
```
# FWH.Orchestrix.Contracts.Location.LocationResponse

## Summary

|||
|:---|:---|
| Class: | FWH.Orchestrix.Contracts.Location.LocationResponse |
| Assembly: | FWH.Orchestrix.Contracts |
| **File(s):** | E:\github\FunWasHad\src\FWH.Orchestrix.Contracts\Location\LocationContracts.cs |
| **Line coverage:** | 0% (0 of 3) |
| Covered lines: | 0 |
| Uncovered lines: | 3 |
| Coverable lines: | 3 |
| Total lines: | 111 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **.ctor(...)** | 100% | 2 | 1 | 0% |
| **get_Success()** | 100% | 2 | 1 | 0% |
| **get_ErrorMessage()** | 100% | 2 | 1 | 0% |

## File(s)

### E:\github\FunWasHad\src\FWH.Orchestrix.Contracts\Location\LocationContracts.cs
```
  1           using FWH.Orchestrix.Contracts.Mediator;
  2           
  3           namespace FWH.Orchestrix.Contracts.Location;
  4           
  5           /// <summary>
  6           /// Base request for location-related operations.
  7           /// </summary>
  8           public abstract record LocationRequest : IMediatorRequest<LocationResponse>;
  9           
 10           /// <summary>
 11           /// Base response for location-related operations.
 12           /// </summary>
 13  ❌ 0     public record LocationResponse
 14           {
 15  ❌ 0         public bool Success { get; init; }
 16  ❌ 0         public string? ErrorMessage { get; init; }
 17           }
 18           
 19           /// <summary>
 20           /// Request to update device location.
 21           /// </summary>
 22           public record UpdateDeviceLocationRequest : IMediatorRequest<UpdateDeviceLocationResponse>
 23           {
 24               public required string DeviceId { get; init; }
 25               public double Latitude { get; init; }
 26               public double Longitude { get; init; }
 27               public double? Accuracy { get; init; }
 28               public double? Altitude { get; init; }
 29               public double? Speed { get; init; }
 30               public double? Heading { get; init; }
 31               public DateTimeOffset Timestamp { get; init; }
 32           }
 33           
 34           /// <summary>
 35           /// Response to update device location.
 36           /// </summary>
 37           public record UpdateDeviceLocationResponse : LocationResponse
 38           {
 39               public long? LocationId { get; init; }
 40           }
 41           
 42           /// <summary>
 43           /// Request to get device location history.
 44           /// </summary>
 45           public record GetDeviceLocationHistoryRequest : IMediatorRequest<GetDeviceLocationHistoryResponse>
 46           {
 47               public required string DeviceId { get; init; }
 48               public DateTimeOffset? Since { get; init; }
 49               public DateTimeOffset? Until { get; init; }
 50               public int? Limit { get; init; }
 51           }
 52           
 53           /// <summary>
 54           /// Response to get device location history.
 55           /// </summary>
 56           public record GetDeviceLocationHistoryResponse : LocationResponse
 57           {
 58               public List<DeviceLocationDto> Locations { get; init; } = new();
 59           }
 60           
 61           /// <summary>
 62           /// Request to get nearby businesses.
 63           /// </summary>
 64           public record GetNearbyBusinessesRequest : IMediatorRequest<GetNearbyBusinessesResponse>
 65           {
 66               public double Latitude { get; init; }
 67               public double Longitude { get; init; }
 68               public int RadiusMeters { get; init; } = 100;
 69               public string[]? Tags { get; init; }
 70           }
 71           
 72           /// <summary>
 73           /// Response to get nearby businesses.
 74           /// </summary>
 75           public record GetNearbyBusinessesResponse : LocationResponse
 76           {
 77               public List<BusinessDto> Businesses { get; init; } = new();
 78               public int TotalCount { get; init; }
 79           }
 80           
 81           /// <summary>
 82           /// DTO for device location.
 83           /// </summary>
 84           public record DeviceLocationDto
 85           {
 86               public long Id { get; init; }
 87               public required string DeviceId { get; init; }
 88               public double Latitude { get; init; }
 89               public double Longitude { get; init; }
 90               public double? Accuracy { get; init; }
 91               public double? Altitude { get; init; }
 92               public double? Speed { get; init; }
 93               public double? Heading { get; init; }
 94               public DateTimeOffset Timestamp { get; init; }
 95           }
 96           
 97           /// <summary>
 98           /// DTO for business information.
 99           /// </summary>
100           public record BusinessDto
101           {
102               public long Id { get; init; }
103               public required string Name { get; init; }
104               public required string Address { get; init; }
105               public double Latitude { get; init; }
106               public double Longitude { get; init; }
107               public double? DistanceMeters { get; init; }
108               public string? Category { get; init; }
109               public string? PhoneNumber { get; init; }
110               public string? Website { get; init; }
111           }
```
# FWH.Orchestrix.Contracts.Location.UpdateDeviceLocationRequest

## Summary

|||
|:---|:---|
| Class: | FWH.Orchestrix.Contracts.Location.UpdateDeviceLocationRequest |
| Assembly: | FWH.Orchestrix.Contracts |
| **File(s):** | E:\github\FunWasHad\src\FWH.Orchestrix.Contracts\Location\LocationContracts.cs |
| **Line coverage:** | 0% (0 of 9) |
| Covered lines: | 0 |
| Uncovered lines: | 9 |
| Coverable lines: | 9 |
| Total lines: | 111 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **.ctor(...)** | 100% | 2 | 1 | 0% |
| **get_DeviceId()** | 100% | 2 | 1 | 0% |
| **get_Latitude()** | 100% | 2 | 1 | 0% |
| **get_Longitude()** | 100% | 2 | 1 | 0% |
| **get_Accuracy()** | 100% | 2 | 1 | 0% |
| **get_Altitude()** | 100% | 2 | 1 | 0% |
| **get_Speed()** | 100% | 2 | 1 | 0% |
| **get_Heading()** | 100% | 2 | 1 | 0% |
| **get_Timestamp()** | 100% | 2 | 1 | 0% |

## File(s)

### E:\github\FunWasHad\src\FWH.Orchestrix.Contracts\Location\LocationContracts.cs
```
  1           using FWH.Orchestrix.Contracts.Mediator;
  2           
  3           namespace FWH.Orchestrix.Contracts.Location;
  4           
  5           /// <summary>
  6           /// Base request for location-related operations.
  7           /// </summary>
  8           public abstract record LocationRequest : IMediatorRequest<LocationResponse>;
  9           
 10           /// <summary>
 11           /// Base response for location-related operations.
 12           /// </summary>
 13           public record LocationResponse
 14           {
 15               public bool Success { get; init; }
 16               public string? ErrorMessage { get; init; }
 17           }
 18           
 19           /// <summary>
 20           /// Request to update device location.
 21           /// </summary>
 22  ❌ 0     public record UpdateDeviceLocationRequest : IMediatorRequest<UpdateDeviceLocationResponse>
 23           {
 24  ❌ 0         public required string DeviceId { get; init; }
 25  ❌ 0         public double Latitude { get; init; }
 26  ❌ 0         public double Longitude { get; init; }
 27  ❌ 0         public double? Accuracy { get; init; }
 28  ❌ 0         public double? Altitude { get; init; }
 29  ❌ 0         public double? Speed { get; init; }
 30  ❌ 0         public double? Heading { get; init; }
 31  ❌ 0         public DateTimeOffset Timestamp { get; init; }
 32           }
 33           
 34           /// <summary>
 35           /// Response to update device location.
 36           /// </summary>
 37           public record UpdateDeviceLocationResponse : LocationResponse
 38           {
 39               public long? LocationId { get; init; }
 40           }
 41           
 42           /// <summary>
 43           /// Request to get device location history.
 44           /// </summary>
 45           public record GetDeviceLocationHistoryRequest : IMediatorRequest<GetDeviceLocationHistoryResponse>
 46           {
 47               public required string DeviceId { get; init; }
 48               public DateTimeOffset? Since { get; init; }
 49               public DateTimeOffset? Until { get; init; }
 50               public int? Limit { get; init; }
 51           }
 52           
 53           /// <summary>
 54           /// Response to get device location history.
 55           /// </summary>
 56           public record GetDeviceLocationHistoryResponse : LocationResponse
 57           {
 58               public List<DeviceLocationDto> Locations { get; init; } = new();
 59           }
 60           
 61           /// <summary>
 62           /// Request to get nearby businesses.
 63           /// </summary>
 64           public record GetNearbyBusinessesRequest : IMediatorRequest<GetNearbyBusinessesResponse>
 65           {
 66               public double Latitude { get; init; }
 67               public double Longitude { get; init; }
 68               public int RadiusMeters { get; init; } = 100;
 69               public string[]? Tags { get; init; }
 70           }
 71           
 72           /// <summary>
 73           /// Response to get nearby businesses.
 74           /// </summary>
 75           public record GetNearbyBusinessesResponse : LocationResponse
 76           {
 77               public List<BusinessDto> Businesses { get; init; } = new();
 78               public int TotalCount { get; init; }
 79           }
 80           
 81           /// <summary>
 82           /// DTO for device location.
 83           /// </summary>
 84           public record DeviceLocationDto
 85           {
 86               public long Id { get; init; }
 87               public required string DeviceId { get; init; }
 88               public double Latitude { get; init; }
 89               public double Longitude { get; init; }
 90               public double? Accuracy { get; init; }
 91               public double? Altitude { get; init; }
 92               public double? Speed { get; init; }
 93               public double? Heading { get; init; }
 94               public DateTimeOffset Timestamp { get; init; }
 95           }
 96           
 97           /// <summary>
 98           /// DTO for business information.
 99           /// </summary>
100           public record BusinessDto
101           {
102               public long Id { get; init; }
103               public required string Name { get; init; }
104               public required string Address { get; init; }
105               public double Latitude { get; init; }
106               public double Longitude { get; init; }
107               public double? DistanceMeters { get; init; }
108               public string? Category { get; init; }
109               public string? PhoneNumber { get; init; }
110               public string? Website { get; init; }
111           }
```
# FWH.Orchestrix.Contracts.Location.UpdateDeviceLocationResponse

## Summary

|||
|:---|:---|
| Class: | FWH.Orchestrix.Contracts.Location.UpdateDeviceLocationResponse |
| Assembly: | FWH.Orchestrix.Contracts |
| **File(s):** | E:\github\FunWasHad\src\FWH.Orchestrix.Contracts\Location\LocationContracts.cs |
| **Line coverage:** | 0% (0 of 2) |
| Covered lines: | 0 |
| Uncovered lines: | 2 |
| Coverable lines: | 2 |
| Total lines: | 111 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **.ctor(...)** | 100% | 2 | 1 | 0% |
| **get_LocationId()** | 100% | 2 | 1 | 0% |

## File(s)

### E:\github\FunWasHad\src\FWH.Orchestrix.Contracts\Location\LocationContracts.cs
```
  1           using FWH.Orchestrix.Contracts.Mediator;
  2           
  3           namespace FWH.Orchestrix.Contracts.Location;
  4           
  5           /// <summary>
  6           /// Base request for location-related operations.
  7           /// </summary>
  8           public abstract record LocationRequest : IMediatorRequest<LocationResponse>;
  9           
 10           /// <summary>
 11           /// Base response for location-related operations.
 12           /// </summary>
 13           public record LocationResponse
 14           {
 15               public bool Success { get; init; }
 16               public string? ErrorMessage { get; init; }
 17           }
 18           
 19           /// <summary>
 20           /// Request to update device location.
 21           /// </summary>
 22           public record UpdateDeviceLocationRequest : IMediatorRequest<UpdateDeviceLocationResponse>
 23           {
 24               public required string DeviceId { get; init; }
 25               public double Latitude { get; init; }
 26               public double Longitude { get; init; }
 27               public double? Accuracy { get; init; }
 28               public double? Altitude { get; init; }
 29               public double? Speed { get; init; }
 30               public double? Heading { get; init; }
 31               public DateTimeOffset Timestamp { get; init; }
 32           }
 33           
 34           /// <summary>
 35           /// Response to update device location.
 36           /// </summary>
 37  ❌ 0     public record UpdateDeviceLocationResponse : LocationResponse
 38           {
 39  ❌ 0         public long? LocationId { get; init; }
 40           }
 41           
 42           /// <summary>
 43           /// Request to get device location history.
 44           /// </summary>
 45           public record GetDeviceLocationHistoryRequest : IMediatorRequest<GetDeviceLocationHistoryResponse>
 46           {
 47               public required string DeviceId { get; init; }
 48               public DateTimeOffset? Since { get; init; }
 49               public DateTimeOffset? Until { get; init; }
 50               public int? Limit { get; init; }
 51           }
 52           
 53           /// <summary>
 54           /// Response to get device location history.
 55           /// </summary>
 56           public record GetDeviceLocationHistoryResponse : LocationResponse
 57           {
 58               public List<DeviceLocationDto> Locations { get; init; } = new();
 59           }
 60           
 61           /// <summary>
 62           /// Request to get nearby businesses.
 63           /// </summary>
 64           public record GetNearbyBusinessesRequest : IMediatorRequest<GetNearbyBusinessesResponse>
 65           {
 66               public double Latitude { get; init; }
 67               public double Longitude { get; init; }
 68               public int RadiusMeters { get; init; } = 100;
 69               public string[]? Tags { get; init; }
 70           }
 71           
 72           /// <summary>
 73           /// Response to get nearby businesses.
 74           /// </summary>
 75           public record GetNearbyBusinessesResponse : LocationResponse
 76           {
 77               public List<BusinessDto> Businesses { get; init; } = new();
 78               public int TotalCount { get; init; }
 79           }
 80           
 81           /// <summary>
 82           /// DTO for device location.
 83           /// </summary>
 84           public record DeviceLocationDto
 85           {
 86               public long Id { get; init; }
 87               public required string DeviceId { get; init; }
 88               public double Latitude { get; init; }
 89               public double Longitude { get; init; }
 90               public double? Accuracy { get; init; }
 91               public double? Altitude { get; init; }
 92               public double? Speed { get; init; }
 93               public double? Heading { get; init; }
 94               public DateTimeOffset Timestamp { get; init; }
 95           }
 96           
 97           /// <summary>
 98           /// DTO for business information.
 99           /// </summary>
100           public record BusinessDto
101           {
102               public long Id { get; init; }
103               public required string Name { get; init; }
104               public required string Address { get; init; }
105               public double Latitude { get; init; }
106               public double Longitude { get; init; }
107               public double? DistanceMeters { get; init; }
108               public string? Category { get; init; }
109               public string? PhoneNumber { get; init; }
110               public string? Website { get; init; }
111           }
```
# FWH.Orchestrix.Contracts.Marketing.BusinessMarketingDto

## Summary

|||
|:---|:---|
| Class: | FWH.Orchestrix.Contracts.Marketing.BusinessMarketingDto |
| Assembly: | FWH.Orchestrix.Contracts |
| **File(s):** | E:\github\FunWasHad\src\FWH.Orchestrix.Contracts\Marketing\MarketingContracts.cs |
| **Line coverage:** | 0% (0 of 7) |
| Covered lines: | 0 |
| Uncovered lines: | 7 |
| Coverable lines: | 7 |
| Total lines: | 256 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **.ctor(...)** | 100% | 2 | 1 | 0% |
| **get_BusinessId()** | 100% | 2 | 1 | 0% |
| **get_BusinessName()** | 100% | 2 | 1 | 0% |
| **get_Theme()** | 100% | 2 | 1 | 0% |
| **get_Coupons()** | 100% | 2 | 1 | 0% |
| **get_MenuItems()** | 100% | 2 | 1 | 0% |
| **get_NewsItems()** | 100% | 2 | 1 | 0% |

## File(s)

### E:\github\FunWasHad\src\FWH.Orchestrix.Contracts\Marketing\MarketingContracts.cs
```
  1           using FWH.Orchestrix.Contracts.Mediator;
  2           
  3           namespace FWH.Orchestrix.Contracts.Marketing;
  4           
  5           /// <summary>
  6           /// Base response for marketing operations.
  7           /// </summary>
  8           public record MarketingResponse
  9           {
 10               public bool Success { get; init; }
 11               public string? ErrorMessage { get; init; }
 12           }
 13           
 14           /// <summary>
 15           /// Request to get business marketing data.
 16           /// </summary>
 17           public record GetBusinessMarketingRequest : IMediatorRequest<GetBusinessMarketingResponse>
 18           {
 19               public long BusinessId { get; init; }
 20           }
 21           
 22           /// <summary>
 23           /// Response to get business marketing data.
 24           /// </summary>
 25           public record GetBusinessMarketingResponse : MarketingResponse
 26           {
 27               public BusinessMarketingDto? Data { get; init; }
 28           }
 29           
 30           /// <summary>
 31           /// Request to get business theme.
 32           /// </summary>
 33           public record GetBusinessThemeRequest : IMediatorRequest<GetBusinessThemeResponse>
 34           {
 35               public long BusinessId { get; init; }
 36           }
 37           
 38           /// <summary>
 39           /// Response to get business theme.
 40           /// </summary>
 41           public record GetBusinessThemeResponse : MarketingResponse
 42           {
 43               public BusinessThemeDto? Theme { get; init; }
 44           }
 45           
 46           /// <summary>
 47           /// Request to get business coupons.
 48           /// </summary>
 49           public record GetBusinessCouponsRequest : IMediatorRequest<GetBusinessCouponsResponse>
 50           {
 51               public long BusinessId { get; init; }
 52           }
 53           
 54           /// <summary>
 55           /// Response to get business coupons.
 56           /// </summary>
 57           public record GetBusinessCouponsResponse : MarketingResponse
 58           {
 59               public List<CouponDto> Coupons { get; init; } = new();
 60           }
 61           
 62           /// <summary>
 63           /// Request to get business menu.
 64           /// </summary>
 65           public record GetBusinessMenuRequest : IMediatorRequest<GetBusinessMenuResponse>
 66           {
 67               public long BusinessId { get; init; }
 68               public string? Category { get; init; }
 69           }
 70           
 71           /// <summary>
 72           /// Response to get business menu.
 73           /// </summary>
 74           public record GetBusinessMenuResponse : MarketingResponse
 75           {
 76               public List<MenuItemDto> MenuItems { get; init; } = new();
 77           }
 78           
 79           /// <summary>
 80           /// Request to get business news.
 81           /// </summary>
 82           public record GetBusinessNewsRequest : IMediatorRequest<GetBusinessNewsResponse>
 83           {
 84               public long BusinessId { get; init; }
 85               public int Limit { get; init; } = 10;
 86           }
 87           
 88           /// <summary>
 89           /// Response to get business news.
 90           /// </summary>
 91           public record GetBusinessNewsResponse : MarketingResponse
 92           {
 93               public List<NewsItemDto> NewsItems { get; init; } = new();
 94           }
 95           
 96           /// <summary>
 97           /// Request to submit feedback.
 98           /// </summary>
 99           public record SubmitFeedbackRequest : IMediatorRequest<SubmitFeedbackResponse>
100           {
101               public long BusinessId { get; init; }
102               public required string UserId { get; init; }
103               public string? UserName { get; init; }
104               public string? UserEmail { get; init; }
105               public required string FeedbackType { get; init; }
106               public required string Subject { get; init; }
107               public required string Message { get; init; }
108               public int? Rating { get; init; }
109               public bool IsPublic { get; init; }
110               public double? Latitude { get; init; }
111               public double? Longitude { get; init; }
112           }
113           
114           /// <summary>
115           /// Response to submit feedback.
116           /// </summary>
117           public record SubmitFeedbackResponse : MarketingResponse
118           {
119               public long? FeedbackId { get; init; }
120           }
121           
122           /// <summary>
123           /// Request to upload feedback attachment.
124           /// </summary>
125           public record UploadFeedbackAttachmentRequest : IMediatorRequest<UploadFeedbackAttachmentResponse>
126           {
127               public long FeedbackId { get; init; }
128               public required string AttachmentType { get; init; } // "image" or "video"
129               public required string FileName { get; init; }
130               public required string ContentType { get; init; }
131               public required byte[] FileData { get; init; }
132           }
133           
134           /// <summary>
135           /// Response to upload feedback attachment.
136           /// </summary>
137           public record UploadFeedbackAttachmentResponse : MarketingResponse
138           {
139               public long? AttachmentId { get; init; }
140               public string? StorageUrl { get; init; }
141           }
142           
143           /// <summary>
144           /// Request to find nearby businesses.
145           /// </summary>
146           public record FindNearbyBusinessesRequest : IMediatorRequest<FindNearbyBusinessesResponse>
147           {
148               public double Latitude { get; init; }
149               public double Longitude { get; init; }
150               public int RadiusMeters { get; init; } = 1000;
151           }
152           
153           /// <summary>
154           /// Response to find nearby businesses.
155           /// </summary>
156           public record FindNearbyBusinessesResponse : MarketingResponse
157           {
158               public List<BusinessSummaryDto> Businesses { get; init; } = new();
159           }
160           
161           // DTOs
162           
163           /// <summary>
164           /// Complete business marketing data.
165           /// </summary>
166  ❌ 0     public record BusinessMarketingDto
167           {
168  ❌ 0         public long BusinessId { get; init; }
169  ❌ 0         public required string BusinessName { get; init; }
170  ❌ 0         public BusinessThemeDto? Theme { get; init; }
171  ❌ 0         public List<CouponDto> Coupons { get; init; } = new();
172  ❌ 0         public List<MenuItemDto> MenuItems { get; init; } = new();
173  ❌ 0         public List<NewsItemDto> NewsItems { get; init; } = new();
174           }
175           
176           /// <summary>
177           /// Business theme data.
178           /// </summary>
179           public record BusinessThemeDto
180           {
181               public long Id { get; init; }
182               public long BusinessId { get; init; }
183               public required string ThemeName { get; init; }
184               public string? PrimaryColor { get; init; }
185               public string? SecondaryColor { get; init; }
186               public string? AccentColor { get; init; }
187               public string? BackgroundColor { get; init; }
188               public string? TextColor { get; init; }
189               public string? LogoUrl { get; init; }
190               public string? BackgroundImageUrl { get; init; }
191               public string? CustomCss { get; init; }
192           }
193           
194           /// <summary>
195           /// Coupon data.
196           /// </summary>
197           public record CouponDto
198           {
199               public long Id { get; init; }
200               public required string Title { get; init; }
201               public required string Description { get; init; }
202               public string? Code { get; init; }
203               public decimal? DiscountAmount { get; init; }
204               public decimal? DiscountPercentage { get; init; }
205               public string? ImageUrl { get; init; }
206               public DateTimeOffset ValidFrom { get; init; }
207               public DateTimeOffset ValidUntil { get; init; }
208               public int? MaxRedemptions { get; init; }
209               public int CurrentRedemptions { get; init; }
210           }
211           
212           /// <summary>
213           /// Menu item data.
214           /// </summary>
215           public record MenuItemDto
216           {
217               public long Id { get; init; }
218               public required string Name { get; init; }
219               public string? Description { get; init; }
220               public required string Category { get; init; }
221               public decimal? Price { get; init; }
222               public string? Currency { get; init; }
223               public string? ImageUrl { get; init; }
224               public int? Calories { get; init; }
225               public string? Allergens { get; init; }
226               public string? DietaryTags { get; init; }
227           }
228           
229           /// <summary>
230           /// News item data.
231           /// </summary>
232           public record NewsItemDto
233           {
234               public long Id { get; init; }
235               public required string Title { get; init; }
236               public required string Content { get; init; }
237               public string? Summary { get; init; }
238               public string? ImageUrl { get; init; }
239               public string? Author { get; init; }
240               public DateTimeOffset PublishedAt { get; init; }
241               public bool IsFeatured { get; init; }
242           }
243           
244           /// <summary>
245           /// Business summary data.
246           /// </summary>
247           public record BusinessSummaryDto
248           {
249               public long Id { get; init; }
250               public required string Name { get; init; }
251               public required string Address { get; init; }
252               public double Latitude { get; init; }
253               public double Longitude { get; init; }
254               public double? DistanceMeters { get; init; }
255               public bool IsSubscribed { get; init; }
256           }
```
# FWH.Orchestrix.Contracts.Marketing.BusinessSummaryDto

## Summary

|||
|:---|:---|
| Class: | FWH.Orchestrix.Contracts.Marketing.BusinessSummaryDto |
| Assembly: | FWH.Orchestrix.Contracts |
| **File(s):** | E:\github\FunWasHad\src\FWH.Orchestrix.Contracts\Marketing\MarketingContracts.cs |
| **Line coverage:** | 0% (0 of 8) |
| Covered lines: | 0 |
| Uncovered lines: | 8 |
| Coverable lines: | 8 |
| Total lines: | 256 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **.ctor(...)** | 100% | 2 | 1 | 0% |
| **get_Id()** | 100% | 2 | 1 | 0% |
| **get_Name()** | 100% | 2 | 1 | 0% |
| **get_Address()** | 100% | 2 | 1 | 0% |
| **get_Latitude()** | 100% | 2 | 1 | 0% |
| **get_Longitude()** | 100% | 2 | 1 | 0% |
| **get_DistanceMeters()** | 100% | 2 | 1 | 0% |
| **get_IsSubscribed()** | 100% | 2 | 1 | 0% |

## File(s)

### E:\github\FunWasHad\src\FWH.Orchestrix.Contracts\Marketing\MarketingContracts.cs
```
  1           using FWH.Orchestrix.Contracts.Mediator;
  2           
  3           namespace FWH.Orchestrix.Contracts.Marketing;
  4           
  5           /// <summary>
  6           /// Base response for marketing operations.
  7           /// </summary>
  8           public record MarketingResponse
  9           {
 10               public bool Success { get; init; }
 11               public string? ErrorMessage { get; init; }
 12           }
 13           
 14           /// <summary>
 15           /// Request to get business marketing data.
 16           /// </summary>
 17           public record GetBusinessMarketingRequest : IMediatorRequest<GetBusinessMarketingResponse>
 18           {
 19               public long BusinessId { get; init; }
 20           }
 21           
 22           /// <summary>
 23           /// Response to get business marketing data.
 24           /// </summary>
 25           public record GetBusinessMarketingResponse : MarketingResponse
 26           {
 27               public BusinessMarketingDto? Data { get; init; }
 28           }
 29           
 30           /// <summary>
 31           /// Request to get business theme.
 32           /// </summary>
 33           public record GetBusinessThemeRequest : IMediatorRequest<GetBusinessThemeResponse>
 34           {
 35               public long BusinessId { get; init; }
 36           }
 37           
 38           /// <summary>
 39           /// Response to get business theme.
 40           /// </summary>
 41           public record GetBusinessThemeResponse : MarketingResponse
 42           {
 43               public BusinessThemeDto? Theme { get; init; }
 44           }
 45           
 46           /// <summary>
 47           /// Request to get business coupons.
 48           /// </summary>
 49           public record GetBusinessCouponsRequest : IMediatorRequest<GetBusinessCouponsResponse>
 50           {
 51               public long BusinessId { get; init; }
 52           }
 53           
 54           /// <summary>
 55           /// Response to get business coupons.
 56           /// </summary>
 57           public record GetBusinessCouponsResponse : MarketingResponse
 58           {
 59               public List<CouponDto> Coupons { get; init; } = new();
 60           }
 61           
 62           /// <summary>
 63           /// Request to get business menu.
 64           /// </summary>
 65           public record GetBusinessMenuRequest : IMediatorRequest<GetBusinessMenuResponse>
 66           {
 67               public long BusinessId { get; init; }
 68               public string? Category { get; init; }
 69           }
 70           
 71           /// <summary>
 72           /// Response to get business menu.
 73           /// </summary>
 74           public record GetBusinessMenuResponse : MarketingResponse
 75           {
 76               public List<MenuItemDto> MenuItems { get; init; } = new();
 77           }
 78           
 79           /// <summary>
 80           /// Request to get business news.
 81           /// </summary>
 82           public record GetBusinessNewsRequest : IMediatorRequest<GetBusinessNewsResponse>
 83           {
 84               public long BusinessId { get; init; }
 85               public int Limit { get; init; } = 10;
 86           }
 87           
 88           /// <summary>
 89           /// Response to get business news.
 90           /// </summary>
 91           public record GetBusinessNewsResponse : MarketingResponse
 92           {
 93               public List<NewsItemDto> NewsItems { get; init; } = new();
 94           }
 95           
 96           /// <summary>
 97           /// Request to submit feedback.
 98           /// </summary>
 99           public record SubmitFeedbackRequest : IMediatorRequest<SubmitFeedbackResponse>
100           {
101               public long BusinessId { get; init; }
102               public required string UserId { get; init; }
103               public string? UserName { get; init; }
104               public string? UserEmail { get; init; }
105               public required string FeedbackType { get; init; }
106               public required string Subject { get; init; }
107               public required string Message { get; init; }
108               public int? Rating { get; init; }
109               public bool IsPublic { get; init; }
110               public double? Latitude { get; init; }
111               public double? Longitude { get; init; }
112           }
113           
114           /// <summary>
115           /// Response to submit feedback.
116           /// </summary>
117           public record SubmitFeedbackResponse : MarketingResponse
118           {
119               public long? FeedbackId { get; init; }
120           }
121           
122           /// <summary>
123           /// Request to upload feedback attachment.
124           /// </summary>
125           public record UploadFeedbackAttachmentRequest : IMediatorRequest<UploadFeedbackAttachmentResponse>
126           {
127               public long FeedbackId { get; init; }
128               public required string AttachmentType { get; init; } // "image" or "video"
129               public required string FileName { get; init; }
130               public required string ContentType { get; init; }
131               public required byte[] FileData { get; init; }
132           }
133           
134           /// <summary>
135           /// Response to upload feedback attachment.
136           /// </summary>
137           public record UploadFeedbackAttachmentResponse : MarketingResponse
138           {
139               public long? AttachmentId { get; init; }
140               public string? StorageUrl { get; init; }
141           }
142           
143           /// <summary>
144           /// Request to find nearby businesses.
145           /// </summary>
146           public record FindNearbyBusinessesRequest : IMediatorRequest<FindNearbyBusinessesResponse>
147           {
148               public double Latitude { get; init; }
149               public double Longitude { get; init; }
150               public int RadiusMeters { get; init; } = 1000;
151           }
152           
153           /// <summary>
154           /// Response to find nearby businesses.
155           /// </summary>
156           public record FindNearbyBusinessesResponse : MarketingResponse
157           {
158               public List<BusinessSummaryDto> Businesses { get; init; } = new();
159           }
160           
161           // DTOs
162           
163           /// <summary>
164           /// Complete business marketing data.
165           /// </summary>
166           public record BusinessMarketingDto
167           {
168               public long BusinessId { get; init; }
169               public required string BusinessName { get; init; }
170               public BusinessThemeDto? Theme { get; init; }
171               public List<CouponDto> Coupons { get; init; } = new();
172               public List<MenuItemDto> MenuItems { get; init; } = new();
173               public List<NewsItemDto> NewsItems { get; init; } = new();
174           }
175           
176           /// <summary>
177           /// Business theme data.
178           /// </summary>
179           public record BusinessThemeDto
180           {
181               public long Id { get; init; }
182               public long BusinessId { get; init; }
183               public required string ThemeName { get; init; }
184               public string? PrimaryColor { get; init; }
185               public string? SecondaryColor { get; init; }
186               public string? AccentColor { get; init; }
187               public string? BackgroundColor { get; init; }
188               public string? TextColor { get; init; }
189               public string? LogoUrl { get; init; }
190               public string? BackgroundImageUrl { get; init; }
191               public string? CustomCss { get; init; }
192           }
193           
194           /// <summary>
195           /// Coupon data.
196           /// </summary>
197           public record CouponDto
198           {
199               public long Id { get; init; }
200               public required string Title { get; init; }
201               public required string Description { get; init; }
202               public string? Code { get; init; }
203               public decimal? DiscountAmount { get; init; }
204               public decimal? DiscountPercentage { get; init; }
205               public string? ImageUrl { get; init; }
206               public DateTimeOffset ValidFrom { get; init; }
207               public DateTimeOffset ValidUntil { get; init; }
208               public int? MaxRedemptions { get; init; }
209               public int CurrentRedemptions { get; init; }
210           }
211           
212           /// <summary>
213           /// Menu item data.
214           /// </summary>
215           public record MenuItemDto
216           {
217               public long Id { get; init; }
218               public required string Name { get; init; }
219               public string? Description { get; init; }
220               public required string Category { get; init; }
221               public decimal? Price { get; init; }
222               public string? Currency { get; init; }
223               public string? ImageUrl { get; init; }
224               public int? Calories { get; init; }
225               public string? Allergens { get; init; }
226               public string? DietaryTags { get; init; }
227           }
228           
229           /// <summary>
230           /// News item data.
231           /// </summary>
232           public record NewsItemDto
233           {
234               public long Id { get; init; }
235               public required string Title { get; init; }
236               public required string Content { get; init; }
237               public string? Summary { get; init; }
238               public string? ImageUrl { get; init; }
239               public string? Author { get; init; }
240               public DateTimeOffset PublishedAt { get; init; }
241               public bool IsFeatured { get; init; }
242           }
243           
244           /// <summary>
245           /// Business summary data.
246           /// </summary>
247  ❌ 0     public record BusinessSummaryDto
248           {
249  ❌ 0         public long Id { get; init; }
250  ❌ 0         public required string Name { get; init; }
251  ❌ 0         public required string Address { get; init; }
252  ❌ 0         public double Latitude { get; init; }
253  ❌ 0         public double Longitude { get; init; }
254  ❌ 0         public double? DistanceMeters { get; init; }
255  ❌ 0         public bool IsSubscribed { get; init; }
256           }
```
# FWH.Orchestrix.Contracts.Marketing.BusinessThemeDto

## Summary

|||
|:---|:---|
| Class: | FWH.Orchestrix.Contracts.Marketing.BusinessThemeDto |
| Assembly: | FWH.Orchestrix.Contracts |
| **File(s):** | E:\github\FunWasHad\src\FWH.Orchestrix.Contracts\Marketing\MarketingContracts.cs |
| **Line coverage:** | 0% (0 of 12) |
| Covered lines: | 0 |
| Uncovered lines: | 12 |
| Coverable lines: | 12 |
| Total lines: | 256 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **.ctor(...)** | 100% | 2 | 1 | 0% |
| **get_Id()** | 100% | 2 | 1 | 0% |
| **get_BusinessId()** | 100% | 2 | 1 | 0% |
| **get_ThemeName()** | 100% | 2 | 1 | 0% |
| **get_PrimaryColor()** | 100% | 2 | 1 | 0% |
| **get_SecondaryColor()** | 100% | 2 | 1 | 0% |
| **get_AccentColor()** | 100% | 2 | 1 | 0% |
| **get_BackgroundColor()** | 100% | 2 | 1 | 0% |
| **get_TextColor()** | 100% | 2 | 1 | 0% |
| **get_LogoUrl()** | 100% | 2 | 1 | 0% |
| **get_BackgroundImageUrl()** | 100% | 2 | 1 | 0% |
| **get_CustomCss()** | 100% | 2 | 1 | 0% |

## File(s)

### E:\github\FunWasHad\src\FWH.Orchestrix.Contracts\Marketing\MarketingContracts.cs
```
  1           using FWH.Orchestrix.Contracts.Mediator;
  2           
  3           namespace FWH.Orchestrix.Contracts.Marketing;
  4           
  5           /// <summary>
  6           /// Base response for marketing operations.
  7           /// </summary>
  8           public record MarketingResponse
  9           {
 10               public bool Success { get; init; }
 11               public string? ErrorMessage { get; init; }
 12           }
 13           
 14           /// <summary>
 15           /// Request to get business marketing data.
 16           /// </summary>
 17           public record GetBusinessMarketingRequest : IMediatorRequest<GetBusinessMarketingResponse>
 18           {
 19               public long BusinessId { get; init; }
 20           }
 21           
 22           /// <summary>
 23           /// Response to get business marketing data.
 24           /// </summary>
 25           public record GetBusinessMarketingResponse : MarketingResponse
 26           {
 27               public BusinessMarketingDto? Data { get; init; }
 28           }
 29           
 30           /// <summary>
 31           /// Request to get business theme.
 32           /// </summary>
 33           public record GetBusinessThemeRequest : IMediatorRequest<GetBusinessThemeResponse>
 34           {
 35               public long BusinessId { get; init; }
 36           }
 37           
 38           /// <summary>
 39           /// Response to get business theme.
 40           /// </summary>
 41           public record GetBusinessThemeResponse : MarketingResponse
 42           {
 43               public BusinessThemeDto? Theme { get; init; }
 44           }
 45           
 46           /// <summary>
 47           /// Request to get business coupons.
 48           /// </summary>
 49           public record GetBusinessCouponsRequest : IMediatorRequest<GetBusinessCouponsResponse>
 50           {
 51               public long BusinessId { get; init; }
 52           }
 53           
 54           /// <summary>
 55           /// Response to get business coupons.
 56           /// </summary>
 57           public record GetBusinessCouponsResponse : MarketingResponse
 58           {
 59               public List<CouponDto> Coupons { get; init; } = new();
 60           }
 61           
 62           /// <summary>
 63           /// Request to get business menu.
 64           /// </summary>
 65           public record GetBusinessMenuRequest : IMediatorRequest<GetBusinessMenuResponse>
 66           {
 67               public long BusinessId { get; init; }
 68               public string? Category { get; init; }
 69           }
 70           
 71           /// <summary>
 72           /// Response to get business menu.
 73           /// </summary>
 74           public record GetBusinessMenuResponse : MarketingResponse
 75           {
 76               public List<MenuItemDto> MenuItems { get; init; } = new();
 77           }
 78           
 79           /// <summary>
 80           /// Request to get business news.
 81           /// </summary>
 82           public record GetBusinessNewsRequest : IMediatorRequest<GetBusinessNewsResponse>
 83           {
 84               public long BusinessId { get; init; }
 85               public int Limit { get; init; } = 10;
 86           }
 87           
 88           /// <summary>
 89           /// Response to get business news.
 90           /// </summary>
 91           public record GetBusinessNewsResponse : MarketingResponse
 92           {
 93               public List<NewsItemDto> NewsItems { get; init; } = new();
 94           }
 95           
 96           /// <summary>
 97           /// Request to submit feedback.
 98           /// </summary>
 99           public record SubmitFeedbackRequest : IMediatorRequest<SubmitFeedbackResponse>
100           {
101               public long BusinessId { get; init; }
102               public required string UserId { get; init; }
103               public string? UserName { get; init; }
104               public string? UserEmail { get; init; }
105               public required string FeedbackType { get; init; }
106               public required string Subject { get; init; }
107               public required string Message { get; init; }
108               public int? Rating { get; init; }
109               public bool IsPublic { get; init; }
110               public double? Latitude { get; init; }
111               public double? Longitude { get; init; }
112           }
113           
114           /// <summary>
115           /// Response to submit feedback.
116           /// </summary>
117           public record SubmitFeedbackResponse : MarketingResponse
118           {
119               public long? FeedbackId { get; init; }
120           }
121           
122           /// <summary>
123           /// Request to upload feedback attachment.
124           /// </summary>
125           public record UploadFeedbackAttachmentRequest : IMediatorRequest<UploadFeedbackAttachmentResponse>
126           {
127               public long FeedbackId { get; init; }
128               public required string AttachmentType { get; init; } // "image" or "video"
129               public required string FileName { get; init; }
130               public required string ContentType { get; init; }
131               public required byte[] FileData { get; init; }
132           }
133           
134           /// <summary>
135           /// Response to upload feedback attachment.
136           /// </summary>
137           public record UploadFeedbackAttachmentResponse : MarketingResponse
138           {
139               public long? AttachmentId { get; init; }
140               public string? StorageUrl { get; init; }
141           }
142           
143           /// <summary>
144           /// Request to find nearby businesses.
145           /// </summary>
146           public record FindNearbyBusinessesRequest : IMediatorRequest<FindNearbyBusinessesResponse>
147           {
148               public double Latitude { get; init; }
149               public double Longitude { get; init; }
150               public int RadiusMeters { get; init; } = 1000;
151           }
152           
153           /// <summary>
154           /// Response to find nearby businesses.
155           /// </summary>
156           public record FindNearbyBusinessesResponse : MarketingResponse
157           {
158               public List<BusinessSummaryDto> Businesses { get; init; } = new();
159           }
160           
161           // DTOs
162           
163           /// <summary>
164           /// Complete business marketing data.
165           /// </summary>
166           public record BusinessMarketingDto
167           {
168               public long BusinessId { get; init; }
169               public required string BusinessName { get; init; }
170               public BusinessThemeDto? Theme { get; init; }
171               public List<CouponDto> Coupons { get; init; } = new();
172               public List<MenuItemDto> MenuItems { get; init; } = new();
173               public List<NewsItemDto> NewsItems { get; init; } = new();
174           }
175           
176           /// <summary>
177           /// Business theme data.
178           /// </summary>
179  ❌ 0     public record BusinessThemeDto
180           {
181  ❌ 0         public long Id { get; init; }
182  ❌ 0         public long BusinessId { get; init; }
183  ❌ 0         public required string ThemeName { get; init; }
184  ❌ 0         public string? PrimaryColor { get; init; }
185  ❌ 0         public string? SecondaryColor { get; init; }
186  ❌ 0         public string? AccentColor { get; init; }
187  ❌ 0         public string? BackgroundColor { get; init; }
188  ❌ 0         public string? TextColor { get; init; }
189  ❌ 0         public string? LogoUrl { get; init; }
190  ❌ 0         public string? BackgroundImageUrl { get; init; }
191  ❌ 0         public string? CustomCss { get; init; }
192           }
193           
194           /// <summary>
195           /// Coupon data.
196           /// </summary>
197           public record CouponDto
198           {
199               public long Id { get; init; }
200               public required string Title { get; init; }
201               public required string Description { get; init; }
202               public string? Code { get; init; }
203               public decimal? DiscountAmount { get; init; }
204               public decimal? DiscountPercentage { get; init; }
205               public string? ImageUrl { get; init; }
206               public DateTimeOffset ValidFrom { get; init; }
207               public DateTimeOffset ValidUntil { get; init; }
208               public int? MaxRedemptions { get; init; }
209               public int CurrentRedemptions { get; init; }
210           }
211           
212           /// <summary>
213           /// Menu item data.
214           /// </summary>
215           public record MenuItemDto
216           {
217               public long Id { get; init; }
218               public required string Name { get; init; }
219               public string? Description { get; init; }
220               public required string Category { get; init; }
221               public decimal? Price { get; init; }
222               public string? Currency { get; init; }
223               public string? ImageUrl { get; init; }
224               public int? Calories { get; init; }
225               public string? Allergens { get; init; }
226               public string? DietaryTags { get; init; }
227           }
228           
229           /// <summary>
230           /// News item data.
231           /// </summary>
232           public record NewsItemDto
233           {
234               public long Id { get; init; }
235               public required string Title { get; init; }
236               public required string Content { get; init; }
237               public string? Summary { get; init; }
238               public string? ImageUrl { get; init; }
239               public string? Author { get; init; }
240               public DateTimeOffset PublishedAt { get; init; }
241               public bool IsFeatured { get; init; }
242           }
243           
244           /// <summary>
245           /// Business summary data.
246           /// </summary>
247           public record BusinessSummaryDto
248           {
249               public long Id { get; init; }
250               public required string Name { get; init; }
251               public required string Address { get; init; }
252               public double Latitude { get; init; }
253               public double Longitude { get; init; }
254               public double? DistanceMeters { get; init; }
255               public bool IsSubscribed { get; init; }
256           }
```
# FWH.Orchestrix.Contracts.Marketing.CouponDto

## Summary

|||
|:---|:---|
| Class: | FWH.Orchestrix.Contracts.Marketing.CouponDto |
| Assembly: | FWH.Orchestrix.Contracts |
| **File(s):** | E:\github\FunWasHad\src\FWH.Orchestrix.Contracts\Marketing\MarketingContracts.cs |
| **Line coverage:** | 0% (0 of 12) |
| Covered lines: | 0 |
| Uncovered lines: | 12 |
| Coverable lines: | 12 |
| Total lines: | 256 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **.ctor(...)** | 100% | 2 | 1 | 0% |
| **get_Id()** | 100% | 2 | 1 | 0% |
| **get_Title()** | 100% | 2 | 1 | 0% |
| **get_Description()** | 100% | 2 | 1 | 0% |
| **get_Code()** | 100% | 2 | 1 | 0% |
| **get_DiscountAmount()** | 100% | 2 | 1 | 0% |
| **get_DiscountPercentage()** | 100% | 2 | 1 | 0% |
| **get_ImageUrl()** | 100% | 2 | 1 | 0% |
| **get_ValidFrom()** | 100% | 2 | 1 | 0% |
| **get_ValidUntil()** | 100% | 2 | 1 | 0% |
| **get_MaxRedemptions()** | 100% | 2 | 1 | 0% |
| **get_CurrentRedemptions()** | 100% | 2 | 1 | 0% |

## File(s)

### E:\github\FunWasHad\src\FWH.Orchestrix.Contracts\Marketing\MarketingContracts.cs
```
  1           using FWH.Orchestrix.Contracts.Mediator;
  2           
  3           namespace FWH.Orchestrix.Contracts.Marketing;
  4           
  5           /// <summary>
  6           /// Base response for marketing operations.
  7           /// </summary>
  8           public record MarketingResponse
  9           {
 10               public bool Success { get; init; }
 11               public string? ErrorMessage { get; init; }
 12           }
 13           
 14           /// <summary>
 15           /// Request to get business marketing data.
 16           /// </summary>
 17           public record GetBusinessMarketingRequest : IMediatorRequest<GetBusinessMarketingResponse>
 18           {
 19               public long BusinessId { get; init; }
 20           }
 21           
 22           /// <summary>
 23           /// Response to get business marketing data.
 24           /// </summary>
 25           public record GetBusinessMarketingResponse : MarketingResponse
 26           {
 27               public BusinessMarketingDto? Data { get; init; }
 28           }
 29           
 30           /// <summary>
 31           /// Request to get business theme.
 32           /// </summary>
 33           public record GetBusinessThemeRequest : IMediatorRequest<GetBusinessThemeResponse>
 34           {
 35               public long BusinessId { get; init; }
 36           }
 37           
 38           /// <summary>
 39           /// Response to get business theme.
 40           /// </summary>
 41           public record GetBusinessThemeResponse : MarketingResponse
 42           {
 43               public BusinessThemeDto? Theme { get; init; }
 44           }
 45           
 46           /// <summary>
 47           /// Request to get business coupons.
 48           /// </summary>
 49           public record GetBusinessCouponsRequest : IMediatorRequest<GetBusinessCouponsResponse>
 50           {
 51               public long BusinessId { get; init; }
 52           }
 53           
 54           /// <summary>
 55           /// Response to get business coupons.
 56           /// </summary>
 57           public record GetBusinessCouponsResponse : MarketingResponse
 58           {
 59               public List<CouponDto> Coupons { get; init; } = new();
 60           }
 61           
 62           /// <summary>
 63           /// Request to get business menu.
 64           /// </summary>
 65           public record GetBusinessMenuRequest : IMediatorRequest<GetBusinessMenuResponse>
 66           {
 67               public long BusinessId { get; init; }
 68               public string? Category { get; init; }
 69           }
 70           
 71           /// <summary>
 72           /// Response to get business menu.
 73           /// </summary>
 74           public record GetBusinessMenuResponse : MarketingResponse
 75           {
 76               public List<MenuItemDto> MenuItems { get; init; } = new();
 77           }
 78           
 79           /// <summary>
 80           /// Request to get business news.
 81           /// </summary>
 82           public record GetBusinessNewsRequest : IMediatorRequest<GetBusinessNewsResponse>
 83           {
 84               public long BusinessId { get; init; }
 85               public int Limit { get; init; } = 10;
 86           }
 87           
 88           /// <summary>
 89           /// Response to get business news.
 90           /// </summary>
 91           public record GetBusinessNewsResponse : MarketingResponse
 92           {
 93               public List<NewsItemDto> NewsItems { get; init; } = new();
 94           }
 95           
 96           /// <summary>
 97           /// Request to submit feedback.
 98           /// </summary>
 99           public record SubmitFeedbackRequest : IMediatorRequest<SubmitFeedbackResponse>
100           {
101               public long BusinessId { get; init; }
102               public required string UserId { get; init; }
103               public string? UserName { get; init; }
104               public string? UserEmail { get; init; }
105               public required string FeedbackType { get; init; }
106               public required string Subject { get; init; }
107               public required string Message { get; init; }
108               public int? Rating { get; init; }
109               public bool IsPublic { get; init; }
110               public double? Latitude { get; init; }
111               public double? Longitude { get; init; }
112           }
113           
114           /// <summary>
115           /// Response to submit feedback.
116           /// </summary>
117           public record SubmitFeedbackResponse : MarketingResponse
118           {
119               public long? FeedbackId { get; init; }
120           }
121           
122           /// <summary>
123           /// Request to upload feedback attachment.
124           /// </summary>
125           public record UploadFeedbackAttachmentRequest : IMediatorRequest<UploadFeedbackAttachmentResponse>
126           {
127               public long FeedbackId { get; init; }
128               public required string AttachmentType { get; init; } // "image" or "video"
129               public required string FileName { get; init; }
130               public required string ContentType { get; init; }
131               public required byte[] FileData { get; init; }
132           }
133           
134           /// <summary>
135           /// Response to upload feedback attachment.
136           /// </summary>
137           public record UploadFeedbackAttachmentResponse : MarketingResponse
138           {
139               public long? AttachmentId { get; init; }
140               public string? StorageUrl { get; init; }
141           }
142           
143           /// <summary>
144           /// Request to find nearby businesses.
145           /// </summary>
146           public record FindNearbyBusinessesRequest : IMediatorRequest<FindNearbyBusinessesResponse>
147           {
148               public double Latitude { get; init; }
149               public double Longitude { get; init; }
150               public int RadiusMeters { get; init; } = 1000;
151           }
152           
153           /// <summary>
154           /// Response to find nearby businesses.
155           /// </summary>
156           public record FindNearbyBusinessesResponse : MarketingResponse
157           {
158               public List<BusinessSummaryDto> Businesses { get; init; } = new();
159           }
160           
161           // DTOs
162           
163           /// <summary>
164           /// Complete business marketing data.
165           /// </summary>
166           public record BusinessMarketingDto
167           {
168               public long BusinessId { get; init; }
169               public required string BusinessName { get; init; }
170               public BusinessThemeDto? Theme { get; init; }
171               public List<CouponDto> Coupons { get; init; } = new();
172               public List<MenuItemDto> MenuItems { get; init; } = new();
173               public List<NewsItemDto> NewsItems { get; init; } = new();
174           }
175           
176           /// <summary>
177           /// Business theme data.
178           /// </summary>
179           public record BusinessThemeDto
180           {
181               public long Id { get; init; }
182               public long BusinessId { get; init; }
183               public required string ThemeName { get; init; }
184               public string? PrimaryColor { get; init; }
185               public string? SecondaryColor { get; init; }
186               public string? AccentColor { get; init; }
187               public string? BackgroundColor { get; init; }
188               public string? TextColor { get; init; }
189               public string? LogoUrl { get; init; }
190               public string? BackgroundImageUrl { get; init; }
191               public string? CustomCss { get; init; }
192           }
193           
194           /// <summary>
195           /// Coupon data.
196           /// </summary>
197  ❌ 0     public record CouponDto
198           {
199  ❌ 0         public long Id { get; init; }
200  ❌ 0         public required string Title { get; init; }
201  ❌ 0         public required string Description { get; init; }
202  ❌ 0         public string? Code { get; init; }
203  ❌ 0         public decimal? DiscountAmount { get; init; }
204  ❌ 0         public decimal? DiscountPercentage { get; init; }
205  ❌ 0         public string? ImageUrl { get; init; }
206  ❌ 0         public DateTimeOffset ValidFrom { get; init; }
207  ❌ 0         public DateTimeOffset ValidUntil { get; init; }
208  ❌ 0         public int? MaxRedemptions { get; init; }
209  ❌ 0         public int CurrentRedemptions { get; init; }
210           }
211           
212           /// <summary>
213           /// Menu item data.
214           /// </summary>
215           public record MenuItemDto
216           {
217               public long Id { get; init; }
218               public required string Name { get; init; }
219               public string? Description { get; init; }
220               public required string Category { get; init; }
221               public decimal? Price { get; init; }
222               public string? Currency { get; init; }
223               public string? ImageUrl { get; init; }
224               public int? Calories { get; init; }
225               public string? Allergens { get; init; }
226               public string? DietaryTags { get; init; }
227           }
228           
229           /// <summary>
230           /// News item data.
231           /// </summary>
232           public record NewsItemDto
233           {
234               public long Id { get; init; }
235               public required string Title { get; init; }
236               public required string Content { get; init; }
237               public string? Summary { get; init; }
238               public string? ImageUrl { get; init; }
239               public string? Author { get; init; }
240               public DateTimeOffset PublishedAt { get; init; }
241               public bool IsFeatured { get; init; }
242           }
243           
244           /// <summary>
245           /// Business summary data.
246           /// </summary>
247           public record BusinessSummaryDto
248           {
249               public long Id { get; init; }
250               public required string Name { get; init; }
251               public required string Address { get; init; }
252               public double Latitude { get; init; }
253               public double Longitude { get; init; }
254               public double? DistanceMeters { get; init; }
255               public bool IsSubscribed { get; init; }
256           }
```
# FWH.Orchestrix.Contracts.Marketing.FindNearbyBusinessesRequest

## Summary

|||
|:---|:---|
| Class: | FWH.Orchestrix.Contracts.Marketing.FindNearbyBusinessesRequest |
| Assembly: | FWH.Orchestrix.Contracts |
| **File(s):** | E:\github\FunWasHad\src\FWH.Orchestrix.Contracts\Marketing\MarketingContracts.cs |
| **Line coverage:** | 0% (0 of 4) |
| Covered lines: | 0 |
| Uncovered lines: | 4 |
| Coverable lines: | 4 |
| Total lines: | 256 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **.ctor(...)** | 100% | 2 | 1 | 0% |
| **get_Latitude()** | 100% | 2 | 1 | 0% |
| **get_Longitude()** | 100% | 2 | 1 | 0% |
| **get_RadiusMeters()** | 100% | 2 | 1 | 0% |

## File(s)

### E:\github\FunWasHad\src\FWH.Orchestrix.Contracts\Marketing\MarketingContracts.cs
```
  1           using FWH.Orchestrix.Contracts.Mediator;
  2           
  3           namespace FWH.Orchestrix.Contracts.Marketing;
  4           
  5           /// <summary>
  6           /// Base response for marketing operations.
  7           /// </summary>
  8           public record MarketingResponse
  9           {
 10               public bool Success { get; init; }
 11               public string? ErrorMessage { get; init; }
 12           }
 13           
 14           /// <summary>
 15           /// Request to get business marketing data.
 16           /// </summary>
 17           public record GetBusinessMarketingRequest : IMediatorRequest<GetBusinessMarketingResponse>
 18           {
 19               public long BusinessId { get; init; }
 20           }
 21           
 22           /// <summary>
 23           /// Response to get business marketing data.
 24           /// </summary>
 25           public record GetBusinessMarketingResponse : MarketingResponse
 26           {
 27               public BusinessMarketingDto? Data { get; init; }
 28           }
 29           
 30           /// <summary>
 31           /// Request to get business theme.
 32           /// </summary>
 33           public record GetBusinessThemeRequest : IMediatorRequest<GetBusinessThemeResponse>
 34           {
 35               public long BusinessId { get; init; }
 36           }
 37           
 38           /// <summary>
 39           /// Response to get business theme.
 40           /// </summary>
 41           public record GetBusinessThemeResponse : MarketingResponse
 42           {
 43               public BusinessThemeDto? Theme { get; init; }
 44           }
 45           
 46           /// <summary>
 47           /// Request to get business coupons.
 48           /// </summary>
 49           public record GetBusinessCouponsRequest : IMediatorRequest<GetBusinessCouponsResponse>
 50           {
 51               public long BusinessId { get; init; }
 52           }
 53           
 54           /// <summary>
 55           /// Response to get business coupons.
 56           /// </summary>
 57           public record GetBusinessCouponsResponse : MarketingResponse
 58           {
 59               public List<CouponDto> Coupons { get; init; } = new();
 60           }
 61           
 62           /// <summary>
 63           /// Request to get business menu.
 64           /// </summary>
 65           public record GetBusinessMenuRequest : IMediatorRequest<GetBusinessMenuResponse>
 66           {
 67               public long BusinessId { get; init; }
 68               public string? Category { get; init; }
 69           }
 70           
 71           /// <summary>
 72           /// Response to get business menu.
 73           /// </summary>
 74           public record GetBusinessMenuResponse : MarketingResponse
 75           {
 76               public List<MenuItemDto> MenuItems { get; init; } = new();
 77           }
 78           
 79           /// <summary>
 80           /// Request to get business news.
 81           /// </summary>
 82           public record GetBusinessNewsRequest : IMediatorRequest<GetBusinessNewsResponse>
 83           {
 84               public long BusinessId { get; init; }
 85               public int Limit { get; init; } = 10;
 86           }
 87           
 88           /// <summary>
 89           /// Response to get business news.
 90           /// </summary>
 91           public record GetBusinessNewsResponse : MarketingResponse
 92           {
 93               public List<NewsItemDto> NewsItems { get; init; } = new();
 94           }
 95           
 96           /// <summary>
 97           /// Request to submit feedback.
 98           /// </summary>
 99           public record SubmitFeedbackRequest : IMediatorRequest<SubmitFeedbackResponse>
100           {
101               public long BusinessId { get; init; }
102               public required string UserId { get; init; }
103               public string? UserName { get; init; }
104               public string? UserEmail { get; init; }
105               public required string FeedbackType { get; init; }
106               public required string Subject { get; init; }
107               public required string Message { get; init; }
108               public int? Rating { get; init; }
109               public bool IsPublic { get; init; }
110               public double? Latitude { get; init; }
111               public double? Longitude { get; init; }
112           }
113           
114           /// <summary>
115           /// Response to submit feedback.
116           /// </summary>
117           public record SubmitFeedbackResponse : MarketingResponse
118           {
119               public long? FeedbackId { get; init; }
120           }
121           
122           /// <summary>
123           /// Request to upload feedback attachment.
124           /// </summary>
125           public record UploadFeedbackAttachmentRequest : IMediatorRequest<UploadFeedbackAttachmentResponse>
126           {
127               public long FeedbackId { get; init; }
128               public required string AttachmentType { get; init; } // "image" or "video"
129               public required string FileName { get; init; }
130               public required string ContentType { get; init; }
131               public required byte[] FileData { get; init; }
132           }
133           
134           /// <summary>
135           /// Response to upload feedback attachment.
136           /// </summary>
137           public record UploadFeedbackAttachmentResponse : MarketingResponse
138           {
139               public long? AttachmentId { get; init; }
140               public string? StorageUrl { get; init; }
141           }
142           
143           /// <summary>
144           /// Request to find nearby businesses.
145           /// </summary>
146  ❌ 0     public record FindNearbyBusinessesRequest : IMediatorRequest<FindNearbyBusinessesResponse>
147           {
148  ❌ 0         public double Latitude { get; init; }
149  ❌ 0         public double Longitude { get; init; }
150  ❌ 0         public int RadiusMeters { get; init; } = 1000;
151           }
152           
153           /// <summary>
154           /// Response to find nearby businesses.
155           /// </summary>
156           public record FindNearbyBusinessesResponse : MarketingResponse
157           {
158               public List<BusinessSummaryDto> Businesses { get; init; } = new();
159           }
160           
161           // DTOs
162           
163           /// <summary>
164           /// Complete business marketing data.
165           /// </summary>
166           public record BusinessMarketingDto
167           {
168               public long BusinessId { get; init; }
169               public required string BusinessName { get; init; }
170               public BusinessThemeDto? Theme { get; init; }
171               public List<CouponDto> Coupons { get; init; } = new();
172               public List<MenuItemDto> MenuItems { get; init; } = new();
173               public List<NewsItemDto> NewsItems { get; init; } = new();
174           }
175           
176           /// <summary>
177           /// Business theme data.
178           /// </summary>
179           public record BusinessThemeDto
180           {
181               public long Id { get; init; }
182               public long BusinessId { get; init; }
183               public required string ThemeName { get; init; }
184               public string? PrimaryColor { get; init; }
185               public string? SecondaryColor { get; init; }
186               public string? AccentColor { get; init; }
187               public string? BackgroundColor { get; init; }
188               public string? TextColor { get; init; }
189               public string? LogoUrl { get; init; }
190               public string? BackgroundImageUrl { get; init; }
191               public string? CustomCss { get; init; }
192           }
193           
194           /// <summary>
195           /// Coupon data.
196           /// </summary>
197           public record CouponDto
198           {
199               public long Id { get; init; }
200               public required string Title { get; init; }
201               public required string Description { get; init; }
202               public string? Code { get; init; }
203               public decimal? DiscountAmount { get; init; }
204               public decimal? DiscountPercentage { get; init; }
205               public string? ImageUrl { get; init; }
206               public DateTimeOffset ValidFrom { get; init; }
207               public DateTimeOffset ValidUntil { get; init; }
208               public int? MaxRedemptions { get; init; }
209               public int CurrentRedemptions { get; init; }
210           }
211           
212           /// <summary>
213           /// Menu item data.
214           /// </summary>
215           public record MenuItemDto
216           {
217               public long Id { get; init; }
218               public required string Name { get; init; }
219               public string? Description { get; init; }
220               public required string Category { get; init; }
221               public decimal? Price { get; init; }
222               public string? Currency { get; init; }
223               public string? ImageUrl { get; init; }
224               public int? Calories { get; init; }
225               public string? Allergens { get; init; }
226               public string? DietaryTags { get; init; }
227           }
228           
229           /// <summary>
230           /// News item data.
231           /// </summary>
232           public record NewsItemDto
233           {
234               public long Id { get; init; }
235               public required string Title { get; init; }
236               public required string Content { get; init; }
237               public string? Summary { get; init; }
238               public string? ImageUrl { get; init; }
239               public string? Author { get; init; }
240               public DateTimeOffset PublishedAt { get; init; }
241               public bool IsFeatured { get; init; }
242           }
243           
244           /// <summary>
245           /// Business summary data.
246           /// </summary>
247           public record BusinessSummaryDto
248           {
249               public long Id { get; init; }
250               public required string Name { get; init; }
251               public required string Address { get; init; }
252               public double Latitude { get; init; }
253               public double Longitude { get; init; }
254               public double? DistanceMeters { get; init; }
255               public bool IsSubscribed { get; init; }
256           }
```
# FWH.Orchestrix.Contracts.Marketing.FindNearbyBusinessesResponse

## Summary

|||
|:---|:---|
| Class: | FWH.Orchestrix.Contracts.Marketing.FindNearbyBusinessesResponse |
| Assembly: | FWH.Orchestrix.Contracts |
| **File(s):** | E:\github\FunWasHad\src\FWH.Orchestrix.Contracts\Marketing\MarketingContracts.cs |
| **Line coverage:** | 0% (0 of 2) |
| Covered lines: | 0 |
| Uncovered lines: | 2 |
| Coverable lines: | 2 |
| Total lines: | 256 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **.ctor(...)** | 100% | 2 | 1 | 0% |
| **get_Businesses()** | 100% | 2 | 1 | 0% |

## File(s)

### E:\github\FunWasHad\src\FWH.Orchestrix.Contracts\Marketing\MarketingContracts.cs
```
  1           using FWH.Orchestrix.Contracts.Mediator;
  2           
  3           namespace FWH.Orchestrix.Contracts.Marketing;
  4           
  5           /// <summary>
  6           /// Base response for marketing operations.
  7           /// </summary>
  8           public record MarketingResponse
  9           {
 10               public bool Success { get; init; }
 11               public string? ErrorMessage { get; init; }
 12           }
 13           
 14           /// <summary>
 15           /// Request to get business marketing data.
 16           /// </summary>
 17           public record GetBusinessMarketingRequest : IMediatorRequest<GetBusinessMarketingResponse>
 18           {
 19               public long BusinessId { get; init; }
 20           }
 21           
 22           /// <summary>
 23           /// Response to get business marketing data.
 24           /// </summary>
 25           public record GetBusinessMarketingResponse : MarketingResponse
 26           {
 27               public BusinessMarketingDto? Data { get; init; }
 28           }
 29           
 30           /// <summary>
 31           /// Request to get business theme.
 32           /// </summary>
 33           public record GetBusinessThemeRequest : IMediatorRequest<GetBusinessThemeResponse>
 34           {
 35               public long BusinessId { get; init; }
 36           }
 37           
 38           /// <summary>
 39           /// Response to get business theme.
 40           /// </summary>
 41           public record GetBusinessThemeResponse : MarketingResponse
 42           {
 43               public BusinessThemeDto? Theme { get; init; }
 44           }
 45           
 46           /// <summary>
 47           /// Request to get business coupons.
 48           /// </summary>
 49           public record GetBusinessCouponsRequest : IMediatorRequest<GetBusinessCouponsResponse>
 50           {
 51               public long BusinessId { get; init; }
 52           }
 53           
 54           /// <summary>
 55           /// Response to get business coupons.
 56           /// </summary>
 57           public record GetBusinessCouponsResponse : MarketingResponse
 58           {
 59               public List<CouponDto> Coupons { get; init; } = new();
 60           }
 61           
 62           /// <summary>
 63           /// Request to get business menu.
 64           /// </summary>
 65           public record GetBusinessMenuRequest : IMediatorRequest<GetBusinessMenuResponse>
 66           {
 67               public long BusinessId { get; init; }
 68               public string? Category { get; init; }
 69           }
 70           
 71           /// <summary>
 72           /// Response to get business menu.
 73           /// </summary>
 74           public record GetBusinessMenuResponse : MarketingResponse
 75           {
 76               public List<MenuItemDto> MenuItems { get; init; } = new();
 77           }
 78           
 79           /// <summary>
 80           /// Request to get business news.
 81           /// </summary>
 82           public record GetBusinessNewsRequest : IMediatorRequest<GetBusinessNewsResponse>
 83           {
 84               public long BusinessId { get; init; }
 85               public int Limit { get; init; } = 10;
 86           }
 87           
 88           /// <summary>
 89           /// Response to get business news.
 90           /// </summary>
 91           public record GetBusinessNewsResponse : MarketingResponse
 92           {
 93               public List<NewsItemDto> NewsItems { get; init; } = new();
 94           }
 95           
 96           /// <summary>
 97           /// Request to submit feedback.
 98           /// </summary>
 99           public record SubmitFeedbackRequest : IMediatorRequest<SubmitFeedbackResponse>
100           {
101               public long BusinessId { get; init; }
102               public required string UserId { get; init; }
103               public string? UserName { get; init; }
104               public string? UserEmail { get; init; }
105               public required string FeedbackType { get; init; }
106               public required string Subject { get; init; }
107               public required string Message { get; init; }
108               public int? Rating { get; init; }
109               public bool IsPublic { get; init; }
110               public double? Latitude { get; init; }
111               public double? Longitude { get; init; }
112           }
113           
114           /// <summary>
115           /// Response to submit feedback.
116           /// </summary>
117           public record SubmitFeedbackResponse : MarketingResponse
118           {
119               public long? FeedbackId { get; init; }
120           }
121           
122           /// <summary>
123           /// Request to upload feedback attachment.
124           /// </summary>
125           public record UploadFeedbackAttachmentRequest : IMediatorRequest<UploadFeedbackAttachmentResponse>
126           {
127               public long FeedbackId { get; init; }
128               public required string AttachmentType { get; init; } // "image" or "video"
129               public required string FileName { get; init; }
130               public required string ContentType { get; init; }
131               public required byte[] FileData { get; init; }
132           }
133           
134           /// <summary>
135           /// Response to upload feedback attachment.
136           /// </summary>
137           public record UploadFeedbackAttachmentResponse : MarketingResponse
138           {
139               public long? AttachmentId { get; init; }
140               public string? StorageUrl { get; init; }
141           }
142           
143           /// <summary>
144           /// Request to find nearby businesses.
145           /// </summary>
146           public record FindNearbyBusinessesRequest : IMediatorRequest<FindNearbyBusinessesResponse>
147           {
148               public double Latitude { get; init; }
149               public double Longitude { get; init; }
150               public int RadiusMeters { get; init; } = 1000;
151           }
152           
153           /// <summary>
154           /// Response to find nearby businesses.
155           /// </summary>
156  ❌ 0     public record FindNearbyBusinessesResponse : MarketingResponse
157           {
158  ❌ 0         public List<BusinessSummaryDto> Businesses { get; init; } = new();
159           }
160           
161           // DTOs
162           
163           /// <summary>
164           /// Complete business marketing data.
165           /// </summary>
166           public record BusinessMarketingDto
167           {
168               public long BusinessId { get; init; }
169               public required string BusinessName { get; init; }
170               public BusinessThemeDto? Theme { get; init; }
171               public List<CouponDto> Coupons { get; init; } = new();
172               public List<MenuItemDto> MenuItems { get; init; } = new();
173               public List<NewsItemDto> NewsItems { get; init; } = new();
174           }
175           
176           /// <summary>
177           /// Business theme data.
178           /// </summary>
179           public record BusinessThemeDto
180           {
181               public long Id { get; init; }
182               public long BusinessId { get; init; }
183               public required string ThemeName { get; init; }
184               public string? PrimaryColor { get; init; }
185               public string? SecondaryColor { get; init; }
186               public string? AccentColor { get; init; }
187               public string? BackgroundColor { get; init; }
188               public string? TextColor { get; init; }
189               public string? LogoUrl { get; init; }
190               public string? BackgroundImageUrl { get; init; }
191               public string? CustomCss { get; init; }
192           }
193           
194           /// <summary>
195           /// Coupon data.
196           /// </summary>
197           public record CouponDto
198           {
199               public long Id { get; init; }
200               public required string Title { get; init; }
201               public required string Description { get; init; }
202               public string? Code { get; init; }
203               public decimal? DiscountAmount { get; init; }
204               public decimal? DiscountPercentage { get; init; }
205               public string? ImageUrl { get; init; }
206               public DateTimeOffset ValidFrom { get; init; }
207               public DateTimeOffset ValidUntil { get; init; }
208               public int? MaxRedemptions { get; init; }
209               public int CurrentRedemptions { get; init; }
210           }
211           
212           /// <summary>
213           /// Menu item data.
214           /// </summary>
215           public record MenuItemDto
216           {
217               public long Id { get; init; }
218               public required string Name { get; init; }
219               public string? Description { get; init; }
220               public required string Category { get; init; }
221               public decimal? Price { get; init; }
222               public string? Currency { get; init; }
223               public string? ImageUrl { get; init; }
224               public int? Calories { get; init; }
225               public string? Allergens { get; init; }
226               public string? DietaryTags { get; init; }
227           }
228           
229           /// <summary>
230           /// News item data.
231           /// </summary>
232           public record NewsItemDto
233           {
234               public long Id { get; init; }
235               public required string Title { get; init; }
236               public required string Content { get; init; }
237               public string? Summary { get; init; }
238               public string? ImageUrl { get; init; }
239               public string? Author { get; init; }
240               public DateTimeOffset PublishedAt { get; init; }
241               public bool IsFeatured { get; init; }
242           }
243           
244           /// <summary>
245           /// Business summary data.
246           /// </summary>
247           public record BusinessSummaryDto
248           {
249               public long Id { get; init; }
250               public required string Name { get; init; }
251               public required string Address { get; init; }
252               public double Latitude { get; init; }
253               public double Longitude { get; init; }
254               public double? DistanceMeters { get; init; }
255               public bool IsSubscribed { get; init; }
256           }
```
# FWH.Orchestrix.Contracts.Marketing.GetBusinessCouponsRequest

## Summary

|||
|:---|:---|
| Class: | FWH.Orchestrix.Contracts.Marketing.GetBusinessCouponsRequest |
| Assembly: | FWH.Orchestrix.Contracts |
| **File(s):** | E:\github\FunWasHad\src\FWH.Orchestrix.Contracts\Marketing\MarketingContracts.cs |
| **Line coverage:** | 0% (0 of 2) |
| Covered lines: | 0 |
| Uncovered lines: | 2 |
| Coverable lines: | 2 |
| Total lines: | 256 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **.ctor(...)** | 100% | 2 | 1 | 0% |
| **get_BusinessId()** | 100% | 2 | 1 | 0% |

## File(s)

### E:\github\FunWasHad\src\FWH.Orchestrix.Contracts\Marketing\MarketingContracts.cs
```
  1           using FWH.Orchestrix.Contracts.Mediator;
  2           
  3           namespace FWH.Orchestrix.Contracts.Marketing;
  4           
  5           /// <summary>
  6           /// Base response for marketing operations.
  7           /// </summary>
  8           public record MarketingResponse
  9           {
 10               public bool Success { get; init; }
 11               public string? ErrorMessage { get; init; }
 12           }
 13           
 14           /// <summary>
 15           /// Request to get business marketing data.
 16           /// </summary>
 17           public record GetBusinessMarketingRequest : IMediatorRequest<GetBusinessMarketingResponse>
 18           {
 19               public long BusinessId { get; init; }
 20           }
 21           
 22           /// <summary>
 23           /// Response to get business marketing data.
 24           /// </summary>
 25           public record GetBusinessMarketingResponse : MarketingResponse
 26           {
 27               public BusinessMarketingDto? Data { get; init; }
 28           }
 29           
 30           /// <summary>
 31           /// Request to get business theme.
 32           /// </summary>
 33           public record GetBusinessThemeRequest : IMediatorRequest<GetBusinessThemeResponse>
 34           {
 35               public long BusinessId { get; init; }
 36           }
 37           
 38           /// <summary>
 39           /// Response to get business theme.
 40           /// </summary>
 41           public record GetBusinessThemeResponse : MarketingResponse
 42           {
 43               public BusinessThemeDto? Theme { get; init; }
 44           }
 45           
 46           /// <summary>
 47           /// Request to get business coupons.
 48           /// </summary>
 49  ❌ 0     public record GetBusinessCouponsRequest : IMediatorRequest<GetBusinessCouponsResponse>
 50           {
 51  ❌ 0         public long BusinessId { get; init; }
 52           }
 53           
 54           /// <summary>
 55           /// Response to get business coupons.
 56           /// </summary>
 57           public record GetBusinessCouponsResponse : MarketingResponse
 58           {
 59               public List<CouponDto> Coupons { get; init; } = new();
 60           }
 61           
 62           /// <summary>
 63           /// Request to get business menu.
 64           /// </summary>
 65           public record GetBusinessMenuRequest : IMediatorRequest<GetBusinessMenuResponse>
 66           {
 67               public long BusinessId { get; init; }
 68               public string? Category { get; init; }
 69           }
 70           
 71           /// <summary>
 72           /// Response to get business menu.
 73           /// </summary>
 74           public record GetBusinessMenuResponse : MarketingResponse
 75           {
 76               public List<MenuItemDto> MenuItems { get; init; } = new();
 77           }
 78           
 79           /// <summary>
 80           /// Request to get business news.
 81           /// </summary>
 82           public record GetBusinessNewsRequest : IMediatorRequest<GetBusinessNewsResponse>
 83           {
 84               public long BusinessId { get; init; }
 85               public int Limit { get; init; } = 10;
 86           }
 87           
 88           /// <summary>
 89           /// Response to get business news.
 90           /// </summary>
 91           public record GetBusinessNewsResponse : MarketingResponse
 92           {
 93               public List<NewsItemDto> NewsItems { get; init; } = new();
 94           }
 95           
 96           /// <summary>
 97           /// Request to submit feedback.
 98           /// </summary>
 99           public record SubmitFeedbackRequest : IMediatorRequest<SubmitFeedbackResponse>
100           {
101               public long BusinessId { get; init; }
102               public required string UserId { get; init; }
103               public string? UserName { get; init; }
104               public string? UserEmail { get; init; }
105               public required string FeedbackType { get; init; }
106               public required string Subject { get; init; }
107               public required string Message { get; init; }
108               public int? Rating { get; init; }
109               public bool IsPublic { get; init; }
110               public double? Latitude { get; init; }
111               public double? Longitude { get; init; }
112           }
113           
114           /// <summary>
115           /// Response to submit feedback.
116           /// </summary>
117           public record SubmitFeedbackResponse : MarketingResponse
118           {
119               public long? FeedbackId { get; init; }
120           }
121           
122           /// <summary>
123           /// Request to upload feedback attachment.
124           /// </summary>
125           public record UploadFeedbackAttachmentRequest : IMediatorRequest<UploadFeedbackAttachmentResponse>
126           {
127               public long FeedbackId { get; init; }
128               public required string AttachmentType { get; init; } // "image" or "video"
129               public required string FileName { get; init; }
130               public required string ContentType { get; init; }
131               public required byte[] FileData { get; init; }
132           }
133           
134           /// <summary>
135           /// Response to upload feedback attachment.
136           /// </summary>
137           public record UploadFeedbackAttachmentResponse : MarketingResponse
138           {
139               public long? AttachmentId { get; init; }
140               public string? StorageUrl { get; init; }
141           }
142           
143           /// <summary>
144           /// Request to find nearby businesses.
145           /// </summary>
146           public record FindNearbyBusinessesRequest : IMediatorRequest<FindNearbyBusinessesResponse>
147           {
148               public double Latitude { get; init; }
149               public double Longitude { get; init; }
150               public int RadiusMeters { get; init; } = 1000;
151           }
152           
153           /// <summary>
154           /// Response to find nearby businesses.
155           /// </summary>
156           public record FindNearbyBusinessesResponse : MarketingResponse
157           {
158               public List<BusinessSummaryDto> Businesses { get; init; } = new();
159           }
160           
161           // DTOs
162           
163           /// <summary>
164           /// Complete business marketing data.
165           /// </summary>
166           public record BusinessMarketingDto
167           {
168               public long BusinessId { get; init; }
169               public required string BusinessName { get; init; }
170               public BusinessThemeDto? Theme { get; init; }
171               public List<CouponDto> Coupons { get; init; } = new();
172               public List<MenuItemDto> MenuItems { get; init; } = new();
173               public List<NewsItemDto> NewsItems { get; init; } = new();
174           }
175           
176           /// <summary>
177           /// Business theme data.
178           /// </summary>
179           public record BusinessThemeDto
180           {
181               public long Id { get; init; }
182               public long BusinessId { get; init; }
183               public required string ThemeName { get; init; }
184               public string? PrimaryColor { get; init; }
185               public string? SecondaryColor { get; init; }
186               public string? AccentColor { get; init; }
187               public string? BackgroundColor { get; init; }
188               public string? TextColor { get; init; }
189               public string? LogoUrl { get; init; }
190               public string? BackgroundImageUrl { get; init; }
191               public string? CustomCss { get; init; }
192           }
193           
194           /// <summary>
195           /// Coupon data.
196           /// </summary>
197           public record CouponDto
198           {
199               public long Id { get; init; }
200               public required string Title { get; init; }
201               public required string Description { get; init; }
202               public string? Code { get; init; }
203               public decimal? DiscountAmount { get; init; }
204               public decimal? DiscountPercentage { get; init; }
205               public string? ImageUrl { get; init; }
206               public DateTimeOffset ValidFrom { get; init; }
207               public DateTimeOffset ValidUntil { get; init; }
208               public int? MaxRedemptions { get; init; }
209               public int CurrentRedemptions { get; init; }
210           }
211           
212           /// <summary>
213           /// Menu item data.
214           /// </summary>
215           public record MenuItemDto
216           {
217               public long Id { get; init; }
218               public required string Name { get; init; }
219               public string? Description { get; init; }
220               public required string Category { get; init; }
221               public decimal? Price { get; init; }
222               public string? Currency { get; init; }
223               public string? ImageUrl { get; init; }
224               public int? Calories { get; init; }
225               public string? Allergens { get; init; }
226               public string? DietaryTags { get; init; }
227           }
228           
229           /// <summary>
230           /// News item data.
231           /// </summary>
232           public record NewsItemDto
233           {
234               public long Id { get; init; }
235               public required string Title { get; init; }
236               public required string Content { get; init; }
237               public string? Summary { get; init; }
238               public string? ImageUrl { get; init; }
239               public string? Author { get; init; }
240               public DateTimeOffset PublishedAt { get; init; }
241               public bool IsFeatured { get; init; }
242           }
243           
244           /// <summary>
245           /// Business summary data.
246           /// </summary>
247           public record BusinessSummaryDto
248           {
249               public long Id { get; init; }
250               public required string Name { get; init; }
251               public required string Address { get; init; }
252               public double Latitude { get; init; }
253               public double Longitude { get; init; }
254               public double? DistanceMeters { get; init; }
255               public bool IsSubscribed { get; init; }
256           }
```
# FWH.Orchestrix.Contracts.Marketing.GetBusinessCouponsResponse

## Summary

|||
|:---|:---|
| Class: | FWH.Orchestrix.Contracts.Marketing.GetBusinessCouponsResponse |
| Assembly: | FWH.Orchestrix.Contracts |
| **File(s):** | E:\github\FunWasHad\src\FWH.Orchestrix.Contracts\Marketing\MarketingContracts.cs |
| **Line coverage:** | 0% (0 of 2) |
| Covered lines: | 0 |
| Uncovered lines: | 2 |
| Coverable lines: | 2 |
| Total lines: | 256 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **.ctor(...)** | 100% | 2 | 1 | 0% |
| **get_Coupons()** | 100% | 2 | 1 | 0% |

## File(s)

### E:\github\FunWasHad\src\FWH.Orchestrix.Contracts\Marketing\MarketingContracts.cs
```
  1           using FWH.Orchestrix.Contracts.Mediator;
  2           
  3           namespace FWH.Orchestrix.Contracts.Marketing;
  4           
  5           /// <summary>
  6           /// Base response for marketing operations.
  7           /// </summary>
  8           public record MarketingResponse
  9           {
 10               public bool Success { get; init; }
 11               public string? ErrorMessage { get; init; }
 12           }
 13           
 14           /// <summary>
 15           /// Request to get business marketing data.
 16           /// </summary>
 17           public record GetBusinessMarketingRequest : IMediatorRequest<GetBusinessMarketingResponse>
 18           {
 19               public long BusinessId { get; init; }
 20           }
 21           
 22           /// <summary>
 23           /// Response to get business marketing data.
 24           /// </summary>
 25           public record GetBusinessMarketingResponse : MarketingResponse
 26           {
 27               public BusinessMarketingDto? Data { get; init; }
 28           }
 29           
 30           /// <summary>
 31           /// Request to get business theme.
 32           /// </summary>
 33           public record GetBusinessThemeRequest : IMediatorRequest<GetBusinessThemeResponse>
 34           {
 35               public long BusinessId { get; init; }
 36           }
 37           
 38           /// <summary>
 39           /// Response to get business theme.
 40           /// </summary>
 41           public record GetBusinessThemeResponse : MarketingResponse
 42           {
 43               public BusinessThemeDto? Theme { get; init; }
 44           }
 45           
 46           /// <summary>
 47           /// Request to get business coupons.
 48           /// </summary>
 49           public record GetBusinessCouponsRequest : IMediatorRequest<GetBusinessCouponsResponse>
 50           {
 51               public long BusinessId { get; init; }
 52           }
 53           
 54           /// <summary>
 55           /// Response to get business coupons.
 56           /// </summary>
 57  ❌ 0     public record GetBusinessCouponsResponse : MarketingResponse
 58           {
 59  ❌ 0         public List<CouponDto> Coupons { get; init; } = new();
 60           }
 61           
 62           /// <summary>
 63           /// Request to get business menu.
 64           /// </summary>
 65           public record GetBusinessMenuRequest : IMediatorRequest<GetBusinessMenuResponse>
 66           {
 67               public long BusinessId { get; init; }
 68               public string? Category { get; init; }
 69           }
 70           
 71           /// <summary>
 72           /// Response to get business menu.
 73           /// </summary>
 74           public record GetBusinessMenuResponse : MarketingResponse
 75           {
 76               public List<MenuItemDto> MenuItems { get; init; } = new();
 77           }
 78           
 79           /// <summary>
 80           /// Request to get business news.
 81           /// </summary>
 82           public record GetBusinessNewsRequest : IMediatorRequest<GetBusinessNewsResponse>
 83           {
 84               public long BusinessId { get; init; }
 85               public int Limit { get; init; } = 10;
 86           }
 87           
 88           /// <summary>
 89           /// Response to get business news.
 90           /// </summary>
 91           public record GetBusinessNewsResponse : MarketingResponse
 92           {
 93               public List<NewsItemDto> NewsItems { get; init; } = new();
 94           }
 95           
 96           /// <summary>
 97           /// Request to submit feedback.
 98           /// </summary>
 99           public record SubmitFeedbackRequest : IMediatorRequest<SubmitFeedbackResponse>
100           {
101               public long BusinessId { get; init; }
102               public required string UserId { get; init; }
103               public string? UserName { get; init; }
104               public string? UserEmail { get; init; }
105               public required string FeedbackType { get; init; }
106               public required string Subject { get; init; }
107               public required string Message { get; init; }
108               public int? Rating { get; init; }
109               public bool IsPublic { get; init; }
110               public double? Latitude { get; init; }
111               public double? Longitude { get; init; }
112           }
113           
114           /// <summary>
115           /// Response to submit feedback.
116           /// </summary>
117           public record SubmitFeedbackResponse : MarketingResponse
118           {
119               public long? FeedbackId { get; init; }
120           }
121           
122           /// <summary>
123           /// Request to upload feedback attachment.
124           /// </summary>
125           public record UploadFeedbackAttachmentRequest : IMediatorRequest<UploadFeedbackAttachmentResponse>
126           {
127               public long FeedbackId { get; init; }
128               public required string AttachmentType { get; init; } // "image" or "video"
129               public required string FileName { get; init; }
130               public required string ContentType { get; init; }
131               public required byte[] FileData { get; init; }
132           }
133           
134           /// <summary>
135           /// Response to upload feedback attachment.
136           /// </summary>
137           public record UploadFeedbackAttachmentResponse : MarketingResponse
138           {
139               public long? AttachmentId { get; init; }
140               public string? StorageUrl { get; init; }
141           }
142           
143           /// <summary>
144           /// Request to find nearby businesses.
145           /// </summary>
146           public record FindNearbyBusinessesRequest : IMediatorRequest<FindNearbyBusinessesResponse>
147           {
148               public double Latitude { get; init; }
149               public double Longitude { get; init; }
150               public int RadiusMeters { get; init; } = 1000;
151           }
152           
153           /// <summary>
154           /// Response to find nearby businesses.
155           /// </summary>
156           public record FindNearbyBusinessesResponse : MarketingResponse
157           {
158               public List<BusinessSummaryDto> Businesses { get; init; } = new();
159           }
160           
161           // DTOs
162           
163           /// <summary>
164           /// Complete business marketing data.
165           /// </summary>
166           public record BusinessMarketingDto
167           {
168               public long BusinessId { get; init; }
169               public required string BusinessName { get; init; }
170               public BusinessThemeDto? Theme { get; init; }
171               public List<CouponDto> Coupons { get; init; } = new();
172               public List<MenuItemDto> MenuItems { get; init; } = new();
173               public List<NewsItemDto> NewsItems { get; init; } = new();
174           }
175           
176           /// <summary>
177           /// Business theme data.
178           /// </summary>
179           public record BusinessThemeDto
180           {
181               public long Id { get; init; }
182               public long BusinessId { get; init; }
183               public required string ThemeName { get; init; }
184               public string? PrimaryColor { get; init; }
185               public string? SecondaryColor { get; init; }
186               public string? AccentColor { get; init; }
187               public string? BackgroundColor { get; init; }
188               public string? TextColor { get; init; }
189               public string? LogoUrl { get; init; }
190               public string? BackgroundImageUrl { get; init; }
191               public string? CustomCss { get; init; }
192           }
193           
194           /// <summary>
195           /// Coupon data.
196           /// </summary>
197           public record CouponDto
198           {
199               public long Id { get; init; }
200               public required string Title { get; init; }
201               public required string Description { get; init; }
202               public string? Code { get; init; }
203               public decimal? DiscountAmount { get; init; }
204               public decimal? DiscountPercentage { get; init; }
205               public string? ImageUrl { get; init; }
206               public DateTimeOffset ValidFrom { get; init; }
207               public DateTimeOffset ValidUntil { get; init; }
208               public int? MaxRedemptions { get; init; }
209               public int CurrentRedemptions { get; init; }
210           }
211           
212           /// <summary>
213           /// Menu item data.
214           /// </summary>
215           public record MenuItemDto
216           {
217               public long Id { get; init; }
218               public required string Name { get; init; }
219               public string? Description { get; init; }
220               public required string Category { get; init; }
221               public decimal? Price { get; init; }
222               public string? Currency { get; init; }
223               public string? ImageUrl { get; init; }
224               public int? Calories { get; init; }
225               public string? Allergens { get; init; }
226               public string? DietaryTags { get; init; }
227           }
228           
229           /// <summary>
230           /// News item data.
231           /// </summary>
232           public record NewsItemDto
233           {
234               public long Id { get; init; }
235               public required string Title { get; init; }
236               public required string Content { get; init; }
237               public string? Summary { get; init; }
238               public string? ImageUrl { get; init; }
239               public string? Author { get; init; }
240               public DateTimeOffset PublishedAt { get; init; }
241               public bool IsFeatured { get; init; }
242           }
243           
244           /// <summary>
245           /// Business summary data.
246           /// </summary>
247           public record BusinessSummaryDto
248           {
249               public long Id { get; init; }
250               public required string Name { get; init; }
251               public required string Address { get; init; }
252               public double Latitude { get; init; }
253               public double Longitude { get; init; }
254               public double? DistanceMeters { get; init; }
255               public bool IsSubscribed { get; init; }
256           }
```
# FWH.Orchestrix.Contracts.Marketing.GetBusinessMarketingRequest

## Summary

|||
|:---|:---|
| Class: | FWH.Orchestrix.Contracts.Marketing.GetBusinessMarketingRequest |
| Assembly: | FWH.Orchestrix.Contracts |
| **File(s):** | E:\github\FunWasHad\src\FWH.Orchestrix.Contracts\Marketing\MarketingContracts.cs |
| **Line coverage:** | 0% (0 of 2) |
| Covered lines: | 0 |
| Uncovered lines: | 2 |
| Coverable lines: | 2 |
| Total lines: | 256 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **.ctor(...)** | 100% | 2 | 1 | 0% |
| **get_BusinessId()** | 100% | 2 | 1 | 0% |

## File(s)

### E:\github\FunWasHad\src\FWH.Orchestrix.Contracts\Marketing\MarketingContracts.cs
```
  1           using FWH.Orchestrix.Contracts.Mediator;
  2           
  3           namespace FWH.Orchestrix.Contracts.Marketing;
  4           
  5           /// <summary>
  6           /// Base response for marketing operations.
  7           /// </summary>
  8           public record MarketingResponse
  9           {
 10               public bool Success { get; init; }
 11               public string? ErrorMessage { get; init; }
 12           }
 13           
 14           /// <summary>
 15           /// Request to get business marketing data.
 16           /// </summary>
 17  ❌ 0     public record GetBusinessMarketingRequest : IMediatorRequest<GetBusinessMarketingResponse>
 18           {
 19  ❌ 0         public long BusinessId { get; init; }
 20           }
 21           
 22           /// <summary>
 23           /// Response to get business marketing data.
 24           /// </summary>
 25           public record GetBusinessMarketingResponse : MarketingResponse
 26           {
 27               public BusinessMarketingDto? Data { get; init; }
 28           }
 29           
 30           /// <summary>
 31           /// Request to get business theme.
 32           /// </summary>
 33           public record GetBusinessThemeRequest : IMediatorRequest<GetBusinessThemeResponse>
 34           {
 35               public long BusinessId { get; init; }
 36           }
 37           
 38           /// <summary>
 39           /// Response to get business theme.
 40           /// </summary>
 41           public record GetBusinessThemeResponse : MarketingResponse
 42           {
 43               public BusinessThemeDto? Theme { get; init; }
 44           }
 45           
 46           /// <summary>
 47           /// Request to get business coupons.
 48           /// </summary>
 49           public record GetBusinessCouponsRequest : IMediatorRequest<GetBusinessCouponsResponse>
 50           {
 51               public long BusinessId { get; init; }
 52           }
 53           
 54           /// <summary>
 55           /// Response to get business coupons.
 56           /// </summary>
 57           public record GetBusinessCouponsResponse : MarketingResponse
 58           {
 59               public List<CouponDto> Coupons { get; init; } = new();
 60           }
 61           
 62           /// <summary>
 63           /// Request to get business menu.
 64           /// </summary>
 65           public record GetBusinessMenuRequest : IMediatorRequest<GetBusinessMenuResponse>
 66           {
 67               public long BusinessId { get; init; }
 68               public string? Category { get; init; }
 69           }
 70           
 71           /// <summary>
 72           /// Response to get business menu.
 73           /// </summary>
 74           public record GetBusinessMenuResponse : MarketingResponse
 75           {
 76               public List<MenuItemDto> MenuItems { get; init; } = new();
 77           }
 78           
 79           /// <summary>
 80           /// Request to get business news.
 81           /// </summary>
 82           public record GetBusinessNewsRequest : IMediatorRequest<GetBusinessNewsResponse>
 83           {
 84               public long BusinessId { get; init; }
 85               public int Limit { get; init; } = 10;
 86           }
 87           
 88           /// <summary>
 89           /// Response to get business news.
 90           /// </summary>
 91           public record GetBusinessNewsResponse : MarketingResponse
 92           {
 93               public List<NewsItemDto> NewsItems { get; init; } = new();
 94           }
 95           
 96           /// <summary>
 97           /// Request to submit feedback.
 98           /// </summary>
 99           public record SubmitFeedbackRequest : IMediatorRequest<SubmitFeedbackResponse>
100           {
101               public long BusinessId { get; init; }
102               public required string UserId { get; init; }
103               public string? UserName { get; init; }
104               public string? UserEmail { get; init; }
105               public required string FeedbackType { get; init; }
106               public required string Subject { get; init; }
107               public required string Message { get; init; }
108               public int? Rating { get; init; }
109               public bool IsPublic { get; init; }
110               public double? Latitude { get; init; }
111               public double? Longitude { get; init; }
112           }
113           
114           /// <summary>
115           /// Response to submit feedback.
116           /// </summary>
117           public record SubmitFeedbackResponse : MarketingResponse
118           {
119               public long? FeedbackId { get; init; }
120           }
121           
122           /// <summary>
123           /// Request to upload feedback attachment.
124           /// </summary>
125           public record UploadFeedbackAttachmentRequest : IMediatorRequest<UploadFeedbackAttachmentResponse>
126           {
127               public long FeedbackId { get; init; }
128               public required string AttachmentType { get; init; } // "image" or "video"
129               public required string FileName { get; init; }
130               public required string ContentType { get; init; }
131               public required byte[] FileData { get; init; }
132           }
133           
134           /// <summary>
135           /// Response to upload feedback attachment.
136           /// </summary>
137           public record UploadFeedbackAttachmentResponse : MarketingResponse
138           {
139               public long? AttachmentId { get; init; }
140               public string? StorageUrl { get; init; }
141           }
142           
143           /// <summary>
144           /// Request to find nearby businesses.
145           /// </summary>
146           public record FindNearbyBusinessesRequest : IMediatorRequest<FindNearbyBusinessesResponse>
147           {
148               public double Latitude { get; init; }
149               public double Longitude { get; init; }
150               public int RadiusMeters { get; init; } = 1000;
151           }
152           
153           /// <summary>
154           /// Response to find nearby businesses.
155           /// </summary>
156           public record FindNearbyBusinessesResponse : MarketingResponse
157           {
158               public List<BusinessSummaryDto> Businesses { get; init; } = new();
159           }
160           
161           // DTOs
162           
163           /// <summary>
164           /// Complete business marketing data.
165           /// </summary>
166           public record BusinessMarketingDto
167           {
168               public long BusinessId { get; init; }
169               public required string BusinessName { get; init; }
170               public BusinessThemeDto? Theme { get; init; }
171               public List<CouponDto> Coupons { get; init; } = new();
172               public List<MenuItemDto> MenuItems { get; init; } = new();
173               public List<NewsItemDto> NewsItems { get; init; } = new();
174           }
175           
176           /// <summary>
177           /// Business theme data.
178           /// </summary>
179           public record BusinessThemeDto
180           {
181               public long Id { get; init; }
182               public long BusinessId { get; init; }
183               public required string ThemeName { get; init; }
184               public string? PrimaryColor { get; init; }
185               public string? SecondaryColor { get; init; }
186               public string? AccentColor { get; init; }
187               public string? BackgroundColor { get; init; }
188               public string? TextColor { get; init; }
189               public string? LogoUrl { get; init; }
190               public string? BackgroundImageUrl { get; init; }
191               public string? CustomCss { get; init; }
192           }
193           
194           /// <summary>
195           /// Coupon data.
196           /// </summary>
197           public record CouponDto
198           {
199               public long Id { get; init; }
200               public required string Title { get; init; }
201               public required string Description { get; init; }
202               public string? Code { get; init; }
203               public decimal? DiscountAmount { get; init; }
204               public decimal? DiscountPercentage { get; init; }
205               public string? ImageUrl { get; init; }
206               public DateTimeOffset ValidFrom { get; init; }
207               public DateTimeOffset ValidUntil { get; init; }
208               public int? MaxRedemptions { get; init; }
209               public int CurrentRedemptions { get; init; }
210           }
211           
212           /// <summary>
213           /// Menu item data.
214           /// </summary>
215           public record MenuItemDto
216           {
217               public long Id { get; init; }
218               public required string Name { get; init; }
219               public string? Description { get; init; }
220               public required string Category { get; init; }
221               public decimal? Price { get; init; }
222               public string? Currency { get; init; }
223               public string? ImageUrl { get; init; }
224               public int? Calories { get; init; }
225               public string? Allergens { get; init; }
226               public string? DietaryTags { get; init; }
227           }
228           
229           /// <summary>
230           /// News item data.
231           /// </summary>
232           public record NewsItemDto
233           {
234               public long Id { get; init; }
235               public required string Title { get; init; }
236               public required string Content { get; init; }
237               public string? Summary { get; init; }
238               public string? ImageUrl { get; init; }
239               public string? Author { get; init; }
240               public DateTimeOffset PublishedAt { get; init; }
241               public bool IsFeatured { get; init; }
242           }
243           
244           /// <summary>
245           /// Business summary data.
246           /// </summary>
247           public record BusinessSummaryDto
248           {
249               public long Id { get; init; }
250               public required string Name { get; init; }
251               public required string Address { get; init; }
252               public double Latitude { get; init; }
253               public double Longitude { get; init; }
254               public double? DistanceMeters { get; init; }
255               public bool IsSubscribed { get; init; }
256           }
```
# FWH.Orchestrix.Contracts.Marketing.GetBusinessMarketingResponse

## Summary

|||
|:---|:---|
| Class: | FWH.Orchestrix.Contracts.Marketing.GetBusinessMarketingResponse |
| Assembly: | FWH.Orchestrix.Contracts |
| **File(s):** | E:\github\FunWasHad\src\FWH.Orchestrix.Contracts\Marketing\MarketingContracts.cs |
| **Line coverage:** | 0% (0 of 2) |
| Covered lines: | 0 |
| Uncovered lines: | 2 |
| Coverable lines: | 2 |
| Total lines: | 256 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **.ctor(...)** | 100% | 2 | 1 | 0% |
| **get_Data()** | 100% | 2 | 1 | 0% |

## File(s)

### E:\github\FunWasHad\src\FWH.Orchestrix.Contracts\Marketing\MarketingContracts.cs
```
  1           using FWH.Orchestrix.Contracts.Mediator;
  2           
  3           namespace FWH.Orchestrix.Contracts.Marketing;
  4           
  5           /// <summary>
  6           /// Base response for marketing operations.
  7           /// </summary>
  8           public record MarketingResponse
  9           {
 10               public bool Success { get; init; }
 11               public string? ErrorMessage { get; init; }
 12           }
 13           
 14           /// <summary>
 15           /// Request to get business marketing data.
 16           /// </summary>
 17           public record GetBusinessMarketingRequest : IMediatorRequest<GetBusinessMarketingResponse>
 18           {
 19               public long BusinessId { get; init; }
 20           }
 21           
 22           /// <summary>
 23           /// Response to get business marketing data.
 24           /// </summary>
 25  ❌ 0     public record GetBusinessMarketingResponse : MarketingResponse
 26           {
 27  ❌ 0         public BusinessMarketingDto? Data { get; init; }
 28           }
 29           
 30           /// <summary>
 31           /// Request to get business theme.
 32           /// </summary>
 33           public record GetBusinessThemeRequest : IMediatorRequest<GetBusinessThemeResponse>
 34           {
 35               public long BusinessId { get; init; }
 36           }
 37           
 38           /// <summary>
 39           /// Response to get business theme.
 40           /// </summary>
 41           public record GetBusinessThemeResponse : MarketingResponse
 42           {
 43               public BusinessThemeDto? Theme { get; init; }
 44           }
 45           
 46           /// <summary>
 47           /// Request to get business coupons.
 48           /// </summary>
 49           public record GetBusinessCouponsRequest : IMediatorRequest<GetBusinessCouponsResponse>
 50           {
 51               public long BusinessId { get; init; }
 52           }
 53           
 54           /// <summary>
 55           /// Response to get business coupons.
 56           /// </summary>
 57           public record GetBusinessCouponsResponse : MarketingResponse
 58           {
 59               public List<CouponDto> Coupons { get; init; } = new();
 60           }
 61           
 62           /// <summary>
 63           /// Request to get business menu.
 64           /// </summary>
 65           public record GetBusinessMenuRequest : IMediatorRequest<GetBusinessMenuResponse>
 66           {
 67               public long BusinessId { get; init; }
 68               public string? Category { get; init; }
 69           }
 70           
 71           /// <summary>
 72           /// Response to get business menu.
 73           /// </summary>
 74           public record GetBusinessMenuResponse : MarketingResponse
 75           {
 76               public List<MenuItemDto> MenuItems { get; init; } = new();
 77           }
 78           
 79           /// <summary>
 80           /// Request to get business news.
 81           /// </summary>
 82           public record GetBusinessNewsRequest : IMediatorRequest<GetBusinessNewsResponse>
 83           {
 84               public long BusinessId { get; init; }
 85               public int Limit { get; init; } = 10;
 86           }
 87           
 88           /// <summary>
 89           /// Response to get business news.
 90           /// </summary>
 91           public record GetBusinessNewsResponse : MarketingResponse
 92           {
 93               public List<NewsItemDto> NewsItems { get; init; } = new();
 94           }
 95           
 96           /// <summary>
 97           /// Request to submit feedback.
 98           /// </summary>
 99           public record SubmitFeedbackRequest : IMediatorRequest<SubmitFeedbackResponse>
100           {
101               public long BusinessId { get; init; }
102               public required string UserId { get; init; }
103               public string? UserName { get; init; }
104               public string? UserEmail { get; init; }
105               public required string FeedbackType { get; init; }
106               public required string Subject { get; init; }
107               public required string Message { get; init; }
108               public int? Rating { get; init; }
109               public bool IsPublic { get; init; }
110               public double? Latitude { get; init; }
111               public double? Longitude { get; init; }
112           }
113           
114           /// <summary>
115           /// Response to submit feedback.
116           /// </summary>
117           public record SubmitFeedbackResponse : MarketingResponse
118           {
119               public long? FeedbackId { get; init; }
120           }
121           
122           /// <summary>
123           /// Request to upload feedback attachment.
124           /// </summary>
125           public record UploadFeedbackAttachmentRequest : IMediatorRequest<UploadFeedbackAttachmentResponse>
126           {
127               public long FeedbackId { get; init; }
128               public required string AttachmentType { get; init; } // "image" or "video"
129               public required string FileName { get; init; }
130               public required string ContentType { get; init; }
131               public required byte[] FileData { get; init; }
132           }
133           
134           /// <summary>
135           /// Response to upload feedback attachment.
136           /// </summary>
137           public record UploadFeedbackAttachmentResponse : MarketingResponse
138           {
139               public long? AttachmentId { get; init; }
140               public string? StorageUrl { get; init; }
141           }
142           
143           /// <summary>
144           /// Request to find nearby businesses.
145           /// </summary>
146           public record FindNearbyBusinessesRequest : IMediatorRequest<FindNearbyBusinessesResponse>
147           {
148               public double Latitude { get; init; }
149               public double Longitude { get; init; }
150               public int RadiusMeters { get; init; } = 1000;
151           }
152           
153           /// <summary>
154           /// Response to find nearby businesses.
155           /// </summary>
156           public record FindNearbyBusinessesResponse : MarketingResponse
157           {
158               public List<BusinessSummaryDto> Businesses { get; init; } = new();
159           }
160           
161           // DTOs
162           
163           /// <summary>
164           /// Complete business marketing data.
165           /// </summary>
166           public record BusinessMarketingDto
167           {
168               public long BusinessId { get; init; }
169               public required string BusinessName { get; init; }
170               public BusinessThemeDto? Theme { get; init; }
171               public List<CouponDto> Coupons { get; init; } = new();
172               public List<MenuItemDto> MenuItems { get; init; } = new();
173               public List<NewsItemDto> NewsItems { get; init; } = new();
174           }
175           
176           /// <summary>
177           /// Business theme data.
178           /// </summary>
179           public record BusinessThemeDto
180           {
181               public long Id { get; init; }
182               public long BusinessId { get; init; }
183               public required string ThemeName { get; init; }
184               public string? PrimaryColor { get; init; }
185               public string? SecondaryColor { get; init; }
186               public string? AccentColor { get; init; }
187               public string? BackgroundColor { get; init; }
188               public string? TextColor { get; init; }
189               public string? LogoUrl { get; init; }
190               public string? BackgroundImageUrl { get; init; }
191               public string? CustomCss { get; init; }
192           }
193           
194           /// <summary>
195           /// Coupon data.
196           /// </summary>
197           public record CouponDto
198           {
199               public long Id { get; init; }
200               public required string Title { get; init; }
201               public required string Description { get; init; }
202               public string? Code { get; init; }
203               public decimal? DiscountAmount { get; init; }
204               public decimal? DiscountPercentage { get; init; }
205               public string? ImageUrl { get; init; }
206               public DateTimeOffset ValidFrom { get; init; }
207               public DateTimeOffset ValidUntil { get; init; }
208               public int? MaxRedemptions { get; init; }
209               public int CurrentRedemptions { get; init; }
210           }
211           
212           /// <summary>
213           /// Menu item data.
214           /// </summary>
215           public record MenuItemDto
216           {
217               public long Id { get; init; }
218               public required string Name { get; init; }
219               public string? Description { get; init; }
220               public required string Category { get; init; }
221               public decimal? Price { get; init; }
222               public string? Currency { get; init; }
223               public string? ImageUrl { get; init; }
224               public int? Calories { get; init; }
225               public string? Allergens { get; init; }
226               public string? DietaryTags { get; init; }
227           }
228           
229           /// <summary>
230           /// News item data.
231           /// </summary>
232           public record NewsItemDto
233           {
234               public long Id { get; init; }
235               public required string Title { get; init; }
236               public required string Content { get; init; }
237               public string? Summary { get; init; }
238               public string? ImageUrl { get; init; }
239               public string? Author { get; init; }
240               public DateTimeOffset PublishedAt { get; init; }
241               public bool IsFeatured { get; init; }
242           }
243           
244           /// <summary>
245           /// Business summary data.
246           /// </summary>
247           public record BusinessSummaryDto
248           {
249               public long Id { get; init; }
250               public required string Name { get; init; }
251               public required string Address { get; init; }
252               public double Latitude { get; init; }
253               public double Longitude { get; init; }
254               public double? DistanceMeters { get; init; }
255               public bool IsSubscribed { get; init; }
256           }
```
# FWH.Orchestrix.Contracts.Marketing.GetBusinessMenuRequest

## Summary

|||
|:---|:---|
| Class: | FWH.Orchestrix.Contracts.Marketing.GetBusinessMenuRequest |
| Assembly: | FWH.Orchestrix.Contracts |
| **File(s):** | E:\github\FunWasHad\src\FWH.Orchestrix.Contracts\Marketing\MarketingContracts.cs |
| **Line coverage:** | 0% (0 of 3) |
| Covered lines: | 0 |
| Uncovered lines: | 3 |
| Coverable lines: | 3 |
| Total lines: | 256 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **.ctor(...)** | 100% | 2 | 1 | 0% |
| **get_BusinessId()** | 100% | 2 | 1 | 0% |
| **get_Category()** | 100% | 2 | 1 | 0% |

## File(s)

### E:\github\FunWasHad\src\FWH.Orchestrix.Contracts\Marketing\MarketingContracts.cs
```
  1           using FWH.Orchestrix.Contracts.Mediator;
  2           
  3           namespace FWH.Orchestrix.Contracts.Marketing;
  4           
  5           /// <summary>
  6           /// Base response for marketing operations.
  7           /// </summary>
  8           public record MarketingResponse
  9           {
 10               public bool Success { get; init; }
 11               public string? ErrorMessage { get; init; }
 12           }
 13           
 14           /// <summary>
 15           /// Request to get business marketing data.
 16           /// </summary>
 17           public record GetBusinessMarketingRequest : IMediatorRequest<GetBusinessMarketingResponse>
 18           {
 19               public long BusinessId { get; init; }
 20           }
 21           
 22           /// <summary>
 23           /// Response to get business marketing data.
 24           /// </summary>
 25           public record GetBusinessMarketingResponse : MarketingResponse
 26           {
 27               public BusinessMarketingDto? Data { get; init; }
 28           }
 29           
 30           /// <summary>
 31           /// Request to get business theme.
 32           /// </summary>
 33           public record GetBusinessThemeRequest : IMediatorRequest<GetBusinessThemeResponse>
 34           {
 35               public long BusinessId { get; init; }
 36           }
 37           
 38           /// <summary>
 39           /// Response to get business theme.
 40           /// </summary>
 41           public record GetBusinessThemeResponse : MarketingResponse
 42           {
 43               public BusinessThemeDto? Theme { get; init; }
 44           }
 45           
 46           /// <summary>
 47           /// Request to get business coupons.
 48           /// </summary>
 49           public record GetBusinessCouponsRequest : IMediatorRequest<GetBusinessCouponsResponse>
 50           {
 51               public long BusinessId { get; init; }
 52           }
 53           
 54           /// <summary>
 55           /// Response to get business coupons.
 56           /// </summary>
 57           public record GetBusinessCouponsResponse : MarketingResponse
 58           {
 59               public List<CouponDto> Coupons { get; init; } = new();
 60           }
 61           
 62           /// <summary>
 63           /// Request to get business menu.
 64           /// </summary>
 65  ❌ 0     public record GetBusinessMenuRequest : IMediatorRequest<GetBusinessMenuResponse>
 66           {
 67  ❌ 0         public long BusinessId { get; init; }
 68  ❌ 0         public string? Category { get; init; }
 69           }
 70           
 71           /// <summary>
 72           /// Response to get business menu.
 73           /// </summary>
 74           public record GetBusinessMenuResponse : MarketingResponse
 75           {
 76               public List<MenuItemDto> MenuItems { get; init; } = new();
 77           }
 78           
 79           /// <summary>
 80           /// Request to get business news.
 81           /// </summary>
 82           public record GetBusinessNewsRequest : IMediatorRequest<GetBusinessNewsResponse>
 83           {
 84               public long BusinessId { get; init; }
 85               public int Limit { get; init; } = 10;
 86           }
 87           
 88           /// <summary>
 89           /// Response to get business news.
 90           /// </summary>
 91           public record GetBusinessNewsResponse : MarketingResponse
 92           {
 93               public List<NewsItemDto> NewsItems { get; init; } = new();
 94           }
 95           
 96           /// <summary>
 97           /// Request to submit feedback.
 98           /// </summary>
 99           public record SubmitFeedbackRequest : IMediatorRequest<SubmitFeedbackResponse>
100           {
101               public long BusinessId { get; init; }
102               public required string UserId { get; init; }
103               public string? UserName { get; init; }
104               public string? UserEmail { get; init; }
105               public required string FeedbackType { get; init; }
106               public required string Subject { get; init; }
107               public required string Message { get; init; }
108               public int? Rating { get; init; }
109               public bool IsPublic { get; init; }
110               public double? Latitude { get; init; }
111               public double? Longitude { get; init; }
112           }
113           
114           /// <summary>
115           /// Response to submit feedback.
116           /// </summary>
117           public record SubmitFeedbackResponse : MarketingResponse
118           {
119               public long? FeedbackId { get; init; }
120           }
121           
122           /// <summary>
123           /// Request to upload feedback attachment.
124           /// </summary>
125           public record UploadFeedbackAttachmentRequest : IMediatorRequest<UploadFeedbackAttachmentResponse>
126           {
127               public long FeedbackId { get; init; }
128               public required string AttachmentType { get; init; } // "image" or "video"
129               public required string FileName { get; init; }
130               public required string ContentType { get; init; }
131               public required byte[] FileData { get; init; }
132           }
133           
134           /// <summary>
135           /// Response to upload feedback attachment.
136           /// </summary>
137           public record UploadFeedbackAttachmentResponse : MarketingResponse
138           {
139               public long? AttachmentId { get; init; }
140               public string? StorageUrl { get; init; }
141           }
142           
143           /// <summary>
144           /// Request to find nearby businesses.
145           /// </summary>
146           public record FindNearbyBusinessesRequest : IMediatorRequest<FindNearbyBusinessesResponse>
147           {
148               public double Latitude { get; init; }
149               public double Longitude { get; init; }
150               public int RadiusMeters { get; init; } = 1000;
151           }
152           
153           /// <summary>
154           /// Response to find nearby businesses.
155           /// </summary>
156           public record FindNearbyBusinessesResponse : MarketingResponse
157           {
158               public List<BusinessSummaryDto> Businesses { get; init; } = new();
159           }
160           
161           // DTOs
162           
163           /// <summary>
164           /// Complete business marketing data.
165           /// </summary>
166           public record BusinessMarketingDto
167           {
168               public long BusinessId { get; init; }
169               public required string BusinessName { get; init; }
170               public BusinessThemeDto? Theme { get; init; }
171               public List<CouponDto> Coupons { get; init; } = new();
172               public List<MenuItemDto> MenuItems { get; init; } = new();
173               public List<NewsItemDto> NewsItems { get; init; } = new();
174           }
175           
176           /// <summary>
177           /// Business theme data.
178           /// </summary>
179           public record BusinessThemeDto
180           {
181               public long Id { get; init; }
182               public long BusinessId { get; init; }
183               public required string ThemeName { get; init; }
184               public string? PrimaryColor { get; init; }
185               public string? SecondaryColor { get; init; }
186               public string? AccentColor { get; init; }
187               public string? BackgroundColor { get; init; }
188               public string? TextColor { get; init; }
189               public string? LogoUrl { get; init; }
190               public string? BackgroundImageUrl { get; init; }
191               public string? CustomCss { get; init; }
192           }
193           
194           /// <summary>
195           /// Coupon data.
196           /// </summary>
197           public record CouponDto
198           {
199               public long Id { get; init; }
200               public required string Title { get; init; }
201               public required string Description { get; init; }
202               public string? Code { get; init; }
203               public decimal? DiscountAmount { get; init; }
204               public decimal? DiscountPercentage { get; init; }
205               public string? ImageUrl { get; init; }
206               public DateTimeOffset ValidFrom { get; init; }
207               public DateTimeOffset ValidUntil { get; init; }
208               public int? MaxRedemptions { get; init; }
209               public int CurrentRedemptions { get; init; }
210           }
211           
212           /// <summary>
213           /// Menu item data.
214           /// </summary>
215           public record MenuItemDto
216           {
217               public long Id { get; init; }
218               public required string Name { get; init; }
219               public string? Description { get; init; }
220               public required string Category { get; init; }
221               public decimal? Price { get; init; }
222               public string? Currency { get; init; }
223               public string? ImageUrl { get; init; }
224               public int? Calories { get; init; }
225               public string? Allergens { get; init; }
226               public string? DietaryTags { get; init; }
227           }
228           
229           /// <summary>
230           /// News item data.
231           /// </summary>
232           public record NewsItemDto
233           {
234               public long Id { get; init; }
235               public required string Title { get; init; }
236               public required string Content { get; init; }
237               public string? Summary { get; init; }
238               public string? ImageUrl { get; init; }
239               public string? Author { get; init; }
240               public DateTimeOffset PublishedAt { get; init; }
241               public bool IsFeatured { get; init; }
242           }
243           
244           /// <summary>
245           /// Business summary data.
246           /// </summary>
247           public record BusinessSummaryDto
248           {
249               public long Id { get; init; }
250               public required string Name { get; init; }
251               public required string Address { get; init; }
252               public double Latitude { get; init; }
253               public double Longitude { get; init; }
254               public double? DistanceMeters { get; init; }
255               public bool IsSubscribed { get; init; }
256           }
```
# FWH.Orchestrix.Contracts.Marketing.GetBusinessMenuResponse

## Summary

|||
|:---|:---|
| Class: | FWH.Orchestrix.Contracts.Marketing.GetBusinessMenuResponse |
| Assembly: | FWH.Orchestrix.Contracts |
| **File(s):** | E:\github\FunWasHad\src\FWH.Orchestrix.Contracts\Marketing\MarketingContracts.cs |
| **Line coverage:** | 0% (0 of 2) |
| Covered lines: | 0 |
| Uncovered lines: | 2 |
| Coverable lines: | 2 |
| Total lines: | 256 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **.ctor(...)** | 100% | 2 | 1 | 0% |
| **get_MenuItems()** | 100% | 2 | 1 | 0% |

## File(s)

### E:\github\FunWasHad\src\FWH.Orchestrix.Contracts\Marketing\MarketingContracts.cs
```
  1           using FWH.Orchestrix.Contracts.Mediator;
  2           
  3           namespace FWH.Orchestrix.Contracts.Marketing;
  4           
  5           /// <summary>
  6           /// Base response for marketing operations.
  7           /// </summary>
  8           public record MarketingResponse
  9           {
 10               public bool Success { get; init; }
 11               public string? ErrorMessage { get; init; }
 12           }
 13           
 14           /// <summary>
 15           /// Request to get business marketing data.
 16           /// </summary>
 17           public record GetBusinessMarketingRequest : IMediatorRequest<GetBusinessMarketingResponse>
 18           {
 19               public long BusinessId { get; init; }
 20           }
 21           
 22           /// <summary>
 23           /// Response to get business marketing data.
 24           /// </summary>
 25           public record GetBusinessMarketingResponse : MarketingResponse
 26           {
 27               public BusinessMarketingDto? Data { get; init; }
 28           }
 29           
 30           /// <summary>
 31           /// Request to get business theme.
 32           /// </summary>
 33           public record GetBusinessThemeRequest : IMediatorRequest<GetBusinessThemeResponse>
 34           {
 35               public long BusinessId { get; init; }
 36           }
 37           
 38           /// <summary>
 39           /// Response to get business theme.
 40           /// </summary>
 41           public record GetBusinessThemeResponse : MarketingResponse
 42           {
 43               public BusinessThemeDto? Theme { get; init; }
 44           }
 45           
 46           /// <summary>
 47           /// Request to get business coupons.
 48           /// </summary>
 49           public record GetBusinessCouponsRequest : IMediatorRequest<GetBusinessCouponsResponse>
 50           {
 51               public long BusinessId { get; init; }
 52           }
 53           
 54           /// <summary>
 55           /// Response to get business coupons.
 56           /// </summary>
 57           public record GetBusinessCouponsResponse : MarketingResponse
 58           {
 59               public List<CouponDto> Coupons { get; init; } = new();
 60           }
 61           
 62           /// <summary>
 63           /// Request to get business menu.
 64           /// </summary>
 65           public record GetBusinessMenuRequest : IMediatorRequest<GetBusinessMenuResponse>
 66           {
 67               public long BusinessId { get; init; }
 68               public string? Category { get; init; }
 69           }
 70           
 71           /// <summary>
 72           /// Response to get business menu.
 73           /// </summary>
 74  ❌ 0     public record GetBusinessMenuResponse : MarketingResponse
 75           {
 76  ❌ 0         public List<MenuItemDto> MenuItems { get; init; } = new();
 77           }
 78           
 79           /// <summary>
 80           /// Request to get business news.
 81           /// </summary>
 82           public record GetBusinessNewsRequest : IMediatorRequest<GetBusinessNewsResponse>
 83           {
 84               public long BusinessId { get; init; }
 85               public int Limit { get; init; } = 10;
 86           }
 87           
 88           /// <summary>
 89           /// Response to get business news.
 90           /// </summary>
 91           public record GetBusinessNewsResponse : MarketingResponse
 92           {
 93               public List<NewsItemDto> NewsItems { get; init; } = new();
 94           }
 95           
 96           /// <summary>
 97           /// Request to submit feedback.
 98           /// </summary>
 99           public record SubmitFeedbackRequest : IMediatorRequest<SubmitFeedbackResponse>
100           {
101               public long BusinessId { get; init; }
102               public required string UserId { get; init; }
103               public string? UserName { get; init; }
104               public string? UserEmail { get; init; }
105               public required string FeedbackType { get; init; }
106               public required string Subject { get; init; }
107               public required string Message { get; init; }
108               public int? Rating { get; init; }
109               public bool IsPublic { get; init; }
110               public double? Latitude { get; init; }
111               public double? Longitude { get; init; }
112           }
113           
114           /// <summary>
115           /// Response to submit feedback.
116           /// </summary>
117           public record SubmitFeedbackResponse : MarketingResponse
118           {
119               public long? FeedbackId { get; init; }
120           }
121           
122           /// <summary>
123           /// Request to upload feedback attachment.
124           /// </summary>
125           public record UploadFeedbackAttachmentRequest : IMediatorRequest<UploadFeedbackAttachmentResponse>
126           {
127               public long FeedbackId { get; init; }
128               public required string AttachmentType { get; init; } // "image" or "video"
129               public required string FileName { get; init; }
130               public required string ContentType { get; init; }
131               public required byte[] FileData { get; init; }
132           }
133           
134           /// <summary>
135           /// Response to upload feedback attachment.
136           /// </summary>
137           public record UploadFeedbackAttachmentResponse : MarketingResponse
138           {
139               public long? AttachmentId { get; init; }
140               public string? StorageUrl { get; init; }
141           }
142           
143           /// <summary>
144           /// Request to find nearby businesses.
145           /// </summary>
146           public record FindNearbyBusinessesRequest : IMediatorRequest<FindNearbyBusinessesResponse>
147           {
148               public double Latitude { get; init; }
149               public double Longitude { get; init; }
150               public int RadiusMeters { get; init; } = 1000;
151           }
152           
153           /// <summary>
154           /// Response to find nearby businesses.
155           /// </summary>
156           public record FindNearbyBusinessesResponse : MarketingResponse
157           {
158               public List<BusinessSummaryDto> Businesses { get; init; } = new();
159           }
160           
161           // DTOs
162           
163           /// <summary>
164           /// Complete business marketing data.
165           /// </summary>
166           public record BusinessMarketingDto
167           {
168               public long BusinessId { get; init; }
169               public required string BusinessName { get; init; }
170               public BusinessThemeDto? Theme { get; init; }
171               public List<CouponDto> Coupons { get; init; } = new();
172               public List<MenuItemDto> MenuItems { get; init; } = new();
173               public List<NewsItemDto> NewsItems { get; init; } = new();
174           }
175           
176           /// <summary>
177           /// Business theme data.
178           /// </summary>
179           public record BusinessThemeDto
180           {
181               public long Id { get; init; }
182               public long BusinessId { get; init; }
183               public required string ThemeName { get; init; }
184               public string? PrimaryColor { get; init; }
185               public string? SecondaryColor { get; init; }
186               public string? AccentColor { get; init; }
187               public string? BackgroundColor { get; init; }
188               public string? TextColor { get; init; }
189               public string? LogoUrl { get; init; }
190               public string? BackgroundImageUrl { get; init; }
191               public string? CustomCss { get; init; }
192           }
193           
194           /// <summary>
195           /// Coupon data.
196           /// </summary>
197           public record CouponDto
198           {
199               public long Id { get; init; }
200               public required string Title { get; init; }
201               public required string Description { get; init; }
202               public string? Code { get; init; }
203               public decimal? DiscountAmount { get; init; }
204               public decimal? DiscountPercentage { get; init; }
205               public string? ImageUrl { get; init; }
206               public DateTimeOffset ValidFrom { get; init; }
207               public DateTimeOffset ValidUntil { get; init; }
208               public int? MaxRedemptions { get; init; }
209               public int CurrentRedemptions { get; init; }
210           }
211           
212           /// <summary>
213           /// Menu item data.
214           /// </summary>
215           public record MenuItemDto
216           {
217               public long Id { get; init; }
218               public required string Name { get; init; }
219               public string? Description { get; init; }
220               public required string Category { get; init; }
221               public decimal? Price { get; init; }
222               public string? Currency { get; init; }
223               public string? ImageUrl { get; init; }
224               public int? Calories { get; init; }
225               public string? Allergens { get; init; }
226               public string? DietaryTags { get; init; }
227           }
228           
229           /// <summary>
230           /// News item data.
231           /// </summary>
232           public record NewsItemDto
233           {
234               public long Id { get; init; }
235               public required string Title { get; init; }
236               public required string Content { get; init; }
237               public string? Summary { get; init; }
238               public string? ImageUrl { get; init; }
239               public string? Author { get; init; }
240               public DateTimeOffset PublishedAt { get; init; }
241               public bool IsFeatured { get; init; }
242           }
243           
244           /// <summary>
245           /// Business summary data.
246           /// </summary>
247           public record BusinessSummaryDto
248           {
249               public long Id { get; init; }
250               public required string Name { get; init; }
251               public required string Address { get; init; }
252               public double Latitude { get; init; }
253               public double Longitude { get; init; }
254               public double? DistanceMeters { get; init; }
255               public bool IsSubscribed { get; init; }
256           }
```
# FWH.Orchestrix.Contracts.Marketing.GetBusinessNewsRequest

## Summary

|||
|:---|:---|
| Class: | FWH.Orchestrix.Contracts.Marketing.GetBusinessNewsRequest |
| Assembly: | FWH.Orchestrix.Contracts |
| **File(s):** | E:\github\FunWasHad\src\FWH.Orchestrix.Contracts\Marketing\MarketingContracts.cs |
| **Line coverage:** | 0% (0 of 3) |
| Covered lines: | 0 |
| Uncovered lines: | 3 |
| Coverable lines: | 3 |
| Total lines: | 256 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **.ctor(...)** | 100% | 2 | 1 | 0% |
| **get_BusinessId()** | 100% | 2 | 1 | 0% |
| **get_Limit()** | 100% | 2 | 1 | 0% |

## File(s)

### E:\github\FunWasHad\src\FWH.Orchestrix.Contracts\Marketing\MarketingContracts.cs
```
  1           using FWH.Orchestrix.Contracts.Mediator;
  2           
  3           namespace FWH.Orchestrix.Contracts.Marketing;
  4           
  5           /// <summary>
  6           /// Base response for marketing operations.
  7           /// </summary>
  8           public record MarketingResponse
  9           {
 10               public bool Success { get; init; }
 11               public string? ErrorMessage { get; init; }
 12           }
 13           
 14           /// <summary>
 15           /// Request to get business marketing data.
 16           /// </summary>
 17           public record GetBusinessMarketingRequest : IMediatorRequest<GetBusinessMarketingResponse>
 18           {
 19               public long BusinessId { get; init; }
 20           }
 21           
 22           /// <summary>
 23           /// Response to get business marketing data.
 24           /// </summary>
 25           public record GetBusinessMarketingResponse : MarketingResponse
 26           {
 27               public BusinessMarketingDto? Data { get; init; }
 28           }
 29           
 30           /// <summary>
 31           /// Request to get business theme.
 32           /// </summary>
 33           public record GetBusinessThemeRequest : IMediatorRequest<GetBusinessThemeResponse>
 34           {
 35               public long BusinessId { get; init; }
 36           }
 37           
 38           /// <summary>
 39           /// Response to get business theme.
 40           /// </summary>
 41           public record GetBusinessThemeResponse : MarketingResponse
 42           {
 43               public BusinessThemeDto? Theme { get; init; }
 44           }
 45           
 46           /// <summary>
 47           /// Request to get business coupons.
 48           /// </summary>
 49           public record GetBusinessCouponsRequest : IMediatorRequest<GetBusinessCouponsResponse>
 50           {
 51               public long BusinessId { get; init; }
 52           }
 53           
 54           /// <summary>
 55           /// Response to get business coupons.
 56           /// </summary>
 57           public record GetBusinessCouponsResponse : MarketingResponse
 58           {
 59               public List<CouponDto> Coupons { get; init; } = new();
 60           }
 61           
 62           /// <summary>
 63           /// Request to get business menu.
 64           /// </summary>
 65           public record GetBusinessMenuRequest : IMediatorRequest<GetBusinessMenuResponse>
 66           {
 67               public long BusinessId { get; init; }
 68               public string? Category { get; init; }
 69           }
 70           
 71           /// <summary>
 72           /// Response to get business menu.
 73           /// </summary>
 74           public record GetBusinessMenuResponse : MarketingResponse
 75           {
 76               public List<MenuItemDto> MenuItems { get; init; } = new();
 77           }
 78           
 79           /// <summary>
 80           /// Request to get business news.
 81           /// </summary>
 82  ❌ 0     public record GetBusinessNewsRequest : IMediatorRequest<GetBusinessNewsResponse>
 83           {
 84  ❌ 0         public long BusinessId { get; init; }
 85  ❌ 0         public int Limit { get; init; } = 10;
 86           }
 87           
 88           /// <summary>
 89           /// Response to get business news.
 90           /// </summary>
 91           public record GetBusinessNewsResponse : MarketingResponse
 92           {
 93               public List<NewsItemDto> NewsItems { get; init; } = new();
 94           }
 95           
 96           /// <summary>
 97           /// Request to submit feedback.
 98           /// </summary>
 99           public record SubmitFeedbackRequest : IMediatorRequest<SubmitFeedbackResponse>
100           {
101               public long BusinessId { get; init; }
102               public required string UserId { get; init; }
103               public string? UserName { get; init; }
104               public string? UserEmail { get; init; }
105               public required string FeedbackType { get; init; }
106               public required string Subject { get; init; }
107               public required string Message { get; init; }
108               public int? Rating { get; init; }
109               public bool IsPublic { get; init; }
110               public double? Latitude { get; init; }
111               public double? Longitude { get; init; }
112           }
113           
114           /// <summary>
115           /// Response to submit feedback.
116           /// </summary>
117           public record SubmitFeedbackResponse : MarketingResponse
118           {
119               public long? FeedbackId { get; init; }
120           }
121           
122           /// <summary>
123           /// Request to upload feedback attachment.
124           /// </summary>
125           public record UploadFeedbackAttachmentRequest : IMediatorRequest<UploadFeedbackAttachmentResponse>
126           {
127               public long FeedbackId { get; init; }
128               public required string AttachmentType { get; init; } // "image" or "video"
129               public required string FileName { get; init; }
130               public required string ContentType { get; init; }
131               public required byte[] FileData { get; init; }
132           }
133           
134           /// <summary>
135           /// Response to upload feedback attachment.
136           /// </summary>
137           public record UploadFeedbackAttachmentResponse : MarketingResponse
138           {
139               public long? AttachmentId { get; init; }
140               public string? StorageUrl { get; init; }
141           }
142           
143           /// <summary>
144           /// Request to find nearby businesses.
145           /// </summary>
146           public record FindNearbyBusinessesRequest : IMediatorRequest<FindNearbyBusinessesResponse>
147           {
148               public double Latitude { get; init; }
149               public double Longitude { get; init; }
150               public int RadiusMeters { get; init; } = 1000;
151           }
152           
153           /// <summary>
154           /// Response to find nearby businesses.
155           /// </summary>
156           public record FindNearbyBusinessesResponse : MarketingResponse
157           {
158               public List<BusinessSummaryDto> Businesses { get; init; } = new();
159           }
160           
161           // DTOs
162           
163           /// <summary>
164           /// Complete business marketing data.
165           /// </summary>
166           public record BusinessMarketingDto
167           {
168               public long BusinessId { get; init; }
169               public required string BusinessName { get; init; }
170               public BusinessThemeDto? Theme { get; init; }
171               public List<CouponDto> Coupons { get; init; } = new();
172               public List<MenuItemDto> MenuItems { get; init; } = new();
173               public List<NewsItemDto> NewsItems { get; init; } = new();
174           }
175           
176           /// <summary>
177           /// Business theme data.
178           /// </summary>
179           public record BusinessThemeDto
180           {
181               public long Id { get; init; }
182               public long BusinessId { get; init; }
183               public required string ThemeName { get; init; }
184               public string? PrimaryColor { get; init; }
185               public string? SecondaryColor { get; init; }
186               public string? AccentColor { get; init; }
187               public string? BackgroundColor { get; init; }
188               public string? TextColor { get; init; }
189               public string? LogoUrl { get; init; }
190               public string? BackgroundImageUrl { get; init; }
191               public string? CustomCss { get; init; }
192           }
193           
194           /// <summary>
195           /// Coupon data.
196           /// </summary>
197           public record CouponDto
198           {
199               public long Id { get; init; }
200               public required string Title { get; init; }
201               public required string Description { get; init; }
202               public string? Code { get; init; }
203               public decimal? DiscountAmount { get; init; }
204               public decimal? DiscountPercentage { get; init; }
205               public string? ImageUrl { get; init; }
206               public DateTimeOffset ValidFrom { get; init; }
207               public DateTimeOffset ValidUntil { get; init; }
208               public int? MaxRedemptions { get; init; }
209               public int CurrentRedemptions { get; init; }
210           }
211           
212           /// <summary>
213           /// Menu item data.
214           /// </summary>
215           public record MenuItemDto
216           {
217               public long Id { get; init; }
218               public required string Name { get; init; }
219               public string? Description { get; init; }
220               public required string Category { get; init; }
221               public decimal? Price { get; init; }
222               public string? Currency { get; init; }
223               public string? ImageUrl { get; init; }
224               public int? Calories { get; init; }
225               public string? Allergens { get; init; }
226               public string? DietaryTags { get; init; }
227           }
228           
229           /// <summary>
230           /// News item data.
231           /// </summary>
232           public record NewsItemDto
233           {
234               public long Id { get; init; }
235               public required string Title { get; init; }
236               public required string Content { get; init; }
237               public string? Summary { get; init; }
238               public string? ImageUrl { get; init; }
239               public string? Author { get; init; }
240               public DateTimeOffset PublishedAt { get; init; }
241               public bool IsFeatured { get; init; }
242           }
243           
244           /// <summary>
245           /// Business summary data.
246           /// </summary>
247           public record BusinessSummaryDto
248           {
249               public long Id { get; init; }
250               public required string Name { get; init; }
251               public required string Address { get; init; }
252               public double Latitude { get; init; }
253               public double Longitude { get; init; }
254               public double? DistanceMeters { get; init; }
255               public bool IsSubscribed { get; init; }
256           }
```
# FWH.Orchestrix.Contracts.Marketing.GetBusinessNewsResponse

## Summary

|||
|:---|:---|
| Class: | FWH.Orchestrix.Contracts.Marketing.GetBusinessNewsResponse |
| Assembly: | FWH.Orchestrix.Contracts |
| **File(s):** | E:\github\FunWasHad\src\FWH.Orchestrix.Contracts\Marketing\MarketingContracts.cs |
| **Line coverage:** | 0% (0 of 2) |
| Covered lines: | 0 |
| Uncovered lines: | 2 |
| Coverable lines: | 2 |
| Total lines: | 256 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **.ctor(...)** | 100% | 2 | 1 | 0% |
| **get_NewsItems()** | 100% | 2 | 1 | 0% |

## File(s)

### E:\github\FunWasHad\src\FWH.Orchestrix.Contracts\Marketing\MarketingContracts.cs
```
  1           using FWH.Orchestrix.Contracts.Mediator;
  2           
  3           namespace FWH.Orchestrix.Contracts.Marketing;
  4           
  5           /// <summary>
  6           /// Base response for marketing operations.
  7           /// </summary>
  8           public record MarketingResponse
  9           {
 10               public bool Success { get; init; }
 11               public string? ErrorMessage { get; init; }
 12           }
 13           
 14           /// <summary>
 15           /// Request to get business marketing data.
 16           /// </summary>
 17           public record GetBusinessMarketingRequest : IMediatorRequest<GetBusinessMarketingResponse>
 18           {
 19               public long BusinessId { get; init; }
 20           }
 21           
 22           /// <summary>
 23           /// Response to get business marketing data.
 24           /// </summary>
 25           public record GetBusinessMarketingResponse : MarketingResponse
 26           {
 27               public BusinessMarketingDto? Data { get; init; }
 28           }
 29           
 30           /// <summary>
 31           /// Request to get business theme.
 32           /// </summary>
 33           public record GetBusinessThemeRequest : IMediatorRequest<GetBusinessThemeResponse>
 34           {
 35               public long BusinessId { get; init; }
 36           }
 37           
 38           /// <summary>
 39           /// Response to get business theme.
 40           /// </summary>
 41           public record GetBusinessThemeResponse : MarketingResponse
 42           {
 43               public BusinessThemeDto? Theme { get; init; }
 44           }
 45           
 46           /// <summary>
 47           /// Request to get business coupons.
 48           /// </summary>
 49           public record GetBusinessCouponsRequest : IMediatorRequest<GetBusinessCouponsResponse>
 50           {
 51               public long BusinessId { get; init; }
 52           }
 53           
 54           /// <summary>
 55           /// Response to get business coupons.
 56           /// </summary>
 57           public record GetBusinessCouponsResponse : MarketingResponse
 58           {
 59               public List<CouponDto> Coupons { get; init; } = new();
 60           }
 61           
 62           /// <summary>
 63           /// Request to get business menu.
 64           /// </summary>
 65           public record GetBusinessMenuRequest : IMediatorRequest<GetBusinessMenuResponse>
 66           {
 67               public long BusinessId { get; init; }
 68               public string? Category { get; init; }
 69           }
 70           
 71           /// <summary>
 72           /// Response to get business menu.
 73           /// </summary>
 74           public record GetBusinessMenuResponse : MarketingResponse
 75           {
 76               public List<MenuItemDto> MenuItems { get; init; } = new();
 77           }
 78           
 79           /// <summary>
 80           /// Request to get business news.
 81           /// </summary>
 82           public record GetBusinessNewsRequest : IMediatorRequest<GetBusinessNewsResponse>
 83           {
 84               public long BusinessId { get; init; }
 85               public int Limit { get; init; } = 10;
 86           }
 87           
 88           /// <summary>
 89           /// Response to get business news.
 90           /// </summary>
 91  ❌ 0     public record GetBusinessNewsResponse : MarketingResponse
 92           {
 93  ❌ 0         public List<NewsItemDto> NewsItems { get; init; } = new();
 94           }
 95           
 96           /// <summary>
 97           /// Request to submit feedback.
 98           /// </summary>
 99           public record SubmitFeedbackRequest : IMediatorRequest<SubmitFeedbackResponse>
100           {
101               public long BusinessId { get; init; }
102               public required string UserId { get; init; }
103               public string? UserName { get; init; }
104               public string? UserEmail { get; init; }
105               public required string FeedbackType { get; init; }
106               public required string Subject { get; init; }
107               public required string Message { get; init; }
108               public int? Rating { get; init; }
109               public bool IsPublic { get; init; }
110               public double? Latitude { get; init; }
111               public double? Longitude { get; init; }
112           }
113           
114           /// <summary>
115           /// Response to submit feedback.
116           /// </summary>
117           public record SubmitFeedbackResponse : MarketingResponse
118           {
119               public long? FeedbackId { get; init; }
120           }
121           
122           /// <summary>
123           /// Request to upload feedback attachment.
124           /// </summary>
125           public record UploadFeedbackAttachmentRequest : IMediatorRequest<UploadFeedbackAttachmentResponse>
126           {
127               public long FeedbackId { get; init; }
128               public required string AttachmentType { get; init; } // "image" or "video"
129               public required string FileName { get; init; }
130               public required string ContentType { get; init; }
131               public required byte[] FileData { get; init; }
132           }
133           
134           /// <summary>
135           /// Response to upload feedback attachment.
136           /// </summary>
137           public record UploadFeedbackAttachmentResponse : MarketingResponse
138           {
139               public long? AttachmentId { get; init; }
140               public string? StorageUrl { get; init; }
141           }
142           
143           /// <summary>
144           /// Request to find nearby businesses.
145           /// </summary>
146           public record FindNearbyBusinessesRequest : IMediatorRequest<FindNearbyBusinessesResponse>
147           {
148               public double Latitude { get; init; }
149               public double Longitude { get; init; }
150               public int RadiusMeters { get; init; } = 1000;
151           }
152           
153           /// <summary>
154           /// Response to find nearby businesses.
155           /// </summary>
156           public record FindNearbyBusinessesResponse : MarketingResponse
157           {
158               public List<BusinessSummaryDto> Businesses { get; init; } = new();
159           }
160           
161           // DTOs
162           
163           /// <summary>
164           /// Complete business marketing data.
165           /// </summary>
166           public record BusinessMarketingDto
167           {
168               public long BusinessId { get; init; }
169               public required string BusinessName { get; init; }
170               public BusinessThemeDto? Theme { get; init; }
171               public List<CouponDto> Coupons { get; init; } = new();
172               public List<MenuItemDto> MenuItems { get; init; } = new();
173               public List<NewsItemDto> NewsItems { get; init; } = new();
174           }
175           
176           /// <summary>
177           /// Business theme data.
178           /// </summary>
179           public record BusinessThemeDto
180           {
181               public long Id { get; init; }
182               public long BusinessId { get; init; }
183               public required string ThemeName { get; init; }
184               public string? PrimaryColor { get; init; }
185               public string? SecondaryColor { get; init; }
186               public string? AccentColor { get; init; }
187               public string? BackgroundColor { get; init; }
188               public string? TextColor { get; init; }
189               public string? LogoUrl { get; init; }
190               public string? BackgroundImageUrl { get; init; }
191               public string? CustomCss { get; init; }
192           }
193           
194           /// <summary>
195           /// Coupon data.
196           /// </summary>
197           public record CouponDto
198           {
199               public long Id { get; init; }
200               public required string Title { get; init; }
201               public required string Description { get; init; }
202               public string? Code { get; init; }
203               public decimal? DiscountAmount { get; init; }
204               public decimal? DiscountPercentage { get; init; }
205               public string? ImageUrl { get; init; }
206               public DateTimeOffset ValidFrom { get; init; }
207               public DateTimeOffset ValidUntil { get; init; }
208               public int? MaxRedemptions { get; init; }
209               public int CurrentRedemptions { get; init; }
210           }
211           
212           /// <summary>
213           /// Menu item data.
214           /// </summary>
215           public record MenuItemDto
216           {
217               public long Id { get; init; }
218               public required string Name { get; init; }
219               public string? Description { get; init; }
220               public required string Category { get; init; }
221               public decimal? Price { get; init; }
222               public string? Currency { get; init; }
223               public string? ImageUrl { get; init; }
224               public int? Calories { get; init; }
225               public string? Allergens { get; init; }
226               public string? DietaryTags { get; init; }
227           }
228           
229           /// <summary>
230           /// News item data.
231           /// </summary>
232           public record NewsItemDto
233           {
234               public long Id { get; init; }
235               public required string Title { get; init; }
236               public required string Content { get; init; }
237               public string? Summary { get; init; }
238               public string? ImageUrl { get; init; }
239               public string? Author { get; init; }
240               public DateTimeOffset PublishedAt { get; init; }
241               public bool IsFeatured { get; init; }
242           }
243           
244           /// <summary>
245           /// Business summary data.
246           /// </summary>
247           public record BusinessSummaryDto
248           {
249               public long Id { get; init; }
250               public required string Name { get; init; }
251               public required string Address { get; init; }
252               public double Latitude { get; init; }
253               public double Longitude { get; init; }
254               public double? DistanceMeters { get; init; }
255               public bool IsSubscribed { get; init; }
256           }
```
# FWH.Orchestrix.Contracts.Marketing.GetBusinessThemeRequest

## Summary

|||
|:---|:---|
| Class: | FWH.Orchestrix.Contracts.Marketing.GetBusinessThemeRequest |
| Assembly: | FWH.Orchestrix.Contracts |
| **File(s):** | E:\github\FunWasHad\src\FWH.Orchestrix.Contracts\Marketing\MarketingContracts.cs |
| **Line coverage:** | 0% (0 of 2) |
| Covered lines: | 0 |
| Uncovered lines: | 2 |
| Coverable lines: | 2 |
| Total lines: | 256 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **.ctor(...)** | 100% | 2 | 1 | 0% |
| **get_BusinessId()** | 100% | 2 | 1 | 0% |

## File(s)

### E:\github\FunWasHad\src\FWH.Orchestrix.Contracts\Marketing\MarketingContracts.cs
```
  1           using FWH.Orchestrix.Contracts.Mediator;
  2           
  3           namespace FWH.Orchestrix.Contracts.Marketing;
  4           
  5           /// <summary>
  6           /// Base response for marketing operations.
  7           /// </summary>
  8           public record MarketingResponse
  9           {
 10               public bool Success { get; init; }
 11               public string? ErrorMessage { get; init; }
 12           }
 13           
 14           /// <summary>
 15           /// Request to get business marketing data.
 16           /// </summary>
 17           public record GetBusinessMarketingRequest : IMediatorRequest<GetBusinessMarketingResponse>
 18           {
 19               public long BusinessId { get; init; }
 20           }
 21           
 22           /// <summary>
 23           /// Response to get business marketing data.
 24           /// </summary>
 25           public record GetBusinessMarketingResponse : MarketingResponse
 26           {
 27               public BusinessMarketingDto? Data { get; init; }
 28           }
 29           
 30           /// <summary>
 31           /// Request to get business theme.
 32           /// </summary>
 33  ❌ 0     public record GetBusinessThemeRequest : IMediatorRequest<GetBusinessThemeResponse>
 34           {
 35  ❌ 0         public long BusinessId { get; init; }
 36           }
 37           
 38           /// <summary>
 39           /// Response to get business theme.
 40           /// </summary>
 41           public record GetBusinessThemeResponse : MarketingResponse
 42           {
 43               public BusinessThemeDto? Theme { get; init; }
 44           }
 45           
 46           /// <summary>
 47           /// Request to get business coupons.
 48           /// </summary>
 49           public record GetBusinessCouponsRequest : IMediatorRequest<GetBusinessCouponsResponse>
 50           {
 51               public long BusinessId { get; init; }
 52           }
 53           
 54           /// <summary>
 55           /// Response to get business coupons.
 56           /// </summary>
 57           public record GetBusinessCouponsResponse : MarketingResponse
 58           {
 59               public List<CouponDto> Coupons { get; init; } = new();
 60           }
 61           
 62           /// <summary>
 63           /// Request to get business menu.
 64           /// </summary>
 65           public record GetBusinessMenuRequest : IMediatorRequest<GetBusinessMenuResponse>
 66           {
 67               public long BusinessId { get; init; }
 68               public string? Category { get; init; }
 69           }
 70           
 71           /// <summary>
 72           /// Response to get business menu.
 73           /// </summary>
 74           public record GetBusinessMenuResponse : MarketingResponse
 75           {
 76               public List<MenuItemDto> MenuItems { get; init; } = new();
 77           }
 78           
 79           /// <summary>
 80           /// Request to get business news.
 81           /// </summary>
 82           public record GetBusinessNewsRequest : IMediatorRequest<GetBusinessNewsResponse>
 83           {
 84               public long BusinessId { get; init; }
 85               public int Limit { get; init; } = 10;
 86           }
 87           
 88           /// <summary>
 89           /// Response to get business news.
 90           /// </summary>
 91           public record GetBusinessNewsResponse : MarketingResponse
 92           {
 93               public List<NewsItemDto> NewsItems { get; init; } = new();
 94           }
 95           
 96           /// <summary>
 97           /// Request to submit feedback.
 98           /// </summary>
 99           public record SubmitFeedbackRequest : IMediatorRequest<SubmitFeedbackResponse>
100           {
101               public long BusinessId { get; init; }
102               public required string UserId { get; init; }
103               public string? UserName { get; init; }
104               public string? UserEmail { get; init; }
105               public required string FeedbackType { get; init; }
106               public required string Subject { get; init; }
107               public required string Message { get; init; }
108               public int? Rating { get; init; }
109               public bool IsPublic { get; init; }
110               public double? Latitude { get; init; }
111               public double? Longitude { get; init; }
112           }
113           
114           /// <summary>
115           /// Response to submit feedback.
116           /// </summary>
117           public record SubmitFeedbackResponse : MarketingResponse
118           {
119               public long? FeedbackId { get; init; }
120           }
121           
122           /// <summary>
123           /// Request to upload feedback attachment.
124           /// </summary>
125           public record UploadFeedbackAttachmentRequest : IMediatorRequest<UploadFeedbackAttachmentResponse>
126           {
127               public long FeedbackId { get; init; }
128               public required string AttachmentType { get; init; } // "image" or "video"
129               public required string FileName { get; init; }
130               public required string ContentType { get; init; }
131               public required byte[] FileData { get; init; }
132           }
133           
134           /// <summary>
135           /// Response to upload feedback attachment.
136           /// </summary>
137           public record UploadFeedbackAttachmentResponse : MarketingResponse
138           {
139               public long? AttachmentId { get; init; }
140               public string? StorageUrl { get; init; }
141           }
142           
143           /// <summary>
144           /// Request to find nearby businesses.
145           /// </summary>
146           public record FindNearbyBusinessesRequest : IMediatorRequest<FindNearbyBusinessesResponse>
147           {
148               public double Latitude { get; init; }
149               public double Longitude { get; init; }
150               public int RadiusMeters { get; init; } = 1000;
151           }
152           
153           /// <summary>
154           /// Response to find nearby businesses.
155           /// </summary>
156           public record FindNearbyBusinessesResponse : MarketingResponse
157           {
158               public List<BusinessSummaryDto> Businesses { get; init; } = new();
159           }
160           
161           // DTOs
162           
163           /// <summary>
164           /// Complete business marketing data.
165           /// </summary>
166           public record BusinessMarketingDto
167           {
168               public long BusinessId { get; init; }
169               public required string BusinessName { get; init; }
170               public BusinessThemeDto? Theme { get; init; }
171               public List<CouponDto> Coupons { get; init; } = new();
172               public List<MenuItemDto> MenuItems { get; init; } = new();
173               public List<NewsItemDto> NewsItems { get; init; } = new();
174           }
175           
176           /// <summary>
177           /// Business theme data.
178           /// </summary>
179           public record BusinessThemeDto
180           {
181               public long Id { get; init; }
182               public long BusinessId { get; init; }
183               public required string ThemeName { get; init; }
184               public string? PrimaryColor { get; init; }
185               public string? SecondaryColor { get; init; }
186               public string? AccentColor { get; init; }
187               public string? BackgroundColor { get; init; }
188               public string? TextColor { get; init; }
189               public string? LogoUrl { get; init; }
190               public string? BackgroundImageUrl { get; init; }
191               public string? CustomCss { get; init; }
192           }
193           
194           /// <summary>
195           /// Coupon data.
196           /// </summary>
197           public record CouponDto
198           {
199               public long Id { get; init; }
200               public required string Title { get; init; }
201               public required string Description { get; init; }
202               public string? Code { get; init; }
203               public decimal? DiscountAmount { get; init; }
204               public decimal? DiscountPercentage { get; init; }
205               public string? ImageUrl { get; init; }
206               public DateTimeOffset ValidFrom { get; init; }
207               public DateTimeOffset ValidUntil { get; init; }
208               public int? MaxRedemptions { get; init; }
209               public int CurrentRedemptions { get; init; }
210           }
211           
212           /// <summary>
213           /// Menu item data.
214           /// </summary>
215           public record MenuItemDto
216           {
217               public long Id { get; init; }
218               public required string Name { get; init; }
219               public string? Description { get; init; }
220               public required string Category { get; init; }
221               public decimal? Price { get; init; }
222               public string? Currency { get; init; }
223               public string? ImageUrl { get; init; }
224               public int? Calories { get; init; }
225               public string? Allergens { get; init; }
226               public string? DietaryTags { get; init; }
227           }
228           
229           /// <summary>
230           /// News item data.
231           /// </summary>
232           public record NewsItemDto
233           {
234               public long Id { get; init; }
235               public required string Title { get; init; }
236               public required string Content { get; init; }
237               public string? Summary { get; init; }
238               public string? ImageUrl { get; init; }
239               public string? Author { get; init; }
240               public DateTimeOffset PublishedAt { get; init; }
241               public bool IsFeatured { get; init; }
242           }
243           
244           /// <summary>
245           /// Business summary data.
246           /// </summary>
247           public record BusinessSummaryDto
248           {
249               public long Id { get; init; }
250               public required string Name { get; init; }
251               public required string Address { get; init; }
252               public double Latitude { get; init; }
253               public double Longitude { get; init; }
254               public double? DistanceMeters { get; init; }
255               public bool IsSubscribed { get; init; }
256           }
```
# FWH.Orchestrix.Contracts.Marketing.GetBusinessThemeResponse

## Summary

|||
|:---|:---|
| Class: | FWH.Orchestrix.Contracts.Marketing.GetBusinessThemeResponse |
| Assembly: | FWH.Orchestrix.Contracts |
| **File(s):** | E:\github\FunWasHad\src\FWH.Orchestrix.Contracts\Marketing\MarketingContracts.cs |
| **Line coverage:** | 0% (0 of 2) |
| Covered lines: | 0 |
| Uncovered lines: | 2 |
| Coverable lines: | 2 |
| Total lines: | 256 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **.ctor(...)** | 100% | 2 | 1 | 0% |
| **get_Theme()** | 100% | 2 | 1 | 0% |

## File(s)

### E:\github\FunWasHad\src\FWH.Orchestrix.Contracts\Marketing\MarketingContracts.cs
```
  1           using FWH.Orchestrix.Contracts.Mediator;
  2           
  3           namespace FWH.Orchestrix.Contracts.Marketing;
  4           
  5           /// <summary>
  6           /// Base response for marketing operations.
  7           /// </summary>
  8           public record MarketingResponse
  9           {
 10               public bool Success { get; init; }
 11               public string? ErrorMessage { get; init; }
 12           }
 13           
 14           /// <summary>
 15           /// Request to get business marketing data.
 16           /// </summary>
 17           public record GetBusinessMarketingRequest : IMediatorRequest<GetBusinessMarketingResponse>
 18           {
 19               public long BusinessId { get; init; }
 20           }
 21           
 22           /// <summary>
 23           /// Response to get business marketing data.
 24           /// </summary>
 25           public record GetBusinessMarketingResponse : MarketingResponse
 26           {
 27               public BusinessMarketingDto? Data { get; init; }
 28           }
 29           
 30           /// <summary>
 31           /// Request to get business theme.
 32           /// </summary>
 33           public record GetBusinessThemeRequest : IMediatorRequest<GetBusinessThemeResponse>
 34           {
 35               public long BusinessId { get; init; }
 36           }
 37           
 38           /// <summary>
 39           /// Response to get business theme.
 40           /// </summary>
 41  ❌ 0     public record GetBusinessThemeResponse : MarketingResponse
 42           {
 43  ❌ 0         public BusinessThemeDto? Theme { get; init; }
 44           }
 45           
 46           /// <summary>
 47           /// Request to get business coupons.
 48           /// </summary>
 49           public record GetBusinessCouponsRequest : IMediatorRequest<GetBusinessCouponsResponse>
 50           {
 51               public long BusinessId { get; init; }
 52           }
 53           
 54           /// <summary>
 55           /// Response to get business coupons.
 56           /// </summary>
 57           public record GetBusinessCouponsResponse : MarketingResponse
 58           {
 59               public List<CouponDto> Coupons { get; init; } = new();
 60           }
 61           
 62           /// <summary>
 63           /// Request to get business menu.
 64           /// </summary>
 65           public record GetBusinessMenuRequest : IMediatorRequest<GetBusinessMenuResponse>
 66           {
 67               public long BusinessId { get; init; }
 68               public string? Category { get; init; }
 69           }
 70           
 71           /// <summary>
 72           /// Response to get business menu.
 73           /// </summary>
 74           public record GetBusinessMenuResponse : MarketingResponse
 75           {
 76               public List<MenuItemDto> MenuItems { get; init; } = new();
 77           }
 78           
 79           /// <summary>
 80           /// Request to get business news.
 81           /// </summary>
 82           public record GetBusinessNewsRequest : IMediatorRequest<GetBusinessNewsResponse>
 83           {
 84               public long BusinessId { get; init; }
 85               public int Limit { get; init; } = 10;
 86           }
 87           
 88           /// <summary>
 89           /// Response to get business news.
 90           /// </summary>
 91           public record GetBusinessNewsResponse : MarketingResponse
 92           {
 93               public List<NewsItemDto> NewsItems { get; init; } = new();
 94           }
 95           
 96           /// <summary>
 97           /// Request to submit feedback.
 98           /// </summary>
 99           public record SubmitFeedbackRequest : IMediatorRequest<SubmitFeedbackResponse>
100           {
101               public long BusinessId { get; init; }
102               public required string UserId { get; init; }
103               public string? UserName { get; init; }
104               public string? UserEmail { get; init; }
105               public required string FeedbackType { get; init; }
106               public required string Subject { get; init; }
107               public required string Message { get; init; }
108               public int? Rating { get; init; }
109               public bool IsPublic { get; init; }
110               public double? Latitude { get; init; }
111               public double? Longitude { get; init; }
112           }
113           
114           /// <summary>
115           /// Response to submit feedback.
116           /// </summary>
117           public record SubmitFeedbackResponse : MarketingResponse
118           {
119               public long? FeedbackId { get; init; }
120           }
121           
122           /// <summary>
123           /// Request to upload feedback attachment.
124           /// </summary>
125           public record UploadFeedbackAttachmentRequest : IMediatorRequest<UploadFeedbackAttachmentResponse>
126           {
127               public long FeedbackId { get; init; }
128               public required string AttachmentType { get; init; } // "image" or "video"
129               public required string FileName { get; init; }
130               public required string ContentType { get; init; }
131               public required byte[] FileData { get; init; }
132           }
133           
134           /// <summary>
135           /// Response to upload feedback attachment.
136           /// </summary>
137           public record UploadFeedbackAttachmentResponse : MarketingResponse
138           {
139               public long? AttachmentId { get; init; }
140               public string? StorageUrl { get; init; }
141           }
142           
143           /// <summary>
144           /// Request to find nearby businesses.
145           /// </summary>
146           public record FindNearbyBusinessesRequest : IMediatorRequest<FindNearbyBusinessesResponse>
147           {
148               public double Latitude { get; init; }
149               public double Longitude { get; init; }
150               public int RadiusMeters { get; init; } = 1000;
151           }
152           
153           /// <summary>
154           /// Response to find nearby businesses.
155           /// </summary>
156           public record FindNearbyBusinessesResponse : MarketingResponse
157           {
158               public List<BusinessSummaryDto> Businesses { get; init; } = new();
159           }
160           
161           // DTOs
162           
163           /// <summary>
164           /// Complete business marketing data.
165           /// </summary>
166           public record BusinessMarketingDto
167           {
168               public long BusinessId { get; init; }
169               public required string BusinessName { get; init; }
170               public BusinessThemeDto? Theme { get; init; }
171               public List<CouponDto> Coupons { get; init; } = new();
172               public List<MenuItemDto> MenuItems { get; init; } = new();
173               public List<NewsItemDto> NewsItems { get; init; } = new();
174           }
175           
176           /// <summary>
177           /// Business theme data.
178           /// </summary>
179           public record BusinessThemeDto
180           {
181               public long Id { get; init; }
182               public long BusinessId { get; init; }
183               public required string ThemeName { get; init; }
184               public string? PrimaryColor { get; init; }
185               public string? SecondaryColor { get; init; }
186               public string? AccentColor { get; init; }
187               public string? BackgroundColor { get; init; }
188               public string? TextColor { get; init; }
189               public string? LogoUrl { get; init; }
190               public string? BackgroundImageUrl { get; init; }
191               public string? CustomCss { get; init; }
192           }
193           
194           /// <summary>
195           /// Coupon data.
196           /// </summary>
197           public record CouponDto
198           {
199               public long Id { get; init; }
200               public required string Title { get; init; }
201               public required string Description { get; init; }
202               public string? Code { get; init; }
203               public decimal? DiscountAmount { get; init; }
204               public decimal? DiscountPercentage { get; init; }
205               public string? ImageUrl { get; init; }
206               public DateTimeOffset ValidFrom { get; init; }
207               public DateTimeOffset ValidUntil { get; init; }
208               public int? MaxRedemptions { get; init; }
209               public int CurrentRedemptions { get; init; }
210           }
211           
212           /// <summary>
213           /// Menu item data.
214           /// </summary>
215           public record MenuItemDto
216           {
217               public long Id { get; init; }
218               public required string Name { get; init; }
219               public string? Description { get; init; }
220               public required string Category { get; init; }
221               public decimal? Price { get; init; }
222               public string? Currency { get; init; }
223               public string? ImageUrl { get; init; }
224               public int? Calories { get; init; }
225               public string? Allergens { get; init; }
226               public string? DietaryTags { get; init; }
227           }
228           
229           /// <summary>
230           /// News item data.
231           /// </summary>
232           public record NewsItemDto
233           {
234               public long Id { get; init; }
235               public required string Title { get; init; }
236               public required string Content { get; init; }
237               public string? Summary { get; init; }
238               public string? ImageUrl { get; init; }
239               public string? Author { get; init; }
240               public DateTimeOffset PublishedAt { get; init; }
241               public bool IsFeatured { get; init; }
242           }
243           
244           /// <summary>
245           /// Business summary data.
246           /// </summary>
247           public record BusinessSummaryDto
248           {
249               public long Id { get; init; }
250               public required string Name { get; init; }
251               public required string Address { get; init; }
252               public double Latitude { get; init; }
253               public double Longitude { get; init; }
254               public double? DistanceMeters { get; init; }
255               public bool IsSubscribed { get; init; }
256           }
```
# FWH.Orchestrix.Contracts.Marketing.MarketingResponse

## Summary

|||
|:---|:---|
| Class: | FWH.Orchestrix.Contracts.Marketing.MarketingResponse |
| Assembly: | FWH.Orchestrix.Contracts |
| **File(s):** | E:\github\FunWasHad\src\FWH.Orchestrix.Contracts\Marketing\MarketingContracts.cs |
| **Line coverage:** | 0% (0 of 3) |
| Covered lines: | 0 |
| Uncovered lines: | 3 |
| Coverable lines: | 3 |
| Total lines: | 256 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **.ctor(...)** | 100% | 2 | 1 | 0% |
| **get_Success()** | 100% | 2 | 1 | 0% |
| **get_ErrorMessage()** | 100% | 2 | 1 | 0% |

## File(s)

### E:\github\FunWasHad\src\FWH.Orchestrix.Contracts\Marketing\MarketingContracts.cs
```
  1           using FWH.Orchestrix.Contracts.Mediator;
  2           
  3           namespace FWH.Orchestrix.Contracts.Marketing;
  4           
  5           /// <summary>
  6           /// Base response for marketing operations.
  7           /// </summary>
  8  ❌ 0     public record MarketingResponse
  9           {
 10  ❌ 0         public bool Success { get; init; }
 11  ❌ 0         public string? ErrorMessage { get; init; }
 12           }
 13           
 14           /// <summary>
 15           /// Request to get business marketing data.
 16           /// </summary>
 17           public record GetBusinessMarketingRequest : IMediatorRequest<GetBusinessMarketingResponse>
 18           {
 19               public long BusinessId { get; init; }
 20           }
 21           
 22           /// <summary>
 23           /// Response to get business marketing data.
 24           /// </summary>
 25           public record GetBusinessMarketingResponse : MarketingResponse
 26           {
 27               public BusinessMarketingDto? Data { get; init; }
 28           }
 29           
 30           /// <summary>
 31           /// Request to get business theme.
 32           /// </summary>
 33           public record GetBusinessThemeRequest : IMediatorRequest<GetBusinessThemeResponse>
 34           {
 35               public long BusinessId { get; init; }
 36           }
 37           
 38           /// <summary>
 39           /// Response to get business theme.
 40           /// </summary>
 41           public record GetBusinessThemeResponse : MarketingResponse
 42           {
 43               public BusinessThemeDto? Theme { get; init; }
 44           }
 45           
 46           /// <summary>
 47           /// Request to get business coupons.
 48           /// </summary>
 49           public record GetBusinessCouponsRequest : IMediatorRequest<GetBusinessCouponsResponse>
 50           {
 51               public long BusinessId { get; init; }
 52           }
 53           
 54           /// <summary>
 55           /// Response to get business coupons.
 56           /// </summary>
 57           public record GetBusinessCouponsResponse : MarketingResponse
 58           {
 59               public List<CouponDto> Coupons { get; init; } = new();
 60           }
 61           
 62           /// <summary>
 63           /// Request to get business menu.
 64           /// </summary>
 65           public record GetBusinessMenuRequest : IMediatorRequest<GetBusinessMenuResponse>
 66           {
 67               public long BusinessId { get; init; }
 68               public string? Category { get; init; }
 69           }
 70           
 71           /// <summary>
 72           /// Response to get business menu.
 73           /// </summary>
 74           public record GetBusinessMenuResponse : MarketingResponse
 75           {
 76               public List<MenuItemDto> MenuItems { get; init; } = new();
 77           }
 78           
 79           /// <summary>
 80           /// Request to get business news.
 81           /// </summary>
 82           public record GetBusinessNewsRequest : IMediatorRequest<GetBusinessNewsResponse>
 83           {
 84               public long BusinessId { get; init; }
 85               public int Limit { get; init; } = 10;
 86           }
 87           
 88           /// <summary>
 89           /// Response to get business news.
 90           /// </summary>
 91           public record GetBusinessNewsResponse : MarketingResponse
 92           {
 93               public List<NewsItemDto> NewsItems { get; init; } = new();
 94           }
 95           
 96           /// <summary>
 97           /// Request to submit feedback.
 98           /// </summary>
 99           public record SubmitFeedbackRequest : IMediatorRequest<SubmitFeedbackResponse>
100           {
101               public long BusinessId { get; init; }
102               public required string UserId { get; init; }
103               public string? UserName { get; init; }
104               public string? UserEmail { get; init; }
105               public required string FeedbackType { get; init; }
106               public required string Subject { get; init; }
107               public required string Message { get; init; }
108               public int? Rating { get; init; }
109               public bool IsPublic { get; init; }
110               public double? Latitude { get; init; }
111               public double? Longitude { get; init; }
112           }
113           
114           /// <summary>
115           /// Response to submit feedback.
116           /// </summary>
117           public record SubmitFeedbackResponse : MarketingResponse
118           {
119               public long? FeedbackId { get; init; }
120           }
121           
122           /// <summary>
123           /// Request to upload feedback attachment.
124           /// </summary>
125           public record UploadFeedbackAttachmentRequest : IMediatorRequest<UploadFeedbackAttachmentResponse>
126           {
127               public long FeedbackId { get; init; }
128               public required string AttachmentType { get; init; } // "image" or "video"
129               public required string FileName { get; init; }
130               public required string ContentType { get; init; }
131               public required byte[] FileData { get; init; }
132           }
133           
134           /// <summary>
135           /// Response to upload feedback attachment.
136           /// </summary>
137           public record UploadFeedbackAttachmentResponse : MarketingResponse
138           {
139               public long? AttachmentId { get; init; }
140               public string? StorageUrl { get; init; }
141           }
142           
143           /// <summary>
144           /// Request to find nearby businesses.
145           /// </summary>
146           public record FindNearbyBusinessesRequest : IMediatorRequest<FindNearbyBusinessesResponse>
147           {
148               public double Latitude { get; init; }
149               public double Longitude { get; init; }
150               public int RadiusMeters { get; init; } = 1000;
151           }
152           
153           /// <summary>
154           /// Response to find nearby businesses.
155           /// </summary>
156           public record FindNearbyBusinessesResponse : MarketingResponse
157           {
158               public List<BusinessSummaryDto> Businesses { get; init; } = new();
159           }
160           
161           // DTOs
162           
163           /// <summary>
164           /// Complete business marketing data.
165           /// </summary>
166           public record BusinessMarketingDto
167           {
168               public long BusinessId { get; init; }
169               public required string BusinessName { get; init; }
170               public BusinessThemeDto? Theme { get; init; }
171               public List<CouponDto> Coupons { get; init; } = new();
172               public List<MenuItemDto> MenuItems { get; init; } = new();
173               public List<NewsItemDto> NewsItems { get; init; } = new();
174           }
175           
176           /// <summary>
177           /// Business theme data.
178           /// </summary>
179           public record BusinessThemeDto
180           {
181               public long Id { get; init; }
182               public long BusinessId { get; init; }
183               public required string ThemeName { get; init; }
184               public string? PrimaryColor { get; init; }
185               public string? SecondaryColor { get; init; }
186               public string? AccentColor { get; init; }
187               public string? BackgroundColor { get; init; }
188               public string? TextColor { get; init; }
189               public string? LogoUrl { get; init; }
190               public string? BackgroundImageUrl { get; init; }
191               public string? CustomCss { get; init; }
192           }
193           
194           /// <summary>
195           /// Coupon data.
196           /// </summary>
197           public record CouponDto
198           {
199               public long Id { get; init; }
200               public required string Title { get; init; }
201               public required string Description { get; init; }
202               public string? Code { get; init; }
203               public decimal? DiscountAmount { get; init; }
204               public decimal? DiscountPercentage { get; init; }
205               public string? ImageUrl { get; init; }
206               public DateTimeOffset ValidFrom { get; init; }
207               public DateTimeOffset ValidUntil { get; init; }
208               public int? MaxRedemptions { get; init; }
209               public int CurrentRedemptions { get; init; }
210           }
211           
212           /// <summary>
213           /// Menu item data.
214           /// </summary>
215           public record MenuItemDto
216           {
217               public long Id { get; init; }
218               public required string Name { get; init; }
219               public string? Description { get; init; }
220               public required string Category { get; init; }
221               public decimal? Price { get; init; }
222               public string? Currency { get; init; }
223               public string? ImageUrl { get; init; }
224               public int? Calories { get; init; }
225               public string? Allergens { get; init; }
226               public string? DietaryTags { get; init; }
227           }
228           
229           /// <summary>
230           /// News item data.
231           /// </summary>
232           public record NewsItemDto
233           {
234               public long Id { get; init; }
235               public required string Title { get; init; }
236               public required string Content { get; init; }
237               public string? Summary { get; init; }
238               public string? ImageUrl { get; init; }
239               public string? Author { get; init; }
240               public DateTimeOffset PublishedAt { get; init; }
241               public bool IsFeatured { get; init; }
242           }
243           
244           /// <summary>
245           /// Business summary data.
246           /// </summary>
247           public record BusinessSummaryDto
248           {
249               public long Id { get; init; }
250               public required string Name { get; init; }
251               public required string Address { get; init; }
252               public double Latitude { get; init; }
253               public double Longitude { get; init; }
254               public double? DistanceMeters { get; init; }
255               public bool IsSubscribed { get; init; }
256           }
```
# FWH.Orchestrix.Contracts.Marketing.MenuItemDto

## Summary

|||
|:---|:---|
| Class: | FWH.Orchestrix.Contracts.Marketing.MenuItemDto |
| Assembly: | FWH.Orchestrix.Contracts |
| **File(s):** | E:\github\FunWasHad\src\FWH.Orchestrix.Contracts\Marketing\MarketingContracts.cs |
| **Line coverage:** | 0% (0 of 11) |
| Covered lines: | 0 |
| Uncovered lines: | 11 |
| Coverable lines: | 11 |
| Total lines: | 256 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **.ctor(...)** | 100% | 2 | 1 | 0% |
| **get_Id()** | 100% | 2 | 1 | 0% |
| **get_Name()** | 100% | 2 | 1 | 0% |
| **get_Description()** | 100% | 2 | 1 | 0% |
| **get_Category()** | 100% | 2 | 1 | 0% |
| **get_Price()** | 100% | 2 | 1 | 0% |
| **get_Currency()** | 100% | 2 | 1 | 0% |
| **get_ImageUrl()** | 100% | 2 | 1 | 0% |
| **get_Calories()** | 100% | 2 | 1 | 0% |
| **get_Allergens()** | 100% | 2 | 1 | 0% |
| **get_DietaryTags()** | 100% | 2 | 1 | 0% |

## File(s)

### E:\github\FunWasHad\src\FWH.Orchestrix.Contracts\Marketing\MarketingContracts.cs
```
  1           using FWH.Orchestrix.Contracts.Mediator;
  2           
  3           namespace FWH.Orchestrix.Contracts.Marketing;
  4           
  5           /// <summary>
  6           /// Base response for marketing operations.
  7           /// </summary>
  8           public record MarketingResponse
  9           {
 10               public bool Success { get; init; }
 11               public string? ErrorMessage { get; init; }
 12           }
 13           
 14           /// <summary>
 15           /// Request to get business marketing data.
 16           /// </summary>
 17           public record GetBusinessMarketingRequest : IMediatorRequest<GetBusinessMarketingResponse>
 18           {
 19               public long BusinessId { get; init; }
 20           }
 21           
 22           /// <summary>
 23           /// Response to get business marketing data.
 24           /// </summary>
 25           public record GetBusinessMarketingResponse : MarketingResponse
 26           {
 27               public BusinessMarketingDto? Data { get; init; }
 28           }
 29           
 30           /// <summary>
 31           /// Request to get business theme.
 32           /// </summary>
 33           public record GetBusinessThemeRequest : IMediatorRequest<GetBusinessThemeResponse>
 34           {
 35               public long BusinessId { get; init; }
 36           }
 37           
 38           /// <summary>
 39           /// Response to get business theme.
 40           /// </summary>
 41           public record GetBusinessThemeResponse : MarketingResponse
 42           {
 43               public BusinessThemeDto? Theme { get; init; }
 44           }
 45           
 46           /// <summary>
 47           /// Request to get business coupons.
 48           /// </summary>
 49           public record GetBusinessCouponsRequest : IMediatorRequest<GetBusinessCouponsResponse>
 50           {
 51               public long BusinessId { get; init; }
 52           }
 53           
 54           /// <summary>
 55           /// Response to get business coupons.
 56           /// </summary>
 57           public record GetBusinessCouponsResponse : MarketingResponse
 58           {
 59               public List<CouponDto> Coupons { get; init; } = new();
 60           }
 61           
 62           /// <summary>
 63           /// Request to get business menu.
 64           /// </summary>
 65           public record GetBusinessMenuRequest : IMediatorRequest<GetBusinessMenuResponse>
 66           {
 67               public long BusinessId { get; init; }
 68               public string? Category { get; init; }
 69           }
 70           
 71           /// <summary>
 72           /// Response to get business menu.
 73           /// </summary>
 74           public record GetBusinessMenuResponse : MarketingResponse
 75           {
 76               public List<MenuItemDto> MenuItems { get; init; } = new();
 77           }
 78           
 79           /// <summary>
 80           /// Request to get business news.
 81           /// </summary>
 82           public record GetBusinessNewsRequest : IMediatorRequest<GetBusinessNewsResponse>
 83           {
 84               public long BusinessId { get; init; }
 85               public int Limit { get; init; } = 10;
 86           }
 87           
 88           /// <summary>
 89           /// Response to get business news.
 90           /// </summary>
 91           public record GetBusinessNewsResponse : MarketingResponse
 92           {
 93               public List<NewsItemDto> NewsItems { get; init; } = new();
 94           }
 95           
 96           /// <summary>
 97           /// Request to submit feedback.
 98           /// </summary>
 99           public record SubmitFeedbackRequest : IMediatorRequest<SubmitFeedbackResponse>
100           {
101               public long BusinessId { get; init; }
102               public required string UserId { get; init; }
103               public string? UserName { get; init; }
104               public string? UserEmail { get; init; }
105               public required string FeedbackType { get; init; }
106               public required string Subject { get; init; }
107               public required string Message { get; init; }
108               public int? Rating { get; init; }
109               public bool IsPublic { get; init; }
110               public double? Latitude { get; init; }
111               public double? Longitude { get; init; }
112           }
113           
114           /// <summary>
115           /// Response to submit feedback.
116           /// </summary>
117           public record SubmitFeedbackResponse : MarketingResponse
118           {
119               public long? FeedbackId { get; init; }
120           }
121           
122           /// <summary>
123           /// Request to upload feedback attachment.
124           /// </summary>
125           public record UploadFeedbackAttachmentRequest : IMediatorRequest<UploadFeedbackAttachmentResponse>
126           {
127               public long FeedbackId { get; init; }
128               public required string AttachmentType { get; init; } // "image" or "video"
129               public required string FileName { get; init; }
130               public required string ContentType { get; init; }
131               public required byte[] FileData { get; init; }
132           }
133           
134           /// <summary>
135           /// Response to upload feedback attachment.
136           /// </summary>
137           public record UploadFeedbackAttachmentResponse : MarketingResponse
138           {
139               public long? AttachmentId { get; init; }
140               public string? StorageUrl { get; init; }
141           }
142           
143           /// <summary>
144           /// Request to find nearby businesses.
145           /// </summary>
146           public record FindNearbyBusinessesRequest : IMediatorRequest<FindNearbyBusinessesResponse>
147           {
148               public double Latitude { get; init; }
149               public double Longitude { get; init; }
150               public int RadiusMeters { get; init; } = 1000;
151           }
152           
153           /// <summary>
154           /// Response to find nearby businesses.
155           /// </summary>
156           public record FindNearbyBusinessesResponse : MarketingResponse
157           {
158               public List<BusinessSummaryDto> Businesses { get; init; } = new();
159           }
160           
161           // DTOs
162           
163           /// <summary>
164           /// Complete business marketing data.
165           /// </summary>
166           public record BusinessMarketingDto
167           {
168               public long BusinessId { get; init; }
169               public required string BusinessName { get; init; }
170               public BusinessThemeDto? Theme { get; init; }
171               public List<CouponDto> Coupons { get; init; } = new();
172               public List<MenuItemDto> MenuItems { get; init; } = new();
173               public List<NewsItemDto> NewsItems { get; init; } = new();
174           }
175           
176           /// <summary>
177           /// Business theme data.
178           /// </summary>
179           public record BusinessThemeDto
180           {
181               public long Id { get; init; }
182               public long BusinessId { get; init; }
183               public required string ThemeName { get; init; }
184               public string? PrimaryColor { get; init; }
185               public string? SecondaryColor { get; init; }
186               public string? AccentColor { get; init; }
187               public string? BackgroundColor { get; init; }
188               public string? TextColor { get; init; }
189               public string? LogoUrl { get; init; }
190               public string? BackgroundImageUrl { get; init; }
191               public string? CustomCss { get; init; }
192           }
193           
194           /// <summary>
195           /// Coupon data.
196           /// </summary>
197           public record CouponDto
198           {
199               public long Id { get; init; }
200               public required string Title { get; init; }
201               public required string Description { get; init; }
202               public string? Code { get; init; }
203               public decimal? DiscountAmount { get; init; }
204               public decimal? DiscountPercentage { get; init; }
205               public string? ImageUrl { get; init; }
206               public DateTimeOffset ValidFrom { get; init; }
207               public DateTimeOffset ValidUntil { get; init; }
208               public int? MaxRedemptions { get; init; }
209               public int CurrentRedemptions { get; init; }
210           }
211           
212           /// <summary>
213           /// Menu item data.
214           /// </summary>
215  ❌ 0     public record MenuItemDto
216           {
217  ❌ 0         public long Id { get; init; }
218  ❌ 0         public required string Name { get; init; }
219  ❌ 0         public string? Description { get; init; }
220  ❌ 0         public required string Category { get; init; }
221  ❌ 0         public decimal? Price { get; init; }
222  ❌ 0         public string? Currency { get; init; }
223  ❌ 0         public string? ImageUrl { get; init; }
224  ❌ 0         public int? Calories { get; init; }
225  ❌ 0         public string? Allergens { get; init; }
226  ❌ 0         public string? DietaryTags { get; init; }
227           }
228           
229           /// <summary>
230           /// News item data.
231           /// </summary>
232           public record NewsItemDto
233           {
234               public long Id { get; init; }
235               public required string Title { get; init; }
236               public required string Content { get; init; }
237               public string? Summary { get; init; }
238               public string? ImageUrl { get; init; }
239               public string? Author { get; init; }
240               public DateTimeOffset PublishedAt { get; init; }
241               public bool IsFeatured { get; init; }
242           }
243           
244           /// <summary>
245           /// Business summary data.
246           /// </summary>
247           public record BusinessSummaryDto
248           {
249               public long Id { get; init; }
250               public required string Name { get; init; }
251               public required string Address { get; init; }
252               public double Latitude { get; init; }
253               public double Longitude { get; init; }
254               public double? DistanceMeters { get; init; }
255               public bool IsSubscribed { get; init; }
256           }
```
# FWH.Orchestrix.Contracts.Marketing.NewsItemDto

## Summary

|||
|:---|:---|
| Class: | FWH.Orchestrix.Contracts.Marketing.NewsItemDto |
| Assembly: | FWH.Orchestrix.Contracts |
| **File(s):** | E:\github\FunWasHad\src\FWH.Orchestrix.Contracts\Marketing\MarketingContracts.cs |
| **Line coverage:** | 0% (0 of 9) |
| Covered lines: | 0 |
| Uncovered lines: | 9 |
| Coverable lines: | 9 |
| Total lines: | 256 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **.ctor(...)** | 100% | 2 | 1 | 0% |
| **get_Id()** | 100% | 2 | 1 | 0% |
| **get_Title()** | 100% | 2 | 1 | 0% |
| **get_Content()** | 100% | 2 | 1 | 0% |
| **get_Summary()** | 100% | 2 | 1 | 0% |
| **get_ImageUrl()** | 100% | 2 | 1 | 0% |
| **get_Author()** | 100% | 2 | 1 | 0% |
| **get_PublishedAt()** | 100% | 2 | 1 | 0% |
| **get_IsFeatured()** | 100% | 2 | 1 | 0% |

## File(s)

### E:\github\FunWasHad\src\FWH.Orchestrix.Contracts\Marketing\MarketingContracts.cs
```
  1           using FWH.Orchestrix.Contracts.Mediator;
  2           
  3           namespace FWH.Orchestrix.Contracts.Marketing;
  4           
  5           /// <summary>
  6           /// Base response for marketing operations.
  7           /// </summary>
  8           public record MarketingResponse
  9           {
 10               public bool Success { get; init; }
 11               public string? ErrorMessage { get; init; }
 12           }
 13           
 14           /// <summary>
 15           /// Request to get business marketing data.
 16           /// </summary>
 17           public record GetBusinessMarketingRequest : IMediatorRequest<GetBusinessMarketingResponse>
 18           {
 19               public long BusinessId { get; init; }
 20           }
 21           
 22           /// <summary>
 23           /// Response to get business marketing data.
 24           /// </summary>
 25           public record GetBusinessMarketingResponse : MarketingResponse
 26           {
 27               public BusinessMarketingDto? Data { get; init; }
 28           }
 29           
 30           /// <summary>
 31           /// Request to get business theme.
 32           /// </summary>
 33           public record GetBusinessThemeRequest : IMediatorRequest<GetBusinessThemeResponse>
 34           {
 35               public long BusinessId { get; init; }
 36           }
 37           
 38           /// <summary>
 39           /// Response to get business theme.
 40           /// </summary>
 41           public record GetBusinessThemeResponse : MarketingResponse
 42           {
 43               public BusinessThemeDto? Theme { get; init; }
 44           }
 45           
 46           /// <summary>
 47           /// Request to get business coupons.
 48           /// </summary>
 49           public record GetBusinessCouponsRequest : IMediatorRequest<GetBusinessCouponsResponse>
 50           {
 51               public long BusinessId { get; init; }
 52           }
 53           
 54           /// <summary>
 55           /// Response to get business coupons.
 56           /// </summary>
 57           public record GetBusinessCouponsResponse : MarketingResponse
 58           {
 59               public List<CouponDto> Coupons { get; init; } = new();
 60           }
 61           
 62           /// <summary>
 63           /// Request to get business menu.
 64           /// </summary>
 65           public record GetBusinessMenuRequest : IMediatorRequest<GetBusinessMenuResponse>
 66           {
 67               public long BusinessId { get; init; }
 68               public string? Category { get; init; }
 69           }
 70           
 71           /// <summary>
 72           /// Response to get business menu.
 73           /// </summary>
 74           public record GetBusinessMenuResponse : MarketingResponse
 75           {
 76               public List<MenuItemDto> MenuItems { get; init; } = new();
 77           }
 78           
 79           /// <summary>
 80           /// Request to get business news.
 81           /// </summary>
 82           public record GetBusinessNewsRequest : IMediatorRequest<GetBusinessNewsResponse>
 83           {
 84               public long BusinessId { get; init; }
 85               public int Limit { get; init; } = 10;
 86           }
 87           
 88           /// <summary>
 89           /// Response to get business news.
 90           /// </summary>
 91           public record GetBusinessNewsResponse : MarketingResponse
 92           {
 93               public List<NewsItemDto> NewsItems { get; init; } = new();
 94           }
 95           
 96           /// <summary>
 97           /// Request to submit feedback.
 98           /// </summary>
 99           public record SubmitFeedbackRequest : IMediatorRequest<SubmitFeedbackResponse>
100           {
101               public long BusinessId { get; init; }
102               public required string UserId { get; init; }
103               public string? UserName { get; init; }
104               public string? UserEmail { get; init; }
105               public required string FeedbackType { get; init; }
106               public required string Subject { get; init; }
107               public required string Message { get; init; }
108               public int? Rating { get; init; }
109               public bool IsPublic { get; init; }
110               public double? Latitude { get; init; }
111               public double? Longitude { get; init; }
112           }
113           
114           /// <summary>
115           /// Response to submit feedback.
116           /// </summary>
117           public record SubmitFeedbackResponse : MarketingResponse
118           {
119               public long? FeedbackId { get; init; }
120           }
121           
122           /// <summary>
123           /// Request to upload feedback attachment.
124           /// </summary>
125           public record UploadFeedbackAttachmentRequest : IMediatorRequest<UploadFeedbackAttachmentResponse>
126           {
127               public long FeedbackId { get; init; }
128               public required string AttachmentType { get; init; } // "image" or "video"
129               public required string FileName { get; init; }
130               public required string ContentType { get; init; }
131               public required byte[] FileData { get; init; }
132           }
133           
134           /// <summary>
135           /// Response to upload feedback attachment.
136           /// </summary>
137           public record UploadFeedbackAttachmentResponse : MarketingResponse
138           {
139               public long? AttachmentId { get; init; }
140               public string? StorageUrl { get; init; }
141           }
142           
143           /// <summary>
144           /// Request to find nearby businesses.
145           /// </summary>
146           public record FindNearbyBusinessesRequest : IMediatorRequest<FindNearbyBusinessesResponse>
147           {
148               public double Latitude { get; init; }
149               public double Longitude { get; init; }
150               public int RadiusMeters { get; init; } = 1000;
151           }
152           
153           /// <summary>
154           /// Response to find nearby businesses.
155           /// </summary>
156           public record FindNearbyBusinessesResponse : MarketingResponse
157           {
158               public List<BusinessSummaryDto> Businesses { get; init; } = new();
159           }
160           
161           // DTOs
162           
163           /// <summary>
164           /// Complete business marketing data.
165           /// </summary>
166           public record BusinessMarketingDto
167           {
168               public long BusinessId { get; init; }
169               public required string BusinessName { get; init; }
170               public BusinessThemeDto? Theme { get; init; }
171               public List<CouponDto> Coupons { get; init; } = new();
172               public List<MenuItemDto> MenuItems { get; init; } = new();
173               public List<NewsItemDto> NewsItems { get; init; } = new();
174           }
175           
176           /// <summary>
177           /// Business theme data.
178           /// </summary>
179           public record BusinessThemeDto
180           {
181               public long Id { get; init; }
182               public long BusinessId { get; init; }
183               public required string ThemeName { get; init; }
184               public string? PrimaryColor { get; init; }
185               public string? SecondaryColor { get; init; }
186               public string? AccentColor { get; init; }
187               public string? BackgroundColor { get; init; }
188               public string? TextColor { get; init; }
189               public string? LogoUrl { get; init; }
190               public string? BackgroundImageUrl { get; init; }
191               public string? CustomCss { get; init; }
192           }
193           
194           /// <summary>
195           /// Coupon data.
196           /// </summary>
197           public record CouponDto
198           {
199               public long Id { get; init; }
200               public required string Title { get; init; }
201               public required string Description { get; init; }
202               public string? Code { get; init; }
203               public decimal? DiscountAmount { get; init; }
204               public decimal? DiscountPercentage { get; init; }
205               public string? ImageUrl { get; init; }
206               public DateTimeOffset ValidFrom { get; init; }
207               public DateTimeOffset ValidUntil { get; init; }
208               public int? MaxRedemptions { get; init; }
209               public int CurrentRedemptions { get; init; }
210           }
211           
212           /// <summary>
213           /// Menu item data.
214           /// </summary>
215           public record MenuItemDto
216           {
217               public long Id { get; init; }
218               public required string Name { get; init; }
219               public string? Description { get; init; }
220               public required string Category { get; init; }
221               public decimal? Price { get; init; }
222               public string? Currency { get; init; }
223               public string? ImageUrl { get; init; }
224               public int? Calories { get; init; }
225               public string? Allergens { get; init; }
226               public string? DietaryTags { get; init; }
227           }
228           
229           /// <summary>
230           /// News item data.
231           /// </summary>
232  ❌ 0     public record NewsItemDto
233           {
234  ❌ 0         public long Id { get; init; }
235  ❌ 0         public required string Title { get; init; }
236  ❌ 0         public required string Content { get; init; }
237  ❌ 0         public string? Summary { get; init; }
238  ❌ 0         public string? ImageUrl { get; init; }
239  ❌ 0         public string? Author { get; init; }
240  ❌ 0         public DateTimeOffset PublishedAt { get; init; }
241  ❌ 0         public bool IsFeatured { get; init; }
242           }
243           
244           /// <summary>
245           /// Business summary data.
246           /// </summary>
247           public record BusinessSummaryDto
248           {
249               public long Id { get; init; }
250               public required string Name { get; init; }
251               public required string Address { get; init; }
252               public double Latitude { get; init; }
253               public double Longitude { get; init; }
254               public double? DistanceMeters { get; init; }
255               public bool IsSubscribed { get; init; }
256           }
```
# FWH.Orchestrix.Contracts.Marketing.SubmitFeedbackRequest

## Summary

|||
|:---|:---|
| Class: | FWH.Orchestrix.Contracts.Marketing.SubmitFeedbackRequest |
| Assembly: | FWH.Orchestrix.Contracts |
| **File(s):** | E:\github\FunWasHad\src\FWH.Orchestrix.Contracts\Marketing\MarketingContracts.cs |
| **Line coverage:** | 0% (0 of 12) |
| Covered lines: | 0 |
| Uncovered lines: | 12 |
| Coverable lines: | 12 |
| Total lines: | 256 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **.ctor(...)** | 100% | 2 | 1 | 0% |
| **get_BusinessId()** | 100% | 2 | 1 | 0% |
| **get_UserId()** | 100% | 2 | 1 | 0% |
| **get_UserName()** | 100% | 2 | 1 | 0% |
| **get_UserEmail()** | 100% | 2 | 1 | 0% |
| **get_FeedbackType()** | 100% | 2 | 1 | 0% |
| **get_Subject()** | 100% | 2 | 1 | 0% |
| **get_Message()** | 100% | 2 | 1 | 0% |
| **get_Rating()** | 100% | 2 | 1 | 0% |
| **get_IsPublic()** | 100% | 2 | 1 | 0% |
| **get_Latitude()** | 100% | 2 | 1 | 0% |
| **get_Longitude()** | 100% | 2 | 1 | 0% |

## File(s)

### E:\github\FunWasHad\src\FWH.Orchestrix.Contracts\Marketing\MarketingContracts.cs
```
  1           using FWH.Orchestrix.Contracts.Mediator;
  2           
  3           namespace FWH.Orchestrix.Contracts.Marketing;
  4           
  5           /// <summary>
  6           /// Base response for marketing operations.
  7           /// </summary>
  8           public record MarketingResponse
  9           {
 10               public bool Success { get; init; }
 11               public string? ErrorMessage { get; init; }
 12           }
 13           
 14           /// <summary>
 15           /// Request to get business marketing data.
 16           /// </summary>
 17           public record GetBusinessMarketingRequest : IMediatorRequest<GetBusinessMarketingResponse>
 18           {
 19               public long BusinessId { get; init; }
 20           }
 21           
 22           /// <summary>
 23           /// Response to get business marketing data.
 24           /// </summary>
 25           public record GetBusinessMarketingResponse : MarketingResponse
 26           {
 27               public BusinessMarketingDto? Data { get; init; }
 28           }
 29           
 30           /// <summary>
 31           /// Request to get business theme.
 32           /// </summary>
 33           public record GetBusinessThemeRequest : IMediatorRequest<GetBusinessThemeResponse>
 34           {
 35               public long BusinessId { get; init; }
 36           }
 37           
 38           /// <summary>
 39           /// Response to get business theme.
 40           /// </summary>
 41           public record GetBusinessThemeResponse : MarketingResponse
 42           {
 43               public BusinessThemeDto? Theme { get; init; }
 44           }
 45           
 46           /// <summary>
 47           /// Request to get business coupons.
 48           /// </summary>
 49           public record GetBusinessCouponsRequest : IMediatorRequest<GetBusinessCouponsResponse>
 50           {
 51               public long BusinessId { get; init; }
 52           }
 53           
 54           /// <summary>
 55           /// Response to get business coupons.
 56           /// </summary>
 57           public record GetBusinessCouponsResponse : MarketingResponse
 58           {
 59               public List<CouponDto> Coupons { get; init; } = new();
 60           }
 61           
 62           /// <summary>
 63           /// Request to get business menu.
 64           /// </summary>
 65           public record GetBusinessMenuRequest : IMediatorRequest<GetBusinessMenuResponse>
 66           {
 67               public long BusinessId { get; init; }
 68               public string? Category { get; init; }
 69           }
 70           
 71           /// <summary>
 72           /// Response to get business menu.
 73           /// </summary>
 74           public record GetBusinessMenuResponse : MarketingResponse
 75           {
 76               public List<MenuItemDto> MenuItems { get; init; } = new();
 77           }
 78           
 79           /// <summary>
 80           /// Request to get business news.
 81           /// </summary>
 82           public record GetBusinessNewsRequest : IMediatorRequest<GetBusinessNewsResponse>
 83           {
 84               public long BusinessId { get; init; }
 85               public int Limit { get; init; } = 10;
 86           }
 87           
 88           /// <summary>
 89           /// Response to get business news.
 90           /// </summary>
 91           public record GetBusinessNewsResponse : MarketingResponse
 92           {
 93               public List<NewsItemDto> NewsItems { get; init; } = new();
 94           }
 95           
 96           /// <summary>
 97           /// Request to submit feedback.
 98           /// </summary>
 99  ❌ 0     public record SubmitFeedbackRequest : IMediatorRequest<SubmitFeedbackResponse>
100           {
101  ❌ 0         public long BusinessId { get; init; }
102  ❌ 0         public required string UserId { get; init; }
103  ❌ 0         public string? UserName { get; init; }
104  ❌ 0         public string? UserEmail { get; init; }
105  ❌ 0         public required string FeedbackType { get; init; }
106  ❌ 0         public required string Subject { get; init; }
107  ❌ 0         public required string Message { get; init; }
108  ❌ 0         public int? Rating { get; init; }
109  ❌ 0         public bool IsPublic { get; init; }
110  ❌ 0         public double? Latitude { get; init; }
111  ❌ 0         public double? Longitude { get; init; }
112           }
113           
114           /// <summary>
115           /// Response to submit feedback.
116           /// </summary>
117           public record SubmitFeedbackResponse : MarketingResponse
118           {
119               public long? FeedbackId { get; init; }
120           }
121           
122           /// <summary>
123           /// Request to upload feedback attachment.
124           /// </summary>
125           public record UploadFeedbackAttachmentRequest : IMediatorRequest<UploadFeedbackAttachmentResponse>
126           {
127               public long FeedbackId { get; init; }
128               public required string AttachmentType { get; init; } // "image" or "video"
129               public required string FileName { get; init; }
130               public required string ContentType { get; init; }
131               public required byte[] FileData { get; init; }
132           }
133           
134           /// <summary>
135           /// Response to upload feedback attachment.
136           /// </summary>
137           public record UploadFeedbackAttachmentResponse : MarketingResponse
138           {
139               public long? AttachmentId { get; init; }
140               public string? StorageUrl { get; init; }
141           }
142           
143           /// <summary>
144           /// Request to find nearby businesses.
145           /// </summary>
146           public record FindNearbyBusinessesRequest : IMediatorRequest<FindNearbyBusinessesResponse>
147           {
148               public double Latitude { get; init; }
149               public double Longitude { get; init; }
150               public int RadiusMeters { get; init; } = 1000;
151           }
152           
153           /// <summary>
154           /// Response to find nearby businesses.
155           /// </summary>
156           public record FindNearbyBusinessesResponse : MarketingResponse
157           {
158               public List<BusinessSummaryDto> Businesses { get; init; } = new();
159           }
160           
161           // DTOs
162           
163           /// <summary>
164           /// Complete business marketing data.
165           /// </summary>
166           public record BusinessMarketingDto
167           {
168               public long BusinessId { get; init; }
169               public required string BusinessName { get; init; }
170               public BusinessThemeDto? Theme { get; init; }
171               public List<CouponDto> Coupons { get; init; } = new();
172               public List<MenuItemDto> MenuItems { get; init; } = new();
173               public List<NewsItemDto> NewsItems { get; init; } = new();
174           }
175           
176           /// <summary>
177           /// Business theme data.
178           /// </summary>
179           public record BusinessThemeDto
180           {
181               public long Id { get; init; }
182               public long BusinessId { get; init; }
183               public required string ThemeName { get; init; }
184               public string? PrimaryColor { get; init; }
185               public string? SecondaryColor { get; init; }
186               public string? AccentColor { get; init; }
187               public string? BackgroundColor { get; init; }
188               public string? TextColor { get; init; }
189               public string? LogoUrl { get; init; }
190               public string? BackgroundImageUrl { get; init; }
191               public string? CustomCss { get; init; }
192           }
193           
194           /// <summary>
195           /// Coupon data.
196           /// </summary>
197           public record CouponDto
198           {
199               public long Id { get; init; }
200               public required string Title { get; init; }
201               public required string Description { get; init; }
202               public string? Code { get; init; }
203               public decimal? DiscountAmount { get; init; }
204               public decimal? DiscountPercentage { get; init; }
205               public string? ImageUrl { get; init; }
206               public DateTimeOffset ValidFrom { get; init; }
207               public DateTimeOffset ValidUntil { get; init; }
208               public int? MaxRedemptions { get; init; }
209               public int CurrentRedemptions { get; init; }
210           }
211           
212           /// <summary>
213           /// Menu item data.
214           /// </summary>
215           public record MenuItemDto
216           {
217               public long Id { get; init; }
218               public required string Name { get; init; }
219               public string? Description { get; init; }
220               public required string Category { get; init; }
221               public decimal? Price { get; init; }
222               public string? Currency { get; init; }
223               public string? ImageUrl { get; init; }
224               public int? Calories { get; init; }
225               public string? Allergens { get; init; }
226               public string? DietaryTags { get; init; }
227           }
228           
229           /// <summary>
230           /// News item data.
231           /// </summary>
232           public record NewsItemDto
233           {
234               public long Id { get; init; }
235               public required string Title { get; init; }
236               public required string Content { get; init; }
237               public string? Summary { get; init; }
238               public string? ImageUrl { get; init; }
239               public string? Author { get; init; }
240               public DateTimeOffset PublishedAt { get; init; }
241               public bool IsFeatured { get; init; }
242           }
243           
244           /// <summary>
245           /// Business summary data.
246           /// </summary>
247           public record BusinessSummaryDto
248           {
249               public long Id { get; init; }
250               public required string Name { get; init; }
251               public required string Address { get; init; }
252               public double Latitude { get; init; }
253               public double Longitude { get; init; }
254               public double? DistanceMeters { get; init; }
255               public bool IsSubscribed { get; init; }
256           }
```
# FWH.Orchestrix.Contracts.Marketing.SubmitFeedbackResponse

## Summary

|||
|:---|:---|
| Class: | FWH.Orchestrix.Contracts.Marketing.SubmitFeedbackResponse |
| Assembly: | FWH.Orchestrix.Contracts |
| **File(s):** | E:\github\FunWasHad\src\FWH.Orchestrix.Contracts\Marketing\MarketingContracts.cs |
| **Line coverage:** | 0% (0 of 2) |
| Covered lines: | 0 |
| Uncovered lines: | 2 |
| Coverable lines: | 2 |
| Total lines: | 256 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **.ctor(...)** | 100% | 2 | 1 | 0% |
| **get_FeedbackId()** | 100% | 2 | 1 | 0% |

## File(s)

### E:\github\FunWasHad\src\FWH.Orchestrix.Contracts\Marketing\MarketingContracts.cs
```
  1           using FWH.Orchestrix.Contracts.Mediator;
  2           
  3           namespace FWH.Orchestrix.Contracts.Marketing;
  4           
  5           /// <summary>
  6           /// Base response for marketing operations.
  7           /// </summary>
  8           public record MarketingResponse
  9           {
 10               public bool Success { get; init; }
 11               public string? ErrorMessage { get; init; }
 12           }
 13           
 14           /// <summary>
 15           /// Request to get business marketing data.
 16           /// </summary>
 17           public record GetBusinessMarketingRequest : IMediatorRequest<GetBusinessMarketingResponse>
 18           {
 19               public long BusinessId { get; init; }
 20           }
 21           
 22           /// <summary>
 23           /// Response to get business marketing data.
 24           /// </summary>
 25           public record GetBusinessMarketingResponse : MarketingResponse
 26           {
 27               public BusinessMarketingDto? Data { get; init; }
 28           }
 29           
 30           /// <summary>
 31           /// Request to get business theme.
 32           /// </summary>
 33           public record GetBusinessThemeRequest : IMediatorRequest<GetBusinessThemeResponse>
 34           {
 35               public long BusinessId { get; init; }
 36           }
 37           
 38           /// <summary>
 39           /// Response to get business theme.
 40           /// </summary>
 41           public record GetBusinessThemeResponse : MarketingResponse
 42           {
 43               public BusinessThemeDto? Theme { get; init; }
 44           }
 45           
 46           /// <summary>
 47           /// Request to get business coupons.
 48           /// </summary>
 49           public record GetBusinessCouponsRequest : IMediatorRequest<GetBusinessCouponsResponse>
 50           {
 51               public long BusinessId { get; init; }
 52           }
 53           
 54           /// <summary>
 55           /// Response to get business coupons.
 56           /// </summary>
 57           public record GetBusinessCouponsResponse : MarketingResponse
 58           {
 59               public List<CouponDto> Coupons { get; init; } = new();
 60           }
 61           
 62           /// <summary>
 63           /// Request to get business menu.
 64           /// </summary>
 65           public record GetBusinessMenuRequest : IMediatorRequest<GetBusinessMenuResponse>
 66           {
 67               public long BusinessId { get; init; }
 68               public string? Category { get; init; }
 69           }
 70           
 71           /// <summary>
 72           /// Response to get business menu.
 73           /// </summary>
 74           public record GetBusinessMenuResponse : MarketingResponse
 75           {
 76               public List<MenuItemDto> MenuItems { get; init; } = new();
 77           }
 78           
 79           /// <summary>
 80           /// Request to get business news.
 81           /// </summary>
 82           public record GetBusinessNewsRequest : IMediatorRequest<GetBusinessNewsResponse>
 83           {
 84               public long BusinessId { get; init; }
 85               public int Limit { get; init; } = 10;
 86           }
 87           
 88           /// <summary>
 89           /// Response to get business news.
 90           /// </summary>
 91           public record GetBusinessNewsResponse : MarketingResponse
 92           {
 93               public List<NewsItemDto> NewsItems { get; init; } = new();
 94           }
 95           
 96           /// <summary>
 97           /// Request to submit feedback.
 98           /// </summary>
 99           public record SubmitFeedbackRequest : IMediatorRequest<SubmitFeedbackResponse>
100           {
101               public long BusinessId { get; init; }
102               public required string UserId { get; init; }
103               public string? UserName { get; init; }
104               public string? UserEmail { get; init; }
105               public required string FeedbackType { get; init; }
106               public required string Subject { get; init; }
107               public required string Message { get; init; }
108               public int? Rating { get; init; }
109               public bool IsPublic { get; init; }
110               public double? Latitude { get; init; }
111               public double? Longitude { get; init; }
112           }
113           
114           /// <summary>
115           /// Response to submit feedback.
116           /// </summary>
117  ❌ 0     public record SubmitFeedbackResponse : MarketingResponse
118           {
119  ❌ 0         public long? FeedbackId { get; init; }
120           }
121           
122           /// <summary>
123           /// Request to upload feedback attachment.
124           /// </summary>
125           public record UploadFeedbackAttachmentRequest : IMediatorRequest<UploadFeedbackAttachmentResponse>
126           {
127               public long FeedbackId { get; init; }
128               public required string AttachmentType { get; init; } // "image" or "video"
129               public required string FileName { get; init; }
130               public required string ContentType { get; init; }
131               public required byte[] FileData { get; init; }
132           }
133           
134           /// <summary>
135           /// Response to upload feedback attachment.
136           /// </summary>
137           public record UploadFeedbackAttachmentResponse : MarketingResponse
138           {
139               public long? AttachmentId { get; init; }
140               public string? StorageUrl { get; init; }
141           }
142           
143           /// <summary>
144           /// Request to find nearby businesses.
145           /// </summary>
146           public record FindNearbyBusinessesRequest : IMediatorRequest<FindNearbyBusinessesResponse>
147           {
148               public double Latitude { get; init; }
149               public double Longitude { get; init; }
150               public int RadiusMeters { get; init; } = 1000;
151           }
152           
153           /// <summary>
154           /// Response to find nearby businesses.
155           /// </summary>
156           public record FindNearbyBusinessesResponse : MarketingResponse
157           {
158               public List<BusinessSummaryDto> Businesses { get; init; } = new();
159           }
160           
161           // DTOs
162           
163           /// <summary>
164           /// Complete business marketing data.
165           /// </summary>
166           public record BusinessMarketingDto
167           {
168               public long BusinessId { get; init; }
169               public required string BusinessName { get; init; }
170               public BusinessThemeDto? Theme { get; init; }
171               public List<CouponDto> Coupons { get; init; } = new();
172               public List<MenuItemDto> MenuItems { get; init; } = new();
173               public List<NewsItemDto> NewsItems { get; init; } = new();
174           }
175           
176           /// <summary>
177           /// Business theme data.
178           /// </summary>
179           public record BusinessThemeDto
180           {
181               public long Id { get; init; }
182               public long BusinessId { get; init; }
183               public required string ThemeName { get; init; }
184               public string? PrimaryColor { get; init; }
185               public string? SecondaryColor { get; init; }
186               public string? AccentColor { get; init; }
187               public string? BackgroundColor { get; init; }
188               public string? TextColor { get; init; }
189               public string? LogoUrl { get; init; }
190               public string? BackgroundImageUrl { get; init; }
191               public string? CustomCss { get; init; }
192           }
193           
194           /// <summary>
195           /// Coupon data.
196           /// </summary>
197           public record CouponDto
198           {
199               public long Id { get; init; }
200               public required string Title { get; init; }
201               public required string Description { get; init; }
202               public string? Code { get; init; }
203               public decimal? DiscountAmount { get; init; }
204               public decimal? DiscountPercentage { get; init; }
205               public string? ImageUrl { get; init; }
206               public DateTimeOffset ValidFrom { get; init; }
207               public DateTimeOffset ValidUntil { get; init; }
208               public int? MaxRedemptions { get; init; }
209               public int CurrentRedemptions { get; init; }
210           }
211           
212           /// <summary>
213           /// Menu item data.
214           /// </summary>
215           public record MenuItemDto
216           {
217               public long Id { get; init; }
218               public required string Name { get; init; }
219               public string? Description { get; init; }
220               public required string Category { get; init; }
221               public decimal? Price { get; init; }
222               public string? Currency { get; init; }
223               public string? ImageUrl { get; init; }
224               public int? Calories { get; init; }
225               public string? Allergens { get; init; }
226               public string? DietaryTags { get; init; }
227           }
228           
229           /// <summary>
230           /// News item data.
231           /// </summary>
232           public record NewsItemDto
233           {
234               public long Id { get; init; }
235               public required string Title { get; init; }
236               public required string Content { get; init; }
237               public string? Summary { get; init; }
238               public string? ImageUrl { get; init; }
239               public string? Author { get; init; }
240               public DateTimeOffset PublishedAt { get; init; }
241               public bool IsFeatured { get; init; }
242           }
243           
244           /// <summary>
245           /// Business summary data.
246           /// </summary>
247           public record BusinessSummaryDto
248           {
249               public long Id { get; init; }
250               public required string Name { get; init; }
251               public required string Address { get; init; }
252               public double Latitude { get; init; }
253               public double Longitude { get; init; }
254               public double? DistanceMeters { get; init; }
255               public bool IsSubscribed { get; init; }
256           }
```
# FWH.Orchestrix.Contracts.Marketing.UploadFeedbackAttachmentRequest

## Summary

|||
|:---|:---|
| Class: | FWH.Orchestrix.Contracts.Marketing.UploadFeedbackAttachmentRequest |
| Assembly: | FWH.Orchestrix.Contracts |
| **File(s):** | E:\github\FunWasHad\src\FWH.Orchestrix.Contracts\Marketing\MarketingContracts.cs |
| **Line coverage:** | 0% (0 of 6) |
| Covered lines: | 0 |
| Uncovered lines: | 6 |
| Coverable lines: | 6 |
| Total lines: | 256 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **.ctor(...)** | 100% | 2 | 1 | 0% |
| **get_FeedbackId()** | 100% | 2 | 1 | 0% |
| **get_AttachmentType()** | 100% | 2 | 1 | 0% |
| **get_FileName()** | 100% | 2 | 1 | 0% |
| **get_ContentType()** | 100% | 2 | 1 | 0% |
| **get_FileData()** | 100% | 2 | 1 | 0% |

## File(s)

### E:\github\FunWasHad\src\FWH.Orchestrix.Contracts\Marketing\MarketingContracts.cs
```
  1           using FWH.Orchestrix.Contracts.Mediator;
  2           
  3           namespace FWH.Orchestrix.Contracts.Marketing;
  4           
  5           /// <summary>
  6           /// Base response for marketing operations.
  7           /// </summary>
  8           public record MarketingResponse
  9           {
 10               public bool Success { get; init; }
 11               public string? ErrorMessage { get; init; }
 12           }
 13           
 14           /// <summary>
 15           /// Request to get business marketing data.
 16           /// </summary>
 17           public record GetBusinessMarketingRequest : IMediatorRequest<GetBusinessMarketingResponse>
 18           {
 19               public long BusinessId { get; init; }
 20           }
 21           
 22           /// <summary>
 23           /// Response to get business marketing data.
 24           /// </summary>
 25           public record GetBusinessMarketingResponse : MarketingResponse
 26           {
 27               public BusinessMarketingDto? Data { get; init; }
 28           }
 29           
 30           /// <summary>
 31           /// Request to get business theme.
 32           /// </summary>
 33           public record GetBusinessThemeRequest : IMediatorRequest<GetBusinessThemeResponse>
 34           {
 35               public long BusinessId { get; init; }
 36           }
 37           
 38           /// <summary>
 39           /// Response to get business theme.
 40           /// </summary>
 41           public record GetBusinessThemeResponse : MarketingResponse
 42           {
 43               public BusinessThemeDto? Theme { get; init; }
 44           }
 45           
 46           /// <summary>
 47           /// Request to get business coupons.
 48           /// </summary>
 49           public record GetBusinessCouponsRequest : IMediatorRequest<GetBusinessCouponsResponse>
 50           {
 51               public long BusinessId { get; init; }
 52           }
 53           
 54           /// <summary>
 55           /// Response to get business coupons.
 56           /// </summary>
 57           public record GetBusinessCouponsResponse : MarketingResponse
 58           {
 59               public List<CouponDto> Coupons { get; init; } = new();
 60           }
 61           
 62           /// <summary>
 63           /// Request to get business menu.
 64           /// </summary>
 65           public record GetBusinessMenuRequest : IMediatorRequest<GetBusinessMenuResponse>
 66           {
 67               public long BusinessId { get; init; }
 68               public string? Category { get; init; }
 69           }
 70           
 71           /// <summary>
 72           /// Response to get business menu.
 73           /// </summary>
 74           public record GetBusinessMenuResponse : MarketingResponse
 75           {
 76               public List<MenuItemDto> MenuItems { get; init; } = new();
 77           }
 78           
 79           /// <summary>
 80           /// Request to get business news.
 81           /// </summary>
 82           public record GetBusinessNewsRequest : IMediatorRequest<GetBusinessNewsResponse>
 83           {
 84               public long BusinessId { get; init; }
 85               public int Limit { get; init; } = 10;
 86           }
 87           
 88           /// <summary>
 89           /// Response to get business news.
 90           /// </summary>
 91           public record GetBusinessNewsResponse : MarketingResponse
 92           {
 93               public List<NewsItemDto> NewsItems { get; init; } = new();
 94           }
 95           
 96           /// <summary>
 97           /// Request to submit feedback.
 98           /// </summary>
 99           public record SubmitFeedbackRequest : IMediatorRequest<SubmitFeedbackResponse>
100           {
101               public long BusinessId { get; init; }
102               public required string UserId { get; init; }
103               public string? UserName { get; init; }
104               public string? UserEmail { get; init; }
105               public required string FeedbackType { get; init; }
106               public required string Subject { get; init; }
107               public required string Message { get; init; }
108               public int? Rating { get; init; }
109               public bool IsPublic { get; init; }
110               public double? Latitude { get; init; }
111               public double? Longitude { get; init; }
112           }
113           
114           /// <summary>
115           /// Response to submit feedback.
116           /// </summary>
117           public record SubmitFeedbackResponse : MarketingResponse
118           {
119               public long? FeedbackId { get; init; }
120           }
121           
122           /// <summary>
123           /// Request to upload feedback attachment.
124           /// </summary>
125  ❌ 0     public record UploadFeedbackAttachmentRequest : IMediatorRequest<UploadFeedbackAttachmentResponse>
126           {
127  ❌ 0         public long FeedbackId { get; init; }
128  ❌ 0         public required string AttachmentType { get; init; } // "image" or "video"
129  ❌ 0         public required string FileName { get; init; }
130  ❌ 0         public required string ContentType { get; init; }
131  ❌ 0         public required byte[] FileData { get; init; }
132           }
133           
134           /// <summary>
135           /// Response to upload feedback attachment.
136           /// </summary>
137           public record UploadFeedbackAttachmentResponse : MarketingResponse
138           {
139               public long? AttachmentId { get; init; }
140               public string? StorageUrl { get; init; }
141           }
142           
143           /// <summary>
144           /// Request to find nearby businesses.
145           /// </summary>
146           public record FindNearbyBusinessesRequest : IMediatorRequest<FindNearbyBusinessesResponse>
147           {
148               public double Latitude { get; init; }
149               public double Longitude { get; init; }
150               public int RadiusMeters { get; init; } = 1000;
151           }
152           
153           /// <summary>
154           /// Response to find nearby businesses.
155           /// </summary>
156           public record FindNearbyBusinessesResponse : MarketingResponse
157           {
158               public List<BusinessSummaryDto> Businesses { get; init; } = new();
159           }
160           
161           // DTOs
162           
163           /// <summary>
164           /// Complete business marketing data.
165           /// </summary>
166           public record BusinessMarketingDto
167           {
168               public long BusinessId { get; init; }
169               public required string BusinessName { get; init; }
170               public BusinessThemeDto? Theme { get; init; }
171               public List<CouponDto> Coupons { get; init; } = new();
172               public List<MenuItemDto> MenuItems { get; init; } = new();
173               public List<NewsItemDto> NewsItems { get; init; } = new();
174           }
175           
176           /// <summary>
177           /// Business theme data.
178           /// </summary>
179           public record BusinessThemeDto
180           {
181               public long Id { get; init; }
182               public long BusinessId { get; init; }
183               public required string ThemeName { get; init; }
184               public string? PrimaryColor { get; init; }
185               public string? SecondaryColor { get; init; }
186               public string? AccentColor { get; init; }
187               public string? BackgroundColor { get; init; }
188               public string? TextColor { get; init; }
189               public string? LogoUrl { get; init; }
190               public string? BackgroundImageUrl { get; init; }
191               public string? CustomCss { get; init; }
192           }
193           
194           /// <summary>
195           /// Coupon data.
196           /// </summary>
197           public record CouponDto
198           {
199               public long Id { get; init; }
200               public required string Title { get; init; }
201               public required string Description { get; init; }
202               public string? Code { get; init; }
203               public decimal? DiscountAmount { get; init; }
204               public decimal? DiscountPercentage { get; init; }
205               public string? ImageUrl { get; init; }
206               public DateTimeOffset ValidFrom { get; init; }
207               public DateTimeOffset ValidUntil { get; init; }
208               public int? MaxRedemptions { get; init; }
209               public int CurrentRedemptions { get; init; }
210           }
211           
212           /// <summary>
213           /// Menu item data.
214           /// </summary>
215           public record MenuItemDto
216           {
217               public long Id { get; init; }
218               public required string Name { get; init; }
219               public string? Description { get; init; }
220               public required string Category { get; init; }
221               public decimal? Price { get; init; }
222               public string? Currency { get; init; }
223               public string? ImageUrl { get; init; }
224               public int? Calories { get; init; }
225               public string? Allergens { get; init; }
226               public string? DietaryTags { get; init; }
227           }
228           
229           /// <summary>
230           /// News item data.
231           /// </summary>
232           public record NewsItemDto
233           {
234               public long Id { get; init; }
235               public required string Title { get; init; }
236               public required string Content { get; init; }
237               public string? Summary { get; init; }
238               public string? ImageUrl { get; init; }
239               public string? Author { get; init; }
240               public DateTimeOffset PublishedAt { get; init; }
241               public bool IsFeatured { get; init; }
242           }
243           
244           /// <summary>
245           /// Business summary data.
246           /// </summary>
247           public record BusinessSummaryDto
248           {
249               public long Id { get; init; }
250               public required string Name { get; init; }
251               public required string Address { get; init; }
252               public double Latitude { get; init; }
253               public double Longitude { get; init; }
254               public double? DistanceMeters { get; init; }
255               public bool IsSubscribed { get; init; }
256           }
```
# FWH.Orchestrix.Contracts.Marketing.UploadFeedbackAttachmentResponse

## Summary

|||
|:---|:---|
| Class: | FWH.Orchestrix.Contracts.Marketing.UploadFeedbackAttachmentResponse |
| Assembly: | FWH.Orchestrix.Contracts |
| **File(s):** | E:\github\FunWasHad\src\FWH.Orchestrix.Contracts\Marketing\MarketingContracts.cs |
| **Line coverage:** | 0% (0 of 3) |
| Covered lines: | 0 |
| Uncovered lines: | 3 |
| Coverable lines: | 3 |
| Total lines: | 256 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **.ctor(...)** | 100% | 2 | 1 | 0% |
| **get_AttachmentId()** | 100% | 2 | 1 | 0% |
| **get_StorageUrl()** | 100% | 2 | 1 | 0% |

## File(s)

### E:\github\FunWasHad\src\FWH.Orchestrix.Contracts\Marketing\MarketingContracts.cs
```
  1           using FWH.Orchestrix.Contracts.Mediator;
  2           
  3           namespace FWH.Orchestrix.Contracts.Marketing;
  4           
  5           /// <summary>
  6           /// Base response for marketing operations.
  7           /// </summary>
  8           public record MarketingResponse
  9           {
 10               public bool Success { get; init; }
 11               public string? ErrorMessage { get; init; }
 12           }
 13           
 14           /// <summary>
 15           /// Request to get business marketing data.
 16           /// </summary>
 17           public record GetBusinessMarketingRequest : IMediatorRequest<GetBusinessMarketingResponse>
 18           {
 19               public long BusinessId { get; init; }
 20           }
 21           
 22           /// <summary>
 23           /// Response to get business marketing data.
 24           /// </summary>
 25           public record GetBusinessMarketingResponse : MarketingResponse
 26           {
 27               public BusinessMarketingDto? Data { get; init; }
 28           }
 29           
 30           /// <summary>
 31           /// Request to get business theme.
 32           /// </summary>
 33           public record GetBusinessThemeRequest : IMediatorRequest<GetBusinessThemeResponse>
 34           {
 35               public long BusinessId { get; init; }
 36           }
 37           
 38           /// <summary>
 39           /// Response to get business theme.
 40           /// </summary>
 41           public record GetBusinessThemeResponse : MarketingResponse
 42           {
 43               public BusinessThemeDto? Theme { get; init; }
 44           }
 45           
 46           /// <summary>
 47           /// Request to get business coupons.
 48           /// </summary>
 49           public record GetBusinessCouponsRequest : IMediatorRequest<GetBusinessCouponsResponse>
 50           {
 51               public long BusinessId { get; init; }
 52           }
 53           
 54           /// <summary>
 55           /// Response to get business coupons.
 56           /// </summary>
 57           public record GetBusinessCouponsResponse : MarketingResponse
 58           {
 59               public List<CouponDto> Coupons { get; init; } = new();
 60           }
 61           
 62           /// <summary>
 63           /// Request to get business menu.
 64           /// </summary>
 65           public record GetBusinessMenuRequest : IMediatorRequest<GetBusinessMenuResponse>
 66           {
 67               public long BusinessId { get; init; }
 68               public string? Category { get; init; }
 69           }
 70           
 71           /// <summary>
 72           /// Response to get business menu.
 73           /// </summary>
 74           public record GetBusinessMenuResponse : MarketingResponse
 75           {
 76               public List<MenuItemDto> MenuItems { get; init; } = new();
 77           }
 78           
 79           /// <summary>
 80           /// Request to get business news.
 81           /// </summary>
 82           public record GetBusinessNewsRequest : IMediatorRequest<GetBusinessNewsResponse>
 83           {
 84               public long BusinessId { get; init; }
 85               public int Limit { get; init; } = 10;
 86           }
 87           
 88           /// <summary>
 89           /// Response to get business news.
 90           /// </summary>
 91           public record GetBusinessNewsResponse : MarketingResponse
 92           {
 93               public List<NewsItemDto> NewsItems { get; init; } = new();
 94           }
 95           
 96           /// <summary>
 97           /// Request to submit feedback.
 98           /// </summary>
 99           public record SubmitFeedbackRequest : IMediatorRequest<SubmitFeedbackResponse>
100           {
101               public long BusinessId { get; init; }
102               public required string UserId { get; init; }
103               public string? UserName { get; init; }
104               public string? UserEmail { get; init; }
105               public required string FeedbackType { get; init; }
106               public required string Subject { get; init; }
107               public required string Message { get; init; }
108               public int? Rating { get; init; }
109               public bool IsPublic { get; init; }
110               public double? Latitude { get; init; }
111               public double? Longitude { get; init; }
112           }
113           
114           /// <summary>
115           /// Response to submit feedback.
116           /// </summary>
117           public record SubmitFeedbackResponse : MarketingResponse
118           {
119               public long? FeedbackId { get; init; }
120           }
121           
122           /// <summary>
123           /// Request to upload feedback attachment.
124           /// </summary>
125           public record UploadFeedbackAttachmentRequest : IMediatorRequest<UploadFeedbackAttachmentResponse>
126           {
127               public long FeedbackId { get; init; }
128               public required string AttachmentType { get; init; } // "image" or "video"
129               public required string FileName { get; init; }
130               public required string ContentType { get; init; }
131               public required byte[] FileData { get; init; }
132           }
133           
134           /// <summary>
135           /// Response to upload feedback attachment.
136           /// </summary>
137  ❌ 0     public record UploadFeedbackAttachmentResponse : MarketingResponse
138           {
139  ❌ 0         public long? AttachmentId { get; init; }
140  ❌ 0         public string? StorageUrl { get; init; }
141           }
142           
143           /// <summary>
144           /// Request to find nearby businesses.
145           /// </summary>
146           public record FindNearbyBusinessesRequest : IMediatorRequest<FindNearbyBusinessesResponse>
147           {
148               public double Latitude { get; init; }
149               public double Longitude { get; init; }
150               public int RadiusMeters { get; init; } = 1000;
151           }
152           
153           /// <summary>
154           /// Response to find nearby businesses.
155           /// </summary>
156           public record FindNearbyBusinessesResponse : MarketingResponse
157           {
158               public List<BusinessSummaryDto> Businesses { get; init; } = new();
159           }
160           
161           // DTOs
162           
163           /// <summary>
164           /// Complete business marketing data.
165           /// </summary>
166           public record BusinessMarketingDto
167           {
168               public long BusinessId { get; init; }
169               public required string BusinessName { get; init; }
170               public BusinessThemeDto? Theme { get; init; }
171               public List<CouponDto> Coupons { get; init; } = new();
172               public List<MenuItemDto> MenuItems { get; init; } = new();
173               public List<NewsItemDto> NewsItems { get; init; } = new();
174           }
175           
176           /// <summary>
177           /// Business theme data.
178           /// </summary>
179           public record BusinessThemeDto
180           {
181               public long Id { get; init; }
182               public long BusinessId { get; init; }
183               public required string ThemeName { get; init; }
184               public string? PrimaryColor { get; init; }
185               public string? SecondaryColor { get; init; }
186               public string? AccentColor { get; init; }
187               public string? BackgroundColor { get; init; }
188               public string? TextColor { get; init; }
189               public string? LogoUrl { get; init; }
190               public string? BackgroundImageUrl { get; init; }
191               public string? CustomCss { get; init; }
192           }
193           
194           /// <summary>
195           /// Coupon data.
196           /// </summary>
197           public record CouponDto
198           {
199               public long Id { get; init; }
200               public required string Title { get; init; }
201               public required string Description { get; init; }
202               public string? Code { get; init; }
203               public decimal? DiscountAmount { get; init; }
204               public decimal? DiscountPercentage { get; init; }
205               public string? ImageUrl { get; init; }
206               public DateTimeOffset ValidFrom { get; init; }
207               public DateTimeOffset ValidUntil { get; init; }
208               public int? MaxRedemptions { get; init; }
209               public int CurrentRedemptions { get; init; }
210           }
211           
212           /// <summary>
213           /// Menu item data.
214           /// </summary>
215           public record MenuItemDto
216           {
217               public long Id { get; init; }
218               public required string Name { get; init; }
219               public string? Description { get; init; }
220               public required string Category { get; init; }
221               public decimal? Price { get; init; }
222               public string? Currency { get; init; }
223               public string? ImageUrl { get; init; }
224               public int? Calories { get; init; }
225               public string? Allergens { get; init; }
226               public string? DietaryTags { get; init; }
227           }
228           
229           /// <summary>
230           /// News item data.
231           /// </summary>
232           public record NewsItemDto
233           {
234               public long Id { get; init; }
235               public required string Title { get; init; }
236               public required string Content { get; init; }
237               public string? Summary { get; init; }
238               public string? ImageUrl { get; init; }
239               public string? Author { get; init; }
240               public DateTimeOffset PublishedAt { get; init; }
241               public bool IsFeatured { get; init; }
242           }
243           
244           /// <summary>
245           /// Business summary data.
246           /// </summary>
247           public record BusinessSummaryDto
248           {
249               public long Id { get; init; }
250               public required string Name { get; init; }
251               public required string Address { get; init; }
252               public double Latitude { get; init; }
253               public double Longitude { get; init; }
254               public double? DistanceMeters { get; init; }
255               public bool IsSubscribed { get; init; }
256           }
```
# FWH.Orchestrix.Mediator.Remote.Extensions.ApiAuthenticationMessageHandler

## Summary

|||
|:---|:---|
| Class: | FWH.Orchestrix.Mediator.Remote.Extensions.ApiAuthenticationMessageHandler |
| Assembly: | FWH.Orchestrix.Mediator.Remote |
| **File(s):** | E:\github\FunWasHad\src\FWH.Orchestrix.Mediator.Remote\Extensions\MediatorServiceCollectionExtensions.cs |
| **Line coverage:** | 0% (0 of 27) |
| Covered lines: | 0 |
| Uncovered lines: | 27 |
| Coverable lines: | 27 |
| Total lines: | 233 |
| **Branch coverage:** | 0% (0 of 12) |
| Covered branches: | 0 |
| Total branches: | 12 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **.ctor(...)** | 0% | 6 | 2 | 0% |
| **SendAsync()** | 0% | 110 | 10 | 0% |

## File(s)

### E:\github\FunWasHad\src\FWH.Orchestrix.Mediator.Remote\Extensions\MediatorServiceCollectionExtensions.cs
```
  1           using Microsoft.Extensions.DependencyInjection;
  2           using FWH.Orchestrix.Contracts.Mediator;
  3           using FWH.Orchestrix.Mediator.Remote.Location;
  4           using FWH.Orchestrix.Mediator.Remote.Marketing;
  5           using FWH.Orchestrix.Mediator.Remote.Mediator;
  6           using System.Net.Http;
  7           using System.Net.Http.Headers;
  8           using System.Reflection;
  9           using System.Text;
 10           using Polly;
 11           using Polly.CircuitBreaker;
 12           using Polly.Fallback;
 13           
 14           namespace FWH.Orchestrix.Mediator.Remote.Extensions;
 15           
 16           /// <summary>
 17           /// Extension methods for registering remote mediator handlers.
 18           /// </summary>
 19           public static class MediatorServiceCollectionExtensions
 20           {
 21               /// <summary>
 22               /// Adds remote mediator handlers for all APIs.
 23               /// </summary>
 24               public static IServiceCollection AddRemoteMediatorHandlers(this IServiceCollection services)
 25               {
 26                   services.AddSingleton<IMediatorSender, ServiceProviderMediatorSender>();
 27           
 28                   // Location
 29                   services.AddTransient<IMediatorHandler<FWH.Orchestrix.Contracts.Location.UpdateDeviceLocationRequest, FWH.Orches
 30                   services.AddTransient<IMediatorHandler<FWH.Orchestrix.Contracts.Location.GetDeviceLocationHistoryRequest, FWH.Or
 31                   services.AddTransient<IMediatorHandler<FWH.Orchestrix.Contracts.Location.GetNearbyBusinessesRequest, FWH.Orchest
 32           
 33                   // Marketing
 34                   services.AddTransient<IMediatorHandler<FWH.Orchestrix.Contracts.Marketing.GetBusinessMarketingRequest, FWH.Orche
 35                   services.AddTransient<IMediatorHandler<FWH.Orchestrix.Contracts.Marketing.GetBusinessThemeRequest, FWH.Orchestri
 36                   services.AddTransient<IMediatorHandler<FWH.Orchestrix.Contracts.Marketing.GetBusinessCouponsRequest, FWH.Orchest
 37                   // Note: additional Marketing handlers (menu/news/nearby) should be registered here once implemented.
 38                   services.AddTransient<IMediatorHandler<FWH.Orchestrix.Contracts.Marketing.SubmitFeedbackRequest, FWH.Orchestrix.
 39                   services.AddTransient<IMediatorHandler<FWH.Orchestrix.Contracts.Marketing.UploadFeedbackAttachmentRequest, FWH.O
 40           
 41                   return services;
 42               }
 43           
 44               /// <summary>
 45               /// Configures HTTP clients for API handlers.
 46               /// </summary>
 47               public static IServiceCollection AddApiHttpClients(
 48                   this IServiceCollection services,
 49                   Action<ApiClientOptions> configure)
 50               {
 51                   var options = new ApiClientOptions();
 52                   configure(options);
 53           
 54                   // Register Location API client with resilience
 55                   services.AddHttpClient("LocationApi", client =>
 56                   {
 57                       client.BaseAddress = new Uri(options.LocationApiBaseUrl);
 58                       client.Timeout = TimeSpan.FromSeconds(30);
 59                   })
 60                   .AddHttpMessageHandler(serviceProvider =>
 61                       new ApiAuthenticationMessageHandler(serviceProvider))
 62                   .AddResilienceHandler("location-api-pipeline", (ResiliencePipelineBuilder<HttpResponseMessage> builder) =>
 63                   {
 64                       // 1. Fallback (outer layer - executed last if all else fails)
 65                       //builder.AddFallback(new FallbackStrategyOptions<HttpResponseMessage>
 66                       //{
 67                       //    ShouldHandle = new PredicateBuilder<HttpResponseMessage>()
 68                       //        .Handle<HttpRequestException>()
 69                       //        .Handle<TimeoutException>()
 70                       //        .Handle<BrokenCircuitException>()
 71                       //        .HandleResult(response => !response.IsSuccessStatusCode),
 72                       //    FallbackAction = args =>
 73                       //    {
 74                       //        // Return an empty response depending on the endpoint
 75                       //        var fallbackResponse = new HttpResponseMessage(System.Net.HttpStatusCode.OK)
 76                       //        {
 77                       //            Content = new StringContent("[]", System.Text.Encoding.UTF8, "application/json")
 78                       //        };
 79           
 80                       //        return Outcome.FromResultAsValueTask(fallbackResponse);
 81                       //    }
 82                       //});
 83           
 84                       // 2. Circuit breaker (prevents cascading failures)
 85                       builder.AddCircuitBreaker(new CircuitBreakerStrategyOptions<HttpResponseMessage>
 86                       {
 87                           SamplingDuration = TimeSpan.FromSeconds(30),
 88                           FailureRatio = 0.5,
 89                           MinimumThroughput = 3,
 90                           BreakDuration = TimeSpan.FromSeconds(15),
 91                           ShouldHandle = new PredicateBuilder<HttpResponseMessage>()
 92                               .Handle<HttpRequestException>()
 93                               .Handle<TimeoutException>()
 94                               .HandleResult(response => !response.IsSuccessStatusCode)
 95                       });
 96           
 97                       // 3. Retry with exponential backoff
 98                       builder.AddRetry(new Polly.Retry.RetryStrategyOptions<HttpResponseMessage>
 99                       {
100                           MaxRetryAttempts = 3,
101                           BackoffType = Polly.DelayBackoffType.Exponential,
102                           UseJitter = true,
103                           Delay = TimeSpan.FromSeconds(1),
104                           ShouldHandle = new PredicateBuilder<HttpResponseMessage>()
105                               .Handle<HttpRequestException>()
106                               .Handle<TimeoutException>()
107                               .HandleResult(response => !response.IsSuccessStatusCode && response.StatusCode != System.Net.HttpSta
108                       });
109           
110                       // 4. Timeout per attempt (inner layer - wraps each individual request)
111                       builder.AddTimeout(TimeSpan.FromSeconds(30));
112                   });
113           
114                   // Register Marketing API client with resilience
115                   services.AddHttpClient("MarketingApi", client =>
116                   {
117                       client.BaseAddress = new Uri(options.MarketingApiBaseUrl);
118                       client.Timeout = TimeSpan.FromSeconds(30);
119                   })
120                   .AddHttpMessageHandler(serviceProvider =>
121                       new ApiAuthenticationMessageHandler(serviceProvider))
122                   .AddResilienceHandler("marketing-api-pipeline", (ResiliencePipelineBuilder<HttpResponseMessage> builder) =>
123                   {
124                       // 1. Fallback (outer layer - executed last if all else fails)
125                       //builder.AddFallback(new FallbackStrategyOptions<HttpResponseMessage>
126                       //{
127                       //    ShouldHandle = new PredicateBuilder<HttpResponseMessage>()
128                       //        .Handle<HttpRequestException>()
129                       //        .Handle<TimeoutException>()
130                       //        .Handle<BrokenCircuitException>()
131                       //        .HandleResult(response => !response.IsSuccessStatusCode),
132                       //    FallbackAction = args =>
133                       //    {
134                       //        // Return an empty response
135                       //        var fallbackResponse = new HttpResponseMessage(System.Net.HttpStatusCode.OK)
136                       //        {
137                       //            Content = new StringContent("[]", System.Text.Encoding.UTF8, "application/json")
138                       //        };
139           
140                       //        return Outcome.FromResultAsValueTask(fallbackResponse);
141                       //    }
142                       //});
143           
144                       // 2. Circuit breaker (prevents cascading failures)
145                       builder.AddCircuitBreaker(new CircuitBreakerStrategyOptions<HttpResponseMessage>
146                       {
147                           SamplingDuration = TimeSpan.FromSeconds(30),
148                           FailureRatio = 0.5,
149                           MinimumThroughput = 3,
150                           BreakDuration = TimeSpan.FromSeconds(15),
151                           ShouldHandle = new PredicateBuilder<HttpResponseMessage>()
152                               .Handle<HttpRequestException>()
153                               .Handle<TimeoutException>()
154                               .HandleResult(response => !response.IsSuccessStatusCode)
155                       });
156           
157                       // 3. Retry with exponential backoff
158                       builder.AddRetry(new Polly.Retry.RetryStrategyOptions<HttpResponseMessage>
159                       {
160                           MaxRetryAttempts = 3,
161                           BackoffType = Polly.DelayBackoffType.Exponential,
162                           UseJitter = true,
163                           Delay = TimeSpan.FromSeconds(1),
164                           ShouldHandle = new PredicateBuilder<HttpResponseMessage>()
165                               .Handle<HttpRequestException>()
166                               .Handle<TimeoutException>()
167                               .HandleResult(response => !response.IsSuccessStatusCode && response.StatusCode != System.Net.HttpSta
168                       });
169           
170                       // 4. Timeout per attempt (inner layer - wraps each individual request)
171                       builder.AddTimeout(TimeSpan.FromSeconds(10));
172                   });
173           
174                   return services;
175               }
176           }
177           
178           /// <summary>
179           /// Options for API client configuration.
180           /// </summary>
181           public class ApiClientOptions
182           {
183               public string LocationApiBaseUrl { get; set; } = "https://localhost:4747";
184               public string MarketingApiBaseUrl { get; set; } = "https://localhost:4749";
185           }
186           
187           /// <summary>
188           /// HTTP message handler that adds API authentication headers to requests.
189           /// Uses reflection to access IApiAuthenticationService from Mobile project if available.
190           /// </summary>
191           internal class ApiAuthenticationMessageHandler : DelegatingHandler
192           {
193               private readonly IServiceProvider _serviceProvider;
194           
195  ❌ 0         public ApiAuthenticationMessageHandler(IServiceProvider serviceProvider)
196  ❌ 0         {
197  ❌ 0  ○          _serviceProvider = serviceProvider ?? throw new ArgumentNullException(nameof(serviceProvider));
198  ❌ 0         }
199           
200               protected override async Task<HttpResponseMessage> SendAsync(
201                   HttpRequestMessage request,
202                   CancellationToken cancellationToken)
203  ❌ 0         {
204                   // Try to get IApiAuthenticationService from service provider using reflection
205                   // This avoids a direct dependency on FWH.Mobile project
206  ❌ 0             var authServiceType = Type.GetType("FWH.Mobile.Services.IApiAuthenticationService, FWH.Mobile");
207  ❌ 0  ○          if (authServiceType != null)
208  ❌ 0             {
209  ❌ 0                 var authService = _serviceProvider.GetService(authServiceType);
210  ❌ 0  ○              if (authService != null)
211  ❌ 0                 {
212                           // Get request body if present for signing
213  ❌ 0                     string? requestBody = null;
214  ❌ 0  ○                  if (request.Content != null)
215  ❌ 0                     {
216  ❌ 0                         requestBody = await request.Content.ReadAsStringAsync(cancellationToken);
217                               // Reset the content stream position
218  ❌ 0  ○                      var contentType = request.Content.Headers.ContentType ?? new MediaTypeHeaderValue("application/json"
219  ❌ 0                         request.Content = new StringContent(requestBody, System.Text.Encoding.UTF8, contentType);
220  ❌ 0                     }
221           
222                           // Call AddAuthenticationHeaders via reflection
223  ❌ 0                     var method = authServiceType.GetMethod("AddAuthenticationHeaders");
224  ❌ 0  ○                  if (method != null)
225  ❌ 0                     {
226  ❌ 0                         method.Invoke(authService, new object[] { request, requestBody! });
227  ❌ 0                     }
228  ❌ 0                 }
229  ❌ 0             }
230           
231  ❌ 0             return await base.SendAsync(request, cancellationToken);
232  ❌ 0         }
233           }
```
# FWH.Orchestrix.Mediator.Remote.Extensions.ApiClientOptions

## Summary

|||
|:---|:---|
| Class: | FWH.Orchestrix.Mediator.Remote.Extensions.ApiClientOptions |
| Assembly: | FWH.Orchestrix.Mediator.Remote |
| **File(s):** | E:\github\FunWasHad\src\FWH.Orchestrix.Mediator.Remote\Extensions\MediatorServiceCollectionExtensions.cs |
| **Line coverage:** | 0% (0 of 2) |
| Covered lines: | 0 |
| Uncovered lines: | 2 |
| Coverable lines: | 2 |
| Total lines: | 233 |
| Covered branches: | 0 |
| Total branches: | 0 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **get_LocationApiBaseUrl()** | 100% | 2 | 1 | 0% |
| **get_MarketingApiBaseUrl()** | 100% | 2 | 1 | 0% |

## File(s)

### E:\github\FunWasHad\src\FWH.Orchestrix.Mediator.Remote\Extensions\MediatorServiceCollectionExtensions.cs
```
  1           using Microsoft.Extensions.DependencyInjection;
  2           using FWH.Orchestrix.Contracts.Mediator;
  3           using FWH.Orchestrix.Mediator.Remote.Location;
  4           using FWH.Orchestrix.Mediator.Remote.Marketing;
  5           using FWH.Orchestrix.Mediator.Remote.Mediator;
  6           using System.Net.Http;
  7           using System.Net.Http.Headers;
  8           using System.Reflection;
  9           using System.Text;
 10           using Polly;
 11           using Polly.CircuitBreaker;
 12           using Polly.Fallback;
 13           
 14           namespace FWH.Orchestrix.Mediator.Remote.Extensions;
 15           
 16           /// <summary>
 17           /// Extension methods for registering remote mediator handlers.
 18           /// </summary>
 19           public static class MediatorServiceCollectionExtensions
 20           {
 21               /// <summary>
 22               /// Adds remote mediator handlers for all APIs.
 23               /// </summary>
 24               public static IServiceCollection AddRemoteMediatorHandlers(this IServiceCollection services)
 25               {
 26                   services.AddSingleton<IMediatorSender, ServiceProviderMediatorSender>();
 27           
 28                   // Location
 29                   services.AddTransient<IMediatorHandler<FWH.Orchestrix.Contracts.Location.UpdateDeviceLocationRequest, FWH.Orches
 30                   services.AddTransient<IMediatorHandler<FWH.Orchestrix.Contracts.Location.GetDeviceLocationHistoryRequest, FWH.Or
 31                   services.AddTransient<IMediatorHandler<FWH.Orchestrix.Contracts.Location.GetNearbyBusinessesRequest, FWH.Orchest
 32           
 33                   // Marketing
 34                   services.AddTransient<IMediatorHandler<FWH.Orchestrix.Contracts.Marketing.GetBusinessMarketingRequest, FWH.Orche
 35                   services.AddTransient<IMediatorHandler<FWH.Orchestrix.Contracts.Marketing.GetBusinessThemeRequest, FWH.Orchestri
 36                   services.AddTransient<IMediatorHandler<FWH.Orchestrix.Contracts.Marketing.GetBusinessCouponsRequest, FWH.Orchest
 37                   // Note: additional Marketing handlers (menu/news/nearby) should be registered here once implemented.
 38                   services.AddTransient<IMediatorHandler<FWH.Orchestrix.Contracts.Marketing.SubmitFeedbackRequest, FWH.Orchestrix.
 39                   services.AddTransient<IMediatorHandler<FWH.Orchestrix.Contracts.Marketing.UploadFeedbackAttachmentRequest, FWH.O
 40           
 41                   return services;
 42               }
 43           
 44               /// <summary>
 45               /// Configures HTTP clients for API handlers.
 46               /// </summary>
 47               public static IServiceCollection AddApiHttpClients(
 48                   this IServiceCollection services,
 49                   Action<ApiClientOptions> configure)
 50               {
 51                   var options = new ApiClientOptions();
 52                   configure(options);
 53           
 54                   // Register Location API client with resilience
 55                   services.AddHttpClient("LocationApi", client =>
 56                   {
 57                       client.BaseAddress = new Uri(options.LocationApiBaseUrl);
 58                       client.Timeout = TimeSpan.FromSeconds(30);
 59                   })
 60                   .AddHttpMessageHandler(serviceProvider =>
 61                       new ApiAuthenticationMessageHandler(serviceProvider))
 62                   .AddResilienceHandler("location-api-pipeline", (ResiliencePipelineBuilder<HttpResponseMessage> builder) =>
 63                   {
 64                       // 1. Fallback (outer layer - executed last if all else fails)
 65                       //builder.AddFallback(new FallbackStrategyOptions<HttpResponseMessage>
 66                       //{
 67                       //    ShouldHandle = new PredicateBuilder<HttpResponseMessage>()
 68                       //        .Handle<HttpRequestException>()
 69                       //        .Handle<TimeoutException>()
 70                       //        .Handle<BrokenCircuitException>()
 71                       //        .HandleResult(response => !response.IsSuccessStatusCode),
 72                       //    FallbackAction = args =>
 73                       //    {
 74                       //        // Return an empty response depending on the endpoint
 75                       //        var fallbackResponse = new HttpResponseMessage(System.Net.HttpStatusCode.OK)
 76                       //        {
 77                       //            Content = new StringContent("[]", System.Text.Encoding.UTF8, "application/json")
 78                       //        };
 79           
 80                       //        return Outcome.FromResultAsValueTask(fallbackResponse);
 81                       //    }
 82                       //});
 83           
 84                       // 2. Circuit breaker (prevents cascading failures)
 85                       builder.AddCircuitBreaker(new CircuitBreakerStrategyOptions<HttpResponseMessage>
 86                       {
 87                           SamplingDuration = TimeSpan.FromSeconds(30),
 88                           FailureRatio = 0.5,
 89                           MinimumThroughput = 3,
 90                           BreakDuration = TimeSpan.FromSeconds(15),
 91                           ShouldHandle = new PredicateBuilder<HttpResponseMessage>()
 92                               .Handle<HttpRequestException>()
 93                               .Handle<TimeoutException>()
 94                               .HandleResult(response => !response.IsSuccessStatusCode)
 95                       });
 96           
 97                       // 3. Retry with exponential backoff
 98                       builder.AddRetry(new Polly.Retry.RetryStrategyOptions<HttpResponseMessage>
 99                       {
100                           MaxRetryAttempts = 3,
101                           BackoffType = Polly.DelayBackoffType.Exponential,
102                           UseJitter = true,
103                           Delay = TimeSpan.FromSeconds(1),
104                           ShouldHandle = new PredicateBuilder<HttpResponseMessage>()
105                               .Handle<HttpRequestException>()
106                               .Handle<TimeoutException>()
107                               .HandleResult(response => !response.IsSuccessStatusCode && response.StatusCode != System.Net.HttpSta
108                       });
109           
110                       // 4. Timeout per attempt (inner layer - wraps each individual request)
111                       builder.AddTimeout(TimeSpan.FromSeconds(30));
112                   });
113           
114                   // Register Marketing API client with resilience
115                   services.AddHttpClient("MarketingApi", client =>
116                   {
117                       client.BaseAddress = new Uri(options.MarketingApiBaseUrl);
118                       client.Timeout = TimeSpan.FromSeconds(30);
119                   })
120                   .AddHttpMessageHandler(serviceProvider =>
121                       new ApiAuthenticationMessageHandler(serviceProvider))
122                   .AddResilienceHandler("marketing-api-pipeline", (ResiliencePipelineBuilder<HttpResponseMessage> builder) =>
123                   {
124                       // 1. Fallback (outer layer - executed last if all else fails)
125                       //builder.AddFallback(new FallbackStrategyOptions<HttpResponseMessage>
126                       //{
127                       //    ShouldHandle = new PredicateBuilder<HttpResponseMessage>()
128                       //        .Handle<HttpRequestException>()
129                       //        .Handle<TimeoutException>()
130                       //        .Handle<BrokenCircuitException>()
131                       //        .HandleResult(response => !response.IsSuccessStatusCode),
132                       //    FallbackAction = args =>
133                       //    {
134                       //        // Return an empty response
135                       //        var fallbackResponse = new HttpResponseMessage(System.Net.HttpStatusCode.OK)
136                       //        {
137                       //            Content = new StringContent("[]", System.Text.Encoding.UTF8, "application/json")
138                       //        };
139           
140                       //        return Outcome.FromResultAsValueTask(fallbackResponse);
141                       //    }
142                       //});
143           
144                       // 2. Circuit breaker (prevents cascading failures)
145                       builder.AddCircuitBreaker(new CircuitBreakerStrategyOptions<HttpResponseMessage>
146                       {
147                           SamplingDuration = TimeSpan.FromSeconds(30),
148                           FailureRatio = 0.5,
149                           MinimumThroughput = 3,
150                           BreakDuration = TimeSpan.FromSeconds(15),
151                           ShouldHandle = new PredicateBuilder<HttpResponseMessage>()
152                               .Handle<HttpRequestException>()
153                               .Handle<TimeoutException>()
154                               .HandleResult(response => !response.IsSuccessStatusCode)
155                       });
156           
157                       // 3. Retry with exponential backoff
158                       builder.AddRetry(new Polly.Retry.RetryStrategyOptions<HttpResponseMessage>
159                       {
160                           MaxRetryAttempts = 3,
161                           BackoffType = Polly.DelayBackoffType.Exponential,
162                           UseJitter = true,
163                           Delay = TimeSpan.FromSeconds(1),
164                           ShouldHandle = new PredicateBuilder<HttpResponseMessage>()
165                               .Handle<HttpRequestException>()
166                               .Handle<TimeoutException>()
167                               .HandleResult(response => !response.IsSuccessStatusCode && response.StatusCode != System.Net.HttpSta
168                       });
169           
170                       // 4. Timeout per attempt (inner layer - wraps each individual request)
171                       builder.AddTimeout(TimeSpan.FromSeconds(10));
172                   });
173           
174                   return services;
175               }
176           }
177           
178           /// <summary>
179           /// Options for API client configuration.
180           /// </summary>
181           public class ApiClientOptions
182           {
183  ❌ 0         public string LocationApiBaseUrl { get; set; } = "https://localhost:4747";
184  ❌ 0         public string MarketingApiBaseUrl { get; set; } = "https://localhost:4749";
185           }
186           
187           /// <summary>
188           /// HTTP message handler that adds API authentication headers to requests.
189           /// Uses reflection to access IApiAuthenticationService from Mobile project if available.
190           /// </summary>
191           internal class ApiAuthenticationMessageHandler : DelegatingHandler
192           {
193               private readonly IServiceProvider _serviceProvider;
194           
195               public ApiAuthenticationMessageHandler(IServiceProvider serviceProvider)
196               {
197                   _serviceProvider = serviceProvider ?? throw new ArgumentNullException(nameof(serviceProvider));
198               }
199           
200               protected override async Task<HttpResponseMessage> SendAsync(
201                   HttpRequestMessage request,
202                   CancellationToken cancellationToken)
203               {
204                   // Try to get IApiAuthenticationService from service provider using reflection
205                   // This avoids a direct dependency on FWH.Mobile project
206                   var authServiceType = Type.GetType("FWH.Mobile.Services.IApiAuthenticationService, FWH.Mobile");
207                   if (authServiceType != null)
208                   {
209                       var authService = _serviceProvider.GetService(authServiceType);
210                       if (authService != null)
211                       {
212                           // Get request body if present for signing
213                           string? requestBody = null;
214                           if (request.Content != null)
215                           {
216                               requestBody = await request.Content.ReadAsStringAsync(cancellationToken);
217                               // Reset the content stream position
218                               var contentType = request.Content.Headers.ContentType ?? new MediaTypeHeaderValue("application/json"
219                               request.Content = new StringContent(requestBody, System.Text.Encoding.UTF8, contentType);
220                           }
221           
222                           // Call AddAuthenticationHeaders via reflection
223                           var method = authServiceType.GetMethod("AddAuthenticationHeaders");
224                           if (method != null)
225                           {
226                               method.Invoke(authService, new object[] { request, requestBody! });
227                           }
228                       }
229                   }
230           
231                   return await base.SendAsync(request, cancellationToken);
232               }
233           }
```
# FWH.Orchestrix.Mediator.Remote.Extensions.MediatorServiceCollectionExtensions

## Summary

|||
|:---|:---|
| Class: | FWH.Orchestrix.Mediator.Remote.Extensions.MediatorServiceCollectionExtensions |
| Assembly: | FWH.Orchestrix.Mediator.Remote |
| **File(s):** | E:\github\FunWasHad\src\FWH.Orchestrix.Mediator.Remote\Extensions\MediatorServiceCollectionExtensions.cs |
| **Line coverage:** | 9% (12 of 133) |
| Covered lines: | 12 |
| Uncovered lines: | 121 |
| Coverable lines: | 133 |
| Total lines: | 233 |
| **Branch coverage:** | 0% (0 of 4) |
| Covered branches: | 0 |
| Total branches: | 4 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **AddRemoteMediatorHandlers(...)** | 100% | 1 | 1 | 100% |
| **AddApiHttpClients(...)** | 0% | 20 | 4 | 0% |

## File(s)

### E:\github\FunWasHad\src\FWH.Orchestrix.Mediator.Remote\Extensions\MediatorServiceCollectionExtensions.cs
```
  1            using Microsoft.Extensions.DependencyInjection;
  2            using FWH.Orchestrix.Contracts.Mediator;
  3            using FWH.Orchestrix.Mediator.Remote.Location;
  4            using FWH.Orchestrix.Mediator.Remote.Marketing;
  5            using FWH.Orchestrix.Mediator.Remote.Mediator;
  6            using System.Net.Http;
  7            using System.Net.Http.Headers;
  8            using System.Reflection;
  9            using System.Text;
 10            using Polly;
 11            using Polly.CircuitBreaker;
 12            using Polly.Fallback;
 13            
 14            namespace FWH.Orchestrix.Mediator.Remote.Extensions;
 15            
 16            /// <summary>
 17            /// Extension methods for registering remote mediator handlers.
 18            /// </summary>
 19            public static class MediatorServiceCollectionExtensions
 20            {
 21                /// <summary>
 22                /// Adds remote mediator handlers for all APIs.
 23                /// </summary>
 24                public static IServiceCollection AddRemoteMediatorHandlers(this IServiceCollection services)
 25  ✔  56         {
 26  ✔  56             services.AddSingleton<IMediatorSender, ServiceProviderMediatorSender>();
 27            
 28                    // Location
 29  ✔  56             services.AddTransient<IMediatorHandler<FWH.Orchestrix.Contracts.Location.UpdateDeviceLocationRequest, FWH.Orches
 30  ✔  56             services.AddTransient<IMediatorHandler<FWH.Orchestrix.Contracts.Location.GetDeviceLocationHistoryRequest, FWH.Or
 31  ✔  56             services.AddTransient<IMediatorHandler<FWH.Orchestrix.Contracts.Location.GetNearbyBusinessesRequest, FWH.Orchest
 32            
 33                    // Marketing
 34  ✔  56             services.AddTransient<IMediatorHandler<FWH.Orchestrix.Contracts.Marketing.GetBusinessMarketingRequest, FWH.Orche
 35  ✔  56             services.AddTransient<IMediatorHandler<FWH.Orchestrix.Contracts.Marketing.GetBusinessThemeRequest, FWH.Orchestri
 36  ✔  56             services.AddTransient<IMediatorHandler<FWH.Orchestrix.Contracts.Marketing.GetBusinessCouponsRequest, FWH.Orchest
 37                    // Note: additional Marketing handlers (menu/news/nearby) should be registered here once implemented.
 38  ✔  56             services.AddTransient<IMediatorHandler<FWH.Orchestrix.Contracts.Marketing.SubmitFeedbackRequest, FWH.Orchestrix.
 39  ✔  56             services.AddTransient<IMediatorHandler<FWH.Orchestrix.Contracts.Marketing.UploadFeedbackAttachmentRequest, FWH.O
 40            
 41  ✔  56             return services;
 42  ✔  56         }
 43            
 44                /// <summary>
 45                /// Configures HTTP clients for API handlers.
 46                /// </summary>
 47                public static IServiceCollection AddApiHttpClients(
 48                    this IServiceCollection services,
 49                    Action<ApiClientOptions> configure)
 50  ❌  0         {
 51  ❌  0             var options = new ApiClientOptions();
 52  ❌  0             configure(options);
 53            
 54                    // Register Location API client with resilience
 55  ❌  0             services.AddHttpClient("LocationApi", client =>
 56  ❌  0             {
 57  ❌  0                 client.BaseAddress = new Uri(options.LocationApiBaseUrl);
 58  ❌  0                 client.Timeout = TimeSpan.FromSeconds(30);
 59  ❌  0             })
 60  ❌  0             .AddHttpMessageHandler(serviceProvider =>
 61  ❌  0                 new ApiAuthenticationMessageHandler(serviceProvider))
 62  ❌  0             .AddResilienceHandler("location-api-pipeline", (ResiliencePipelineBuilder<HttpResponseMessage> builder) =>
 63  ❌  0             {
 64  ❌  0                 // 1. Fallback (outer layer - executed last if all else fails)
 65  ❌  0                 //builder.AddFallback(new FallbackStrategyOptions<HttpResponseMessage>
 66  ❌  0                 //{
 67  ❌  0                 //    ShouldHandle = new PredicateBuilder<HttpResponseMessage>()
 68  ❌  0                 //        .Handle<HttpRequestException>()
 69  ❌  0                 //        .Handle<TimeoutException>()
 70  ❌  0                 //        .Handle<BrokenCircuitException>()
 71  ❌  0                 //        .HandleResult(response => !response.IsSuccessStatusCode),
 72  ❌  0                 //    FallbackAction = args =>
 73  ❌  0                 //    {
 74  ❌  0                 //        // Return an empty response depending on the endpoint
 75  ❌  0                 //        var fallbackResponse = new HttpResponseMessage(System.Net.HttpStatusCode.OK)
 76  ❌  0                 //        {
 77  ❌  0                 //            Content = new StringContent("[]", System.Text.Encoding.UTF8, "application/json")
 78  ❌  0                 //        };
 79  ❌  0     
 80  ❌  0                 //        return Outcome.FromResultAsValueTask(fallbackResponse);
 81  ❌  0                 //    }
 82  ❌  0                 //});
 83  ❌  0     
 84  ❌  0                 // 2. Circuit breaker (prevents cascading failures)
 85  ❌  0                 builder.AddCircuitBreaker(new CircuitBreakerStrategyOptions<HttpResponseMessage>
 86  ❌  0                 {
 87  ❌  0                     SamplingDuration = TimeSpan.FromSeconds(30),
 88  ❌  0                     FailureRatio = 0.5,
 89  ❌  0                     MinimumThroughput = 3,
 90  ❌  0                     BreakDuration = TimeSpan.FromSeconds(15),
 91  ❌  0                     ShouldHandle = new PredicateBuilder<HttpResponseMessage>()
 92  ❌  0                         .Handle<HttpRequestException>()
 93  ❌  0                         .Handle<TimeoutException>()
 94  ❌  0                         .HandleResult(response => !response.IsSuccessStatusCode)
 95  ❌  0                 });
 96  ❌  0     
 97  ❌  0                 // 3. Retry with exponential backoff
 98  ❌  0                 builder.AddRetry(new Polly.Retry.RetryStrategyOptions<HttpResponseMessage>
 99  ❌  0                 {
100  ❌  0                     MaxRetryAttempts = 3,
101  ❌  0                     BackoffType = Polly.DelayBackoffType.Exponential,
102  ❌  0                     UseJitter = true,
103  ❌  0                     Delay = TimeSpan.FromSeconds(1),
104  ❌  0                     ShouldHandle = new PredicateBuilder<HttpResponseMessage>()
105  ❌  0                         .Handle<HttpRequestException>()
106  ❌  0                         .Handle<TimeoutException>()
107  ❌  0  ○                      .HandleResult(response => !response.IsSuccessStatusCode && response.StatusCode != System.Net.HttpSta
108  ❌  0                 });
109  ❌  0     
110  ❌  0                 // 4. Timeout per attempt (inner layer - wraps each individual request)
111  ❌  0                 builder.AddTimeout(TimeSpan.FromSeconds(30));
112  ❌  0             });
113            
114                    // Register Marketing API client with resilience
115  ❌  0             services.AddHttpClient("MarketingApi", client =>
116  ❌  0             {
117  ❌  0                 client.BaseAddress = new Uri(options.MarketingApiBaseUrl);
118  ❌  0                 client.Timeout = TimeSpan.FromSeconds(30);
119  ❌  0             })
120  ❌  0             .AddHttpMessageHandler(serviceProvider =>
121  ❌  0                 new ApiAuthenticationMessageHandler(serviceProvider))
122  ❌  0             .AddResilienceHandler("marketing-api-pipeline", (ResiliencePipelineBuilder<HttpResponseMessage> builder) =>
123  ❌  0             {
124  ❌  0                 // 1. Fallback (outer layer - executed last if all else fails)
125  ❌  0                 //builder.AddFallback(new FallbackStrategyOptions<HttpResponseMessage>
126  ❌  0                 //{
127  ❌  0                 //    ShouldHandle = new PredicateBuilder<HttpResponseMessage>()
128  ❌  0                 //        .Handle<HttpRequestException>()
129  ❌  0                 //        .Handle<TimeoutException>()
130  ❌  0                 //        .Handle<BrokenCircuitException>()
131  ❌  0                 //        .HandleResult(response => !response.IsSuccessStatusCode),
132  ❌  0                 //    FallbackAction = args =>
133  ❌  0                 //    {
134  ❌  0                 //        // Return an empty response
135  ❌  0                 //        var fallbackResponse = new HttpResponseMessage(System.Net.HttpStatusCode.OK)
136  ❌  0                 //        {
137  ❌  0                 //            Content = new StringContent("[]", System.Text.Encoding.UTF8, "application/json")
138  ❌  0                 //        };
139  ❌  0     
140  ❌  0                 //        return Outcome.FromResultAsValueTask(fallbackResponse);
141  ❌  0                 //    }
142  ❌  0                 //});
143  ❌  0     
144  ❌  0                 // 2. Circuit breaker (prevents cascading failures)
145  ❌  0                 builder.AddCircuitBreaker(new CircuitBreakerStrategyOptions<HttpResponseMessage>
146  ❌  0                 {
147  ❌  0                     SamplingDuration = TimeSpan.FromSeconds(30),
148  ❌  0                     FailureRatio = 0.5,
149  ❌  0                     MinimumThroughput = 3,
150  ❌  0                     BreakDuration = TimeSpan.FromSeconds(15),
151  ❌  0                     ShouldHandle = new PredicateBuilder<HttpResponseMessage>()
152  ❌  0                         .Handle<HttpRequestException>()
153  ❌  0                         .Handle<TimeoutException>()
154  ❌  0                         .HandleResult(response => !response.IsSuccessStatusCode)
155  ❌  0                 });
156  ❌  0     
157  ❌  0                 // 3. Retry with exponential backoff
158  ❌  0                 builder.AddRetry(new Polly.Retry.RetryStrategyOptions<HttpResponseMessage>
159  ❌  0                 {
160  ❌  0                     MaxRetryAttempts = 3,
161  ❌  0                     BackoffType = Polly.DelayBackoffType.Exponential,
162  ❌  0                     UseJitter = true,
163  ❌  0                     Delay = TimeSpan.FromSeconds(1),
164  ❌  0                     ShouldHandle = new PredicateBuilder<HttpResponseMessage>()
165  ❌  0                         .Handle<HttpRequestException>()
166  ❌  0                         .Handle<TimeoutException>()
167  ❌  0  ○                      .HandleResult(response => !response.IsSuccessStatusCode && response.StatusCode != System.Net.HttpSta
168  ❌  0                 });
169  ❌  0     
170  ❌  0                 // 4. Timeout per attempt (inner layer - wraps each individual request)
171  ❌  0                 builder.AddTimeout(TimeSpan.FromSeconds(10));
172  ❌  0             });
173            
174  ❌  0             return services;
175  ❌  0         }
176            }
177            
178            /// <summary>
179            /// Options for API client configuration.
180            /// </summary>
181            public class ApiClientOptions
182            {
183                public string LocationApiBaseUrl { get; set; } = "https://localhost:4747";
184                public string MarketingApiBaseUrl { get; set; } = "https://localhost:4749";
185            }
186            
187            /// <summary>
188            /// HTTP message handler that adds API authentication headers to requests.
189            /// Uses reflection to access IApiAuthenticationService from Mobile project if available.
190            /// </summary>
191            internal class ApiAuthenticationMessageHandler : DelegatingHandler
192            {
193                private readonly IServiceProvider _serviceProvider;
194            
195                public ApiAuthenticationMessageHandler(IServiceProvider serviceProvider)
196                {
197                    _serviceProvider = serviceProvider ?? throw new ArgumentNullException(nameof(serviceProvider));
198                }
199            
200                protected override async Task<HttpResponseMessage> SendAsync(
201                    HttpRequestMessage request,
202                    CancellationToken cancellationToken)
203                {
204                    // Try to get IApiAuthenticationService from service provider using reflection
205                    // This avoids a direct dependency on FWH.Mobile project
206                    var authServiceType = Type.GetType("FWH.Mobile.Services.IApiAuthenticationService, FWH.Mobile");
207                    if (authServiceType != null)
208                    {
209                        var authService = _serviceProvider.GetService(authServiceType);
210                        if (authService != null)
211                        {
212                            // Get request body if present for signing
213                            string? requestBody = null;
214                            if (request.Content != null)
215                            {
216                                requestBody = await request.Content.ReadAsStringAsync(cancellationToken);
217                                // Reset the content stream position
218                                var contentType = request.Content.Headers.ContentType ?? new MediaTypeHeaderValue("application/json"
219                                request.Content = new StringContent(requestBody, System.Text.Encoding.UTF8, contentType);
220                            }
221            
222                            // Call AddAuthenticationHeaders via reflection
223                            var method = authServiceType.GetMethod("AddAuthenticationHeaders");
224                            if (method != null)
225                            {
226                                method.Invoke(authService, new object[] { request, requestBody! });
227                            }
228                        }
229                    }
230            
231                    return await base.SendAsync(request, cancellationToken);
232                }
233            }
```
# FWH.Orchestrix.Mediator.Remote.Location.GetDeviceLocationHistoryHandler

## Summary

|||
|:---|:---|
| Class: | FWH.Orchestrix.Mediator.Remote.Location.GetDeviceLocationHistoryHandler |
| Assembly: | FWH.Orchestrix.Mediator.Remote |
| **File(s):** | E:\github\FunWasHad\src\FWH.Orchestrix.Mediator.Remote\Location\GetDeviceLocationHistoryHandler.cs |
| **Line coverage:** | 0% (0 of 44) |
| Covered lines: | 0 |
| Uncovered lines: | 44 |
| Coverable lines: | 44 |
| Total lines: | 73 |
| **Branch coverage:** | 0% (0 of 12) |
| Covered branches: | 0 |
| Total branches: | 12 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **.ctor(...)** | 0% | 6 | 2 | 0% |
| **HandleAsync()** | 0% | 110 | 10 | 0% |

## File(s)

### E:\github\FunWasHad\src\FWH.Orchestrix.Mediator.Remote\Location\GetDeviceLocationHistoryHandler.cs
```
 1           using System.Net.Http.Json;
 2           using FWH.Orchestrix.Contracts.Location;
 3           using Microsoft.Extensions.Logging;
 4           using FWH.Orchestrix.Contracts.Mediator;
 5           
 6           namespace FWH.Orchestrix.Mediator.Remote.Location;
 7           
 8           /// <summary>
 9           /// Remote handler for getting device location history via HTTP API.
10           /// </summary>
11           public class GetDeviceLocationHistoryHandler : IMediatorHandler<GetDeviceLocationHistoryRequest, GetDeviceLocationHistor
12           {
13               private readonly HttpClient _httpClient;
14               private readonly ILogger<GetDeviceLocationHistoryHandler> _logger;
15           
16  ❌ 0         public GetDeviceLocationHistoryHandler(
17  ❌ 0             IHttpClientFactory httpClientFactory,
18  ❌ 0             ILogger<GetDeviceLocationHistoryHandler> logger)
19  ❌ 0         {
20  ❌ 0             _httpClient = httpClientFactory.CreateClient("LocationApi");
21  ❌ 0  ○          _logger = logger ?? throw new ArgumentNullException(nameof(logger));
22  ❌ 0         }
23           
24               public async Task<GetDeviceLocationHistoryResponse> HandleAsync(
25                   GetDeviceLocationHistoryRequest request,
26                   CancellationToken cancellationToken = default)
27  ❌ 0         {
28                   try
29  ❌ 0             {
30  ❌ 0                 _logger.LogInformation("Getting device location history remotely for device {DeviceId}",
31  ❌ 0                     request.DeviceId);
32           
33  ❌ 0                 var query = $"?deviceId={Uri.EscapeDataString(request.DeviceId)}";
34  ❌ 0  ○              if (request.Since.HasValue)
35  ❌ 0                     query += $"&since={Uri.EscapeDataString(request.Since.Value.ToString("O"))}";
36  ❌ 0  ○              if (request.Until.HasValue)
37  ❌ 0                     query += $"&until={Uri.EscapeDataString(request.Until.Value.ToString("O"))}";
38  ❌ 0  ○              if (request.Limit.HasValue)
39  ❌ 0                     query += $"&limit={request.Limit}";
40           
41  ❌ 0                 var response = await _httpClient.GetAsync($"/api/locations{query}", cancellationToken);
42           
43  ❌ 0  ○              if (response.IsSuccessStatusCode)
44  ❌ 0                 {
45  ❌ 0                     var locations = await response.Content.ReadFromJsonAsync<List<DeviceLocationDto>>(cancellationToken);
46  ❌ 0  ○                  return new GetDeviceLocationHistoryResponse
47  ❌ 0                     {
48  ❌ 0                         Success = true,
49  ❌ 0                         Locations = locations ?? new List<DeviceLocationDto>()
50  ❌ 0                     };
51                       }
52           
53  ❌ 0                 var error = await response.Content.ReadAsStringAsync(cancellationToken);
54  ❌ 0                 _logger.LogWarning("Failed to get device location history: {StatusCode} - {Error}",
55  ❌ 0                     response.StatusCode, error);
56           
57  ❌ 0                 return new GetDeviceLocationHistoryResponse
58  ❌ 0                 {
59  ❌ 0                     Success = false,
60  ❌ 0                     ErrorMessage = $"HTTP {response.StatusCode}: {error}"
61  ❌ 0                 };
62                   }
63  ❌ 0             catch (Exception ex)
64  ❌ 0             {
65  ❌ 0                 _logger.LogError(ex, "Error getting device location history remotely");
66  ❌ 0                 return new GetDeviceLocationHistoryResponse
67  ❌ 0                 {
68  ❌ 0                     Success = false,
69  ❌ 0                     ErrorMessage = ex.Message
70  ❌ 0                 };
71                   }
72  ❌ 0         }
73           }
```
# FWH.Orchestrix.Mediator.Remote.Location.GetNearbyBusinessesHandler

## Summary

|||
|:---|:---|
| Class: | FWH.Orchestrix.Mediator.Remote.Location.GetNearbyBusinessesHandler |
| Assembly: | FWH.Orchestrix.Mediator.Remote |
| **File(s):** | E:\github\FunWasHad\src\FWH.Orchestrix.Mediator.Remote\Location\GetNearbyBusinessesHandler.cs |
| **Line coverage:** | 0% (0 of 43) |
| Covered lines: | 0 |
| Uncovered lines: | 43 |
| Coverable lines: | 43 |
| Total lines: | 72 |
| **Branch coverage:** | 0% (0 of 14) |
| Covered branches: | 0 |
| Total branches: | 14 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **.ctor(...)** | 0% | 6 | 2 | 0% |
| **HandleAsync()** | 0% | 156 | 12 | 0% |

## File(s)

### E:\github\FunWasHad\src\FWH.Orchestrix.Mediator.Remote\Location\GetNearbyBusinessesHandler.cs
```
 1           using System.Net.Http.Json;
 2           using FWH.Orchestrix.Contracts.Location;
 3           using Microsoft.Extensions.Logging;
 4           using FWH.Orchestrix.Contracts.Mediator;
 5           
 6           namespace FWH.Orchestrix.Mediator.Remote.Location;
 7           
 8           /// <summary>
 9           /// Remote handler for getting nearby businesses via HTTP API.
10           /// </summary>
11           public class GetNearbyBusinessesHandler : IMediatorHandler<GetNearbyBusinessesRequest, GetNearbyBusinessesResponse>
12           {
13               private readonly HttpClient _httpClient;
14               private readonly ILogger<GetNearbyBusinessesHandler> _logger;
15           
16  ❌ 0         public GetNearbyBusinessesHandler(
17  ❌ 0             IHttpClientFactory httpClientFactory,
18  ❌ 0             ILogger<GetNearbyBusinessesHandler> logger)
19  ❌ 0         {
20  ❌ 0             _httpClient = httpClientFactory.CreateClient("LocationApi");
21  ❌ 0  ○          _logger = logger ?? throw new ArgumentNullException(nameof(logger));
22  ❌ 0         }
23           
24               public async Task<GetNearbyBusinessesResponse> HandleAsync(
25                   GetNearbyBusinessesRequest request,
26                   CancellationToken cancellationToken = default)
27  ❌ 0         {
28                   try
29  ❌ 0             {
30  ❌ 0                 _logger.LogInformation("Getting nearby businesses remotely at ({Lat}, {Lon})",
31  ❌ 0                     request.Latitude, request.Longitude);
32           
33  ❌ 0                 var query = $"?latitude={request.Latitude}&longitude={request.Longitude}&radius={request.RadiusMeters}";
34  ❌ 0  ○              if (request.Tags != null && request.Tags.Length > 0)
35  ❌ 0                 {
36  ❌ 0  ○                  query += $"&tags={string.Join(",", request.Tags.Select(Uri.EscapeDataString))}";
37  ❌ 0                 }
38           
39  ❌ 0                 var response = await _httpClient.GetAsync($"/api/locations/nearby{query}", cancellationToken);
40           
41  ❌ 0  ○              if (response.IsSuccessStatusCode)
42  ❌ 0                 {
43  ❌ 0                     var businesses = await response.Content.ReadFromJsonAsync<List<BusinessDto>>(cancellationToken);
44  ❌ 0  ○                  return new GetNearbyBusinessesResponse
45  ❌ 0                     {
46  ❌ 0                         Success = true,
47  ❌ 0                         Businesses = businesses ?? new List<BusinessDto>(),
48  ❌ 0                         TotalCount = businesses?.Count ?? 0
49  ❌ 0                     };
50                       }
51           
52  ❌ 0                 var error = await response.Content.ReadAsStringAsync(cancellationToken);
53  ❌ 0                 _logger.LogWarning("Failed to get nearby businesses: {StatusCode} - {Error}",
54  ❌ 0                     response.StatusCode, error);
55           
56  ❌ 0                 return new GetNearbyBusinessesResponse
57  ❌ 0                 {
58  ❌ 0                     Success = false,
59  ❌ 0                     ErrorMessage = $"HTTP {response.StatusCode}: {error}"
60  ❌ 0                 };
61                   }
62  ❌ 0             catch (Exception ex)
63  ❌ 0             {
64  ❌ 0                 _logger.LogError(ex, "Error getting nearby businesses remotely");
65  ❌ 0                 return new GetNearbyBusinessesResponse
66  ❌ 0                 {
67  ❌ 0                     Success = false,
68  ❌ 0                     ErrorMessage = ex.Message
69  ❌ 0                 };
70                   }
71  ❌ 0         }
72           }
```
# FWH.Orchestrix.Mediator.Remote.Location.UpdateDeviceLocationHandler

## Summary

|||
|:---|:---|
| Class: | FWH.Orchestrix.Mediator.Remote.Location.UpdateDeviceLocationHandler |
| Assembly: | FWH.Orchestrix.Mediator.Remote |
| **File(s):** | E:\github\FunWasHad\src\FWH.Orchestrix.Mediator.Remote\Location\UpdateDeviceLocationHandler.cs |
| **Line coverage:** | 0% (0 of 51) |
| Covered lines: | 0 |
| Uncovered lines: | 51 |
| Coverable lines: | 51 |
| Total lines: | 87 |
| **Branch coverage:** | 0% (0 of 6) |
| Covered branches: | 0 |
| Total branches: | 6 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **.ctor(...)** | 0% | 6 | 2 | 0% |
| **HandleAsync()** | 0% | 20 | 4 | 0% |
| **get_Id()** | 100% | 2 | 1 | 0% |

## File(s)

### E:\github\FunWasHad\src\FWH.Orchestrix.Mediator.Remote\Location\UpdateDeviceLocationHandler.cs
```
 1           using System.Net.Http.Json;
 2           using FWH.Orchestrix.Contracts.Location;
 3           using Microsoft.Extensions.Logging;
 4           using FWH.Orchestrix.Contracts.Mediator;
 5           
 6           namespace FWH.Orchestrix.Mediator.Remote.Location;
 7           
 8           /// <summary>
 9           /// Remote handler for updating device location via HTTP API.
10           ///
11           /// ⚠️ WARNING: This handler should NOT be used in the mobile app.
12           /// TR-MOBILE-001: Device location is tracked in the local SQLite database only.
13           /// Device location should NEVER be sent to the API for privacy and performance reasons.
14           ///
15           /// This handler exists for potential future server-to-server scenarios only.
16           /// The mobile app uses LocationTrackingService with NotesDbContext for local storage.
17           /// </summary>
18           public class UpdateDeviceLocationHandler : IMediatorHandler<UpdateDeviceLocationRequest, UpdateDeviceLocationResponse>
19           {
20               private readonly HttpClient _httpClient;
21               private readonly ILogger<UpdateDeviceLocationHandler> _logger;
22           
23  ❌ 0         public UpdateDeviceLocationHandler(
24  ❌ 0             IHttpClientFactory httpClientFactory,
25  ❌ 0             ILogger<UpdateDeviceLocationHandler> logger)
26  ❌ 0         {
27  ❌ 0             _httpClient = httpClientFactory.CreateClient("LocationApi");
28  ❌ 0  ○          _logger = logger ?? throw new ArgumentNullException(nameof(logger));
29  ❌ 0         }
30           
31               public async Task<UpdateDeviceLocationResponse> HandleAsync(
32                   UpdateDeviceLocationRequest request,
33                   CancellationToken cancellationToken = default)
34  ❌ 0         {
35                   try
36  ❌ 0             {
37  ❌ 0                 _logger.LogInformation("Updating device location remotely for device {DeviceId}",
38  ❌ 0                     request.DeviceId);
39           
40  ❌ 0                 var response = await _httpClient.PostAsJsonAsync(
41  ❌ 0                     "/api/locations",
42  ❌ 0                     new
43  ❌ 0                     {
44  ❌ 0                         request.DeviceId,
45  ❌ 0                         request.Latitude,
46  ❌ 0                         request.Longitude,
47  ❌ 0                         request.Accuracy,
48  ❌ 0                         request.Altitude,
49  ❌ 0                         request.Speed,
50  ❌ 0                         request.Heading,
51  ❌ 0                         request.Timestamp
52  ❌ 0                     },
53  ❌ 0                     cancellationToken);
54           
55  ❌ 0  ○              if (response.IsSuccessStatusCode)
56  ❌ 0                 {
57  ❌ 0                     var result = await response.Content.ReadFromJsonAsync<LocationCreatedDto>(cancellationToken);
58  ❌ 0  ○                  return new UpdateDeviceLocationResponse
59  ❌ 0                     {
60  ❌ 0                         Success = true,
61  ❌ 0                         LocationId = result?.Id
62  ❌ 0                     };
63                       }
64           
65  ❌ 0                 var error = await response.Content.ReadAsStringAsync(cancellationToken);
66  ❌ 0                 _logger.LogWarning("Failed to update device location: {StatusCode} - {Error}",
67  ❌ 0                     response.StatusCode, error);
68           
69  ❌ 0                 return new UpdateDeviceLocationResponse
70  ❌ 0                 {
71  ❌ 0                     Success = false,
72  ❌ 0                     ErrorMessage = $"HTTP {response.StatusCode}: {error}"
73  ❌ 0                 };
74                   }
75  ❌ 0             catch (Exception ex)
76  ❌ 0             {
77  ❌ 0                 _logger.LogError(ex, "Error updating device location remotely");
78  ❌ 0                 return new UpdateDeviceLocationResponse
79  ❌ 0                 {
80  ❌ 0                     Success = false,
81  ❌ 0                     ErrorMessage = ex.Message
82  ❌ 0                 };
83                   }
84  ❌ 0         }
85           
86  ❌ 0         private record LocationCreatedDto(long Id);
87           }
```
# FWH.Orchestrix.Mediator.Remote.Marketing.GetBusinessCouponsHandler

## Summary

|||
|:---|:---|
| Class: | FWH.Orchestrix.Mediator.Remote.Marketing.GetBusinessCouponsHandler |
| Assembly: | FWH.Orchestrix.Mediator.Remote |
| **File(s):** | E:\github\FunWasHad\src\FWH.Orchestrix.Mediator.Remote\Marketing\GetBusinessCouponsHandler.cs |
| **Line coverage:** | 0% (0 of 37) |
| Covered lines: | 0 |
| Uncovered lines: | 37 |
| Coverable lines: | 37 |
| Total lines: | 65 |
| **Branch coverage:** | 0% (0 of 6) |
| Covered branches: | 0 |
| Total branches: | 6 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **.ctor(...)** | 0% | 6 | 2 | 0% |
| **HandleAsync()** | 0% | 20 | 4 | 0% |

## File(s)

### E:\github\FunWasHad\src\FWH.Orchestrix.Mediator.Remote\Marketing\GetBusinessCouponsHandler.cs
```
 1           using System.Net.Http.Json;
 2           using FWH.Orchestrix.Contracts.Marketing;
 3           using Microsoft.Extensions.Logging;
 4           using FWH.Orchestrix.Contracts.Mediator;
 5           
 6           namespace FWH.Orchestrix.Mediator.Remote.Marketing;
 7           
 8           /// <summary>
 9           /// Remote handler for getting business coupons via HTTP API.
10           /// </summary>
11           public class GetBusinessCouponsHandler : IMediatorHandler<GetBusinessCouponsRequest, GetBusinessCouponsResponse>
12           {
13               private readonly HttpClient _httpClient;
14               private readonly ILogger<GetBusinessCouponsHandler> _logger;
15           
16  ❌ 0         public GetBusinessCouponsHandler(
17  ❌ 0             IHttpClientFactory httpClientFactory,
18  ❌ 0             ILogger<GetBusinessCouponsHandler> logger)
19  ❌ 0         {
20  ❌ 0             _httpClient = httpClientFactory.CreateClient("MarketingApi");
21  ❌ 0  ○          _logger = logger ?? throw new ArgumentNullException(nameof(logger));
22  ❌ 0         }
23           
24               public async Task<GetBusinessCouponsResponse> HandleAsync(
25                   GetBusinessCouponsRequest request,
26                   CancellationToken cancellationToken = default)
27  ❌ 0         {
28                   try
29  ❌ 0             {
30  ❌ 0                 _logger.LogInformation("Getting business coupons remotely for business {BusinessId}",
31  ❌ 0                     request.BusinessId);
32           
33  ❌ 0                 var response = await _httpClient.GetAsync($"/api/marketing/{request.BusinessId}/coupons", cancellationToken)
34           
35  ❌ 0  ○              if (response.IsSuccessStatusCode)
36  ❌ 0                 {
37  ❌ 0                     var coupons = await response.Content.ReadFromJsonAsync<List<CouponDto>>(cancellationToken);
38  ❌ 0  ○                  return new GetBusinessCouponsResponse
39  ❌ 0                     {
40  ❌ 0                         Success = true,
41  ❌ 0                         Coupons = coupons ?? new List<CouponDto>()
42  ❌ 0                     };
43                       }
44           
45  ❌ 0                 var error = await response.Content.ReadAsStringAsync(cancellationToken);
46  ❌ 0                 _logger.LogWarning("Failed to get business coupons: {StatusCode} - {Error}",
47  ❌ 0                     response.StatusCode, error);
48           
49  ❌ 0                 return new GetBusinessCouponsResponse
50  ❌ 0                 {
51  ❌ 0                     Success = false,
52  ❌ 0                     ErrorMessage = $"HTTP {response.StatusCode}: {error}"
53  ❌ 0                 };
54                   }
55  ❌ 0             catch (Exception ex)
56  ❌ 0             {
57  ❌ 0                 _logger.LogError(ex, "Error getting business coupons remotely");
58  ❌ 0                 return new GetBusinessCouponsResponse
59  ❌ 0                 {
60  ❌ 0                     Success = false,
61  ❌ 0                     ErrorMessage = ex.Message
62  ❌ 0                 };
63                   }
64  ❌ 0         }
65           }
```
# FWH.Orchestrix.Mediator.Remote.Marketing.GetBusinessMarketingHandler

## Summary

|||
|:---|:---|
| Class: | FWH.Orchestrix.Mediator.Remote.Marketing.GetBusinessMarketingHandler |
| Assembly: | FWH.Orchestrix.Mediator.Remote |
| **File(s):** | E:\github\FunWasHad\src\FWH.Orchestrix.Mediator.Remote\Marketing\GetBusinessMarketingHandler.cs |
| **Line coverage:** | 0% (0 of 37) |
| Covered lines: | 0 |
| Uncovered lines: | 37 |
| Coverable lines: | 37 |
| Total lines: | 65 |
| **Branch coverage:** | 0% (0 of 4) |
| Covered branches: | 0 |
| Total branches: | 4 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **.ctor(...)** | 0% | 6 | 2 | 0% |
| **HandleAsync()** | 0% | 6 | 2 | 0% |

## File(s)

### E:\github\FunWasHad\src\FWH.Orchestrix.Mediator.Remote\Marketing\GetBusinessMarketingHandler.cs
```
 1           using System.Net.Http.Json;
 2           using FWH.Orchestrix.Contracts.Marketing;
 3           using Microsoft.Extensions.Logging;
 4           using FWH.Orchestrix.Contracts.Mediator;
 5           
 6           namespace FWH.Orchestrix.Mediator.Remote.Marketing;
 7           
 8           /// <summary>
 9           /// Remote handler for getting business marketing data via HTTP API.
10           /// </summary>
11           public class GetBusinessMarketingHandler : IMediatorHandler<GetBusinessMarketingRequest, GetBusinessMarketingResponse>
12           {
13               private readonly HttpClient _httpClient;
14               private readonly ILogger<GetBusinessMarketingHandler> _logger;
15           
16  ❌ 0         public GetBusinessMarketingHandler(
17  ❌ 0             IHttpClientFactory httpClientFactory,
18  ❌ 0             ILogger<GetBusinessMarketingHandler> logger)
19  ❌ 0         {
20  ❌ 0             _httpClient = httpClientFactory.CreateClient("MarketingApi");
21  ❌ 0  ○          _logger = logger ?? throw new ArgumentNullException(nameof(logger));
22  ❌ 0         }
23           
24               public async Task<GetBusinessMarketingResponse> HandleAsync(
25                   GetBusinessMarketingRequest request,
26                   CancellationToken cancellationToken = default)
27  ❌ 0         {
28                   try
29  ❌ 0             {
30  ❌ 0                 _logger.LogInformation("Getting business marketing data remotely for business {BusinessId}",
31  ❌ 0                     request.BusinessId);
32           
33  ❌ 0                 var response = await _httpClient.GetAsync($"/api/marketing/{request.BusinessId}", cancellationToken);
34           
35  ❌ 0  ○              if (response.IsSuccessStatusCode)
36  ❌ 0                 {
37  ❌ 0                     var data = await response.Content.ReadFromJsonAsync<BusinessMarketingDto>(cancellationToken);
38  ❌ 0                     return new GetBusinessMarketingResponse
39  ❌ 0                     {
40  ❌ 0                         Success = true,
41  ❌ 0                         Data = data
42  ❌ 0                     };
43                       }
44           
45  ❌ 0                 var error = await response.Content.ReadAsStringAsync(cancellationToken);
46  ❌ 0                 _logger.LogWarning("Failed to get business marketing data: {StatusCode} - {Error}",
47  ❌ 0                     response.StatusCode, error);
48           
49  ❌ 0                 return new GetBusinessMarketingResponse
50  ❌ 0                 {
51  ❌ 0                     Success = false,
52  ❌ 0                     ErrorMessage = $"HTTP {response.StatusCode}: {error}"
53  ❌ 0                 };
54                   }
55  ❌ 0             catch (Exception ex)
56  ❌ 0             {
57  ❌ 0                 _logger.LogError(ex, "Error getting business marketing data remotely");
58  ❌ 0                 return new GetBusinessMarketingResponse
59  ❌ 0                 {
60  ❌ 0                     Success = false,
61  ❌ 0                     ErrorMessage = ex.Message
62  ❌ 0                 };
63                   }
64  ❌ 0         }
65           }
```
# FWH.Orchestrix.Mediator.Remote.Marketing.GetBusinessThemeHandler

## Summary

|||
|:---|:---|
| Class: | FWH.Orchestrix.Mediator.Remote.Marketing.GetBusinessThemeHandler |
| Assembly: | FWH.Orchestrix.Mediator.Remote |
| **File(s):** | E:\github\FunWasHad\src\FWH.Orchestrix.Mediator.Remote\Marketing\GetBusinessThemeHandler.cs |
| **Line coverage:** | 0% (0 of 37) |
| Covered lines: | 0 |
| Uncovered lines: | 37 |
| Coverable lines: | 37 |
| Total lines: | 65 |
| **Branch coverage:** | 0% (0 of 4) |
| Covered branches: | 0 |
| Total branches: | 4 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **.ctor(...)** | 0% | 6 | 2 | 0% |
| **HandleAsync()** | 0% | 6 | 2 | 0% |

## File(s)

### E:\github\FunWasHad\src\FWH.Orchestrix.Mediator.Remote\Marketing\GetBusinessThemeHandler.cs
```
 1           using System.Net.Http.Json;
 2           using FWH.Orchestrix.Contracts.Marketing;
 3           using Microsoft.Extensions.Logging;
 4           using FWH.Orchestrix.Contracts.Mediator;
 5           
 6           namespace FWH.Orchestrix.Mediator.Remote.Marketing;
 7           
 8           /// <summary>
 9           /// Remote handler for getting business theme via HTTP API.
10           /// </summary>
11           public class GetBusinessThemeHandler : IMediatorHandler<GetBusinessThemeRequest, GetBusinessThemeResponse>
12           {
13               private readonly HttpClient _httpClient;
14               private readonly ILogger<GetBusinessThemeHandler> _logger;
15           
16  ❌ 0         public GetBusinessThemeHandler(
17  ❌ 0             IHttpClientFactory httpClientFactory,
18  ❌ 0             ILogger<GetBusinessThemeHandler> logger)
19  ❌ 0         {
20  ❌ 0             _httpClient = httpClientFactory.CreateClient("MarketingApi");
21  ❌ 0  ○          _logger = logger ?? throw new ArgumentNullException(nameof(logger));
22  ❌ 0         }
23           
24               public async Task<GetBusinessThemeResponse> HandleAsync(
25                   GetBusinessThemeRequest request,
26                   CancellationToken cancellationToken = default)
27  ❌ 0         {
28                   try
29  ❌ 0             {
30  ❌ 0                 _logger.LogInformation("Getting business theme remotely for business {BusinessId}",
31  ❌ 0                     request.BusinessId);
32           
33  ❌ 0                 var response = await _httpClient.GetAsync($"/api/marketing/{request.BusinessId}/theme", cancellationToken);
34           
35  ❌ 0  ○              if (response.IsSuccessStatusCode)
36  ❌ 0                 {
37  ❌ 0                     var theme = await response.Content.ReadFromJsonAsync<BusinessThemeDto>(cancellationToken);
38  ❌ 0                     return new GetBusinessThemeResponse
39  ❌ 0                     {
40  ❌ 0                         Success = true,
41  ❌ 0                         Theme = theme
42  ❌ 0                     };
43                       }
44           
45  ❌ 0                 var error = await response.Content.ReadAsStringAsync(cancellationToken);
46  ❌ 0                 _logger.LogWarning("Failed to get business theme: {StatusCode} - {Error}",
47  ❌ 0                     response.StatusCode, error);
48           
49  ❌ 0                 return new GetBusinessThemeResponse
50  ❌ 0                 {
51  ❌ 0                     Success = false,
52  ❌ 0                     ErrorMessage = $"HTTP {response.StatusCode}: {error}"
53  ❌ 0                 };
54                   }
55  ❌ 0             catch (Exception ex)
56  ❌ 0             {
57  ❌ 0                 _logger.LogError(ex, "Error getting business theme remotely");
58  ❌ 0                 return new GetBusinessThemeResponse
59  ❌ 0                 {
60  ❌ 0                     Success = false,
61  ❌ 0                     ErrorMessage = ex.Message
62  ❌ 0                 };
63                   }
64  ❌ 0         }
65           }
```
# FWH.Orchestrix.Mediator.Remote.Marketing.SubmitFeedbackHandler

## Summary

|||
|:---|:---|
| Class: | FWH.Orchestrix.Mediator.Remote.Marketing.SubmitFeedbackHandler |
| Assembly: | FWH.Orchestrix.Mediator.Remote |
| **File(s):** | E:\github\FunWasHad\src\FWH.Orchestrix.Mediator.Remote\Marketing\SubmitFeedbackHandler.cs |
| **Line coverage:** | 0% (0 of 54) |
| Covered lines: | 0 |
| Uncovered lines: | 54 |
| Coverable lines: | 54 |
| Total lines: | 83 |
| **Branch coverage:** | 0% (0 of 6) |
| Covered branches: | 0 |
| Total branches: | 6 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **.ctor(...)** | 0% | 6 | 2 | 0% |
| **HandleAsync()** | 0% | 20 | 4 | 0% |
| **get_Id()** | 100% | 2 | 1 | 0% |

## File(s)

### E:\github\FunWasHad\src\FWH.Orchestrix.Mediator.Remote\Marketing\SubmitFeedbackHandler.cs
```
 1           using System.Net.Http.Json;
 2           using FWH.Orchestrix.Contracts.Marketing;
 3           using Microsoft.Extensions.Logging;
 4           using FWH.Orchestrix.Contracts.Mediator;
 5           
 6           namespace FWH.Orchestrix.Mediator.Remote.Marketing;
 7           
 8           /// <summary>
 9           /// Remote handler for submitting feedback via HTTP API.
10           /// </summary>
11           public class SubmitFeedbackHandler : IMediatorHandler<SubmitFeedbackRequest, SubmitFeedbackResponse>
12           {
13               private readonly HttpClient _httpClient;
14               private readonly ILogger<SubmitFeedbackHandler> _logger;
15           
16  ❌ 0         public SubmitFeedbackHandler(
17  ❌ 0             IHttpClientFactory httpClientFactory,
18  ❌ 0             ILogger<SubmitFeedbackHandler> logger)
19  ❌ 0         {
20  ❌ 0             _httpClient = httpClientFactory.CreateClient("MarketingApi");
21  ❌ 0  ○          _logger = logger ?? throw new ArgumentNullException(nameof(logger));
22  ❌ 0         }
23           
24               public async Task<SubmitFeedbackResponse> HandleAsync(
25                   SubmitFeedbackRequest request,
26                   CancellationToken cancellationToken = default)
27  ❌ 0         {
28                   try
29  ❌ 0             {
30  ❌ 0                 _logger.LogInformation("Submitting feedback remotely for business {BusinessId}",
31  ❌ 0                     request.BusinessId);
32           
33  ❌ 0                 var response = await _httpClient.PostAsJsonAsync(
34  ❌ 0                     "/api/feedback",
35  ❌ 0                     new
36  ❌ 0                     {
37  ❌ 0                         request.BusinessId,
38  ❌ 0                         request.UserId,
39  ❌ 0                         request.UserName,
40  ❌ 0                         request.UserEmail,
41  ❌ 0                         request.FeedbackType,
42  ❌ 0                         request.Subject,
43  ❌ 0                         request.Message,
44  ❌ 0                         request.Rating,
45  ❌ 0                         request.IsPublic,
46  ❌ 0                         request.Latitude,
47  ❌ 0                         request.Longitude
48  ❌ 0                     },
49  ❌ 0                     cancellationToken);
50           
51  ❌ 0  ○              if (response.IsSuccessStatusCode)
52  ❌ 0                 {
53  ❌ 0                     var result = await response.Content.ReadFromJsonAsync<FeedbackCreatedDto>(cancellationToken);
54  ❌ 0  ○                  return new SubmitFeedbackResponse
55  ❌ 0                     {
56  ❌ 0                         Success = true,
57  ❌ 0                         FeedbackId = result?.Id
58  ❌ 0                     };
59                       }
60           
61  ❌ 0                 var error = await response.Content.ReadAsStringAsync(cancellationToken);
62  ❌ 0                 _logger.LogWarning("Failed to submit feedback: {StatusCode} - {Error}",
63  ❌ 0                     response.StatusCode, error);
64           
65  ❌ 0                 return new SubmitFeedbackResponse
66  ❌ 0                 {
67  ❌ 0                     Success = false,
68  ❌ 0                     ErrorMessage = $"HTTP {response.StatusCode}: {error}"
69  ❌ 0                 };
70                   }
71  ❌ 0             catch (Exception ex)
72  ❌ 0             {
73  ❌ 0                 _logger.LogError(ex, "Error submitting feedback remotely");
74  ❌ 0                 return new SubmitFeedbackResponse
75  ❌ 0                 {
76  ❌ 0                     Success = false,
77  ❌ 0                     ErrorMessage = ex.Message
78  ❌ 0                 };
79                   }
80  ❌ 0         }
81           
82  ❌ 0         private record FeedbackCreatedDto(long Id);
83           }
```
# FWH.Orchestrix.Mediator.Remote.Marketing.UploadFeedbackAttachmentHandler

## Summary

|||
|:---|:---|
| Class: | FWH.Orchestrix.Mediator.Remote.Marketing.UploadFeedbackAttachmentHandler |
| Assembly: | FWH.Orchestrix.Mediator.Remote |
| **File(s):** | E:\github\FunWasHad\src\FWH.Orchestrix.Mediator.Remote\Marketing\UploadFeedbackAttachmentHandler.cs |
| **Line coverage:** | 0% (0 of 46) |
| Covered lines: | 0 |
| Uncovered lines: | 46 |
| Coverable lines: | 46 |
| Total lines: | 77 |
| **Branch coverage:** | 0% (0 of 10) |
| Covered branches: | 0 |
| Total branches: | 10 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **.ctor(...)** | 0% | 6 | 2 | 0% |
| **HandleAsync()** | 0% | 72 | 8 | 0% |
| **get_Id()** | 100% | 2 | 1 | 0% |

## File(s)

### E:\github\FunWasHad\src\FWH.Orchestrix.Mediator.Remote\Marketing\UploadFeedbackAttachmentHandler.cs
```
 1           using System.Net.Http.Json;
 2           using FWH.Orchestrix.Contracts.Marketing;
 3           using Microsoft.Extensions.Logging;
 4           using FWH.Orchestrix.Contracts.Mediator;
 5           
 6           namespace FWH.Orchestrix.Mediator.Remote.Marketing;
 7           
 8           /// <summary>
 9           /// Remote handler for uploading feedback attachments via HTTP API.
10           /// </summary>
11           public class UploadFeedbackAttachmentHandler : IMediatorHandler<UploadFeedbackAttachmentRequest, UploadFeedbackAttachmen
12           {
13               private readonly HttpClient _httpClient;
14               private readonly ILogger<UploadFeedbackAttachmentHandler> _logger;
15           
16  ❌ 0         public UploadFeedbackAttachmentHandler(
17  ❌ 0             IHttpClientFactory httpClientFactory,
18  ❌ 0             ILogger<UploadFeedbackAttachmentHandler> logger)
19  ❌ 0         {
20  ❌ 0             _httpClient = httpClientFactory.CreateClient("MarketingApi");
21  ❌ 0  ○          _logger = logger ?? throw new ArgumentNullException(nameof(logger));
22  ❌ 0         }
23           
24               public async Task<UploadFeedbackAttachmentResponse> HandleAsync(
25                   UploadFeedbackAttachmentRequest request,
26                   CancellationToken cancellationToken = default)
27  ❌ 0         {
28                   try
29  ❌ 0             {
30  ❌ 0                 _logger.LogInformation("Uploading {AttachmentType} attachment remotely for feedback {FeedbackId}",
31  ❌ 0                     request.AttachmentType, request.FeedbackId);
32           
33  ❌ 0                 using var content = new MultipartFormDataContent();
34  ❌ 0                 using var fileContent = new ByteArrayContent(request.FileData);
35  ❌ 0                 fileContent.Headers.ContentType = new System.Net.Http.Headers.MediaTypeHeaderValue(request.ContentType);
36  ❌ 0                 content.Add(fileContent, "file", request.FileName);
37           
38  ❌ 0  ○              var endpoint = request.AttachmentType.ToLower() == "image"
39  ❌ 0                     ? $"/api/feedback/{request.FeedbackId}/attachments/image"
40  ❌ 0                     : $"/api/feedback/{request.FeedbackId}/attachments/video";
41           
42  ❌ 0                 var response = await _httpClient.PostAsync(endpoint, content, cancellationToken);
43           
44  ❌ 0  ○              if (response.IsSuccessStatusCode)
45  ❌ 0                 {
46  ❌ 0                     var result = await response.Content.ReadFromJsonAsync<AttachmentCreatedDto>(cancellationToken);
47  ❌ 0  ○                  return new UploadFeedbackAttachmentResponse
48  ❌ 0                     {
49  ❌ 0                         Success = true,
50  ❌ 0                         AttachmentId = result?.Id,
51  ❌ 0                         StorageUrl = result?.StorageUrl
52  ❌ 0                     };
53                       }
54           
55  ❌ 0                 var error = await response.Content.ReadAsStringAsync(cancellationToken);
56  ❌ 0                 _logger.LogWarning("Failed to upload feedback attachment: {StatusCode} - {Error}",
57  ❌ 0                     response.StatusCode, error);
58           
59  ❌ 0                 return new UploadFeedbackAttachmentResponse
60  ❌ 0                 {
61  ❌ 0                     Success = false,
62  ❌ 0                     ErrorMessage = $"HTTP {response.StatusCode}: {error}"
63  ❌ 0                 };
64                   }
65  ❌ 0             catch (Exception ex)
66  ❌ 0             {
67  ❌ 0                 _logger.LogError(ex, "Error uploading feedback attachment remotely");
68  ❌ 0                 return new UploadFeedbackAttachmentResponse
69  ❌ 0                 {
70  ❌ 0                     Success = false,
71  ❌ 0                     ErrorMessage = ex.Message
72  ❌ 0                 };
73                   }
74  ❌ 0         }
75           
76  ❌ 0         private record AttachmentCreatedDto(long Id, string StorageUrl);
77           }
```
# FWH.Orchestrix.Mediator.Remote.Mediator.ServiceProviderMediatorSender

## Summary

|||
|:---|:---|
| Class: | FWH.Orchestrix.Mediator.Remote.Mediator.ServiceProviderMediatorSender |
| Assembly: | FWH.Orchestrix.Mediator.Remote |
| **File(s):** | E:\github\FunWasHad\src\FWH.Orchestrix.Mediator.Remote\Mediator\ServiceProviderMediatorSender.cs |
| **Line coverage:** | 77.2% (17 of 22) |
| Covered lines: | 17 |
| Uncovered lines: | 5 |
| Coverable lines: | 22 |
| Total lines: | 44 |
| **Branch coverage:** | 50% (3 of 6) |
| Covered branches: | 3 |
| Total branches: | 6 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **.ctor(...)** | 100% | 1 | 1 | 100% |
| **SendAsync(...)** | 50.0% | 7 | 6 | 70.58% |

## File(s)

### E:\github\FunWasHad\src\FWH.Orchestrix.Mediator.Remote\Mediator\ServiceProviderMediatorSender.cs
```
 1            using System;
 2            using System.Threading;
 3            using System.Threading.Tasks;
 4            using Microsoft.Extensions.DependencyInjection;
 5            using FWH.Orchestrix.Contracts.Mediator;
 6            
 7            namespace FWH.Orchestrix.Mediator.Remote.Mediator;
 8            
 9            public sealed class ServiceProviderMediatorSender : IMediatorSender
10            {
11                private readonly IServiceProvider _serviceProvider;
12            
13  ✔  58         public ServiceProviderMediatorSender(IServiceProvider serviceProvider)
14  ✔  58         {
15  ✔  58             ArgumentNullException.ThrowIfNull(serviceProvider);
16  ✔  58             _serviceProvider = serviceProvider;
17  ✔  58         }
18            
19                public Task<TResponse> SendAsync<TResponse>(IMediatorRequest<TResponse> request, CancellationToken cancellationToken
20  ✔  65         {
21  ✔  65             ArgumentNullException.ThrowIfNull(request);
22            
23  ✔  65             var handlerType = typeof(IMediatorHandler<,>).MakeGenericType(request.GetType(), typeof(TResponse));
24  ✔  65             var handler = _serviceProvider.GetService(handlerType);
25  ✓  65  ◑          if (handler is null)
26  ❌  0             {
27  ❌  0                 throw new InvalidOperationException($"No mediator handler registered for request type '{request.GetType().Fu
28                    }
29            
30  ✔  65             var method = handlerType.GetMethod("HandleAsync");
31  ✓  65  ◑          if (method is null)
32  ❌  0             {
33  ❌  0                 throw new InvalidOperationException($"Handler type '{handlerType.FullName}' does not implement HandleAsync."
34                    }
35            
36  ✔  65             var result = method.Invoke(handler, new object?[] { request, cancellationToken });
37  ✓  65  ◑          if (result is Task<TResponse> typed)
38  ✔  65             {
39  ✔  65                 return typed;
40                    }
41            
42  ❌  0             throw new InvalidOperationException($"Handler '{handlerType.FullName}' returned unexpected result type.");
43  ✔  65         }
44            }
```
# Microsoft.Extensions.Hosting.Extensions

## Summary

|||
|:---|:---|
| Class: | Microsoft.Extensions.Hosting.Extensions |
| Assembly: | FWH.ServiceDefaults |
| **File(s):** | E:\github\FunWasHad\src\FWH.ServiceDefaults\Extensions.cs |
| **Line coverage:** | 90.9% (60 of 66) |
| Covered lines: | 60 |
| Uncovered lines: | 6 |
| Coverable lines: | 66 |
| Total lines: | 118 |
| **Branch coverage:** | 75% (3 of 4) |
| Covered branches: | 3 |
| Total branches: | 4 |
| **Method coverage:** | [Feature is only available for sponsors](https://reportgenerator.io/pro) |

## Metrics

| **Method** | **Branch coverage** | **Crap Score** | **Cyclomatic complexity** | **Line coverage** |
|:---|---:|---:|---:|---:|
| **AddServiceDefaults(...)** | 100% | 1 | 1 | 88.88% |
| **ConfigureOpenTelemetry(...)** | 100% | 1 | 1 | 100% |
| **AddOpenTelemetryExporters(...)** | 50.0% | 2 | 2 | 62.50% |
| **AddDefaultHealthChecks(...)** | 100% | 1 | 1 | 100% |
| **MapDefaultEndpoints(...)** | 100% | 2 | 2 | 90.90% |

## File(s)

### E:\github\FunWasHad\src\FWH.ServiceDefaults\Extensions.cs
```
  1           using Microsoft.AspNetCore.Builder;
  2           using Microsoft.AspNetCore.Diagnostics.HealthChecks;
  3           using Microsoft.Extensions.DependencyInjection;
  4           using Microsoft.Extensions.Diagnostics.HealthChecks;
  5           using Microsoft.Extensions.Logging;
  6           using Microsoft.Extensions.ServiceDiscovery;
  7           using OpenTelemetry;
  8           using OpenTelemetry.Metrics;
  9           using OpenTelemetry.Trace;
 10           
 11           namespace Microsoft.Extensions.Hosting;
 12           
 13           // Adds common .NET Aspire services: service discovery, resilience, health checks, and OpenTelemetry.
 14           // This project should be referenced by each service project in your solution.
 15           // To learn more about using this project, see https://aka.ms/dotnet/aspire/service-defaults
 16           public static class Extensions
 17           {
 18               public static IHostApplicationBuilder AddServiceDefaults(this IHostApplicationBuilder builder)
 19  ✔  3         {
 20  ✔  3             builder.ConfigureOpenTelemetry();
 21           
 22  ✔  3             builder.AddDefaultHealthChecks();
 23           
 24  ✔  3             builder.Services.AddServiceDiscovery();
 25           
 26  ✔  3             builder.Services.ConfigureHttpClientDefaults(http =>
 27  ✔  3             {
 28  ✔  3                 // Turn on resilience by default
 29  ✔  3                 http.AddStandardResilienceHandler();
 30  ✔  3     
 31  ✔  3                 // Turn on service discovery by default
 32  ✔  3                 http.AddServiceDiscovery();
 33  ✔  6             });
 34           
 35                   // Uncomment the following to restrict the allowed schemes for service discovery.
 36  ✔  3             builder.Services.Configure<ServiceDiscoveryOptions>(options =>
 37  ❌ 0             {
 38  ❌ 0                 options.AllowedSchemes = ["https"];
 39  ✔  3             });
 40           
 41  ✔  3             return builder;
 42  ✔  3         }
 43           
 44               public static IHostApplicationBuilder ConfigureOpenTelemetry(this IHostApplicationBuilder builder)
 45  ✔  3         {
 46  ✔  3             builder.Logging.AddOpenTelemetry(logging =>
 47  ✔  3             {
 48  ✔  3                 logging.IncludeFormattedMessage = true;
 49  ✔  3                 logging.IncludeScopes = true;
 50  ✔  6             });
 51           
 52  ✔  3             builder.Services.AddOpenTelemetry()
 53  ✔  3                 .WithMetrics(metrics =>
 54  ✔  3                 {
 55  ✔  3                     metrics.AddAspNetCoreInstrumentation()
 56  ✔  3                         .AddHttpClientInstrumentation()
 57  ✔  3                         .AddRuntimeInstrumentation();
 58  ✔  3                 })
 59  ✔  3                 .WithTracing(tracing =>
 60  ✔  3                 {
 61  ✔  3                     tracing.AddAspNetCoreInstrumentation()
 62  ✔  3                         // Uncomment the following line to enable gRPC instrumentation (requires the OpenTelemetry.Instrumen
 63  ✔  3                         //.AddGrpcClientInstrumentation()
 64  ✔  3                         .AddHttpClientInstrumentation();
 65  ✔  6                 });
 66           
 67  ✔  3             builder.AddOpenTelemetryExporters();
 68           
 69  ✔  3             return builder;
 70  ✔  3         }
 71           
 72               private static IHostApplicationBuilder AddOpenTelemetryExporters(this IHostApplicationBuilder builder)
 73  ✔  3         {
 74  ✔  3             var useOtlpExporter = !string.IsNullOrWhiteSpace(builder.Configuration["OTEL_EXPORTER_OTLP_ENDPOINT"]);
 75           
 76  ✓  3  ◑          if (useOtlpExporter)
 77  ❌ 0             {
 78  ❌ 0                 builder.Services.AddOpenTelemetry().UseOtlpExporter();
 79  ❌ 0             }
 80           
 81                   // Uncomment the following lines to enable the Azure Monitor exporter (requires the Azure.Monitor.OpenTelemetry.
 82                   //if (!string.IsNullOrEmpty(builder.Configuration["APPLICATIONINSIGHTS_CONNECTION_STRING"]))
 83                   //{
 84                   //    builder.Services.AddOpenTelemetry()
 85                   //       .UseAzureMonitor();
 86                   //}
 87           
 88  ✔  3             return builder;
 89  ✔  3         }
 90           
 91               public static IHostApplicationBuilder AddDefaultHealthChecks(this IHostApplicationBuilder builder)
 92  ✔  3         {
 93  ✔  3             builder.Services.AddHealthChecks()
 94  ✔  3                 // Add a default liveness check to ensure app is responsive
 95  ✔  3                 .AddCheck("self", () => HealthCheckResult.Healthy(), ["live"]);
 96           
 97  ✔  3             return builder;
 98  ✔  3         }
 99           
100               public static WebApplication MapDefaultEndpoints(this WebApplication app)
101  ✔  3         {
102                   // Adding health checks endpoints to applications in non-development environments has security implications.
103                   // See https://aka.ms/dotnet/aspire/healthchecks for details before enabling these endpoints in non-development 
104  ✔  3  ●          if (app.Environment.IsDevelopment())
105  ✔  3             {
106                       // All health checks must pass for app to be considered ready to accept traffic after starting
107  ✔  3                 app.MapHealthChecks("/health");
108           
109                       // Only health checks tagged with the "live" tag must pass for app to be considered alive
110  ✔  3                 app.MapHealthChecks("/alive", new HealthCheckOptions
111  ✔  3                 {
112  ❌ 0                     Predicate = r => r.Tags.Contains("live")
113  ✔  3                 });
114  ✔  3             }
115           
116  ✔  3             return app;
117  ✔  3         }
118           }
```

